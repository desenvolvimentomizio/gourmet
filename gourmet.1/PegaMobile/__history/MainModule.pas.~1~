unit MainModule;

interface

uses
  uniGUIMainModule, SysUtils, Classes, inifiles, Data.DB, DBAccess, Uni,
  UniProvider, MySQLUniProvider, VirtualTable, DASQLMonitor, UniSQLMonitor,
  MemDS,dialogs;

type
  TUniMainModule = class(TUniGUIMainModule)
    brd: TUniQuery;
    brdsel: TStringField;
    brdbrdcodigo: TIntegerField;
    brdbrdidentificacao: TStringField;
    letras: TUniQuery;
    letrasletra: TStringField;
    UniDataSource1: TUniDataSource;
    montapedido: TUniQuery;
    Dbpr: TDataSource;
    bpr: TUniQuery;
    bprbprchave: TIntegerField;
    bprpronome: TStringField;
    bprprocodigo: TIntegerField;
    bprprocodigoborda: TIntegerField;
    trfmesa: TUniQuery;
    trfmesaorcchave: TIntegerField;
    trfmesamesa: TStringField;
    trfmesaorcmesa: TIntegerField;
    trfmesasel: TIntegerField;
    ttro: TUniQuery;
    ttroID: TIntegerField;
    ttroorcchave: TIntegerField;
    ttromesa: TStringField;
    ttroorcmesa: TIntegerField;
    TransfereMesa: TUniStoredProc;
    UniSQLMonitor1: TUniSQLMonitor;
    cfg: TUniQuery;
    cfgcfgcodigo: TIntegerField;
    cfgcfgmgoutaxaatendimento: TFloatField;
    cfgcfgmgouqtdmesas: TIntegerField;
    cfgcfgmgounomelocal: TStringField;
    dsTgr: TUniDataSource;
    dsCgr: TUniDataSource;
    cgr: TUniQuery;
    cgrcgrcodigo: TIntegerField;
    cgrcgridentificacao: TStringField;
    tgr: TUniQuery;
    tgrtgrcodigo: TIntegerField;
    tgrtgridentificacao: TStringField;
    olt: TUniQuery;
    oltoltchave: TIntegerField;
    oltoltidentificacao: TStringField;
    oltctacodigo: TIntegerField;
    oltlteregistro: TDateTimeField;
    oltlteprincipal: TFloatField;
    oltltedesconto: TFloatField;
    oltltetotal: TFloatField;
    oltctaidentificacao: TStringField;
    oltclbidentificacao: TStringField;
    olttipobaixa: TIntegerField;
    oltorcchave: TIntegerField;
    oltltechave: TIntegerField;
    unm: TUniQuery;
    unmunmchave: TIntegerField;
    unmorcchave: TIntegerField;
    unmunmmesa: TIntegerField;
    unmorcmesa: TIntegerField;
    msaocupada: TUniQuery;
    msaocupadaorcmesa: TIntegerField;
    msaocupadastocodigo: TIntegerField;
    msaocupadaitem: TIntegerField;
    ItemIngredienteNormal: TUniQuery;
    ItemIngredienteNormalitoitem: TIntegerField;
    ItemIngredienteNormalprocodigo: TIntegerField;
    ItemIngredienteNormalisitipo: TIntegerField;
    ItemIngredienteNormalsbiobs: TStringField;
    ItemIngredienteNormalingnome: TStringField;
    ItemIngredienteNormaltsiidentificacao: TStringField;
    ItemIngredienteFra: TUniQuery;
    ItemIngredienteFraitoitem: TIntegerField;
    ItemIngredienteFraprocodigo: TIntegerField;
    ItemIngredienteFraisitipo: TIntegerField;
    ItemIngredienteFrasbiobs: TStringField;
    ItemIngredienteFraingnome: TStringField;
    ItemIngredienteFratsiidentificacao: TStringField;
    ItemSabor: TUniQuery;
    ItemSaboritoitem: TIntegerField;
    ItemSaborsbridentificacao: TStringField;
    ItemSaborsbichave: TIntegerField;
    ItemBorda: TUniQuery;
    ItemBordaitoitem: TIntegerField;
    ItemBordabrdidentificacao: TStringField;
    Item: TUniQuery;
    Itemitoitem: TIntegerField;
    Itemprocodigo: TIntegerField;
    Itempronome: TStringField;
    Itemitoquantidade: TFloatField;
    Itemunisimbolo: TStringField;
    Itemitovalorav: TFloatField;
    Itemitototalav: TFloatField;
    dvtbrd: TUniDataSource;
    vtbrd: TVirtualTable;
    vtbrdbrdcodigo: TIntegerField;
    vtbrdbrdidentificacao: TStringField;
    tbrd: TUniQuery;
    tbrdsfnid: TIntegerField;
    tbrdsfncodigo: TIntegerField;
    tbrdbrdcodigo: TIntegerField;
    dbrd: TUniDataSource;
    vtfIng: TVirtualTable;
    vtfIngsfnid: TIntegerField;
    vtfIngsfncodigo: TIntegerField;
    vtfIngsbrcodigo: TIntegerField;
    vtfIngprocodigo: TIntegerField;
    vtfIngtsicodigo: TIntegerField;
    vtfIngtipo: TIntegerField;
    vtfIngquantidade: TIntegerField;
    dfIngrediente: TUniDataSource;
    fIngrediente: TUniQuery;
    fIngredientesbrcodigo: TIntegerField;
    fIngredienteprocodigo: TIntegerField;
    fIngredientepronome: TStringField;
    fIngredientetsicodigo: TIntegerField;
    fIngredientetsiidentificacao: TStringField;
    fIngredientetipo: TIntegerField;
    fIngredienteobs: TStringField;
    fIngredienteitochave: TIntegerField;
    fIngredienteisiquantidade: TIntegerField;
    dvtpro: TUniDataSource;
    vtpro: TVirtualTable;
    vtprosfnid: TIntegerField;
    vtprosfncodigo: TIntegerField;
    vtprosbrcodigo: TIntegerField;
    vtprodescricao: TStringField;
    vtprocopos: TIntegerField;
    vtpropratos: TIntegerField;
    vtproobs: TStringField;
    dfsbr: TUniDataSource;
    fsbr: TUniQuery;
    fsbrsbrcodigo: TIntegerField;
    fsbrsbridentificacao: TStringField;
    fsbrprocodigo: TIntegerField;
    tisi: TUniQuery;
    tisisbrcodigo: TIntegerField;
    tisitsicodigo: TIntegerField;
    tisiprocodigo: TIntegerField;
    tisiisitipo: TIntegerField;
    tisisfncodigo: TIntegerField;
    tisisfnid: TIntegerField;
    tisiobs: TStringField;
    tisiisiitem: TIntegerField;
    tisibprchave: TIntegerField;
    tisiisiquantidade: TIntegerField;
    dAdc: TUniDataSource;
    Adc: TUniQuery;
    Adcprocodigo: TIntegerField;
    Adcpronome: TStringField;
    Adcgrpcodigo: TIntegerField;
    Adctsicodigo: TIntegerField;
    Adctsiidentificacao: TStringField;
    Adcisiquantidade: TIntegerField;
    dtsi: TUniDataSource;
    tsi: TUniQuery;
    tsitsicodigo: TIntegerField;
    tsitsiidentificacao: TStringField;
    dsbr: TUniDataSource;
    sbr: TUniQuery;
    sbrsbrcodigo: TIntegerField;
    sbrsbrprocodigo: TIntegerField;
    sbrprocodigo: TIntegerField;
    sbrpronome: TStringField;
    sbrtsicodigo: TIntegerField;
    sbrtsiidentificacao: TStringField;
    sbrtipo: TIntegerField;
    sbrobs: TStringField;
    sbritochave: TIntegerField;
    sbrisiquantidade: TIntegerField;
    MobGravaItens: TUniStoredProc;
    tito: TUniQuery;
    titoID: TIntegerField;
    titoprocodigo: TIntegerField;
    titopuncodigo: TIntegerField;
    titoclbcodigo: TIntegerField;
    titoqtde: TFloatField;
    titopessoas: TIntegerField;
    titoobs: TStringField;
    titosfnid: TIntegerField;
    titosfncodigo: TIntegerField;
    titocopos: TIntegerField;
    titopratos: TIntegerField;
    dpun: TUniDataSource;
    pun: TUniQuery;
    punpuncodigo: TIntegerField;
    pununisimbolo: TStringField;
    punpunprecoav: TFloatField;
    punvlvenda: TStringField;
    MobAbreMesa: TUniStoredProc;
    dsfn: TUniDataSource;
    dproc: TUniDataSource;
    sfn: TUniQuery;
    sfnprocodigo: TIntegerField;
    sfnpuncodigo: TIntegerField;
    sfnpronomereduzido: TStringField;
    sfnpunprecoav: TStringField;
    sfnunipro: TIntegerField;
    sfnunipun: TIntegerField;
    sfnunisimbolo: TStringField;
    sfnsfnquantidade: TFloatField;
    sfnsfncodigo: TIntegerField;
    proc: TUniQuery;
    procprocodigo: TIntegerField;
    procpronomereduzido: TStringField;
    procpunprecoav: TStringField;
    dGrp: TUniDataSource;
    grp: TUniQuery;
    grpgrpcodigo: TIntegerField;
    grpgrpidentificacao: TStringField;
    grptpocodigo: TIntegerField;
    dVtiItens: TUniDataSource;
    vtItens: TVirtualTable;
    vtItensitoitem: TIntegerField;
    vtItensprocodigo: TIntegerField;
    vtItenspronome: TStringField;
    vtItenspuncodigo: TIntegerField;
    vtItensitoquantidade: TFloatField;
    vtItensunisimbolo: TStringField;
    vtItensStatus: TIntegerField;
    vtItensObs: TStringField;
    vtItenstipo: TIntegerField;
    vtItenssfncodigo: TIntegerField;
    vtItensitochave: TIntegerField;
    vtItenscopos: TIntegerField;
    vtItenspratos: TIntegerField;
    vtItenshoraimprimiu: TStringField;
    dIto: TUniDataSource;
    dOrc: TUniDataSource;
    dMsa: TUniDataSource;
    dClb: TUniDataSource;
    ito: TUniQuery;
    itoitochave: TIntegerField;
    itoitoitem: TIntegerField;
    itoprocodigo: TIntegerField;
    itopronome: TStringField;
    itoitoquantidade: TFloatField;
    itounisimbolo: TStringField;
    itoitovalorav: TFloatField;
    itoitototalav: TFloatField;
    itopuncodigo: TIntegerField;
    itoimmhoraimpresso: TStringField;
    orc: TUniQuery;
    orcorcchave: TIntegerField;
    orcetdcodigo: TIntegerField;
    orcclbcodigo: TIntegerField;
    orcstocodigo: TIntegerField;
    orcorcmesa: TIntegerField;
    orcorcpessoas: TIntegerField;
    msa: TUniQuery;
    msamsachave: TIntegerField;
    msamsaabertura: TDateTimeField;
    msamsafechamento: TDateTimeField;
    msaclbcodigo: TIntegerField;
    msaorcchave: TIntegerField;
    msamsasituacao: TIntegerField;
    msamsanumero: TIntegerField;
    Consulta: TUniQuery;
    MySQLUniProvider: TMySQLUniProvider;
    clb: TUniQuery;
    clbclbcodigo: TIntegerField;
    clbclbidentificacao: TStringField;
    Conexao: TUniConnection;
    dsLetras: TUniDataSource;
    trm: TUniQuery;
    trmtrmcodigo: TIntegerField;
    trmtrmmesavendarapida: TIntegerField;
    Adcpunprecoav: TStringField;
    procedure UniGUIMainModuleCreate(Sender: TObject);
  private
    { Private declarations }
    vpConfigIni: TIniFile;
    procedure IncluirMesa;
  public
    { Public declarations }

    vpQtdeMesas: Integer;
    vpTituloOperador: String;

    function AlinhaTexto(Texto: String; Tamanho: Integer; Alinha: String = 'E'): String;
    function ConsultaSQL(Script: String): Boolean;
    function SQL(Script: String): Boolean;
    function VersaoExe(const FileNAme: String): String;



  end;

function UniMainModule: TUniMainModule;

implementation

{$R *.dfm}

uses
  UniGUIVars, ServerModule, uniGUIApplication;

function UniMainModule: TUniMainModule;
begin
  Result := TUniMainModule(UniApplication.UniMainModule)
end;


function TUniMainModule.AlinhaTexto(Texto: String; Tamanho: Integer; Alinha: String): String;
var
  vQtde, vCont: Integer;
  vRetorno: String;
begin
  if Length(Texto) >= Tamanho then
    vRetorno := Copy(Texto, Tamanho)
  else
  begin
    vRetorno := '';
    vCont := 1;
    vQtde := Length(Texto);
    vQtde := Tamanho - vQtde;

    While vCont <= vQtde do
    begin
      vRetorno := vRetorno + '_';
      vCont := vCont + 1;
    end;

    if Alinha = 'E' then
      vRetorno := Texto + vRetorno
    else
      vRetorno := vRetorno + Texto;
  end;
  Result := vRetorno;
end;

function TUniMainModule.ConsultaSQL(Script: String): Boolean;
begin
  Consulta.Close;
  Consulta.SQL.Clear;
  Consulta.SQL.Add(Script);
  Consulta.Open;

  Result := (not Consulta.IsEmpty);
end;

function TUniMainModule.SQL(Script: String): Boolean;
begin
  try
    Consulta.Close;
    Consulta.SQL.Clear;
    Consulta.SQL.Add(Script);
    Consulta.ExecSQL;
    Result := true;
  Except
    Result := False;
  end;
end;



procedure TUniMainModule.UniGUIMainModuleCreate(Sender: TObject);
var
  vIpServer, vDbServer: String;
  vlCaminho: string;
begin
  // Carregando informações de configuração do servidor de banco de dados
  vlCaminho := ExtractFilePath(ParamSTR(0)) + 'mobile.ini';
  if FileExists(ExtractFilePath(ParamSTR(0)) + 'mobile.ini') then
  begin
    vpConfigIni := TIniFile.Create(ExtractFilePath(ParamSTR(0)) + 'mobile.ini');
    vIpServer := vpConfigIni.ReadString('dados', 'server', 'Não foi informado o IP SERVIDOR  em "server"' + #13 + 'Verifique arquivo de configuração em :' +
      ExtractFilePath(ParamSTR(0)) + 'mobile.Ini');
    vDbServer := vpConfigIni.ReadString('dados', 'database', 'Não foi informado o NOME DO BANCO DE DADOS em "database"' + #13 + 'Verifique arquivo de configuração em :' +
      ExtractFilePath(ParamSTR(0)) + 'mobile.Ini');

    try
      Conexao.Close;
      Conexao.Server := vIpServer;
      Conexao.Database := vDbServer;
      Conexao.Open;

      UniMainModule.cfg.Close;
      UniMainModule.cfg.Connection := UniMainModule.Conexao;
      UniMainModule.cfg.Open;

      vpQtdeMesas := MainModule.UniMainModule.cfgcfgmgouqtdmesas.AsInteger;
      vpTituloOperador := MainModule.UniMainModule.cfgcfgmgounomelocal.asstring;

    except
      on E: Exception do
      begin
        ShowMessage('Erro - Ao abrir Conexão verifique as configurações no arquivo mobile.Ini' + #13 + 'Verifica arquivo de configuração em : ' + ExtractFilePath(ParamSTR(0)) + #13
          + '[' + E.ClassName + ']' + #13 + ' - mens - ' + E.Message + ']');
      end;
    end;
  end
  else
  begin
    ShowMessage('Não foi possível abrir Conexão verifique as configurações no arquivo mobile.Ini' + #13 + 'em : ' + ExtractFilePath(ParamSTR(0)));
    Exit;
  end;

end;

function TUniMainModule.VersaoExe(const FileNAme: String): String;
type
  TVersionInfo = packed record
    Dummy: array [0 .. 7] of Byte;
    V2, V1, V4, V3: Word;
  end;
var
  Zero, Size: Cardinal;
  Data: Pointer;
  VersionInfo: ^TVersionInfo;
begin
  Result := Format('%d.%d.%d.%d', [0, 0, 0, 0]);
end;

procedure TUniMainModule.IncluirMesa;
begin

  ttro.Append;
  ttromesa.asstring := trfmesamesa.asstring;
  ttroorcchave.AsInteger := trfmesaorcchave.AsInteger;
  ttroorcmesa.AsInteger := trfmesaorcmesa.AsInteger;
  ttro.Post;

  trfmesa.Edit;
  trfmesasel.AsInteger := 1;
  trfmesa.Post;

end;


initialization

RegisterMainModuleClass(TUniMainModule);

end.
