unit UntFinalizaMesa;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics,ufuncoes,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, uni, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.Grids, Vcl.DBGrids,ufstonehide,
  Vcl.ComCtrls, Vcl.ExtCtrls, Vcl.Mask, Vcl.DBCtrls, UntPegaConst, Data.DB,
  DBAccess, MemDS,uftransacaoLTETEFAPI,uRecordsTEF,
  UntPegaUtils, uPegaBase, System.DateUtils, Winapi.WinInet;

type
  TRotinasNFe = (rnfGerarNFe, rnfImprimirNFe, rnfGerarPDF, rnfEmail, rnfCancelar, rnfCartaCorrecao, rnfEmailEvento, rnfImprimirEvento,
    rnfConsultaEvento, rnfGerarXML, rnfInutilizar, rnfStatusSefaz, rnfStatusNFe, rnfInutilizarDireto, rnfManifDestDesconhecimento, rnfGerarPrevia,
    rnfReGerarXML);

type
  TFrmFinalizaMesa = class(TForm)
    PnQuantidade: TPanel;
    Panel15: TPanel;
    Label2: TLabel;
    Panel17: TPanel;
    Panel18: TPanel;
    PnSabores: TPanel;
    Label7: TLabel;
    Button6: TButton;
    Button5: TButton;
    EdtQtde: TEdit;
    Panel20: TPanel;
    btnqtdeconfirma: TButton;
    btnqtdecancela: TButton;
    PnTroco: TPanel;
    Panel68: TPanel;
    Panel69: TPanel;
    Panel70: TPanel;
    Button2: TButton;
    Panel71: TPanel;
    Panel72: TPanel;
    Label14: TLabel;
    EdtVlResto: TEdit;
    Label15: TLabel;
    Label13: TLabel;
    DataSource1: TDataSource;
    Panel3: TPanel;
    PCFechamento: TPageControl;
    TabItens: TTabSheet;
    Panel4: TPanel;
    Panel6: TPanel;
    Label1: TLabel;
    DBGrid4: TDBGrid;
    Panel16: TPanel;
    Panel37: TPanel;
    Panel13: TPanel;
    LbItemTotal: TLabel;
    LbItemQtde: TLabel;
    Panel48: TPanel;
    Panel5: TPanel;
    BtnIncSabores: TBitBtn;
    BtnExcSabores: TBitBtn;
    Panel7: TPanel;
    Panel8: TPanel;
    Label3: TLabel;
    DBGridItens: TDBGrid;
    Panel9: TPanel;
    Panel1: TPanel;
    LbItemDispValor: TLabel;
    LbItemDispQtde: TLabel;
    Panel12: TPanel;
    Panel14: TPanel;
    BtnConfirmar: TButton;
    BtnCancelar: TButton;
    Panel21: TPanel;
    Button1: TButton;
    Panel19: TPanel;
    LbPendente: TLabel;
    LbRecebido: TLabel;
    TabResumo: TTabSheet;
    Panel23: TPanel;
    Label4: TLabel;
    Panel22: TPanel;
    Panel24: TPanel;
    Button9: TButton;
    Button10: TButton;
    Button11: TButton;
    PnRecebimentos: TPanel;
    PnItensRecebidos: TPanel;
    DBGrid2: TDBGrid;
    DBGrid1: TDBGrid;
    TabPedidos: TTabSheet;
    Panel25: TPanel;
    Label9: TLabel;
    Panel36: TPanel;
    Panel41: TPanel;
    BtnPedConfirma: TButton;
    Button3: TButton;
    Panel42: TPanel;
    BtnImprimir: TButton;
    Btcancelar: TButton;
    Panel43: TPanel;
    Panel44: TPanel;
    DBGrid3: TDBGrid;
    DBGridPedidos: TDBGrid;
    Panel30: TPanel;
    Label5: TLabel;
    Label17: TLabel;
    Label18: TLabel;
    Label19: TLabel;
    Label21: TLabel;
    EdtPedido: TEdit;
    EdtCliente: TEdit;
    EdtTelefone: TEdit;
    EdtEntregador: TEdit;
    TabRecebimento: TTabSheet;
    Panel26: TPanel;
    Panel74: TPanel;
    Panel75: TPanel;
    Label16: TLabel;
    plModalConvenios: TPanel;
    Panel77: TPanel;
    Panel78: TPanel;
    EdtConvenio: TEdit;
    PnModalConvenio: TPanel;
    plqlimitedisponivel: TPanel;
    plcontroleLimite: TPanel;
    pltitlimitetotal: TPanel;
    pllimitetotal: TPanel;
    pltitlimitedisponivel: TPanel;
    pllimitedisponivel: TPanel;
    plModalCartaoCredito: TPanel;
    Panel82: TPanel;
    Panel83: TPanel;
    EdtCardCredito: TEdit;
    PnModalCardCre: TPanel;
    plModalCartaoDebito: TPanel;
    Panel87: TPanel;
    Panel88: TPanel;
    EdtCardDebito: TEdit;
    PnModalCardDeb: TPanel;
    plModalDinheiro: TPanel;
    Label20: TLabel;
    Panel92: TPanel;
    Panel93: TPanel;
    EdtDinherio: TEdit;
    plModalCheque: TPanel;
    Panel97: TPanel;
    Panel98: TPanel;
    EdtCheque: TEdit;
    PnModalCheque: TPanel;
    Panel101: TPanel;
    Panel102: TPanel;
    BtnTabRecConfirma: TButton;
    Button7: TButton;
    BtnRecVoltar: TButton;
    BtnRecLimpar: TButton;
    PnCliente: TPanel;
    LbNomeCliente: TLabel;
    EdtNomeCliente: TEdit;
    Panel67: TPanel;
    LbCliente: TLabel;
    Panel73: TPanel;
    BtCarregacliente: TButton;
    plDisponivel: TPanel;
    Panel28: TPanel;
    Panel31: TPanel;
    Label6: TLabel;
    EdtVlrPago: TEdit;
    plsubtotalcomtaxa: TPanel;
    Label26: TLabel;
    EditTotalComTaxa: TEdit;
    edValorTaxa: TEdit;
    cbDescontarTaxa: TComboBox;
    Panel45: TPanel;
    Panel46: TPanel;
    Panel47: TPanel;
    Label22: TLabel;
    Panel104: TPanel;
    EdtFalta: TEdit;
    Panel60: TPanel;
    Panel61: TPanel;
    Panel62: TPanel;
    Label12: TLabel;
    plvalorinformado: TLabel;
    Panel65: TPanel;
    Panel66: TPanel;
    EdtTroco: TEdit;
    plModalAFaturars: TPanel;
    Panel110: TPanel;
    Panel111: TPanel;
    edtAFaturar: TEdit;
    plModalAFaturar: TPanel;
    plModalDoacoes: TPanel;
    Panel80: TPanel;
    Panel84: TPanel;
    edtDoacao: TEdit;
    plModalDoacao: TPanel;
    plProcessamento: TPanel;
    Panel34: TPanel;
    Label8: TLabel;
    Panel38: TPanel;
    EdtVlrTotal: TEdit;
    Panel55: TPanel;
    Label11: TLabel;
    Panel57: TPanel;
    EdtVlrReceber: TEdit;
    Panel50: TPanel;
    Panel52: TPanel;
    Label10: TLabel;
    EdtDesconto: TEdit;
    btDescontoPerc: TBitBtn;
    Panel27: TPanel;
    PnPercentual: TPanel;
    Panel115: TPanel;
    Label23: TLabel;
    Panel116: TPanel;
    Panel117: TPanel;
    Button4: TButton;
    Panel118: TPanel;
    Panel119: TPanel;
    Label24: TLabel;
    Label25: TLabel;
    EdtPercentual: TEdit;
    dolt: TUniDataSource;
    Button12: TButton;
    MemPro: TRichEdit;
    DataSourceIto: TDataSource;
    Button13: TButton;
    Panel2: TPanel;
    Label27: TLabel;
    DBGridResumoitens: TDBGrid;
    LbjaRecebido: TLabel;
    plModalCreditos: TPanel;
    Panel11: TPanel;
    Panel29: TPanel;
    edtCredito: TEdit;
    plModalCredito: TPanel;
    plModalPIXS: TPanel;
    Panel33: TPanel;
    Panel35: TPanel;
    EdtPIX: TEdit;
    plModalPIX: TPanel;
    plMensagem: TPanel;
    procedure BtnCancelarClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure BtnIncSaboresClick(Sender: TObject);
    procedure btnqtdeconfirmaClick(Sender: TObject);
    procedure btnqtdecancelaClick(Sender: TObject);
    procedure EdtQtdeKeyPress(Sender: TObject; var Key: Char);
    procedure Button5Click(Sender: TObject);
    procedure Button6Click(Sender: TObject);
    procedure EdtQtdeExit(Sender: TObject);
    procedure BtnExcSaboresClick(Sender: TObject);
    procedure BtnRecVoltarClick(Sender: TObject);
    procedure BtnConfirmarClick(Sender: TObject);
    procedure plModalCartaoDebitoMouseEnter(Sender: TObject);
    procedure plModalCartaoDebitoMouseLeave(Sender: TObject);
    procedure PnModalCardDebMouseEnter(Sender: TObject);
    procedure PnModalCardDebMouseLeave(Sender: TObject);
    procedure PnModalChequeMouseEnter(Sender: TObject);
    procedure PnModalChequeMouseLeave(Sender: TObject);
    procedure PnModalCardCreMouseEnter(Sender: TObject);
    procedure PnModalCardCreMouseLeave(Sender: TObject);
    procedure PnModalConvenioMouseEnter(Sender: TObject);
    procedure PnModalConvenioMouseLeave(Sender: TObject);
    procedure PnModalConvenioMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure TabRecebimentoShow(Sender: TObject);
    procedure EdtVlrPagoExit(Sender: TObject);
    procedure EdtVlrPagoKeyPress(Sender: TObject; var Key: Char);
    procedure EdtDinherioExit(Sender: TObject);
    procedure EdtVlrPagoChange(Sender: TObject);
    procedure EdtNomeClienteKeyPress(Sender: TObject; var Key: Char);
    procedure BtnTabRecConfirmaClick(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Button1Click(Sender: TObject);
    procedure Button9Click(Sender: TObject);
    procedure doltDataChange(Sender: TObject; Field: TField);
    procedure PnModalChequeMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure PnModalCardDebMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure PnModalCardCreMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure BtnRecLimparClick(Sender: TObject);
    procedure DBGridItensKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGrid4KeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGrid1KeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGrid2KeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGridPedidosDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure DBGridPedidosKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGridPedidosCellClick(Column: TColumn);
    procedure Button10Click(Sender: TObject);
    procedure EdtCardCreditoExit(Sender: TObject);
    procedure EdtCardDebitoExit(Sender: TObject);
    procedure EdtDescontoExit(Sender: TObject);
    procedure EdtDescontoChange(Sender: TObject);
    procedure EdtDescontoKeyPress(Sender: TObject; var Key: Char);
    procedure Button3Click(Sender: TObject);
    procedure BtnPedConfirmaClick(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure EdtVlRestoChange(Sender: TObject);
    procedure EdtVlRestoKeyPress(Sender: TObject; var Key: Char);
    procedure EdtPedidoEnter(Sender: TObject);
    procedure EdtPedidoExit(Sender: TObject);
    procedure EdtClienteChange(Sender: TObject);
    procedure EdtClienteEnter(Sender: TObject);
    procedure EdtTelefoneEnter(Sender: TObject);
    procedure EdtEntregadorEnter(Sender: TObject);
    procedure EdtTelefoneChange(Sender: TObject);
    procedure EdtEntregadorChange(Sender: TObject);
    procedure DBGridPedidosTitleClick(Column: TColumn);
    procedure EdtTelefoneExit(Sender: TObject);
    procedure EdtPedidoKeyPress(Sender: TObject; var Key: Char);
    procedure EdtClienteKeyPress(Sender: TObject; var Key: Char);
    procedure EdtTelefoneKeyPress(Sender: TObject; var Key: Char);
    procedure EdtEntregadorKeyPress(Sender: TObject; var Key: Char);
    procedure DBGridPedidosKeyPress(Sender: TObject; var Key: Char);
    procedure TabPedidosShow(Sender: TObject);
    procedure BtnPedConfirmaKeyPress(Sender: TObject; var Key: Char);
    procedure BtCarregaclienteClick(Sender: TObject);
    procedure TabItensShow(Sender: TObject);
    procedure EdtNomeClienteEnter(Sender: TObject);
    procedure EdtNomeClienteExit(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure BtnImprimirClick(Sender: TObject);

    procedure edtAFaturarExit(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure btDescontoPercClick(Sender: TObject);
    procedure DBGrid3DrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure edtDoacaoExit(Sender: TObject);
    procedure plModalAFaturarMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure plModalAFaturarMouseEnter(Sender: TObject);
    procedure plMOdalAFaturarMouseLeave(Sender: TObject);
    procedure BtcancelarClick(Sender: TObject);
    procedure cbDescontarTaxaChange(Sender: TObject);
    procedure edValorTaxaExit(Sender: TObject);
    procedure Button11Click(Sender: TObject);
    procedure Button12Click(Sender: TObject);
    procedure DataSourceItoDataChange(Sender: TObject; Field: TField);
    procedure Button13Click(Sender: TObject);
    procedure plDoacaoMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure plModalDoacaoMouseEnter(Sender: TObject);
    procedure plModalDoacaoMouseLeave(Sender: TObject);
    procedure DBGridResumoitensKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure TabItensEnter(Sender: TObject);
    procedure edtCreditoExit(Sender: TObject);
    procedure cbDescontarTaxaEnter(Sender: TObject);
    procedure DBGridItensCellClick(Column: TColumn);
    procedure DBGridItensKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);
    procedure EdtPIXExit(Sender: TObject);
    procedure plModalPIXMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure plModalPIXMouseEnter(Sender: TObject);
    procedure plModalPIXMouseLeave(Sender: TObject);
    procedure plModalCreditoMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure plModalCreditoMouseEnter(Sender: TObject);
    procedure plModalCreditoMouseLeave(Sender: TObject);
    procedure EdtConvenioExit(Sender: TObject);
    procedure EdtChequeExit(Sender: TObject);
    procedure cbDescontarTaxaCloseUp(Sender: TObject);
    procedure EdtDinherioKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdtCardDebitoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdtCardCreditoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdtChequeKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdtPIXKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdtConvenioKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtAFaturarKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtDoacaoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtCreditoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);

  private
    { Private declarations }

    FCodigoADC: Integer;
    FAdquirenteADC: String;
    FContaADC: Integer;
    FEntidadeADC: Integer;

    festabelecimentotipotef:string;
    festabelecimentocnpj:string;
    festabelecimentorazaosocial:string;
    fterminalcodempresa:string;
    fterminalcodfilial:string;
    fterminalcodterminal:string;
    fterminalenderecoservidor:string;
    fterminalportapinpad:string;

    flteChave:string;
    flteprincipal: currency;
    fltedesconto: currency;
    flteliquido: currency;
    fltetroco: currency;
    flterecebido: currency;

    fdtlChave:Integer;
    fTdfCodigo:String;

    FDataAtual: TDate;
    FContaCaixa: Integer;
    FContaPIX: Integer;
    FCcxchave: Integer;
    fusacre: Integer;
    FUsaAdc: Integer;
    fTEFAtivo: Boolean;
    fcontrolalimite: Integer;



    fOperador: String;
    fTeclaFinalizador: Integer;
    fDocumentoFiscal: String;
    FWebOnLine: Boolean;
    fStatusVenda: TStatusVenda;
    vpIdcCodigo:String;

    function mostralista(pModulo, pUsuario: string; pFiltro: string): string;
    function Imprime(pOrcChave: Integer): String;
    function ModuloNFCe(vmeschave: string): Boolean;

    procedure IncluirItem;
    procedure InformarQtde;
    procedure LimpaRecebimento;
    procedure SomaItens;
    procedure RemoverItem;
    procedure MostraTab(Tab: TTabSheet);
    procedure LancaConvenio;
    procedure LancaCartao(pMdaCodigo: Integer; EdtDados: TEdit);
    procedure LancaCheque;
    procedure LancaDoacao;
    procedure LancaCredito;

    procedure ValidaRecDinheiro;
    procedure ValidaRecPIX;
    procedure ValidaRecAFaturar;
    procedure ValidaRecCardCredito;
    procedure ValidaRecCardDedito;
    procedure ValidaReccredito;
    procedure ValidaRecDesconto;
    procedure ValidaRecdoacao;
    procedure ValidaRecConvenio;

    procedure EncerraMesa;
    procedure CalculaRecebimentos;
    procedure EmiteDocumento(pMesChave: Integer);
    procedure EmiteRecibo(pLteChave: Integer);
    procedure EmiteComprovante(pMesChave: Integer);
    procedure IniciaRecebimento;
    procedure CalculaTroco;
    procedure LimpaEdtBusca;
    procedure BuscaCliente;
    procedure Receber;
    procedure ConfirmaRecebimento;
    procedure LancaConvenioAutomagico;
    procedure GerarParcelas(VlrParcela: Currency; vetdcodigo: Integer);
    procedure ImprimeEntrega(pOrcChave: Integer);
    procedure InformarPercentualDesconto;


    function RegistraCartao(aDtlchave: Integer; aValor: Currency; aQuantidadeParcelas:String='1'): TOperacaoTEF;
    procedure GravaRegistroCartao(vdtlchave: String; vTotal: Double; vrdcnrauto: string = '');



    function AjustaTit(vtitcodigo: string; vetdcodigo: Integer; vtitnumero: String; vtitvalor: Double; vtitemissao, vtitvctoinicial: TDate;
      vtfdcodigo, vtficodigo: Integer; vtithistorico: String; vtitvalorparcela: Double; vtitparcelas: Integer;
      vtitmoradia, vtitvalomulta, vtitpercmesmora, vtitvalodesc, vtitpercmulta, vtitpercmesmulta: Double; vbcocodigo: String;
      vcarcodigo, vtitdiasmulta, vtitdiasdesc: Integer): Integer;
    function AjustaRfi(vtitcodigo: string; vVencimento: TDate; vParcela: Integer; vvalor: Double; vrdauto: string = ''): Integer;
    procedure ConssolidaRecebimentos;
    function LimiteAutorizado(vetdcodigo: String; vValorVenda, vlLimiteSolic, vlLimiteDisponivel: Double; vpOrcChave: Integer): Boolean;
    function CarregalimiteCliente(vetdcodigo: Integer): Double;
    procedure ajustafalta;
    procedure ApresentaItem(pOrcChave, pItoChave: Integer);
    procedure AlteraFonte(pObjeto: TRichEdit; pTamanho: Integer; pTipo: TFontStyle; pCor: TColor);
    function modulonfe(arq: String; Rotina: TRotinasNFe; chave: String): Boolean;

    procedure LancaPIX;
    procedure ValidaRecebimento(var vModalidade: Currency; vValorInformado: Currency; vedCampo: TEdit);
    procedure AjustuarTributacao;
    function CNPJCPFInformado: Boolean;
    procedure ExibirMensagem(const Mensagem: string;
      MilissegundosExibicao: Integer);
    procedure ExibirMensagemPorTempo(const Mensagem: string;
      MilissegundosExibicao: Integer);
    function GeraSequencial: String;
    procedure CarregaDadosConfiguracaoTEF;
    procedure DadosConfiguracao;
    function GetHoraAtual: TTime;
    function TemOperacaoTEF(aMeschave: String): boolean;
    function ValorDigitado: Currency;

    procedure EncerraRecebimentoStone;
    procedure GerarTituloVenda(VlrParcela: Currency; vetdcodigo: Integer);
    procedure GeraComprovantesTEF(vlmeschave: string);
    procedure AjustaHistoricos(aMesChave: string; aLteChave:string);
    procedure AjustaRFMConvenio(aMesChave: string);
    procedure RegistraClienteIdentificado;
  var
    fCPFnaNota:String;

    vppodefechar: Boolean;

    vpTotal: Currency;
    vpTroco: Currency;
    vpReceber: Currency;
    vpTaxaParcial: Currency;
    vpDinheiro: Currency;

    vpPIX: Currency;
    vpPIXAuto:String;
    vpPIXVia1:String;
    vpPIXbdc:String;

    vpConvenio: Currency;

    vpCardDebito: Currency;
    vpCardDebitoAuto:String;
    vpCardDebitoVia1:String;
    vpCardDebitobdc:String;


    vpCardCredito: Currency;
    vpCardCreditoAuto:String;
    vpCardCreditoVia1:String;
    vpCardCreditobdc:String;


    vpAFaturar: Currency;
    vpDoacao: Currency;
    vpcredito: Currency;

    vpCheque: Currency;
    vpFalta: Currency;
    vpRecebimentos: Currency;
    vpTipoRec: Integer; // 1 - Gourmet | 2 - Delivery
    vpDescRec: Currency;
    vpRecNo: Integer;
    vpRegistraCartao: Boolean;
    vpRegistraPIX: Boolean;

    vpDescontoMaximo: Currency;

    vpkey: Boolean;
    vpImpConvenio: Boolean;


  public
    { Public declarations }
    vpDesconto: Currency;
    vpMesaAtual: String;
    vpOrcChave: string;
    vpMeschaveParcial: String;
    vpOrcchaveParcial: String;
    vpOrcChaveDelivery: string;
    vpEtdCodigo: Integer;
    vpTotalGeral: Currency;
    vpFechada: Boolean;
    vpMeschave: Integer;
    vpLtechave: Integer;
    vpEtlDescontoPadrao: Double;
    procedure AtualizaLimiteTela(vetdcodigo: string);
    procedure CalculaTaxaParcial;

  published
    property CPFnaNota: String read fCPFnaNota write fCPFnaNota;
    property Operador: String read fOperador write fOperador;


    property CodigoADC: Integer read FCodigoADC write FCodigoADC;
    property AdquirenteADC: String read FAdquirenteADC write FAdquirenteADC;
    property ContaADC: Integer read FContaADC write FContaADC;
    property EntidadeADC: Integer read FEntidadeADC write FEntidadeADC;


    property DataAtual: TDate read FDataAtual write fDataAtual;
    property HoraAtual: TTime read GetHoraAtual;
    property ContaCaixa: Integer read FContaCaixa write FContaCaixa;
    property ContaPIX: Integer read FContaPIX write FContaPIX;


    property UsaCre: Integer read FUsaCre write FUsaCre;
    property UsaAdc: Integer read FUsaAdc write FUsaAdc;
    property ControlaLimite: Integer read FControlaLimite write FControlaLimite;

    property estabelecimentocnpj: String read festabelecimentocnpj write festabelecimentocnpj;
    property estabelecimentorazaosocial: String read festabelecimentorazaosocial write festabelecimentorazaosocial;

    property estabelecimentotipotef:string read festabelecimentotipotef write festabelecimentotipotef;
    property terminalcodempresa:string read fterminalcodempresa write fterminalcodempresa;
    property terminalcodfilial:string read fterminalcodfilial write fterminalcodfilial;
    property terminalcodterminal:string read fterminalcodterminal write fterminalcodterminal;
    property terminalenderecoservidor:string read fterminalenderecoservidor write fterminalenderecoservidor;
    property terminalportapinpad:string read fterminalportapinpad write fterminalportapinpad;

    property lteprincipal: currency  read flteprincipal write flteprincipal;
    property ltedesconto: currency  read fltedesconto write fltedesconto;
    property lteliquido: currency  read flteliquido write flteliquido;
    property ltetroco: currency  read fltetroco write fltetroco;
    property lterecebido: currency  read flterecebido write flterecebido;

    property DtlChave: Integer read fDtlChave write fDtlChave;
    property TdfCodigo: String read fTdfCodigo write fTdfCodigo;

    property StatusVenda: TStatusVenda read fStatusVenda write fStatusVenda;
    property DocumentoFiscal: String read fDocumentoFiscal write fDocumentoFiscal;

    property WebOnLine: Boolean read FWebOnLine write FWebOnLine;




  end;

  TClienteSimples = function(AOwner: TComponent; conexao: TUniConnection; vmeschave: string; vClbCodigo: string): string;

var
  FrmFinalizaMesa: TFrmFinalizaMesa;
  fOperacaoTEF:TOperacaoTEF;
  fConfiguracaoTEF: TConfiguracaoTEF;


implementation

uses
  UntDmDados,
  UntParcela, System.Math, UntPrincipal, frExibeMensagem, frExibeMensagemPorTempo;

{$R *.dfm}

{ TFrmFinalizaMesa }
type
  { expor propriedades e metodso privadas e protegindos do dbgrid }
  TFriendly = class(TCustomDBGrid);

Function BuscaTroca(Text, Busca, Troca: String): String;

Var
  N: Integer;
Begin

  For N := 1 To Length(Text) Do
  Begin
    If Copy(Text, N, 1) = Busca Then
    Begin
      Delete(Text, N, 1);
      Insert(Troca, Text, N);
    End;
  End;

  result := Text;
End;

function InternetAtiva: Boolean;
var
  Flags: Cardinal;
begin
  result := False;
  if not InternetGetConnectedState(@Flags, 0) then
    result := False
  else
    result := true;
end;

Function TBTruncate(Valor: Real; Decimal: Integer): Real;
Var
  Aux: String;
Begin
  Valor := Valor * 100000;
  Aux := formatfloat('00000000000000000000', Valor);
  Aux := Copy(Aux, 1, 15) + Copy(Aux, 16, Decimal);
  Case Decimal Of
    2:
      Valor := Strtofloat(Aux) / 100;
    3:
      Valor := Strtofloat(Aux) / 1000;
    4:
      Valor := Strtofloat(Aux) / 10000;
    5:
      Valor := Strtofloat(Aux) / 100000;
  End;
  result := Valor;
End;

procedure TFrmFinalizaMesa.btDescontoPercClick(Sender: TObject);
begin
  BtnRecLimpar.Click;
  InformarPercentualDesconto;
end;

procedure TFrmFinalizaMesa.BtcancelarClick(Sender: TObject);
var
  vlOrcchave: string;
  vlRecno: Integer;
  value: string;
begin
  if FPrinciGou.Autorizado(FPrinciGou.ActiCancelarDelivery, 'Cacelamento de pedido de Delivery') then
  begin

    vlRecno := DmDados.dorcdlv.DataSet.RecNo;
    vlOrcchave := DmDados.dorcdlv.DataSet.FieldByName('orcchave').AsString;

    value := inputbox('Cancelamento', 'Por fovor informe o motivo do cancelamento.', '');

    if value = '' then
      exit;

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'update orc set orcobs=' + QuotedStr(value) + ' where orcchave=' + vlOrcchave;
    DmDados.Consulta.ExecSQL;

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'update orc set stocodigo=88 where orcchave=' + vlOrcchave;
    DmDados.Consulta.ExecSQL;

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'update ito set stocodigo=88 where orcchave=' + vlOrcchave;
    DmDados.Consulta.ExecSQL;

    DmDados.dorcdlv.DataSet.Refresh;

    DmDados.dorcdlv.DataSet.RecNo := vlRecno;
  end;
end;


Function TFrmFinalizaMesa.GeraSequencial:String;
var
  vlDtl:TUniquery;
  vlSequencial:String;
begin

  vlDtl:=TUniquery.Create(nil);

  vlDtl.Close;
  vlDtl.Connection := dmdados.Conexao;
  vlDtl.SQL.Text:='SELECT max(dtlchave)+1 as sequencial from dtl';
  vlDtl.Open;
  Result := vlDtl.FieldByName('sequencial').AsString;

  vlDtl.close;
  vlDtl.Free;

end;

{
Function TFrmFinalizaMesa.GeraSequencial:String;
var
  vlSequencial: String;
  vlData:String;

  vlValorData:Double;
  vlyyyy:String;
  vlmm:String;
  vldd:String;
  vlhh:String;
  vlnn:String;
  vlss:String;

begin

  vlData := FormatDateTime('yyyymmddhhnnss', Now());

  vlyyyy:=copy(vlData,3,2);
  vlmm:=copy(vlData,5,2);
  vldd:=copy(vlData,7,2);
  vlhh:=copy(vlData,9,2);
  vlnn:=copy(vlData,11,2);
  vlss:=copy(vlData,13,2);


  vlValorData:= StrToInt(vlyyyy)+StrToInt(vlmm)+StrToInt(vldd)+StrToInt(vlhh)+StrToInt(vlnn)+StrToInt(vlss);

  vlValorData:= StrToInt(vlyyyy)+StrToInt(vlmm)+StrToInt(vldd)+StrToInt(vlhh)+StrToInt(vlnn)+StrToInt(vlss);


  vlData:=Floattostr(vlValorData);

  vlSequencial:=sonumeros(vlData);
  Result := vlSequencial;
end;
}


procedure TFrmFinalizaMesa.BtnCancelarClick(Sender: TObject);
begin


    if (EdtCardDebito.Text<>'') and (EdtCardDebito.Text<>'0,00') then
    begin
      ShowMessage('Já possui recebimento de Cartão de Débito!'+#13+'Não pode ser cancelado, conclua o fechamento!');
      exit;
    end;

    if (EdtCardCredito.Text<>'') and (EdtCardcredito.Text<>'0,00') then
    begin
      ShowMessage('Já possui recebimento de Cartão de Crédito!'+#13+'Não pode ser cancelado, conclua o fechamento!');
      exit;
    end;

    if (EdtPIX.Text<>'') and (EdtPIX.Text<>'0,00') then
    begin
      ShowMessage('Já possui recebimento de PIX!'+#13+'Não pode ser cancelado, conclua o fechamento!');
      exit;
    end;

  

  DmDados.dtitem.DataSet.First;
  while DmDados.dtitem.DataSet.RecordCount > 0 do
  begin
    BtnExcSabores.onClick(BtnExcSabores);
  end;

  { DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'delete from olt where orcchave=' + FPrinciGou.vpOrcChave;
    DmDados.Consulta.ExecSQL; }
  modalresult := mrcancel;
  Close;
end;

procedure TFrmFinalizaMesa.BtnConfirmarClick(Sender: TObject);
var
  vldispo: Double;
  vlvlrdispo: string;

  vlemaberto: Double;
  vlareceber: Double;

begin

  vlemaberto := 0;
  vlareceber := 0;

  vlemaberto := Strtofloat(StringReplace(trim(Copy(LbPendente.Caption, 12, 20)), '.', '', [rfReplaceAll, rfIgnoreCase]));
  vlareceber := Strtofloat(StringReplace(trim(Copy(LbItemTotal.Caption, 1, 20)), '.', '', [rfReplaceAll, rfIgnoreCase]));

  if vlareceber > vlemaberto then
  begin
    ShowMessage('Valor do(s) produto(s) selecionados é maior que o valor pendente!');
    exit;

  end;

  vlvlrdispo := trim(Copy(LbItemDispValor.Caption, 9, 100));
  vlvlrdispo := StringReplace(vlvlrdispo, '.', '', [rfReplaceAll, rfIgnoreCase]);
  // vlvlrdispo := StringReplace(vlvlrdispo, ',', '.', [rfReplaceAll, rfIgnoreCase]);

  vldispo := 0;
  vldispo := Strtofloat(vlvlrdispo);

  if vldispo < 0 then
  begin
    ShowMessage('Não deve selecionar produtos se ao pagamento é total.' + #13#13 + 'Apenas clique em confirma!');
    exit;
  end;

  if (DmDados.dIto.DataSet.RecordCount = 0) and (DmDados.dtitem.DataSet.RecordCount <> 0) then
  begin
    DmDados.dtitem.DataSet.First;
    while DmDados.dtitem.DataSet.RecordCount > 0 do
    begin

      BtnExcSabores.onClick(BtnExcSabores);

    end;

    { ShowMessage('Não deve selecionar produtos se ao pagamento é total.' + #13#13 + 'Apenas clique em confirma!');
      exit;^ }
  end;

  try
    BtnConfirmar.Enabled := False;

    if DmDados.dtitem.DataSet.Active then
    begin
      if not DmDados.dtitem.DataSet.IsEmpty then
      begin
        EdtNomeCliente.Color := clYellow;

      end
      else
        EdtNomeCliente.Color := clWhite;

    end
    else
      EdtNomeCliente.Color := clWhite;

    Receber;
  finally
    BtnConfirmar.Enabled := true;
  end;
end;

procedure TFrmFinalizaMesa.Receber;
var
  vSQL: String;
begin
  vSQL := 'SELECT orc.stocodigo, sto.stoidentificacao ' + '  FROM orc ' + ' INNER JOIN sto ON orc.stocodigo = sto.stocodigo ' +
    ' WHERE orc.orcchave = ' + vpOrcChave;
  DmDados.ConsultaSQL(vSQL);
  if not(DmDados.Consulta.Fields[0].AsInteger in [1, 2, 5]) then
  begin
    ShowMessage('Atenção, ' + DmDados.Usuario.TituloOperador + ' atual teve sua situação alterada para ' + DmDados.Consulta.Fields[1].AsString +
      ', verifique ');
    vpFechada := true;
    Close;
    exit;
  end;
  // atualizar valor a receber
  if DmDados.titem.IsEmpty then
  begin
    vpTotal := TBRound((vpTotalGeral - vpRecebimentos), 2);
   // vpDesconto := 0;
    vpReceber := TBRound((vpTotalGeral - vpRecebimentos + vpTaxaParcial), 2);
  end;
  LimpaRecebimento;
  MostraTab(TabRecebimento);

end;

procedure TFrmFinalizaMesa.BtnExcSaboresClick(Sender: TObject);
begin
  try
    BtnExcSabores.Enabled := False;
    if not DmDados.titem.IsEmpty then
      RemoverItem;
  finally
    DBGridItens.Repaint;
    BtnExcSabores.Enabled := true;
  end;
end;

procedure TFrmFinalizaMesa.BtnImprimirClick(Sender: TObject);
begin
  if not DmDados.orcdlv.IsEmpty then
    ImprimeEntrega(DmDados.orcdlvorcchave.AsInteger);
end;

procedure TFrmFinalizaMesa.ImprimeEntrega(pOrcChave: Integer);
var
  vlNomeArq: string;
  vlTciCodigo: string;
  vlNumePedido: string;
begin
  DmDados.gri.Close;
  DmDados.gri.Open;

  vlNomeArq := Extractfilepath(Application.ExeName) + 'relat\comprovanteDelivery.fr3';

  DmDados.grirelarquivo.SaveToFile(vlNomeArq);

  if FileExists(vlNomeArq) then
  begin

    DmDados.ExecutaSQL('update orc set orcimpressao = (IFNULL(orcimpressao,0) + 1) where orcchave = ' + IntToStr(pOrcChave));
    // DmDados.ConsultaSQL('SELECT ' + IntToStr(pOrcChave) + ' as orcchave');
    DmDados.ConsultaSQL('SELECT DISTINCT ' + IntToStr(pOrcChave) + ' as orcchave, immnumepedido, tcicodigo from orc,ito,imm WHERE orc.orcchave=' +
      IntToStr(pOrcChave) + ' and ito.orcchave=orc.orcchave and ito.itochave=imm.itochave');

    { frxDados.DataSet:=DmDados.Consulta;

      relatorio.LoadFromFile(vlNomeArq);



      vlTciCodigo:=DmDados.Consulta.FieldByName('immnumepedido').AsString;
      vlNumePedido:=DmDados.Consulta.FieldByName('tcicodigo').AsString;



      relatorio.Variables['tcicodigo'] := QuotedStr(vlTciCodigo);
      relatorio.Variables['immnumepedido'] := QuotedStr(vlNumePedido);


      relatorio.PrepareReport(True);
      relatorio.PrintOptions.ShowDialog := false;
      relatorio.ShowProgress := false;

      relatorio.ShowPreparedReport; }

    mrfrImprimir(DmDados.dConsulta, vlNomeArq, tiImprimirDireto);

  end
  else
    ShowMessage('Aquivo não encontrado' + #13 + vlNomeArq + #13 + 'Não é possível imprimir resumo de ' + DmDados.Usuario.TituloOperador +
      ', verifique !');
end;

procedure TFrmFinalizaMesa.BtnIncSaboresClick(Sender: TObject);
begin
  try
    BtnIncSabores.Enabled := False;

    if not DmDados.ito.IsEmpty then
    begin
      if (DmDados.itoitoquantidade.AsFloat > 1) and (DmDados.itosbrfracionado.AsInteger = 0) then
        InformarQtde
      else
      begin
        IncluirItem;

      end;
    end;

  finally
    SomaItens;
    // DBGridItens.DataSource.DataSet.First;
    // DBGridItens.DataSource.DataSet.last;
    BtnIncSabores.Enabled := true;
  end;

end;

procedure TFrmFinalizaMesa.BtnPedConfirmaClick(Sender: TObject);
begin
  // atualizar valor a receber
  // DmDados.orcdlv
  if (DmDados.dorcdlv.DataSet.FieldByName('stocodigo').AsInteger = 88) then
  begin
    ShowMessage('Este pedido foi cancelado: ' + #13 + DmDados.dorcdlv.DataSet.FieldByName('orcobs').AsString + #13 + #13 + 'Não pode ser recebido!');
    exit;
  end;

  if not DmDados.orcdlv.IsEmpty then
  begin
    vpOrcChaveDelivery := DmDados.orcdlvorcchave.AsString;
    vpRecNo := DmDados.orcdlv.RecNo;
    vpTotalGeral := TBRound(DmDados.orcdlvorctotalav.AsCurrency, 2);
    vpRecebimentos := 0;
    vpTotal := TBRound((vpTotalGeral - vpRecebimentos), 2);
   // vpDesconto := 0;
    vpReceber := TBRound((vpTotalGeral - vpRecebimentos + vpTaxaParcial), 2);
    LimpaRecebimento;
    BtCarregacliente.Visible := False;
    MostraTab(TabRecebimento);
  end
  else
  begin
    // BtCarregacliente.Visible := true;
  end;
end;

procedure TFrmFinalizaMesa.BtnPedConfirmaKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    Key := #0;
    DBGridPedidos.SetFocus;
  end;

end;

procedure TFrmFinalizaMesa.btnqtdeconfirmaClick(Sender: TObject);
begin
  if (Length(EdtQtde.Text) > 0) and (Strtofloat(EdtQtde.Text) > 0) then
  begin
    PnQuantidade.Tag := 1;
    PnQuantidade.Visible := False;
    PCFechamento.Enabled := true;
    IncluirItem;
  end;

  DBGridItens.DataSource.DataSet.First;
  DBGridItens.DataSource.DataSet.last;

end;

procedure TFrmFinalizaMesa.Button10Click(Sender: TObject);
begin
  if not DmDados.olt.IsEmpty then
  begin

    DmDados.oltmes.Close;
    DmDados.oltmes.ParamByName('orcchave').AsString := FPrinciGou.vpOrcChave;
    DmDados.oltmes.Open;

    if DmDados.oltmesmeschave.AsInteger > 0 then
      EmiteComprovante(DmDados.oltmesmeschave.AsInteger)
    else if DmDados.oltltechave.AsInteger > 0 then
      EmiteRecibo(DmDados.oltltechave.AsInteger);
  end
  else
  begin
    EmiteComprovante(DmDados.oltmesmeschave.AsInteger);
  end;
end;

procedure TFrmFinalizaMesa.Button11Click(Sender: TObject);
var
  vlltechave: string;
begin

{  if DmDados.ditoparc.DataSet.RecordCount > 0 then
  begin
    ShowMessage('Recebimentos em itens não podem ser cancelados!');
    exit;
  end;

  if MessageDlg('Ccncelar recebimento selecionado ?', mtConfirmation, [mbYes, mbNo], 0, mbNo) = IdYes then
  begin

    vlltechave := dolt.DataSet.FieldByName('ltechave').AsString;

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'delete from olt where ltechave=' + vlltechave;
    DmDados.Consulta.ExecSQL;

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'delete from lte where ltechave=' + vlltechave;
    DmDados.Consulta.ExecSQL;

    dolt.DataSet.Close;
    dolt.DataSet.Open;

  end;
  self.Close;
}
end;

procedure TFrmFinalizaMesa.Button12Click(Sender: TObject);
begin
  PCFechamento.Enabled := true;
  PnPercentual.Visible := False;

  EdtDinherio.SelectAll;
  EdtDinherio.SetFocus;
end;

procedure TFrmFinalizaMesa.Button13Click(Sender: TObject);
begin
  DmDados.dorcdlv.DataSet.Refresh;
end;

procedure TFrmFinalizaMesa.Button1Click(Sender: TObject);
begin
  // Mostrando resumo de recebimentos
  if DmDados.olt.IsEmpty then
    ShowMessage('Não existe recebimento registrado para essa mesa, verifique !')
  else
    MostraTab(TabResumo);
end;

procedure TFrmFinalizaMesa.Button2Click(Sender: TObject);
var
  vVlrInformado: Currency;
begin
  vpTroco := 0;
  if (Length(EdtVlResto.Text) > 0) and (Strtofloat(EdtVlResto.Text) > 0) then
  begin
    if DmDados.ValidaValor(EdtVlResto, vVlrInformado) then
      if (vVlrInformado > vpDinheiro) then
        vpTroco := vVlrInformado - vpDinheiro;
  end;
  EdtTroco.Text := formatfloat('###0.00', vpTroco);
  EdtVlResto.Text := '0';
  PCFechamento.Enabled := true;
  PnTroco.Visible := False;
  if EdtConvenio.Visible then
  begin
    EdtConvenio.SelectAll;
    EdtConvenio.SetFocus;
  end;
end;

procedure TFrmFinalizaMesa.Button3Click(Sender: TObject);
begin
  Close;
end;

procedure TFrmFinalizaMesa.Button4Click(Sender: TObject);
var
  vPerInformado: Currency;
  vlDesconto: Double;
begin

  if EdtPercentual.Text = '' then
  begin
    ShowMessage('Por favor informar o percentual!');
    exit;
  end;

  if Strtofloat(EdtPercentual.Text) > DmDados.Usuario.PercDesc then
  begin
    ShowMessage('Desconto acima ' + Currtostr(DmDados.Usuario.PercDesc) + '% do permitido para o usuário!');
    exit;
  end;

  vlDesconto := 0;
  if (Length(EdtPercentual.Text) > 0) and (Strtofloat(EdtPercentual.Text) > 0) then
  begin

    vlDesconto := Strtofloat(EdtVlrTotal.Text) * (Strtofloat(EdtPercentual.Text) / 100);
  end;

  EdtDesconto.Text := formatfloat('###0.00', vlDesconto);
  EdtPercentual.Text := '0';
  PCFechamento.Enabled := true;
  PnPercentual.Visible := False;

  if EdtDesconto.Text <> '' then
    ValidaRecDesconto;

  EdtDinherio.SelectAll;
  EdtDinherio.SetFocus;
end;

procedure TFrmFinalizaMesa.BtnRecLimparClick(Sender: TObject);
var
  vlCor: TColor;
begin


    if (EdtCardDebito.Text<>'') and (EdtCardDebito.Text<>'0,00') then
    begin
      ShowMessage('Já possui recebimento de Cartão de Débito!'+#13+'Não pode ser limpo, conclua o fechamento!');
      exit;
    end;

    if (EdtCardCredito.Text<>'') and (EdtCardcredito.Text<>'0,00') then
    begin
      ShowMessage('Já possui recebimento de Cartão de Crédito!'+#13+'Não pode ser limpo, conclua o fechamento!');
      exit;
    end;

    if (EdtPIX.Text<>'') and (EdtPIX.Text<>'0,00') then
    begin
      ShowMessage('Já possui recebimento de PIX!'+#13+'Não pode ser limpo, conclua o fechamento!');
      exit;
    end;



  btDescontoPerc.Visible := False;
  vlCor := EdtNomeCliente.Color;

  EdtDesconto.Enabled := true;
  EdtCardDebito.Enabled := true;
  EdtCardCredito.Enabled := true;
  EdtPIX.Enabled := true;


  LimpaRecebimento;
  plqlimitedisponivel.Caption := '';
  EdtNomeCliente.Color := clWhite;

  // abrindo tabela temporaria de itens
  if not DmDados.trfi.IsEmpty then
  begin
    DmDados.trfi.Close;
    DmDados.trfi.Open;
  end;

  // abrindo tabela temporaria de cheques
  if not DmDados.tche.IsEmpty then
  begin
    DmDados.tche.Close;
    DmDados.tche.Open;
  end;

  // abrindo tabela temporaria de cartões
  if not DmDados.trdc.IsEmpty then
  begin
    DmDados.trdc.Close;
    DmDados.trdc.Open;
  end;

  // abrindo tabela temporaria de cartões
  if not DmDados.trdc.IsEmpty then
  begin
    DmDados.trdc.Close;
    DmDados.trdc.Open;
  end;

  EdtTroco.Text := '0,00';
  vpTroco := 0;
  cbDescontarTaxa.ItemIndex := 0;

 // CalculaTaxaParcial;

  edtDoacao.Text := '';
  edtCredito.Text := '';
  EdtPIX.Text := '';

  EdtFalta.Text := '';
  plvalorinformado.Caption := 'R$ 0,00';

  LbCliente.Caption := '';
  plDisponivel.Caption := '';
  AtualizaLimiteTela('0');

  EdtNomeCliente.Color := vlCor;
  EdtNomeCliente.Color := clWhite;
  if (EdtNomeCliente.Color = clYellow) and (EdtNomeCliente.Text = '') then
  begin
    EdtNomeCliente.SetFocus;
  end
  else
  begin
    EdtDinherio.SetFocus;
  end;

  BtnTabRecConfirma.Enabled := False;

end;

procedure TFrmFinalizaMesa.BtnTabRecConfirmaClick(Sender: TObject);
var
  vlLimiteDisponivel: Double;
begin

  if EdtVlrReceber.Text = EdtVlrPago.Text then
  begin

    if DmDados.dtitem.DataSet.RecordCount = 0 then
    begin
      EdtNomeCliente.Color := clWhite;
    end;

  end;

  if (EdtConvenio.Text <> '') and (EdtConvenio.Text <> '0,00') then
  begin
    if vpEtdCodigo = 0 then
    begin
      LancaConvenio;
    end;
  end;

  if cbDescontarTaxa.Visible then
  begin
    if (cbDescontarTaxa.Text = 'Cobrar') and (Strtofloat(edValorTaxa.Text) <= 0) then
    begin

      edValorTaxa.Text := formatfloat('###0.00', 0);
      edValorTaxa.Enabled := False;
      EdtTroco.Text := formatfloat('###0.00', 0);
      EdtFalta.Text := formatfloat('###0.00', 0);
      CalculaTaxaParcial;
      vpFalta := (vpReceber) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
      EdtFalta.Text := formatfloat('###0.00', vpFalta);

      // ShowMessage('Valor de taxa 0,00 dever ser selecionado Sem Taxa');
      // cbDescontarTaxa.SetFocus;
      exit;
    end;
  end;
  if trim(EdtFalta.Text) = '' then
  begin
    EdtFalta.Text := '0';
  end;

  if Strtofloat(EdtFalta.Text) < 0 then
  begin
    ShowMessage('Favor clicar no botão Limpar e refazer o recebimento!');
    self.vppodefechar := False;
    exit;
  end
  else
  begin
    self.vppodefechar := true;
  end;

  try
    BtnTabRecConfirma.Enabled := False;

    if vpEtdCodigo <> 0 then
    begin
      AtualizaLimiteTela(IntToStr(vpEtdCodigo));
    end;

    if (EdtConvenio.Text <> '') and (plDisponivel.Caption <> '') then
    begin

      vlLimiteDisponivel := Strtofloat(StringReplace(plDisponivel.Caption, '.', '', [rfReplaceAll, rfIgnoreCase]));
      if vlLimiteDisponivel < 0 then
        vlLimiteDisponivel := 0;

      if vlLimiteDisponivel = 0 then
      begin
        ShowMessage('Cliente com limite indispoível para esta valor.' + #13 + #13 +

          'Limite disponível: R$ ' + StringReplace(plDisponivel.Caption, '.', '', [rfReplaceAll, rfIgnoreCase]) + #13 + #13 +
          'Necessita verificar situação junto ao ' + #13 + 'Departamento financeiro!')

      end
      else if Strtofloat(StringReplace(EdtConvenio.Text, '.', '', [rfReplaceAll, rfIgnoreCase])) <= vlLimiteDisponivel then
      begin

        ConfirmaRecebimento;

      end
      else if Strtofloat(StringReplace(EdtConvenio.Text, '.', '', [rfReplaceAll, rfIgnoreCase])) > vlLimiteDisponivel then
      begin
        if DmDados.etstsecodigo.AsInteger <> 0 then
          ShowMessage('Cliente necessita verificar situação junto ao ' + #13 + 'Departamento financeiro!')
        else
          ConfirmaRecebimento;
      end
      else
      begin
        ConfirmaRecebimento;
      end;
    end
    else
      ConfirmaRecebimento;
  finally
  //  BtnTabRecConfirma.Enabled := true;
  end;

  modalresult := mrok;
end;

procedure TFrmFinalizaMesa.ConfirmaRecebimento;
var
  vSQL: string;
  vlValor: String;
  vlPunCodigo: string;
  vlUniCodigo: string;
  vlItoChave: string;

  vlTotalvenda: Currency;
  vlstTotalvenda: String;

  vlTotalServicos: Currency;
  vlstTotalServicos: String;
begin



  DmDados.Consulta.Close;
  DmDados.Consulta.sql.Text:='update orc set oricodigo=6 where orcchave='+vpOrcChave;
  DmDados.Consulta.ExecSQL;

  if vpFalta <= 0.009 then
  begin

     vlTotalvenda := 0;

    DmDados.produtos.Close;
    DmDados.produtos.ParamByName('orcchave').AsString := vpOrcChave;
    DmDados.produtos.Open;

    if not DmDados.produtos.IsEmpty then
    begin
      vlTotalvenda := DmDados.produtos.FieldByName('itmtotal').AsCurrency;

      vlstTotalvenda := Floattostr(vlTotalvenda);
      vlstTotalvenda := StringReplace(vlstTotalvenda, '.', '', []);
    end;

    vlTotalServicos := 0;
    DmDados.servicos.Close;
    DmDados.servicos.ParamByName('orcchave').AsString := vpOrcChave;
    DmDados.servicos.Open;

    if not DmDados.servicos.IsEmpty then
    begin
      vlTotalServicos := DmDados.servicos.FieldByName('itmtotal').AsCurrency;

      vlstTotalServicos := Floattostr(vlTotalServicos);
      vlstTotalServicos := StringReplace(vlstTotalServicos, '.', '', []);
    end;


    if TabItens.Tag = 0 then
    begin
      vSQL := 'SELECT orc.stocodigo, sto.stoidentificacao ' + '  FROM orc ' + ' INNER JOIN sto ON orc.stocodigo = sto.stocodigo ' +
        ' WHERE orc.orcchave = ' + vpOrcChave;
      DmDados.ConsultaSQL(vSQL);
      if not(DmDados.Consulta.Fields[0].AsInteger in [1, 2, 5]) then
      begin
        ShowMessage('Atenção, ' + DmDados.Usuario.TituloOperador + ' atual teve sua situação alterada para ' + DmDados.Consulta.Fields[1].AsString +
          ', verifique ');
        Close;
        exit;
      end;
    end;

    if not DmDados.cfgmcfg.Active then
    begin
      DmDados.cfgmcfg.Open;
    end;

    if DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString <> '' then
    begin

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select puncodigo, unicodigo from pun where procodigo=' + DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString;
      DmDados.Consulta.Open;

      vlPunCodigo := DmDados.Consulta.FieldByName('puncodigo').AsString;
      vlUniCodigo := DmDados.Consulta.FieldByName('unicodigo').AsString;

    end;

    if EdtNomeCliente.Color = clYellow then
    begin

      if ((cbDescontarTaxa.Text = 'Cobrar') or (cbDescontarTaxa.Text = 'Descontar')) and (cbDescontarTaxa.Visible) then
      begin
        if DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString <> '' then
        begin
          vlValor := edValorTaxa.Text;

          if Pos(',', vlValor) > 0 then
            vlValor := StringReplace(vlValor, ',', '.', [rfReplaceAll, rfIgnoreCase]);

          vpTaxaParcial := StrToCurr(StringReplace(vlValor, '.', ',', [rfReplaceAll, rfIgnoreCase]));
          DmDados.Consulta.Close;

          if DmDados.dtitem.DataSet.RecordCount > 0 then
          begin

            vSQL := 'INSERT INTO ito ' + ' values (@chave, ' + vpOrcChave + ', ' + DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString + ', ' +
              vlPunCodigo + ',' + vlUniCodigo + ', 3, 1 ' + ' , 1, ' + vlValor + ', 0,' + vlValor + ', ' + vlValor + ' ' + ' , ' + vlValor + ', 0, ' +
              vlValor + ', ' + vlValor + ', 1 ' + ' , ' + QuotedStr('') + ', ' + QuotedStr('') + ', curdate(), 999, ' + QuotedStr('') + ' , 0, 0,' +
              QuotedStr('') + ', 0, 0 ' + ' , null, ' + QuotedStr('') + ',1,' + QuotedStr('00') + ',0,0,0,0,0,1,0,' +
              DmDados.Usuario.ClbCodigo.ToString + ',0,null,0) ';
          end
          else
          begin
            vSQL := 'INSERT INTO ito ' + ' values (@chave, ' + vpOrcChave + ', ' + DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString + ', ' +
              vlPunCodigo + ',' + vlUniCodigo + ', 2, 1 ' + ' , 1, ' + vlValor + ', 0,' + vlValor + ', ' + vlValor + ' ' + ' , ' + vlValor + ', 0, ' +
              vlValor + ', ' + vlValor + ', 1 ' + ' , ' + QuotedStr('') + ', ' + QuotedStr('') + ', curdate(), 999, ' + QuotedStr('') + ' , 0, 0,' +
              QuotedStr('') + ', 0, 0 ' + ' , null, ' + QuotedStr('') + ',1,' + QuotedStr('00') + ',0,0,0,0,0,1,0,' +
              DmDados.Usuario.ClbCodigo.ToString + ',0,null,0) ';

          end;

          DmDados.ExecutaSQL(vSQL);
          vSQL := '';

        end;
      end
      else
      begin

        if (cbDescontarTaxa.Visible) and (cbDescontarTaxa.Text <> 'Sem Taxa') then
        begin
          if DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString <> '' then
          begin
            vlValor := edValorTaxa.Text;

            if Pos(',', vlValor) > 0 then
              vlValor := StringReplace(vlValor, ',', '.', [rfReplaceAll, rfIgnoreCase]);

            vpTaxaParcial := StrToCurr(StringReplace(vlValor, '.', ',', [rfReplaceAll, rfIgnoreCase]));

            vSQL := 'INSERT INTO ito ' + ' values (@chave, ' + vpOrcChave + ', ' + DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString + ', ' +
              vlPunCodigo + ',' + vlUniCodigo + ', 88, 1 ' + ' , 1, ' + vlValor + ', 0,' + vlValor + ', ' + vlValor + ' ' + ' , ' + vlValor + ', 0, '
              + vlValor + ', ' + vlValor + ', 1 ' + ' , ' + QuotedStr('') + ', ' + QuotedStr('') + ', curdate(), 901, ' + QuotedStr('') + ' , 0, 0,' +
              QuotedStr('') + ', 0, 0 ' + ' , null, ' + QuotedStr('') + ',1,' + QuotedStr('00') + ',0,0,0,0,0,1,0,' +
              DmDados.Usuario.ClbCodigo.ToString + ',0,null,0) ';

            DmDados.ExecutaSQL(vSQL);

          end;
        end;
      end;

    end
    else
    begin

      if ((cbDescontarTaxa.Text = 'Cobrar') or (cbDescontarTaxa.Text = 'Descontar')) and (cbDescontarTaxa.Visible) then
      begin
        if DmDados.cfgmcfgcfgmgouproatendimento.AsString <> '' then
        begin
          vlValor := edValorTaxa.Text;

          if Pos(',', vlValor) > 0 then
            vlValor := StringReplace(vlValor, ',', '.', [rfReplaceAll, rfIgnoreCase]);

          vpTaxaParcial := StrToCurr(StringReplace(vlValor, '.', ',', [rfReplaceAll, rfIgnoreCase]));
          DmDados.Consulta.Close;

          vSQL := 'INSERT INTO ito ' + ' values (@chave, ' + vpOrcChave + ', ' + DmDados.cfgmcfgcfgmgouproatendimento.AsString + ', ' + vlPunCodigo +
            ',' + vlUniCodigo + ', 2, 1 ' + ' , 1, ' + vlValor + ', 0,' + vlValor + ', ' + vlValor + ' ' + ' , ' + vlValor + ', 0, ' + vlValor + ', '
            + vlValor + ', 1 ' + ' , ' + QuotedStr('') + ', ' + QuotedStr('') + ', curdate(), 999, ' + QuotedStr('') + ' , 0, 0,' + QuotedStr('') +
            ', 0, 0 ' + ' , null, ' + QuotedStr('') + ',1,' + QuotedStr('00') + ',0,0,0,0,0,1,0,' + DmDados.Usuario.ClbCodigo.ToString +
            ',0,null,0) ';

          DmDados.ExecutaSQL(vSQL);
          vSQL := '';

        end;
      end
      else
      begin

        if (cbDescontarTaxa.Visible) and (cbDescontarTaxa.Text <> 'Sem Taxa') then
        begin
          if DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString <> '' then
          begin
            vlValor := edValorTaxa.Text;

            if Pos(',', vlValor) > 0 then
              vlValor := StringReplace(vlValor, ',', '.', [rfReplaceAll, rfIgnoreCase]);

            vpTaxaParcial := StrToCurr(StringReplace(vlValor, '.', ',', [rfReplaceAll, rfIgnoreCase]));

            vSQL := 'INSERT INTO ito ' + ' values (@chave, ' + vpOrcChave + ', ' + DmDados.cfgmcfgcfgmgouproatendimento.AsString + ', ' + vlPunCodigo
              + ',' + vlUniCodigo + ', 88, 1 ' + ' , 1, ' + vlValor + ', 0,' + vlValor + ', ' + vlValor + ' ' + ' , ' + vlValor + ', 0, ' + vlValor +
              ', ' + vlValor + ', 1 ' + ' , ' + QuotedStr('') + ', ' + QuotedStr('') + ', curdate(), 901, ' + QuotedStr('') + ' , 0, 0,' +
              QuotedStr('') + ', 0, 0 ' + ' , null, ' + QuotedStr('') + ',1,' + QuotedStr('00') + ',0,0,0,0,0,1,0,' +
              DmDados.Usuario.ClbCodigo.ToString + ',0,null,0) ';

            DmDados.ExecutaSQL(vSQL);

          end;
        end;
      end;

    end;

    EncerraMesa;
    ConssolidaRecebimentos;

  end;
end;







procedure TFrmFinalizaMesa.ConssolidaRecebimentos;
var
  vSQL: string;
  vletdcodigo: string;
  vlrcrchave: string;
  vlrfichave: string;
  vlmeschave: string;
  vlrfivalor: string;

  vlTotalServicos: Currency;
  vlstTotalServicos: String;

  vlTotalvenda: Currency;
  vlstTotalvenda: String;


  vlTotalOutras:Currency;
  vlTotalDescontos:Currency;
  vlTotalAcrescimos:Currency;

  vlDiferencaOutras:Currency;
  vlDiferencaAcrescimos:Currency;
  vlDiferencaDescontos:Currency;

  vlTxtDiferencaOutras:String;
  vlTxtDiferencaAcrescimos:String;
  vlTxtDiferencaDescontos:String;


  vlMesOutras:Currency;
  vlMesDescontos:Currency;
  vlMesAcrescimos:Currency;

  vlDesconto:Currency;
  vlTxtDesconto:String;

  vlTotal:Currency;
  vlTxtTotal:String;

  vlMesRefeicao:String;

begin

  if vpOrcChave <> '' then
  begin

    DmDados.itorecalculoadicional.Close;
    DmDados.itorecalculoadicional.ParamByName('orcchave').AsString := vpOrcChave;
    DmDados.itorecalculoadicional.Open;

    while not DmDados.itorecalculoadicional.Eof do
    begin
      DmDados.recalculaadional.Close;
      DmDados.recalculaadional.ParamByName('itochave').AsInteger := DmDados.itorecalculoadicionalitochave.AsInteger;
      DmDados.recalculaadional.Open;

      if DmDados.recalculaadionalpunprecoav.AsFloat > 0 then
      begin

        DmDados.ajustaadicional.Close;
        DmDados.ajustaadicional.ParamByName('vlradicional').AsFloat := DmDados.recalculaadionalpunprecoav.AsFloat;
        DmDados.ajustaadicional.ParamByName('itochave').AsInteger := DmDados.itorecalculoadicionalitochave.AsInteger;
        DmDados.ajustaadicional.ExecSQL;
      end;

      //  1207
      vSQL := 'update itm i set i.itmacrescimoav=(select itoacrescimoav from ito where ito.itochave='+DmDados.itorecalculoadicionalitochave.AsString+') where i.itochave='+DmDados.itorecalculoadicionalitochave.AsString;
      DmDados.ExecutaSQL(vSQL);

      DmDados.itorecalculoadicional.Next;
    end;

    while not DmDados.itorec.Eof do
    begin
      DmDados.recalculaadional.Close;
      DmDados.recalculaadional.ParamByName('itochave').AsInteger := DmDados.itorecitochave.AsInteger;
      DmDados.recalculaadional.Open;

      if DmDados.recalculaadionalpunprecoav.AsFloat > 0 then
      begin

        DmDados.ajustaadicional.Close;
        DmDados.ajustaadicional.ParamByName('vlradicional').AsFloat := DmDados.recalculaadionalpunprecoav.AsFloat;
        DmDados.ajustaadicional.ParamByName('itochave').AsInteger := DmDados.itorecitochave.AsInteger;
        DmDados.ajustaadicional.ExecSQL;
        DmDados.itorecalculoadicional.Next;
      end;

      DmDados.itorec.Next;
    end;

  end;

  vSQL := 'delete from ito where itoquantidade=0 and orcchave=' + vpOrcChave;
  DmDados.ExecutaSQL(vSQL);



  vSQL := 'update mes,mor set  mesvalor=' +
    '(select sum(itovalorav*itoquantidade)-(itoacrescimoav) from ito,pro where ito.procodigo=pro.procodigo and pro.tpocodigo=0 and  ito.orcchave=mor.orcchave and ito.stocodigo<>88), '
    +
    ' mestotal=(select sum(itovalorav*itoquantidade)-itodescontoav from ito,pro where ito.procodigo=pro.procodigo and pro.tpocodigo=0 and  ito.orcchave=mor.orcchave and ito.stocodigo<>88)+'
    + '(select sum(itmoutras) from itm where itm.meschave=mor.meschave and mor.orcchave='+vpOrcChave+'  ) ' +
    'where mes.mesrefeicao=0 and mes.meschave=mor.meschave and  orcchave=' + vpOrcChave;
  DmDados.ExecutaSQL(vSQL);




  vletdcodigo := '';
  vlrcrchave := '';
  vlmeschave := '';

  if (plDisponivel.Visible) and (plDisponivel.Color = clgreen) then
  begin

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'select etdcodigo from orc where etdcodigo<>0 and orcchave=' + vpOrcChave;
    DmDados.Consulta.Open;

    if not DmDados.Consulta.IsEmpty then
    begin

      vletdcodigo := DmDados.Consulta.FieldByName('etdcodigo').AsString;

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select rcrchave from rcr where etdcodigo=' + vletdcodigo;
      DmDados.Consulta.Open;

      if not DmDados.Consulta.IsEmpty then
      begin
        vlrcrchave := DmDados.Consulta.FieldByName('rcrchave').AsString;
      end;

    end;

    if vlrcrchave <> '' then
    begin

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select meschave from mor where orcchave=' + vpOrcChave+' order by morchave desc limit 1' ;
      DmDados.Consulta.Open;

      if not DmDados.Consulta.IsEmpty then
      begin

        vlmeschave := DmDados.Consulta.FieldByName('meschave').AsString;
      end;

      DmDados.mce.Close;
      DmDados.mce.ParamByName('rcrchave').AsString := vlrcrchave;
      DmDados.mce.Open;

      DmDados.mce.Append;
      DmDados.mcercrchave.AsString := vlrcrchave;
      DmDados.mcetmccodigo.AsInteger := 6;
      DmDados.mceclbcodigo.AsInteger := DmDados.Usuario.ClbCodigo;
      DmDados.mcemcemotivo.AsString := 'Venda: ' + vlmeschave;
      DmDados.mcemecregistro.Asdatetime := now();
      DmDados.mceltechave.AsInteger := vpLtechave;
      DmDados.mce.Post;

      DmDados.mcr.Close;
      DmDados.mcr.ParamByName('rcrchave').AsString := vlrcrchave;
      DmDados.mcr.Open;

      DmDados.mcr.Append;
      DmDados.mcrrcrchave.AsString := vlrcrchave;
      DmDados.mcrmcrvalor.AsCurrency := vpcredito;
      DmDados.mcrmcechave.AsInteger := DmDados.mcemcechave.AsInteger;
      DmDados.mcr.Post;

    end;

  end;

  if EdtNomeCliente.Color = clYellow then
  begin

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'select meschave, orcchave  from mor where meschave=' + vpMeschaveparcial+ ' order by morchave desc limit 1';
    DmDados.Consulta.Open;

    vpOrcChave:=DmDados.Consulta.FieldByName('orcchave').AsString;
  end
  else
  begin
    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'select meschave from mor where orcchave=' + vpOrcChave+' order by morchave desc limit 1';
    DmDados.Consulta.Open;
  end;


  vlMesOutras:= 0;
  vlMesDescontos:= 0;


  if vpOrcChave='' then
    vpOrcChave:=dmdados.orcorcchave.AsString;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := 'select mes.meschave, mesoutras, mesdesconto from mor,mes where mes.meschave=mor.meschave  and mor.orcchave=' + vpOrcChave+' order by morchave desc limit 1';
  DmDados.Consulta.Open;

  vlMesOutras:= DmDados.Consulta.FieldByName('mesoutras').AsCurrency;
  vlMesDescontos:= DmDados.Consulta.FieldByName('mesdesconto').AsCurrency;

  vlmeschave := DmDados.Consulta.FieldByName('meschave').AsString;


  vlMesAcrescimos:= 0;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := 'select sum(itoacrescimoav) itoacrescimoav from ito where orcchave=' + vpOrcChave;
  DmDados.Consulta.Open;

  vlMesAcrescimos:= DmDados.Consulta.FieldByName('itoacrescimoav').AsCurrency;

  vlTotalAcrescimos:= 0;
  vlTotalOutras:= 0;
  vlTotalDescontos:=0;


  vlDiferencaOutras:= 0;
  vlDiferencaAcrescimos:= 0;
  vlDiferencaDescontos:= 0;



  if not DmDados.Consulta.IsEmpty then
  begin

    vpOrcChave:=dmdados.orcorcchave.AsString;

    if (vlmeschave='') or (vlmeschave='0') then
    begin

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select meschave from mor where orcchave=' + vpOrcChave+' order by morchave desc limit 1';
      DmDados.Consulta.Open;

      vlmeschave:= DmDados.Consulta.fieldbyname('meschave').AsString;

    end;

    if  vlmeschave<>'' then
    begin

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select sum(itmoutras) itmoutras, sum(itmdesconto) itmdesconto from itm where meschave=' + vlmeschave;
      DmDados.Consulta.Open;

      vlTotalOutras:=DmDados.Consulta.FieldByName('itmoutras').AsCurrency;
      vlTotalDescontos:=DmDados.Consulta.FieldByName('itmdesconto').AsCurrency;


      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select sum(itmacrescimoav) itmacrescimoav from itm where meschave=' + vlmeschave;
      DmDados.Consulta.Open;


      vlTotalAcrescimos:=DmDados.Consulta.FieldByName('itmacrescimoav').AsCurrency;


      vlDiferencaOutras:= vlMesOutras-vlTotalOutras;

      vlTxtDiferencaOutras:=stringreplace(floattostr(vlDiferencaOutras),',','.',[]);

      if (vlTxtDiferencaOutras<>'') and (vlTxtDiferencaOutras<>'0')  and (vlTxtDiferencaOutras<>'0.00') then
      begin
        vSQL := 'update itm set itmoutras=itmoutras+'+vlTxtDiferencaOutras+' where meschave='+vlmeschave+' limit 1';

        DmDados.ExecutaSQL(vSQL);

      end;


      dmdados.Descontomes.close;
      dmdados.Descontomes.sql.text:='SELECT distinct lte.ltechave, ltedesconto '+
      'FROM mes '+
      'INNER JOIN rfm ON mes.meschave = rfm.meschave '+
      'INNER JOIN rfi ON rfm.rfichave = rfi.rfichave '+
      'INNER JOIN mfi ON rfm.rfichave = mfi.rfichave '+
      'INNER JOIN mlt ON mfi.mfichave =mlt.mfichave '+
      'INNER JOIN lte ON mlt.ltechave = lte.ltechave '+
      'WHERE mes.meschave=' +vlmeschave;
      dmdados.Descontomes.open;

      vlDesconto:=dmdados.Descontomes.fieldbyname('ltedesconto').ascurrency;

      if vlDesconto>0 then
      begin

        vlTxtDesconto:=Floattostr(vlDesconto);
        vlTxtDesconto:=Stringreplace(vlTxtDesconto,',','.',[]);

        dmdados.Descontomes.close;
        dmdados.Descontomes.sql.text:='SELECT  ( SUM((itmvalor+itmoutras+itmacrescimoav)*itmquantidade))      AS total FROM itm WHERE meschave=' +vlmeschave;
        dmdados.Descontomes.open;

        vlTotal:=dmdados.Descontomes.fieldbyname('total').ascurrency;
        vlTxtTotal:=floattostr(vlTotal);
        vlTxtTotal:=Stringreplace(vlTxtTotal,',','.',[]);



         vSQL := 'UPDATE itm,mes set itmdesconto='+vlTxtDesconto+'*(((itmvalor+itmoutras+itmacrescimoav)*itmquantidade )/'+vlTxtTotal+
         ') WHERE itm.meschave=mes.meschave and mes.mesrefeicao=0 and itm.meschave='+vlmeschave;

          DmDados.ExecutaSQL(vSQL);

         if (vlTxtDesconto<>'') and (vlTxtDesconto<>'0')  and (vlTxtDesconto<>'0.00') then
         begin

           vSQL := 'UPDATE  mes,itm SET mesdesconto='+vlTxtDesconto+', mestotal=(SELECT SUM((itmtotal-itmdesconto+itmoutras)) total '+
                   'FROM itm WHERE itm.meschave='+vlmeschave+') '+
                   'WHERE mes.mesrefeicao=0 and mes.meschave=itm.meschave and mes.meschave='+vlmeschave;

           DmDados.ExecutaSQL(vSQL);
           vlMesDescontos:=vlDesconto;
         end;
      end;

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select mesrefeicao from mes where meschave=' + vlmeschave;
      DmDados.Consulta.Open;

      vlMesRefeicao:=DmDados.Consulta.FieldByName('mesrefeicao').AsString;


      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select sum(itmoutras) itmoutras, sum(itmdesconto) itmdesconto from itm where meschave=' + vlmeschave;
      DmDados.Consulta.Open;

      vlTotalDescontos:= DmDados.Consulta.FieldByName('itmdesconto').AsCurrency;

      vlDiferencaDescontos:= vlMesDescontos-vlTotalDescontos;

      vlTxtDiferencaDescontos:=stringreplace(floattostr(vlDiferencaDescontos),',','.',[]);

      if (vlTxtDiferencaDescontos<>'') and (vlTxtDiferencaDescontos<>'0')  and (vlTxtDiferencaDescontos<>'0.00') then
      begin
        if vlMesRefeicao='0' then
        begin
          vSQL := 'update itm set itmdesconto=itmdesconto+'+vlTxtDiferencaDescontos+' where meschave='+vlmeschave+' limit 1';
          DmDados.ExecutaSQL(vSQL);

        end;
      end;

      vSQL := 'UPDATE  mes,itm SET mesvalor=(SELECT SUM((itmtotal))-sum(itmacrescimoav)  total '+
               'FROM itm WHERE itm.meschave='+vlmeschave+') '+
               'WHERE mes.mesrefeicao=0 and mes.meschave=itm.meschave and mes.meschave='+vlmeschave;
      DmDados.ExecutaSQL(vSQL);


      vSQL := 'UPDATE  mes,itm SET mestotal=(SELECT SUM((itmtotal))+sum(itmacrescimoav)+sum(itmoutras)-sum(itmdesconto)  total '+
               'FROM itm WHERE itm.meschave='+vlmeschave+') '+
               'WHERE mes.mesrefeicao=0 and mes.meschave=itm.meschave and mes.meschave='+vlmeschave;
      DmDados.ExecutaSQL(vSQL);


      if vlMesRefeicao='1' then
      begin

        DmDados.Consulta.Close;
        DmDados.Consulta.SQL.Text := 'select mes.meschave, mesoutras, mesdesconto from mes where mes.meschave=' + inttostr(strtoint(vlmeschave)-1);
        DmDados.Consulta.Open;

        vlMesOutras:= DmDados.Consulta.FieldByName('mesoutras').AsCurrency;

        DmDados.Consulta.Close;
        DmDados.Consulta.SQL.Text := 'select sum(itmoutras) itmoutras, sum(itmdesconto) itmdesconto from itm where meschave=' + inttostr(strtoint(vlmeschave)-1);
        DmDados.Consulta.Open;

        vlTotalOutras:= DmDados.Consulta.FieldByName('itmoutras').AsCurrency;

        vlTotalDescontos:= DmDados.Consulta.FieldByName('itmdesconto').AsCurrency;

        vlDiferencaDescontos:= vlMesDescontos-vlTotalDescontos;

        vlTxtDiferencaDescontos:=stringreplace(floattostr(vlDiferencaDescontos),',','.',[]);

         if (vlTxtDiferencaDescontos<>'') and (vlTxtDiferencaDescontos<>'0')  and (vlTxtDiferencaDescontos<>'0.00') then
         begin
           if vlMesRefeicao='1' then
           begin
             vSQL := 'update itm set itmdesconto=itmdesconto+'+vlTxtDiferencaDescontos+' where meschave='+ inttostr(strtoint(vlmeschave)-1)+' limit 1';
             DmDados.ExecutaSQL(vSQL);

           end;
         end;

         vlDiferencaOutras:= vlMesOutras-vlTotalOutras;

         vlTxtDiferencaOutras:=stringreplace(floattostr(vlDiferencaOutras),',','.',[]);

         if (vlTxtDiferencaOutras<>'') and (vlTxtDiferencaOutras<>'0')  and (vlTxtDiferencaOutras<>'0.00') then
         begin
           if vlMesRefeicao='1' then
           begin
             vSQL := 'update itm set itmoutras=itmoutras+'+vlTxtDiferencaOutras+' where meschave='+ inttostr(strtoint(vlmeschave)-1)+' limit 1';
             DmDados.ExecutaSQL(vSQL);

           end;
         end;

         if (vlTxtDesconto<>'') and (vlTxtDesconto<>'0')  and (vlTxtDesconto<>'0.00') then
         begin
            vSQL := 'UPDATE  mes SET  mesdesconto= '+ vlTxtDesconto + ' WHERE  mes.meschave='+inttostr(strtoint(vlmeschave)-1);
            DmDados.ExecutaSQL(vSQL);
         end;


        vSQL := 'UPDATE  mes,itm SET  mesvalor=(SELECT SUM((itmtotal))  total '+
                 'FROM itm WHERE itm.meschave='+inttostr(strtoint(vlmeschave)-1)+') '+
                 'WHERE mes.mesrefeicao=0 and mes.meschave=itm.meschave and mes.meschave='+inttostr(strtoint(vlmeschave)-1);
        DmDados.ExecutaSQL(vSQL);


        vSQL := 'UPDATE  mes,itm SET mestotal=(SELECT SUM(itmtotal)-SUM(itmdesconto)+sum(itmoutras)  total '+
                 'FROM itm WHERE itm.meschave='+inttostr(strtoint(vlmeschave)-1)+') '+
                 'WHERE mes.meschave=itm.meschave and mes.meschave='+inttostr(strtoint(vlmeschave)-1);
        DmDados.ExecutaSQL(vSQL);

      end;

      // ajuste de histórico dos registros;

      if (vpLtechave<>0) and (vlmeschave<>'') then
      begin
       AjustaHistoricos(vlmeschave,vpLtechave.ToString);
       AjustaRFMConvenio(vlmeschave);
      end;

      // calculo de saldo de estoque
      {
      dmdados.itmsaldo.close;
      dmdados.itmsaldo.sql.text:='select itm.procodigo from itm,pro where '+
                                 'itm.procodigo=pro.procodigo and pro.proestoque=1 and '+
                                 'meschave='+ vlmeschave;
      dmdados.itmsaldo.open;

      while not dmdados.itmsaldo.eof do
      begin

        dmdados.Consulta.close;
        dmdados.Consulta.sql.Text:='UPDATE pro  SET pro.prosaldo = '+
                                   'calcSaldoProduto(pro.procodigo) '+
                                   'WHERE pro.proestoque=1 and pro.procodigo = '+
                                   dmdados.itmsaldo.fieldbyname('procodigo').asstring;;
        dmdados.Consulta.ExecSQL;

        dmdados.Consulta.close;
        dmdados.Consulta.sql.Text:='UPDATE pro  SET pro.prosaldodisp = '+
                                   'calcSaldoProdutoDisp(pro.procodigo) '+
                                   'WHERE pro.proestoque=1 and pro.procodigo = '+
                                   dmdados.itmsaldo.fieldbyname('procodigo').asstring;;
        dmdados.Consulta.ExecSQL;

        dmdados.itmsaldo.Next;
      end;
      }



      GeraComprovantesTEF(vlmeschave); // VIA COMERCIANTE
      GeraComprovantesTEF(vlmeschave); // VIA CLIENTE

    end
    else
    begin
      if vpLtechave<>0 then
      begin



        dmdados.dtltefparcial.close;
        dmdados.dtltefparcial.Connection:=dmdados.Conexao;
        dmdados.dtltefparcial.ParamByName('ltechave').AsInteger:=vpLtechave;
        dmdados.dtltefparcial.Open;


        if not dmdados.dtltefparcial.IsEmpty then
        begin

          dmdados.dtltefparcial.First;
          while not dmdados.dtltefparcial.Eof do
          begin
            if (dmdados.dtltefparcialmdacodigo.AsInteger=mdaCartaoDebito) or
               (dmdados.dtltefparcialmdacodigo.AsInteger=mdaCartaoCredito) or
               (dmdados.dtltefparcialmdacodigo.AsInteger=mdaPIX)   then
            begin

              dmdados.rdctef.close;
              dmdados.rdctef.Connection:=dmdados.Conexao;
              dmdados.rdctef.ParamByName('dtlchave').AsString:=dmdados.dtltefparcial.FieldByName('dtlchave').AsString;
              dmdados.rdctef.Open;


              if not dmdados.rdctef.IsEmpty then
              begin

                if not dmdados.trm.Active then
                begin
                  dmdados.trm.ParamByName('trmcodigo').AsInteger:=dmdados.Usuario.TrmCodigo;
                  dmdados.trm.Open;
                end;


                dmdados.trm.Edit;
                dmdados.trmtrmterminalcomprovante1via.AsString:=dmdados.rdctef.FieldByName('rdccomprovante1via').AsString;
                dmdados.trm.Post;

               dmdados.ImprimirViaTEF;
              end;

            end;

            dmdados.dtltefparcial.Next;
          end;

          // ajuste de histórico dos registros;

          if (vpLtechave<>0) and (vlmeschave<>'') then
          begin
           AjustaHistoricos(vlmeschave,vpLtechave.ToString);
           AjustaRFMConvenio(vlmeschave);

          end;

        end;

      end;


    end;



  end;

end;

Procedure  TFrmFinalizaMesa.AjustaRFMConvenio(aMesChave:string);
var
  vlOrcChave:string;
  vlRfiChave:string;
begin
  vlOrcChave:='';
  dmdados.consulta.close;
  dmdados.consulta.SQL.Text:='SELECT orcchave FROM mor WHERE meschave='+aMesChave;
  dmdados.consulta.Open;

  vlOrcChave:=dmdados.consulta.FieldByName('orcchave').AsString+' - 1/1';




  dmdados.consulta.close;
  dmdados.consulta.SQL.Text:='SELECT  rfi.rfichave,rfinumero,rfihistorico FROM  rfi where '+
                              'rfinumero='+QuotedStr(vlOrcChave)+ ' and '+
                              ' tfdcodigo=2  and '+
                              'rfihistorico='+QuotedStr(vlOrcChave);
  dmdados.consulta.open;


  if not dmdados.consulta.IsEmpty then
  begin
    vlRfiChave :=dmdados.consulta.FieldByName('rfichave').AsString;


    dmdados.consulta.Edit;
    dmdados.consulta.FieldByName('rfinumero').AsString:=aMesChave+' - 1/1';
    dmdados.consulta.FieldByName('rfihistorico').AsString:=aMesChave+' - 1/1';
    dmdados.consulta.Post;


    dmdados.rfmrfi.close;
    dmdados.rfmrfi.parambyname('meschave').asstring:=aMesChave;
    dmdados.rfmrfi.parambyname('rfichave').asstring:= vlRfiChave;
    dmdados.rfmrfi.open;

    if dmdados.rfmrfi.isempty then
    begin
      dmdados.rfmrfi.append;
      dmdados.rfmrfi.fieldbyname('meschave').asstring:= aMesChave;
      dmdados.rfmrfi.fieldbyname('rfichave').asstring:= vlRfiChave;
      dmdados.rfmrfi.fieldbyname('flacodigo').asstring:='1';
      dmdados.rfmrfi.post;
    end;

  end;
end;

Procedure  TFrmFinalizaMesa.AjustaHistoricos(aMesChave:string; aLteChave:string);
begin

  if aMesChave<>'' then
  begin

    dmdados.dtlclt.Close;
    dmdados.dtlclt.sql.Text:=' SELECT dtl.ltechave,dtl.rdcnrauto,dtl.mdacodigo ';
    dmdados.dtlclt.sql.Add('FROM rfm ');
    dmdados.dtlclt.sql.Add('INNER JOIN rfi ON rfm.rfichave = rfi.rfichave ');
    dmdados.dtlclt.sql.Add('INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
    dmdados.dtlclt.sql.Add('INNER JOIN mlt ON mfi.mfichave = mlt.mfichave ');
    dmdados.dtlclt.sql.Add('INNER JOIN lte ON mlt.ltechave = lte.ltechave ');
    dmdados.dtlclt.sql.Add('INNER JOIN dtl ON lte.ltechave = dtl.ltechave ');
    dmdados.dtlclt.sql.Add('INNER JOIN mda ON dtl.mdacodigo = mda.mdacodigo ');
    dmdados.dtlclt.sql.Add('WHERE rfm.meschave=:meschave ');
    dmdados.dtlclt.sql.Add('  and lte.flacodigo=:flacodigo ');
    dmdados.dtlclt.sql.Add('  AND lte.tfdcodigo=32 ');
    dmdados.dtlclt.sql.Add('  AND tmfcodigo=21 ');
    dmdados.dtlclt.sql.Add('GROUP BY  dtl.dtlchave ');
    dmdados.dtlclt.sql.Add('ORDER BY dtl.dtlchave ');
    dmdados.dtlclt.ParamByName('flacodigo').AsString:='1';
    dmdados.dtlclt.ParamByName('meschave').AsString:=aMesChave;

    dmdados.dtlclt.Open;

    while not dmdados.dtlclt.eof do
    begin
      if (dmdados.dtlclt.FieldByName('mdacodigo').AsInteger=4) or
         (dmdados.dtlclt.FieldByName('mdacodigo').AsInteger=6) or
         (dmdados.dtlclt.FieldByName('mdacodigo').AsInteger=19) then
      begin
        dmdados.consulta.Close;
        dmdados.consulta.sql.Text:=
                                   'UPDATE cco, clt, dtl, mda SET cco.ccohistorico=CONCAT('+QuotedStr('Venda ')+
                                   ',mda.mdaidentificacao, '+QuotedStr(' Nr: ')+
                                   ', :meschave,'+QuotedStr(' Aut.Nr.: ')+','+
                                   QuotedStr(dmdados.dtlclt.FieldByName('rdcnrauto').AsString) +') '+
                                   ' WHERE clt.dtlchave = dtl.dtlchave '+
                                   'AND dtl.mdacodigo = mda.mdacodigo '+
                                   'AND clt.ccochave = cco.ccochave '+
                                   'AND clt.ltechave = :ltechave';

        dmdados.consulta.ParamByName('meschave').AsString:=aMesChave;
        dmdados.consulta.ParamByName('ltechave').AsString:=dmdados.dtlclt.FieldByName('ltechave').AsString;
        dmdados.consulta.ExecSQL;
      end
      else
      begin
        dmdados.consulta.Close;
        dmdados.consulta.sql.Text:=
                                   'UPDATE cco, clt, dtl, mda SET cco.ccohistorico=CONCAT('+QuotedStr('Venda ')+
                                   ',mda.mdaidentificacao, '+QuotedStr(' Nr: ')+
                                   ', :meschave'+') '+
                                   ' WHERE clt.dtlchave = dtl.dtlchave '+
                                   'AND dtl.mdacodigo = mda.mdacodigo '+
                                   'AND clt.ccochave = cco.ccochave '+
                                   'AND clt.ltechave = :ltechave';

        dmdados.consulta.ParamByName('meschave').AsString:=aMesChave;
        dmdados.consulta.ParamByName('ltechave').AsString:=dmdados.dtlclt.FieldByName('ltechave').AsString;
        dmdados.consulta.ExecSQL;


      end;
      dmdados.dtlclt.Next;
    end;
  end;
end;




procedure TFrmFinalizaMesa.Button5Click(Sender: TObject);
begin
  if (Strtofloat(EdtQtde.Text) >= 1) and (Strtofloat(EdtQtde.Text) < DmDados.itoitoquantidade.AsFloat) then
    EdtQtde.Text := Floattostr(Strtofloat(EdtQtde.Text) + 1);
end;

procedure TFrmFinalizaMesa.Button6Click(Sender: TObject);
begin
  if (Strtofloat(EdtQtde.Text) > 1) and (Strtofloat(EdtQtde.Text) <= DmDados.itoitoquantidade.AsFloat) then
    EdtQtde.Text := Floattostr((Strtofloat(EdtQtde.Text) - 1));
end;

procedure TFrmFinalizaMesa.BtCarregaclienteClick(Sender: TObject);
begin
  BuscaCliente;
end;

procedure TFrmFinalizaMesa.BuscaCliente;
var
  vetdcodigo: String;
begin
  LbCliente.Caption := '';
  plDisponivel.Caption := '';
  vetdcodigo := mostralista('mcli', IntToStr(DmDados.Usuario.ClbCodigo), 'tse.tsecodigo=0');

  if vetdcodigo <> '' then
  begin
    vpEtdCodigo := vetdcodigo.ToInteger;
    AtualizaLimiteTela(vetdcodigo);
  end;
end;

procedure TFrmFinalizaMesa.BtnRecVoltarClick(Sender: TObject);
begin


    if (EdtCardDebito.Text<>'') and (EdtCardDebito.Text<>'0,00') then
    begin
      ShowMessage('Já possui recebimento de Cartão de Débito!'+#13+'Não pode ser limpo, conclua o fechamento!');
      exit;
    end;

    if (EdtCardCredito.Text<>'') and (EdtCardcredito.Text<>'0,00') then
    begin
      ShowMessage('Já possui recebimento de Cartão de Crédito!'+#13+'Não pode ser limpo, conclua o fechamento!');
      exit;
    end;

    if (EdtPIX.Text<>'') and (EdtPIX.Text<>'0,00') then
    begin
      ShowMessage('Já possui recebimento de PIX!'+#13+'Não pode ser limpo, conclua o fechamento!');
      exit;
    end;

  

  BtnRecLimpar.onClick(Sender);

  LimpaRecebimento;

  vpReceber := 0;
  if TabItens.Tag = 0 then
  begin
    SomaItens;
    MostraTab(TabItens);
  end
  else
    MostraTab(TabPedidos);

end;

procedure TFrmFinalizaMesa.Button9Click(Sender: TObject);
begin
  MostraTab(TabItens);
end;

procedure TFrmFinalizaMesa.CalculaRecebimentos;
var
  vlorcOrigem: string;
  vlrecitens: Double;
begin
  vpDescRec := 0;
  vpRecebimentos := 0;
  vlrecitens := 0;
  if TabItens.Tag = 0 then
  begin

    DmDados.tropar.Close;
    DmDados.tropar.SQL.Text := ' SELECT tro.trochave , tro.orcchaveorigem  , tro.orcchavedestino ';
    DmDados.tropar.SQL.add('FROM tro where tro.orcchavedestino=' + vpOrcChave);
    DmDados.tropar.Open;

    vlorcOrigem := DmDados.tropar.FieldByName('orcchaveorigem').AsString;

    // buscando dados de pagamentos
    DmDados.olt.Close;
    DmDados.olt.Params[0].AsString := vpOrcChave;
    DmDados.olt.Open;

    // calculando valores recebidos
    if not DmDados.olt.IsEmpty then
    begin
      DmDados.olt.First;
      while not DmDados.olt.Eof do
      begin
       // if DmDados.olttipobaixa.AsInteger = 0 then
       // begin
          vpRecebimentos := vpRecebimentos + DmDados.oltltetotal.AsCurrency;
          vpDescRec := vpDescRec + DmDados.oltltedesconto.AsCurrency;
       // end;
        DmDados.olt.Next;
      end;
    end;

    if DmDados.Ditorec.DataSet.Active then
    begin
      DmDados.Ditorec.DataSet.First;
      while not DmDados.Ditorec.DataSet.Eof do
      begin
        vlrecitens := vlrecitens + DmDados.Ditorec.DataSet.FieldByName('itototalav').AsCurrency;

        DmDados.Ditorec.DataSet.Next;
      end;

    end;
    LbRecebido.Caption := 'Recebido R$ ' + formatfloat('###0.00', vlrecitens);
    LbjaRecebido.Caption := 'Já Recebido: ' + formatfloat('###0.00', vpRecebimentos + vlrecitens);
  end;
end;

procedure TFrmFinalizaMesa.DataSourceItoDataChange(Sender: TObject; Field: TField);
begin
  { if (DmDados.itoorcchave.AsString <> '') and (DmDados.itoitochave.AsString <> '') then
    begin

    if (not DmDados.ito.Executing) and (not DmDados.ito.Fetching) then
    begin
    ApresentaItem(DmDados.orcorcchave.AsInteger, DmDados.itoitochave.AsInteger);
    end;


    end; }
end;

procedure TFrmFinalizaMesa.DBGrid1KeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  If (((Shift = [ssCtrl]) And (Key = 46))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) Then
    Abort;
end;

procedure TFrmFinalizaMesa.DBGrid2KeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  If (((Shift = [ssCtrl]) And (Key = 46))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) Then
    Abort;

end;

procedure TFrmFinalizaMesa.DBGrid3DrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
var
  fixRect: TRect;
  tmpck: Integer;
  R: TRect;
  I: Integer;
begin

  // If DBGLista.Focused Then
  // begin

  fixRect := Rect;

  if DmDados.itodlvclbconferencia.AsInteger <> 0 then
  begin
    DBGrid3.Canvas.Font.Color := clgreen;
  end
  else
  begin
    DBGrid3.Canvas.Font.Color := clblack;
  end;

  { cast DBGrid to a unit friendly class thus exposing all it private bits! }
  with TFriendly(DBGrid3) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. tmpck against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }
        Brush.Color := clsilver; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(Rect, DataCol, Column, State);
      end;
    end;
  end;

  // end;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      Brush.Color := clsilver; // $004080FF;
      FillRect(fixRect);
      Font.Color := clWhite;
    End;

  with TFriendly(DBGrid3) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. tmpck against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }
        Brush.Color := clsilver; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(fixRect, DataCol, Column, State);
      end;
    end;
  end;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);

end;

procedure TFrmFinalizaMesa.DBGrid4KeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  If (((Shift = [ssCtrl]) And (Key = 46))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) Then
    Abort;

end;

procedure TFrmFinalizaMesa.DBGridPedidosCellClick(Column: TColumn);
begin
  { if Column.FieldName = 'sel' then
    begin
    if not DmDados.orcdlv.IsEmpty then
    begin
    DmDados.orcdlv.Edit;
    if DmDados.orcdlvsel.AsString = '0' then
    DmDados.orcdlvsel.AsString := '1'
    else
    DmDados.orcdlvsel.AsString := '0';
    DmDados.orcdlv.Post;
    end;
    end; }
end;

procedure TFrmFinalizaMesa.DBGridPedidosDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
var
  fixRect: TRect;
begin
  fixRect := Rect;

  If Odd(dolt.DataSet.RecNo) Then
    DBGridPedidos.Canvas.Brush.Color := clsilver
  Else
    DBGridPedidos.Canvas.Brush.Color := clWhite;

  if (DmDados.dorcdlv.DataSet.FieldByName('stocodigo').AsInteger = 88) then
    With (Sender As TDBGrid).Canvas Do
    Begin
      FillRect(fixRect);
      Font.Color := clMaroon;
    End;

  { cast DBGrid to a unit friendly class thus exposing all it private bits! }
  with TFriendly(DBGridPedidos) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. Check against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }
        Brush.Color := $00FFB76F; // PEG_COR_SELCGRID; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(Rect, DataCol, Column, State);
      end;
    end;
  end;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      Brush.Color := $00FFB76F; // PEG_COR_SELCGRID; // $004080FF;

      FillRect(fixRect);
      // Font.Color :=  CLWHITE;
      Font.Style := [fsbold];
    End;

  with TFriendly(DBGridPedidos) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. Check against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }

        Brush.Color := $00FFB76F; // PEG_COR_SELCGRID; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(fixRect, DataCol, Column, State);
      end;
    end;
  end;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);

end;

procedure TFrmFinalizaMesa.DBGridPedidosKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  If (((Shift = [ssCtrl]) And (Key = 46))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) Then
    Abort;
end;

procedure TFrmFinalizaMesa.DBGridPedidosKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    Key := #0;
    if not DmDados.orcdlv.IsEmpty then
      BtnPedConfirma.SetFocus;
  end;
  if Key = #27 then
  begin
    Key := #0;
    EdtPedido.SetFocus;
  end;
end;

procedure TFrmFinalizaMesa.DBGridPedidosTitleClick(Column: TColumn);
begin
  DmDados.orcdlv.IndexFieldNames := Column.FieldName;
end;

procedure TFrmFinalizaMesa.DBGridResumoitensKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  If (((Shift = [ssCtrl]) And (Key = 46))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) Then
    Abort;

end;

procedure TFrmFinalizaMesa.DBGridItensCellClick(Column: TColumn);
begin
  if (DmDados.itoorcchave.AsString <> '') and (DmDados.itoitochave.AsString <> '') then
  begin

    if (not DmDados.ito.Executing) and (not DmDados.ito.Fetching) then
    begin
      ApresentaItem(DmDados.orcorcchave.AsInteger, DmDados.itoitochave.AsInteger);
    end;

  end;
end;

procedure TFrmFinalizaMesa.DBGridItensKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  If ((Shift = [ssCtrl]) And (Key = 46)) or ((ssCtrl in Shift) and (Key = VK_DELETE)) Then
    Abort;

end;

procedure TFrmFinalizaMesa.DBGridItensKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin

  if (DmDados.itoorcchave.AsString <> '') and (DmDados.itoitochave.AsString <> '') then
  begin

    if (not DmDados.ito.Executing) and (not DmDados.ito.Fetching) then
    begin
      ApresentaItem(DmDados.orcorcchave.AsInteger, DmDados.itoitochave.AsInteger);
    end;

  end;
end;

procedure TFrmFinalizaMesa.doltDataChange(Sender: TObject; Field: TField);
begin
  if DmDados.olttipobaixa.AsInteger = 0 then
  begin

    if DmDados.oltorcchave.AsInteger <> 0 then
    begin
      DmDados.itoparcial.Close;
      DmDados.itoparcial.Params[0].AsInteger := DmDados.oltorcchave.AsInteger;
      DmDados.itoparcial.Open;
    end;

    if DmDados.itoparcial.Active then
    begin

      if not DmDados.itoparcial.IsEmpty then
      begin

      //  dmdados.consulta.close;
      //  dmdados.consulta.sql.text:='update olt set olttipo=1 where orcchave='+DmDados.itoparcialorcchave.asstring;
      //  dmdados.consulta.execsql;

        PnItensRecebidos.Visible := true;
      end
      else
        PnItensRecebidos.Visible := False;
    end
    else
      PnItensRecebidos.Visible := False;
  end
  else
  begin
    DmDados.itoparcial.Close;
    PnItensRecebidos.Visible := False;
  end;
end;

procedure TFrmFinalizaMesa.edtAFaturarExit(Sender: TObject);
begin
  if edtAFaturar.Text <> '' then
  begin
    ValidaRecebimento(vpAFaturar, StrToCurr(edtAFaturar.Text), edtAFaturar);
    // ValidaRecAFaturar;
  end
  else
  begin
    vpAFaturar := 0;
  end;

end;

procedure TFrmFinalizaMesa.edtAFaturarKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin

  TThread.Queue(nil,
    procedure
    var
      txt, txt2: string;
      X: Integer;
    begin
      txt := edtAFaturar.Text;
      txt2 := '';
      for X := 0 to Length(txt) - 1 do
        if (txt.Chars[X] In ['0' .. '9']) then
          txt2 := txt2 + txt.Chars[X];

      txt := txt2;
      if txt <> '' then
      begin

        edtAFaturar.Text := formatfloat('#0.00', StrToFloatDef(txt, 0) / 100);
        edtAFaturar.SelLength := 0;

      end;
      edtAFaturar.SelStart := edtAFaturar.GetTextLen;

    end);
end;

procedure TFrmFinalizaMesa.EdtNomeClienteEnter(Sender: TObject);
begin
  vpkey := true;
end;

procedure TFrmFinalizaMesa.EdtNomeClienteExit(Sender: TObject);
begin
  vpkey := False;
end;

procedure TFrmFinalizaMesa.EdtNomeClienteKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    Key := #0;
    Perform(WM_NEXTDLGCTL, 0, 0);
  end;
  if Key = #27 then
  begin
    Key := #0;
    Perform(WM_NEXTDLGCTL, 1, 0);
  end;
end;

procedure TFrmFinalizaMesa.EdtPedidoEnter(Sender: TObject);
begin
  LimpaEdtBusca;
  DmDados.orcdlv.IndexFieldNames := 'immnumepedido';
end;

procedure TFrmFinalizaMesa.EdtPedidoExit(Sender: TObject);
begin
  if EdtPedido.Text <> '' then
    if not DmDados.orcdlv.Locate('immnumepedido', EdtPedido.Text, []) then
    begin
      ShowMessage('Pedido nº ' + EdtPedido.Text + ' não encontrado !');
      EdtPedido.SetFocus;
    end;

end;

procedure TFrmFinalizaMesa.EdtPedidoKeyPress(Sender: TObject; var Key: Char);
begin
  if not(Key in [#13, #8, '0' .. '9']) then
    Key := #0;

  if Key = #13 then
  begin
    if EdtPedido.Text <> '' then
      DBGridPedidos.SetFocus
    else
      EdtCliente.SetFocus;
  end;
end;

procedure TFrmFinalizaMesa.EdtPIXExit(Sender: TObject);
var
 vlValor:Currency;
 flteliquido:Currency;
 OperacaoTEF:TOperacaoTEF;
begin


  if (EdtPIX.Text <> '') and (EdtPIX.Text <> '0,00')  and (EdtPIX.Enabled) then
  begin

    if StrToCurr(EdtPIX.Text)>0 then
    begin


        if (flteliquido>999.99)   then
        begin

          if CNPJCPFInformado=false then
          begin
            ExibirMensagemPorTempo('Vendas com valor superior a R$ 999,99'+#13+'necessita CPF ou CNPJ',2000);
            vlValor:=0;
          end
          else
          begin
            fTeclaFinalizador:=119;
            OperacaoTEF:= RegistraCartao(1, StrToCurr(EdtPIX.Text),'1');
            vlValor:=OperacaoTEF.valor;
            vpPIXaUTO:=OperacaoTEF.AutorizacaoRetorno;
            vpPIXVia1:=OperacaoTEF.ImagemComprovante1aVia;
            vpPIXbdc:=OperacaoTEF.Bandeira;
          end;
        end
        else
        begin
          fTeclaFinalizador:=119;
          OperacaoTEF:= RegistraCartao(1, StrToCurr(EdtPIX.Text),'1');
          vlValor:=OperacaoTEF.valor;
          vpPIXaUTO:=OperacaoTEF.AutorizacaoRetorno;
          vpPIXVia1:=OperacaoTEF.ImagemComprovante1aVia;
          vpPIXbdc:=OperacaoTEF.Bandeira;
        end;



      if vlValor=0 then
      begin
        EdtPIX.Text :='';
        EdtPIX.Enabled := True;
        vpPIX := 0;
        vpPIXaUTO:='';
        vpPIXVia1:='';
        vpPIXbdc:='';
      end
      else
      begin
        ValidaRecebimento(vpPIX, StrToCurr(EdtPIX.Text), EdtPIX);
        EdtPIX.Enabled := False;
      end;

    end;
  end
  else
  begin
    if EdtPIX.Text ='0,00' then
    begin
      EdtPIX.Text :='';
      EdtPIX.Enabled := True;
      vpPix := 0;
    end;
  end;

   ajustafalta;

end;

procedure TFrmFinalizaMesa.EdtPIXKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin

  TThread.Queue(nil,
    procedure
    var
      txt, txt2: string;
      X: Integer;
    begin
      txt := EdtPIX.Text;
      txt2 := '';
      for X := 0 to Length(txt) - 1 do
        if (txt.Chars[X] In ['0' .. '9']) then
          txt2 := txt2 + txt.Chars[X];

      txt := txt2;
      if txt <> '' then
      begin

        EdtPIX.Text := formatfloat('#0.00', StrToFloatDef(txt, 0) / 100);
        EdtPIX.SelLength := 0;


       if EdtPIX.Text<>'' then
        begin
          if StrToFloat(EdtPIX.Text)> vpFalta then
          begin
            Showmessage('Não pode ser informado valor como troco para PIX!');
            EdtPIX.Text:='';
          end;
        end;


      end;
      EdtPIX.SelStart := EdtPIX.GetTextLen;

    end);
end;

procedure TFrmFinalizaMesa.LimpaEdtBusca;
begin
  EdtPedido.Clear;
  EdtCliente.Clear;
  EdtTelefone.Clear;
  EdtEntregador.Clear;
end;

procedure TFrmFinalizaMesa.EdtQtdeExit(Sender: TObject);
begin
  if Length(EdtQtde.Text) = 0 then
    EdtQtde.Text := '0';

  if Length(EdtQtde.Text) > 0 then
  begin
    if (Strtofloat(EdtQtde.Text) > DmDados.itoitoquantidade.AsFloat) then
    begin
      ShowMessage('Quantidade informada maior que a quantidade lançado na comanda !');
      EdtQtde.Text := DmDados.itoitoquantidade.AsString;
    end;
  end;
end;

procedure TFrmFinalizaMesa.EdtQtdeKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    Key := #0;
    btnqtdeconfirma.SetFocus;
  end;
  if Length(EdtQtde.Text) = 0 then
  begin
    if not(Key in ['1' .. '9', #8, #13]) then
      Key := #0;
  end
  else if not(Key in ['0' .. '9', #8, #13]) then
    Key := #0;
end;

procedure TFrmFinalizaMesa.EdtTelefoneChange(Sender: TObject);
begin
  if EdtTelefone.Text <> '' then
  begin
    DmDados.orcdlv.Filtered := False;
    // DmDados.orcdlv.Filter   := '(orctelefone like %'+EdtTelefone.Text+'%)';
    DmDados.orcdlv.Filter := '( orctelefone = ' + QuotedStr('%' + EdtTelefone.Text + '%') + ')';
    DmDados.orcdlv.Filtered := true;
  end
  else
  begin
    DmDados.orcdlv.Filtered := False;
  end;
end;

procedure TFrmFinalizaMesa.EdtTelefoneEnter(Sender: TObject);
begin
  LimpaEdtBusca;
  DmDados.orcdlv.IndexFieldNames := 'orctelefone';
end;

procedure TFrmFinalizaMesa.EdtTelefoneExit(Sender: TObject);
begin
  if EdtTelefone.Text = '' then
  begin
    DmDados.orcdlv.Filtered := False;
  end;
end;

procedure TFrmFinalizaMesa.EdtTelefoneKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    Key := #0;
    if EdtTelefone.Text <> '' then
      DBGridPedidos.SetFocus
    else
      EdtEntregador.SetFocus;
  end;
  if Key = #27 then
  begin
    Key := #0;
    EdtCliente.SetFocus;
  end;
end;

procedure TFrmFinalizaMesa.EdtVlRestoChange(Sender: TObject);
begin
  if (Length((Sender as TEdit).Text) = 1) and ((Sender as TEdit).Text = '0') then
  begin
    try
      (Sender as TEdit).Text := '';
      (Sender as TEdit).SetFocus;
    except
    end;
  end;

end;

procedure TFrmFinalizaMesa.EdtVlRestoKeyPress(Sender: TObject; var Key: Char);
begin
  if (Key = ',') then
    if AnsiPos(',', (Sender as TEdit).Text) > 0 then
      Key := #0;

  if not(Key in [#0, #13, #27, #8, #3, #$16, ',', '0' .. '9']) then
    Key := #0;

  if Key = #13 then
  begin
    Key := #0;
    Perform(WM_NEXTDLGCTL, 0, 0);
  end;
  if Key = #27 then
  begin
    Key := #0;
    vpTroco := 0;
    EdtTroco.Text := formatfloat('###0.00', vpTroco);
    EdtVlResto.Text := '0';
    PCFechamento.Enabled := true;
    PnTroco.Visible := False;
    Button12.Click;
  end;
end;

procedure TFrmFinalizaMesa.EdtVlrPagoChange(Sender: TObject);
var
  vSQL: String;

begin
  if (Length((Sender as TEdit).Text) = 1) and ((Sender as TEdit).Text = '0') then
  begin
    (Sender as TEdit).Text := '';
    (Sender as TEdit).SetFocus;
  end
  else
  begin
    CalculaTaxaParcial;

  end;
end;

procedure TFrmFinalizaMesa.EdtVlrPagoExit(Sender: TObject);
var
  vVlrInformado: Currency;
begin
  if not EdtVlrPago.ReadOnly then
  begin

    if DmDados.ValidaValor(EdtVlrPago, vVlrInformado) then
    begin
      if (vVlrInformado > 0) and (vVlrInformado <= vpReceber) then
      begin
        vpFalta := vVlrInformado - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
        vpReceber := vVlrInformado;
        EdtVlrPago.Text := formatfloat('###0.00', vVlrInformado);
        CalculaTaxaParcial;
        EdtFalta.Text := formatfloat('###0.00', vpFalta + vpTaxaParcial);
        EdtVlrPago.ReadOnly := true;

        if EdtVlrPago.Text <> EdtVlrReceber.Text then
        begin
          EdtNomeCliente.Color := clYellow;
          EdtDesconto.Enabled := False;

          if cbDescontarTaxa.Visible then
          begin
            cbDescontarTaxa.ItemIndex := 1;
            cbDescontarTaxa.Enabled := False;
            edValorTaxa.Text := '0,00';
            EdtDesconto.Enabled := False;

            // cbDescontarTaxa.SetFocus;
          end;
        end
        else
        begin
          begin
            EdtNomeCliente.Color := clWhite;
            EdtDesconto.Enabled := true;
            cbDescontarTaxa.Enabled := true;

          end;

        end;
      //  Application.ProcessMessages;

      end
      else
      begin
        EdtVlrPago.Text := formatfloat('###0.00', vpReceber);
        CalculaTaxaParcial;
        vpFalta := vpReceber;
      end;
      btDescontoPerc.Visible := False;

    end;
  end;
end;

procedure TFrmFinalizaMesa.EdtVlrPagoKeyPress(Sender: TObject; var Key: Char);
begin

  if (Key = 'd') or (Key = 'D') then
  begin
    Key := #0;
    btDescontoPerc.Click;
    exit;

  end;

  if (Key = ',') then
    if AnsiPos(',', (Sender as TEdit).Text) > 0 then
      Key := #0;

  if not(Key in [#0, #13, #27, #8, #3, #$16, ',', '0' .. '9']) then
    Key := #0;

  if Key = #13 then
  begin
    Key := #0;
    EdtDinherio.SetFocus;
    // Perform(WM_NEXTDLGCTL, 0, 0);
  end;
  if Key = #27 then
  begin
    Key := #0;
    Perform(WM_NEXTDLGCTL, 1, 0);
  end;
end;

procedure TFrmFinalizaMesa.ajustafalta;
var
  vlValor: string;
begin
  vlValor := edValorTaxa.Text;

  if Pos(',', vlValor) > 0 then
    vlValor := StringReplace(vlValor, ',', '.', [rfReplaceAll, rfIgnoreCase]);

  if cbDescontarTaxa.Visible then
  begin
    if (Strtofloat(edValorTaxa.Text) <= 0) and (cbDescontarTaxa.Text <> 'Sem Taxa') then
    begin
      cbDescontarTaxa.ItemIndex := 1;
      edValorTaxa.Text := formatfloat('###0.00', 0);
      edValorTaxa.Enabled := False;
      EdtTroco.Text := formatfloat('###0.00', 0);
      EdtFalta.Text := formatfloat('###0.00', 0);
      CalculaTaxaParcial;
      vpFalta := (vpReceber) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
      EdtFalta.Text := formatfloat('###0.00', vpFalta);

      // ShowMessage('Valor de taxa 0,00 dever ser selecionado Sem Taxa');
      // cbDescontarTaxa.SetFocus;
      exit;
    end;
  end;

  vpTaxaParcial := StrToCurr(StringReplace(vlValor, '.', ',', [rfReplaceAll, rfIgnoreCase]));

  EdtVlrPago.Text := formatfloat('###0.00', vpReceber);

  EdtTroco.Text := formatfloat('###0.00', 0);
  EdtFalta.Text := formatfloat('###0.00', 0);
  // CalculaTaxaParcial;
  vpFalta := (vpReceber + vpTaxaParcial) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao +
    vpcredito);
  EdtFalta.Text := formatfloat('###0.00', vpFalta);

  if vpFalta >= 0.001 then
  begin
    BtnTabRecConfirma.Enabled := False;
  end
  else
  begin
    BtnTabRecConfirma.Enabled := true;
  end;

end;

procedure TFrmFinalizaMesa.edValorTaxaExit(Sender: TObject);
var
  vlValor: string;
begin
  vlValor := edValorTaxa.Text;

  if Pos(',', vlValor) > 0 then
    vlValor := StringReplace(vlValor, ',', '.', [rfReplaceAll, rfIgnoreCase]);

  if cbDescontarTaxa.Visible then
  begin
    if (Strtofloat(edValorTaxa.Text) <= 0) and (cbDescontarTaxa.Text <> 'Sem Taxa') then
    begin
      ShowMessage('Valor de taxa 0,00 dever ser selecionado Sem Taxa');
      cbDescontarTaxa.SetFocus;
      exit;
    end;
  end;

  vpTaxaParcial := StrToCurr(StringReplace(vlValor, '.', ',', [rfReplaceAll, rfIgnoreCase]));

  EdtVlrPago.Text := formatfloat('###0.00', vpReceber);

  EdtTroco.Text := formatfloat('###0.00', 0);
  EdtFalta.Text := formatfloat('###0.00', 0);
  // CalculaTaxaParcial;
  vpFalta := (vpReceber + vpTaxaParcial) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
  EdtFalta.Text := formatfloat('###0.00', vpFalta);
  EdtDinherio.SetFocus;

end;

procedure TFrmFinalizaMesa.EmiteDocumento(pMesChave: Integer);
var
  vRetorno: String;
  vDirRelatorio: String;
  vImprimeDireto: Boolean;
  I: Integer;
  vlBotaoPadrao: TMsgDlgBtn;
  vlEtdCodigo: string;
begin
  if TabItens.Tag = 0 then
    vRetorno := Imprime(StrToInt(vpOrcChave))
  else
    vRetorno := Imprime(DmDados.orcdlvorcchave.AsInteger);

  if Copy(vRetorno, 1, 1) = '1' then
  begin
    if DmDados.cfgmcfgcfgusapdv.AsInteger = 0 then
      vlBotaoPadrao := mbNo
    else
      vlBotaoPadrao := mbYes;

    if MessageDlg('Deseja imprimir comprovante de venda ?', mtConfirmation, [mbYes, mbNo], 0, vlBotaoPadrao) = mrYes then
    begin

      if DmDados.cfgmcfgcfgmgoutaxaatendimento.AsCurrency > 0 then
      begin
        vDirRelatorio := Extractfilepath(Application.ExeName) + 'relat\comprovantetaxa.fr3';
      end
      else
      begin
        if fileexists(Extractfilepath(Application.ExeName) + 'relat\comprovantebalcao.fr3') then
          vDirRelatorio := Extractfilepath(Application.ExeName) + 'relat\comprovantebalcao.fr3'
        else
          vDirRelatorio := Extractfilepath(Application.ExeName) + 'relat\comprovante.fr3';
      end;

      vImprimeDireto := DmDados.Usuario.MitTipCodigo = tipTermica48Col;

      for I := 1 to DmDados.cfgmcfgcfgviascomprovante.AsInteger do
      begin
        if DmDados.ConsultaSQL('SELECT orcchave, meschave FROM mor WHERE meschave = ''' + IntToStr(pMesChave) + '''  order by morchave desc limit 1 ') then
          mrfrImprimir(DmDados.dConsulta, vDirRelatorio, tiImprimirDireto);
      end;
      if (vpImpConvenio) or (vpAFaturar <> 0) then
      begin
        vDirRelatorio := Extractfilepath(Application.ExeName) + 'relat\viaassinar.fr3';
        vImprimeDireto := DmDados.Usuario.MitTipCodigo = tipTermica48Col;

        if DmDados.ConsultaSQL('SELECT orcchave, meschave FROM mor WHERE meschave = ''' + IntToStr(pMesChave) + '''  order by morchave desc limit 1') then
          mrfrImprimir(DmDados.dConsulta, vDirRelatorio, tiImprimirDireto);
      end;
    end;
  end;
  if Copy(vRetorno, 2, 1) = '1' then
  begin
    ModuloNFCe(IntToStr(pMesChave));
  end
  else if Copy(vRetorno, 3, 1) = '1' then
  begin
    ModuloNFCe(IntToStr(pMesChave));
  end
  else if Copy(vRetorno, 4, 1) = '1' then
  begin
    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'select meschave, etdcodigo from mes where meschave=' + IntToStr(pMesChave);
    DmDados.Consulta.Open;

    vlEtdCodigo := '';
    if DmDados.Consulta.FieldByName('etdcodigo').AsString = '0' then
    begin

      vlEtdCodigo := mostralista('mcli', DmDados.Usuario.ClbCodigo.ToString, '');

      if (vlEtdCodigo <> '0') and (vlEtdCodigo <> '') then
      begin

        DmDados.Consulta.edit;
        DmDados.Consulta.FieldByName('etdcodigo').AsString := vlEtdCodigo;
        DmDados.Consulta.Post;
      end;

    end
    else
    begin
     vlEtdCodigo:= DmDados.Consulta.FieldByName('etdcodigo').AsString;
    end;

    if (vlEtdCodigo <> '0') and (vlEtdCodigo <> '') then
    begin
      modulonfe('', rnfGerarNFe, IntToStr(pMesChave));
    end;
  end;

end;

function TFrmFinalizaMesa.modulonfe(arq: String; Rotina: TRotinasNFe; chave: String): Boolean;
type
  TAcesso = record
    IdAcesso: Integer;
    Usuario: Integer;
    Filial: Integer;
    Terminal: Integer;
  end;

type
  TModuloNFe = function(AOwner: TComponent; Conexao: TUniConnection; varq: string; Vchave: string; vRotinaNFe: TRotinasNFe; Acesso: TAcesso;
  vConsultouSefaz: Boolean): Boolean;

var
  modnfe: TModuloNFe;

  ch: string;
  vu: string;

  Acesso: TAcesso;
  vpacknfe:Cardinal;

begin
  result := False;

  vpacknfe := LoadPackage('modulos\mnfegourmet.bpl');

  if vpacknfe <> 0 then
    try
      @modnfe := GetProcAddress(vpacknfe, PChar('ModuloNFe'));
      if Assigned(modnfe) then
      begin

        Acesso.IdAcesso := 0;
        Acesso.Filial := DmDados.cfgmcfgflacodigo.AsInteger;
        Acesso.Usuario := DmDados.Usuario.ClbCodigo;
        Acesso.Terminal := DmDados.Usuario.TrmCodigo;

        result := modnfe(Application, DmDados.Conexao, arq, chave, Rotina, Acesso, False);

      end;
    finally
      // DoUnLoadPackage(Application, vpack);
    end;
End;

procedure TFrmFinalizaMesa.EmiteRecibo(pLteChave: Integer);
var
  vRetorno: String;
  vDirRelatorio: String;
  vImprimeDireto: Boolean;
begin
  if pLteChave > 0 then
  begin
    vDirRelatorio := Extractfilepath(Application.ExeName) + 'relat\recibo.fr3';
    vImprimeDireto := DmDados.Usuario.MitTipCodigo = tipTermica48Col;
    if DmDados.ConsultaSQL('SELECT ''' + IntToStr(pLteChave) + ''' ltechave') then
      mrfrImprimir(DmDados.dConsulta, vDirRelatorio, tiImprimirDireto);
  end;
end;

procedure TFrmFinalizaMesa.EmiteComprovante(pMesChave: Integer);
var
  vRetorno: String;
  vDirRelatorio: String;
  vImprimeDireto: Boolean;
begin
  if pMesChave > 0 then
  begin
    if DmDados.cfgmcfgcfgmgoutaxaatendimento.AsCurrency > 0 then
    begin
      vDirRelatorio := Extractfilepath(Application.ExeName) + 'relat\comprovantetaxa.fr3';
    end
    else
    begin
      vDirRelatorio := Extractfilepath(Application.ExeName) + 'relat\comprovante.fr3';
    end;
    vImprimeDireto := DmDados.Usuario.MitTipCodigo = tipTermica48Col;
    if DmDados.ConsultaSQL('SELECT orcchave, meschave FROM mor WHERE meschave = ''' + IntToStr(pMesChave) + '''  order by morchave desc limit 1') then
      mrfrImprimir(DmDados.dConsulta, vDirRelatorio, tiImprimirDireto);
  end;
end;

procedure TFrmFinalizaMesa.EdtCardCreditoExit(Sender: TObject);
var
 vlValor:Currency;
 flteliquido:Currency;
 OperacaoTEF:TOperacaoTEF;
begin

  if (EdtCardCredito.Text <> '') and (EdtCardCredito.Text <> '0,00') and (EdtCardCredito.Enabled) then
  begin

    if StrToCurr(EdtCardCredito.Text)>0 then
    begin


        if (flteliquido>999.99)   then
        begin

          if CNPJCPFInformado=false then
          begin
            ExibirMensagemPorTempo('Vendas com valor superior a R$ 999,99'+#13+'necessita CPF ou CNPJ',2000);
            vlValor:=0;
          end
          else
          begin
            fTeclaFinalizador:=114;
            OperacaoTEF:= RegistraCartao(1, StrToCurr(EdtCardCredito.Text),'1');
            vlValor:=OperacaoTEF.valor;
            vpCardCreditoaUTO:=OperacaoTEF.AutorizacaoRetorno;
            vpCardCreditoVia1:=OperacaoTEF.ImagemComprovante1aVia;
            vpCardCreditobdc:=OperacaoTEF.Bandeira;
          end;
        end
        else
        begin
          fTeclaFinalizador:=114;
          OperacaoTEF:= RegistraCartao(1, StrToCurr(EdtCardCredito.Text),'1');
          vlValor:=OperacaoTEF.valor;
          vpCardCreditoaUTO:=OperacaoTEF.AutorizacaoRetorno;
          vpCardCreditoVia1:=OperacaoTEF.ImagemComprovante1aVia;
          vpCardCreditobdc:=OperacaoTEF.Bandeira;
        end;


      if vlValor=0 then
      begin
        EdtCardCredito.Text :='';
        EdtCardCredito.Enabled := True;
        vpCardCredito := 0;
        vpCardCreditoaUTO:='';
        vpCardCreditoVia1:='';
        vpCardCreditobdc:='';
      end
      else
      begin
        ValidaRecebimento(vpCardCredito, StrToCurr(EdtCardCredito.Text), EdtCardCredito);
        EdtCardCredito.Enabled := False;
      end;

    end;
  end
  else
  begin
    if EdtCardCredito.Text ='0,00' then
    begin
      EdtCardCredito.Text :='';
      EdtCardCredito.Enabled := True;
      vpCardCredito := 0;
    end;
  end;

  ajustafalta;
end;

procedure TFrmFinalizaMesa.EdtCardCreditoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin

  TThread.Queue(nil,
    procedure
    var
      txt, txt2: string;
      X: Integer;
    begin
      txt := EdtCardCredito.Text;
      txt2 := '';
      for X := 0 to Length(txt) - 1 do
        if (txt.Chars[X] In ['0' .. '9']) then
          txt2 := txt2 + txt.Chars[X];

      txt := txt2;
      if txt <> '' then
      begin

        EdtCardCredito.Text := formatfloat('#0.00', StrToFloatDef(txt, 0) / 100);
        EdtCardCredito.SelLength := 0;

        if EdtCardCredito.Text<>'' then
        begin
          if StrToFloat(EdtCardCredito.Text)> vpFalta then
          begin
            Showmessage('Não pode ser informado valor como troco para Cartão de Crédito!');
            EdtCardCredito.Text:='';
          end;
        end;


      end;
      EdtCardCredito.SelStart := EdtCardCredito.GetTextLen;

    end);
end;

procedure TFrmFinalizaMesa.EdtCardDebitoExit(Sender: TObject);
var
 vlValor:Currency;
 flteliquido:Currency;
 OperacaoTEF:TOperacaoTEF;

begin
  if (EdtCardDebito.Text <> '') and  (EdtCardDebito.Text <> '0,00') and (EdtCardDebito.Enabled) then
  begin

    if StrToCurr(EdtCardDebito.Text)>0 then
    begin



        if (flteliquido>999.99)   then
        begin

          if CNPJCPFInformado=false then
          begin
            ExibirMensagemPorTempo('Vendas com valor superior a R$ 999,99'+#13+'necessita CPF ou CNPJ',2000);
            vlValor:=0;
          end
          else
          begin
            fTeclaFinalizador:=115;
            OperacaoTEF:= RegistraCartao(1, StrToCurr(EdtCardDebito.Text),'1');
            vlValor:=OperacaoTEF.valor;
            vpCardDebito:=vlValor;
            vpCardDebitoaUTO:=OperacaoTEF.AutorizacaoRetorno;
            vpCardDebitoVia1:=OperacaoTEF.ImagemComprovante1aVia;
            vpCardDebitobdc:=OperacaoTEF.Bandeira;

          end;
        end
        else
        begin
          fTeclaFinalizador:=115;
          OperacaoTEF:= RegistraCartao(1, StrToCurr(EdtCardDebito.Text),'1');
          vlValor:=OperacaoTEF.valor;
          vpCardDebito:=vlValor;
          vpCardDebitoaUTO:=OperacaoTEF.AutorizacaoRetorno;
          vpCardDebitoVia1:=OperacaoTEF.ImagemComprovante1aVia;
          vpCardDebitobdc:=OperacaoTEF.Bandeira;

        end;



      if vlValor=0 then
      begin
        EdtCardDebito.Text :='';
        EdtCardDebito.Enabled := True;
        vpCardDebito := 0;
        vpCardDebitoaUTO:='';
        vpCardDebitoVia1:='';
        vpCardDebitobdc:='';
      end
      else
      begin
        ValidaRecebimento(vpCardDebito, StrToCurr(EdtCardDebito.Text), EdtCardDebito);
        EdtCardDebito.Enabled := False;

      end;


    end;
  end
  else
  begin
    if EdtCardDebito.Text ='0,00' then
    begin
      EdtCardDebito.Text :='';
      EdtCardDebito.Enabled := True;
      vpCardDebito := 0;
    end;
  end;

  ajustafalta;

end;

procedure TFrmFinalizaMesa.EdtCardDebitoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  TThread.Queue(nil,
    procedure
    var
      txt, txt2: string;
      X: Integer;
    begin
      txt := EdtCardDebito.Text;
      txt2 := '';
      for X := 0 to Length(txt) - 1 do
        if (txt.Chars[X] In ['0' .. '9']) then
          txt2 := txt2 + txt.Chars[X];

      txt := txt2;
      if txt <> '' then
      begin
        EdtCardDebito.Text := formatfloat('#0.00', StrToFloatDef(txt, 0) / 100);
        EdtCardDebito.SelLength := 0;
      end;

      if EdtCardDebito.Text<>'' then
      begin
        if StrToFloat(EdtCardDebito.Text)> vpFalta then
        begin
          Showmessage('Não pode ser informado valor como troco para Cartão de Crédito!');
          EdtCardDebito.Text:='';
        end;
      end;

      EdtCardDebito.SelStart := EdtCardDebito.GetTextLen;

    end);
end;

procedure TFrmFinalizaMesa.EdtChequeExit(Sender: TObject);
begin

  if EdtCheque.Text <> '' then
  begin

    ValidaRecebimento(vpCheque, StrToCurr(EdtCheque.Text), EdtCheque);

    EdtCheque.Enabled := False;
  end
  else
  begin
    vpCheque := 0;
  end;

end;

procedure TFrmFinalizaMesa.EdtChequeKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin

  TThread.Queue(nil,
    procedure
    var
      txt, txt2: string;
      X: Integer;
    begin
      txt := EdtCheque.Text;
      txt2 := '';
      for X := 0 to Length(txt) - 1 do
        if (txt.Chars[X] In ['0' .. '9']) then
          txt2 := txt2 + txt.Chars[X];

      txt := txt2;
      if txt <> '' then
      begin

        EdtCheque.Text := formatfloat('#0.00', StrToFloatDef(txt, 0) / 100);
        EdtCheque.SelLength := 0;

      end;
      EdtCheque.SelStart := EdtCheque.GetTextLen;

    end);
end;

procedure TFrmFinalizaMesa.EdtClienteChange(Sender: TObject);
begin
  if EdtCliente.Text <> '' then
    DmDados.orcdlv.Locate('etdidentificacao', EdtCliente.Text, [loPartialKey, loCaseInsensitive]);
end;

procedure TFrmFinalizaMesa.EdtClienteEnter(Sender: TObject);
begin
  LimpaEdtBusca;
  DmDados.orcdlv.IndexFieldNames := 'etdidentificacao';
end;

procedure TFrmFinalizaMesa.EdtClienteKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    Key := #0;
    if EdtCliente.Text <> '' then
      DBGridPedidos.SetFocus
    else
      EdtTelefone.SetFocus;
  end;
  if Key = #27 then
  begin
    Key := #0;
    EdtPedido.SetFocus;
  end;
end;

procedure TFrmFinalizaMesa.EdtConvenioExit(Sender: TObject);
begin
  if EdtConvenio.Text <> '' then
  begin
    ValidaRecebimento(vpConvenio, StrToCurr(EdtConvenio.Text), EdtConvenio);
    // ValidaRecConvenio;
    EdtConvenio.Enabled := False;
  end
  else
  begin
    vpConvenio := 0;
  end;
end;

procedure TFrmFinalizaMesa.EdtConvenioKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin

  TThread.Queue(nil,
    procedure
    var
      txt, txt2: string;
      X: Integer;
    begin
      txt := EdtConvenio.Text;
      txt2 := '';
      for X := 0 to Length(txt) - 1 do
        if (txt.Chars[X] In ['0' .. '9']) then
          txt2 := txt2 + txt.Chars[X];

      txt := txt2;
      if txt <> '' then
      begin

        EdtConvenio.Text := formatfloat('#0.00', StrToFloatDef(txt, 0) / 100);
        EdtConvenio.SelLength := 0;

      end;
      EdtConvenio.SelStart := EdtConvenio.GetTextLen;

    end);
end;

procedure TFrmFinalizaMesa.edtCreditoExit(Sender: TObject);
begin
  if edtCredito.Text <> '' then
  begin
    ValidaRecebimento(vpcredito, StrToCurr(edtCredito.Text), edtCredito);
    // ValidaReccredito;
  end
  else
  begin
    vpcredito := 0;
  end;

end;

procedure TFrmFinalizaMesa.edtCreditoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin

  TThread.Queue(nil,
    procedure
    var
      txt, txt2: string;
      X: Integer;
    begin
      txt := edtCredito.Text;
      txt2 := '';
      for X := 0 to Length(txt) - 1 do
        if (txt.Chars[X] In ['0' .. '9']) then
          txt2 := txt2 + txt.Chars[X];

      txt := txt2;
      if txt <> '' then
      begin

        edtCredito.Text := formatfloat('#0.00', StrToFloatDef(txt, 0) / 100);
        edtCredito.SelLength := 0;

      end;
      edtCredito.SelStart := edtCredito.GetTextLen;

    end);
end;

procedure TFrmFinalizaMesa.EdtDescontoChange(Sender: TObject);
begin
  if (Length((Sender as TEdit).Text) = 1) and ((Sender as TEdit).Text = '0') then
  begin
    (Sender as TEdit).Text := '';
    (Sender as TEdit).SetFocus;
  end;
end;

procedure TFrmFinalizaMesa.EdtDescontoExit(Sender: TObject);
begin
  if EdtDesconto.Text <> '' then
  begin

    ValidaRecDesconto;
    ajustafalta;
    ValidaRecDinheiro;

    // edValorTaxaExit(edValorTaxa);
  end;
end;

procedure TFrmFinalizaMesa.ValidaRecDesconto;
var
  vVlrInformado: Currency;
begin
  if not EdtDesconto.ReadOnly then
  begin
    if (DmDados.ValidaValor(EdtDesconto, vVlrInformado)) and (vpDescontoMaximo>0) then
    begin
      if (vVlrInformado > vpDescontoMaximo) then
      begin
        ShowMessage('Desconto informado maior que máximo permitido (R$ ' + formatfloat('###0.00', vpDescontoMaximo) + '), Verifique!');
        LimpaRecebimento;
        EdtDesconto.SetFocus;
        exit;
      end;
      if (vVlrInformado > 0) and (vVlrInformado <= vpTotal) then
      begin
        vpFalta := ((vpTotal) - vVlrInformado);
        vpReceber := vpFalta;
        vpDesconto := vVlrInformado;
        EdtDesconto.Text := formatfloat('###0.00', vVlrInformado);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrReceber.Text := formatfloat('###0.00', vpReceber);
        EdtVlrPago.Text := formatfloat('###0.00', vpReceber);
        EdtDesconto.ReadOnly := true;
      end
      else
      begin
        EdtDesconto.Text := formatfloat('###0.00', vpDesconto);
        vpFalta := (vpTotal - vpDesconto);
      end;
    end;
  end;
end;

procedure TFrmFinalizaMesa.EdtDescontoKeyPress(Sender: TObject; var Key: Char);
begin
  if (Key = ',') then
    if AnsiPos(',', (Sender as TEdit).Text) > 0 then
      Key := #0;

  if not(Key in [#0, #13, #27, #8, #3, #$16, ',', '0' .. '9']) then
    Key := #0;

  if Key = #13 then
  begin
    Key := #0;
    Perform(WM_NEXTDLGCTL, 0, 0);
  end;
  if Key = #27 then
  begin
    Key := #0;
    Perform(WM_NEXTDLGCTL, 1, 0);
  end;
end;

procedure TFrmFinalizaMesa.EdtDinherioExit(Sender: TObject);
begin

  if EdtDinherio.Text <> '' then
  begin
    plvalorinformado.Caption := 'R$ ' + formatfloat('###0.00', Strtofloat(BuscaTroca(EdtDinherio.Text, '.', '')));
  //  Application.ProcessMessages;

    ValidaRecebimento(vpDinheiro, StrToCurr(EdtDinherio.Text), EdtDinherio);

    // ValidaRecDinheiro;

  end
  else
  begin
    vpDinheiro := 0;
  end;

end;

procedure TFrmFinalizaMesa.EdtDinherioKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  TThread.Queue(nil,
    procedure
    var
      txt, txt2: string;
      X: Integer;
    begin
      txt := EdtDinherio.Text;
      txt2 := '';
      for X := 0 to Length(txt) - 1 do
        if (txt.Chars[X] In ['0' .. '9']) then
          txt2 := txt2 + txt.Chars[X];

      txt := txt2;
      EdtDinherio.Text := formatfloat('#0.00', StrToFloatDef(txt, 0) / 100);
      EdtDinherio.SelLength := 0;

      EdtDinherio.SelStart := EdtDinherio.GetTextLen;

    end);
end;

procedure TFrmFinalizaMesa.edtDoacaoExit(Sender: TObject);
begin
  if edtDoacao.Text <> '' then
  begin
    ValidaRecebimento(vpDoacao, StrToCurr(edtDoacao.Text), edtDoacao);

    // ValidaRecdoacao;
  end
  else
  begin
    vpDoacao := 0;
  end;

end;

procedure TFrmFinalizaMesa.edtDoacaoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin

  TThread.Queue(nil,
    procedure
    var
      txt, txt2: string;
      X: Integer;
    begin
      txt := edtDoacao.Text;
      txt2 := '';
      for X := 0 to Length(txt) - 1 do
        if (txt.Chars[X] In ['0' .. '9']) then
          txt2 := txt2 + txt.Chars[X];

      txt := txt2;
      if txt <> '' then
      begin

        edtDoacao.Text := formatfloat('#0.00', StrToFloatDef(txt, 0) / 100);
        edtDoacao.SelLength := 0;

      end;
      edtDoacao.SelStart := edtDoacao.GetTextLen;

    end);
end;

procedure TFrmFinalizaMesa.EdtEntregadorChange(Sender: TObject);
begin
  if EdtEntregador.Text <> '' then
    DmDados.orcdlv.Locate('etgidentificacao', EdtEntregador.Text, [loPartialKey, loCaseInsensitive]);
end;

procedure TFrmFinalizaMesa.EdtEntregadorEnter(Sender: TObject);
begin
  LimpaEdtBusca;
  DmDados.orcdlv.IndexFieldNames := 'etgidentificacao';
end;

procedure TFrmFinalizaMesa.EdtEntregadorKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    Key := #0;
    DBGridPedidos.SetFocus;
  end;
  if Key = #27 then
  begin
    Key := #0;
    EdtTelefone.SetFocus;
  end;
end;

procedure TFrmFinalizaMesa.ValidaRecCardDedito;
var
  vVlrInformado: Currency;
begin
  if DmDados.ValidaValor(EdtCardDebito, vVlrInformado) then
  begin

    if ((vVlrInformado >= 0) and (vVlrInformado <= (vpFalta + vpCardDebito))) then
    begin
      if vVlrInformado = vpReceber + vpTaxaParcial then
      begin
        vpFalta := 0;
        vpCardDebito := vVlrInformado;

        if cbDescontarTaxa.Visible = False then
          EdtCardDebito.Text := formatfloat('###0.00', vVlrInformado);

        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;

      end
      else
      begin

        if EdtCardDebito.Text = '0,00' then
        begin
          if cbDescontarTaxa.Text = 'Sem Taxa' then
            vpFalta := vpReceber - (vVlrInformado + vpConvenio + vpAFaturar + vpPIX + vpDinheiro + vpCardCredito + vpCheque + vpAFaturar + vpDoacao +
              vpcredito)
          else
            vpFalta := vpReceber + vpTaxaParcial - (vVlrInformado + vpDinheiro + vpPIX + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar +
              vpDoacao + vpcredito);

          if vVlrInformado = 0 then
            vVlrInformado := vpFalta;

          vpCardDebito := vVlrInformado;
          EdtCardDebito.Text := formatfloat('###0.00', vVlrInformado + vpTaxaParcial);
          EdtFalta.Text := formatfloat('###0.00', vpFalta);
          EdtVlrPago.ReadOnly := true;

        end
        else
        begin
          vpCardDebito := vVlrInformado;

          // if cbDescontarTaxa.Text = 'Sem Taxa' then

          if cbDescontarTaxa.Text = 'Descontar' then
            vpFalta := vpReceber - (vVlrInformado + vpAFaturar + vpConvenio + vpDinheiro + vpPIX + vpCardCredito + vpCheque + vpAFaturar + vpDoacao +
              vpcredito)
          else
            vpFalta := vpReceber + vpTaxaParcial - (vVlrInformado + vpConvenio + vpPIX + vpDinheiro + vpCardCredito + vpCheque + vpAFaturar + vpDoacao
              + vpcredito);

          EdtFalta.Text := formatfloat('###0.00', vpFalta);
        end;

      end;
    end
    else
    begin

      if vpCardDebito = 0 then
      begin
        ShowMessage('Valor informado para Cartão de Débito é inválido!' + #13 + #13 + 'Favor clicar no botão Limpar e refazer o recebimento!');
      end;

      vpFalta := (vpReceber) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao + vpcredito);

      if cbDescontarTaxa.Visible = False then
        EdtCardDebito.Text := formatfloat('###0.00', vpCardDebito + vpTaxaParcial);

      vpTroco := 0;
      EdtTroco.Text := formatfloat('###0.00', vpTroco);

    end;
  end;
  if vpFalta <= 0.001 then
  begin
    if BtnTabRecConfirma.Visible then
    begin
      BtnTabRecConfirma.Enabled := true;
      if BtnTabRecConfirma.Enabled then
      begin
        BtnTabRecConfirma.SetFocus;
      end;
    end;
  end
  else
  begin
    BtnTabRecConfirma.Enabled := False;
  end;

  if PnCliente.Visible then
  begin

    if EdtNomeCliente.Color = clYellow then
    begin
      if (EdtNomeCliente.Text = '') and (ActiveControl <> EdtNomeCliente) then
      begin
        ShowMessage('Favor informar o campo Recebido de:');
        EdtNomeCliente.SetFocus;
      end;

    end;

  end;

end;

procedure TFrmFinalizaMesa.ValidaRecCardCredito;
var
  vVlrInformado: Currency;
begin
  if DmDados.ValidaValor(EdtCardCredito, vVlrInformado) then
  begin
    { vpTroco := 0;
      EdtTroco.Text := formatfloat('###0.00', vpTroco); }

    if ((vVlrInformado >= 0) and (vVlrInformado <= (vpFalta + vpCardCredito))) then
    begin
      if vVlrInformado = vpReceber + vpTaxaParcial then
      begin
        vpFalta := 0;
        vpCardCredito := vVlrInformado;

        if cbDescontarTaxa.Visible = False then
          EdtCardCredito.Text := formatfloat('###0.00', vVlrInformado);

        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;

      end
      else
      begin

        if EdtCardCredito.Text = '0,00' then
        begin
          if cbDescontarTaxa.Text = 'Sem Taxa' then
            vpFalta := vpReceber - (vVlrInformado + vpConvenio + vpAFaturar + vpDinheiro + vpPIX + vpCardDebito + vpCheque + vpAFaturar + vpDoacao +
              vpcredito)
          else
            vpFalta := vpReceber + vpTaxaParcial - (vVlrInformado + vpDinheiro + vpPIX + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar +
              vpDoacao + vpcredito);

          if vVlrInformado = 0 then
            vVlrInformado := vpFalta;

          vpCardCredito := vVlrInformado;
          EdtCardCredito.Text := formatfloat('###0.00', vVlrInformado + vpTaxaParcial);
          EdtFalta.Text := formatfloat('###0.00', vpFalta);
          EdtVlrPago.ReadOnly := true;

        end
        else
        begin
          vpCardCredito := vVlrInformado;

          if cbDescontarTaxa.Text = 'Descontar' then
            vpFalta := vpReceber - (vVlrInformado + vpConvenio + vpAFaturar + vpDinheiro + vpPIX + vpCardDebito + vpCheque + vpAFaturar + vpDoacao +
              vpcredito)
          else
            vpFalta := vpReceber + vpTaxaParcial - (vVlrInformado + vpConvenio + vpDinheiro + vpPIX + vpCardDebito + vpCheque + vpAFaturar + vpDoacao
              + vpcredito);

          EdtFalta.Text := formatfloat('###0.00', vpFalta);
        end;

      end;
    end
    else
    begin

      if vpCardCredito = 0 then
      begin
        ShowMessage('Valor informado para Cartão de Crédito é inválido!' + #13 + #13 + 'Favor clicar no botão Limpar e refazer o recebimento!');
      end;

      vpFalta := (vpReceber) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao + vpcredito);

      if cbDescontarTaxa.Visible = False then
        EdtCardCredito.Text := formatfloat('###0.00', vpCardCredito + vpTaxaParcial);

      vpTroco := 0;
      EdtTroco.Text := formatfloat('###0.00', vpTroco);

    end;
  end;

  if vpFalta <= 0.001 then
  begin
    if BtnTabRecConfirma.Visible then
    begin
      BtnTabRecConfirma.Enabled := true;
      if BtnTabRecConfirma.Enabled then
      begin
        BtnTabRecConfirma.SetFocus;
      end;
    end;
  end
  else
  begin
    BtnTabRecConfirma.Enabled := False;
  end;

  if PnCliente.Visible then
  begin
    if EdtNomeCliente.Color = clYellow then
    begin
      if (EdtNomeCliente.Text = '') and (ActiveControl <> EdtNomeCliente) then
      begin
        ShowMessage('Favor informar o campo Recebido de:');
        EdtNomeCliente.SetFocus;
      end;

    end;
  end;

end;

procedure TFrmFinalizaMesa.ValidaRecAFaturar;
var
  vVlrInformado: Currency;
begin
  if DmDados.ValidaValor(edtAFaturar, vVlrInformado) then
  begin
    // CalculaTroco(vVlrInformado);
    // Calculando troco
    { vpTroco := 0;
      EdtTroco.Text := formatfloat('###0.00', vpTroco); }

    if (vVlrInformado > (vpFalta + vpAFaturar)) then
    begin
      vpTroco := vVlrInformado - (vpFalta + vpAFaturar);
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
      vVlrInformado := vVlrInformado - vpTroco;
    end;

    if ((vVlrInformado >= 0) and (vVlrInformado <= (vpFalta + vpAFaturar))) then
    begin
      if vVlrInformado = vpReceber + vpTaxaParcial then
      begin
        vpFalta := 0;
        vpAFaturar := vVlrInformado;
        edtAFaturar.Text := formatfloat('###0.00', vVlrInformado);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;

      end
      else
      begin
        vpFalta := vpReceber - (vVlrInformado + vpConvenio + vpDinheiro + vpPIX + vpCardDebito + vpCardCredito + vpCheque + vpDoacao + vpcredito);
        vpAFaturar := vVlrInformado;
        edtAFaturar.Text := formatfloat('###0.00', vVlrInformado + vpTaxaParcial);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end;
    end
    else
    begin
      edtAFaturar.Text := formatfloat('###0.00', vpAFaturar + vpTaxaParcial);
      vpFalta := vpReceber - (vpDinheiro + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpDoacao + vpcredito);
      vpTroco := 0;
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
    end;
  end;
  if vpFalta <= 0.001 then
  begin
    if BtnTabRecConfirma.Visible then
    begin
      BtnTabRecConfirma.Enabled := true;
      if BtnTabRecConfirma.Enabled then
      begin
        BtnTabRecConfirma.SetFocus;
      end;
    end;
  end
  else
  begin
    BtnTabRecConfirma.Enabled := False;
  end;

  if PnCliente.Visible then
  begin

    if (EdtNomeCliente.Color = clYellow) then
    begin
      if (EdtNomeCliente.Text = '') and (ActiveControl <> EdtNomeCliente) then
      begin
        ShowMessage('Favor informar o campo Recebido de:');
        EdtNomeCliente.SetFocus;
      end;

    end;

  end;
end;

procedure TFrmFinalizaMesa.ValidaRecConvenio;
var
  vVlrInformado: Currency;
begin
  if DmDados.ValidaValor(EdtConvenio, vVlrInformado) then
  begin

    if (vVlrInformado > (vpFalta + vpConvenio)) then
    begin
      vpTroco := vVlrInformado - (vpFalta + vpConvenio);
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
      vVlrInformado := vVlrInformado - vpTroco;
    end;

    if ((vVlrInformado >= 0) and (vVlrInformado <= (vpFalta + vpConvenio))) then
    begin
      if vVlrInformado = vpReceber + vpTaxaParcial then
      begin
        vpFalta := 0;
        vpConvenio := vVlrInformado;
        EdtConvenio.Text := formatfloat('###0.00', vVlrInformado);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;

      end
      else
      begin
        vpFalta := vpReceber - (vVlrInformado + vpAFaturar + vpDinheiro + vpPIX + vpCardDebito + vpCardCredito + vpCheque + vpDoacao + vpcredito);
        vpConvenio := vVlrInformado;
        EdtConvenio.Text := formatfloat('###0.00', vVlrInformado + vpTaxaParcial);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end;
    end
    else
    begin
      EdtConvenio.Text := formatfloat('###0.00', vpConvenio + vpTaxaParcial);
      vpFalta := vpReceber - (vpDinheiro + vpPIX + vpAFaturar + vpCardDebito + vpCardCredito + vpCheque + vpDoacao + vpcredito);
      vpTroco := 0;
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
    end;
  end;
  if vpFalta <= 0.001 then
  begin
    if BtnTabRecConfirma.Visible then
    begin
      BtnTabRecConfirma.Enabled := true;
      if BtnTabRecConfirma.Enabled then
      begin
        BtnTabRecConfirma.SetFocus;
      end;
    end;
  end
  else
  begin
    BtnTabRecConfirma.Enabled := False;
  end;

  if PnCliente.Visible then
  begin

    if (EdtNomeCliente.Color = clYellow) then
    begin
      if (EdtNomeCliente.Text = '') and (ActiveControl <> EdtNomeCliente) then
      begin
        ShowMessage('Favor informar o campo Recebido de:');
        EdtNomeCliente.SetFocus;
      end;

    end;

  end;

end;

procedure TFrmFinalizaMesa.ValidaReccredito;
var
  vVlrInformado: Currency;
begin
  if DmDados.ValidaValor(edtCredito, vVlrInformado) then
  begin
    if (vVlrInformado > (vpFalta + vpcredito)) then
    begin
      vpTroco := vVlrInformado - (vpFalta + vpcredito);
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
      vVlrInformado := vVlrInformado - vpTroco;
    end;

    if ((vVlrInformado >= 0) and (vVlrInformado <= (vpFalta + vpcredito))) then
    begin
      if vVlrInformado = vpReceber + vpTaxaParcial then
      begin
        vpFalta := 0;
        vpcredito := vVlrInformado;
        edtCredito.Text := formatfloat('###0.00', vVlrInformado);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end
      else
      begin
        vpFalta := vpReceber - (vVlrInformado + vpDinheiro + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque);
        vpcredito := vVlrInformado;
        edtCredito.Text := formatfloat('###0.00', vVlrInformado + vpTaxaParcial);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end;
    end
    else
    begin
      edtCredito.Text := formatfloat('###0.00', vpcredito + vpTaxaParcial);
      vpFalta := vpReceber - (vpDinheiro + vpPIX + vpConvenio + vpAFaturar + vpCardDebito + vpCardCredito + vpCheque);
      vpTroco := 0;
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
    end;
  end;
  if vpFalta <= 0.001 then
  begin
    if BtnTabRecConfirma.Visible then
    begin
      BtnTabRecConfirma.Enabled := true;
      if BtnTabRecConfirma.Enabled then
      begin
        BtnTabRecConfirma.SetFocus;
      end;
    end;
  end
  else
  begin
    BtnTabRecConfirma.Enabled := False;
  end;

end;

procedure TFrmFinalizaMesa.ValidaRecdoacao;
var
  vVlrInformado: Currency;
begin
  if DmDados.ValidaValor(edtDoacao, vVlrInformado) then
  begin
    // CalculaTroco(vVlrInformado);
    // Calculando troco
    { vpTroco := 0;
      EdtTroco.Text := formatfloat('###0.00', vpTroco); }
    if (vVlrInformado > (vpFalta + vpDoacao)) then
    begin
      vpTroco := vVlrInformado - (vpFalta + vpDoacao);
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
      vVlrInformado := vVlrInformado - vpTroco;
    end;

    if ((vVlrInformado >= 0) and (vVlrInformado <= (vpFalta + vpDoacao))) then
    begin
      if vVlrInformado = vpReceber + vpTaxaParcial then
      begin
        vpFalta := 0;
        vpDoacao := vVlrInformado;
        edtDoacao.Text := formatfloat('###0.00', vVlrInformado);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end
      else
      begin
        vpFalta := vpReceber - (vVlrInformado + vpDinheiro + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpcredito);
        vpDoacao := vVlrInformado;
        edtDoacao.Text := formatfloat('###0.00', vVlrInformado + vpTaxaParcial);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end;
    end
    else
    begin
      edtDoacao.Text := formatfloat('###0.00', vpDoacao + vpTaxaParcial);
      vpFalta := vpReceber - (vpDinheiro + vpPIX + vpConvenio + vpAFaturar + vpCardDebito + vpCardCredito + vpCheque + vpcredito);
      vpTroco := 0;
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
    end;
  end;
  if vpFalta <= 0.001 then
  begin
    if BtnTabRecConfirma.Visible then
    begin
      BtnTabRecConfirma.Enabled := true;
      if BtnTabRecConfirma.Enabled then
      begin
        BtnTabRecConfirma.SetFocus;
      end;
    end;
  end
  else
  begin
    BtnTabRecConfirma.Enabled := False;
  end;

  if PnCliente.Visible then
  begin
    if EdtNomeCliente.Color = clYellow then
    begin
      if (EdtNomeCliente.Text = '') and (ActiveControl <> EdtNomeCliente) then
      begin
        ShowMessage('Favor informar o campo Recebido de:');
        EdtNomeCliente.SetFocus;
      end;

    end;
  end;

end;

procedure TFrmFinalizaMesa.ValidaRecDinheiro;
var
  vVlrInformado: Currency;
begin

  if DmDados.ValidaValor(EdtDinherio, vVlrInformado) then
  begin
    // CalculaTroco;
    // Calculando troco
    vpTroco := 0;
    EdtTroco.Text := formatfloat('###0.00', vpTroco);
    if (vVlrInformado { - vpTaxaParcial } > (vpFalta + vpDinheiro)) then
    begin
      vpTroco := vVlrInformado - (vpFalta + vpDinheiro);
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
      vVlrInformado := vVlrInformado - vpTroco;
    end;

    if ((vVlrInformado >= 0) and (vVlrInformado <= (vpFalta + vpDinheiro))) then
    begin
      if vVlrInformado >= vpReceber + vpTaxaParcial then
      begin
        vpFalta := 0;
        vpDinheiro := vVlrInformado;
        if cbDescontarTaxa.Visible = False then
          EdtDinherio.Text := formatfloat('###0.00', vVlrInformado);

        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end
      else
      begin
        if cbDescontarTaxa.Text = 'Descontar' then
          vpFalta := vpReceber - (vVlrInformado + vpPIX + vpAFaturar + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao +
            vpcredito)
        else
          vpFalta := vpReceber + vpTaxaParcial - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque +
            vpAFaturar + vpDoacao + vpcredito);

        vpDinheiro := vVlrInformado;
        if cbDescontarTaxa.Visible = False then
          EdtDinherio.Text := formatfloat('###0.00', vVlrInformado + vpTaxaParcial);

        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end;
    end
    else
    begin
      if cbDescontarTaxa.Visible = False then
        EdtDinherio.Text := formatfloat('###0.00', vpDinheiro + vpTaxaParcial);

      if cbDescontarTaxa.Visible = true then
      begin
        if vVlrInformado >= vpReceber + vpTaxaParcial then
        begin
          vpFalta := 0;
          vpTroco := vVlrInformado - (vpReceber + vpTaxaParcial);
          vpDinheiro := vVlrInformado;
          EdtFalta.Text := formatfloat('###0.00', vpFalta);
        end;

        // vpFalta := vpReceber+ vptaxaparcial- (vpDinheiro + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpCredito + vpDoacao);
      end
      else
      begin
        vpFalta := vpReceber - (vpDinheiro + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao +
          vpcredito);

        vpTroco := 0;

        EdtTroco.Text := formatfloat('###0.00', vpTroco);
      end;
    end;
  end;

  if vpFalta <= 0.001 then
  begin
    if BtnTabRecConfirma.Visible then
    begin
      BtnTabRecConfirma.Enabled := true;
      if BtnTabRecConfirma.Enabled then
      begin
        BtnTabRecConfirma.SetFocus;
      end;
    end;
  end
  else
  begin
    BtnTabRecConfirma.Enabled := False;
  end;

  if PnCliente.Visible then
  begin
    if (EdtNomeCliente.Color = clYellow) and (ActiveControl <> EdtNomeCliente) then
    begin
      if (EdtNomeCliente.Text = '') and (ActiveControl <> EdtNomeCliente) then
      begin
        ShowMessage('Favor informar o campo Recebido de:');
        EdtNomeCliente.SetFocus;
      end;

    end;
  end;

end;

procedure TFrmFinalizaMesa.ValidaRecPIX;
var
  vVlrInformado: Currency;
begin

  if DmDados.ValidaValor(EdtPIX, vVlrInformado) then
  begin
    // CalculaTroco;
    // Calculando troco
    vpTroco := 0;
    EdtTroco.Text := formatfloat('###0.00', vpTroco);
    if (vVlrInformado { - vpTaxaParcial } > (vpFalta + vpPIX)) then
    begin
      vpTroco := vVlrInformado - (vpFalta + vpPIX);
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
      vVlrInformado := vVlrInformado - vpTroco;
    end;

    if ((vVlrInformado >= 0) and (vVlrInformado <= (vpFalta + vpPIX))) then
    begin
      if vVlrInformado >= vpReceber + vpTaxaParcial then
      begin
        vpFalta := 0;
        vpPIX := vVlrInformado;
        if cbDescontarTaxa.Visible = False then
          EdtPIX.Text := formatfloat('###0.00', vVlrInformado);

        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end
      else
      begin
        if cbDescontarTaxa.Text = 'Descontar' then
          vpFalta := vpReceber - (vVlrInformado + vpAFaturar + vpDinheiro + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar +
            vpDoacao + vpcredito)
        else
          vpFalta := vpReceber + vpTaxaParcial - (vVlrInformado + vpAFaturar + vpDinheiro + vpConvenio + vpCardDebito + vpCardCredito + vpCheque +
            vpAFaturar + vpDoacao + vpcredito);

        vpPIX := vVlrInformado;
        if cbDescontarTaxa.Visible = False then
          EdtPIX.Text := formatfloat('###0.00', vVlrInformado + vpTaxaParcial);

        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end;
    end
    else
    begin
      if cbDescontarTaxa.Visible = False then
        EdtPIX.Text := formatfloat('###0.00', vpPIX + vpTaxaParcial);

      if cbDescontarTaxa.Visible = true then
      begin
        if vVlrInformado >= vpReceber + vpTaxaParcial then
        begin
          vpFalta := 0;
          vpTroco := vVlrInformado - (vpReceber + vpTaxaParcial);
          vpPIX := vVlrInformado;
          EdtFalta.Text := formatfloat('###0.00', vpFalta);
        end;

        // vpFalta := vpReceber+ vptaxaparcial- (vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpCredito + vpDoacao);
      end
      else
      begin
        vpFalta := vpReceber - (vpDinheiro + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao +
          vpcredito);

        vpTroco := 0;

        EdtTroco.Text := formatfloat('###0.00', vpTroco);
      end;
    end;
  end;

  if vpFalta <= 0.001 then
  begin
    if BtnTabRecConfirma.Visible then
    begin
      BtnTabRecConfirma.Enabled := true;
      if BtnTabRecConfirma.Enabled then
      begin
        BtnTabRecConfirma.SetFocus;
      end;
    end;
  end
  else
  begin
    BtnTabRecConfirma.Enabled := False;
  end;

  if PnCliente.Visible then
  begin
    if (EdtNomeCliente.Color = clYellow) and (ActiveControl <> EdtNomeCliente) then
    begin
      if (EdtNomeCliente.Text = '') and (ActiveControl <> EdtNomeCliente) then
      begin
        ShowMessage('Favor informar o campo Recebido de:');
        EdtNomeCliente.SetFocus;
      end;

    end;
  end;

end;

procedure TFrmFinalizaMesa.btnqtdecancelaClick(Sender: TObject);
begin
  PnQuantidade.Tag := 0;
  EdtQtde.Text := '0';
  PCFechamento.Enabled := true;
  PnQuantidade.Visible := False;
end;

Function ajustadata(Dia: String): String;

Var
  d: String;
  di, me, an: String;
Begin
  d := Dia;
  di := Copy(d, 1, 2);
  me := Copy(d, 4, 2);
  an := Copy(d, 7, 4);
  d := an + '-' + me + '-' + di;
  result := d;
End;

procedure TFrmFinalizaMesa.EncerraMesa;
var
  vlmeschave: string;
  vlmesicmchave: string;
  vlmeschaveAnterior: string;

  vlltechave: String;
  vlValor: String;
  vlOrcchaveRemover: string;
  vlrfichave: string;
  vlrdcnrchave: string;
  vlitmitem: Integer;
  vlCcxChave: string;
  I: Integer;

  vSQL: string;

  vlToeCodigoServico: Integer;
  vlPercentualdesconto: Double;
begin
  if vpReceber <= 0 then
  begin
    ShowMessage('Valor de recebimento não permitido, verifique !');
    exit;
  end;

  DmDados.ccx.Close;
  DmDados.ccx.ParamByName('clbcodigo').AsInteger := DmDados.Usuario.ClbCodigo;
  DmDados.ccx.Open;

  vlCcxChave := DmDados.ccxccxchave.AsString;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := 'select orcdataabert from orc where orcchave=' + vpOrcChave;
  DmDados.Consulta.Open;

  if DmDados.Consulta.FieldByName('orcdataabert').Asdatetime < DmDados.ccxccxdataber.Asdatetime then
  begin
    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'update orc set  orcimpressao=1,orcdataabert=' + QuotedStr(ajustadata(DmDados.ccxccxdataber.AsString)) +
      ' , ccxchave=' + vlCcxChave + ' where orcchave=' + vpOrcChave;
    DmDados.Consulta.ExecSQL;

    { DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'update imm,orc,ito set immhorapedido=' +
      QuotedStr(ajustadata(DmDados.ccxccxdataber.AsString) + ' ' + DmDados.ccxccxhoraaber.AsString) + ' , imm.cznchave=' + FPrinciGou.vpCznChave +
      ' where  ito.stocodigo=2 and  ito.itochave=imm.itochave and ito.orcchave=orc.orcchave and  orc.orcchave=' + vpOrcChave;
      DmDados.Consulta.ExecSQL; }

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'update imm,orc,ito set imm.cznchave=' + FPrinciGou.vpCznChave +
      ' where  ito.stocodigo=2 and  ito.itochave=imm.itochave and ito.orcchave=orc.orcchave and  orc.orcchave=' + vpOrcChave;
    DmDados.Consulta.ExecSQL;

  end
  else
  begin

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'update orc set orcimpressao=1,ccxchave=' + vlCcxChave + ' where orcchave=' + vpOrcChave;
    DmDados.Consulta.ExecSQL;

  end;

  // Gravando itens selecionados
  if not DmDados.titem.IsEmpty then
    DmDados.titem.ApplyUpdates();

  // Gerando registros DTL
  DmDados.tdtl.Close;
  DmDados.tdtl.Open;

  // Gerando parcelas de convenio
  if not DmDados.trfi.IsEmpty then
  begin

    DmDados.trfi.ApplyUpdates();
  end;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := 'update orc set ccxchave=' + FPrinciGou.vpCcxChave + ' where ((ccxchave=0) or (ccxchave=null)) and orcchave=' +
    vpOrcChave;
  DmDados.Consulta.ExecSQL;

  // pagamentos em dinheiro
  if vpDinheiro > 0 then
  begin
    DmDados.tdtl.Append;
    DmDados.tdtlmdacodigo.AsInteger := 1;
    DmDados.tdtldtlvalor.AsFloat := vpDinheiro;
    DmDados.tdtlccxchave.AsString := FPrinciGou.vpCcxChave;
    DmDados.tdtldtlregistro.AsString := datetimetostr(now());
    DmDados.tdtl.Post;
  end;

  // pagamentos em pix
  if vpPIX > 0 then
  begin
    DmDados.tdtl.Append;
    DmDados.tdtlmdacodigo.AsInteger := 6;
    DmDados.tdtldtlvalor.AsFloat := vpPIX;
    DmDados.tdtlccxchave.AsString := FPrinciGou.vpCcxChave;
    DmDados.tdtldtlregistro.AsString := datetimetostr(now());
    DmDados.tdtl.Post;
  end;

  // pagamentos em cheque
  if vpCheque > 0 then
  begin
    DmDados.tdtl.Append;
    DmDados.tdtlmdacodigo.AsInteger := 3;
    DmDados.tdtldtlvalor.AsFloat := vpCheque;
    DmDados.tdtlccxchave.AsString := FPrinciGou.vpCcxChave;
    DmDados.tdtldtlregistro.AsString := datetimetostr(now());
    DmDados.tdtl.Post;
  end;

  // pagamentos em cartão crédito

  if vpCardCredito > 0 then
  begin
    DmDados.tdtl.Append;
    DmDados.tdtlmdacodigo.AsInteger := 4;
    DmDados.tdtldtlvalor.AsFloat := vpCardCredito;
    DmDados.tdtlccxchave.AsString := FPrinciGou.vpCcxChave;
    DmDados.tdtldtlregistro.AsString := datetimetostr(now());
    DmDados.tdtl.Post;
  end;

  // pagamentos em cartão Débito
  if vpCardDebito > 0 then
  begin
    DmDados.tdtl.Append;
    DmDados.tdtlmdacodigo.AsInteger := 5;
    DmDados.tdtldtlvalor.AsFloat := vpCardDebito;
    DmDados.tdtlccxchave.AsString := FPrinciGou.vpCcxChave;
    DmDados.tdtldtlregistro.AsString := datetimetostr(now());
    DmDados.tdtl.Post;
  end;

  // pagamentos em a Faturar
  if vpAFaturar > 0 then
  begin
    DmDados.tdtl.Append;
    DmDados.tdtlmdacodigo.AsInteger := 9;
    DmDados.tdtldtlvalor.AsFloat := vpAFaturar;
    DmDados.tdtlccxchave.AsString := FPrinciGou.vpCcxChave;
    DmDados.tdtldtlregistro.AsString := datetimetostr(now());
    DmDados.tdtl.Post;
  end;

  // pagamentos em doacao
  if vpDoacao > 0 then
  begin
    DmDados.tdtl.Append;
    DmDados.tdtlmdacodigo.AsInteger := 16;
    DmDados.tdtldtlvalor.AsFloat := vpDoacao;
    DmDados.tdtlccxchave.AsString := FPrinciGou.vpCcxChave;
    DmDados.tdtldtlregistro.AsString := datetimetostr(now());
    DmDados.tdtl.Post;
  end;

  // pagamentos em Credito
  if vpcredito > 0 then
  begin
    DmDados.tdtl.Append;
    DmDados.tdtlmdacodigo.AsInteger := 8;
    DmDados.tdtldtlvalor.AsFloat := vpcredito;
    DmDados.tdtlccxchave.AsString := FPrinciGou.vpCcxChave;
    DmDados.tdtldtlregistro.AsString := datetimetostr(now());
    DmDados.tdtl.Post;
  end;


  // pagamentos em a Credito / vale

  // pagamentos em convenio
  if vpConvenio > 0 then
  begin
    DmDados.tdtl.Append;
    DmDados.tdtlmdacodigo.AsInteger := 7;
    DmDados.tdtldtlvalor.AsFloat := vpConvenio;
    DmDados.tdtlccxchave.AsString := FPrinciGou.vpCcxChave;
    DmDados.tdtldtlregistro.AsString := datetimetostr(now());
    DmDados.tdtl.Post;
    DmDados.ConsultaSQL('SELECT cfgviaassinar FROM cfgmcre LIMIT 1');
    if DmDados.Consulta.Fields[0].AsInteger = 1 then
      vpImpConvenio := true;

  end;

  if not DmDados.tdtl.IsEmpty then
    DmDados.tdtl.ApplyUpdates();

  DmDados.FechaMesa.Close;
  vpMeschave := 0;
  vpMeschaveParcial:='';




  if EdtNomeCliente.Color = clYellow then
  begin

    if vpEtdCodigo <> 0 then
    begin
      DmDados.Consulta.ExecSQL;
      DmDados.Consulta.SQL.Text := 'update orc set etdcodigo=' + vpEtdCodigo.ToString + ' where orcchave=' + vpOrcChave;
      DmDados.Consulta.ExecSQL;
    end;

    if TabItens.Tag = 0 then
      DmDados.FechaMesaParcial.Params[0].AsInteger := StrToInt(vpOrcChave)
    else
      DmDados.FechaMesaParcial.Params[0].AsInteger := DmDados.orcdlvorcchave.AsInteger;

    if (vpReceber > 0) and (((vpTotalGeral - vpRecebimentos) - vpDesconto) > vpReceber) then
      DmDados.FechaMesaParcial.Params[1].AsInteger := 1 // Tipo 1 - Parcial; 2 - Total
    else
    begin
      DmDados.FechaMesaParcial.Params[1].AsInteger := 2; // Tipo 1 - Parcela; 2 - Total
      vpFechada := true;
    end;
    DmDados.FechaMesaParcial.Params[2].AsString := EdtNomeCliente.Text;
    // Nome do cliente
    DmDados.FechaMesaParcial.Params[3].AsInteger := DmDados.cfgmcfgflacodigo.AsInteger;
    // Filial

    DmDados.FechaMesaParcial.Params[4].AsInteger := DmDados.Usuario.ClbCodigo;
    // Colaborador
    DmDados.FechaMesaParcial.Params[5].AsInteger := DmDados.Usuario.CtaCodigo;
    // Cta Caixa
    if cbDescontarTaxa.Text = 'Cobrar' then
    begin
      DmDados.FechaMesaParcial.Params[6].AsFloat := (vpReceber + vpDesconto);
    end
    else if cbDescontarTaxa.Text = 'Descontar' then
    begin
      DmDados.FechaMesaParcial.Params[6].AsFloat := (vpReceber + vpDesconto - vpTaxaParcial);
    end
    else
    begin
      DmDados.FechaMesaParcial.Params[6].AsFloat := (vpReceber + vpDesconto);
    end;
    // Vlr Principal
    DmDados.FechaMesaParcial.Params[7].AsFloat := 0; // Vlr Juros
    DmDados.FechaMesaParcial.Params[8].AsFloat := vpDesconto; // Vlr Desconto
    DmDados.FechaMesaParcial.Params[9].AsFloat := 0; // Vlr Multa
    DmDados.FechaMesaParcial.Params[10].AsFloat := vpTroco; // Vlr Troco

    DmDados.FechaMesaParcial.Params[11].AsFloat := 0;

    if edValorTaxa.Visible then
    begin
      if edValorTaxa.Text = '' then
        edValorTaxa.Text := '0,00';

      vlValor := edValorTaxa.Text;
      if Pos(',', vlValor) > 0 then
        vlValor := StringReplace(vlValor, '.', '', [rfReplaceAll, rfIgnoreCase]);

      DmDados.FechaMesaParcial.Params[12].AsInteger := cbDescontarTaxa.ItemIndex;

      DmDados.FechaMesaParcial.Params[13].AsFloat := Strtofloat(vlValor);

    end
    else
    begin
      DmDados.FechaMesaParcial.Params[12].AsInteger := 2;
      DmDados.FechaMesaParcial.Params[13].AsFloat := 0;
    end;

    DmDados.FechaMesaParcial.Params[14].AsFloat := 0;

    DmDados.FechaMesaParcial.ExecSQL;

    plProcessamento.Caption := DmDados.FechaMesaParcial.Params[16].AsString;

    vlmeschave := DmDados.FechaMesaParcial.Params[17].AsString;


    vlltechave := DmDados.FechaMesaParcial.Params[18].AsString;
    vpMeschave := StrToInt(vlmeschave);
    vpMeschaveParcial:=vpMeschave.ToString;
    vpLtechave := StrToInt(vlltechave);

    if (vlValor <> '') and (vlmeschave <> '0') and (vlmeschave <> '') and (cbDescontarTaxa.Text <> 'Sem Taxa') then
    begin

      if Strtofloat(vlValor) > 0 then
      begin

        DmDados.toetaxa.Close;
        DmDados.toetaxa.SQL.Text := 'select toecodigo from toe where toecfopsaida=' + QuotedStr('5.933');
        DmDados.toetaxa.Open;

        if DmDados.toetaxa.IsEmpty then
        begin

          DmDados.toetaxa.Close;
          DmDados.toetaxa.SQL.Text := 'insert into toe value ( @chave, ' + QuotedStr('PRETAÇÃO DE SERVIÇO') + ', ' + QuotedStr('PRETAÇÃO DE SERVIÇO')
            + ',7,  ' + QuotedStr('5.933') + ', ';
          DmDados.toetaxa.SQL.add('  5,  1,  1,  0,  1,  0,  NULL,  NULL,  ' + QuotedStr('900') + ',  ' + QuotedStr('99') + ', ' + QuotedStr('99') +
            ',  0,  ' + QuotedStr('99') + ',  0,  NULL,  NULL,  ' + QuotedStr('900') + ')');
          DmDados.toetaxa.ExecSQL;

          DmDados.toetaxa.Close;
          DmDados.toetaxa.SQL.Text := 'select toecodigo from toe where toecfopsaida=' + QuotedStr('5.933');
          DmDados.toetaxa.Open;

          vlToeCodigoServico := DmDados.toetaxa.FieldByName('toecodigo').AsInteger;
        end
        else
        begin
          vlToeCodigoServico := DmDados.toetaxa.FieldByName('toecodigo').AsInteger;
        end;

        vlValor := StringReplace(vlValor, ',', '.', [rfReplaceAll, rfIgnoreCase]);
        DmDados.Consulta.Close;

        DmDados.Consulta.Close;
        DmDados.Consulta.SQL.Text := 'select mesrefeicao from mes where meschave=' + vlmeschave;
        DmDados.Consulta.Open;

        vlmeschaveAnterior := '';
        if DmDados.Consulta.FieldByName('mesrefeicao').AsInteger = 1 then
        begin
          vlmeschaveAnterior := vlmeschave;
          vlmeschave := IntToStr(StrToInt(vlmeschave) - 1);
        end;

        vSQL := '';
        vSQL := 'INSERT INTO ' +
          '  itm (itmchave, meschave, itmitem, procodigo, cstcodigo, itmdesccomple, itmquantidade, itmvalor, itmdesconto, itmmovifisico, toecodigo,   cfocfop,   icmcodigo,   itmbicm,   itmaliqicm,   itmicm, '
          + '  itmbicms,   itmaliqicms,   itmicms,   itmapuipi,   csicodigo,   ceicodigo,   itmbipi,   itmaliqipi,   itmipi,   cspcodigo,   itmbpis,   itmaliqpis,   itmquantpis,  itmaliqpisvalor,  itmpis, csfcodigo,'
          + '  itmbcofins,   itmaliqcofins,   itmquantcofins,   itmaliqcofinsvalor,   itmcofins,   pcccodigo,   itmtotal,   unicodigo,   itmicmsvalor,   puncodigo,   procodigoori,   pronomeori,   progtin,'
          + '  itmcontendo,   cfocfopdestinacao,   unicodigobase,   itmcusto,   itmtipodesc,   itmfrete,   itmseguro,   itmoutras,   itmsped,   itmpercdesc,   itmvlribpt,   itmproservico,   itminfadprod,'
          + '  itmquanticontada,   flacodigo,   tdfcodigo,   itmtipocomissao,   itmoutroscustos,   itochave,   itmpercreducaobaseicm,   pmpchave,   itmtempoproducao,   itmtempoentrega,   itmitempedido,   itmcest,'
          + '  itmmva) VALUES ' +

          ' (@chavenova, ' + vlmeschave + ', 999, ' + DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString + ', ' + QuotedStr('500') +
          ', NULL, 1.0000, ' + vlValor + ', 0.00, ' + QuotedStr('0') + ', ' + vlToeCodigoServico.ToString + ', ' + QuotedStr('5.933') + ', ' +
          QuotedStr('00') + ',' + ' 0.00, ' + QuotedStr('0') + ', 0.00, 0.00, 0.00, 0.00, ' + QuotedStr('0') + ', ' + QuotedStr('99') +
          ', NULL, 0.00, 0.00, 0.00, ' + QuotedStr('49') + ', 0.00, 0.0000,' + ' 0.000, 0.0000, 0.00, ' + QuotedStr('49') +
          ', 0.00, 0.0000, 0.000, 0.0000, 0.00, ' + QuotedStr('3.01.01.01.01.03.00') + ', ' + vlValor + ', ' + ' 1, 0.00, ' +
          DmDados.cfgmcfgcfgmgouproatendimento.AsString + ', NULL, NULL, NULL, 1.000000, ' + QuotedStr('5.933') + QuotedStr('5.933') +
          ', 1, 0.00000, NULL, 0.00, 0.00, 0.00, 1,' + ' 0, 0.00, NULL, NULL, 0.000, 1, ' + QuotedStr('00') +
          ', 1, 0.00, 0, NULL, 0, NULL, NULL, NULL, NULL, 0.000)';

        DmDados.ExecutaSQL(vSQL);
        vSQL := '';
        vSQL := 'update mes set mestotal=mestotal+' + vlValor + ', mesvalor=mesvalor+ ' + vlValor + ' where meschave=' + vlmeschave;
        DmDados.ExecutaSQL(vSQL);

        if vlmeschaveAnterior <> '' then
        begin
          vlmeschave := vlmeschaveAnterior;
        end;

      end;
    end;

  end
  else
  begin

    if vpEtdCodigo <> 0 then
    begin
      DmDados.Consulta.ExecSQL;
      DmDados.Consulta.SQL.Text := 'update orc set etdcodigo=' + vpEtdCodigo.ToString + ' where orcchave=' + vpOrcChave;
      DmDados.Consulta.ExecSQL;
    end;

    DmDados.Consulta.ExecSQL;
    DmDados.Consulta.SQL.Text := 'delete imm.* from imm,ito where imm.itochave=ito.itochave and ito.stocodigo=88 and ito.orcchave=' + vpOrcChave;
    DmDados.Consulta.ExecSQL;

    if TabItens.Tag = 0 then
      DmDados.FechaMesa.Params[0].AsInteger := StrToInt(vpOrcChave)
    else
      DmDados.FechaMesa.Params[0].AsInteger := DmDados.orcdlvorcchave.AsInteger;

    if (vpReceber > 0) and (((vpTotalGeral - vpRecebimentos) - vpDesconto) > vpReceber) then
      DmDados.FechaMesa.Params[1].AsInteger := 1 // Tipo 1 - Parcial; 2 - Total
    else
    begin
      DmDados.FechaMesa.Params[1].AsInteger := 2; // Tipo 1 - Parcela; 2 - Total
      vpFechada := true;
    end;
    DmDados.FechaMesa.Params[2].AsString := EdtNomeCliente.Text;
    // Nome do cliente
    DmDados.FechaMesa.Params[3].AsInteger := DmDados.cfgmcfgflacodigo.AsInteger;
    // Filial

    DmDados.FechaMesa.Params[4].AsInteger := DmDados.Usuario.ClbCodigo;
    // Colaborador
    DmDados.FechaMesa.Params[5].AsInteger := DmDados.Usuario.CtaCodigo;
    // Cta Caixa
    if cbDescontarTaxa.Text = 'Cobrar' then
    begin
      DmDados.FechaMesa.Params[6].AsFloat := (vpReceber + vpDesconto);

    end
    else if cbDescontarTaxa.Text = 'Descontar' then
    begin
      DmDados.FechaMesa.Params[6].AsFloat := (vpReceber + vpDesconto - vpTaxaParcial);

    end
    else
    begin
      DmDados.FechaMesa.Params[6].AsFloat := (vpReceber + vpDesconto);
    end;

   //GerarTituloVenda(vpReceber,0);

    // Vlr Principal
    DmDados.FechaMesa.Params[7].AsFloat := 0; // Vlr Juros
    DmDados.FechaMesa.Params[8].AsFloat := vpDesconto; // Vlr Desconto
    DmDados.FechaMesa.Params[9].AsFloat := 0; // Vlr Multa
    DmDados.FechaMesa.Params[10].AsFloat := vpTroco; // Vlr Troco

    DmDados.FechaMesa.Params[11].AsFloat := 0;

    if edValorTaxa.Visible then
    begin
      if edValorTaxa.Text = '' then
        edValorTaxa.Text := '0,00';

      if (edValorTaxa.Text = '0,00') and (cbDescontarTaxa.Text <> 'Sem Taxa') then
      begin
        DmDados.Consulta.Close;
        DmDados.Consulta.SQL.Text := 'select sum(itosaldoav) taxasparciais from ito where  ito.procodigo=' +
          DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString + '  and orcchave=' + DmDados.orcorcchave.AsString;
        DmDados.Consulta.Open;

        vlValor := Currtostr(DmDados.Consulta.FieldByName('taxasparciais').AsCurrency);

      end
      else
      begin

        if (cbDescontarTaxa.Text = 'Sem Taxa') then
        BEGIN
          DmDados.Consulta.Close;
          DmDados.Consulta.SQL.Text := 'select sum(itosaldoav) taxasparciais from ito where  ito.procodigo=' +
            DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString + ' and stocodigo=2  and orcchave=' + DmDados.orcorcchave.AsString;
          DmDados.Consulta.Open;

          vlValor := Currtostr(DmDados.Consulta.FieldByName('taxasparciais').AsCurrency);

        END
        else
        begin
          DmDados.Consulta.Close;
          DmDados.Consulta.SQL.Text := 'select sum(itosaldoav) taxasparciais from ito where  ito.procodigo=' +
            DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString + '  and stocodigo=2 and   orcchave=' + DmDados.orcorcchave.AsString;
          DmDados.Consulta.Open;

          if DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString = DmDados.cfgmcfgcfgmgouproatendimento.AsString then
          begin
            vlValor := Floattostr(DmDados.Consulta.FieldByName('taxasparciais').AsCurrency);
          end
          else
          begin
            vlValor := Floattostr(Strtofloat(edValorTaxa.Text) + DmDados.Consulta.FieldByName('taxasparciais').AsCurrency);
          end;
        end;
      end;

      if Pos(',', vlValor) > 0 then
        vlValor := StringReplace(vlValor, '.', '', [rfReplaceAll, rfIgnoreCase]);

      DmDados.FechaMesa.Params[12].AsInteger := cbDescontarTaxa.ItemIndex;

      DmDados.FechaMesa.Params[13].AsFloat := Strtofloat(vlValor);

    end
    else
    begin
      DmDados.FechaMesa.Params[12].AsInteger := 2;
      DmDados.FechaMesa.Params[13].AsFloat := 0;
    end;

    if EdtNomeCliente.Color = clYellow then
      DmDados.FechaMesa.Params[14].AsFloat := 0 // tipo de fechamento
    else
      DmDados.FechaMesa.Params[14].AsFloat := 1; // tipo de fechamento

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'SHOW TABLES LIKE ' + QuotedStr('trdc');
    DmDados.Consulta.Open;

    if DmDados.Consulta.IsEmpty then
    begin
      DmDados.trdc.Close;
      DmDados.trdc.Open;
    end;

    { DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'SHOW TABLES LIKE ' + QuotedStr('trfi');
      DmDados.Consulta.Open;

      if DmDados.Consulta.IsEmpty then
      begin
      DmDados.trfi.Close;
      DmDados.trfi.Open;
      end; }

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'SHOW TABLES LIKE ' + QuotedStr('tche');
    DmDados.Consulta.Open;

    if DmDados.Consulta.IsEmpty then
    begin
      DmDados.tche.Close;
      DmDados.tche.Open;
    end;

    DmDados.FechaMesa.ExecSQL;

    plProcessamento.Caption := DmDados.FechaMesa.Params[16].AsString;

    vlmeschave := DmDados.FechaMesa.Params[17].AsString;
    vpMeschave := StrToInt(vlmeschave);
    vlltechave := DmDados.FechaMesa.Params[18].AsString;
    vpLtechave := StrToInt(vlltechave);

    if (vlValor <> '') { and (cbDescontarTaxa.Text <> 'Sem Taxa') } then
    begin
      DmDados.toetaxa.Close;
      DmDados.toetaxa.SQL.Text := 'select toecodigo from toe where toecfopsaida=' + QuotedStr('5.933');
      DmDados.toetaxa.Open;

      if (cbDescontarTaxa.Text <> 'Sem Taxa') then
      begin
        if DmDados.toetaxa.IsEmpty then
        begin

          DmDados.toetaxa.Close;
          DmDados.toetaxa.SQL.Text := 'insert into toe value ( @chave, ' + QuotedStr('PRETAÇÃO DE SERVIÇO') + ', ' + QuotedStr('PRETAÇÃO DE SERVIÇO')
            + ',7,  ' + QuotedStr('5.933') + ', ';
          DmDados.toetaxa.SQL.add('  5,  1,  1,  0,  1,  0,  NULL,  NULL,  ' + QuotedStr('900') + ',  ' + QuotedStr('99') + ', ' + QuotedStr('99') +
            ',  0,  ' + QuotedStr('99') + ',  0,  NULL,  NULL,  ' + QuotedStr('900') + ')');
          DmDados.toetaxa.ExecSQL;

          DmDados.toetaxa.Close;
          DmDados.toetaxa.SQL.Text := 'select toecodigo from toe where toecfopsaida=' + QuotedStr('5.933');
          DmDados.toetaxa.Open;

          vlToeCodigoServico := DmDados.toetaxa.FieldByName('toecodigo').AsInteger;
        end
        else
        begin
          vlToeCodigoServico := DmDados.toetaxa.FieldByName('toecodigo').AsInteger;
        end;

      end
      else
      begin
        vlToeCodigoServico := DmDados.toetaxa.FieldByName('toecodigo').AsInteger;
      end;
      if (Strtofloat(vlValor) > 0) { and (cbDescontarTaxa.Text <> 'Sem Taxa') } then
      begin

       { if EdtDesconto.Text <> '0,00' then
        begin

          vlPercentualdesconto := Strtofloat(EdtDesconto.Text) / (Strtofloat(StringReplace(EdtVlrTotal.Text, '.', '', [rfReplaceAll, rfIgnoreCase])) -
            Strtofloat(edValorTaxa.Text));
          vlValor := Floattostr(Strtofloat(vlValor) - RoundTo((Strtofloat(vlValor) * vlPercentualdesconto), -2));

        end;}

        vlValor := StringReplace(vlValor, ',', '.', [rfReplaceAll, rfIgnoreCase]);

        DmDados.Consulta.Close;
        DmDados.Consulta.SQL.Text := 'select mesrefeicao from mes where meschave=' + vlmeschave;
        DmDados.Consulta.Open;

        vlmeschaveAnterior := '';
        if DmDados.Consulta.FieldByName('mesrefeicao').AsInteger = 1 then
        begin
          vlmeschaveAnterior := vlmeschave;
          vlmeschave := IntToStr(StrToInt(vlmeschave) - 1);
        end;

        DmDados.Consulta.Close;
        vSQL := '';
        vSQL := 'INSERT INTO ' +
          '  itm(itmchave, meschave, itmitem, procodigo, cstcodigo, itmdesccomple, itmquantidade, itmvalor, itmdesconto, itmmovifisico, toecodigo,   cfocfop,   icmcodigo,   itmbicm,   itmaliqicm,   itmicm, '
          + '  itmbicms,   itmaliqicms,   itmicms,   itmapuipi,   csicodigo,   ceicodigo,   itmbipi,   itmaliqipi,   itmipi,   cspcodigo,   itmbpis,   itmaliqpis,   itmquantpis,  itmaliqpisvalor,  itmpis, csfcodigo,'
          + '  itmbcofins,   itmaliqcofins,   itmquantcofins,   itmaliqcofinsvalor,   itmcofins,   pcccodigo,   itmtotal,   unicodigo,   itmicmsvalor,   puncodigo,   procodigoori,   pronomeori,   progtin,'
          + '  itmcontendo,   cfocfopdestinacao,   unicodigobase,   itmcusto,   itmtipodesc,   itmfrete,   itmseguro,   itmoutras,   itmsped,   itmpercdesc,   itmvlribpt,   itmproservico,   itminfadprod,'
          + '  itmquanticontada,   flacodigo,   tdfcodigo,   itmtipocomissao,   itmoutroscustos,   itochave,   itmpercreducaobaseicm,   pmpchave,   itmtempoproducao,   itmtempoentrega,   itmitempedido,   itmcest,'
          + '  itmmva) VALUES ' +

          ' (@chavenova, ' + vlmeschave + ', 999, ' + DmDados.cfgmcfgcfgmgouproatendimento.AsString + ', ' + QuotedStr('500') + ', NULL, 1.0000, ' +
          vlValor + ', 0.00, ' + QuotedStr('0') + ', ' + vlToeCodigoServico.ToString + ', ' + QuotedStr('5.933') + ', ' + QuotedStr('00') + ',' +
          ' 0.00, ' + QuotedStr('0') + ', 0.00, 0.00, 0.00, 0.00, ' + QuotedStr('0') + ', ' + QuotedStr('99') + ', NULL, 0.00, 0.00, 0.00, ' +
          QuotedStr('49') + ', 0.00, 0.0000,' + ' 0.000, 0.0000, 0.00, ' + QuotedStr('49') + ', 0.00, 0.0000, 0.000, 0.0000, 0.00, ' +
          QuotedStr('3.01.01.01.01.03.00') + ', ' + vlValor + ', ' + ' 1, 0.00, ' + DmDados.cfgmcfgcfgmgouproatendimento.AsString +
          ', NULL, NULL, NULL, 1.000000, ' + QuotedStr('5.933') + ', 1, 0.00000, NULL, 0.00, 0.00, 0.00, 1,' + ' 0, 0.00, NULL, NULL, 0.000, 1, ' +
          QuotedStr('00') + ', 1, 0.00, 0, NULL, 0, NULL, NULL, NULL, NULL, 0.000)';

        DmDados.ExecutaSQL(vSQL);
        vSQL := '';

        vSQL := 'update mes set mestotal=mestotal+' + vlValor + ', mesvalor=mesvalor+ ' + vlValor + ' where  meschave=' + vlmeschave;
        DmDados.ExecutaSQL(vSQL);

        if vlmeschaveAnterior <> '' then
        begin
          vlmeschave := vlmeschaveAnterior;
        end;

      end;

    end;
  end;

  DmDados.ConsultaSQL('select cfgusaadc from cfg limit 1');

  if DmDados.Consulta.Fields[0].AsInteger = 1 then
  begin

    DmDados.trdc.Close;
    DmDados.trdc.Open;

    if vpPIX > 0 then
    begin
      DmDados.trdc.Append;
      DmDados.trdcrdcchave.AsInteger := 1;
      DmDados.trdcrdcvalor.AsCurrency := vpPIX;
      DmDados.trdcrdcnrauto.AsString := vpPIXAuto;
      DmDados.trdcrdcvalorope.AsCurrency := 0;
      DmDados.trdcrdcsituacao.AsInteger := 0;
      DmDados.trdcrdcdata.AsString := datetostr(now());
      DmDados.trdcadccodigo.AsInteger :=CodigoADC;
      DmDados.trdcrdcparcelas.AsInteger := 0;
      DmDados.trdctescodigo.AsInteger := 0;
      DmDados.trdcmdacodigo.AsInteger := 6;
      DmDados.trdcbdccodigo.AsInteger := 1;
      DmDados.trdcrdcvia1.asstring:=vpPIXVia1;
      DmDados.trdcbdccodigo.AsString:='99';
      DmDados.trdc.Post;
    end;


    if vpCardCredito > 0 then
    begin
      DmDados.trdc.Append;
      DmDados.trdcrdcchave.AsInteger := 2;
      DmDados.trdcrdcvalor.AsCurrency := vpCardCredito;
      DmDados.trdcrdcnrauto.AsString := vpCardCreditoAuto;
      DmDados.trdcrdcvalorope.AsCurrency := 0;
      DmDados.trdcrdcsituacao.AsInteger := 0;
      DmDados.trdcrdcdata.AsString := datetostr(now());
      DmDados.trdcadccodigo.AsInteger := CodigoADC;
      DmDados.trdcrdcparcelas.AsInteger := 0;
      DmDados.trdctescodigo.AsInteger := 0;
      DmDados.trdcmdacodigo.AsInteger := 4;
      DmDados.trdcbdccodigo.AsInteger := 1;
      DmDados.trdcrdcvia1.asstring:=vpCardCreditoVia1;
      DmDados.trdcbdccodigo.AsString:=vpCardCreditobdc;
      DmDados.trdc.Post;
    end;

    if vpCardDebito > 0 then
    begin
      DmDados.trdc.Append;
      DmDados.trdcrdcchave.AsInteger := 3;
      DmDados.trdcrdcvalor.AsCurrency := vpCardDebito;
      DmDados.trdcrdcnrauto.AsString := vpCardDebitoAuto;
      DmDados.trdcrdcvalorope.AsCurrency := 0;
      DmDados.trdcrdcsituacao.AsInteger := 0;
      DmDados.trdcrdcdata.AsString := datetostr(now());
      DmDados.trdcadccodigo.AsInteger := CodigoADC;
      DmDados.trdcrdcparcelas.AsInteger := 0;
      DmDados.trdctescodigo.AsInteger := 0;
      DmDados.trdcmdacodigo.AsInteger := 5;
      DmDados.trdcbdccodigo.AsInteger := 1;
      DmDados.trdcrdcvia1.asstring:=vpCardDebitoVia1;
      DmDados.trdcbdccodigo.AsString:=vpCardDebitobdc;
      DmDados.trdc.Post;
    end;

  end;

  DmDados.rdc.Open;

  DmDados.vrdc.Close;
  DmDados.vrdc.Open;

  DmDados.vrdc.First;


  while not DmDados.vrdc.Eof do
  begin

    DmDados.rdc.Append;
    DmDados.rdcrdcvalor.AsFloat := DmDados.vrdcrdcvalor.AsFloat;
    DmDados.rdcrdcnrauto.AsString := DmDados.vrdcrdcnrauto.AsString;
    DmDados.rdcrdcvalorope.AsFloat := DmDados.vrdcrdcvalorope.AsFloat;
    DmDados.rdcrdcsituacao.AsInteger := DmDados.vrdcrdcsituacao.AsInteger;
    DmDados.rdcrdcdata.Asdatetime := DmDados.vrdcrdcdata.Asdatetime;
    DmDados.rdcadccodigo.AsInteger := DmDados.vrdcadccodigo.AsInteger;
    DmDados.rdcrdcparcelas.AsInteger := DmDados.vrdcrdcparcelas.AsInteger;
    DmDados.rdctescodigo.AsInteger := DmDados.vrdctescodigo.AsInteger;
    DmDados.rdcbdccodigo.AsInteger := DmDados.vrdcbdccodigo.AsInteger;
    DmDados.rdcdtlchave.asinteger :=DmDados.vrdcmdacodigo.AsInteger;

    dmdados.trdc.Locate('rdcnrauto',DmDados.vrdcrdcnrauto.AsString,[]);
    DmDados.rdcrdccomprovante1via.asstring:= DmDados.trdcrdcvia1.asstring;
    DmDados.rdc.Post;

    DmDados.dtl.Close;
    DmDados.dtl.ParamByName('ltechave').AsString := vlltechave;
    DmDados.dtl.Open;

    if DmDados.dtl.locate('mdacodigo',DmDados.rdcdtlchave.asinteger,[]) then
    begin

      DmDados.rdc.Edit;
      DmDados.rdcdtlchave.asinteger :=DmDados.dtldtlchave.AsInteger;
      DmDados.rdc.Post;

    end;

    DmDados.dtl.edit;
    DmDados.dtlrdcnrauto.AsString := DmDados.vrdcrdcnrauto.AsString;
    DmDados.dtl.Post;

  //  GravaRegistroCartao(DmDados.dtldtlchave.AsString, DmDados.dtldtlvalor.AsFloat, DmDados.vrdcrdcnrauto.AsString);

    DmDados.ltr.Open;
    DmDados.ltr.Append;
    DmDados.ltrrdcchave.AsInteger := DmDados.rdcrdcchave.AsInteger;
    DmDados.ltrdtlchave.AsInteger := DmDados.dtldtlchave.AsInteger;
    DmDados.ltr.Post;

    DmDados.vrdc.Next;
  end;

  DmDados.numeroauto.Close;
  DmDados.numeroauto.ParamByName('ltechave').AsString := vlltechave;
  DmDados.numeroauto.Open;
  vlrdcnrchave := '';

  while not DmDados.numeroauto.Eof do
  begin
    vlrfichave := DmDados.numeroautorfichave.AsString;

    if Pos(DmDados.numeroautordcnrauto.AsString, vlrdcnrchave) = 0 then
    begin
      vlrdcnrchave := vlrdcnrchave + DmDados.numeroautordcnrauto.AsString + ',';
    end;

    DmDados.numeroauto.Next;
  end;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := '';
  DmDados.Consulta.SQL.add('set  @disable_triggers=1;');
  DmDados.Consulta.SQL.add('update mes set mesdesconto=(select sum(itmdesconto) from itm where meschave=' + vlmeschave +
    '),mesvalor=(select sum(itmtotal) from itm where meschave=' + vlmeschave + ')   ,ccxchave=' + FPrinciGou.vpCcxChave + ' where meschave=' +
    vlmeschave + ';');
  DmDados.Consulta.SQL.add('set  @disable_triggers=null;');
  DmDados.Consulta.ExecSQL;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := '';
  DmDados.Consulta.SQL.add('set  @disable_triggers=1;');
  DmDados.Consulta.SQL.add('update mes set mestotal=mesvalor-mesdesconto where meschave=' + vlmeschave + ';');
  DmDados.Consulta.SQL.add('set  @disable_triggers=null;');
  DmDados.Consulta.ExecSQL;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := 'update lte set ccxchave=' + FPrinciGou.vpCcxChave + ' where ltechave=' + vlltechave;
  DmDados.Consulta.ExecSQL;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := 'update mes set ccxchave=' + FPrinciGou.vpCcxChave + ' where meschave=' + vlmeschave;
  DmDados.Consulta.ExecSQL;

  if vlrdcnrchave <> '' then
  begin

    vlrdcnrchave := Copy(vlrdcnrchave, 1, Length(vlrdcnrchave) - 1);

    if DmDados.numeroautoadcliquidaautomatico.AsInteger = 1 then
    begin

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'update rfi set srfcodigo=2, rdcnrauto=' + QuotedStr(vlrdcnrchave) + ' where rfichave=' + vlrfichave;
      DmDados.Consulta.ExecSQL;

    end
    else
    begin

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'update rfi set rdcnrauto=' + QuotedStr(vlrdcnrchave) + ' where rfichave=' + vlrfichave;
      DmDados.Consulta.ExecSQL;

    end;

  end;


  vlmesicmchave:= vlmeschave;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := 'select mesrefeicao from mes where meschave='+vlmesicmchave;
  DmDados.Consulta.Open;

  if DmDados.Consulta.FieldByName('mesrefeicao').AsString='1' then
  begin

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'select meschave from mes where meschave='+ inttostr(strtoint(vlmesicmchave)-1);
    DmDados.Consulta.Open;

    vlmesicmchave:=DmDados.Consulta.FieldByName('meschave').AsString;

  end;



  DmDados.itm.Close;
  DmDados.itm.ParamByName('meschave').AsString := vlmesicmchave;
  DmDados.itm.Open;

  vlitmitem := 1;

  DmDados.imc.Open;
  while not DmDados.itm.Eof do
  begin

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'select orcchave from mor where meschave=' + vlmesicmchave+ ' order by morchave desc limit 1';
    DmDados.Consulta.Open;

    if not DmDados.Consulta.IsEmpty then
    begin
      DmDados.itoimc.Close;
      DmDados.itoimc.ParamByName('orcchave').AsString := DmDados.Consulta.FieldByName('orcchave').AsString;
      DmDados.itoimc.Open;

    end
    else
    begin
      DmDados.itoimc.Close;
      DmDados.itoimc.ParamByName('orcchave').AsString := vpOrcChave;
      DmDados.itoimc.Open;
    end;

    if DmDados.itoimc.Locate('itochave', DmDados.itmitochave.AsInteger, []) then
    begin
      if DmDados.itoimcclbpedido.AsString <> '' then
      begin
        DmDados.imc.Append;
        DmDados.imcclbcodigo.AsInteger := DmDados.itoimcclbpedido.AsInteger;
        DmDados.imcitmchave.AsInteger := DmDados.itmitmchave.AsInteger;
        DmDados.imcimcpercentual.AsInteger := 0;
        DmDados.imcflacodigo.AsInteger := DmDados.itmflacodigo.AsInteger;
        DmDados.imc.Post;
      end;
    end;

    DmDados.itm.edit;
    DmDados.itm.FieldByName('itmitem').AsInteger := vlitmitem;
    DmDados.itm.Post;

    DmDados.itm.Next;
    vlitmitem := vlitmitem + 1;
  end;




  DmDados.itm.Close;
  DmDados.itm.ParamByName('meschave').AsString := vlmeschave;
  DmDados.itm.Open;

{  vlitmitem := 1;

  DmDados.imc.Open;
  while not DmDados.itm.Eof do
  begin

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'select orcchave from mor where meschave=' + vlmeschave+ ' order by morchave desc limit 1';
    DmDados.Consulta.Open;

    if not DmDados.Consulta.IsEmpty then
    begin
      DmDados.itoimc.Close;
      DmDados.itoimc.ParamByName('orcchave').AsString := DmDados.Consulta.FieldByName('orcchave').AsString;
      DmDados.itoimc.Open;

    end
    else
    begin
      DmDados.itoimc.Close;
      DmDados.itoimc.ParamByName('orcchave').AsString := vpOrcChave;
      DmDados.itoimc.Open;
    end;

    if DmDados.itoimc.Locate('itochave', DmDados.itmitochave.AsInteger, []) then
    begin
      if DmDados.itoimcclbpedido.AsString <> '' then
      begin
        DmDados.imc.Append;
        DmDados.imcclbcodigo.AsInteger := DmDados.itoimcclbpedido.AsInteger;
        DmDados.imcitmchave.AsInteger := DmDados.itmitmchave.AsInteger;
        DmDados.imcimcpercentual.AsInteger := 0;
        DmDados.imcflacodigo.AsInteger := DmDados.itmflacodigo.AsInteger;
        DmDados.imc.Post;
      end;
    end;

    DmDados.itm.edit;
    DmDados.itm.FieldByName('itmitem').AsInteger := vlitmitem;
    DmDados.itm.Post;

    DmDados.itm.Next;
    vlitmitem := vlitmitem + 1;
  end;

  }




  if vpOrcChave = '' then
    vpOrcChave := DmDados.orcorcchave.AsString;

  if (vpOrcChave = '') and (vpOrcChaveDelivery <> '') then
    vpOrcChave := vpOrcChaveDelivery;

  if vpAFaturar > 0 then
  begin
    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'select meschave from mor where orcchave=' + vpOrcChave+ ' order by morchave desc limit 1';
    DmDados.Consulta.Open;

    vlmeschave := DmDados.Consulta.FieldByName('meschave').AsString;

    if vlmeschave <> '' then
    begin
      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'update mes set tdfcodigo=' + QuotedStr('AF') + ' where meschave=' + vlmeschave;
      DmDados.Consulta.ExecSQL;

    end;
  end;

  if EdtNomeCliente.Color = clYellow then
  begin

    if DmDados.FechaMesaParcial.Fields[0].AsInteger = 0 then
    begin
      if DmDados.FechaMesaParcial.Fields[2].AsInteger > 0 then
      begin

        if vpMeschave <> 0 then
        begin
          AjustuarTributacao;

        end;

        EmiteDocumento(DmDados.FechaMesaParcial.Fields[2].AsInteger);

      end
      else if DmDados.FechaMesaParcial.Fields[3].AsInteger > 0 then
      begin
        if MessageDlg('Deseja imprimir recibo ?', mtConfirmation, [mbYes, mbNo], 0, mbNo) = mrYes then
          EmiteRecibo(DmDados.FechaMesaParcial.Fields[3].AsInteger);
      end
      else
        ShowMessage(DmDados.FechaMesaParcial.Fields[1].AsString);

      if TabItens.Tag = 0 then
      begin
        DmDados.titem.Close;
        Close;
      end
      else
      begin

        if vpOrcChaveDelivery <> '' then
          DmDados.ExecutaSQL('update orc set stocodigo=2 where stocodigo=5 and orcchave=' + vpOrcChaveDelivery);

        if vpOrcChaveDelivery <> '' then
          DmDados.ExecutaSQL('update ito set stocodigo=2 where stocodigo=5 and orcchave=' + vpOrcChaveDelivery);

        LimpaRecebimento;

        vpOrcChaveDelivery := '';
        // Limpando Edits;
        EdtDesconto.Clear;
        EdtVlrReceber.Clear;
        EdtDinherio.Clear;
        EdtPIX.Clear;
        EdtConvenio.Clear;
        EdtCardDebito.Clear;
        EdtCardCredito.Clear;
        edtAFaturar.Clear;

        EdtCheque.Clear;
        EdtNomeCliente.Clear;
        EdtVlrPago.Clear;

        DmDados.orcdlv.Refresh;
        IniciaRecebimento;
      end;
    end
    else
    begin
      vpFechada := False;
      ShowMessage(DmDados.FechaMesaParcial.Fields[1].AsString);
    end;

  end
  else
  begin

    dmdados.oltmlt.close;
    dmdados.oltmlt.parambyname('orcchave').asstring:=vpOrcChave;
    dmdados.oltmlt.open;

    while not dmdados.oltmlt.eof do
    begin

      dmdados.mfimlt.close;
      dmdados.mfimlt.sql.text:='SELECT mfi.mfichave, lte.ltechave, rfm.meschave FROM rfm ';
      dmdados.mfimlt.sql.add('INNER JOIN rfi ON rfm.rfichave = rfi.rfichave ');
      dmdados.mfimlt.sql.add('INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
      dmdados.mfimlt.sql.add('INNER JOIN mlt ON mfi.mfichave = mlt.mfichave ');
      dmdados.mfimlt.sql.add('INNER JOIN lte ON mlt.ltechave = lte.ltechave ');
      dmdados.mfimlt.sql.add('WHERE rfm.meschave='+vlmeschave);
      dmdados.mfimlt.sql.add('AND lte.tfdcodigo=32 AND tmfcodigo=21 ');
      dmdados.mfimlt.open;

      dmdados.ltemlt.close;
      dmdados.ltemlt.parambyname('ltechave').asstring:=dmdados.oltmlt.fieldbyname('ltechave').asstring;
      dmdados.ltemlt.parambyname('mfichave').asstring:=dmdados.mfimlt.fieldbyname('mfichave').asstring;
      dmdados.ltemlt.open;

      if dmdados.ltemlt.isempty then
      begin
        dmdados.ltemlt.append;
        dmdados.ltemlt.fieldbyname('flacodigo').asinteger:=1;
        dmdados.ltemlt.fieldbyname('ltechave').asstring:=dmdados.oltmlt.fieldbyname('ltechave').asstring;
        dmdados.ltemlt.fieldbyname('mfichave').asstring:=dmdados.mfimlt.fieldbyname('mfichave').asstring;
        dmdados.ltemlt.post;
      end;

      dmdados.lteclt.close;
      dmdados.lteclt.sql.text:=' SELECT ccochave, rdcnrauto, mdaidentificacao FROM dtl, mda, clt  ';
      dmdados.lteclt.sql.add('WHERE dtl.mdacodigo=mda.mdacodigo and dtl.ltechave=clt.ltechave AND dtl.mdacodigo IN (4,5,6) ');
      dmdados.lteclt.sql.add('and dtl.ltechave='+dmdados.oltmlt.fieldbyname('ltechave').asstring);
      dmdados.lteclt.open;

      while not dmdados.lteclt.eof do
      begin

        dmdados.ccodtl.close;
        dmdados.ccodtl.sql.text:='select ccochave, ccohistorico from cco where ccochave='+
                                  dmdados.lteclt.fieldbyname('ccochave').asstring;
        dmdados.ccodtl.open;
        dmdados.ccodtl.edit;
        dmdados.ccodtl.fieldbyname('ccohistorico').asstring:='Venda '+
                                                             dmdados.lteclt.fieldbyname('mdaidentificacao').asstring+ ' Nr. '+
                                                             dmdados.mfimlt.FieldByName('meschave').AsString+
                                                             ' Aut.Nr.: '+dmdados.lteclt.fieldbyname('rdcnrauto').asstring;
        dmdados.ccodtl.Post;

        dmdados.lteclt.next;
      end;

      dmdados.oltmlt.Next;
    end;

    if vpOrcChave <> '' then
    begin
      DmDados.ExecutaSQL('delete from ito where itoquantidade=0 and orcchave=' + vpOrcChave);
    end;

    if DmDados.FechaMesa.Fields[0].AsInteger = 0 then
    begin
      if DmDados.FechaMesa.Fields[2].AsInteger > 0 then
      begin

        if vpMeschave <> 0 then
        begin
          AjustuarTributacao;

        end;

        if dmdados.trmstonetrmintegrapagarme.AsInteger=1 then
        begin
          EncerraRecebimentoStone;
        end;

        EmiteDocumento(DmDados.FechaMesa.Fields[2].AsInteger);

        if vpOrcChave <> '' then
          DmDados.ExecutaSQL('delete from unm where orcchave=' + vpOrcChave);

      end
      else if DmDados.FechaMesa.Fields[3].AsInteger > 0 then
      begin
        if MessageDlg('Deseja imprimir recibo ?', mtConfirmation, [mbYes, mbNo], 0, mbNo) = mrYes then
          EmiteRecibo(DmDados.FechaMesa.Fields[3].AsInteger);
      end
      else
        ShowMessage(DmDados.FechaMesa.Fields[1].AsString);

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select orcchaveorigem from tro where orcchavedestino=' + vpOrcChave;
      DmDados.Consulta.Open;

      vlOrcchaveRemover := DmDados.Consulta.FieldByName('orcchaveorigem').AsString;

      if vlOrcchaveRemover <> '' then
      begin
        DmDados.Consulta.Close;
        DmDados.Consulta.SQL.Text := 'delete from tro where orcchaveorigem=' + vlOrcchaveRemover;
        DmDados.Consulta.ExecSQL;
      end;

      if TabItens.Tag = 0 then
      begin
        DmDados.titem.Close;

        Close;
      end
      else
      begin

        if vpOrcChaveDelivery <> '' then
          DmDados.ExecutaSQL('update orc set stocodigo=2 where stocodigo=5 and orcchave=' + vpOrcChaveDelivery);

        if vpOrcChaveDelivery <> '' then
          DmDados.ExecutaSQL('update ito set stocodigo=2 where stocodigo=5 and orcchave=' + vpOrcChaveDelivery);

        LimpaRecebimento;

        vpOrcChaveDelivery := '';
        // Limpando Edits;
        EdtDesconto.Clear;
        EdtVlrReceber.Clear;
        EdtDinherio.Clear;
        EdtPIX.Clear;
        EdtConvenio.Clear;
        EdtCardDebito.Clear;
        EdtCardCredito.Clear;
        edtAFaturar.Clear;

        EdtCheque.Clear;
        EdtNomeCliente.Clear;
        EdtVlrPago.Clear;

        DmDados.orcdlv.Refresh;
        EdtDesconto.text:=FormatFloat('##0.0', vpDesconto);

        IniciaRecebimento;

      end;

    end
    else
    begin
      vpFechada := False;
      ShowMessage(DmDados.FechaMesa.Fields[1].AsString);
    end;

  end;

  DmDados.itodes.DisableControls;
  DmDados.itodes.First;
  while not DmDados.itodes.Eof do
  begin

    DmDados.imp.Close;
    DmDados.imp.SQL.Text := 'select impchave, itmchave,  TIMEDIFF(impfinal, impinicio) tempoproducao from imp where itochave=' +
      DmDados.itoitochave.AsString;
    DmDados.imp.Open;

    if not DmDados.imp.IsEmpty then
    begin

      DmDados.imp.First;
      while not DmDados.imp.Eof do
      begin

        DmDados.itmproducao.Close;
        DmDados.itmproducao.SQL.Text := 'select itmchave, itmtempoproducao from itm where itochave=' + DmDados.itodes.fieldbyname('itochave').AsString;
        DmDados.itmproducao.Open;

        DmDados.imp.edit;
        DmDados.imp.FieldByName('itmchave').AsInteger := DmDados.itmproducao.FieldByName('itmchave').AsInteger;
        DmDados.imp.Post;
        DmDados.imp.Next;
      end;
    end;

    DmDados.itodes.Next;
  end;

  DmDados.itodes.EnableControls;

  DmDados.trorec.DisableControls;
  DmDados.trorec.Close;
  DmDados.trorec.Params[0].AsInteger := DmDados.orcorcchave.AsInteger;
  DmDados.trorec.Open;

  if not DmDados.trorec.IsEmpty then
  begin

    if DmDados.trorecorcchaveorigem.AsInteger = 0 then
    begin
      DmDados.itorec.Close;
      DmDados.itorec.ParamByName('orcchave').AsInteger := DmDados.orcorcchave.AsInteger;
      DmDados.itorec.Open;
    end
    else
    begin

      DmDados.itorec.Close;
      DmDados.itorec.ParamByName('orcchave').AsInteger := DmDados.orcorcchave.AsInteger;
      DmDados.itorec.Open;
    end;
  end;

  if DmDados.itorec.Active then
  begin

    DmDados.itorec.First;
    while not DmDados.itorec.Eof do
    begin

      DmDados.imp.Close;
      DmDados.imp.SQL.Text := 'select impchave, itmchave,  TIMEDIFF(impfinal, impinicio) tempoproducao from imp where itochave=' +
        DmDados.itorecitochave.AsString;
      DmDados.imp.Open;

      if not DmDados.imp.IsEmpty then
      begin

        DmDados.imp.First;
        while not DmDados.imp.Eof do
        begin

          DmDados.itmproducao.Close;
          DmDados.itmproducao.SQL.Text := 'select itmchave, itmtempoproducao from itm where itochave=' + DmDados.itorecitochave.AsString;
          DmDados.itmproducao.Open;

          DmDados.imp.edit;
          DmDados.imp.FieldByName('itmchave').AsInteger := DmDados.itmproducao.FieldByName('itmchave').AsInteger;
          DmDados.imp.Post;
          DmDados.imp.Next;
        end;
      end;

      DmDados.itorec.Next;
    end;

  end;
  RegistraClienteIdentificado;
  DmDados.trorec.EnableControls;
end;





procedure TFrmFinalizaMesa.RegistraClienteIdentificado;
var
  vlTentativas:integer;
begin


  showmessage('Meschave: '+ self.vpMeschave.ToString);

  showmessage('CPF: '+FrmFinalizaMesa.CPFnaNota);


  if FrmFinalizaMesa.CPFnaNota<>'' then
  begin
    vlTentativas := 0;
    while True do
    begin


      try

        dmdados.idc.Close;
        dmdados.idc.Connection:= dmdados.Conexao;
        dmdados.idc.ParamByName('idcdoc').AsString:=FrmFinalizaMesa.CPFnaNota;
        dmdados.idc.Open;


        if dmdados.idc.IsEmpty then
         dmdados.idc.append
        else
         dmdados.idc.Edit;

        dmdados.idcidcnome.AsString:='CONSUMIDOR IDENTIFICADO';
        dmdados.idcidcdoc.AsString:=FrmFinalizaMesa.CPFnaNota;
        dmdados.idc.Post;

        dmdados.mic.Close;
        dmdados.mic.Connection:=dmdados.Conexao;
        dmdados.mic.ParamByName('idccodigo').AsInteger:=dmdados.idcidccodigo.AsInteger;
        dmdados.mic.ParamByName('meschave').AsString:= self.vpMeschave.ToString;
        dmdados.mic.Open;

        if dmdados.mic.IsEmpty then
          dmdados.mic.Append
        else
          dmdados.mic.Edit;

        dmdados.micidccodigo.AsInteger:=dmdados.idcidccodigo.AsInteger;
        dmdados.micmeschave.AsString:=self.vpMeschave.ToString;
        dmdados.mic.Post;
        break
      except
        vlTentativas := vlTentativas+1;
        if vlTentativas>5 then
          break
        else
          Sleep(1000);

      end;
    end;
  end;
  TdfCodigo:=DocumentoFiscal;


end;




function TFrmFinalizaMesa.AjustaTit(vtitcodigo: string; vetdcodigo: Integer; vtitnumero: String; vtitvalor: Double; vtitemissao: TDate;
vtitvctoinicial: TDate; vtfdcodigo: Integer; vtficodigo: Integer; vtithistorico: String; vtitvalorparcela: Double; vtitparcelas: Integer;
vtitmoradia: Double; vtitvalomulta: Double; vtitpercmesmora: Double; vtitvalodesc: Double; vtitpercmulta: Double; vtitpercmesmulta: Double;
vbcocodigo: String; vcarcodigo: Integer; vtitdiasmulta: Integer; vtitdiasdesc: Integer): Integer;

begin

  DmDados.tit.Close;
  DmDados.tit.Connection := DmDados.Conexao;
  DmDados.tit.SQL.Text := 'SELECT tit.titcodigo, tit.etdcodigo, tit.titvalor, tit.titnumero, tit.titemissao, ';
  DmDados.tit.SQL.add('tit.titvalorparcela, tit.titparcelas, tit.titvctoinicial, tit.tfdcodigo, tit.srfcodigo,');
  DmDados.tit.SQL.add('tit.tficodigo, tit.tithora, tit.clbcodigo, tit.tithistorico, tit.flacodigo, tit.bcocodigo,');
  DmDados.tit.SQL.add('tit.carcodigo, tit.titprevisao, tit.moecodigo, tit.titmoradia, tit.titdiasmulta, tit.titvalomulta,');
  DmDados.tit.SQL.add('tit.titpercmesmora, tit.titvalodesc, tit.titdiasdesc, tit.titpercmulta ');
  DmDados.tit.SQL.add('FROM tit ');

  if (vtitcodigo <> '') and (vtitcodigo <> '0') then
  begin
    DmDados.tit.SQL.add('WHERE tit.titcodigo=' + vtitcodigo);
    DmDados.tit.Open;
    DmDados.tit.edit;
  end
  else
  begin
    DmDados.tit.SQL.add('limit 1');
    DmDados.tit.Open;
    DmDados.tit.Append;
  end;

  DmDados.tittithora.AsFloat := now();
  DmDados.titclbcodigo.AsInteger := FPrinciGou.AcessoRec.Usuario;
  DmDados.tittitprevisao.AsInteger := 0;

  DmDados.titflacodigo.AsInteger := FPrinciGou.AcessoRec.Filial;

  DmDados.titmoecodigo.AsInteger := 1;
  DmDados.titsrfcodigo.AsInteger := 0;
  DmDados.titetdcodigo.AsInteger := vetdcodigo;
  DmDados.tittitnumero.AsString := vtitnumero;
  DmDados.tittitvalor.AsFloat := vtitvalor;
  DmDados.tittitemissao.AsFloat := vtitemissao;
  DmDados.tittitvctoinicial.AsFloat := vtitvctoinicial;
  DmDados.tittfdcodigo.AsInteger := vtfdcodigo;
  DmDados.tittficodigo.AsInteger := vtficodigo;
  DmDados.tittithistorico.AsString := vtithistorico;
  DmDados.tittitvalorparcela.AsFloat := vtitvalorparcela;
  DmDados.tittitparcelas.AsInteger := vtitparcelas;
  DmDados.tittitmoradia.AsFloat := vtitmoradia;
  DmDados.tittitvalomulta.AsFloat := vtitvalomulta;
  DmDados.tittitpercmesmora.AsFloat := vtitpercmesmora;
  DmDados.tittitvalodesc.AsFloat := vtitvalodesc;
  DmDados.tittitpercmulta.AsFloat := vtitpercmulta;
  DmDados.titbcocodigo.AsString := vbcocodigo;
  DmDados.titcarcodigo.AsInteger := vcarcodigo;
  DmDados.tittitdiasmulta.AsInteger := vtitdiasmulta;
  DmDados.tittitdiasdesc.AsInteger := vtitdiasdesc;
  DmDados.tit.Post;

  result := DmDados.tittitcodigo.AsInteger;

end;

function TFrmFinalizaMesa.AjustaRfi(vtitcodigo: string; vVencimento: TDate; vParcela: Integer; vvalor: Double; vrdauto: string = ''): Integer;
begin
  if vpMeschave <> 0 then
  begin
    DmDados.tit.Close;
    DmDados.tit.SQL.Text := 'SELECT tit.titcodigo, tit.etdcodigo, tit.titvalor, tit.titnumero, tit.titemissao, ';
    DmDados.tit.SQL.add('tit.titvalorparcela, tit.titparcelas, tit.titvctoinicial, tit.tfdcodigo, tit.srfcodigo,');
    DmDados.tit.SQL.add('tit.tficodigo, tit.tithora, tit.clbcodigo, tit.tithistorico, tit.flacodigo, tit.bcocodigo,');
    DmDados.tit.SQL.add('tit.carcodigo, tit.titprevisao, tit.moecodigo, tit.titmoradia, tit.titdiasmulta, tit.titvalomulta,');
    DmDados.tit.SQL.add('tit.titpercmesmora, tit.titvalodesc, tit.titdiasdesc, tit.titpercmulta ');
    DmDados.tit.SQL.add('FROM tit ');
    DmDados.tit.SQL.add('WHERE tit.titcodigo=' + vtitcodigo);
    DmDados.tit.Open;

    if not DmDados.tit.IsEmpty then
    begin

      DmDados.rfi.Open;
      DmDados.rfi.Append;
      DmDados.rfititcodigo.AsString := vtitcodigo;
      DmDados.rfietdcodigo.AsInteger := DmDados.titetdcodigo.AsInteger;
      DmDados.rfitfdcodigo.AsInteger := DmDados.tittfdcodigo.AsInteger;
      DmDados.rfiflacodigo.AsInteger := DmDados.titflacodigo.AsInteger;
      DmDados.rfitficodigo.AsInteger := DmDados.tittficodigo.AsInteger;
      DmDados.rfibcocodigo.AsString := DmDados.titbcocodigo.AsString;
      DmDados.rficarcodigo.AsInteger := DmDados.titcarcodigo.AsInteger;
      DmDados.rfirfiemissao.AsFloat := DmDados.tittitemissao.AsFloat;
      DmDados.rfirfivencimento.AsFloat := vVencimento;
      DmDados.rfirfinumero.AsString := DmDados.tittitnumero.AsString + '-' + IntToStr(vParcela);
      DmDados.rfirfivalor.AsFloat := vvalor;
      DmDados.rfirfihistorico.AsString := DmDados.tittithistorico.AsString;
      DmDados.rfisrfcodigo.AsInteger := DmDados.titsrfcodigo.AsInteger;
      DmDados.rfifrrcodigo.AsInteger := 1;
      DmDados.rfirfimoradia.AsFloat := 0;
      DmDados.rfirfipercmesmora.AsFloat := 0;
      DmDados.rfirfirepetir.AsInteger := 0;
      DmDados.rfirfiprevisao.AsInteger := 0;
      DmDados.rfirdcnrauto.AsString := vrdauto;
      DmDados.rfirfivalorparcela.AsFloat := vvalor;
      DmDados.rfimoecodigo.AsInteger := 1;
      DmDados.rfi.Post;

      DmDados.rfm.Open;
      DmDados.rfm.Append;
      DmDados.rfmrfichave.AsInteger := DmDados.rfirfichave.AsInteger;
      DmDados.rfmflacodigo.AsInteger := FPrinciGou.AcessoRec.Filial;
      DmDados.rfmmeschave.AsInteger := vpMeschave;
      DmDados.rfm.Post;

      // registro
      DmDados.mfi.Open;
      DmDados.mfi.Append;
      DmDados.mfirfichave.AsInteger := DmDados.rfirfichave.AsInteger;
      DmDados.mfitmfcodigo.AsInteger := 2;
      DmDados.mfimoecodigo.AsInteger := 1;
      DmDados.mfimfivalor.AsFloat := DmDados.rfirfivalor.AsFloat;
      DmDados.mfimfidata.AsFloat := date;
      DmDados.mfimfihistorico.AsString := '';
      DmDados.mfimfivalorori.AsFloat := DmDados.rfirfivalor.AsFloat;
      DmDados.mfimfiparcela.AsInteger := 0;
      DmDados.mfi.Post;

      if (DmDados.cfgmcfgcfgusaadc.AsInteger = 1) then
      begin

        // registro
        DmDados.mfi.Open;
        DmDados.mfi.Append;
        DmDados.mfirfichave.AsInteger := DmDados.rfirfichave.AsInteger;
        DmDados.mfitmfcodigo.AsInteger := 21;
        DmDados.mfimoecodigo.AsInteger := 1;
        DmDados.mfimfivalor.AsFloat := DmDados.rfirfivalor.AsFloat;
        DmDados.mfimfidata.AsFloat := date;
        DmDados.mfimfihistorico.AsString := '';
        DmDados.mfimfivalorori.AsFloat := DmDados.rfirfivalor.AsFloat;
        DmDados.mfimfiparcela.AsInteger := 0;
        DmDados.mfi.Post;

        DmDados.mlt.Open;
        DmDados.mlt.Append;
        DmDados.mltmfichave.AsInteger := DmDados.mfimfichave.AsInteger;
        DmDados.mltltechave.AsInteger := vpLtechave;
        DmDados.mltflacodigo.AsInteger := FPrinciGou.AcessoRec.Filial;
        DmDados.mlt.Post;

        DmDados.Consulta.Close;
        DmDados.Consulta.SQL.Text := 'update tit set srfcodigo=2 where titcodigo=' + vtitcodigo;
        DmDados.Consulta.ExecSQL;

        DmDados.Consulta.Close;
        DmDados.Consulta.SQL.Text := 'update rfi set srfcodigo=2 where rfichave=' + DmDados.rfirfichave.AsString;
        DmDados.Consulta.ExecSQL;

      end;

      result := DmDados.rfirfichave.AsInteger;
    end;

  end;
end;



procedure TFrmFinalizaMesa.GravaRegistroCartao(vdtlchave: String; vTotal: Double; vrdcnrauto: string = '');
var
  vletdcodigo: Integer;
  vlValorCartao: Double;
  vlRdcData: TDate;
  vlQtdParcelas: Integer;
  vlTitCodigo: Integer;
  vlNrAuto: string;
  vlMdaCodigo: Integer;

  I: Integer;
  vlCarCodigo: string;
  vlBcoCodigo: string;

  vlVlrParcela: Double;
  vlTotParcelas: Double;

  vCarDiasMulta: string;
  vCarPercMulta: string;
  vCarPercMorames: string;
  vCarDiasdesc: string;
  vCarPercdesc: string;
begin
  vlValorCartao := 0;
  vlVlrParcela := 0;
  vlTotParcelas := 0;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := 'SELECT cfgportadorpadrao FROM cfgmcre';
  DmDados.Consulta.Open;

  vlCarCodigo := DmDados.Consulta.Fields[0].AsString;

  DmDados.Consulta.Close;
  DmDados.Consulta.SQL.Text := 'SELECT bcocodigo, cardiasmulta, carpercmulta, carpercmorames, cardiasdesc, carpercdesc FROM car ';
  DmDados.Consulta.SQL.add('WHERE carcodigo = ' + vlCarCodigo);
  DmDados.Consulta.Open;

  vlBcoCodigo := DmDados.Consulta.Fields[0].AsString;
  vCarDiasMulta := DmDados.Consulta.Fields[1].AsString;
  vCarPercMulta := DmDados.Consulta.Fields[2].AsString;
  vCarPercMorames := DmDados.Consulta.Fields[3].AsString;
  vCarDiasdesc := DmDados.Consulta.Fields[4].AsString;
  vCarPercdesc := DmDados.Consulta.Fields[5].AsString;

  DmDados.ConsultaSQL('select cfgusaadc from cfg limit 1');

  if (DmDados.Consulta.Fields[0].AsInteger IN [1, 2]) then
  begin

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'SELECT adc.etdcodigo, rdc.rdcdata, rdc.rdcnrauto, rdc.rdcvalor, rdc.rdcparcelas, dtl.mdacodigo FROM ltr ';
    DmDados.Consulta.SQL.add('INNER JOIN rdc ON ltr.rdcchave = rdc.rdcchave ');
    DmDados.Consulta.SQL.add('INNER JOIN adc ON rdc.adccodigo = adc.adccodigo ');
    DmDados.Consulta.SQL.add('INNER JOIN dtl ON ltr.dtlchave = dtl.dtlchave');
    DmDados.Consulta.SQL.add('WHERE ltr.dtlchave = ' + vdtlchave);
    DmDados.Consulta.Open;

    if not DmDados.Consulta.IsEmpty then
    begin
      while not DmDados.Consulta.Eof do
      begin
        vletdcodigo := DmDados.Consulta.Fields[0].AsInteger;
        vlRdcData := DmDados.Consulta.Fields[1].AsFloat;
        vlNrAuto := DmDados.Consulta.Fields[2].AsString;
        vlValorCartao := DmDados.Consulta.Fields[3].AsFloat;
        vlQtdParcelas := DmDados.Consulta.Fields[4].AsInteger;
        vlMdaCodigo := DmDados.Consulta.Fields[5].AsInteger;
        vlTotParcelas := 0;

        vlTitCodigo := 0;

        vlTitCodigo := AjustaTit('', vletdcodigo, vlNrAuto, vlValorCartao, now(), vlRdcData, 2, 6, '', vlValorCartao, vlQtdParcelas, 0, 0, 0, 0, 0, 0,
          '000', 1, 0, 0);

        if vlTitCodigo > 0 then
          for I := 1 to vlQtdParcelas do
          begin
            vlVlrParcela := TBTruncate(vlValorCartao / vlQtdParcelas, 2);
            vlTotParcelas := vlTotParcelas + vlVlrParcela;

            if I = vlQtdParcelas then
              if vlTotParcelas <> vlValorCartao then
                vlVlrParcela := vlVlrParcela + (vlValorCartao - vlTotParcelas);

            AjustaRfi(IntToStr(vlTitCodigo), IncDay(vlRdcData, IfThen(vlMdaCodigo = 5, 1, (30 * I))), I, vlVlrParcela, vlNrAuto);
          end;

        DmDados.Consulta.Next;
      end;
    end
    else
    begin

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := ' SELECT adc.etdcodigo FROM adc ';
      DmDados.Consulta.Open;

      vletdcodigo := DmDados.Consulta.Fields[0].AsInteger;

      if trim(EdtCardDebito.Text) <> '' then
      begin
        if Strtofloat(StringReplace(EdtCardDebito.Text, '.', '', [])) <> 0 then
        begin
          vlValorCartao := Strtofloat(StringReplace(EdtCardDebito.Text, '.', '', []));
          vlVlrParcela := Strtofloat(StringReplace(EdtCardDebito.Text, '.', '', []));
          vlMdaCodigo := 5;
          vlRdcData := date + 3;

          vlNrAuto := '';
          vlQtdParcelas := 1;

          vlTitCodigo := 0;
          vlTitCodigo := AjustaTit('', vletdcodigo, vrdcnrauto, vlValorCartao, date, vlRdcData, 2, 6, '', vlValorCartao, vlQtdParcelas, 0, 0, 0, 0, 0,
            0, '000', 1, 0, 0);
          I := 1;
          AjustaRfi(IntToStr(vlTitCodigo), vlRdcData, I, vlVlrParcela, vrdcnrauto);

        end;
      end;

      if trim(EdtCardCredito.Text) <> '' then
      begin
        if Strtofloat(StringReplace(EdtCardCredito.Text, '.', '', [])) <> 0 then
        begin
          vlValorCartao := Strtofloat(StringReplace(EdtCardCredito.Text, '.', '', []));
          vlVlrParcela := Strtofloat(StringReplace(EdtCardCredito.Text, '.', '', []));
          vlMdaCodigo := 4;
          vlRdcData := date + 30;

          vlNrAuto := '';
          vlQtdParcelas := 1;

          vlTitCodigo := 0;
          vlTitCodigo := AjustaTit('', vletdcodigo, vrdcnrauto, vlValorCartao, date, vlRdcData, 2, 6, '', vlValorCartao, vlQtdParcelas, 0, 0, 0, 0, 0,
            0, '000', 1, 0, 0);

          I := 1;
          AjustaRfi(IntToStr(vlTitCodigo), vlRdcData, I, vlVlrParcela, vrdcnrauto);

        end;

      end;
    end;

  end
  else
  begin

    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := ' SELECT adc.etdcodigo FROM adc ';
    DmDados.Consulta.Open;

    vletdcodigo := DmDados.Consulta.Fields[0].AsInteger;
    vlValorCartao := vTotal;
    vlRdcData := date + 30;

    vlNrAuto := '';
    vlQtdParcelas := 1;

    vlTitCodigo := 0;
    vlTitCodigo := AjustaTit('', vletdcodigo, vlNrAuto, vlValorCartao, date, vlRdcData, 2, 6, '', vlValorCartao, vlQtdParcelas, 0, 0, 0, 0, 0, 0,
      '000', 1, 0, 0);

    if vlTitCodigo > 0 then
    begin
      DmDados.Consulta.First;
      I := 0;
      while not DmDados.Consulta.Eof do
      begin
        I := I + 1;
        AjustaRfi(IntToStr(vlTitCodigo), vlRdcData, I, vlValorCartao);
        DmDados.Consulta.Next;
      end;

      DmDados.Consulta.Close;
    end;
  end;

end;

procedure TFrmFinalizaMesa.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  vpDesconto := 0;

  // Voltando a tabela de itens ao estado original

  if (DmDados.ito.Active) and (TabItens.Tag = 0) then
  begin
    DmDados.ito.Filter := '';
    DmDados.ito.Filtered := False;
    DmDados.ito.CancelUpdates;
    DmDados.titem.Close;
  end;
  vpOrcChaveDelivery := '';
end;

procedure TFrmFinalizaMesa.FormCloseQuery(Sender: TObject; var CanClose: Boolean);
begin
  CanClose := vppodefechar;
end;

procedure TFrmFinalizaMesa.FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  try

    if Key = VK_F2 then
    begin
      if PCFechamento.ActivePage = TabRecebimento then
      begin
        EdtVlrPago.SetFocus;
      end;
    end;

    // Registrando convênio
    if Key = VK_F9 then
      if PCFechamento.ActivePage = TabRecebimento then
      begin
        LancaConvenio;
      end;

    // Registrando crédito
    if Key = VK_F3 then
      if PCFechamento.ActivePage = TabRecebimento then
      begin
        if EdtCardCredito.Visible then
        begin
          if vpRegistraCartao then
            LancaCartao(4, EdtCardCredito)
          else
          begin
            EdtCardCredito.SetFocus;
            EdtCardCredito.Text := formatfloat('###0.00', (vpFalta + vpCardCredito));
            ValidaRecCardCredito;
            EdtCardCredito.SelectAll;
          end;
        end;
      end;

    // Registrando Débito
    if Key = VK_F4 then
      if PCFechamento.ActivePage = TabRecebimento then
      begin
        if EdtCardDebito.Visible then
        begin
          if vpRegistraCartao then
            LancaCartao(5, EdtCardDebito)
          else
          begin
            EdtCardDebito.SetFocus;
            EdtCardDebito.Text := formatfloat('###0.00', (vpFalta + vpCardDebito));
            ValidaRecCardDedito;
            EdtCardDebito.SelectAll;
          end;
        end;
      end;

    // Registrando cheques
    { if Key = VK_F5 then
      if PCFechamento.ActivePage = TabRecebimento then
      LancaCheque; }

    // Registrando pagamento em dinherio
    if Key = VK_F6 then
    begin
      if PCFechamento.ActivePage = TabRecebimento then
      begin
        if EdtDinherio.Visible then
        begin
          EdtDinherio.SetFocus;
          if EdtDinherio.Text <> '' then
          begin
            plvalorinformado.Caption := 'R$ ' + formatfloat('###0.00', Strtofloat(EdtDinherio.Text));
          end;
          if cbDescontarTaxa.Visible = False then
            EdtDinherio.Text := formatfloat('###0.00', (vpFalta + vpDinheiro));
          ValidaRecDinheiro;
          EdtDinherio.SelectAll;
        end;
      end;
    end;

    if Key = VK_F8 then
    begin
      if PCFechamento.ActivePage = TabRecebimento then
      begin
        if EdtPIX.Visible then
        begin
          EdtPIX.SetFocus;
          if EdtPIX.Text <> '' then
          begin
            plvalorinformado.Caption := 'R$ ' + formatfloat('###0.00', Strtofloat(EdtPIX.Text));
          end;
          if cbDescontarTaxa.Visible = False then
            EdtPIX.Text := formatfloat('###0.00', (vpFalta + vpPIX));
          ValidaRecPIX;
          EdtPIX.SelectAll;
        end;
      end;

      // EdtVlrPago.SetFocus;
    end;

    if Key = VK_F10 then
      if PCFechamento.ActivePage = TabRecebimento then
      begin
        BuscaCliente;
        if vpEtdCodigo <> 0 then
        begin
          edtAFaturar.SetFocus;
          edtAFaturar.Text := formatfloat('###0.00', (vpFalta + vpAFaturar));
          ValidaRecAFaturar;
          edtAFaturar.SelectAll;
        end;
      end;

    if Key = VK_F11 then
      if PCFechamento.ActivePage = TabRecebimento then
      begin
        if edtDoacao.Visible then
        begin
          edtDoacao.SetFocus;
          edtDoacao.Text := formatfloat('###0.00', (vpFalta + vpDoacao));
          ValidaRecdoacao;
          edtDoacao.SelectAll;
        end;
      end;

    if Key = VK_F12 then
    begin
      if edtCredito.Visible then
      begin
        if PCFechamento.ActivePage = TabRecebimento then
        begin
          if (plDisponivel.Visible = False) or (plDisponivel.Caption = '0,00') or (plDisponivel.Caption = '') then
          begin
            if BtCarregacliente.Visible then
            begin
              BtCarregacliente.Click;
            end;
          end;

          if (plDisponivel.Caption = '0,00') or (plDisponivel.Caption = '') then
          begin
            ShowMessage('O Cliente selecionado nao possui crédito para utilização!');
            LbCliente.Caption := '';
            plDisponivel.Caption := '';
            AtualizaLimiteTela('0');

          end
          else
          begin

            if edtCredito.Visible then
            begin
              if Strtofloat(plDisponivel.Caption) <= (vpFalta + vpcredito) then
              begin
                edtCredito.SetFocus;
                edtCredito.Text := plDisponivel.Caption;
              end
              else
              begin
                edtCredito.SetFocus;
                edtCredito.Text := formatfloat('###0.00', (vpFalta + vpcredito));
              end;
              ValidaReccredito;
              edtCredito.SelectAll;
            end;
          end;
        end;

      end;

    end;

    if Key = VK_F7 then
      if PCFechamento.ActivePage = TabRecebimento then
        CalculaTroco;
  except

  end;
end;

procedure TFrmFinalizaMesa.FormKeyPress(Sender: TObject; var Key: Char);
begin
  If Key = #13 Then
  Begin
    Key := #0;
    Perform(WM_NEXTDLGCTL, 0, 0);
  End;

  if (UpperCase(Key) = 'C') and (PCFechamento.ActivePage = TabRecebimento) then
    if vpkey = False then
    begin

      if BtnTabRecConfirma.Enabled then
      begin
        BtnTabRecConfirmaClick(BtnTabRecConfirma);
      end;

    end;
end;

procedure TFrmFinalizaMesa.FormShow(Sender: TObject);
begin

  vppodefechar := true;
  FrmFinalizaMesa.Width := 1012;

 // if DmDados.cfgmcfgcfgusaafaturar.AsInteger = 1 then
 // begin
 //   plModalAFaturars.Visible := true;
 // end
 // else
 // begin
    plModalAFaturars.Visible := False;
 // end;

  if (DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsInteger <> 0) and (DmDados.cfgmcfgcfgmgouproatendimento.AsInteger <> 0) then
  begin
    if lowercase(FPrinciGou.vpTaxa) = lowercase('Não') then
    begin
      cbDescontarTaxa.Visible := False;
      edValorTaxa.Visible := False;
      cbDescontarTaxa.ItemIndex := 1;
      plsubtotalcomtaxa.Visible := False;
      self.Height := 600;
      Panel28.Height := 73;
    end
    else
    begin
      plsubtotalcomtaxa.Visible := true;
      cbDescontarTaxa.Visible := true;
      edValorTaxa.Visible := true;

      cbDescontarTaxa.ItemIndex := 0;
      self.Height := 600;
      Panel28.Height := 73;
      if self.Caption = 'Fechamento Rápido' then
      begin
        cbDescontarTaxa.ItemIndex := 1;
      end;
      CalculaTaxaParcial;
    end;
  end
  else
  begin
    plsubtotalcomtaxa.Visible := False;
    cbDescontarTaxa.Visible := False;
    edValorTaxa.Visible := False;
    cbDescontarTaxa.ItemIndex := 1;
    self.Height := 600;
    Panel28.Height := 33;
  end;

  IniciaRecebimento;

  plvalorinformado.Caption := 'R$ ' + formatfloat('###0.00', 0);
//  Application.ProcessMessages;

  if self.Caption = 'Fechamento Rápido' then
  begin
    FrmFinalizaMesa.BtnConfirmar.Click;

  end;

  if DmDados.cfgmcfgcfgcontrolalimite.AsInteger = 1 then
  begin
    pltitlimitetotal.Visible := true;
    pltitlimitedisponivel.Visible := true;
    plcontroleLimite.Visible := true;
  end
  else
  begin
    pltitlimitetotal.Visible := False;
    pltitlimitedisponivel.Visible := False;
    plcontroleLimite.Visible := False;
  end;

end;

procedure TFrmFinalizaMesa.IniciaRecebimento;
begin
  // Preparando a tabela de itens ao estado original
  DmDados.ito.Filter := ' stocodigo = 2';
  DmDados.ito.Filtered := true;

  // abrindo tabela temporaria de itens
  DmDados.titem.Close;
  DmDados.titem.Open;

  // abrindo tabela temporaria de itens
  { DmDados.trfi.Close;
    DmDados.trfi.Open; }

  // abrindo tabela temporaria de cheques
  { DmDados.tche.Close;
    DmDados.tche.Open; }

  // abrindo tabela temporaria de cartões
  DmDados.trdc.Close;
  DmDados.trdc.Open;

  // calculando recebimentos
  CalculaRecebimentos;

  PnItensRecebidos.Visible := False;
  plProcessamento.Caption := '';

  vpFechada := False;
  vpTroco := 0;

  EdtCardCredito.ReadOnly := true;
  EdtCardDebito.ReadOnly := true;

  // verifica se usa lancamento detalhado de cartões
  if DmDados.ConsultaSQL('select cfgusaadc from cfg limit 1') then
  begin
    if (DmDados.Consulta.Fields[0].AsInteger = 2)
    { or (DmDados.Consulta.Fields[0].AsInteger = 1) } then
      vpRegistraCartao := true
    else
    begin
      vpRegistraCartao := False;
      EdtCardCredito.ReadOnly := False;
      EdtCardDebito.ReadOnly := False;
    end
  end
  else
  begin
    vpRegistraCartao := False;
    EdtCardCredito.ReadOnly := False;
    EdtCardDebito.ReadOnly := False;
  end;

  if TabItens.Tag = 0 then
  begin
    SomaItens;
    if DmDados.Usuario.TipoFechamento = 'F' then // Mostra Tela de finalizador
      Receber
    else // Mostra tela de itens
      MostraTab(TabItens);
  end
  else
    MostraTab(TabPedidos);
end;


function TFrmFinalizaMesa.TemOperacaoTEF(aMeschave:String):boolean;
begin

  Result:= False;

  if ((EdtCardDebito.text<>'') and (EdtCardDebito.text<>'0,00')) or
     ((EdtCardCredito.text<>'') and (EdtCardCredito.text<>'0,00')) or
     ((EdtPIX.text<>'') and (EdtPIX.text<>'0,00')) then
  begin
      Result:=True;
      exit
  end;

end;




function TFrmFinalizaMesa.Imprime(pOrcChave: Integer): String;
type
  TImprimeOrc = function(AOwner: TComponent; Conexao: TUniConnection; Vchave: String; vTrmCodigo: String; Vusrcodigo: String;
  vBtsAtivos: String; ValorNota: Currency): String;
var

  vlImprimirOrc: TImprimeOrc;
  vlPackIpo: Cardinal;
  vlImpressoesAutorizadas: String;
begin
  if vpAFaturar <> 0 then
  begin
    vlImpressoesAutorizadas := 'O    ';
  end
  else
  begin
    vlImpressoesAutorizadas := 'ONFN ';
  end;


  if (TemOperacaoTEF(vpMeschave.ToString)) or (TemOperacaoTEF(vpMeschaveParcial))  then
    vlImpressoesAutorizadas := 'ONFN 1'
  else
     vlImpressoesAutorizadas := 'ONFN ';


  vlPackIpo := LoadPackage('modulos\mipo.bpl');

  if vlPackIpo <> 0 then
    try
      @vlImprimirOrc := GetProcAddress(vlPackIpo, PChar('imprimeorc'));

      if Assigned(vlImprimirOrc) then
        result := vlImprimirOrc(Application, DmDados.Conexao, IntToStr(pOrcChave), IntToStr(DmDados.Usuario.TrmCodigo),
          IntToStr(DmDados.Usuario.ClbCodigo), vlImpressoesAutorizadas, strtofloat(EdtVlrReceber.Text) );
    finally
      DoUnLoadPackage(Application, vlPackIpo);
    end;
end;

procedure TFrmFinalizaMesa.IncluirItem;
var
  vQtde: Extended;
  vlSomaAdicional: Double;
  vlItoChave: Integer;
  vlemaberto: Double;
  vlareceber: Double;

begin
  // selecionando itens a serem pagos

  // validar os item que esta sendo selicionado não ultrapassa o valor que ainda falta receber
  // if ((vpReceber + DmDados.itoitototalav.AsCurrency) > (vpTotalGeral - vpRecebimentos)) then

  { if ((vpTotal + DmDados.dtitem.DataSet.FieldByName('itototalav').AsCurrency) > (vpTotalGeral - vpRecebimentos)) then
    begin
    ShowMessage('Valor do(s) produto(s) selecionados é maior que o valor pendente!');
    exit;
    end; }

  DmDados.ito.DisableControls;
  vQtde := 0;
  if PnQuantidade.Tag = 1 then
    vQtde := Strtofloat(EdtQtde.Text)
  else
    vQtde := DmDados.itoitoquantidade.AsFloat;

  if not DmDados.titem.Locate('itochave', DmDados.itoitochave.AsInteger, []) then
  begin
    DmDados.titem.Append;
    DmDados.titemitochave.AsInteger := DmDados.itoitochave.AsInteger;
    DmDados.titemprocodigo.AsInteger := DmDados.itoprocodigo.AsInteger;
    DmDados.titempronome.AsString := DmDados.itopronome.AsString;
    DmDados.titemqtde.AsFloat := 0;
  end
  else
  begin
    DmDados.titem.edit;
  end;
  vlSomaAdicional := 0;

  DmDados.ItemIngredienteNormal.Close;
  DmDados.ItemIngredienteNormal.Params[0].AsInteger := DmDados.orcorcchave.AsInteger;
  // orcchave
  DmDados.ItemIngredienteNormal.Params[1].AsInteger := DmDados.itoitochave.AsInteger;
  // itochave
  DmDados.ItemIngredienteNormal.Open;
  if not DmDados.ItemIngredienteNormal.IsEmpty then
  begin
    DmDados.ItemIngredienteNormal.First;
    while not DmDados.ItemIngredienteNormal.Eof do
    begin
      if DmDados.ItemIngredienteNormalisitipo.AsInteger = 1 then
      begin
        DmDados.Consulta.Close;
        DmDados.Consulta.SQL.Text := 'select itochave from ito where orcchave=' + DmDados.orcorcchave.AsString + ' and itoitem=' +
          DmDados.ItemIngredienteNormalitoitem.AsString;
        DmDados.Consulta.Open;

        vlItoChave := DmDados.Consulta.FieldByName('itochave').AsInteger;

        DmDados.recalculaadional.Close;
        DmDados.recalculaadional.ParamByName('itochave').AsInteger := vlItoChave;
        DmDados.recalculaadional.Open;

        if DmDados.recalculaadionalpunprecoav.AsFloat > 0 then
        begin

          vlSomaAdicional := vlSomaAdicional + DmDados.recalculaadionalpunprecoav.AsFloat;
        end;
      end
      else
      begin

      end;
      DmDados.ItemIngredienteNormal.Next;
    end;
  end;

  DmDados.titemqtde.AsFloat := (DmDados.titemqtde.AsFloat + vQtde);
  DmDados.titemitototalav.AsCurrency := (DmDados.titemqtde.AsFloat * (DmDados.itoitovalorav.AsCurrency+dmdados.itoitooutras.ascurrency)) +
    (DmDados.itoitoacrescimoav.AsCurrency * vQtde);
  DmDados.titem.Post;

  // atualizando
  DmDados.ito.edit;
  DmDados.itoitoquantidade.AsFloat := (DmDados.itoitoquantidade.AsFloat - vQtde);
  DmDados.itoitototalav.AsCurrency := (DmDados.itoitoquantidade.AsFloat * (DmDados.itoitovalorav.AsCurrency + DmDados.itoitoacrescimoav.AsCurrency));

  if DmDados.itoitoquantidade.AsFloat = 0 then
    DmDados.itostocodigo.AsInteger := 5;
  DmDados.ito.Post;

  PnQuantidade.Tag := 0;
  SomaItens;
  DmDados.ito.EnableControls;
  DBGridItens.SetFocus;

end;

procedure TFrmFinalizaMesa.InformarQtde;
begin
  PnQuantidade.Left := trunc((FrmFinalizaMesa.Width - 280) / 2);
  PnQuantidade.Top := trunc((FrmFinalizaMesa.Height - 140) / 2);
  EdtQtde.Text := DmDados.itoitoquantidade.AsString;
  PCFechamento.Enabled := False;
  PnQuantidade.BringToFront;
  PnQuantidade.BringToFront;

  PnQuantidade.Visible := true;
  EdtQtde.SelectAll;
  EdtQtde.SetFocus;
end;

procedure TFrmFinalizaMesa.InformarPercentualDesconto;
begin
  PnPercentual.Left := trunc((FrmFinalizaMesa.Width - 280) / 2);
  PnPercentual.Top := trunc((FrmFinalizaMesa.Height - 140) / 2);
  EdtPercentual.Text := '';
  PCFechamento.Enabled := true;
  PnPercentual.Visible := true;
  EdtPercentual.SelectAll;
  EdtPercentual.SetFocus;
end;

procedure TFrmFinalizaMesa.AtualizaLimiteTela(vetdcodigo: string);
begin

  if not(vetdcodigo = '') and not(vetdcodigo = '0') then
  begin
    if vpEtdCodigo <> 0 then
      vetdcodigo := IntToStr(vpEtdCodigo);

    DmDados.etd.Close;
    DmDados.etd.Params[0].AsInteger := StrToInt(vetdcodigo);
    DmDados.etd.Open;
    if not DmDados.etd.IsEmpty then
    begin
      vpEtlDescontoPadrao := DmDados.etdetldescontopadrao.AsFloat;
      LbCliente.Caption := DmDados.etdetdcodigo.AsString + ' - ' + DmDados.etdetdidentificacao.AsString;
      EdtNomeCliente.Text := Copy(DmDados.etdetdidentificacao.AsString, 1, Pos(' ', DmDados.etdetdidentificacao.AsString));
      vpEtdCodigo := DmDados.etdetdcodigo.AsInteger;
      if TabItens.Tag = 0 then
        DmDados.ExecutaSQL('UPDATE orc SET etdcodigo = ' + vetdcodigo + ' WHERE orcchave = ' + vpOrcChave)
      else
        DmDados.ExecutaSQL('UPDATE orc SET etdcodigo = ' + vetdcodigo + ' WHERE orcchave = ' + DmDados.orcdlvetdcodigo.AsString);
      DmDados.ets.Close;
      DmDados.ets.Connection := DmDados.Conexao;
      DmDados.ets.Params[0].AsInteger := DmDados.etdetdcodigo.AsInteger;
      DmDados.ets.Open;
      if DmDados.etstsecodigo.AsInteger <> 0 then
      begin
        plDisponivel.Caption := '';
      end
      else
      begin
        DmDados.limite.Close;
        DmDados.limite.Connection := DmDados.Conexao;
        DmDados.limite.Params[0].AsInteger := DmDados.etdetdcodigo.AsInteger;
        DmDados.limite.Open;
        // plValorLimiteTotal.Caption := FormatFloat('##,#####0.00', dmdados.limiteetllimitetotal.AsFloat);
        DmDados.disponivel.Close;
        DmDados.disponivel.Connection := DmDados.Conexao;
        DmDados.disponivel.Params[0].AsInteger := DmDados.etdetdcodigo.AsInteger;
        DmDados.disponivel.Open;
        if DmDados.cfgmcfgcfgcontrolalimite.AsInteger = 1 then
        begin
          plDisponivel.Caption := formatfloat('##,#####0.00', DmDados.limiteetllimitetotal.AsFloat - DmDados.disponivelrfisaldocapital.AsCurrency);
        end
        else
        begin
          DmDados.creditos.Close;
          DmDados.creditos.FilterSQL := 'etdcodigo=' + vetdcodigo;
          DmDados.creditos.Open;

          if not DmDados.creditos.IsEmpty then
          begin
            if DmDados.creditosrcrsaldo.AsCurrency > 0 then
            begin
              plDisponivel.Caption := formatfloat('##,#####0.00', DmDados.creditosrcrsaldo.AsCurrency);
              plDisponivel.Color := clgreen;
            end;

          end
          else
          begin
            plDisponivel.Caption := '';
          end;

        end;
      //  Application.ProcessMessages;
      end;
    end;
  end;
end;

procedure TFrmFinalizaMesa.CalculaTaxaParcial;
var
  vlValorTaxaparcial: Currency;
  vlPercentualConta: Double;
  vlValorReceber: Currency;
  vlValorPago: Double;
  vlValorTaxaTotal: Double;
  vlrecebe: string;
  vlValorReceberOutros: Double;

begin
  vlValorTaxaparcial := 0;
  vlPercentualConta := 0;
  vpTaxaParcial := 0;
  vlValorReceber := 0;
  vlValorReceberOutros := 0;



  if not DmDados.titem.IsEmpty then
  begin

    DmDados.titem.First;

    while not DmDados.titem.Eof  do
    begin

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select itovalorav*itoquantidade as itototal from ito, pro,grp ' +
      'where ito.procodigo='+DmDados.titemprocodigo.AsString +'   and pro.grpcodigo=grp.grpcodigo and grp.grpidentificacao=' + QuotedStr('TAXAS ESPECIAIS') +
      ' and  ito.procodigo=pro.procodigo and ito.orcchave=' + vpOrcChave+' '+
      'AND ito.procodigo<>(SELECT cfgmgouproatendimento from cfgmgou ) and '+
      'ito.procodigo<>(SELECT cfgmgouproatendimentoparcial from cfgmgou )';
      DmDados.Consulta.Open;

      if not DmDados.Consulta.IsEmpty then
        vlValorReceberOutros :=vlValorReceberOutros+ DmDados.titemitototalav.AsCurrency
      else
        vlValorReceberOutros :=0;


      DmDados.titem.Next;
    end;


  end
  else
  begin


      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select sum(itovalorav*itoquantidade) itototal from ito, pro,grp ' +
      'where ito.stocodigo<>88 and pro.grpcodigo=grp.grpcodigo and grp.grpidentificacao=' + QuotedStr('TAXAS ESPECIAIS') +
      ' and  ito.procodigo=pro.procodigo and ito.orcchave=' + vpOrcChave+' '+
      'AND ito.procodigo<>(SELECT cfgmgouproatendimento from cfgmgou ) and '+
      'ito.procodigo<>(SELECT cfgmgouproatendimentoparcial from cfgmgou )';
      DmDados.Consulta.Open;

      vlValorReceberOutros :=0;

      if not DmDados.Consulta.IsEmpty then
        vlValorReceberOutros :=DmDados.Consulta.FieldByName('itototal').AsCurrency
      else
        vlValorReceberOutros :=0;

  end;





  if vlValorReceberOutros > 0 then
  begin
    Panel31.Visible := False;
    PnCliente.Visible := False;
    EdtVlrPago.Enabled := False

  end
  else
  begin

    Panel31.Visible := true;
    PnCliente.Visible := true;
    EdtVlrPago.Enabled := true;
  end;

  if EdtVlrReceber.Text <> '' then
  begin
    if Pos('.', EdtVlrReceber.Text) > 0 then
    begin
      if EdtNomeCliente.Color=clYellow then
        vlValorReceber := Strtofloat(StringReplace(EdtVlrReceber.Text, '.', '', [rfReplaceAll, rfIgnoreCase]))
      else
        vlValorReceber := Strtofloat(StringReplace(EdtVlrReceber.Text, '.', '', [rfReplaceAll, rfIgnoreCase])) - vlValorReceberOutros;

    end
    else
    begin
      vlrecebe := EdtVlrReceber.Text;
      vlValorReceber := Strtofloat(vlrecebe);
    end;
  end;
  if EdtVlrPago.Text <> '' then
  begin
   if EdtNomeCliente.Color=clYellow then
    vlValorPago := Strtofloat(StringReplace(EdtVlrPago.Text, '.', '', [rfReplaceAll, rfIgnoreCase]))
   else
    vlValorPago := Strtofloat(StringReplace(EdtVlrPago.Text, '.', '', [rfReplaceAll, rfIgnoreCase])) - vlValorReceberOutros;
  end;

  if (TabItens.Tag = 1) or (not DmDados.titem.IsEmpty) then
  begin
    if cbDescontarTaxa.Visible then
    begin

      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select orctotalav from orc where orcchave=' + vpOrcChave;
      DmDados.Consulta.Open;

      vlValorReceber := DmDados.Consulta.FieldByName('orctotalav').AsCurrency - vlValorReceberOutros;

      vlPercentualConta := vlValorPago / vlValorReceber;
      DmDados.Consulta.Close;
      DmDados.Consulta.SQL.Text := 'select itototalav from ito where orcchave=' + vpOrcChave + ' and ito.procodigo=' +
        DmDados.cfgmcfgcfgmgouproatendimento.AsString;
      DmDados.Consulta.Open;
      vlValorTaxaTotal := DmDados.Consulta.FieldByName('itototalav').AsCurrency;

      vlValorTaxaparcial := vlValorTaxaTotal * vlPercentualConta;

      vlValorTaxaparcial := (vlValorPago-vlValorReceberOutros )* (DmDados.cfgmcfgcfgmgoutaxaatendimento.AsFloat / 100);

      edValorTaxa.Text := formatfloat('#0.00', (vlValorTaxaparcial));


    end;
  end
  else
  begin

    if (EdtVlrPago.Text <> '') and (EdtVlrReceber.Text <> '') and  (EdtVlrPago.Text <> '0,00') and (EdtVlrReceber.Text <> '0,00')  then
    begin
      if cbDescontarTaxa.Visible then
      begin
        vlPercentualConta := vlValorPago / vlValorReceber;
        DmDados.Consulta.Close;
        DmDados.Consulta.SQL.Text := 'select itototalav from ito where  orcchave=' + vpOrcChave + ' and ito.procodigo=' +
          DmDados.cfgmcfgcfgmgouproatendimento.AsString;
        DmDados.Consulta.Open;
        vlValorTaxaTotal := DmDados.Consulta.FieldByName('itototalav').AsCurrency;
        vlValorTaxaparcial := vlValorTaxaTotal * vlPercentualConta;

        vlValorTaxaparcial := (vlValorPago) * (DmDados.cfgmcfgcfgmgoutaxaatendimento.AsFloat / 100);

        edValorTaxa.Text := formatfloat('#0.00', (vlValorTaxaparcial));
      end;
    end;
  end;

  if (DmDados.cfgmcfgcfgmgouproatendimentoparcial.AsString <> '') and  (DmDados.cfgmcfgcfgmgouproatendimento.AsString <> '') then
  begin
    cbDescontarTaxa.ItemIndex := 0;
  end;


  if cbDescontarTaxa.Text = 'Cobrar' then
  begin
    vpTaxaParcial := vlValorTaxaparcial;
    edValorTaxa.Text := formatfloat('#0.00', (vpTaxaParcial));
  end
  else if cbDescontarTaxa.Text = 'Descontar' then
  begin
    vpTaxaParcial := vlValorTaxaparcial;
    edValorTaxa.Text := formatfloat('#0.00', (vpTaxaParcial));
  end
  else
  begin
    vpTaxaParcial := 0;
    edValorTaxa.Text := formatfloat('#0.00', (vpTaxaParcial));
  end;

end;

procedure TFrmFinalizaMesa.GeraComprovantesTEF(vlmeschave: string);
begin
  if TemOperacaoTEF(vlmeschave) then
  begin
    dmdados.dtltef.close;
    dmdados.dtltef.Connection := dmdados.Conexao;
    dmdados.dtltef.ParamByName('meschave').AsString := vlmeschave;
    dmdados.dtltef.Open;
    if not dmdados.dtltef.IsEmpty then
    begin
      dmdados.dtltef.First;
      while not dmdados.dtltef.Eof do
      begin
        if (dmdados.dtltefmdacodigo.AsInteger = mdaCartaoDebito) or (dmdados.dtltefmdacodigo.AsInteger = mdaCartaoCredito) or (dmdados.dtltefmdacodigo.AsInteger = mdaPIX) then
        begin
          dmdados.rdctef.close;
          dmdados.rdctef.Connection := dmdados.Conexao;
          dmdados.rdctef.ParamByName('dtlchave').AsString := dmdados.dtltef.FieldByName('dtlchave').AsString;
          dmdados.rdctef.Open;
          dmdados.rct.close;
          dmdados.rct.ParamByName('rctnrauto').AsString := dmdados.rdctef.FieldByName('rdcnrauto').AsString;
          dmdados.rct.ParamByName('bdccodigo').AsString := dmdados.rdctef.FieldByName('bdccodigo').AsString;
          dmdados.rct.ParamByName('rctvalor').AsCurrency := dmdados.rdctef.FieldByName('rdcvalor').AsCurrency;
          dmdados.rct.Open;
          if (not dmdados.rdctef.IsEmpty) then
          begin
            if (not dmdados.rct.IsEmpty) then
            begin
              if not dmdados.trm.Active then
              begin
                dmdados.trm.ParamByName('trmcodigo').AsInteger := dmdados.Usuario.TrmCodigo;
                dmdados.trm.Open;
              end;
              dmdados.trm.Edit;
              dmdados.trmtrmterminalcomprovante1via.AsString := dmdados.rdctef.FieldByName('rdccomprovante1via').AsString;
              dmdados.trm.Post;
              dmdados.rct.Edit;
              dmdados.rct.FieldByName('rctcomprovante1via').AsString := dmdados.rdctef.FieldByName('rdccomprovante1via').AsString;
              dmdados.rct.Post;
              dmdados.ImprimirViaTEF;
            end;
          end;
        end;
        dmdados.dtltef.Next;
      end;
    end;
    if dmdados.dtltef.IsEmpty then
    begin
      if vpLtechave <> 0 then
      begin
        dmdados.dtltefparcial.close;
        dmdados.dtltefparcial.Connection := dmdados.Conexao;
        dmdados.dtltefparcial.ParamByName('ltechave').AsInteger := vpLtechave;
        dmdados.dtltefparcial.Open;
        if not dmdados.dtltefparcial.IsEmpty then
        begin
          dmdados.dtltefparcial.First;
          while not dmdados.dtltefparcial.Eof do
          begin
            if (dmdados.dtltefparcialmdacodigo.AsInteger = mdaCartaoDebito) or (dmdados.dtltefparcialmdacodigo.AsInteger = mdaCartaoCredito) or (dmdados.dtltefparcialmdacodigo.AsInteger = mdaPIX) then
            begin
              dmdados.rdctef.close;
              dmdados.rdctef.Connection := dmdados.Conexao;
              dmdados.rdctef.ParamByName('dtlchave').AsString := dmdados.dtltefparcial.FieldByName('dtlchave').AsString;
              dmdados.rdctef.Open;
              if not dmdados.rdctef.IsEmpty then
              begin
                if not dmdados.trm.Active then
                begin
                  dmdados.trm.ParamByName('trmcodigo').AsInteger := dmdados.Usuario.TrmCodigo;
                  dmdados.trm.Open;
                end;
                dmdados.trm.Edit;
                dmdados.trmtrmterminalcomprovante1via.AsString := dmdados.rdctef.FieldByName('rdccomprovante1via').AsString;
                dmdados.trm.Post;
                dmdados.ImprimirViaTEF;
              end;
            end;
            dmdados.dtltefparcial.Next;
          end;
        end;
      end;
    end;
  end;
end;

procedure TFrmFinalizaMesa.AjustuarTributacao;
var
  vlbicm: Double;
  vlicm: Double;
  vlipi: Double;
  vlpis: Double;
  vlcofins: Double;
  vlPercentual: Double;

begin
  // ajustar tributação da venda
  DmDados.mestrib.Close;
  DmDados.mestrib.Params[0].AsInteger := vpMeschave;
  DmDados.mestrib.Open;

  vlbicm := 0;
  vlicm := 0;
  vlipi := 0;
  vlpis := 0;
  vlcofins := 0;

  DmDados.itmtrib.Close;
  DmDados.itmtrib.Params[0].AsInteger := vpMeschave;
  DmDados.itmtrib.Open;

  DmDados.itmtrib.First;
  while not DmDados.itmtrib.Eof do
  begin

    DmDados.protrib.Close;
    DmDados.protrib.Params[0].AsInteger := DmDados.itmtribprocodigo.AsInteger;
    DmDados.protrib.Open;

    DmDados.itmtrib.edit;

    DmDados.itmtribcfocfopdestinacao.AsString := DmDados.protrib.FieldByName('cfocfop').AsString;
    DmDados.itmtribcfocfop.AsString := DmDados.protrib.FieldByName('cfocfop').AsString;

    // pis
    DmDados.itmtribcspcodigo.AsString := DmDados.protrib.FieldByName('cspcodigo').AsString;

    DmDados.itmtribitmbpis.AsFloat := (DmDados.itmtribitmvalor.AsCurrency * DmDados.itmtribitmquantidade.AsFloat) -
      DmDados.itmtribitmdesconto.AsCurrency;
    DmDados.itmtribitmaliqpis.AsFloat := DmDados.protrib.FieldByName('propisaliquota').AsFloat;
    if DmDados.protrib.FieldByName('propisaliquota').AsFloat > 0 then
    begin
      DmDados.itmtribitmpis.AsFloat := ((DmDados.itmtribitmvalor.AsCurrency * DmDados.itmtribitmquantidade.AsFloat) -
        DmDados.itmtribitmdesconto.AsCurrency) * (DmDados.protrib.FieldByName('propisaliquota').AsFloat / 100);
    end;
    DmDados.itmtribitmquantpis.AsFloat := 0;
    DmDados.itmtribitmaliqpisvalor.AsFloat := 0;

    // cofins
    DmDados.itmtribcsfcodigo.AsString := DmDados.protrib.FieldByName('csfcodigo').AsString;
    DmDados.itmtribitmbcofins.AsFloat := (DmDados.itmtribitmvalor.AsCurrency * DmDados.itmtribitmquantidade.AsFloat) -
      DmDados.itmtribitmdesconto.AsCurrency;
    DmDados.itmtribitmaliqcofins.AsFloat := DmDados.protrib.FieldByName('procofinsaliquota').AsFloat;
    if DmDados.protrib.FieldByName('procofinsaliquota').AsFloat <> 0 then
    begin
      DmDados.itmtribitmcofins.AsFloat := ((DmDados.itmtribitmvalor.AsCurrency * DmDados.itmtribitmquantidade.AsFloat) -
        DmDados.itmtribitmdesconto.AsCurrency) * (DmDados.protrib.FieldByName('procofinsaliquota').AsFloat / 100);
    end;
    DmDados.itmtribitmquantcofins.AsFloat := 0;
    DmDados.itmtribitmaliqcofinsvalor.AsFloat := 0;
    // ipi
    DmDados.itmtribcsicodigo.AsString := DmDados.protrib.FieldByName('csicodigo').AsString;
    DmDados.itmtribitmapuipi.AsInteger := 1;
    DmDados.itmtribitmbipi.AsFloat := 0;
    DmDados.itmtribitmaliqipi.AsFloat := 0;
    DmDados.itmtribitmipi.AsFloat := 0;

    // icm
    DmDados.itmtribcstcodigo.AsString := DmDados.protrib.FieldByName('cstcodigo').AsString;
    DmDados.itmtribicmcodigo.AsString := DmDados.protrib.FieldByName('icmcodigo').AsString;
    DmDados.icm.Close;
    DmDados.icm.Open;

    DmDados.icm.Locate('icmcodigo', DmDados.protribicmcodigo.AsString, []);

    If (DmDados.icm.FieldByName('icmaliquotas').AsFloat = 0.01) or (DmDados.icm.FieldByName('icmaliquotas').AsFloat = 0) Then
    Begin
      DmDados.itmtribitmbicm.AsFloat := 0;
      DmDados.itmtribitmaliqicm.AsFloat := 0;
      DmDados.itmtribitmicm.AsFloat := 0;

      DmDados.itmtribitmbicms.AsFloat := 0;
      DmDados.itmtribitmaliqicms.AsFloat := 0;
      DmDados.itmtribitmicms.AsFloat := 0;

    End
    Else
    Begin

      DmDados.itmtribitmbicm.AsCurrency := (DmDados.itmtribitmvalor.AsCurrency * DmDados.itmtribitmquantidade.AsFloat) -
        DmDados.itmtribitmdesconto.AsCurrency;

      if DmDados.protrib.FieldByName('propercreducaobaseicm').AsFloat <> 0 then
      begin
        DmDados.itmtribitmpercreducaobaseicm.AsFloat := DmDados.protrib.FieldByName('propercreducaobaseicm').AsFloat;
        DmDados.itmtribitmbicm.AsCurrency := DmDados.itmtribitmbicm.AsCurrency -
          (DmDados.itmtribitmbicm.AsCurrency * (DmDados.protrib.FieldByName('propercreducaobaseicm').AsFloat / 100));
      end;

      DmDados.itmtribitmaliqicm.AsCurrency := DmDados.icm.FieldByName('icmaliquotas').AsFloat;
      DmDados.itmtribitmicm.AsCurrency := DmDados.itmtribitmbicm.AsCurrency * (DmDados.icm.FieldByName('icmaliquotas').AsFloat / 100);

      DmDados.itmtribitmbicms.AsFloat := 0;
      DmDados.itmtribitmaliqicms.AsFloat := 0;
      DmDados.itmtribitmicms.AsFloat := 0;

    End;

    vlPercentual := 0;
    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Text := 'SELECT propercfcp FROM pro WHERE procodigo=' + DmDados.itmtribprocodigo.AsString;
    DmDados.Consulta.Open;

    if (DmDados.Consulta.FieldByName('propercfcp').AsString <> '') then
    begin
      if (DmDados.Consulta.FieldByName('propercfcp').AsString <> '0') then
      begin

        if (DmDados.Consulta.FieldByName('propercfcp').AsString <> '0.00') and (DmDados.Consulta.FieldByName('propercfcp').AsString <> '0,00') then
        begin

          vlPercentual := Strtofloat(StringReplace(trim(DmDados.Consulta.FieldByName('propercfcp').AsString), '.', ',', []));

          DmDados.itmtribitmbasefcpicm.AsCurrency := DmDados.itmtribitmtotal.AsCurrency - DmDados.itmtribitmdesconto.AsCurrency;
          DmDados.itmtribitmpercfcpicm.AsFloat := vlPercentual;
          DmDados.itmtribitmvalofcpicm.AsCurrency := (DmDados.itmtribitmtotal.AsCurrency - DmDados.itmtribitmdesconto.AsCurrency) *
            (vlPercentual / 100);
        end;

      end;
    end;

    // acumadores do mes
    vlbicm := vlbicm + DmDados.itmtribitmbicm.AsCurrency;
    vlicm := vlicm + DmDados.itmtribitmicm.AsCurrency;
    vlipi := vlipi + DmDados.itmtribitmipi.AsCurrency;
    vlpis := vlpis + DmDados.itmtribitmpis.AsCurrency;
    vlcofins := vlcofins + DmDados.itmtribitmcofins.AsCurrency;

    DmDados.itmtrib.Post;

    DmDados.itmtrib.Next;
  end;

  DmDados.mestrib.edit;
  DmDados.mestribmesbicm.AsCurrency := vlbicm;
  DmDados.mestribmesicm.AsCurrency := vlicm;
  DmDados.mestribmesipi.AsCurrency := vlipi;
  DmDados.mestribmespis.AsCurrency := vlpis;
  DmDados.mestribmescofins.AsCurrency := vlcofins;
  DmDados.mestrib.Post;

end;

procedure TFrmFinalizaMesa.CalculaTroco;
begin
  PnTroco.Left := trunc((FrmFinalizaMesa.Width - 280) / 2);
  PnTroco.Top := trunc((FrmFinalizaMesa.Height - 140) / 2);
  EdtVlResto.Text := '';
  PCFechamento.Enabled := False;
  PnTroco.BringToFront;
  PnTroco.BringToFront;

  PnTroco.Visible := true;

  EdtVlResto.SelectAll;
  EdtVlResto.SetFocus;
end;

procedure TFrmFinalizaMesa.cbDescontarTaxaChange(Sender: TObject);
var
  I: Integer;
  vlRec: Double;
  vlTot: Currency;
begin
  {

    if cbDescontarTaxa.ItemIndex = 1 then
    begin
    if EdtVlrPago.Text = EdtVlrReceber.Text then
    begin
    cbDescontarTaxa.Text := 'Cobrar';
    cbDescontarTaxa.ItemIndex := 0;

    ShowMessage('Pagamento total não permite descontar a taxa!');
    exit;
    end;

    end;

    if cbDescontarTaxa.ItemIndex = 0 then
    begin
    EdtVlrPago.Text := formatfloat('###0.00', vpReceber);

    EdtTroco.Text := formatfloat('###0.00', 0);
    EdtFalta.Text := formatfloat('###0.00', 0);
    CalculaTaxaParcial;
    vpFalta := (vpReceber + vpTaxaParcial) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
    EdtFalta.Text := formatfloat('###0.00', vpFalta);

    end
    else if cbDescontarTaxa.ItemIndex = 1 then
    begin
    if EdtVlrPago.ReadOnly then
    begin
    vlRec := vpReceber;
    while true do

    begin
    vlRec := RoundTo(vlRec - 0.01, -2);
    vpTaxaParcial := RoundTo(vlRec * (DmDados.cfgmcfgcfgmgoutaxaatendimento.AsFloat / 100), -2);

    vlTot := vlRec + vpTaxaParcial;
    if ((vlTot) <= vpReceber) then
    begin
    EdtVlrPago.ReadOnly := False;
    EdtVlrPago.Text := formatfloat('###0.00', vpReceber - vpTaxaParcial);
    EdtVlrPago.ReadOnly := true;

    break

    end;

    end;

    EdtTroco.Text := formatfloat('###0.00', 0);
    EdtFalta.Text := formatfloat('###0.00', 0);
    CalculaTaxaParcial;
    vpFalta := (vpReceber) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
    EdtFalta.Text := formatfloat('###0.00', vpFalta);

    end
    else
    begin
    EdtTroco.Text := formatfloat('###0.00', 0);
    EdtFalta.Text := formatfloat('###0.00', 0);
    CalculaTaxaParcial;
    vpFalta := (vpReceber) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
    EdtFalta.Text := formatfloat('###0.00', vpFalta);

    end;
    end
    else
    begin
    EdtTroco.Text := formatfloat('###0.00', 0);
    EdtFalta.Text := formatfloat('###0.00', 0);
    edValorTaxa.Text := formatfloat('###0.00', 0);
    vpTaxaParcial := 0;
    CalculaTaxaParcial;
    vpFalta := (vpReceber + vpTaxaParcial) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
    EdtFalta.Text := formatfloat('###0.00', vpFalta);

    end;

    if (EdtDinherio.Text <> '0,00') and (EdtDinherio.Text <> '') then
    begin
    ValidaRecDinheiro;
    end;

    if (EdtCardDebito.Text <> '0,00') and (EdtCardDebito.Text <> '') then
    begin
    ValidaRecCardDedito;
    end;

    if (EdtCardCredito.Text <> '0,00') and (EdtCardCredito.Text <> '') then
    begin
    ValidaRecCardCredito;
    end;

    if (edtAFaturar.Text <> '0,00') and (edtAFaturar.Text <> '') then
    begin
    ValidaRecAFaturar;
    end;

    if (edtDoacao.Text <> '0,00') and (edtDoacao.Text <> '') then
    begin
    ValidaRecdoacao;
    end;

    EditTotalComTaxa.Text := formatfloat('###0.00', 0);
  }
end;

procedure TFrmFinalizaMesa.cbDescontarTaxaCloseUp(Sender: TObject);
var
  I: Integer;
  vlRec: Double;
  vlTot: Currency;
begin

  if cbDescontarTaxa.ItemIndex = 1 then
  begin
    {
      if EdtVlrPago.Text = EdtVlrReceber.Text then
      begin
      cbDescontarTaxa.Text := 'Cobrar';
      cbDescontarTaxa.ItemIndex := 0;
      cbDescontarTaxa.SetFocus;


      edValorTaxa.Enabled:=True;
      EdtVlrPago.Text := formatfloat('###0.00', vpReceber);

      EdtTroco.Text := formatfloat('###0.00', 0);
      EdtFalta.Text := formatfloat('###0.00', 0);
      CalculaTaxaParcial;
      vpFalta := (vpReceber + vpTaxaParcial) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
      EdtFalta.Text := formatfloat('###0.00', vpFalta);

      ShowMessage('Pagamento total não permite descontar a taxa!');
      exit;
      end;
    }
  end;

  if cbDescontarTaxa.ItemIndex = 0 then
  begin
    edValorTaxa.Enabled := true;
    EdtVlrPago.Text := formatfloat('###0.00', vpReceber);

    EdtTroco.Text := formatfloat('###0.00', 0);
    EdtFalta.Text := formatfloat('###0.00', 0);
    CalculaTaxaParcial;
    vpFalta := (vpReceber + vpTaxaParcial) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
    EdtFalta.Text := formatfloat('###0.00', vpFalta);

  end
  { else if cbDescontarTaxa.ItemIndex = 1 then
    begin
    if EdtVlrPago.ReadOnly then
    begin
    vlRec := vpReceber;
    while true do

    begin
    vlRec := RoundTo(vlRec - 0.01, -2);
    vpTaxaParcial := RoundTo(vlRec * (DmDados.cfgmcfgcfgmgoutaxaatendimento.AsFloat / 100), -2);

    vlTot := vlRec + vpTaxaParcial;
    if ((vlTot) <= vpReceber) then
    begin
    EdtVlrPago.ReadOnly := False;
    EdtVlrPago.Text := formatfloat('###0.00', vpReceber - vpTaxaParcial);
    EdtVlrPago.ReadOnly := true;

    break

    end;

    end;

    EdtTroco.Text := formatfloat('###0.00', 0);
    EdtFalta.Text := formatfloat('###0.00', 0);
    CalculaTaxaParcial;
    vpFalta := (vpReceber) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
    EdtFalta.Text := formatfloat('###0.00', vpFalta);

    end
    else if cbDescontarTaxa.ItemIndex = 1 then
    begin

    edValorTaxa.Text := formatfloat('###0.00', 0);
    edValorTaxa.Enabled:=False;
    EdtTroco.Text := formatfloat('###0.00', 0);
    EdtFalta.Text := formatfloat('###0.00', 0);
    CalculaTaxaParcial;
    vpFalta := (vpReceber) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
    EdtFalta.Text := formatfloat('###0.00', vpFalta);


    end
    else
    begin

    end;
    end }
  else
  begin

    EdtTroco.Text := formatfloat('###0.00', 0);
    EdtFalta.Text := formatfloat('###0.00', 0);
    edValorTaxa.Text := formatfloat('###0.00', 0);
    vpTaxaParcial := 0;
    CalculaTaxaParcial;
    vpFalta := (vpReceber + vpTaxaParcial) - (vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
    EdtFalta.Text := formatfloat('###0.00', vpFalta);
    edValorTaxa.Enabled := False;
  end;

  if (EdtDinherio.Text <> '0,00') and (EdtDinherio.Text <> '') then
  begin
    ValidaRecDinheiro;
  end;

  if (EdtCardDebito.Text <> '0,00') and (EdtCardDebito.Text <> '') then
  begin
    ValidaRecCardDedito;
  end;

  if (EdtCardCredito.Text <> '0,00') and (EdtCardCredito.Text <> '') then
  begin
    ValidaRecCardCredito;
  end;

  if (edtAFaturar.Text <> '0,00') and (edtAFaturar.Text <> '') then
  begin
    ValidaRecAFaturar;
  end;

  if (edtDoacao.Text <> '0,00') and (edtDoacao.Text <> '') then
  begin
    ValidaRecdoacao;
  end;

  EditTotalComTaxa.Text := formatfloat('###0.00', 0);

end;

procedure TFrmFinalizaMesa.cbDescontarTaxaEnter(Sender: TObject);
begin
  cbDescontarTaxa.DroppedDown := true;

end;

procedure TFrmFinalizaMesa.LancaCartao(pMdaCodigo: Integer; EdtDados: TEdit);
type
  TRegistraCartoes = function(AOwner: TComponent; Conexao: TUniConnection; vTotal: string; pMdaCodigo: Integer): string;
var
  registra: TRegistraCartoes;
  pack: HMODULE;
  vlRetorno: String;
  vVlrPagto: Currency;
  vVlrGeral: Currency;
  vVlrRec: Currency;
begin
  EdtDados.SelectAll;
  EdtDados.SetFocus;
  if pMdaCodigo = 4 then
    vVlrGeral := (vpFalta + vpCardCredito)
  else if pMdaCodigo = 5 then
    vVlrGeral := (vpFalta + vpCardDebito);

  if vVlrGeral > 0 then
  begin
    pack := LoadPackage('modulos\mgrdc.bpl');
    if pack <> 0 then
      try
        @registra := GetProcAddress(pack, PChar('RegistraCartoes'));

        if not Assigned(registra) then
          exit;

        if pMdaCodigo = 5 then
        begin
          vlRetorno := registra(Application, DmDados.Conexao, Floattostr(vVlrGeral + vpCardCredito), pMdaCodigo);
          vlRetorno := Floattostr((Strtofloat(vlRetorno) - vpCardCredito));

        end
        else if pMdaCodigo = 4 then
        begin
          vlRetorno := registra(Application, DmDados.Conexao, Floattostr(vVlrGeral + vpCardDebito), pMdaCodigo);
          vlRetorno := Floattostr((Strtofloat(vlRetorno) - vpCardDebito));
        end
        else
          vlRetorno := registra(Application, DmDados.Conexao, Floattostr(vVlrGeral), pMdaCodigo);

        if vlRetorno <> '' then
        begin
          EdtDados.Text := vlRetorno;
          if DmDados.ValidaValor(EdtDados, vVlrRec) then
          begin
            if pMdaCodigo = 4 then
              vpCardCredito := vVlrRec
            else if pMdaCodigo = 5 then
              vpCardDebito := vVlrRec;

            vpFalta := vpReceber - (vpConvenio + vpAFaturar + vpDinheiro + vpPIX + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
            EdtDados.Text := formatfloat('###0.00', vVlrRec);
            EdtFalta.Text := formatfloat('###0.00', vpFalta);
          end;
        end;
      finally
        DoUnLoadPackage(Application, pack);
      end;
  end;
end;

procedure TFrmFinalizaMesa.LancaPIX;
begin
  EdtPIX.SetFocus;
  EdtPIX.Text := formatfloat('###0.00', (vpFalta + vpPIX));
  ValidaRecPIX;
end;

procedure TFrmFinalizaMesa.LancaCredito;
begin
  edtCredito.SetFocus;
  edtCredito.Text := formatfloat('###0.00', (vpFalta + vpcredito));
  ValidaReccredito;
end;

procedure TFrmFinalizaMesa.LancaDoacao;
begin
  if NOT plModalDoacoes.Visible then
  exit;
  edtDoacao.SetFocus;
  edtDoacao.Text := formatfloat('###0.00', (vpFalta + vpDoacao));
  ValidaRecdoacao;
end;

procedure TFrmFinalizaMesa.LancaCheque;
type
  TRegistraCheques = function(AOwner: TComponent; Conexao: TUniConnection; Vusrcodigo: String; vTotal: string; vdtlchave: string;
  vetdcodigo: String = ''): string;

var
  registra: TRegistraCheques;
  pack: HMODULE;
  vlRetorno: String;
  vVlrPagto: Currency;
  vOk: Boolean;
begin
  EdtCheque.SelectAll;
  EdtCheque.SetFocus;
  if (vpFalta + vpCheque) > 0 then
  begin
    pack := LoadPackage('modulos\mgche.bpl');
    if pack <> 0 then
      try
        @registra := GetProcAddress(pack, PChar('RegistraCheques'));

        if Assigned(registra) then
        begin
          if not DmDados.tche.Active then
            DmDados.tche.Open;

          vOk := False;
          while not vOk = true do
          begin


            // vlRetorno := registra(Application, DmDados.Conexao, FPrinciGou.AcessoRec.Usuario.ToString, FloattoStr((vpFalta + vpCheque)), '', '');

            vlRetorno := Floattostr((vpFalta + vpCheque));

            if (vlRetorno <> '') and (vlRetorno <> '0') then
            begin
              EdtCheque.Text := vlRetorno;
              if DmDados.ValidaValor(EdtCheque, vpCheque) then
              begin
                vpFalta := vpReceber - (vpConvenio + vpAFaturar + vpDinheiro + vpPIX + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao
                  + vpTaxaParcial);
                EdtCheque.Text := formatfloat('###0.00', vpCheque);
                EdtFalta.Text := formatfloat('###0.00', vpFalta);
                if vpFalta >= 0 then
                  vOk := true
                else
                  ShowMessage('Valor de cheque(s) informado maior que o falor devido, verifique !');
              end;
            end
            else
              vOk := true;
          end;
        end;

      finally
        DoUnLoadPackage(Application, pack);
      end;
  end;
end;

procedure TFrmFinalizaMesa.LancaConvenioAutomagico;
var
  vetdcodigo: String;
  vlLimDisp: Double;
  vlOrcchave: string;
begin
  EdtConvenio.SelectAll;
  EdtConvenio.SetFocus;
  if (vpFalta + vpConvenio) > 0 then
  begin
    vetdcodigo := mostralista('mcli', IntToStr(DmDados.Usuario.ClbCodigo), '');
    if vetdcodigo = '0' then
    begin
      ShowMessage('Não é possivel lançar convênio para cliente CONSUMIDOR!');

      plqlimitedisponivel.Caption := '';
      exit;
    end;
    if not(vetdcodigo = '') then
    begin
      DmDados.etd.Close;
      DmDados.etd.Params[0].AsInteger := StrToInt(vetdcodigo);
      DmDados.etd.Open;

      CarregalimiteCliente(StrToInt(vetdcodigo));

      if DmDados.etstsecodigo.AsInteger = 9 then
      begin
        ShowMessage('Não é permitido venda para cliente desativado!');

        plqlimitedisponivel.Caption := '';
        exit;

      end;

      vlOrcchave := DmDados.dorcdlv.DataSet.FieldByName('orcchave').AsString;

      if (plqlimitedisponivel.Caption <> '') and ((plqlimitedisponivel.Caption <> 'Bloqueio Total') and
        (plqlimitedisponivel.Caption <> 'Bloqueio Parcial')) then
      begin
        vlLimDisp := StrToCurr(StringReplace(pllimitedisponivel.Caption, '.', '', [rfReplaceAll, rfIgnoreCase]));
        if vlLimDisp < 0 then
          vlLimDisp := 0;

        if ((vlLimDisp - vpFalta + vpConvenio) < 0) or ((DmDados.etsetscodigo.AsInteger = 1) or (DmDados.etsetscodigo.AsInteger = 2)) then
        begin

          if DmDados.cfgmcfgcfgcontrolalimite.AsInteger = 1 then
          begin
            if LimiteAutorizado(vetdcodigo, vpFalta + vpConvenio, vlLimDisp, vlLimDisp, vlOrcchave.ToInteger) = False then
            begin

              plqlimitedisponivel.Caption := '';
              exit;
            end;
          end
          else if ((plqlimitedisponivel.Caption = 'Bloqueio Total') or (plqlimitedisponivel.Caption = 'Bloqueio Parcial')) then
          begin

            if LimiteAutorizado(vetdcodigo, vpFalta + vpConvenio, vlLimDisp, vlLimDisp, vlOrcchave.ToInteger) = False then
            begin

              plqlimitedisponivel.Caption := '';
              exit;
            end;

          end;

        end;
      end
      else if ((plqlimitedisponivel.Caption = 'Bloqueio Total') or (plqlimitedisponivel.Caption = 'Bloqueio Parcial')) then
      begin

        if LimiteAutorizado(vetdcodigo, vpFalta + vpConvenio, vlLimDisp, vlLimDisp, vlOrcchave.ToInteger) = False then
        begin

          plqlimitedisponivel.Caption := '';
          exit;
        end;

      end;

      if not DmDados.etd.IsEmpty then
      begin
        LbCliente.Caption := DmDados.etdetdcodigo.AsString + ' - ' + DmDados.etdetdidentificacao.AsString;
        EdtNomeCliente.Text := Copy(DmDados.etdetdidentificacao.AsString, 1, Pos(' ', DmDados.etdetdidentificacao.AsString));

        vpEtdCodigo := StrToInt(vetdcodigo);
        vpConvenio := (vpFalta + vpConvenio);
        EdtConvenio.Text := formatfloat('###0.00', vpConvenio);
        GerarParcelas(vpConvenio, vpEtdCodigo);
        vpFalta := vpReceber + vpTaxaParcial - (vpConvenio + vpDinheiro + vpPIX + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);
        EdtConvenio.Text := formatfloat('###0.00', vpConvenio);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        if TabItens.Tag = 0 then
          DmDados.ExecutaSQL('UPDATE orc SET etdcodigo = ' + vetdcodigo + ' WHERE orcchave = ' + vpOrcChave)
        else
          DmDados.ExecutaSQL('UPDATE orc SET etdcodigo = ' + vetdcodigo + ' WHERE orcchave = ' + DmDados.orcdlvetdcodigo.AsString);
      end;
    end;
  end;
end;


procedure TFrmFinalizaMesa.GerarTituloVenda(VlrParcela: Currency; vetdcodigo: Integer);
var
  vNumParc: Integer;
  vVlrParc: Currency;
  vVlrTotal: Currency;
  vDtVencto: TDateTime;
  vDiferenca: Currency;
begin
  if not DmDados.trfi.Active then
    DmDados.trfi.Open;

  vDtVencto := DmDados.Usuario.DtAtual;

  vDtVencto := (vDtVencto);
  DmDados.trfi.Append;
  DmDados.trfietdcodigo.AsInteger := vetdcodigo;
  DmDados.trfimdacodigo.AsInteger := 7;
  DmDados.trfitfdcodigo.AsInteger := 32;
  DmDados.trfinumParc.AsInteger := 1;
  DmDados.trfivlrparcela.AsCurrency := VlrParcela;
  DmDados.trfidtvecto.Asdatetime := vDtVencto;
  DmDados.trfinumero.AsString := vpOrcChave;
  DmDados.trfi.Post;
end;


procedure TFrmFinalizaMesa.GerarParcelas(VlrParcela: Currency; vetdcodigo: Integer);
var
  vNumParc: Integer;
  vVlrParc: Currency;
  vVlrTotal: Currency;
  vDtVencto: TDateTime;
  vDiferenca: Currency;
begin
  if not DmDados.trfi.Active then
    DmDados.trfi.Open;

  vDtVencto := DmDados.Usuario.DtAtual;

  DmDados.trfi.CancelUpdates;

  vDtVencto := (vDtVencto + 30);
  DmDados.trfi.Append;
  DmDados.trfietdcodigo.AsInteger := vetdcodigo;
  DmDados.trfimdacodigo.AsInteger := 7;
  DmDados.trfitfdcodigo.AsInteger := 2;
  DmDados.trfinumParc.AsInteger := 1;
  DmDados.trfivlrparcela.AsCurrency := VlrParcela;
  DmDados.trfidtvecto.Asdatetime := vDtVencto;
  DmDados.trfinumero.AsString := vpOrcChave;
  DmDados.trfi.Post;
end;

function TFrmFinalizaMesa.CarregalimiteCliente(vetdcodigo: Integer): Double;
begin
  pllimitetotal.Caption := formatfloat('##,#####0.00', 0);
  pllimitedisponivel.Caption := formatfloat('##,#####0.00', 0);
  if DmDados.cfgmcfgcfgcontrolalimite.AsInteger = 1 then
  begin
    DmDados.limite.Close;
    DmDados.limite.Params[0].AsInteger := vetdcodigo;
    DmDados.limite.Open;
    pllimitetotal.Caption := formatfloat('##,#####0.00', DmDados.limiteetllimitetotal.AsFloat);

    // vpEtlDescontoPadrao := dmdados.limiteetldescontopadrao.AsFloat;

    DmDados.disponivel.Close;
    DmDados.disponivel.Params[0].AsInteger := vetdcodigo;
    DmDados.disponivel.Open;
    pllimitedisponivel.Caption := formatfloat('##,#####0.00', DmDados.limiteetllimitetotal.AsFloat - DmDados.disponivelrfisaldocapital.AsCurrency);

  end;

  DmDados.ets.Close;
  DmDados.ets.ParamByName('etdcodigo').AsInteger := vetdcodigo;
  DmDados.ets.Open;

  if not DmDados.ets.IsEmpty then
  begin
    if (DmDados.etstsecodigo.AsInteger = 1) or (DmDados.etstsecodigo.AsInteger = 2) then
    begin
      pltitlimitetotal.Visible := False;
      pltitlimitedisponivel.Visible := False;
      plqlimitedisponivel.Caption := DmDados.etstseidentificacao.AsString;
      plqlimitedisponivel.Font.Color := clred;
      plqlimitedisponivel.Visible := true;
   //   Application.ProcessMessages;

    end;
  end;

end;

procedure TFrmFinalizaMesa.LancaConvenio;
var
  vetdcodigo: String;
  vVlrPagto: Currency;
  vlOrcchave: string;
  vlLimDisp: Double;

begin
  if (EdtConvenio.ReadOnly = False) and (EdtConvenio.Enabled = true) then
  begin
    EdtConvenio.SelectAll;
    EdtConvenio.SetFocus;
  end;
  if (vpFalta + vpConvenio) > 0 then
  begin

    if vpOrcChaveDelivery <> '' then
    begin
      vetdcodigo := DmDados.orcdlvetdcodigo.AsString;
    end
    else
    begin
      vetdcodigo := mostralista('mcli', IntToStr(DmDados.Usuario.ClbCodigo), '');
    end;

    if not(vetdcodigo = '') then
    begin
      DmDados.etd.Close;
      DmDados.etd.Params[0].AsInteger := StrToInt(vetdcodigo);
      DmDados.etd.Open;

      DmDados.situacaoetd.Close;
      DmDados.situacaoetd.SQL.Text := ' SELECT ets.tsecodigo from ets  WHERE  etdcodigo=' + vetdcodigo + ' ORDER BY etscodigo DESC LIMIT 1 ';
      DmDados.situacaoetd.Open;

      if DmDados.situacaoetd.FieldByName('tsecodigo').AsInteger = 9 then
      begin
        ShowMessage('Não é permitido venda para cliente desativado!');

        plqlimitedisponivel.Caption := '';
        exit;
      end;

      CarregalimiteCliente(StrToInt(vetdcodigo));

      if vpOrcChaveDelivery <> '' then
      begin
        vlOrcchave := vpOrcChaveDelivery;

      end
      else
      begin
        vlOrcchave := DmDados.dOrc.DataSet.FieldByName('orcchave').AsString;

      end;

      if (plqlimitedisponivel.Caption <> '') and ((plqlimitedisponivel.Caption <> 'Bloqueio Total') and
        (plqlimitedisponivel.Caption <> 'Bloqueio Parcial')) then
      begin
        vlLimDisp := StrToCurr(StringReplace(pllimitedisponivel.Caption, '.', '', [rfReplaceAll, rfIgnoreCase]));

        if ((vlLimDisp - vpFalta + vpConvenio) < 0) or ((DmDados.etsetscodigo.AsInteger = 1) or (DmDados.etsetscodigo.AsInteger = 2)) then
        begin

          if DmDados.cfgmcfgcfgcontrolalimite.AsInteger = 1 then
          begin

            if LimiteAutorizado(vetdcodigo, vpFalta + vpConvenio, vlLimDisp, vlLimDisp, vlOrcchave.ToInteger) = False then
            begin
              exit;

              plqlimitedisponivel.Caption := '';

              exit;
            end
            else
            begin

            end;
          end;
        end;
      end
      else if ((plqlimitedisponivel.Caption = 'Bloqueio Total') or (plqlimitedisponivel.Caption = 'Bloqueio Parcial')) then
      begin

        if LimiteAutorizado(vetdcodigo, vpFalta + vpConvenio, vlLimDisp, vlLimDisp, vlOrcchave.ToInteger) = False then
        begin

          plqlimitedisponivel.Caption := '';
          exit;
        end;

      end;

      if not DmDados.etd.IsEmpty then
      begin

        vpEtdCodigo := StrToInt(vetdcodigo);

        { Application.CreateForm(TFrmParcela, FrmParcela);
          FrmParcela.EdtVlrReceber.Text := formatfloat('###0.00', (vpFalta + vpConvenio));
          FrmParcela.EdtFalta.Text := formatfloat('###0.00', (vpFalta + vpConvenio));
          FrmParcela.vpFalta := vpFalta + vpConvenio;

          FrmParcela.vpEtdCodigo := StrToInt(vEtdCodigo);
          FrmParcela.ShowModal;

          if FrmParcela.vpConfirma then }

        if (vpEtdCodigo > 0) then
        begin
          GerarParcelas(vpFalta + vpConvenio, StrToInt(vetdcodigo));
          vpConvenio := vpFalta + vpConvenio;

          LbCliente.Caption := DmDados.etdetdcodigo.AsString + ' - ' + DmDados.etdetdidentificacao.AsString;
          EdtNomeCliente.Text := Copy(DmDados.etdetdidentificacao.AsString, 1, Pos(' ', DmDados.etdetdidentificacao.AsString));

          if TabItens.Tag = 0 then
            DmDados.ExecutaSQL('UPDATE orc SET etdcodigo = ' + vetdcodigo + ' WHERE orcchave = ' + vpOrcChave)
          else
            DmDados.ExecutaSQL('UPDATE orc SET etdcodigo = ' + vetdcodigo + ' WHERE orcchave = ' + DmDados.orcdlvetdcodigo.AsString);
        end;

        { FreeAndNil(FrmParcela); }

        if (cbDescontarTaxa.Text = 'Cobrar') then
        begin
          vpFalta := (vpReceber + vpTaxaParcial) - (vpConvenio + vpAFaturar + vpDinheiro + vpPIX + vpCardDebito + vpCardCredito + vpCheque +
            vpAFaturar + vpDoacao);

        end
        else
        begin

          vpFalta := vpReceber - (vpConvenio + vpAFaturar + vpDinheiro + vpPIX + vpCardDebito + vpCardCredito + vpCheque + vpAFaturar + vpDoacao);

        end;

        EdtConvenio.Text := formatfloat('###0.00', vpConvenio);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);

      end;
    end;
  end;

  if vpFalta <= 0.01 then
  begin
    BtnTabRecConfirma.Enabled := true;
  end;

end;

function TFrmFinalizaMesa.LimiteAutorizado(vetdcodigo: String; vValorVenda: Double; vlLimiteSolic: Double; vlLimiteDisponivel: Double;
vpOrcChave: Integer): Boolean;
type
  TAutorizacaoAtenLimite = function(AOwner: TComponent; Conexao: TUniConnection; vusuario: string; vLimiteSolic: Double; vorcchave: String): string;

var

  auto: TAutorizacaoAtenLimite;
  ru: string;
  vactcodigo: string;
  vlPackLia: Cardinal;

begin
  result := true;

  if (plqlimitedisponivel.Caption = 'Bloqueio Total') or (plqlimitedisponivel.Caption = 'Bloqueio Parcial') then
  begin
    if Application.MessageBox('Cliente possui Bloqueio no cadastro!! ' + #13 + #13 + 'Liberar venda?', 'Atenção', MB_ICONQUESTION + MB_YESNO) = IdYes
    then
    begin
      vlPackLia := LoadPackage('modulos\mlia.bpl');
      if vlPackLia <> 0 then
        try
          @auto := GetProcAddress(vlPackLia, PChar('liberacaoAtenLimiteCred'));

          if not Assigned(auto) then
            exit;

          ru := auto(Application, DmDados.Conexao, DmDados.Usuario.ClbCodigo.ToString, vlLimiteSolic, IntToStr(vpOrcChave));

          if (ru = '0') or (ru = '') then // retornou NÃO AUTORIZADO
            result := False;
        finally
          DoUnLoadPackage(Application, vlPackLia);
        end;

    end
    else
    begin
      plqlimitedisponivel.Caption := '';
      result := False;

    end;

  end
  else
  begin
    result := true;
    vlPackLia := LoadPackage('modulos\mlia.bpl');
    if vlPackLia <> 0 then
      try
        @auto := GetProcAddress(vlPackLia, PChar('liberacaoAtenLimiteCred'));

        if not Assigned(auto) then
          exit;

        ru := auto(Application, DmDados.Conexao, DmDados.Usuario.ClbCodigo.ToString, vlLimiteSolic, IntToStr(vpOrcChave));

        if (ru = '0') or (ru = '') then // retornou NÃO AUTORIZADO
          result := False;
      finally
        DoUnLoadPackage(Application, vlPackLia);
      end;

  end;

end;

procedure TFrmFinalizaMesa.LimpaRecebimento;
begin

  // Limpando Edits;

  EdtDesconto.Clear;
  EdtVlrReceber.Clear;
  EdtDinherio.Clear;
  EdtConvenio.Clear;
  EdtCardDebito.Clear;
  EdtCardCredito.Clear;
  edtAFaturar.Clear;
  EdtPIX.Clear;
  EdtCheque.Clear;
  edtDoacao.Clear;
  edtCredito.Clear;
  EdtNomeCliente.Clear;
  EdtVlrPago.Clear;

  // zerando variaveis de controle de recebimento
 // vpDesconto := 0;
  vpReceber := vpTotal;
  vpDinheiro := 0;
  vpPIX := 0;

  vpConvenio := 0;
  vpCardDebito := 0;
  vpCardCredito := 0;
  vpAFaturar := 0;
  vpDoacao := 0;

  vpCheque := 0;
  vpFalta := 0;
  vpTroco := 0;
  // vpEtdCodigo := 0;
  if vpEtdCodigo = 0 then
  begin
    LbCliente.Caption := '';
    plDisponivel.Caption := '';
  end;

  EdtVlrTotal.Text := formatfloat('###0.00', vpTotal);

  //EdtDesconto.Text := formatfloat('###0.00', 0);
  EdtDesconto.text:=FormatFloat('##0.00', vpDesconto);
  EdtVlrReceber.Text := formatfloat('###0.00', vpTotal);
  // FormatFloat('###0.00', (vpTotalGeral - vpRecebimentos) );
  EdtVlrPago.Text := formatfloat('###0.00', vpTotal);

  CalculaTaxaParcial;

  // FormatFloat('###0.00', (vpTotalGeral - vpRecebimentos));
  EdtFalta.Text := formatfloat('###0.00', vpTotal + vpTaxaParcial);
  // FormatFloat('###0.00', (vpTotalGeral - vpRecebimentos));
  vpFalta := vpTotal + vpTaxaParcial; // (vpTotalGeral - vpRecebimentos);

  // passando orcamento para consumidor
  if TabItens.Tag = 0 then
    DmDados.ExecutaSQL('UPDATE orc SET etdcodigo = 0 WHERE orcchave = ' + vpOrcChave)
  else
    DmDados.ExecutaSQL('UPDATE orc SET etdcodigo = 0 WHERE orcchave = ' + DmDados.orcdlvetdcodigo.AsString);

  EdtDesconto.ReadOnly := False;

  if EdtDesconto.Text <> '' then
  begin
    vpDescontoMaximo:=vpFalta;
    ValidaRecDesconto;
    ajustafalta;


  end;

  if (TabItens.Tag = 1) or (not DmDados.titem.IsEmpty) then
  begin
    EdtVlrPago.ReadOnly := true;
    CalculaTaxaParcial;
  end
  else
    EdtVlrPago.ReadOnly := False;
end;

function TFrmFinalizaMesa.ModuloNFCe(vmeschave: string): Boolean;
type
  TModuloNFCe = function(AOwner: TComponent; Conexao: TUniConnection; vmeschave: string; vFuncao: string; Acesso: TAcesso; vImprimir: Boolean;
  vConsultouSefaz: Boolean; vemail: string): Boolean;
var
  ModuloNFCe: TModuloNFCe;

  vImprimir: Boolean;

begin
  try
    result := False;

    begin
      FPrinciGou.vpacknfe := LoadPackage('modulos\mnfegourmet.bpl');
    end;
    if FPrinciGou.vpacknfe <> 0 then

      @ModuloNFCe := GetProcAddress(FPrinciGou.vpacknfe, PChar('modulonfce'));

    if Assigned(ModuloNFCe) then
    begin
      vImprimir := true;

      result := ModuloNFCe(Application, DmDados.Conexao, vmeschave, 'EmiteNFCe', FPrinciGou.AcessoRec, vImprimir, DmDados.vpConsultouSefaz, '');
      DmDados.vpConsultouSefaz := true;
    end;
  finally
    // DoUnLoadPackage(Application, vPackNFCe);
  end;
end;

function TFrmFinalizaMesa.mostralista(pModulo, pUsuario: string; pFiltro: string): string;

type
  TExecFormu = function(AOwner: TComponent; Conexao: TUniConnection; vusuario: string; vtipolista: Integer; vmodulo: string; vfiltro: string;
  vmodo: string): string;
var
  ExecFormu: function(CargaFrame: TCargaFrame): String;
  vlCargaFrame: TCargaFrame;
  vlRetorno: string;
  pack: Cardinal;
begin

  if InternetAtiva then
  begin
    FPrinciGou.VerAtualizacao(pModulo);
  end;

  pack := LoadPackage('modulos\' + pModulo + '.bpl');

  (* Abandona pois não localizou o módulo (Pode ser adicionada mensagem informando o usuário) *)
  if pack = 0 then
    exit;

  try
    @ExecFormu := GetProcAddress(pack, PChar('formu'));
    if Assigned(ExecFormu) then
    begin

      vlCargaFrame := CargaFrameFormu(Application, pack, DmDados.Conexao, FPrinciGou.AcessoRec, pFiltro, '');
      result := ExecFormu(vlCargaFrame);

    end;
  finally
    DoUnLoadPackage(Application, pack);
  end;
end;

procedure TFrmFinalizaMesa.MostraTab(Tab: TTabSheet);
begin
  // desabilitando TabSheets
  if TabItens.TabVisible then
    TabItens.TabVisible := False;

  if TabResumo.TabVisible then
    TabResumo.TabVisible := False;

  if TabRecebimento.TabVisible then
    TabRecebimento.TabVisible := False;

  if TabPedidos.TabVisible then
    TabPedidos.TabVisible := False;

  // Abrindo Grupos do Cardapio
  if Tab = TabItens then
  begin
    if FrmFinalizaMesa.Width = 480 then
    begin
      FrmFinalizaMesa.Width := 1012;
      FrmFinalizaMesa.Left := (FrmFinalizaMesa.Left - 266);
    end;
  end;
  if Tab = TabResumo then
  begin
    if DmDados.olt.Active then
      DmDados.olt.First;
  end;

  if Tab = TabRecebimento then
  begin
    ajustafalta;

    // redimencionando formulário
    if FrmFinalizaMesa.Width = 1012 then
    begin
      FrmFinalizaMesa.Width := 480;
      FrmFinalizaMesa.Left := (FrmFinalizaMesa.Left + 266);
    end;
    // Desconto Maximo
    if vpEtlDescontoPadrao <> 0 then
      vpDescontoMaximo := TBRound(((vpTotal * (vpEtlDescontoPadrao / 100))), 2)
    else
      vpDescontoMaximo := TBRound(((vpTotal * (DmDados.Usuario.PercDesc / 100))), 2);

    if TabPedidos.Tag = 0 then
    begin
      self.Caption := 'Delivery - Pedido Nº ' + DmDados.orcdlvimmnumepedido.AsString;
      LbNomeCliente.Visible := False;
      EdtNomeCliente.Visible := False;
      EdtVlrPago.ReadOnly := true;
      EdtVlrPago.TabStop := False;
    end
    else
    begin
      LbNomeCliente.Visible := true;
      EdtNomeCliente.Visible := true;
      PnCliente.Enabled := true;
      if not DmDados.titem.IsEmpty then
        EdtVlrPago.ReadOnly := true
      else
        EdtVlrPago.ReadOnly := False;
      EdtVlrPago.TabStop := true;
    end;
  end
  else
  begin
    // redimencionando formulário
    if FrmFinalizaMesa.Width = 480 then
    begin
      FrmFinalizaMesa.Width := 1012;
      FrmFinalizaMesa.Left := (FrmFinalizaMesa.Left - 266);
    end;
  end;

  if Tab = TabPedidos then
  begin
    self.Caption := 'Recebimento Delivery';
    if vpRecNo > 0 then
      DmDados.orcdlv.RecNo := vpRecNo;
  end;

  Tab.TabVisible := true;
  PCFechamento.ActivePage := Tab;
end;

procedure TFrmFinalizaMesa.plDoacaoMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  LancaDoacao;
end;

procedure TFrmFinalizaMesa.plModalCreditoMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  LancaCredito;
end;

procedure TFrmFinalizaMesa.plModalCreditoMouseEnter(Sender: TObject);
begin
  plModalCredito.BevelKind := bkFlat;
end;

procedure TFrmFinalizaMesa.plModalCreditoMouseLeave(Sender: TObject);
begin
  plModalCredito.BevelKind := bkNone;
end;

procedure TFrmFinalizaMesa.plModalDoacaoMouseEnter(Sender: TObject);
begin
  plModalDoacao.BevelKind := bkFlat;
end;

procedure TFrmFinalizaMesa.plModalDoacaoMouseLeave(Sender: TObject);
begin
  plModalDoacao.BevelKind := bkNone;
end;

procedure TFrmFinalizaMesa.plModalPIXMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
 // LancaPIX;

  // Registrando PIX
  if EdtPIX.Enabled then
  begin
    if vpRegistraPIX then
      LancaCartao(4, EdtPIX)
    else
    begin

      if (EdtPIX.Text='0,00') or  (EdtPIX.Text='')  then
      begin
        if (vpFalta-ValorDigitado) =vpReceber then
           EdtPIX.Text := formatfloat('###0.00', (vpFalta + vpPIX));
      end;

      ValidaRecPIX;

      EdtPIX.SelectAll;

      EdtPIXExit(EdtPIX);

    end;

  end;


end;

procedure TFrmFinalizaMesa.plModalPIXMouseEnter(Sender: TObject);
begin
  plModalPIX.BevelKind := bkFlat;
end;

procedure TFrmFinalizaMesa.plModalPIXMouseLeave(Sender: TObject);
begin
  plModalPIX.BevelKind := bkNone;
end;

procedure TFrmFinalizaMesa.plModalCartaoDebitoMouseEnter(Sender: TObject);
begin
  PnModalCardDeb.BevelKind := bkFlat;
end;

procedure TFrmFinalizaMesa.plModalCartaoDebitoMouseLeave(Sender: TObject);
begin
  PnModalCardDeb.BevelKind := bkNone;
end;

procedure TFrmFinalizaMesa.plModalAFaturarMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  BuscaCliente;
  if vpEtdCodigo <> 0 then
  begin
    edtAFaturar.SetFocus;

    if (edtAFaturar.Text = '0,00') or (edtAFaturar.Text = '')  then
      edtAFaturar.Text := formatfloat('###0.00', (vpFalta + vpAFaturar));
    ValidaRecAFaturar;
    edtAFaturar.SelectAll;
  end;
end;

procedure TFrmFinalizaMesa.plModalAFaturarMouseEnter(Sender: TObject);
begin
  plModalAFaturar.BevelKind := bkFlat;
end;

procedure TFrmFinalizaMesa.plMOdalAFaturarMouseLeave(Sender: TObject);
begin
  plModalAFaturar.BevelKind := bkNone;
end;

procedure TFrmFinalizaMesa.PnModalChequeMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  LancaCheque;
end;

procedure TFrmFinalizaMesa.PnModalChequeMouseEnter(Sender: TObject);
begin
  PnModalCheque.BevelKind := bkFlat;
end;

procedure TFrmFinalizaMesa.PnModalChequeMouseLeave(Sender: TObject);
begin
  PnModalCheque.BevelKind := bkNone;
end;

procedure TFrmFinalizaMesa.PnModalConvenioMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  LancaConvenio;
end;

procedure TFrmFinalizaMesa.PnModalConvenioMouseEnter(Sender: TObject);
begin
  PnModalConvenio.BevelKind := bkFlat;
end;

procedure TFrmFinalizaMesa.PnModalConvenioMouseLeave(Sender: TObject);
begin
  PnModalConvenio.BevelKind := bkNone;
end;

procedure TFrmFinalizaMesa.PnModalCardCreMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // LancaCartao(4, EdtCardCredito);
  // Registrando crédito
  if EdtCardCredito.Enabled then
  begin
    if vpRegistraCartao then
      LancaCartao(4, EdtCardCredito)
    else
    begin
     // EdtCardCredito.SetFocus;

      if (EdtCardCredito.Text='0,00') or  (EdtCardCredito.Text='')  then
      begin
        if (vpFalta-ValorDigitado) =vpReceber then
           EdtCardCredito.Text := formatfloat('###0.00', (vpFalta + vpCardCredito));
      end;

      ValidaRecCardCredito;
      EdtCardCredito.SelectAll;

      EdtCardCreditoExit(EdtCardCredito);

    end;
  end;
end;

procedure TFrmFinalizaMesa.PnModalCardCreMouseEnter(Sender: TObject);
begin
  PnModalCardCre.BevelKind := bkFlat;
end;

procedure TFrmFinalizaMesa.PnModalCardCreMouseLeave(Sender: TObject);
begin
  PnModalCardCre.BevelKind := bkNone;
end;

procedure TFrmFinalizaMesa.PnModalCardDebMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // LancaCartao(5, EdtCardDebito);

  // Registrando Débito

  if EdtCardDebito.Enabled then
  begin

    if vpRegistraCartao then
      LancaCartao(5, EdtCardDebito)
    else
    begin

   //   EdtCardDebito.SetFocus;

      if (EdtCardDebito.Text='0,00') or  (EdtCardDebito.Text='')  then
      begin
        if (vpFalta-ValorDigitado) =vpReceber then
          EdtCardDebito.Text := formatfloat('###0.00', (vpFalta + vpCardDebito));
      end;

      ValidaRecCardDedito;
      EdtCardDebito.SelectAll;

      EdtCardDebitoExit(EdtCardDebito);

    end;
  end;
end;

function TFrmFinalizaMesa.ValorDigitado:Currency;
var
  ValorDigitado:Currency;
begin

  ValorDigitado := 0;

  if EdtDinherio.text<>'' then
    ValorDigitado := ValorDigitado + StrToCurr(EdtDinherio.text);

  if EdtCardDebito.text<>'' then
    ValorDigitado := ValorDigitado + StrToCurr(EdtCardDebito.text);

  if EdtCardCredito.text<>'' then
    ValorDigitado := ValorDigitado + StrToCurr(EdtCardCredito.text);

  if EdtCheque.text<>'' then
    ValorDigitado := ValorDigitado + StrToCurr(EdtCheque.text);

  if EdtPIX.text<>'' then
    ValorDigitado := ValorDigitado + StrToCurr(EdtPIX.text);

  if EdtConvenio.text<>'' then
    ValorDigitado := ValorDigitado + StrToCurr(EdtConvenio.text);

  if edtAFaturar.text<>'' then
    ValorDigitado := ValorDigitado + StrToCurr(edtAFaturar.text);

  if edtDoacao.text<>'' then
    ValorDigitado := ValorDigitado + StrToCurr(edtDoacao.text);

  if edtCredito.text<>'' then
    ValorDigitado := ValorDigitado + StrToCurr(edtCredito.text);

  ReSult := ValorDigitado;

end;

procedure TFrmFinalizaMesa.PnModalCardDebMouseEnter(Sender: TObject);
begin
  PnModalCardDeb.BevelKind := bkFlat;
end;

procedure TFrmFinalizaMesa.PnModalCardDebMouseLeave(Sender: TObject);
begin
  PnModalCardDeb.BevelKind := bkNone;
end;

procedure TFrmFinalizaMesa.RemoverItem;
begin
  // Excluindo item selecionado
  with DmDados do
  begin
    ito.DisableControls;
    ito.Filtered := False;
    if ito.Locate('itochave', titemitochave.AsInteger, []) then
    begin
      ito.edit;
      itoitoquantidade.AsFloat := (itoitoquantidade.AsFloat + titemqtde.AsFloat);

      itoitototalav.AsCurrency := (itoitoquantidade.AsFloat * (itoitovalorav.AsCurrency + itoitoacrescimoav.AsCurrency));

      itostocodigo.AsInteger := 2;
      ito.Post;
    end;
    ito.Filtered := true;
    titem.Delete;
    SomaItens;
    ito.EnableControls;
  end;
end;

procedure TFrmFinalizaMesa.SomaItens;
begin
  with DmDados do
  begin
    vpTotal := 0;
    if not titem.IsEmpty then
    begin
      titem.First;
      while not titem.Eof do
      begin
        vpTotal := vpTotal + titemitototalav.AsCurrency;
        titem.Next;
      end;
    end;
    // itens total

    vpTotal := TBRound(vpTotal, 2);
    vpReceber := vpTotal + vpTaxaParcial;
    LbItemDispValor.Caption := formatfloat('###0.00', (vpTotalGeral - vpTotal)-vpdesconto);
    DmDados.Consulta.Close;
    DmDados.Consulta.SQL.Clear;
    DmDados.Consulta.SQL.Text := 'select sum(itoquantidade) as qtd from ito where  ito.stocodigo=2 and  orcchave=' + vpOrcChave;
    DmDados.Consulta.Open;

    LbItemDispQtde.Caption := 'Itens: ' + IntToStr(DmDados.Consulta.FieldByName('qtd').AsInteger);
    // itens selecionados
    LbItemTotal.Caption := formatfloat('###0.00', vpTotal);

    LbItemQtde.Caption := 'Itens: ' + IntToStr(titem.RecordCount);
    LbPendente.Caption := 'Pendente R$ ' + formatfloat('###0.00', (vpTotalGeral - vpRecebimentos)-vpDesconto);

    EditTotalComTaxa.Text := formatfloat('###0.00', (vpReceber));

    LbItemDispValor.Caption := 'Saldo R$ ' + formatfloat('###0.00', (vpTotalGeral - vpTotal) - (vpRecebimentos+vpdesconto ));

  //  Application.ProcessMessages;

  end;
end;

procedure TFrmFinalizaMesa.TabItensEnter(Sender: TObject);
begin
  BtnConfirmar.SetFocus;
end;

procedure TFrmFinalizaMesa.TabItensShow(Sender: TObject);
begin
  BtnConfirmar.SetFocus
end;

procedure TFrmFinalizaMesa.TabPedidosShow(Sender: TObject);
begin
  EdtPedido.SetFocus;
end;

procedure TFrmFinalizaMesa.TabRecebimentoShow(Sender: TObject);
begin
  if DmDados.dtitem.DataSet.RecordCount > 0 then
  begin
    BtnRecLimpar.Visible := False;
  end
  else
  begin
    BtnRecLimpar.Visible := true;
  end;

  if not EdtDesconto.ReadOnly then
  begin
    EdtDinherio.SelectAll;

    if (EdtNomeCliente.Color = clYellow) and (EdtNomeCliente.Text = '') then
    begin
      if PnCliente.Visible then
      begin
        EdtNomeCliente.SetFocus;
      end
      else
        EdtDinherio.SetFocus;
    end
    else
    begin
      EdtDinherio.SetFocus;
    end;

  end
  else
    EdtNomeCliente.SetFocus;
end;

procedure TFrmFinalizaMesa.AlteraFonte(pObjeto: TRichEdit; pTamanho: Integer; pTipo: TFontStyle; pCor: TColor);
begin
  pObjeto.SelAttributes.Color := pCor;
  pObjeto.SelAttributes.Size := pTamanho;
  pObjeto.SelAttributes.Name := 'Tahoma';
  pObjeto.SelAttributes.Style := [pTipo];
end;

procedure TFrmFinalizaMesa.ApresentaItem(pOrcChave, pItoChave: Integer);
var
  vSQL: String;
begin
  MemPro.Lines.Clear;

  vSQL := 'SELECT COUNT(*) fsncount ' + '  FROM sfn ' + ' INNER JOIN pro ON sfn.procodigo = pro.procodigo ' +
    ' INNER JOIN ito on pro.procodigo = ito.procodigo  ' + ' WHERE ito.itochave = ' + IntToStr(pItoChave);
  DmDados.ConsultaSQL(vSQL);

  DmDados.Item.Close;
  DmDados.Item.Params[0].AsInteger := pOrcChave; // orcchave
  DmDados.Item.Params[1].AsInteger := pItoChave; // itochave
  DmDados.Item.Open;

  if not DmDados.Item.IsEmpty then
  begin
    MemPro.Visible := true;
    // Escrevendo nome do produto
    AlteraFonte(MemPro, 16, fsbold, clblack);
    // MemPro.Lines.Add(' ' + dmdados.Itemitoquantidade.AsString + ' X ' + dmdados.Itempronome.AsString);

    // caso produto seja fracionado
    if DmDados.Consulta.Fields[0].AsInteger > 0 then
    begin
      // Escrevendo bordas do produto quando existir
      DmDados.itemBorda.Close;
      DmDados.itemBorda.Params[0].AsInteger := pOrcChave; // orcchave
      DmDados.itemBorda.Params[1].AsInteger := pItoChave; // itochave
      DmDados.itemBorda.Open;
      if not DmDados.itemBorda.IsEmpty then
      begin
        AlteraFonte(MemPro, 12, fsbold, clBlue);
        MemPro.Lines.add('*** ' + trim(DmDados.cfgmcfgcfgmgouttulocomposicao.AsString) + ' ***');
        DmDados.itemBorda.First;
        while not DmDados.itemBorda.Eof do
        begin
          AlteraFonte(MemPro, 10, fsbold, clblack);
          MemPro.Lines.add('   ' + DmDados.ItemBordabrdidentificacao.AsString);
          DmDados.itemBorda.Next;
        end;
      end;

      // Escrevendo sabores do produto quando existir
      DmDados.itemSabor.Close;
      DmDados.itemSabor.Params[0].AsInteger := pOrcChave; // orcchave
      DmDados.itemSabor.Params[1].AsInteger := pItoChave; // itochave
      DmDados.itemSabor.Open;

      if not DmDados.itemSabor.IsEmpty then
      begin

        AlteraFonte(MemPro, 12, fsbold, clgreen);
        MemPro.Lines.add('*** SABORES ***');
        DmDados.itemSabor.First;
        while not DmDados.itemSabor.Eof do
        begin
          AlteraFonte(MemPro, 10, fsbold, clblack);
          MemPro.Lines.add('   ' + DmDados.ItemSaborsbridentificacao.AsString);
          // Escrevendo sabores do produto quando existir
          DmDados.ItemIngredientefra.Close;
          DmDados.ItemIngredientefra.Params[0].AsInteger := pOrcChave;
          // orcchave
          DmDados.ItemIngredientefra.Params[1].AsInteger := pItoChave;
          // itochave
          DmDados.ItemIngredientefra.Params[2].AsInteger := DmDados.ItemSaborsbichave.AsInteger; // sbichave
          DmDados.ItemIngredientefra.Open;
          if not DmDados.ItemIngredientefra.IsEmpty then
          begin
            DmDados.ItemIngredientefra.First;
            while not DmDados.ItemIngredientefra.Eof do
            begin
              if DmDados.ItemIngredienteFraisitipo.AsInteger = 0 then
              begin
                AlteraFonte(MemPro, 9, fsbold, clblack);
                if Pos('            ' + DmDados.ItemIngredienteFratsiidentificacao.AsString + ' ' + DmDados.ItemIngredienteFraingnome.AsString,
                  MemPro.Lines.Text) = 0 then
                begin
                  MemPro.Lines.add('            ' + DmDados.ItemIngredienteFratsiidentificacao.AsString + ' ' +
                    DmDados.ItemIngredienteFraingnome.AsString)
                end;
              end
              else
              begin
                AlteraFonte(MemPro, 9, fsbold, clMaroon);
                if Pos('            ' + 'ADICIONAR ' + DmDados.ItemIngredienteFraingnome.AsString + ' (' +
                  DmDados.ItemIngredienteFratsiidentificacao.AsString + ')', MemPro.Lines.Text) = 0 then
                begin
                  MemPro.Lines.add('            ' + 'ADICIONAR :' + DmDados.ItemIngredienteFraingnome.AsString + ' ' + formatfloat('##0',
                    DmDados.ItemIngredienteFraisiquantidade.AsInteger) + ' X ' + formatfloat('###0.00',
                    DmDados.ItemIngredienteFrapunprecoav.AsCurrency) + ' = ' + formatfloat('###0.00', DmDados.ItemIngredienteFrapunprecoav.AsCurrency
                    * DmDados.ItemIngredienteFraisiquantidade.AsInteger));
                end;
              end;
              DmDados.ItemIngredientefra.Next;
            end;
          end;

          DmDados.itemSabor.Next;
        end;
      end;
    end
    else
    // caso o item seja comum
    begin

      // Escrevendo sabores do produto quando existir
      DmDados.ItemIngredienteNormal.Close;
      DmDados.ItemIngredienteNormal.Params[0].AsInteger := pOrcChave;
      // orcchave
      DmDados.ItemIngredienteNormal.Params[1].AsInteger := pItoChave;
      // itochave
      DmDados.ItemIngredienteNormal.Open;
      if not DmDados.ItemIngredienteNormal.IsEmpty then
      begin
        DmDados.ItemIngredienteNormal.First;
        while not DmDados.ItemIngredienteNormal.Eof do
        begin
          if DmDados.ItemIngredienteNormalisitipo.AsInteger = 0 then
          begin
            AlteraFonte(MemPro, 9, fsbold, clblack);
            if Pos('            ' + DmDados.ItemIngredienteNormaltsiidentificacao.AsString + ' ' + DmDados.ItemIngredienteNormalingnome.AsString,
              MemPro.Lines.Text) = 0 then

              MemPro.Lines.add('            ' + DmDados.ItemIngredienteNormaltsiidentificacao.AsString + ' ' +
                DmDados.ItemIngredienteNormalingnome.AsString)
          end
          else
          begin
            AlteraFonte(MemPro, 9, fsbold, clMaroon);
            if Pos('            ' + 'ADICIONAR ' + DmDados.ItemIngredienteNormalingnome.AsString + ' (' +
              DmDados.ItemIngredienteNormaltsiidentificacao.AsString + ')', MemPro.Lines.Text) = 0 then
            begin
              MemPro.Lines.add('            ' + 'ADICIONAR :' + DmDados.ItemIngredienteNormalingnome.AsString + ' ' + formatfloat('##0',
                DmDados.ItemIngredienteNormalisiquantidade.AsInteger) + ' x ' + formatfloat('###0.00',
                DmDados.ItemIngredienteNormalpunprecoav.AsCurrency) + ' = ' + formatfloat('###0.00',
                DmDados.ItemIngredienteNormalpunprecoav.AsCurrency * DmDados.ItemIngredienteNormalisiquantidade.AsInteger));
            end;
          end;
          DmDados.ItemIngredienteNormal.Next;
        end;
      end;

    end;
  end
  else
  begin
    MemPro.Visible := False;
  end;

end;

procedure TFrmFinalizaMesa.ValidaRecebimento(var vModalidade: Currency; vValorInformado: Currency; vedCampo: TEdit);
var
  vVlrInformado: Currency;
begin
  vVlrInformado := vValorInformado;

  if DmDados.ValidaValor(vedCampo, vVlrInformado) then
  begin
    if (vVlrInformado > (vpFalta + vModalidade)) then
    begin
      vpTroco := vVlrInformado - (vpFalta + vModalidade);
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
      vVlrInformado := vVlrInformado - vpTroco;
    end;

    if ((vVlrInformado >= 0) and (vVlrInformado <= (vpFalta + vModalidade))) then
    begin
      if vVlrInformado = vpReceber + vpTaxaParcial then
      begin
        vpFalta := 0;
        vModalidade := vVlrInformado;
        vedCampo.Text := formatfloat('###0.00', vVlrInformado);
        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end
      else
      begin
        if vedCampo.Name = 'EdtDinherio' then
        begin
          if cbDescontarTaxa.Text = 'Descontar' then
          begin
            vpFalta := (vpReceber) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpDoacao +
              vpcredito);
          end
          else
          begin;
            vpFalta := (vpReceber + vpTaxaParcial) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque +
              vpDoacao + vpcredito);
          end;

        end
        else if vedCampo.Name = 'EdtCardDebito' then
        begin
          if cbDescontarTaxa.Text = 'Descontar' then
          begin
            vpFalta := (vpReceber) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpDinheiro + vpCardCredito + vpCheque + vpDoacao + vpcredito);

          end
          else
          begin

            vpFalta := (vpReceber + vpTaxaParcial) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpDinheiro + vpCardCredito + vpCheque +
              vpDoacao + vpcredito);
          end;
        end
        else if vedCampo.Name = 'EdtCardCredito' then
        begin
          if cbDescontarTaxa.Text = 'Descontar' then
          begin

            vpFalta := (vpReceber) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpDinheiro + vpCheque + vpDoacao + vpcredito);

          end
          else
          begin

            vpFalta := (vpReceber + vpTaxaParcial) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpDinheiro + vpCheque +
              vpDoacao + vpcredito);
          end;
        end
        else if vedCampo.Name = 'EdtPIX' then
        begin
          if cbDescontarTaxa.Text = 'Descontar' then
          begin

            vpFalta := (vpReceber) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpDinheiro + vpCheque + vpDoacao + vpcredito);

          end
          else
          begin

            vpFalta := (vpReceber + vpTaxaParcial) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpDinheiro + vpCheque +
              vpDoacao + vpcredito);
          end;
        end

        else if vedCampo.Name = 'EdtCheque' then
        begin
          if cbDescontarTaxa.Text = 'Descontar' then
          begin
            vpFalta := vpReceber - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpDinheiro + vpDoacao +
              vpcredito);

          end
          else
          begin

            vpFalta := (vpReceber + vpTaxaParcial) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpDinheiro +
              vpDoacao + vpcredito);
          end;
        end
        else if vedCampo.Name = 'EdtConvenio' then
        begin
          if cbDescontarTaxa.Text = 'Descontar' then
          begin
            vpFalta := (vpReceber) - (vVlrInformado + vpAFaturar + vpPIX + vpDinheiro + vpCardDebito + vpCardCredito + vpCheque + vpDoacao +
              vpcredito);

          end
          else
          begin
            vpFalta := (vpReceber + vpTaxaParcial) - (vVlrInformado + vpAFaturar + vpPIX + vpDinheiro + vpCardDebito + vpCardCredito + vpCheque +
              vpDoacao + vpcredito);
          end;
        end
        else if vedCampo.Name = 'edtAFaturar' then
        begin
          if cbDescontarTaxa.Text = 'Descontar' then
          begin

            vpFalta := (vpReceber) - (vVlrInformado + vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpDoacao +
              vpcredito);

          end
          else
          begin
            vpFalta := (vpReceber + vpTaxaParcial) - (vVlrInformado + vpDinheiro + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque +
              vpDoacao + vpcredito);
          end;
        end
        else if vedCampo.Name = 'edtDoacao' then
        begin
          if cbDescontarTaxa.Text = 'Descontar' then
          begin
            vpFalta := (vpReceber) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpDinheiro +
              vpcredito);

          end
          else
          begin
            vpFalta := (vpReceber + vpTaxaParcial) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque +
              vpDinheiro + vpcredito);
          end;
        end
        else if vedCampo.Name = 'edtCredito' then
        begin
          if cbDescontarTaxa.Text = 'Descontar' then
          begin
            vpFalta := (vpReceber) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque + vpDoacao +
              vpDinheiro);

          end
          else
          begin
            vpFalta := (vpReceber + vpTaxaParcial) - (vVlrInformado + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque +
              vpDoacao + vpDinheiro);
          end;
        end;

        // vpFalta := vpReceber - (vVlrInformado + vpDinheiro + vpAFaturar + vpPIX + vpConvenio + vpCardDebito + vpCardCredito + vpCheque);

        vModalidade := vVlrInformado;

        // vedCampo.Text := formatfloat('###0.00', vVlrInformado + vpTaxaParcial);

        if cbDescontarTaxa.Text = 'Cobrar' then
        begin

          if EdtNomeCliente.Color = clYellow then
          begin
            vedCampo.Text := formatfloat('###0.00', vVlrInformado);

          end
          else
          begin

            vedCampo.Text := formatfloat('###0.00', vVlrInformado);
          end;

        end
        else if cbDescontarTaxa.Text = 'Descontar' then
        begin
          vedCampo.Text := formatfloat('###0.00', vVlrInformado);
        end
        else
        begin
          vedCampo.Text := formatfloat('###0.00', vVlrInformado);
        end;

        EdtFalta.Text := formatfloat('###0.00', vpFalta);
        EdtVlrPago.ReadOnly := true;
      end;
    end
    else
    begin
      vedCampo.Text := formatfloat('###0.00', vModalidade + vpTaxaParcial);
      vpFalta := vpReceber - (vpDinheiro + vpPIX + vpConvenio + vpAFaturar + vpCardDebito + vpCardCredito + vpCheque);
      vpTroco := 0;
      EdtTroco.Text := formatfloat('###0.00', vpTroco);
    end;
  end;
  if vpFalta <= 0.001 then
  begin
    if BtnTabRecConfirma.Visible then
    begin
      BtnTabRecConfirma.Enabled := true;
      if BtnTabRecConfirma.Enabled then
      begin
        BtnTabRecConfirma.SetFocus;
      end;
    end;
  end
  else
  begin
    BtnTabRecConfirma.Enabled := False;
  end;

end;




Function TFrmFinalizaMesa.CNPJCPFInformado:Boolean;
var
  ClienteSimples: TClienteSimples;
  vlRetorno: string;
  vlPackIDC: Cardinal;
begin
  vlRetorno := '0';
  vlPackIDC := 0;
  vlPackIDC := LoadPackage('modulos\midc.bpl');
  if vlPackIDC <> 0 then
    @ClienteSimples := GetProcAddress(vlPackIDC, PChar('ClienteSimplesOrc'));

  if Assigned(ClienteSimples) then
  begin
    vlRetorno := ClienteSimples(Application, dmdados.conexao, dmdados.orcorcchave.AsString, Inttostr(DmDados.Usuario.ClbCodigo));
  end;
  // DoUnLoadPackage(Application, vlPackIDC);



  if (vlRetorno <> '0') and (vlRetorno <> '') then
  begin

    dmdados.oic.Close;
    dmdados.oic.Connection:= dmdados.Conexao;
    dmdados.oic.Params[0].AsString := dmdados.orcorcchave.asstring;
    dmdados.oic.Open;

    if dmdados.oic.RecordCount = 1 then
      dmdados.oic.Edit
    else
      dmdados.oic.Append;

    dmdados.oicidccodigo.AsString := vlRetorno;
    dmdados.oicorcchave.AsString :=  dmdados.orcorcchave.asstring;
    dmdados.oic.Post;

  end;

  dmdados.idcoic.close;
  dmdados.idcoic.Connection:=dmdados.Conexao;
  dmdados.idcoic.ParamByName('orcchave').AsString:= dmdados.orcorcchave.asstring;
  dmdados.idcoic.Open;

  if not dmdados.idcoic.IsEmpty then
  begin

    CPFnaNota:=dmdados.idcoic.FieldByName('idcdoc').AsString;

    if CPFnaNota<>'' then
    begin
      plMensagem.Visible:=true;
      plMensagem.Color:=clYellow;
      plMensagem.Caption:='CNPJ: '+CPFnaNota;
    end;

    Result:=true;
  end
  else
    Result := False;


  inherited;

end;

procedure TFrmFinalizaMesa.ExibirMensagemPorTempo(const Mensagem: string; MilissegundosExibicao: Integer);
var
  FormExibeMensagem: TFormExibeMensagemPortempo;
begin
  if (MilissegundosExibicao >= 0) then
  begin
    FormExibeMensagem := TFormExibeMensagemPortempo.Create(Self);
    try
      FormExibeMensagem.Mensagem := Mensagem;
      FormExibeMensagem.TempoEspera := MilissegundosExibicao;
      FormExibeMensagem.ShowModal;
    finally
      FormExibeMensagem.Free;
    end;
  end;

end;


procedure TFrmFinalizaMesa.ExibirMensagem(const Mensagem: string; MilissegundosExibicao: Integer);
var
  FormExibeMensagem: TFormExibeMensagem;
begin
  if (MilissegundosExibicao >= 0) then
  begin
    FormExibeMensagem := TFormExibeMensagem.Create(Self);
    try
      FormExibeMensagem.Mensagem := Mensagem;
      FormExibeMensagem.TempoEspera := MilissegundosExibicao;
      FormExibeMensagem.ShowModal;
    finally
      FormExibeMensagem.Free;
    end;
  end;

end;

procedure TFrmFinalizaMesa.DadosConfiguracao;
var
  vlcfg:TUniquery;
  vltrm:TUniquery;
  vladc:TUniquery;
  vlclb:TUniquery;

begin

  vlcfg:=TUniquery.Create(nil);

  vlcfg.Close;
  vlcfg.Connection :=dmdados.Conexao;
  vlcfg.SQL.Text:='SELECT cfgusacre, cfgcontrolalimite, cfgctacodigopix,  cfgusaadc, '+
                  'etddoc1, etdidentificacao,cfgdatapadrao '+
                  'FROM cfg, etd, cfgmsai, cfgmcre, cfgmcfg '+
                  'WHERE cfg.cfgcodigo=cfgmsai.cfgcodigo '+
                  'AND cfg.cfgcodigo=cfgmcfg.cfgcodigo '+
                  'AND cfg.cfgcodigo=cfgmcre.cfgcodigo '+
                  'AND cfgmcfg.cfgetdempresa=etd.etdcodigo  limit 1';
  vlcfg.Open;

  estabelecimentocnpj:=SoNumeros(vlcfg.FieldByName('etddoc1').AsString);
  estabelecimentorazaosocial:=trim(uppercase(vlcfg.FieldByName('etdidentificacao').AsString));
  DataAtual:=vlcfg.FieldByName('cfgdatapadrao').AsDateTime;

  ContaPIX:=vlcfg.FieldByName('cfgctacodigopix').AsInteger;
  UsaCre:=vlcfg.FieldByName('cfgusacre').AsInteger;
  UsaAdc:=vlcfg.FieldByName('cfgusaadc').AsInteger;
  ControlaLimite:=vlcfg.FieldByName('cfgcontrolalimite').AsInteger;

  vlcfg.close;
  vlcfg.Free;

  vltrm:=TUniquery.Create(nil);
  vltrm.Connection:=dmdados.Conexao;
  vltrm.sql.Text:='SELECT trmcodigo, trmestabelecimentotipotef, trmterminalcodempresa,'+
                  'trmterminalcodfilial, trmterminalcodterminal,  trmterminalenderecoservidor,'+
                  'trmterminalportapinpad FROM trm  where trmcodigo=:trmcodigo';
  vltrm.ParamByName('trmcodigo').AsInteger:=dmdados.usuario.clbcodigo;
  vltrm.open;

  estabelecimentotipotef:=vltrm.FieldByName('trmestabelecimentotipotef').AsString;

  terminalcodempresa:=vltrm.FieldByName('trmterminalcodempresa').AsString;
  terminalcodfilial:=vltrm.FieldByName('trmterminalcodfilial').AsString;
  terminalcodterminal:=vltrm.FieldByName('trmterminalcodterminal').AsString;
  terminalenderecoservidor:=vltrm.FieldByName('trmterminalenderecoservidor').AsString;
  terminalportapinpad:=vltrm.FieldByName('trmterminalportapinpad').AsString;

  vltrm.close;
  vltrm.Free;

  vladc:=TUniquery.Create(nil);

  vladc.Close;
  vladc.Connection := dmdados.Conexao;
  vladc.SQL.Text:='SELECT adccodigo, adcidentificacao, etdcodigo, adcpropria, '+
                  'bdccodigo, ctacodigo FROM adc  where ctacodigo<>0 and  adcencerramento is null  order by adccodigo desc limit 1';
  vladc.Open;

  CodigoADC:=vladc.FieldByName('adccodigo').AsInteger;
  AdquirenteADC:=vladc.FieldByName('adcidentificacao').AsString;
  EntidadeADC:=vladc.FieldByName('etdcodigo').AsInteger;
  ContaAdc:=vladc.FieldByName('ctacodigo').AsInteger;

  vladc.close;

  vlclb:=TUniquery.Create(nil);
  vlclb.Close;
  vlclb.Connection:=dmdados.Conexao;
  vlclb.sql.Text :='SELECT clbcodigo, clbidentificacao from clb where clbcodigo=:clbcodigo ';
  vlclb.ParamByName('clbcodigo').AsInteger:=dmdados.usuario.clbcodigo;
  vlclb.Open;

  if not vlclb.IsEmpty then
    Operador :=vlclb.FieldByName('clbidentificacao').AsString
  else
    Operador := 'Operado';
  vlclb.close;

end;




procedure TFrmFinalizaMesa.CarregaDadosConfiguracaoTEF;
begin

  DadosConfiguracao;

  fConfiguracaoTEF.EstabelecimentoTipoTEF := estabelecimentotipotef;
  fConfiguracaoTEF.EstabelecimentoCNPJ := estabelecimentoCNPJ;
  fConfiguracaoTEF.EstabelecimentoRazaoSocial := EstabelecimentoRazaoSocial;
  fConfiguracaoTEF.terminalcodempresa := terminalcodempresa;
  fConfiguracaoTEF.terminalcodfilial := terminalcodfilial;
  fConfiguracaoTEF.terminalcodterminal := terminalcodterminal;
  fConfiguracaoTEF.terminalenderecoservidor := terminalenderecoservidor;
  fConfiguracaoTEF.terminalportapinpad :=terminalportapinpad;
  fConfiguracaoTEF.TerminalOperador := Operador;

end;


function TFrmFinalizaMesa.RegistraCartao(aDtlchave: Integer; aValor: Currency; aQuantidadeParcelas:String='1'): TOperacaoTEF;
var
  vlRctChave:Integer;
  vlclb:TUniquery;
  vlResultado:Integer;
begin


  vlclb:=TUniquery.Create(nil);
  vlclb.Close;
  vlclb.Connection:=dmdados.Conexao;
  vlclb.sql.Text :='SELECT clbcodigo, clbidentificacao from clb where clbcodigo=:clbcodigo ';
  vlclb.ParamByName('clbcodigo').AsInteger:=DmDados.Usuario.ClbCodigo;
  vlclb.Open;

  if not vlclb.IsEmpty then
    Operador :=vlclb.FieldByName('clbidentificacao').AsString
  else
    Operador := 'Operado';
  vlclb.close;
  vlclb.Free;

  fConfiguracaoTEF.TerminalOperador := Operador;

  CarregaDadosConfiguracaoTEF;

  if fOperacaoTEF=nil then
    fOperacaoTEF:=TOperacaoTEF.create;

  fOperacaoTEF.numero:=GeraSequencial.ToInteger;
  fOperacaoTEF.Bandeira:='';
  fOperacaoTEF.AutorizacaoRetorno:='';
  fOperacaoTEF.DocumentoRetorno:='';
  fOperacaoTEF.ImagemComprovante1aVia:='';
  fOperacaoTEF.ImagemComprovante2aVia:='';
  fOperacaoTEF.Rede:='';
  fOperacaoTEF.Dia:='';

  fOperacaoTEF.Valor := aValor;
  fOperacaoTEF.Identificacao := vlRctChave.ToString;
  fOperacaoTEF.TipoFinanciador := '0'; // parcelado a vista
  fOperacaoTEF.TipoCartao := '1'; // Cartão chipado

  case fTeclaFinalizador of
    114:
      begin
        fOperacaoTEF.Modalidade := 3; // tcDebito,
        fOperacaoTEF.TipoOperacao := '1';

      end;

    115:
      begin
        fOperacaoTEF.Modalidade := 4; // credito
        fOperacaoTEF.TipoOperacao := '1';
      end;
    119:
      begin
        fOperacaoTEF.Modalidade := 5;// TACBrTEFModalidadePagamento.tefmpCarteiraVirtual;
        fOperacaoTEF.TipoOperacao := '0';
      end;

  end;

  fOperacaoTEF.QuantidadeParcela:=aQuantidadeParcelas;
  fConfiguracaoTEF.TerminalOperador := Operador;

  fTransacaoTEF.fConfiguracaoTEF:=fConfiguracaoTEF;
  fTransacaoTEF.TipoProcessamento:=1;
  fTransacaoTEF.OperacaoTEF:=fOperacaoTEF;
  fTransacaoTEF.ZCone:=dmdados.Conexao;
  fTransacaoTEF.OrcChave:=dmdados.orcorcchave.asstring;

  vlResultado:=fTransacaoTEF.ShowModal;

  if vlResultado=mrok then
  begin
    result:=fTransacaoTEF.OperacaoTEF;
  end
  else
  begin
    fTransacaoTEF.OperacaoTEF.Valor:=0;
    result:=fTransacaoTEF.OperacaoTEF;
  end;

end;


function TFrmFinalizaMesa.GetHoraAtual: TTime;
var
  qHora: tuniquery;
begin
  qHora := tuniquery.Create(application);
  try
    qHora.Connection := dmdados.Conexao;
    qHora.SQL.Text := 'SELECT CURRENT_TIME();';
    qHora.Open;

    Result := qHora.Fields[0].AsDateTime;
  finally
    qHora.Free;
  end;
end;



procedure TFrmFinalizaMesa.EncerraRecebimentoStone;
var
  vlfstonenome:String;
  vlStoneHide: Tfstonehide;

begin

   vlfstonenome:='fstonehide'+vpMesaAtual;



   if FPrinciGou.plmesasemfechamento.FindChildControl(vlfstonenome) <> nil then
   begin
    vlStoneHide:=(FPrinciGou.plmesasemfechamento.FindChildControl(vlfstonenome)  as Tfstonehide);
    if vlStoneHide<>nil then
    begin
      vlStoneHide.FinalizaRecebimento;
    end;

    vlStoneHide.Free;

   end;



end;





end.
