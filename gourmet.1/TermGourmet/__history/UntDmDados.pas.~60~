unit UntDmDados;

interface

uses
  System.SysUtils, System.Classes, uni, DASQLMonitor, UniSQLMonitor, Data.DB,
  Vcl.Forms, Winapi.Windows, System.Variants, System.Math,
  Vcl.Dialogs,
  MemDS, DBAccess, UniProvider, MySQLUniProvider, VirtualTable, Vcl.DBGrids,
  Vcl.StdCtrls, IniFiles, MemData, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,
  FireDAC.DApt.Intf, FireDAC.Comp.DataSet, FireDAC.Comp.Client;

type

  TUsuario = record
    ClbCodigo: Integer;
    ClbIdentificacao: string;
    CcxChave: Integer;
    CznChave: Integer;
    QtdMesa: Integer;
    TsiCodigo: Integer;
    DtAtual: TDateTime;
    CtaCodigo: Integer;
    MitTipCodigo: Integer;
    TciTciPorta: String;
    TrmCodigo: Integer;
    TituloOperador: String;
    UsaDelivery: Integer;
    PercDesc: Currency;
    TipoFechamento: String;
    VendaIndividual: String;
    MesaVendaRapida: String;

  end;

  TBalanca = Record
    Ativa: Integer;
    modelo: String;
    porta: String;
    baud: Integer;
    handshake: String;
    parity: String;
    stop: String;
    Data: Integer;
  End;

  TDmDados = class(TDataModule)
    Conexao: TUniConnection;
    MySQLUniProvider: TMySQLUniProvider;
    Consulta: TUniQuery;
    UniSQLMonitor: TUniSQLMonitor;
    MobGravaItens: TUniStoredProc;
    clb: TUniQuery;
    clbclbcodigo: TIntegerField;
    clbclbidentificacao: TStringField;
    msa: TUniQuery;
    msamsachave: TIntegerField;
    msamsaabertura: TDateTimeField;
    msamsafechamento: TDateTimeField;
    msaclbcodigo: TIntegerField;
    msaorcchave: TIntegerField;
    msamsasituacao: TIntegerField;
    msamsanumero: TIntegerField;
    orc: TUniQuery;
    orcorcchave: TIntegerField;
    orcetdcodigo: TIntegerField;
    orcclbcodigo: TIntegerField;
    orcstocodigo: TIntegerField;
    orcorcmesa: TIntegerField;
    orcorcpessoas: TIntegerField;
    ito: TUniQuery;
    itoitochave: TIntegerField;
    itoitoitem: TIntegerField;
    itoprocodigo: TIntegerField;
    itopronome: TStringField;
    itoitoquantidade: TFloatField;
    itounisimbolo: TStringField;
    itoitovalorav: TFloatField;
    itoitototalav: TFloatField;
    itopuncodigo: TIntegerField;
    dClb: TUniDataSource;
    dMsa: TUniDataSource;
    dOrc: TUniDataSource;
    dIto: TUniDataSource;
    grp: TUniQuery;
    grpgrpcodigo: TIntegerField;
    grpgrpidentificacao: TStringField;
    grptpocodigo: TIntegerField;
    proc: TUniQuery;
    procprocodigo: TIntegerField;
    procpronomereduzido: TStringField;
    procpunprecoav: TStringField;
    sfn: TUniQuery;
    sfnprocodigo: TIntegerField;
    sfnpuncodigo: TIntegerField;
    sfnpronomereduzido: TStringField;
    sfnpunprecoav: TStringField;
    sfnunipro: TIntegerField;
    sfnunipun: TIntegerField;
    sfnunisimbolo: TStringField;
    sfnsfnquantidade: TFloatField;
    sfnsfncodigo: TIntegerField;
    dsfn: TUniDataSource;
    vtItens: TFDMemTable;
    vtItensitoitem: TIntegerField;
    vtItensprocodigo: TIntegerField;
    vtItenspronome: TStringField;
    vtItenspuncodigo: TIntegerField;
    vtItensitoquantidade: TFloatField;
    vtItensunisimbolo: TStringField;
    vtItensStatus: TIntegerField;
    vtItensObs: TStringField;
    vtItenstipo: TIntegerField;
    vtItenssfncodigo: TIntegerField;
    dVtiItens: TUniDataSource;
    pun: TUniQuery;
    punpuncodigo: TIntegerField;
    pununisimbolo: TStringField;
    punpunprecoav: TFloatField;
    punvlvenda: TStringField;
    tito: TUniQuery;
    titoID: TIntegerField;
    titoprocodigo: TIntegerField;
    titopuncodigo: TIntegerField;
    titoclbcodigo: TIntegerField;
    titopessoas: TIntegerField;
    titoobs: TStringField;
    titosfnid: TIntegerField;
    titosfncodigo: TIntegerField;
    sbr: TUniQuery;
    sbrsbrcodigo: TIntegerField;
    sbrsbrprocodigo: TIntegerField;
    sbrprocodigo: TIntegerField;
    sbrpronome: TStringField;
    sbrtsiidentificacao: TStringField;
    sbrobs: TStringField;
    tsi: TUniQuery;
    tsitsicodigo: TIntegerField;
    tsitsiidentificacao: TStringField;
    dtsi: TUniDataSource;
    Adc: TUniQuery;
    Adcprocodigo: TIntegerField;
    Adcpronome: TStringField;
    Adcpunprecoav: TFloatField;
    Adcgrpcodigo: TIntegerField;
    dAdc: TUniDataSource;
    tisi: TUniQuery;
    tisisbrcodigo: TIntegerField;
    tisitsicodigo: TIntegerField;
    tisiprocodigo: TIntegerField;
    tisiisitipo: TIntegerField;
    tisisfncodigo: TIntegerField;
    tisisfnid: TIntegerField;
    tisiobs: TStringField;
    vtpro: TFDMemTable;
    vtprosfnid: TIntegerField;
    vtprosfncodigo: TIntegerField;
    vtprosbrcodigo: TIntegerField;
    vtprodescricao: TStringField;
    vtproobs: TStringField;
    fIngrediente: TUniQuery;
    fIngredientesbrcodigo: TIntegerField;
    fIngredienteprocodigo: TIntegerField;
    fIngredientepronome: TStringField;
    fIngredientetsicodigo: TIntegerField;
    fIngredienteobs: TStringField;
    dfIngrediente: TUniDataSource;
    vtfIng: TFDMemTable;
    vtfIngsfnid: TIntegerField;
    vtfIngsfncodigo: TIntegerField;
    vtfIngsbrcodigo: TIntegerField;
    vtfIngprocodigo: TIntegerField;
    vtfIngtsicodigo: TIntegerField;
    vtfIngtipo: TIntegerField;
    brd: TUniQuery;
    brdbrdcodigo: TIntegerField;
    brdbrdidentificacao: TStringField;
    dbrd: TUniDataSource;
    tbrd: TUniQuery;
    tbrdsfnid: TIntegerField;
    tbrdsfncodigo: TIntegerField;
    tbrdbrdcodigo: TIntegerField;
    fsbr: TUniQuery;
    fsbrsbrcodigo: TIntegerField;
    fsbrsbridentificacao: TStringField;
    fsbrprocodigo: TIntegerField;
    dfsbr: TUniDataSource;
    dsbr: TUniDataSource;
    dpun: TUniDataSource;
    dstito: TUniDataSource;
    sbrtsiopcao: TStringField;
    vtsbradc: TFDMemTable;
    vtsbradcprocodigo: TIntegerField;
    vtsbradcpronome: TStringField;
    vtsbradctsicodigo: TIntegerField;
    vtsbradctsiopcao: TStringField;
    dvtsbradc: TUniDataSource;
    titopronome: TStringField;
    vtsbradcsbrcodigo: TIntegerField;
    Adctsicodigo: TIntegerField;
    Adctsiidentificacao: TStringField;
    fIngredientetsiopcao: TStringField;
    cfgmcfg: TUniQuery;
    cfgmcfgetdapelido: TStringField;
    cfgmcfgmodonfe: TStringField;
    clbclbdescmaximo: TFloatField;
    cfgmcfgdtAtual: TDateField;
    fpun: TUniQuery;
    IntegerField1: TIntegerField;
    StringField1: TStringField;
    FloatField1: TFloatField;
    StringField2: TStringField;
    dfpun: TUniDataSource;
    itostocodigo: TIntegerField;
    itostoidentificacao: TStringField;
    tro: TUniQuery;
    trotrochave: TIntegerField;
    troorcchaveorigem: TIntegerField;
    troorcchavedestino: TIntegerField;
    trfmesa: TUniQuery;
    ttro: TUniQuery;
    trfmesaorcchave: TIntegerField;
    trfmesaorcmesa: TIntegerField;
    ttroID: TIntegerField;
    ttroorcchave: TIntegerField;
    ttromesa: TStringField;
    ttroorcmesa: TIntegerField;
    dtrfmesa: TUniDataSource;
    dttro: TUniDataSource;
    TransfereMesa: TUniStoredProc;
    rel: TUniQuery;
    relbplcodigo: TIntegerField;
    relreltitulo: TStringField;
    relrelnomearquivo: TStringField;
    relrelarquivo: TBlobField;
    relrelidentificacao: TStringField;
    relbplfranome: TStringField;
    relrelcodigo: TStringField;
    titem: TUniQuery;
    dtitem: TUniDataSource;
    titemID: TIntegerField;
    titemprocodigo: TIntegerField;
    titempronome: TStringField;
    titemobs: TStringField;
    titemitototalav: TFloatField;
    titemitochave: TIntegerField;
    etd: TUniQuery;
    detd: TUniDataSource;
    etdetdcodigo: TIntegerField;
    etdetddoc1: TStringField;
    etdetdidentificacao: TStringField;
    etdedrcodigo: TIntegerField;
    etdedrrua: TStringField;
    etdedrnumero: TStringField;
    etdedrbairro: TStringField;
    etdetftelefone: TStringField;
    etdtsecodigo: TIntegerField;
    etdedrinscest: TStringField;
    etdedritem: TIntegerField;
    trfi: TUniQuery;
    dtrfi: TUniDataSource;
    trfiID: TIntegerField;
    trfidtvecto: TDateField;
    trfivlrparcela: TFloatField;
    trfinumparc: TIntegerField;
    FechaMesa: TUniStoredProc;
    tdtl: TUniQuery;
    tdtlID: TIntegerField;
    tdtldtlvalor: TFloatField;
    tdtlmdacodigo: TIntegerField;
    dtdtl: TUniDataSource;
    trfietdcodigo: TIntegerField;
    trfitfdcodigo: TIntegerField;
    olt: TUniQuery;
    oltoltchave: TIntegerField;
    oltoltidentificacao: TStringField;
    oltctacodigo: TIntegerField;
    oltlteregistro: TDateTimeField;
    oltltetotal: TFloatField;
    oltorcchave: TIntegerField;
    itoparcial: TUniQuery;
    itoparcialprocodigo: TIntegerField;
    itoparcialpronome: TStringField;
    itoparcialitoquantidade: TFloatField;
    itoparcialunisimbolo: TStringField;
    itoparcialitovalorav: TFloatField;
    itoparcialitototalav: TFloatField;
    itoparcialitoitem: TIntegerField;
    ditoparc: TUniDataSource;
    tche: TUniQuery;
    dtche: TUniDataSource;
    trdc: TUniQuery;
    dtrdc: TUniDataSource;
    trfimdacodigo: TIntegerField;
    trfinumero: TStringField;
    trdcrdcchave: TIntegerField;
    trdcrdcvalor: TFloatField;
    trdcrdcnrauto: TStringField;
    trdcrdcvalorope: TFloatField;
    trdcrdcsituacao: TIntegerField;
    trdcrdcdata: TDateField;
    trdcadccodigo: TIntegerField;
    trdcrdcparcelas: TIntegerField;
    trdctescodigo: TIntegerField;
    trdcmdacodigo: TIntegerField;
    dConsulta: TUniDataSource;
    msaocupada: TUniQuery;
    msaocupadaorcmesa: TIntegerField;
    msaocupadastocodigo: TIntegerField;
    orcstoidentificacao: TStringField;
    orcdlv: TUniQuery;
    orcdlvorcchave: TIntegerField;
    orcdlvetdidentificacao: TStringField;
    orcdlvorctelefone: TStringField;
    orcdlvmoccodigo: TIntegerField;
    orcdlvstocodigo: TIntegerField;
    orcdlvedrbairro: TStringField;
    orcdlvcidade: TStringField;
    orcdlvetgidentificacao: TStringField;
    orcdlvorctotalav: TFloatField;
    dorcdlv: TUniDataSource;
    orcdlvsel: TStringField;
    itodlv: TUniQuery;
    ditodlv: TUniDataSource;
    itodlvprocodigo: TIntegerField;
    itodlvpronome: TStringField;
    itodlvitoquantidade: TFloatField;
    itodlvunisimbolo: TStringField;
    itodlvitovalorav: TFloatField;
    itodlvitototalav: TFloatField;
    itodlvitoitem: TIntegerField;
    Item: TUniQuery;
    Itemitoitem: TIntegerField;
    Itemprocodigo: TIntegerField;
    Itempronome: TStringField;
    Itemitoquantidade: TFloatField;
    Itemunisimbolo: TStringField;
    Itemitovalorav: TFloatField;
    Itemitototalav: TFloatField;
    ItemBorda: TUniQuery;
    ItemBordaitoitem: TIntegerField;
    ItemBordabrdidentificacao: TStringField;
    ItemSabor: TUniQuery;
    ItemSaboritoitem: TIntegerField;
    ItemSaborsbridentificacao: TStringField;
    ItemSaborsbichave: TIntegerField;
    ItemIngredienteFra: TUniQuery;
    ItemIngredienteFraitoitem: TIntegerField;
    ItemIngredienteFraprocodigo: TIntegerField;
    ItemIngredienteFraisitipo: TIntegerField;
    ItemIngredienteFrasbiobs: TStringField;
    ItemIngredienteFraingnome: TStringField;
    ItemIngredienteFratsiidentificacao: TStringField;
    ItemIngredienteNormal: TUniQuery;
    itoimmnumepedido: TIntegerField;
    ItemIngredienteNormalitoitem: TIntegerField;
    ItemIngredienteNormalprocodigo: TIntegerField;
    ItemIngredienteNormalisitipo: TIntegerField;
    ItemIngredienteNormalsbiobs: TStringField;
    ItemIngredienteNormalingnome: TStringField;
    ItemIngredienteNormaltsiidentificacao: TStringField;
    oltltechave: TIntegerField;
    unm: TUniQuery;
    unmunmchave: TIntegerField;
    unmorcchave: TIntegerField;
    vtmesa: TFDMemTable;
    dvtmesa: TUniDataSource;
    vtmesaid: TIntegerField;
    vtmesamesa: TStringField;
    vtmesasel: TIntegerField;
    vtmsajuncao: TFDMemTable;
    dvtmsajuncao: TUniDataSource;
    vtmsajuncaoid: TIntegerField;
    vtmsajuncaomesa: TStringField;
    msaocupadaitem: TIntegerField;
    olttipobaixa: TIntegerField;
    sbrtipo: TIntegerField;
    trfmesasel: TIntegerField;
    fIngredientetipo: TIntegerField;
    fIngredientesfnid: TIntegerField;
    fIngredientesfncodigo: TIntegerField;
    brdsel: TIntegerField;
    unmorcmesa: TIntegerField;
    unmunmmesa: TIntegerField;
    sbrtsicodigo: TIntegerField;
    titocopos: TIntegerField;
    titopratos: TIntegerField;
    vtItenscopos: TIntegerField;
    vtItenspratos: TIntegerField;
    msaocupadaorcchave: TIntegerField;
    orcorcimpressao: TIntegerField;
    itoimmhorapedido: TStringField;
    msapgto: TUniQuery;
    msapgtoorcchave: TIntegerField;
    msapgtoorcdataabert: TDateField;
    msapgtoorctotalav: TFloatField;
    msapgtoorchoraencerr: TTimeField;
    oltlteprincipal: TFloatField;
    oltltedesconto: TFloatField;
    titoqtde: TFloatField;
    grpsbrfracionado: TIntegerField;
    sbrsbrfracionado: TIntegerField;
    titemqtde: TFloatField;
    BuscaPro: TUniQuery;
    BuscaProprocodigo: TIntegerField;
    BuscaProgrpcodigo: TIntegerField;
    BuscaProtpocodigo: TIntegerField;
    BuscaProsfnqtde: TIntegerField;
    BuscaProsbrfracionado: TIntegerField;
    orcdlvimmhorapedido: TDateTimeField;
    orcdlvimmhoraentrega: TDateTimeField;
    msapgtomesa: TStringField;
    orcdlvimmnumepedido: TIntegerField;
    orcdlvetdcodigo: TIntegerField;
    cfgmcfgcfgmgoupedidounificado: TIntegerField;
    cfgmcfgcfgmgouproatendimento: TIntegerField;
    cfgmcfgcfgmgoutaxaatendimento: TFloatField;
    itoimmmodo: TIntegerField;
    imm: TUniQuery;
    immimmchave: TIntegerField;
    immitochave: TIntegerField;
    immtcicodigo: TIntegerField;
    immimmmodo: TIntegerField;
    immimmhoraimprimir: TDateTimeField;
    immimmhoraimpresso: TDateTimeField;
    immimmhoraentrega: TDateTimeField;
    immimmrecebido: TIntegerField;
    immdorchave: TIntegerField;
    immimmdestino: TIntegerField;
    immimmtemporetardo: TIntegerField;
    immimmmodoimpressao: TIntegerField;
    immimmgarsom: TIntegerField;
    immtrmcodigo: TIntegerField;
    immimmhorapedido: TDateTimeField;
    immimmnumepedido: TIntegerField;
    immimmidentificacao: TStringField;
    immimmimpresso: TIntegerField;
    immimmentregue: TIntegerField;
    immccxchave: TIntegerField;
    immcznchave: TIntegerField;
    immetdcodigoent: TIntegerField;
    immimmpratos: TIntegerField;
    immimmcopos: TIntegerField;
    immimmnumepedidoint: TIntegerField;
    immclbcodigo: TIntegerField;
    cfgmcfgcfgviascomprovante: TIntegerField;
    act: TUniQuery;
    actactcodigo: TIntegerField;
    dau: TUniQuery;
    cfgmcfgflacodigo: TIntegerField;
    gpd: TUniQuery;
    gpdgpdchave: TIntegerField;
    gpdgpdorcpdv: TIntegerField;
    gpdgpdorcgor: TIntegerField;
    cpb: TUniQuery;
    cpbprocodigo: TIntegerField;
    cfgmcfgcfgdigitosbalanca: TIntegerField;
    cfgmcfgcfgetiquetabalanca: TIntegerField;
    MobAbreMesa: TUniStoredProc;
    itoclbpediu: TStringField;
    msapgtoetdidentificacao: TStringField;
    ets: TUniQuery;
    etsetscodigo: TIntegerField;
    etstsecodigo: TIntegerField;
    etsetdcodigo: TIntegerField;
    etsetsdata: TDateField;
    etsetshistorico: TStringField;
    disponivel: TUniQuery;
    disponivelrfisaldocapital: TFloatField;
    limite: TUniQuery;
    limiteetdcodigo: TIntegerField;
    limiteetllimitetotal: TFloatField;
    Dccx: TDataSource;
    ccx: TUniQuery;
    ccxccxchave: TIntegerField;
    ccxclbcodigo: TIntegerField;
    ccxctacodigo: TIntegerField;
    ccxccxturno: TIntegerField;
    ccxccxdataber: TDateField;
    ccxccxhoraaber: TTimeField;
    ccxccxsaldoaber: TFloatField;
    ccxccxdatafecha: TDateField;
    ccxccxhorafecha: TTimeField;
    ccxccxsaldofecha: TFloatField;
    ccxccxsangrias: TFloatField;
    ccxccxsuprimentos: TFloatField;
    trdcbdccodigo: TIntegerField;
    itodlvclbconferencia: TIntegerField;
    tit: TUniQuery;
    tittitcodigo: TIntegerField;
    titetdcodigo: TIntegerField;
    tittitnumero: TStringField;
    tittitvalor: TFloatField;
    tittitemissao: TDateField;
    tittitvctoinicial: TDateField;
    tittfdcodigo: TIntegerField;
    titsrfcodigo: TIntegerField;
    tittficodigo: TIntegerField;
    tittithora: TTimeField;
    tittithistorico: TStringField;
    titclbcodigo: TIntegerField;
    tittitvalorparcela: TFloatField;
    tittitparcelas: TIntegerField;
    tittitprevisao: TIntegerField;
    titmoecodigo: TIntegerField;
    tittitmoradia: TFloatField;
    tittitvalomulta: TFloatField;
    tittitpercmesmora: TFloatField;
    tittitvalodesc: TFloatField;
    tittitpercmulta: TFloatField;
    titflacodigo: TIntegerField;
    titbcocodigo: TStringField;
    titcarcodigo: TIntegerField;
    tittitdiasmulta: TIntegerField;
    tittitdiasdesc: TIntegerField;
    rfi: TUniQuery;
    rfirfichave: TIntegerField;
    rfietdcodigo: TIntegerField;
    rfitfdcodigo: TIntegerField;
    rfiflacodigo: TIntegerField;
    rfitficodigo: TIntegerField;
    rfibcocodigo: TStringField;
    rficarcodigo: TIntegerField;
    rfirfiemissao: TDateField;
    rfirfivencimento: TDateField;
    rfirfinumero: TStringField;
    rfirfivalor: TFloatField;
    rfirfihistorico: TStringField;
    rfisrfcodigo: TIntegerField;
    rfifrrcodigo: TIntegerField;
    rfirfimoradia: TFloatField;
    rfirfipercmesmora: TFloatField;
    rfirfirepetir: TIntegerField;
    rfirfiprevisao: TIntegerField;
    rfirfivalorparcela: TFloatField;
    rfimoecodigo: TIntegerField;
    rfititcodigo: TIntegerField;
    rfm: TUniQuery;
    rfmrfmchave: TIntegerField;
    rfmrfichave: TIntegerField;
    rfmmeschave: TIntegerField;
    rfmflacodigo: TIntegerField;
    mfi: TUniQuery;
    mfimfichave: TIntegerField;
    mfirfichave: TIntegerField;
    mfitmfcodigo: TIntegerField;
    mfimoecodigo: TIntegerField;
    mfimfivalor: TFloatField;
    mfimfidata: TDateField;
    mfimfihistorico: TStringField;
    mfimfivalorori: TFloatField;
    mfimfiparcela: TIntegerField;
    mfiflacodigo: TIntegerField;
    mlt: TUniQuery;
    mltmltchave: TIntegerField;
    mltmfichave: TIntegerField;
    mltltechave: TIntegerField;
    mltflacodigo: TIntegerField;
    etdetldescontopadrao: TFloatField;
    cfgmcfgcfgusapdv: TIntegerField;
    RegistraRefeicao: TUniStoredProc;
    tickets: TUniQuery;
    oltmes: TUniQuery;
    oltmesmeschave: TIntegerField;
    UniTransaction: TUniTransaction;
    rdc: TUniQuery;
    rdcrdcvalor: TFloatField;
    rdcrdcnrauto: TStringField;
    rdcrdcvalorope: TFloatField;
    rdcrdcsituacao: TIntegerField;
    rdcrdcdata: TDateField;
    rdcadccodigo: TIntegerField;
    rdcrdcparcelas: TIntegerField;
    rdctescodigo: TIntegerField;
    rdcbdccodigo: TIntegerField;
    dtl: TUniQuery;
    ltr: TUniQuery;
    ltrltrchave: TIntegerField;
    ltrrdcchave: TIntegerField;
    ltrdtlchave: TIntegerField;
    dtldtlchave: TIntegerField;
    dtlltechave: TIntegerField;
    dtlcedcodigo: TIntegerField;
    dtldtlvalor: TFloatField;
    dtlmdacodigo: TIntegerField;
    dtldtlvalorinfo: TFloatField;
    dtlflacodigo: TIntegerField;
    rdcrdcchave: TIntegerField;
    vrdc: TUniQuery;
    vrdcrdcchave: TIntegerField;
    vrdcrdcvalor: TFloatField;
    vrdcrdcnrauto: TStringField;
    vrdcrdcvalorope: TFloatField;
    vrdcrdcsituacao: TIntegerField;
    vrdcrdcdata: TDateField;
    vrdcadccodigo: TIntegerField;
    vrdcrdcparcelas: TIntegerField;
    vrdctescodigo: TIntegerField;
    vrdcmdacodigo: TIntegerField;
    vrdcbdccodigo: TIntegerField;
    imc: TUniQuery;
    imcimcchave: TIntegerField;
    imcclbcodigo: TIntegerField;
    imcitmchave: TIntegerField;
    imcimcpercentual: TFloatField;
    imcflacodigo: TIntegerField;
    itm: TUniQuery;
    itmitochave: TIntegerField;
    itoclbpedido: TIntegerField;
    itmitmchave: TIntegerField;
    itmflacodigo: TIntegerField;
    orcdlvorcobs: TStringField;
    trfmesamesa: TStringField;
    itoimc: TUniQuery;
    itoimcitochave: TIntegerField;
    itoimcitoitem: TIntegerField;
    itoimcprocodigo: TIntegerField;
    itoimcpronome: TStringField;
    itoimcitoquantidade: TFloatField;
    itoimcunisimbolo: TStringField;
    itoimcitovalorav: TFloatField;
    itoimcitototalav: TFloatField;
    itoimcpuncodigo: TIntegerField;
    itoimcstocodigo: TIntegerField;
    itoimcstoidentificacao: TStringField;
    itoimcimmnumepedido: TIntegerField;
    itoimcimmhorapedido: TStringField;
    itoimcimmmodo: TIntegerField;
    itoimcclbpediu: TStringField;
    itoimcclbpedido: TIntegerField;
    cfgmcfgcfgmgouttulocomposicao: TStringField;
    immtransf: TUniQuery;
    immtransfimmchave: TIntegerField;
    immtransfitochave: TIntegerField;
    immtransftcicodigo: TIntegerField;
    immtransfimmmodo: TIntegerField;
    immtransfimmhoraimprimir: TDateTimeField;
    immtransfimmhoraimpresso: TDateTimeField;
    immtransfimmhoraentrega: TDateTimeField;
    immtransfimmrecebido: TIntegerField;
    immtransfdorchave: TIntegerField;
    immtransfimmdestino: TIntegerField;
    immtransfimmtemporetardo: TIntegerField;
    immtransfimmmodoimpressao: TIntegerField;
    immtransfimmgarsom: TIntegerField;
    immtransftrmcodigo: TIntegerField;
    immtransfimmhorapedido: TDateTimeField;
    immtransfimmnumepedido: TIntegerField;
    immtransfimmidentificacao: TStringField;
    immtransfimmimpresso: TIntegerField;
    immtransfimmentregue: TIntegerField;
    immtransfccxchave: TIntegerField;
    immtransfcznchave: TIntegerField;
    immtransfetdcodigoent: TIntegerField;
    immtransfimmpratos: TIntegerField;
    immtransfimmcopos: TIntegerField;
    immtransfimmnumepedidoint: TIntegerField;
    immtransfclbcodigo: TIntegerField;
    cfgmcfgcfgmgouproatendimentoparcial: TIntegerField;
    itomesa: TUniQuery;
    itomesaitochave: TIntegerField;
    itomesaitoitem: TIntegerField;
    itomesaprocodigo: TIntegerField;
    itomesapronome: TStringField;
    itomesaitoquantidade: TFloatField;
    itomesaunisimbolo: TStringField;
    itomesaitovalorav: TFloatField;
    itomesaitototalav: TFloatField;
    itomesapuncodigo: TIntegerField;
    itomesastocodigo: TIntegerField;
    itomesastoidentificacao: TStringField;
    itomesaimmnumepedido: TIntegerField;
    itomesaimmhorapedido: TStringField;
    itomesaimmmodo: TIntegerField;
    itomesaclbpediu: TStringField;
    itomesaclbpedido: TIntegerField;
    itorec: TUniQuery;
    Ditorec: TDataSource;
    itorecitochave: TIntegerField;
    itorecitoitem: TIntegerField;
    itorecprocodigo: TIntegerField;
    itorecpronome: TStringField;
    itorecitoquantidade: TFloatField;
    itorecunisimbolo: TStringField;
    itorecitovalorav: TFloatField;
    itorecpuncodigo: TIntegerField;
    itorecstocodigo: TIntegerField;
    itorecstoidentificacao: TStringField;
    itorecimmnumepedido: TIntegerField;
    itorecimmhorapedido: TStringField;
    itorecimmmodo: TIntegerField;
    itorecclbpediu: TStringField;
    itorecclbpedido: TIntegerField;
    itosbrfracionado: TIntegerField;
    trorec: TUniQuery;
    trorecorcchaveorigem: TIntegerField;
    trorectrochave: TIntegerField;
    trorecorcchavedestino: TIntegerField;
    msapgtostocodigo: TIntegerField;
    msapgtostoidentificacao: TStringField;
    tropar: TUniQuery;
    tdtlccxchave: TIntegerField;
    tdtldtlregistro: TDateTimeField;
    oltltesituacao: TStringField;
    tisiisiitem: TIntegerField;
    tisibprchave: TIntegerField;
    bpr: TUniQuery;
    bprbprchave: TIntegerField;
    bprpronome: TStringField;
    bprprocodigo: TIntegerField;
    bprprocodigoborda: TIntegerField;
    Dbpr: TDataSource;
    tisiisiquantidade: TIntegerField;
    vtfIngquantidade: TIntegerField;
    fIngredienteisiquantidade: TIntegerField;
    Adcisiquantidade: TIntegerField;
    etstseidentificacao: TStringField;
    cfgmcfgcfgcontrolalimite: TIntegerField;
    ttroclbcodigo: TIntegerField;
    ttroregistro: TDateTimeField;
    troclbcodigo: TIntegerField;
    trotroregistro: TDateTimeField;
    vtsbradctsitipo: TIntegerField;
    tsq: TUniQuery;
    tsqtsqcodigo: TIntegerField;
    tsqtsqidentificacao: TStringField;
    fIngredientetsiidentificacao: TStringField;
    Adctsiopcao: TStringField;
    Adctipo: TIntegerField;
    ItemIngredienteNormalisiquantidade: TIntegerField;
    ItemIngredienteFraisiquantidade: TIntegerField;
    ItemIngredienteFrapunprecoav: TFloatField;
    ItemIngredienteNormalpunprecoav: TFloatField;
    titototal: TCurrencyField;
    gri: TUniQuery;
    grirelarquivo: TBlobField;
    recalculaadional: TUniQuery;
    recalculaadionalpunprecoav: TFloatField;
    itorecalculoadicional: TUniQuery;
    itorecalculoadicionalitochave: TIntegerField;
    ajustaadicional: TUniQuery;
    cfgmcfgcfgprevisualizarimpressao: TIntegerField;
    vIngrediente: TFDMemTable;
    vIngredientesbrcodigo: TIntegerField;
    vIngredienteprocodigo: TIntegerField;
    vIngredientepronome: TStringField;
    vIngredientetsicodigo: TIntegerField;
    vIngredientetipo: TIntegerField;
    vIngredienteobs: TStringField;
    vIngredientesfnid: TIntegerField;
    vIngredientesfncodigo: TIntegerField;
    vIngredienteisiquantidade: TIntegerField;
    vIngredientetsiidentificacao: TStringField;
    itoorcchave: TIntegerField;
    itoitoacrescimoav: TCurrencyField;
    titoitoacrescimoav: TFloatField;
    titemitoacrescimoav: TFloatField;
    situacaoetd: TUniQuery;
    FechaMesaParcial: TUniStoredProc;
    itorecitodescontoav: TFloatField;
    itorecitototalav: TFloatField;
    msapgtoclbcodigo: TIntegerField;
    orcdlvstoidentificacao: TStringField;
    itodlvitoacrescimoav: TFloatField;
    UniDataSource1: TUniDataSource;
    ttfm: TUniQuery;
    ttfmID: TIntegerField;
    ttfmorcchave: TIntegerField;
    ttfmmesa: TStringField;
    ttfmorcmesa: TIntegerField;
    ttfmclbcodigo: TIntegerField;
    ttfmregistro: TDateTimeField;
    orctfm: TUniQuery;
    tfm: TUniQuery;
    tfmtfmchave: TIntegerField;
    tfmorcchaveorigem: TIntegerField;
    tfmorcchavedestino: TIntegerField;
    tfmclbcodigo: TIntegerField;
    tfmtfmregistro: TDateTimeField;
    ajustaitoitem: TUniQuery;
    msapgtooltidentificacao: TStringField;
    msapgtoolttipo: TIntegerField;
    cfgmcfgcfgmgounomelocal: TStringField;
    cfgmcfgcfgmgouqtdmesas: TIntegerField;
    numeroauto: TUniQuery;
    numeroautorfichave: TIntegerField;
    numeroautordcnrauto: TStringField;
    numeroautoadcliquidaautomatico: TIntegerField;
    numeroautorfivalor: TCurrencyField;
    caixas: TUniQuery;
    DsCaixas: TUniDataSource;
    sqlticket: TUniQuery;
    dsSqlTicket: TUniDataSource;
    orcccxchave: TIntegerField;
    itmitmitem: TIntegerField;
    imp: TUniQuery;
    itmproducao: TUniQuery;
    cfgmcfgcfgmgoufinalizadelivery: TIntegerField;
    itoresumo: TUniQuery;
    itoresumoitochave: TIntegerField;
    itoresumoitoitem: TIntegerField;
    itoresumoprocodigo: TIntegerField;
    itoresumopronome: TStringField;
    itoresumoitoquantidade: TFloatField;
    itoresumounisimbolo: TStringField;
    itoresumoitovalorav: TFloatField;
    itoresumoitototalav: TFloatField;
    itoresumopuncodigo: TIntegerField;
    itoresumostocodigo: TIntegerField;
    itoresumostoidentificacao: TStringField;
    itoresumoorcchave: TIntegerField;
    itoresumoitoacrescimoav: TCurrencyField;
    UniDataSource2: TUniDataSource;
    dsitoresumo: TUniDataSource;
    creditos: TUniQuery;
    creditosrcrchave: TIntegerField;
    creditostcridentificacao: TStringField;
    creditostscidentificacao: TStringField;
    creditosetdidentificacao: TStringField;
    creditosetdcodigo: TIntegerField;
    creditoscedcodigo: TIntegerField;
    creditosrcrdata: TDateField;
    creditosrcrhistorico: TStringField;
    creditosmcechave: TIntegerField;
    creditostmcidentificacao: TStringField;
    creditostmccodigo: TIntegerField;
    creditosclbcodigo: TIntegerField;
    creditosclbidentificacao: TStringField;
    creditosrcrvalor: TFloatField;
    creditosmcrvalorbaixa: TFloatField;
    creditosrcrsaldo: TFloatField;
    creditosmcemotivo: TStringField;
    creditosmecregistro: TDateTimeField;
    creditostcrcodigo: TIntegerField;
    creditostsccodigo: TIntegerField;
    creditostnccodigo: TIntegerField;
    creditosrcrhora: TTimeField;
    creditostsccodigo_1: TIntegerField;
    mce: TUniQuery;
    mcemcechave: TIntegerField;
    mcercrchave: TIntegerField;
    mcetmccodigo: TIntegerField;
    mceclbcodigo: TIntegerField;
    mcemcemotivo: TStringField;
    mcemecregistro: TDateTimeField;
    mceltechave: TIntegerField;
    mcr: TUniQuery;
    mcrmcrchave: TIntegerField;
    mcrrcrchave: TIntegerField;
    mcrmcrvalor: TFloatField;
    mcrmcechave: TIntegerField;
    ccxs: TUniQuery;
    DSccxs: TUniDataSource;
    msaocupadaorcimpressao: TIntegerField;
    orcdlvendereco: TStringField;
    msaimprime: TUniQuery;
    msaimprimeorcmesa: TIntegerField;
    msaimprimestocodigo: TIntegerField;
    msaimprimeitem: TIntegerField;
    msaimprimeorcchave: TIntegerField;
    msaimprimeorcimpressao: TIntegerField;
    dmsaimprime: TUniDataSource;
    sbrfra: TUniQuery;
    cfgmcfgcfgusaadc: TIntegerField;
    rfirdcnrauto: TStringField;
    dtlrdcnrauto: TStringField;
    FDMemTable1: TFDMemTable;
    punpunbarra: TStringField;
    procpunbarra: TStringField;
    bprbrdcodigo: TIntegerField;
    titoclbatendente: TIntegerField;
    orcorcdataabert: TDateField;
    cfgmcfgcfgnumecertif: TStringField;
    cfgmcfgcfgsenhacertificadoa1: TStringField;
    orccznchave: TIntegerField;
    cfgmcfgcfgctacaixa: TIntegerField;
    cfgmcfgcfgctacodigopix: TIntegerField;
    cfgmcfgcfgusanfe: TIntegerField;
    cfgmcfgcfgusanfc: TIntegerField;
    itoimmhoraimpresso: TStringField;
    toetaxa: TUniQuery;
    cfgmcfgcfgusaafaturar: TIntegerField;
    taxaparcial: TUniQuery;
    itmtrib: TUniQuery;
    itmtribcstcodigo: TStringField;
    itmtribitmvalor: TFloatField;
    itmtribitmdesconto: TFloatField;
    itmtribitmtotal: TFloatField;
    itmtribtoecodigo: TIntegerField;
    itmtribcfocfop: TStringField;
    itmtribitmbicm: TFloatField;
    itmtribicmcodigo: TStringField;
    itmtribitmaliqicm: TStringField;
    itmtribitmicm: TFloatField;
    itmtribitmbicms: TFloatField;
    itmtribitmaliqicms: TFloatField;
    itmtribitmicms: TFloatField;
    itmtribitmapuipi: TStringField;
    itmtribcsicodigo: TStringField;
    itmtribceicodigo: TStringField;
    itmtribitmbipi: TFloatField;
    itmtribitmaliqipi: TFloatField;
    itmtribitmipi: TFloatField;
    itmtribcspcodigo: TStringField;
    itmtribitmbpis: TFloatField;
    itmtribitmaliqpis: TFloatField;
    itmtribitmpis: TFloatField;
    itmtribitmquantpis: TFloatField;
    itmtribitmaliqpisvalor: TFloatField;
    itmtribitmbcofins: TFloatField;
    itmtribcsfcodigo: TStringField;
    itmtribitmaliqcofins: TFloatField;
    itmtribitmquantcofins: TFloatField;
    itmtribitmaliqcofinsvalor: TFloatField;
    itmtribitmcofins: TFloatField;
    itmtribcfocfopdestinacao: TStringField;
    itmtribitmoutras: TFloatField;
    itmtribitmseguro: TFloatField;
    itmtribitmfrete: TFloatField;
    itmtribitmpercreducaobaseicm: TFloatField;
    itmtribitmmva: TFloatField;
    itmtribitmvalofcpicm: TFloatField;
    itmtribitmbasefcpicm: TFloatField;
    itmtribitmpercfcpicm: TFloatField;
    itmtribitmchave: TIntegerField;
    itmtribmeschave: TIntegerField;
    mestrib: TUniQuery;
    mestribmeschave: TIntegerField;
    mestribtoecodigo: TIntegerField;
    mestribmesvalor: TFloatField;
    mestribmesdesconto: TFloatField;
    mestribmestotal: TFloatField;
    mestribmesfrete: TFloatField;
    mestribmesseguro: TFloatField;
    mestribmesoutras: TFloatField;
    mestribmesbicm: TFloatField;
    mestribmesicm: TFloatField;
    mestribmesbicms: TFloatField;
    mestribmesicms: TFloatField;
    mestribmesipi: TFloatField;
    mestribmespis: TFloatField;
    mestribmescofins: TFloatField;
    mestribmespiss: TFloatField;
    mestribmescofinss: TFloatField;
    icm: TUniQuery;
    icmicmcodigo: TStringField;
    icmicmaliquotas: TStringField;
    protrib: TUniQuery;
    protribprocodigo: TIntegerField;
    protribicmcodigo: TStringField;
    protribtpocodigo: TIntegerField;
    protribproncm: TStringField;
    protribcstcodigo: TStringField;
    protribcsicodigo: TStringField;
    protribcspcodigo: TStringField;
    protribcsfcodigo: TStringField;
    protribprounitrib: TIntegerField;
    protribpropisaliquota: TFloatField;
    protribprocofinsaliquota: TFloatField;
    protribprocest: TStringField;
    protribpromva: TStringField;
    protribcfocfopfora: TStringField;
    protribcfocfop: TStringField;
    protribpropercfcp: TStringField;
    protribicmcodigofora: TStringField;
    itmtribprocodigo: TIntegerField;
    itmtribitmquantidade: TFloatField;
    protribpropercreducaobaseicm: TFloatField;
    pco: TUniQuery;
    pcopcocodigo: TIntegerField;
    pcoprocodigo: TIntegerField;
    pcopcosubproduto: TIntegerField;
    pcounicodigo: TIntegerField;
    pcopcoquantidade: TFloatField;
    pcopcosaborfixo: TIntegerField;
    itotpocodigo: TIntegerField;
    itogrpidentificacao: TStringField;
    servicos: TUniQuery;
    produtos: TUniQuery;
    itoitooutras: TCurrencyField;
    Descontomes: TUniQuery;
    ltedesconto: TUniQuery;
    idcoic: TUniQuery;
    oic: TUniQuery;
    oicoicchave: TIntegerField;
    oicidccodigo: TIntegerField;
    oicorcchave: TIntegerField;
    rdcdtlchave: TIntegerField;
    trdcrdcvia1: TStringField;
    dtltef: TUniQuery;
    dtltefltechave: TIntegerField;
    dtltefmdaidentificacao: TStringField;
    dtltefdtlvalor: TFloatField;
    dtltefmdacodigo: TIntegerField;
    rdctef: TUniQuery;
    trm: TUniQuery;
    trmtrmcodigo: TIntegerField;
    trmtrmidentificacao: TStringField;
    trmtciporta: TStringField;
    trmecfcodigo: TIntegerField;
    trmtipcodigo: TIntegerField;
    trmctacodigo: TIntegerField;
    trmtrmbalamodelo: TStringField;
    trmtrmbalaporta: TStringField;
    trmtrmbalabaud: TStringField;
    trmtrmbalahandshake: TStringField;
    trmtrmbalaparity: TStringField;
    trmtrmbalastop: TStringField;
    trmtrmbaladata: TStringField;
    trmtrmgaveta: TIntegerField;
    trmtrmestabelecimentotipotef: TStringField;
    trmtrmterminalcomprovante1via: TStringField;
    dtltefdtlchave: TIntegerField;
    rdcrdccomprovante1via: TStringField;
    rdcrdccomprovante2via: TStringField;
    adctef: TUniQuery;
    orctef: TUniQuery;
    dtltefparcial: TUniQuery;
    dtltefparcialdtlchave: TIntegerField;
    dtltefparcialltechave: TIntegerField;
    dtltefparcialmdaidentificacao: TStringField;
    dtltefparcialdtlvalor: TFloatField;
    dtltefparcialmdacodigo: TIntegerField;
    rct: TUniQuery;
    consultacomprovante: TUniQuery;
    centavos: TUniQuery;
    itoitodescontoav: TCurrencyField;
    dadosrelatorio: TUniQuery;
    DSDadosRelatorio: TUniDataSource;
    mor: TUniQuery;
    itodes: TUniQuery;
    trmtrmintegrapagarme: TIntegerField;
    trmstone: TUniQuery;
    trmstonetrmcodigo: TIntegerField;
    trmstonetrmintegrapagarme: TIntegerField;
    rpwemaberto: TUniQuery;
    rpwemabertorpwchave: TIntegerField;
    rpwemabertorpwtoken: TStringField;
    rpwemabertorpwmesa: TStringField;
    rpwemabertorpwstatus: TStringField;
    rpwemabertoorcchave: TIntegerField;
    rpw: TUniQuery;
    rpwrpwchave: TIntegerField;
    rpwrpwtoken: TStringField;
    rpwrpwmesa: TStringField;
    rpwrpwstatus: TStringField;
    rpworcchave: TIntegerField;
    cfgmcfgcfgmgouprorefeicao: TIntegerField;
    itoref: TUniQuery;
    mfimlt: TUniQuery;
    oltmlt: TUniQuery;
    ltemlt: TUniQuery;
    lteclt: TUniQuery;
    ccodtl: TUniQuery;
    rfmrfi: TUniQuery;
    ccoclt: TUniQuery;
    dtlclt: TUniQuery;
    procedure fIngredienteAfterPost(DataSet: TDataSet);
    procedure fIngredienteBeforeDelete(DataSet: TDataSet);
    procedure trfiBeforeScroll(DataSet: TDataSet);
    procedure trfidtvectoSetText(Sender: TField; const Text: string);
    procedure dorcdlvDataChange(Sender: TObject; Field: TField);
    procedure UniTransactionError(Sender: TObject; E: EDAError; var Fail: Boolean);
    procedure MobAbreMesaDeleteError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
    procedure MobAbreMesaEditError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
    procedure MobAbreMesaPostError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
    procedure MobGravaItensDeleteError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
    procedure MobGravaItensEditError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
    procedure MobGravaItensPostError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
    procedure ConexaoAfterConnect(Sender: TObject);
    procedure ConexaoConnectionLost(Sender: TObject; Component: TComponent; ConnLostCause: TConnLostCause; var RetryMode: TRetryMode);
    procedure dfIngredienteDataChange(Sender: TObject; Field: TField);
    procedure titoAfterInsert(DataSet: TDataSet);
  private
    procedure ImprimirComprovantesTEF(Owner: TApplication; vConexao: TUniConnection; vTrmCodigo, vDirRelat, vImpressora: String;
      vTipoImpressao: Integer);

    { Private declarations }
  public
    { Public declarations }
    vpTentativasReconexoes: Integer;
    function ImprimirViaTEF: Boolean;
  Var
    DtAtual: TDateTime;
    vpValidaData: Boolean;
    vpConsultouSefaz: Boolean;
    vpConfigIni: TIniFile;

    Usuario: TUsuario;
    Balaca: TBalanca;

    function ConsultaSQL(Script: String): Boolean;
    function ExecutaSQL(Script: String): Boolean;
    function AjustaGrid(DbGrid: TDbGrid): Boolean;
    function AjustaGridFit(DbGrid: TDbGrid): Boolean;
    function ValidaValor(Edit: TEdit; var Valor: Currency): Boolean;
    function TBRound(Value: Extended; Decimals: Integer): Extended;
    function CountSubStr(substr, texto: string): Integer;

  end;

var
  DmDados: TDmDados;

implementation



{%CLASSGROUP 'Vcl.Controls.TControl'}
{$R *.dfm}
{ TDmDados }

function TDmDados.AjustaGrid(DbGrid: TDbGrid): Boolean;
var
  TotalColumnWidth, ColumnCount, GridClientWidth, i: Integer;
  vDiffColumnWidth: Integer;
begin
  ColumnCount := DbGrid.Columns.Count;

  if ColumnCount = 0 then
    Exit;

  // compute total width used by grid columns and vertical lines if any
  TotalColumnWidth := 0;
  for i := 0 to ColumnCount - 1 do
    TotalColumnWidth := TotalColumnWidth + DbGrid.Columns[i].Width;
  if dgColLines in DbGrid.Options then
    // include vertical lines in total (one per column)
    TotalColumnWidth := TotalColumnWidth + ColumnCount;

  // compute grid client width by excluding vertical scroll bar, grid indicator,
  // and grid border
  GridClientWidth := DbGrid.Width - GetSystemMetrics(SM_CXVSCROLL);
  if dgIndicator in DbGrid.Options then
  begin
    GridClientWidth := GridClientWidth - IndicatorWidth;
    if dgColLines in DbGrid.Options then
      Dec(GridClientWidth);
  end;

  if DbGrid.BorderStyle = bsSingle then
  begin
    // border is sunken (vertical border is 2 pixels wide)
    if DbGrid.Ctl3D then
      GridClientWidth := GridClientWidth - 4
      // border is one-dimensional (vertical border is one pixel wide)
    else
      GridClientWidth := GridClientWidth - 2;
  end;

  // adjust column widths
  if TotalColumnWidth < GridClientWidth then
  begin
    vDiffColumnWidth := (GridClientWidth - TotalColumnWidth);
    for i := 0 to ColumnCount - 1 do
      DbGrid.Columns[i].Width := DbGrid.Columns[i].Width + Trunc(vDiffColumnWidth * (DbGrid.Columns[i].Width / TotalColumnWidth));;
  end
  else if TotalColumnWidth > GridClientWidth then
  begin
    vDiffColumnWidth := (TotalColumnWidth - GridClientWidth);
    for i := 0 to ColumnCount - 1 do
      DbGrid.Columns[i].Width := DbGrid.Columns[i].Width - Trunc(vDiffColumnWidth * (DbGrid.Columns[i].Width / TotalColumnWidth));
  end;
end;

function TDmDados.AjustaGridFit(DbGrid: TDbGrid): Boolean;
const
  C_Add = 3;
var
  ds: TDataSet;
  bm: TBookmark;
  i: Integer;
  w: Integer;
  a: Array of Integer;
begin
  ds := DbGrid.DataSource.DataSet;
  if Assigned(ds) then
  begin
    ds.DisableControls;
    bm := ds.GetBookmark;
    try
      ds.First;
      SetLength(a, DbGrid.Columns.Count);
      while not ds.Eof do
      begin
        for i := 0 to DbGrid.Columns.Count - 1 do
        begin
          if Assigned(DbGrid.Columns[i].Field) then
          begin
            w := DbGrid.Canvas.TextWidth(ds.Fieldbyname(DbGrid.Columns[i].Field.FieldName).DisplayText);
            if a[i] < w then
              a[i] := w;
          end;
        end;
        ds.Next;
      end;
      // if fieldwidth is smaller than Row 0 (field names) fix
      for i := 0 to DbGrid.Columns.Count - 1 do
      begin
        w := DbGrid.Canvas.TextWidth(DbGrid.Columns[i].Field.FieldName);
        if a[i] < w then
          a[i] := w;
      end;

      for i := 0 to DbGrid.Columns.Count - 1 do
        DbGrid.Columns[i].Width := a[i] + C_Add;
      ds.GotoBookmark(bm);
    finally
      ds.FreeBookmark(bm);
      ds.EnableControls;
    end;
  end;
end;

procedure TDmDados.ConexaoAfterConnect(Sender: TObject);
begin

  Consulta.Close;
  Consulta.SQL.Clear;
  Consulta.SQL.Add('SET innodb_lock_wait_timeout=30000');
  Consulta.ExecSQL;

  Consulta.Close;
  Consulta.SQL.Clear;
  Consulta.SQL.Add('SET @@GLOBAL.sql_mode=' + QuotedStr(''));
  Consulta.ExecSQL;

end;

procedure TDmDados.ConexaoConnectionLost(Sender: TObject; Component: TComponent; ConnLostCause: TConnLostCause; var RetryMode: TRetryMode);
begin
  while vpTentativasReconexoes < 6 do
  begin
    sleep(1000);
    RetryMode := rmReconnectExecute;
    if Conexao.Connected then
      Break;
    if vpTentativasReconexoes > 5 then
    begin
      ShowMessage('Falha de rede, conexão com servidor pedida!');
      Application.Terminate;
    end
    else
    begin
      ShowMessage('Tentativa ' + Inttostr(vpTentativasReconexoes) + ' de 6 de reconexão com sistema.' + #13#13 + 'VEREFIQUE SUA REDE!');
      vpTentativasReconexoes := vpTentativasReconexoes + 1;
    end;
  end;

end;

function TDmDados.ConsultaSQL(Script: String): Boolean;
begin
  if trim(Script) <> '' then
  begin
   try
    Consulta.Close;
    Consulta.SQL.Clear;
    Consulta.SQL.Add(Script);
    Consulta.Open;
   except

   end;

    Result := (not Consulta.IsEmpty);
  end;
end;

function TDmDados.CountSubStr(substr, texto: string): Integer;
var
  i: Integer;
begin
  Result := 0;
  for i := 1 to Length(texto) do
    if (texto[i] = substr) then
      Result := Result + 1;
end;

procedure TDmDados.dfIngredienteDataChange(Sender: TObject; Field: TField);
begin
  { if fIngredientetipo.AsInteger=0 then
    begin
    fIngredientetsiopcao.LookupDataSet:=tsi;
    fIngredientetsiopcao.KeyFields:='tsicodigo';
    fIngredientetsiopcao.LookupKeyFields:='tsicodigo';
    fIngredientetsiopcao.LookupResultField:='tsiidentificacao';

    end
    else
    begin
    fIngredientetsiopcao.LookupDataSet:=tsq;
    fIngredientetsiopcao.KeyFields:='tsqcodigo';
    fIngredientetsiopcao.LookupKeyFields:='tsqcodigo';
    fIngredientetsiopcao.LookupResultField:='tsqidentificacao';
    end; }

end;

procedure TDmDados.dorcdlvDataChange(Sender: TObject; Field: TField);
begin
  DmDados.itodlv.Close;
  DmDados.itodlv.Params[0].AsInteger := DmDados.orcdlvorcchave.AsInteger;
  DmDados.itodlv.Open;
end;

function TDmDados.ExecutaSQL(Script: String): Boolean;
begin
  Consulta.Close;
  Consulta.SQL.Clear;
  Consulta.SQL.Add(Script);
  Consulta.Execute;
  if Consulta.RowsAffected > 0 then
    Result := true
  else
    Result := False;

end;

procedure TDmDados.fIngredienteAfterPost(DataSet: TDataSet);
begin
  if vtfIng.Active then
  begin
    if vtfIng.locate('sbrcodigo;procodigo;tipo', VarArrayOf([fIngredientesbrcodigo.AsInteger, fIngredienteprocodigo.AsInteger, fIngredientetipo.AsInteger]), []) then
    begin
      // caso a quantidade foi alterada novamente faz o reajuste
      vtfIng.Edit;
      vtfIngtsicodigo.AsInteger := fIngredientetsicodigo.AsInteger;
      vtfIng.Post;
    end
    else
      // caso a quantidade do ingrediente tenha sido alterada ou seja um ingrediente adicional
      if (fIngredientetsicodigo.AsInteger <> Usuario.TsiCodigo) or (fIngredientetipo.AsInteger = 1) then
      begin
        vtfIng.Append;
        vtfIngsfnid.AsInteger := fIngredientesfnid.AsInteger;
        vtfIngsfncodigo.AsInteger := fIngredientesfncodigo.AsInteger;
        vtfIngsbrcodigo.AsInteger := fIngredientesbrcodigo.AsInteger;
        vtfIngprocodigo.AsInteger := fIngredienteprocodigo.AsInteger;
        vtfIngtsicodigo.AsInteger := fIngredientetsicodigo.AsInteger;
        vtfIngtipo.AsInteger := fIngredientetipo.AsInteger;
        vtfIng.Post;
      end;
  end;

end;

procedure TDmDados.fIngredienteBeforeDelete(DataSet: TDataSet);
begin
  if vtfIng.locate('sbrcodigo;procodigo;tipo', VarArrayOf([fIngredientesbrcodigo.AsInteger, fIngredienteprocodigo.AsInteger, fIngredientetipo.AsInteger]), []) then
    vtfIng.Delete;
end;

procedure TDmDados.MobAbreMesaDeleteError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
begin
  sleep(2000);
  Action := daRetry;

end;

procedure TDmDados.MobAbreMesaEditError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
begin
  sleep(2000);
  Action := daRetry;

end;

procedure TDmDados.MobAbreMesaPostError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
begin
  sleep(2000);
  Action := daRetry;

end;

procedure TDmDados.MobGravaItensDeleteError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
begin
  sleep(2000);
  Action := daRetry;

end;

procedure TDmDados.MobGravaItensEditError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
begin
  sleep(2000);
  Action := daRetry;

end;

procedure TDmDados.MobGravaItensPostError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
begin
  sleep(2000);
  Action := daRetry;

end;

function TDmDados.TBRound(Value: Extended; Decimals: Integer): Extended;
var
  Factor, Fraction: Extended;
begin
  Factor := IntPower(10, Decimals);

  { A conversão para string e depois para float evita
    erros de arredondamentos indesejáveis. }
  Value := Strtofloat(FloatToStr(Value * Factor));

  Result := Int(Value);
  Fraction := Frac(Value);
  if (Fraction >= 0.5) then
    Result := Result + 1
  else If (Fraction <= -0.5) then
    Result := Result - 1;
  Result := Result / Factor;
end;

procedure TDmDados.titoAfterInsert(DataSet: TDataSet);
begin
  self.titoclbcodigo.AsInteger := DmDados.Usuario.ClbCodigo;
  self.titoclbatendente.AsInteger := DmDados.Usuario.ClbCodigo;

end;

procedure TDmDados.trfiBeforeScroll(DataSet: TDataSet);
begin
  if trfi.State in [dsedit, dsinsert] then
    if (DtAtual > DmDados.trfidtvecto.AsDateTime) and (Not DmDados.trfidtvecto.IsNull) then
    begin
      ShowMessage('Data informada menor que a data Atual, verifique !');
      DmDados.trfi.Edit;
      DmDados.trfidtvecto.AsDateTime := DtAtual;
      DmDados.trfi.Post;
      Exit;
    end;
end;

procedure TDmDados.trfidtvectoSetText(Sender: TField; const Text: string);
var
  vTeste: TDateTime;
begin
  try
    vpValidaData := False;
    vTeste := StrToDate(Text);
    Sender.AsString := Text;
    vpValidaData := true;
  Except
    vpValidaData := False;
    ShowMessage('Data invalida, verifique !');
  end;
end;

procedure TDmDados.UniTransactionError(Sender: TObject; E: EDAError; var Fail: Boolean);
begin
  ShowMessage(E.Message);
  Fail := true;

end;

function TDmDados.ValidaValor(Edit: TEdit; var Valor: Currency): Boolean;
begin
  try
    Result := true;
    Valor := Strtofloat(StringReplace(Edit.Text, '.', '', [rfReplaceAll, rfIgnoreCase]));
    Valor := TBRound(Valor, 2);
  except
    Result := False;
    // Application.MessageBox(PChar(Edit.Name + ': Valor Inválido'), 'Atenção', MB_ICONWARNING + MB_OK);
    Edit.SetFocus;
    Exit;
  end;
end;

Function mrfrImprimirtef(Application: TApplication; Conexao: TUniConnection; Dados: TUniDataSource; DirRelatorio: String; TipoImpressao: Integer; Impressora: String = '';
  vUsuCodigo: string = ''): String;
type
  Impressao = function(AOwner: TComponent; Conexao: TUniConnection; vtabela: TUniDataSource; DirRelatorio: String; Impressora: String = ''; vUsuCodigo: string = ''): string;

Var
  Pack: Cardinal;
  Exec: Impressao;
  vNomeRotina: String;
  Vu: String;
Begin

  vNomeRotina := 'mrfrImpressaoDireta';

  Pack := LoadPackage('modulos\mrfr.bpl');
  If Pack <> 0 Then
    Try
      @Exec := GetProcAddress(Pack, PChar(vNomeRotina));

      If Assigned(Exec) Then
        Vu := Exec(Application, Conexao, Dados, DirRelatorio, Impressora, Vu);

    Finally

    End;

End;


function TDmDados.ImprimirViaTEF: Boolean;
var
  vDirRelat: String;
  i:Integer;
begin
  // try

  vDirRelat := Extractfilepath(Application.ExeName) + 'report\tefcomprovante.fr3';

  if not FileExists(vDirRelat) then
  begin
    Showmessage('Arquivo não localizado: '+vDirRelat);
    exit;
  end;

  ImprimirComprovantesTEF(Application, Conexao, usuario.TrmCodigo.ToString, vDirRelat,'', 2);

  Result := True;

end;



procedure TDmDados.ImprimirComprovantesTEF(Owner: TApplication; vConexao: TUniConnection; vTrmCodigo, vDirRelat, vImpressora: String; vTipoImpressao: Integer);
var
  vtTrm: TUniQuery;
  DSTrm: TUniDataSource;
begin

  vtTrm := TUniQuery.Create(Owner);
  vtTrm.Connection:=vConexao;
  vtTrm.SQL.Text:='select trmcodigo,trmterminalcomprovante1via, trmterminalcomprovante2via from trm '+
                  'where trmcodigo='+vTrmCodigo;
  vtTrm.Open;



  DSTrm := TUniDataSource.Create(Owner);

  try

    DSTrm.DataSet := vtTrm;

    if (length(vtTrm.FieldByName('trmterminalcomprovante1via').AsString)>0) or
       (length(vtTrm.FieldByName('trmterminalcomprovante2via').AsString)>0) then
    begin
      mrfrImprimirtef(Owner, vConexao, DSTrm, vDirRelat, vTipoImpressao, vImpressora);
    end;

  finally
    vtTrm.Free;
    DSTrm.Free;
  end;
end;






end.
