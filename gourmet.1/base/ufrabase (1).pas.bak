unit ufrabase;

interface

uses Winapi.Windows, Vcl.Forms, VirtualTable, Data.DB, MemDS, DBAccess, Uni,
  Vcl.Menus, System.Classes, System.Actions, Vcl.ActnList, Vcl.Buttons, midaslib,
  Vcl.StdCtrls, Vcl.Grids, Vcl.DBGrids, Vcl.Imaging.jpeg, Vcl.ExtCtrls,
  Vcl.Imaging.pngimage, Vcl.Controls, Vcl.ComCtrls, ufuncoes, System.SysUtils,
  Winapi.Messages, Vcl.Dialogs, Vcl.Graphics, IniFiles, CRAccess,
  System.StrUtils, ufrmbase, System.Variants, uPegaBase, Vcl.Mask, Vcl.DBCtrls,
  System.Diagnostics, System.Win.ComObj, System.ImageList, Vcl.ImgList, 
  Xml.xmldom, Xml.XMLIntf, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,
  FireDAC.DApt.Intf, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Xml.XMLDoc, DateUtils,
;

type
  TAcoesSemPermissao = array [0 .. 8] of string;

const
  AcoesSemPermissao: TAcoesSemPermissao = ('ActAtualizar', 'ActConfig', 'ActConfiguracoes', 'ActFiltrar', 'ActPesquisar', 'ActRelatorios', 'ActInstrucoes', 'ActSair',
    'ActVerFiltros');

type
  TFrmBaseClass = class of TFrmBase;

  TFraBase = class(TFrame)
    acoes: TActionList;
    ActIncluir: TAction;
    ActAlterar: TAction;
    ActExcluir: TAction;
    ActAtualizar: TAction;
    ActPesquisar: TAction;
    ActRelatorios: TAction;
    ActFiltrar: TAction;
    ActConfiguracoes: TAction;
    ActSair: TAction;
    DSTabela: TUniDataSource;
    MenuManutencao: TPopupMenu;
    Incluir1: TMenuItem;
    Alterar1: TMenuItem;
    Excluir1: TMenuItem;
    Atualizar1: TMenuItem;
    Pesquisar1: TMenuItem;
    Sair1: TMenuItem;
    PlGeral: TPanel;
    PlBotoes: TPanel;
    ImageLogoBase: TImage;
    PlInfo: TPanel;
    SplBotoes: TSplitter;
    PlLista: TPanel;
    SplLista: TSplitter;
    PlRodaPe: TPanel;
    PlFiltros: TPanel;
    PlSelecao: TPanel;
    PnlGrid: TPanel;
    DBGLista: TDBGrid;
    PnlRodapeGrid: TPanel;
    PlTitulo: TPanel;
    consulta: TUniQuery;
    cls: TUniQuery;
    mdl: TUniQuery;
    mdlmdlcodigo: TIntegerField;
    mdlmdlidentificacao: TStringField;
    mdlmdldescricao: TStringField;
    mdlmdlnome: TStringField;
    mdlmdlconfig: TIntegerField;
    mdlmdlsubgrupo: TStringField;
    dau: TUniQuery;
    dauclbcodigo: TIntegerField;
    dauactcodigo: TIntegerField;
    act: TUniQuery;
    actactcodigo: TIntegerField;
    uqtabela: TUniQuery;
    SBBotoes: TScrollBox;
    daudauativo: TIntegerField;
    cau: TUniQuery;
    cca: TUniQuery;
    caumdlcodigo: TIntegerField;
    cauactcodigo: TIntegerField;
    caucaudata: TDateField;
    caucauhora: TTimeField;
    cauusrautorizou: TIntegerField;
    dcl: TUniQuery;
    dcldclcodigo: TIntegerField;
    dclclscodigo: TIntegerField;
    dclclbcodigo: TIntegerField;
    dcldclvisivel: TIntegerField;
    dcldclpesquisavel: TIntegerField;
    dcldclpesquisa: TIntegerField;
    dcldclnomecampo: TStringField;
    dcldcltitulo: TStringField;
    mConfiguracoes: TMenuItem;
    mFiltrar: TMenuItem;
    fil: TUniQuery;
    filfilcodigo: TIntegerField;
    filclscodigo: TIntegerField;
    filclbcodigo: TIntegerField;
    ifi: TUniQuery;
    ifiifichave: TIntegerField;
    ififilcodigo: TIntegerField;
    ifiifitipocampo: TIntegerField;
    ifiififiltro: TStringField;
    ifiifidescricao: TStringField;
    ifiificampo: TStringField;
    ifiifimetodo: TIntegerField;
    GBPlSelecao: TGroupBox;
    DBLista: TDBGrid;
    Difi: TUniDataSource;
    SpFilter: TSplitter;
    Image1: TImage;
    PlBotoesFiltros: TPanel;
    BFiltroIncluir: TBitBtn;
    BFiltroExcluir: TBitBtn;
    BFiltroAlterar: TBitBtn;
    ifiifititulo: TStringField;
    PlEdTextoBusca: TPanel;
    GrBTextoProcurar: TGroupBox;
    PlGbEdtBusca: TPanel;
    edbusca: TEdit;
    plid: TPanel;
    PlQtdRecno: TPanel;
    ActConfig: TAction;
    BFiltroOcultar: TBitBtn;
    clsclsnomeform: TStringField;
    clsclslargura: TIntegerField;
    clsclsaltura: TIntegerField;
    clsusrcodigo: TIntegerField;
    clsclsmodo: TIntegerField;
    clsclsrodape: TIntegerField;
    clsclsfiltro: TIntegerField;
    clsclstopo: TIntegerField;
    clsclsesquerda: TIntegerField;
    clsclspositopo: TIntegerField;
    clsclsposiesquerda: TIntegerField;
    clsclsbotoes: TIntegerField;
    clsclsselecao: TIntegerField;
    clsclsultimo: TStringField;
    filfilsqloriginal: TStringField;
    PlBotaoFiltro: TPanel;
    ActVerFiltros: TAction;
    PlSair: TPanel;
    clsclsordem: TIntegerField;
    cpg: TUniQuery;
    cpgcpgchave: TIntegerField;
    cpgcpgnomegrid: TStringField;
    cpgcpgcolunas: TBlobField;
    cpgclbcodigo: TIntegerField;
    vcls: TVirtualTable;
    PlBotaoFiltroEsp2: TPanel;
    cpc: TUniQuery;
    cpccpcchave: TIntegerField;
    cpccpgchave: TIntegerField;
    cpccpcordem: TIntegerField;
    cpccpccampo: TStringField;
    cpccpclargura: TIntegerField;
    cpccpctitulo: TStringField;
    cpccpcvisivel: TIntegerField;
    plfiltroEspecial: TPanel;
    clsclscodigo: TIntegerField;
    bSair: TBitBtn;
    clsclsletra: TIntegerField;
    BDiminuiLetra: TBitBtn;
    BAumentaLetra: TBitBtn;
    BLegenda: TBitBtn;
    rel: TUniQuery;
    relbplcodigo: TIntegerField;
    relreltitulo: TStringField;
    relrelnomearquivo: TStringField;
    relrelarquivo: TBlobField;
    relbplfranome: TStringField;
    MenuRelatorios: TPopupMenu;
    este1: TMenuItem;
    relrelidentificacao: TStringField;
    relrelcodigo: TStringField;
    PlBotaoFiltroEsp: TScrollBox;
    BvlSeparador: TBevel;
    spChamaAjuda: TSpeedButton;
    actactacao: TStringField;
    plDataInicial: TPanel;
    spCalenDtInicial: TSpeedButton;
    fmddtinicial: TDBEdit;
    plDataFinal: TPanel;
    spCalenDtFinal: TSpeedButton;
    fmddtfinal: TDBEdit;
    plTipoData: TPanel;
    cbTipoData: TComboBox;
    fmd: TUniQuery;
    gbFiltroPorDatas: TGroupBox;
    Dfmd: TDataSource;
    fmdfmdchave: TIntegerField;
    fmdmdlnome: TStringField;
    fmdclbcodigo: TIntegerField;
    fmdflacodigo: TIntegerField;
    fmdfmdcampo: TStringField;
    fmdfmddtinicial: TDateField;
    fmdfmddtfinal: TDateField;
    fmdfmdtitulo: TStringField;
    plSugestao: TPanel;
    DSSugestao: TDataSource;
    qrySugestao: TUniQuery;
    DBGSugestao: TDBGrid;
    pbotoes: TPanel;
    psituacao: TPanel;
    bConfirmaSelecao: TBitBtn;
    bCancelaSelecao: TBitBtn;
    ifiifiexato: TIntegerField;
    Dsfi: TUniDataSource;
    sfi: TUniQuery;
    sfisfichave: TIntegerField;
    sfiifichave: TIntegerField;
    sfisfitexto: TStringField;
    FechaFiltro: TTimer;
    cbSelecaoExata: TCheckBox;
    btLimpaBusca: TPanel;
    Image2: TImage;
    plseparador: TPanel;
    lou: TUniQuery;
    loulouchave: TIntegerField;
    louclbcodigo: TIntegerField;
    louloudatahora: TDateTimeField;
    loulouaplicacao: TStringField;
    loulouformulario: TStringField;
    loulounomecomponente: TStringField;
    louloutipocomponente: TStringField;
    loulouconteudocomponente: TStringField;
    loulouacaocomponente: TStringField;
    BCorFundo: TSpeedButton;
    ColorDialog: TColorDialog;
    cpgcpgfundo: TIntegerField;
    mnAcessos: TMenuItem;
    sbExcel: TSpeedButton;
    ImageList1: TImageList;
    DBGrid2Excel: TDBGrid2Excel;
    XMLDocument1: TXMLDocument;
    cfgmgou: TUniQuery;
    cfgmgoucfgmgouhoravirada: TTimeField;
    ActInstrucoes: TAction;
    its: TUniQuery;
    itsbplcodigo: TIntegerField;
    itsitsidentificacao: TStringField;
    MenuInstrucoes: TPopupMenu;
    itsitscodigo: TIntegerField;
    itsitspdf: TBlobField;
    cfgalterado: TUniQuery;
    cfgalteradocfgcodigo: TIntegerField;
    cfgalteradocfgalteracao: TDateTimeField;
    stg: TUniQuery;
    stgstgcodigo: TIntegerField;
    stgstgdatacriacao: TDateTimeField;
    stgstgdataalteracao: TDateTimeField;
    stgclbcodigo: TIntegerField;
    stgstgexcluido: TIntegerField;
    stgid: TUniQuery;
    consultashema: TUniQuery;
    consultashemaCOLUMN_NAME: TStringField;
    
    procedure ChamaCalendario(Sender: TObject);
    procedure ActSairExecute(Sender: TObject);
    procedure ActAtualizarExecute(Sender: TObject);
    procedure ActExcluirExecute(Sender: TObject);
    procedure DBGListaDblClick(Sender: TObject);
    procedure DBGListaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure DBGListaKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGListaKeyPress(Sender: TObject; var Key: Char);
    procedure DBGListaKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGListaTitleClick(Column: TColumn);
    procedure DSTabelaDataChange(Sender: TObject; Field: TField);
    procedure edbuscaKeyPress(Sender: TObject; var Key: Char);
    procedure edbuscaKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Descarregar; virtual;
    procedure ActPesquisarExecute(Sender: TObject);
    procedure ActRelatoriosExecute(Sender: TObject);
    procedure ActConfiguracoesExecute(Sender: TObject);
    procedure ActFiltrarExecute(Sender: TObject);
    procedure DBGListaCellClick(Column: TColumn);
    procedure DBListaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure BFiltroExcluirClick(Sender: TObject);
    procedure BFiltroAlterarClick(Sender: TObject);
    procedure DBGListaColEnter(Sender: TObject);
    procedure edbuscaEnter(Sender: TObject);
    procedure BFiltroOcultarClick(Sender: TObject);
    procedure DifiUpdateData(Sender: TObject);
    procedure CriaAcoesDeAcesso;
    procedure ActVerFiltrosExecute(Sender: TObject);
    procedure ActConfigExecute(Sender: TObject);
    procedure acoesExecute(Action: TBasicAction; var Handled: Boolean);
    procedure DBGListaColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure filAfterInsert(DataSet: TDataSet);
    procedure BDiminuiLetraClick(Sender: TObject);
    procedure BAumentaLetraClick(Sender: TObject);
    procedure PlBotaoFiltroEspMouseWheelDown(Sender: TObject; Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
    procedure PlBotaoFiltroEspMouseWheelUp(Sender: TObject; Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
    procedure spChamaAjudaClick(Sender: TObject);
    procedure spCalenDtFinalClick(Sender: TObject);
    procedure spCalenDtInicialClick(Sender: TObject);
    procedure cbTipoDataKeyPress(Sender: TObject; var Key: Char);
    procedure cbTipoDataExit(Sender: TObject);
    procedure cbTipoDataCloseUp(Sender: TObject);
    procedure fmdBeforePost(DataSet: TDataSet);
    procedure bCancelaSelecaoClick(Sender: TObject);
    procedure bConfirmaSelecaoClick(Sender: TObject);
    procedure DBGSugestaoCellClick(Column: TColumn);
    procedure DBGSugestaoKeyPress(Sender: TObject; var Key: Char);
    procedure FechaFiltroTimer(Sender: TObject);
    procedure btLimpaBuscaClick(Sender: TObject);
    procedure Image2Click(Sender: TObject);
    procedure fmddtinicialKeyPress(Sender: TObject; var Key: Char);
    procedure fmddtfinalKeyPress(Sender: TObject; var Key: Char);
    procedure FrameConstrainedResize(Sender: TObject; var MinWidth, MinHeight, MaxWidth, MaxHeight: Integer);
    procedure uqtabelaCalcFields(DataSet: TDataSet);
    procedure mnAcessosClick(Sender: TObject);
    procedure FrameResize(Sender: TObject);
    procedure sbExcelClick(Sender: TObject);
    procedure DBGListaMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure ActInstrucoesExecute(Sender: TObject);
    procedure MadExceptionHandler1ExceptAction(action: TExceptAction;
      const exceptIntf: IMEException; var handled: Boolean);
    procedure MadExceptionHandler1Exception(const exceptIntf: IMEException;
      var handled: Boolean);

  private
    FAplicacao: String;
    FModoFrameDocado: Integer;

    vpalavra: String;
    vtitucol: String;
    vAliasTabela: String;
    vnomecol: String;
    vtipocol: TFieldType;
    vntabfilesp: string;

    xordem: Integer;

    FZCone: TUniConnection;
    FTitulo: string;
    FIdModulo: String;
    FTxtFiltro: string;
    FTxtFiltrosql: string;

    FSQlOriginal: String;

    FRegistroFrmBase: String;
    FPodeFechar: Boolean;
    FRemoverFiltro: Boolean;
    FHandleHerdado: NativeUInt;
    FFormaFrame: TFormaFrame;
    FModoFrame: TModoCarga;

    procedure AjustaFiltro;
    procedure AjustaOrdem(Key: Integer);

    procedure ChamaFiltro(pChave: string);
    procedure AjustaBotaoFiltro;
    procedure ActFiltroEspExecute(Sender: TObject);
    function AplicaFiltroEspecial(tabe: TUniQuery): string; Overload;
    function AplicaFiltroEspecial(vsqlorginal: string; tabe: TUniQuery): string; Overload;
    procedure MontaMenuFiltro;
    procedure SalvarLarguraEPosicao;
    procedure AjustaLetraGrids(vQuantiMudar: Integer; vTipoMudar: string);
    procedure ChamaRelatorio(Sender: TObject);
    function ImprimeRelatorio(modulo, varquivo: string): string;
    procedure SetZCone(const Value: TUniConnection);
    procedure SetIdModulo(const Value: string);
    procedure SetTitulo(const Value: string);
    procedure SetHandleHerdado(const Value: NativeUInt);
    procedure SetFormaFrame(const Value: TFormaFrame);
    procedure MontaFiltroEsp2;
    procedure RegistraEvento(Sender: TObject);

    procedure VerAtualizacao(pacote: string);
    procedure MontaMenuInstricoes;

    procedure ChamaInstrucao(Sender: TObject);
    procedure ChamaInstricao(Sender: TObject);
    procedure MOstraInstrucao(vNomeArq: string);

  protected
    { Private declarations }

  public
    Acesso: TAcesso;
    pack: Cardinal;
    vChave: string;
    vChaveMestre: string;
    vretorno: string;
    vdataatual: Double;
    vordem: string;
    vpfiltroSugestao: String;
    (* Método Construtor *)
    /// <summary>Construtor base.</summary>
    constructor Create(pCargaFrame: TCargaFrame);

    { Public declarations }
    function CriaFormulario(pFormClass: TFrmBaseClass; pChave, pChaveMestre: String; pFiltro: String = ''): Boolean;
    function MostraLista(pModulo: String; pFiltro: string = ''; pChaveMestre: string = ''): string;

    function MostraFormu(pModulo: string; pChave: string; pChaveMestre: string; pFormulario: string = 'formulario'; pFiltro: String = ''): String;
    procedure Carregar; virtual;
    procedure CalculaTotais; virtual;
    function MontaFiltro: string;
    procedure AtualizaFiltroUQTabela; virtual;
    procedure CarregarColunas(grid: TDBGrid);
    procedure SalvarColunas(grid: TDBGrid);
    procedure MontaFiltroEsp(tabe: TUniQuery; vChavePadrao: String = '');
    procedure MouseToCell(X, Y: Integer; var ACol, ARow: longint);
    function AutenticaUsuario(vUsrCodigo: string): Boolean;
    procedure MontaMenuRelatorios;
    procedure MontaMenu(vAcoes: TActionList);

    procedure SetModoExibicaoFrame(const Value: Integer = frmModoLista);

    procedure AjustarPosicaoBotoesFiltro(Sender: TObject);
    procedure onMostraFiltrodoBotao(Sender: TObject);
    procedure onOcultaFiltrodoBotao(Sender: TObject);
    procedure AtualizaTipoData;
    procedure RegistraAlteracaoParaCargas;
    procedure SalvarSTG(vtabela, vcampochave: string);

  published
    property ZCone: TUniConnection read FZCone write SetZCone;
    property Titulo: string read FTitulo write SetTitulo;
    property IdModulo: string read FIdModulo write SetIdModulo;
    property TxtFiltro: string read FTxtFiltro write FTxtFiltro;
    property TxtFiltroSQL: string read FTxtFiltrosql write FTxtFiltrosql;
    property PodeFechar: Boolean read FPodeFechar write FPodeFechar;
    property RegistroFrmBase: string read FRegistroFrmBase write FRegistroFrmBase;
    property SQLOriginal: string read FSQlOriginal;
    property RemoverFiltro: Boolean read FRemoverFiltro write FRemoverFiltro default False;

    property HandleHerdado: NativeUInt read FHandleHerdado write SetHandleHerdado;

    procedure CarregaColunas;
    procedure SalvaColunas;

    function Autorizado(Sender: TObject; motivo: string = ''): Boolean;
    procedure OcultarColuna(nomecol: string; visivel: Boolean; lista: TDBGrid);
    procedure DeletarColuna(nomecol: string; lista: TDBGrid);
    procedure PosicaoColuna(nomecol: string; lista: TDBGrid; vIndex: Integer);
    procedure GridZebrado(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);

    property ModoFrameDocado: Integer read FModoFrameDocado write SetModoExibicaoFrame;

    property FormaFrame: TFormaFrame read FFormaFrame write SetFormaFrame;
    property ModoFrame: TModoCarga read FModoFrame write FModoFrame;
    property Aplicacao: String read FAplicacao write FAplicacao;

  end;

  Taces = function(AOwner: TComponent; Conexao: TUniConnection): string;

  TImprimeRelat = function(AOwner: TComponent; Conexao: TUniConnection; vtabela: TUniDataSource; DirRelatorio: String; Impressora: String = ''; vUsuCodigo: string = ''): string;

  TAutorizacao = function(AOwner: TComponent; Conexao: TUniConnection; vusuario: string; vactcodigo: string; vmotivo: string = ''; vtdecodigo: String = ''; vorcchave: String = '';
    vmeschave: String = ''; vltecodigo: String = ''; vddfcodigo: String = ''; vForcaLogin: Boolean = False): string;

var
  fraBase: TFraBase;

implementation

{$R *.dfm}

uses uffiltro, ufcalendario, ufajuda, ufcpc, ufpesquisar, uffiltrocoluna,
  ufmostraist;

type
  { expor propriedades e metodso privadas e protegindos do dbgrid }
  TFriendly = class(TCustomDBGrid);
  TCellGrid = class(TCustomGrid);

procedure ExportRecordsetToMSExcel(vdbGridLista: TDBGrid; DestName: string; Data: TDataSource);
var
  linha, coluna: Integer;
  planilha: variant;
  valorcampo: string;
  i, X: Integer;
  vExportar: Boolean;
begin

  planilha := CreateoleObject('Excel.Application');
  planilha.WorkBooks.add(1);
  planilha.caption := 'Exportando dados para o Excel';
  planilha.visible := true;

  Data.DataSet.Open;
  Data.DataSet.First;
  X := 0;
  for linha := 0 to Data.DataSet.RecordCount - 1 do
  begin
    for coluna := 1 to Data.DataSet.FieldCount do
    begin
      for i := 0 to vdbGridLista.Columns.Count - 1 do
      begin
        if vdbGridLista.Columns[i].FieldName = Data.DataSet.Fields[coluna - 1].FieldName then
        begin
          if vdbGridLista.Columns[i].visible then
          begin
            vExportar := true;
            X := X + 1
          end
          else
            vExportar := False;
        end;
      end;

      if vExportar then
      begin

        valorcampo := Data.DataSet.Fields[coluna - 1].AsString;
        planilha.cells[linha + 2, X] := valorcampo;

      end;

    end;
    Data.DataSet.Next;
    X := 0;
  end;

  X := 0;
  for coluna := 1 to Data.DataSet.FieldCount do
  begin

    for i := 0 to vdbGridLista.Columns.Count - 1 do
    begin
      if vdbGridLista.Columns[i].FieldName = Data.DataSet.Fields[coluna - 1].FieldName then
      begin
        if vdbGridLista.Columns[i].visible then
        begin
          vExportar := true;
          X := X + 1
        end
        else
          vExportar := False;
      end;
    end;

    if vExportar then
    begin
      valorcampo := Data.DataSet.Fields[coluna - 1].DisplayLabel;
      planilha.cells[1, X] := valorcampo;

    end;
  end;
  planilha.Columns.Autofit;
end;

procedure TFraBase.PlBotaoFiltroEspMouseWheelDown(Sender: TObject; Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
begin
  TScrollBox(Sender).Perform(WM_VSCROLL, 1, 0);
end;

procedure TFraBase.PlBotaoFiltroEspMouseWheelUp(Sender: TObject; Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
begin
  TScrollBox(Sender).Perform(WM_VSCROLL, 0, 0);
end;

procedure TFraBase.MouseToCell(X, Y: Integer; var ACol, ARow: Integer);
var
  Coord: TGridCoord;
begin
  Coord := DBLista.MouseCoord(X, Y);
  ACol := Coord.X;
  ARow := Coord.Y;
end;

procedure TFraBase.AjustarPosicaoBotoesFiltro(Sender: TObject);
var
  i: Integer;
  btBmp: TPanel;

  Cols: Integer;
  function GetColsWidth(Column: TColumn): Integer;
  var
    i: Integer;
  begin
    Result := 0;
    for i := 0 to Column.Index do
    begin
      Result := Result + TDBGrid(Sender).Columns.Items[i].Width;
    end;
    Result := Result + 10 + (Column.Index);
  end;

begin

  with TFriendly(DBGLista) do
  begin
    for i := 0 to DBGLista.Columns.Count - 1 do

      if self.FindComponent('btntopofiltro' + DBGLista.Columns[i].FieldName) <> nil then
      begin
        if self.FindComponent('btntopofiltro' + DBGLista.Columns[i].FieldName) is TPanel then
        begin
          btBmp := self.FindComponent('btntopofiltro' + DBGLista.Columns[i].FieldName) as TPanel;

          btBmp.Top := 2;
          btBmp.Width := RowHeights[0];
          btBmp.Height := RowHeights[0] - 3;
          btBmp.Left := GetColsWidth((DBGLista.Columns[i] as TColumn)) - btBmp.Width;
        end;

      end;
  end;

end;

procedure TFraBase.SalvarLarguraEPosicao;
var
  nomecol: string;
  Cols: Integer;

begin
  { * ao mover colunas de lugar ele salva a posicao para carregar a tela
    de ajusta de colunas visíveis * }
  cpg.Close;
  cpg.Params[0].AsInteger := Acesso.Usuario;
  cpg.Params[1].AsString := self.Name + '-' + DBGLista.Name;
  cpg.Open;
  cpc.Close;
  cpc.Params[0].AsInteger := self.cpgcpgchave.AsInteger;
  cpc.Open;
  if cpc.IsEmpty then
    exit;
  for Cols := 0 to self.DBGLista.Columns.Count - 1 do
  begin
    nomecol := self.DBGLista.Columns[Cols].FieldName;
    try
      if self.cpc.Locate('cpccampo', nomecol, [loCaseInsensitive]) then
      begin
        self.cpc.Edit;
        self.cpccpcordem.AsInteger := Cols;
        self.cpccpclargura.AsInteger := self.DBGLista.Columns[Cols].Width;
        self.cpc.Post;
      end;
    except

    end;
  end;
end;

procedure TFraBase.spChamaAjudaClick(Sender: TObject);
begin
  if Application.FindComponent('fajuda') <> nil then
    fajuda.Close;

  Application.CreateForm(tfajuda, fajuda);
  fajuda.ZCone := self.ZCone;
  fajuda.vpBplNome := uppercase('m' + Copy(self.Name, 4, 3) + '.BPL');
  fajuda.Show;
end;

procedure TFraBase.sbExcelClick(Sender: TObject);
begin

  DBGrid2Excel.SaveDBGridAs('c:\mizio\excel.xls')
  // ExportRecordsetToMSExcel(self.DBGLista, 'c:\mizio\excel.xml', DSTabela);
end;

procedure TFraBase.uqtabelaCalcFields(DataSet: TDataSet);
begin
  PlQtdRecno.caption := 'Registros: ' + IntToStr(self.uqtabela.RecordCount);
end;

procedure TFraBase.spCalenDtFinalClick(Sender: TObject);
begin
  spCalenDtFinal.Hint := '';
  ChamaCalendario(Sender);

  if spCalenDtFinal.Hint <> '' then
  begin
    fmddtfinal.DataSource.DataSet.Edit;
    fmddtfinal.Field.AsString := spCalenDtFinal.Hint;
    fmddtfinal.DataSource.DataSet.Post;
    self.ActAtualizar.Execute;
  end;

end;

procedure TFraBase.spCalenDtInicialClick(Sender: TObject);
begin
  spCalenDtInicial.Hint := '';
  ChamaCalendario(Sender);

  if spCalenDtInicial.Hint <> '' then
  begin
    fmddtinicial.DataSource.DataSet.Edit;
    fmddtinicial.Field.AsString := spCalenDtInicial.Hint;
    fmddtinicial.DataSource.DataSet.Post;
    self.ActAtualizar.Execute;
  end;
end;

procedure TFraBase.MontaFiltroEsp2;
var
  vlCampos: TStringList;
  vlTitulos: TStringList;
  i: Integer;
  vlTipo: TFieldType;
  vlTipoData: string;
begin
  vlCampos := TStringList.Create;
  vlCampos.Clear;
  vlTitulos := TStringList.Create;
  vlTitulos.Clear;

  for i := 0 to DBGLista.Columns.Count - 1 do
  begin
    vlTipo := uqtabela.FieldByName(DBGLista.Columns[i].FieldName).DataType;
    if (uqtabela.FieldByName(DBGLista.Columns[i].FieldName).DataType = ftDate) or (uqtabela.FieldByName(DBGLista.Columns[i].FieldName).DataType = ftDateTime) then
    begin
      vlTitulos.add(DBGLista.Columns[i].Title.caption);
      vlCampos.add(Copy(DBGLista.Columns[i].FieldName, 1, 3) + '.' + DBGLista.Columns[i].FieldName);
    end;
  end;

  vlTipoData := cbTipoData.text;
  fmd.Close;
  fmd.Params[0].AsInteger := Acesso.Usuario;
  fmd.Params[1].AsString := self.Name;
  fmd.Params[2].AsInteger := Acesso.Filial;
  fmd.Open;

  if fmd.IsEmpty then
  begin
    for i := 0 to vlCampos.Count - 1 do
    begin
      fmd.Append;
      fmdmdlnome.AsString := self.Name;
      fmdclbcodigo.AsInteger := Acesso.Usuario;
      fmdflacodigo.AsInteger := Acesso.Filial;
      fmdfmdcampo.AsString := vlCampos[i];
      fmdfmddtinicial.AsString := DateToStr(StrToDate(hoje(Application, ZCone)) - 30);
      fmdfmddtfinal.AsString := hoje(Application, ZCone);
      fmdfmdtitulo.AsString := vlTitulos[i];
      fmd.Post;
    end;
  end
  else
  begin
    fmd.Locate('fmdtitulo', vlTipoData, []);

    cbTipoData.text := vlTipoData;

  end;

  if vlTitulos.text <> '' then
  begin

    cbTipoData.Items.text := vlTitulos.text;
    // cbTipoData.ItemIndex := 0;

    cbTipoData.text := fmdfmdtitulo.AsString;

    if (pos('fracco', lowercase(self.Name)) = 0) and (PlBotaoFiltroEsp2.Enabled) then
      PlBotaoFiltroEsp2.visible := true;
  end;

end;

{ *
  procedure TFraBase.MontaFiltroEsp2;
  var
  vlCampos: TStringList;
  vlTitulos: TStringList;
  i: Integer;
  vlTipo: TFieldType;
  vlTipoData: string;
  begin
  vlCampos := TStringList.Create;
  vlCampos.Clear;
  vlTitulos := TStringList.Create;
  vlTitulos.Clear;

  for i := 0 to DBGLista.Columns.Count - 1 do
  begin
  vlTipo := uqtabela.FieldByName(DBGLista.Columns[i].FieldName).DataType;
  if (uqtabela.FieldByName(DBGLista.Columns[i].FieldName).DataType = ftDate) then
  begin
  vlTitulos.add(DBGLista.Columns[i].Title.caption);
  vlCampos.add(Copy(DBGLista.Columns[i].FieldName, 1, 3) + '.' + DBGLista.Columns[i].FieldName);
  end;
  end;

  vlTipoData := cbTipoData.text;
  fmd.Close;
  fmd.Params[0].AsInteger := Acesso.Usuario;
  fmd.Params[1].AsString := self.Name;
  fmd.Params[2].AsInteger := Acesso.Filial;
  fmd.Open;

  if fmd.IsEmpty then
  begin
  for i := 0 to vlCampos.Count - 1 do
  begin
  fmd.Append;
  fmdmdlnome.AsString := self.Name;
  fmdclbcodigo.AsInteger := Acesso.Usuario;
  fmdflacodigo.AsInteger := Acesso.Filial;
  fmdfmdcampo.AsString := vlCampos[i];
  fmdfmddtinicial.AsString := DateToStr(StrToDate(hoje(Application, ZCone)) - 30);
  fmdfmddtfinal.AsString := hoje(Application, ZCone);
  fmdfmdtitulo.AsString := vlTitulos[i];
  fmd.Post;
  end;
  end
  else
  begin
  fmd.Locate('fmdtitulo', vlTipoData, []);

  cbTipoData.text := vlTipoData;

  end;

  if vlTitulos.text <> '' then
  begin

  cbTipoData.Items.text := vlTitulos.text;
  // cbTipoData.ItemIndex := 0;

  cbTipoData.text := fmdfmdtitulo.AsString;

  if (pos('fracco', lowercase(self.Name)) = 0) and (PlBotaoFiltroEsp2.Enabled) then
  PlBotaoFiltroEsp2.visible := true;
  end;

  end;    * }

procedure TFraBase.MontaFiltroEsp(tabe: TUniQuery; vChavePadrao: String = '');
var
  ActExib: TAction;
  btamcr: TCheckBox;
begin
  if not Assigned(tabe.Connection) then
    tabe.Connection := ZCone;

  if SBBotoes.FindChildControl('plesp' + SoLetras(semacento('Exibir'))) = nil then
  begin

    tabe.Close;
    tabe.Open;

    tabe.First;
    while not tabe.Eof do
    begin
      if PlBotaoFiltroEsp.FindChildControl('bAct' + SoLetras(tabe.Fields[1].AsString)) = nil then
      begin

        ActExib := TAction.Create(acoes);
        ActExib.Name := 'Act' + semacento(SoLetras(tabe.Fields[1].AsString));

        ActExib.GroupIndex := tabe.RecNo;
        ActExib.HelpKeyword := tabe.Fields[0].AsString;

        // ActExib.GroupIndex := tabe.Fields[0].AsInteger;
        // ActExib.Tag := tabe.Fields[0].AsInteger;

        ActExib.caption := tabe.Fields[1].AsString;
        ActExib.Hint := tabe.Name;
        vntabfilesp := tabe.Name;
        ActExib.OnExecute := ActFiltroEspExecute;

        if tabe.Fields[0].AsString = vChavePadrao then
          ActExib.Checked := true;

        consulta.Close;
        consulta.SQL.text := 'select cfgtodasentidades from cfg where cfgcodigo=' + Acesso.Filial.ToString;
        consulta.Open;

        if consulta.Fields[0].AsString = '1' then
          ActExib.Checked := true;




        // if tabe.Fields[0].AsInteger = vChavePadrao then
        // ActExib.Checked := True;

        btamcr := TCheckBox.Create(PlBotaoFiltroEsp);
        btamcr.Parent := PlBotaoFiltroEsp;
        btamcr.caption := ActExib.caption;
        btamcr.HelpKeyword := ActExib.HelpKeyword;

        // btamcr.Tag := ActExib.Tag;
        btamcr.Name := 'b' + ActExib.Name;
        btamcr.Action := ActExib;
        btamcr.Align := alBottom;
        btamcr.Align := alTop;
        btamcr.Height := 22;
        PlBotaoFiltroEsp.visible := true;
      end;

      tabe.Next;
    end;
  end;
end;

procedure TFraBase.ActFiltroEspExecute(Sender: TObject);
var
  vlNomeCB: string;
  vlCheckBox: TCheckBox;
begin

  if (Sender is TAction) then
  begin
    vlNomeCB := (Sender as TAction).Name;
    vlCheckBox := (self.PlBotaoFiltroEsp.FindComponent('b' + vlNomeCB) as TCheckBox);

    if vlCheckBox <> nil then
      if vlCheckBox.Checked = False then
        vlCheckBox.Checked := False
      else
        vlCheckBox.Checked := true;
  end;

  self.ActAtualizar.Execute;
end;

procedure TFraBase.ActInstrucoesExecute(Sender: TObject);
var
  vlBtnIts: TBitBtn;
  vlPoint: TPoint;
begin
  vlBtnIts := self.PlBotoes.FindComponent('bActInstrucoes') as TBitBtn;

  vlPoint := Point(0, 0);
  vlPoint := vlBtnIts.ClientToScreen(vlPoint);

  MontaMenuInstricoes;
  vlBtnIts.PopupMenu := MenuInstrucoes;
  MenuInstrucoes.Popup(vlPoint.X + vlBtnIts.Width, vlPoint.Y);

end;

function TFraBase.AplicaFiltroEspecial(vsqlorginal: string; tabe: TUniQuery): string;
var
  vlFiltro: string;
  vlNomeCB: string;
  vlCheckBox: TCheckBox;
begin
  vlFiltro := '(';
  tabe.First;
  while not tabe.Eof do
  begin
    vlNomeCB := semacento(SoLetras(tabe.Fields[1].AsString));
    vlCheckBox := (self.PlBotaoFiltroEsp.FindComponent('bAct' + vlNomeCB) as TCheckBox);

    if vlCheckBox <> nil then
      if vlCheckBox.Checked then
      begin
        if pos(' v_pro ', vsqlorginal) > 0 then
        begin
          if tabe.Fields[0].DataType = ftInteger then
            vlFiltro := vlFiltro + tabe.Fields[0].FieldName + '=' + vlCheckBox.HelpKeyword + ' or ';
          if tabe.Fields[0].DataType = ftString then
            vlFiltro := vlFiltro + tabe.Fields[0].FieldName + '=' + QuotedStr(vlCheckBox.HelpKeyword) + ' or ';

        end
        else
        begin

          if tabe.Fields[0].DataType = ftInteger then
            vlFiltro := vlFiltro + Copy(tabe.Fields[0].FieldName, 1, 3) + '.' + tabe.Fields[0].FieldName + '=' + vlCheckBox.HelpKeyword + ' or ';
          if tabe.Fields[0].DataType = ftString then
            vlFiltro := vlFiltro + Copy(tabe.Fields[0].FieldName, 1, 3) + '.' + tabe.Fields[0].FieldName + '=' + QuotedStr(vlCheckBox.HelpKeyword) + ' or ';

        end;
      end;

    tabe.Next;
  end;

  vlFiltro := Copy(vlFiltro, 1, Length(vlFiltro) - 4) + ')';

  if vlFiltro = ')' then
    vlFiltro := '';

  Result := vlFiltro;
end;

function TFraBase.AplicaFiltroEspecial(tabe: TUniQuery): string;
var
  vlFiltro: string;
  vlNomeCB: string;
  vlCheckBox: TCheckBox;
begin
  vlFiltro := '(';
  tabe.First;
  while not tabe.Eof do
  begin
    vlNomeCB := semacento(SoLetras(tabe.Fields[1].AsString));
    vlCheckBox := (self.PlBotaoFiltroEsp.FindComponent('bAct' + vlNomeCB) as TCheckBox);

    if vlCheckBox <> nil then
      if vlCheckBox.Checked then
      begin
        if pos(' v_pro ', tabe.SQL.text) > 0 then
        begin
          if tabe.Fields[0].DataType = ftInteger then
            vlFiltro := vlFiltro + tabe.Fields[0].FieldName + '=' + vlCheckBox.HelpKeyword + ' or ';
          if tabe.Fields[0].DataType = ftString then
            vlFiltro := vlFiltro + tabe.Fields[0].FieldName + '=' + QuotedStr(vlCheckBox.HelpKeyword) + ' or ';

        end
        else
        begin

          if tabe.Fields[0].DataType = ftInteger then
            vlFiltro := vlFiltro + Copy(tabe.Fields[0].FieldName, 1, 3) + '.' + tabe.Fields[0].FieldName + '=' + vlCheckBox.HelpKeyword + ' or ';
          if tabe.Fields[0].DataType = ftString then
            vlFiltro := vlFiltro + Copy(tabe.Fields[0].FieldName, 1, 3) + '.' + tabe.Fields[0].FieldName + '=' + QuotedStr(vlCheckBox.HelpKeyword) + ' or ';

        end;
      end;

    tabe.Next;
  end;

  vlFiltro := Copy(vlFiltro, 1, Length(vlFiltro) - 4) + ')';

  if vlFiltro = ')' then
    vlFiltro := '';

  Result := vlFiltro;
end;

procedure TFraBase.GridZebrado(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
var
  fixRect: TRect;
begin
  fixRect := Rect;

  if Odd((Sender as TDBGrid).DataSource.DataSet.RecNo) then
    (Sender as TDBGrid).Canvas.Brush.Color := $00FFEBD7
  else
    (Sender as TDBGrid).Canvas.Brush.Color := CLWHITE;

  if gdSelected in State then
    with (Sender as TDBGrid).Canvas do
    begin
      Brush.Color := PEG_COR_SELCGRID;
      FillRect(fixRect);
      // Font.Color := CLWHITE;
      Font.Style := [fsbold];
    end;

  { Get active record within grids TDataLink. The active record will be
    the current record in the dataset. Check against Row that we are
    trying to Draw, -1 to offset the column headings within grid. }

  (Sender as TDBGrid).Canvas.Font.Color := clBlack;
  with TFriendly((Sender as TDBGrid)) do
    if TDataLink(DataLink).ActiveRecord = Row - 1 then
      with Canvas do
      begin
        Brush.Color := PEG_COR_SELCGRID; { set grids canvas to win highlight colour }
        DefaultDrawColumnCell(fixRect, DataCol, Column, State); { now redraw the cell, but highlighted }
      end;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);
end;

procedure TFraBase.AtualizaFiltroUQTabela;
var
  vlFiltroBusca: string;
  vlFiltroAnterior: String;
  vlTabela: string;
begin
  if edbusca.Hint <> '' then
  begin
    try
      if edbusca.text = '' then
        exit;

      uqtabela.DisableControls;
      if cbSelecaoExata.Checked then
      begin
        edbusca.text := qrySugestao.Fields[0].AsString;
        vlFiltroBusca := qrySugestao.Fields[0].FieldName + '=' + Chr(39) + edbusca.text + Chr(39) + '';
      end
      else
      begin
        vlFiltroBusca := qrySugestao.Fields[0].FieldName + ' like ' + Chr(39) + '%' + edbusca.text + '%' + Chr(39);

      end;
      vlTabela := Copy(vlFiltroBusca, 1, 3);

      if pos(vlTabela + '.', uqtabela.SQL.text) > 0 then
        vlFiltroBusca := vlTabela + '.' + vlFiltroBusca;

      if uqtabela.FilterSQL <> '' then
      begin
        if pos(qrySugestao.Fields[0].FieldName, uqtabela.FilterSQL) = 0 then
        begin

          if uqtabela.FilterSQL <> '' then
          begin
            try
              uqtabela.FilterSQL := uqtabela.FilterSQL + ' and ' + vlFiltroBusca;
            except
              uqtabela.FilterSQL := uqtabela.FilterSQL + ' and ' + vlTabela + '.' + vlFiltroBusca;
            end;
          end
          else
          begin
            try
              uqtabela.FilterSQL := uqtabela.FilterSQL + ' ' + vlFiltroBusca
            except
              uqtabela.FilterSQL := uqtabela.FilterSQL + ' ' + vlTabela + '.' + vlFiltroBusca
            end;
          end;
        end
        else
        begin
          uqtabela.FilterSQL := Copy(uqtabela.FilterSQL, 1, pos(qrySugestao.Fields[0].FieldName, uqtabela.FilterSQL) - 5);
          if uqtabela.FilterSQL <> '' then
            vlFiltroAnterior := uqtabela.FilterSQL;

          if vlFiltroAnterior <> '' then
          begin
            try
              uqtabela.FilterSQL := vlFiltroAnterior + ' and ' + vlFiltroBusca;
            except
              uqtabela.FilterSQL := vlFiltroAnterior + ' and ' + vlTabela + '.' + vlFiltroBusca;
            end;
          end
          else
          begin
            try
              uqtabela.FilterSQL := vlFiltroBusca;
            except
              uqtabela.FilterSQL := vlTabela + '.' + vlFiltroBusca;
            end;
          end;
        end;
      end
      else
      begin
        if pos(qrySugestao.Fields[0].FieldName, uqtabela.FilterSQL) = 0 then
        begin
          uqtabela.FilterSQL := vlFiltroBusca
        end
        else
        begin
          uqtabela.FilterSQL := Copy(uqtabela.FilterSQL, 1, pos(qrySugestao.Fields[0].FieldName, uqtabela.FilterSQL) - 1);
          uqtabela.FilterSQL := vlFiltroBusca;
        end;
      end;
    finally
      uqtabela.EnableControls;
    end;
    FechaFiltro.Enabled := true;
  end;
end;

procedure TFraBase.AtualizaTipoData;
var
  i: Integer;
begin
  for i := 0 to DBGLista.Columns.Count - 1 do
  begin
    if DBGLista.Columns[i].Title.caption = cbTipoData.text then
    begin
      fmd.Edit;
      fmdfmdtitulo.AsString := DBGLista.Columns[i].Title.caption;
      fmdfmdcampo.AsString := DBGLista.Columns[i].FieldName;
      fmd.Post;
      break;
    end;
  end;

end;

procedure TFraBase.ChamaCalendario(Sender: TObject);
var
  vlData: TDate;
begin
  Application.CreateForm(tfcalendario, fcalendario);

  if Sender is TSpeedButton then
    if (Sender as TSpeedButton).Hint <> '' then
      try
        StrToDate((Sender as TSpeedButton).Hint);
      except
      end;

  if fcalendario.ShowModal = mrOk then
  begin
    try
      vlData := fcalendario.vdata;
    except
      vlData := 0;
    end;

    if Sender is TSpeedButton then
      (Sender as TSpeedButton).Hint := DateToStr(vlData);
  end;
end;

procedure TFraBase.acoesExecute(Action: TBasicAction; var Handled: Boolean);
var
  vlNomeAcao: string;
begin
  if not(Parent is TPanel) then
  begin
    vlNomeAcao := Action.Name;
    RegistraEvento(Action);
    if (vlNomeAcao = 'ActIncluirSelecionado') or (vlNomeAcao = 'ActIncluirTodos') or (vlNomeAcao = 'ActRemoverTodos') or (vlNomeAcao = 'ActRemoverSelecionado') then
    begin
    end
    else
    begin
      if not self.Autorizado(Action) then
        Handled := true;
    end;
  end;
end;

procedure TFraBase.ActAtualizarExecute(Sender: TObject);
var
  vQuery, vSQLFiltroEsp, vLinhaSQL: string;
  i: Integer;
  vRegAtual: String;

  vfiltro: string;
  ztab: TComponent;

  vFieldFiltroEsp: string;
  vFieldFiltroEsp2: string;

  vlregiatu: Integer;
  sw: TStopwatch;
begin
  try
    SendMessage(self.Handle, WM_SETREDRAW, Integer(False), 0);

    sw := TStopwatch.Create;

    // edbusca.Text := '';
    try
      sw.Start;
      vlregiatu := uqtabela.RecNo;

      self.uqtabela.DisableControls;

      consulta.Close;
      consulta.SQL.text := 'SELECT CURDATE()';
      consulta.Open;

      self.vdataatual := consulta.Fields[0].AsFloat;

      for i := 0 to self.ComponentCount - 1 do
      begin
        if self.Components[i] is TUniQuery then
          (self.Components[i] as TUniQuery).Connection := self.ZCone;

        if self.Components[i] is TDBGrid then
          (self.Components[i] as TDBGrid).ReadOnly := true;
      end;

      vRegAtual := '0';

      if uqtabela.Active = False then
      begin
        if self.clsclsultimo.AsString <> '' then
          try
            vRegAtual := self.clsclsultimo.AsString;
          except
          end;
      end
      else
        vRegAtual := self.uqtabela.Fields[0].AsString;

      self.uqtabela.Close;

      fil.Close;
      fil.SQL.Clear;
      fil.SQL.text := 'SELECT filcodigo, clscodigo, clbcodigo, filsqloriginal FROM fil WHERE ';
      fil.SQL.add('clscodigo = ' + self.clsclscodigo.AsString + ' AND ');
      fil.SQL.add('clbcodigo = ' + self.Acesso.Usuario.ToString);
      fil.Open;

      if (not fil.IsEmpty) and (RemoverFiltro) then
        fil.Delete;

      RemoverFiltro := False;

      vfiltro := MontaFiltro;
      if vfiltro <> '' then
        PlSelecao.visible := true
      else
        PlSelecao.visible := False;

      if pos('order', lowercase(self.SQLOriginal)) > 0 then
        self.uqtabela.SQL.text := self.SQLOriginal + ' and ' + vfiltro;

      if vfiltro <> '' then
      begin
        if pos('where', lowercase(self.SQLOriginal)) = 0 then
          self.uqtabela.SQL.text := self.SQLOriginal + ' where ' + vfiltro
        else
          self.uqtabela.SQL.text := self.SQLOriginal + ' and ' + vfiltro;
      end
      else if self.SQLOriginal <> '' then
        self.uqtabela.SQL.text := self.SQLOriginal;

      if self.vChaveMestre <> '' then
        if self.uqtabela.Params.Count = 1 then
          self.uqtabela.Params[0].AsString := self.vChaveMestre;

      ztab := self.FindComponent(vntabfilesp);

      if ztab <> nil then
        vFieldFiltroEsp := (ztab as TUniQuery).Name + '.' + (ztab as TUniQuery).Fields[0].FieldName
      else
        vFieldFiltroEsp := '';

      if vFieldFiltroEsp <> '' then
      begin
        for i := 0 to self.uqtabela.SQL.Count - 1 do
        begin
          vLinhaSQL := self.uqtabela.SQL[i];

          if pos(vFieldFiltroEsp + '=', vLinhaSQL) = 0 then
            vQuery := vQuery + vLinhaSQL + ' ' + #13;
        end;
      end
      else
      begin
        for i := 0 to self.uqtabela.SQL.Count - 1 do
        begin
          vLinhaSQL := self.uqtabela.SQL[i];
          vQuery := vQuery + vLinhaSQL + ' ' + #13;
        end;
      end;

      if vQuery = '' then
        vQuery := self.uqtabela.SQL.text;

      vSQLFiltroEsp := '';

      if ztab <> nil then
      begin
        if pos('_', vQuery) > 0 then
        begin
          vSQLFiltroEsp := AplicaFiltroEspecial(vQuery, ztab as TUniQuery);
        end
        else
        begin
          vSQLFiltroEsp := AplicaFiltroEspecial(ztab as TUniQuery);
        end;

      end;

      if (vSQLFiltroEsp <> '') then
        if (pos('where', lowercase(vQuery)) > 0) then
          vSQLFiltroEsp := ' and ' + vSQLFiltroEsp
        else
          vSQLFiltroEsp := ' WHERE ' + vSQLFiltroEsp;

      if (self.FTxtFiltrosql <> '') then
      begin
        if self.fil.RecordCount = 0 then
        begin
          self.fil.Append;
          self.filclscodigo.AsInteger := self.clsclscodigo.AsInteger;
          self.filclbcodigo.AsInteger := Acesso.Usuario;
        end
        else
        begin
          self.fil.Edit;
        end;

        // Self.filfilsqloriginal.AsString := Self.uqtabela.SQL.Text;
        self.fil.Post;

        if pos('where', lowercase(vQuery + vSQLFiltroEsp)) > 0 then
          vSQLFiltroEsp := ' ' + vSQLFiltroEsp + ' and ' + self.FTxtFiltrosql
        else
          vSQLFiltroEsp := ' where ' + self.FTxtFiltrosql;
      end
      else
      begin
        if (pos('where', lowercase(vQuery + vSQLFiltroEsp)) = 0) and (vSQLFiltroEsp <> '') then
          vSQLFiltroEsp := ' where ' + vSQLFiltroEsp;

      end;

      if Length(vQuery + vSQLFiltroEsp) > 0 then
        self.uqtabela.SQL.text := vQuery + vSQLFiltroEsp;

      try
        if self.uqtabela.Params.FindParam('flacodigo') <> nil then
          self.uqtabela.ParamByName('flacodigo').AsInteger := Acesso.Filial;

        MontaFiltroEsp2;

        if (PlBotaoFiltroEsp2.visible) and (PlBotaoFiltroEsp2.Hint = '') then
        begin

          if self.Name = 'fravnd' then
          begin
            try
              if not fmd.IsEmpty then
              begin
                cfgmgou.Close;
                cfgmgou.ParamByName('flacodigo').AsInteger := Acesso.Filial;
                cfgmgou.Open;

                self.uqtabela.FilterSQL := Copy(fmdfmdcampo.AsString, 1, 3) + '.' + 'mesinclusao' + ' BETWEEN (' +
                  QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtinicial.AsFloat) + ' ' + cfgmgoucfgmgouhoravirada.AsString) + ') and (' +
                  QuotedStr(FormatDateTime('yyyy-mm-dd', IncDay(fmdfmddtfinal.AsFloat, 1)) + ' ' + Timetostr(IncSecond(cfgmgoucfgmgouhoravirada.AsDateTime, -1))) + ')';

                AtualizaFiltroUQTabela;
                // Self.uqtabela.Prepare;
                self.uqtabela.Open;
              end;
            except
              self.uqtabela.FilterSQL := 'mesinclusao' + ' BETWEEN (' + QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtinicial.AsFloat)) + ') and (' +
                QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtfinal.AsFloat)) + ')';
              AtualizaFiltroUQTabela;
              // Self.uqtabela.Prepare;
              self.uqtabela.Open;
            end;

          end
          else
          begin
            try
              if not fmd.IsEmpty then
                self.uqtabela.FilterSQL := Copy(fmdfmdcampo.AsString, 1, 3) + '.' + fmdfmdcampo.AsString + ' BETWEEN (' +
                  QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtinicial.AsFloat)) + ') and (' + QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtfinal.AsFloat)) + ')';
              AtualizaFiltroUQTabela;
              // Self.uqtabela.Prepare;
              self.uqtabela.Open;
            except
              self.uqtabela.FilterSQL := fmdfmdcampo.AsString + ' BETWEEN (' + QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtinicial.AsFloat)) + ') and (' +
                QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtfinal.AsFloat)) + ')';
              AtualizaFiltroUQTabela;
              // Self.uqtabela.Prepare;
              self.uqtabela.Open;
            end;

          end;
        end
        else
        begin
          AtualizaFiltroUQTabela;
          // Self.uqtabela.Prepare;
          self.uqtabela.Open;
        end;
      except
        if fil.Active then
        begin
          if not fil.IsEmpty then
            fil.Delete;

          // ifi.Refresh;
          ActVerFiltros.Execute;
        end;

        self.uqtabela.SQL.text := SQLOriginal + vSQLFiltroEsp;

        if self.uqtabela.Params.FindParam('flacodigo') <> nil then
          self.uqtabela.ParamByName('flacodigo').AsInteger := Acesso.Filial;
        // Self.uqtabela.Prepare;
        self.uqtabela.Open;
      end;

      PlQtdRecno.caption := 'Registros: ' + IntToStr(self.uqtabela.RecordCount);

      if ifi.Active then
      begin
        if ifi.RecordCount = 0 then
        begin
          if SplBotoes.FindComponent('bactverfiltros') <> nil then
            (SplBotoes.FindComponent('bactverfiltros') as TBitBtn).visible := False;
        end
        else if SplBotoes.FindComponent('bactverfiltros') <> nil then
          (SplBotoes.FindComponent('bactverfiltros') as TBitBtn).visible := true;
      end
      else if SplBotoes.FindComponent('bactverfiltros') <> nil then
        (SplBotoes.FindComponent('bactverfiltros') as TBitBtn).visible := False;

      if self.uqtabela.Locate(self.uqtabela.Fields[0].FieldName, vRegAtual, []) = False then
      begin
        try
          uqtabela.RecNo := vlregiatu - 1;
        except
          self.uqtabela.First;
        end;
      end;
    finally
      self.uqtabela.EnableControls;
      sw.Stop;

      PlQtdRecno.Hint := Format('Tempo Execução: %d ms', [sw.ElapsedMilliseconds]);
    end;

  finally

    SendMessage(self.Handle, WM_SETREDRAW, Integer(true), 0);
    // Update client area
    RedrawWindow(self.Handle, nil, 0, RDW_INVALIDATE or RDW_UPDATENOW or RDW_ALLCHILDREN);

  end;
end;

function TFraBase.MontaFiltro: string;
var
  filtro: string;
  vcampoatual: string;
  vmetodo: Integer;
  i: Integer;
begin

  fil.Close;
  fil.SQL.text := 'SELECT filcodigo, clscodigo, clbcodigo, filsqloriginal FROM fil WHERE ';
  fil.SQL.add('clscodigo = ' + self.clsclscodigo.AsString + ' AND ');
  fil.SQL.add('clbcodigo = ' + Acesso.Usuario.ToString);
  fil.Open;

  if self.filfilcodigo.AsString <> '' then
  begin
    ifi.Close;
    ifi.SQL.text := 'SELECT ifichave, filcodigo, ifitipocampo, ififiltro, ifidescricao, ificampo, ifimetodo, ifititulo, ifiexato FROM ifi WHERE ';
    ifi.SQL.add('filcodigo = ' + self.filfilcodigo.AsString + ' ');
    ifi.SQL.add('ORDER BY ificampo, ifimetodo');
    ifi.Open;

    filtro := '';

    if not ifi.Eof then
    begin
      vcampoatual := self.ifiificampo.AsString;

      while not ifi.Eof do
      begin
        if Trim(self.ifiififiltro.AsString) <> '' then
        begin
          filtro := filtro + ' ' + self.ifiififiltro.AsString;
          vmetodo := self.ifiifimetodo.AsInteger;
        end;

        ifi.Next;

        if Trim(self.ifiififiltro.AsString) <> '' then
          if not ifi.Eof then
            if vcampoatual = self.ifiificampo.AsString then
            begin
              if pos('(', filtro) = 0 then
              begin
                if pos(' not like ', self.ifiififiltro.AsString) > 0 then
                begin
                  filtro := '(' + filtro + ' and ';
                end
                else
                begin
                  if vmetodo = 2 then
                  begin
                    filtro := '(' + filtro + ' and ';
                  end
                  else
                  begin
                    if (self.ifiifitipocampo.AsInteger = 1) or (self.ifiifitipocampo.AsInteger = 2) then
                      filtro := '(' + filtro + ' or '
                    else
                      filtro := filtro + ' and ';
                  end;
                end;
              end
              else
              begin
                if pos(' not like ', lowercase(self.ifiififiltro.AsString)) > 0 then
                begin
                  filtro := filtro + ' and ';
                end
                else
                begin
                  if vmetodo = 2 then
                    filtro := filtro + ' and '
                  else
                    filtro := filtro + ' or ';
                end;
              end;
            end
            else
            begin
              if pos('(', filtro) > 0 then
                if (self.ifiifitipocampo.AsInteger = 1) then
                begin
                  if funCountChar(filtro, '(') > funCountChar(filtro, ')') then
                    filtro := filtro + ')'; { + filtro }
                end
                else
                  filtro := filtro;

              filtro := filtro + ' and ';
              vcampoatual := self.ifiificampo.AsString;
            end;

        if ifi.Eof then
        begin
          if pos('(', filtro) > 0 then
            if pos(')', filtro) = 0 then
              filtro := filtro + ')';

          break;
        end;
      end;
    end;

    { for I :=0 to funCountChar(filtro, '.') do
      begin
      filtro:=buscatroca(filtro,'.','');
      end; }

    for i := 0 to funCountChar(filtro, ',') do
      filtro := BuscaTroca(filtro, ',', '.');
  end;
  Result := filtro;
end;

procedure TFraBase.AjustaBotaoFiltro;
var
  vlBtnVerFiltros: TBitBtn;
begin
  vlBtnVerFiltros := (PlBotaoFiltro.FindComponent('bactverfiltros') as TBitBtn);

  if vlBtnVerFiltros <> nil then
    if Difi.DataSet.Active then
    begin
      ActVerFiltros.caption := 'Mostrar Filtro';

      if Difi.DataSet.RecordCount > 0 then
        vlBtnVerFiltros.visible := true
      else
        vlBtnVerFiltros.visible := False;
    end
    else
      vlBtnVerFiltros.visible := False;
end;

procedure TFraBase.ActConfigExecute(Sender: TObject);
begin
  { definir na tela }
end;

procedure TFraBase.ActConfiguracoesExecute(Sender: TObject);
var
  Cols: Integer;
begin

  { * identifica a coluna selecioanda como ordem atual da lista * }
  for Cols := 0 to DBGLista.Columns.Count - 1 do
  begin
    if DBGLista.Columns[Cols].Title.Font.Color = clRed then
      break
  end;

  (* Persite ajustes que o usuário possa ter feito nessa execução *)
  SalvarColunas(DBGLista);

  { * chama formulario para ajustar os campos que serao visiveis para a lista atual * }
  fcpc := Tfcpc.Create(self);
  try
    cpg.Close;
    cpg.Params[0].AsInteger := Acesso.Usuario;
    cpg.Params[1].AsString := self.Name + '-' + DBGLista.Name;
    cpg.Open;

    cpc.Close;
    cpc.Params[0].AsInteger := self.cpgcpgchave.AsInteger;
    cpc.Open;

    fcpc.DScpc.DataSet := cpc;
    fcpc.DBGLista.Columns[0].Field := cpc.FieldByName('cpcvisivel');
    fcpc.DBGLista.Columns[1].Field := cpc.FieldByName('cpctitulo');

    fcpc.ShowModal;

    CarregarColunas(DBGLista);
    { * seleciona novamente a coluna previamente salva para a ordem da lista * }
    DBGListaTitleClick(self.DBGLista.Columns[Cols]);

  finally
    fcpc.Free;
  end;
end;

function TFraBase.AutenticaUsuario(vUsrCodigo: string): Boolean;
var
  exec: Taces;
  vu: string;
begin
  pack := LoadPackage('modulos\macs.bpl');
  if pack <> 0 then
    try
      @exec := GetProcAddress(pack, Pchar('acesso'));

      if Assigned(exec) then
      begin
        vu := exec(Application, ZCone);
      end;
    finally
      DoUnLoadPackage(Application, pack);
    end;

  if vu = '' then
  begin
    Result := False;
  end
  else
  begin
    if vUsrCodigo = vu then
      Result := true
    else
      Result := False;
  end;
end;

procedure TFraBase.ActExcluirExecute(Sender: TObject);
begin
  if self.Autorizado(Sender) then
    if (Sender is TAction) then
      if (Sender as TAction).Tag > 0 then
      begin
        // Exclui registro selecionado
        if ActExcluir.Enabled = False then
        begin
          ShowMessage('Excluir não autorizada!');
        end
        else
        begin
          if Application.MessageBox(Pchar('Confirma a exclusão do registro selecionado?'), Pchar('Excluir'), MB_TASKMODAL + MB_ICONQUESTION + MB_YESNO + MB_DEFBUTTON2) = idYes then
          begin
            self.uqtabela.Delete;
            try
              self.ActAtualizar.Execute;
            except

            end;
          end;
        end;
      end
      else
      begin

      end
    else
    begin
      ShowMessage('Verificar direitos de acesso!');
    end;
end;

procedure TFraBase.ChamaFiltro(pChave: string);
begin
  { definições de filtros }
  try
    Application.CreateForm(tffiltro, ffiltro);
    ffiltro.vclscodigo := self.clsclscodigo.AsString;
    ffiltro.vclbcodigo := Acesso.Usuario.ToString;

    if pos('view_', lowercase(self.uqtabela.SQL.text)) > 0 then
      ffiltro.vtipcons := 'view'
    else
      ffiltro.vtipcons := 'sql';

    if pChave = '' then
    begin
      ffiltro.vnomecol := self.vnomecol;
      ffiltro.vtipocol := self.vtipocol;
      ffiltro.vtitucol := self.vtitucol;
    end
    else
    begin
      ffiltro.ifi.Connection := self.ZCone;
      ffiltro.fil.Connection := self.ZCone;

      ffiltro.fil.Close;
      ffiltro.fil.Params[0].AsInteger := self.clsclscodigo.AsInteger;
      ffiltro.fil.Params[1].AsInteger := Acesso.Usuario;
      ffiltro.fil.Open;

      ffiltro.ifi.Close;
      ffiltro.ifi.Params[0].AsString := ffiltro.filfilcodigo.AsString;
      ffiltro.ifi.Open;

      ffiltro.ifi.Locate('ifichave', pChave, []);

      ffiltro.vnomecol := ffiltro.ifiificampo.AsString;

      case ffiltro.ifiifitipocampo.AsInteger of
        1:
          vtipocol := ftString;
        2:
          vtipocol := ftInteger;
        3:
          vtipocol := ftFloat;
        4:
          vtipocol := ftDate;
        5:
          vtipocol := ftArray;
      end;

      ffiltro.vtitucol := ffiltro.ifiifititulo.AsString;
    end;

    ffiltro.vAliasTabela := vAliasTabela;
    ffiltro.vifichave := pChave;
    ffiltro.vpalavra := self.vpalavra;

    ffiltro.vfiltrosql := TxtFiltroSQL;

    ffiltro.vsqloriginal := SQLOriginal;

    ffiltro.ZCone := self.ZCone;

    if ffiltro.ShowModal = mrOk then
    begin
      self.edbusca.Hint := '';
      self.edbusca.text := '';

      ActAtualizar.Execute;
    end;
  finally
    FreeAndNil(ffiltro);
  end;
end;

procedure TFraBase.ActFiltrarExecute(Sender: TObject);
var
  vifichave: string;
  vlNomeAtualCol: String;
begin

  { definições de filtros }

  vtitucol := self.DBGLista.Columns[self.DBGLista.SelectedIndex].Title.caption;
  vnomecol := self.DBGLista.Columns[self.DBGLista.SelectedIndex].FieldName;
  vlNomeAtualCol := TCRFieldDesc(TDBAccessUtils.GetIRecordSet(uqtabela).FieldByName(self.vnomecol)).ActualName;

  vAliasTabela := TCRFieldDesc(TDBAccessUtils.GetIRecordSet(uqtabela).FieldByName(self.vnomecol)).TableInfo.TableAlias;

  if vAliasTabela = '' then
    vAliasTabela := TCRFieldDesc(TDBAccessUtils.GetIRecordSet(uqtabela).FieldByName(self.vnomecol)).TableInfo.TableName;

  vnomecol := vlNomeAtualCol;

  if self.DBGLista.Columns[self.DBGLista.SelectedIndex].Field.Tag = 999 then
    vtipocol := ftArray
  else
    vtipocol := self.DBGLista.Columns[self.DBGLista.SelectedIndex].Field.DataType;

  vifichave := '';

  if vtipocol = ftArray then
  begin
    consulta.Close;
    consulta.SQL.text := 'SELECT ifi.ifichave FROM ifi, fil WHERE ';
    consulta.SQL.add('ifi.filcodigo = fil.filcodigo AND ');
    consulta.SQL.add('fil.clbcodigo = ' + Acesso.Usuario.ToString + '  AND ');
    consulta.SQL.add('ifi.ificampo = ''' + vnomecol + ''' AND ');
    consulta.SQL.add('ifimetodo=5');
    consulta.Open;

    vifichave := consulta.Fields[0].AsString;
  end;

  ChamaFiltro(vifichave);
end;

procedure TFraBase.ActPesquisarExecute(Sender: TObject);
var
  vlRegAtual: Integer;
  vfPesquisar: Tfpesquisa;
  vlCampoPesquisa: String;
  vlTextoPesquisa: String;
  i: Integer;
begin
  try
    vlRegAtual := self.uqtabela.Fields[0].AsInteger;

    DBGListaTitleClick(DBGLista.Columns[DBGLista.SelectedIndex]);

    vfPesquisar := Tfpesquisa.Create(self);
    vfPesquisar.campos.Open;
    cpc.First;
    while not cpc.Eof do
    begin
      if cpccpcvisivel.AsInteger = 1 then
      begin
        vfPesquisar.campos.Append;
        vfPesquisar.camposnomecampo.AsString := cpccpccampo.AsString;
        vfPesquisar.campostitulocampo.AsString := cpccpctitulo.AsString;
        vfPesquisar.campos.Post;
      end;

      cpc.Next;
    end;

    if vfPesquisar.ShowModal = mrOk then
    begin

      vlCampoPesquisa := vfPesquisar.vpCampoPesquisa;
      vlTextoPesquisa := vfPesquisar.vpTextoPesquisa;

      if (vlCampoPesquisa <> '') and (vlTextoPesquisa <> '') then
      begin
        for i := 0 to DBGLista.Columns.Count - 1 do
        begin
          if lowercase(DBGLista.Columns[i].FieldName) = lowercase(vlCampoPesquisa) then
          begin
            DBGListaTitleClick(DBGLista.Columns[i]);
            break
          end;
        end;

        uqtabela.Locate(vlCampoPesquisa, vlTextoPesquisa, [loPartialKey, loCaseInsensitive]);
      end;

    end;

  finally
    FreeAndNil(vfPesquisar);
  end;
end;

procedure TFraBase.ActRelatoriosExecute(Sender: TObject);
var
  vlBtnRel: TBitBtn;
  vlPoint: TPoint;
begin
  vlBtnRel := self.PlBotoes.FindComponent('bActRelatorios') as TBitBtn;

  vlPoint := Point(0, 0);
  vlPoint := vlBtnRel.ClientToScreen(vlPoint);

  MontaMenuRelatorios;
  vlBtnRel.PopupMenu := MenuRelatorios;
  MenuRelatorios.Popup(vlPoint.X + vlBtnRel.Width, vlPoint.Y);
end;

procedure TFraBase.ActSairExecute(Sender: TObject);
var
  vlTabSheet: TTabSheet;
begin
  self.vretorno := self.uqtabela.Fields[0].AsString;
  self.Descarregar;

  if (self.Parent is TForm) then
  begin
    FPodeFechar := true;
    (self.Parent as TForm).Close;
    (self.Parent as TForm).ModalResult := mrOk;
  end
  else if self.Parent is TTabSheet then
  begin
    vlTabSheet := Parent as TTabSheet;
    Free; // Libera o Frame
    vlTabSheet.Free; // Libera tab Pai do Frame
  end;

end;

procedure TFraBase.ActVerFiltrosExecute(Sender: TObject);
begin
  if (PlSelecao.visible = False) and (ifi.RecordCount > 0) then
  begin
    (SplBotoes.FindComponent('bactverfiltros') as TBitBtn).caption := 'Ocultar Filtro';
    PlSelecao.visible := true;
  end
  else
  begin
    (SplBotoes.FindComponent('bactverfiltros') as TBitBtn).caption := 'Mostrar Filtro';
    PlSelecao.visible := False;
  end;
end;

procedure TFraBase.DBGListaCellClick(Column: TColumn);
begin
  // RegistraEvento(Column);

  { vtitucol := Column.Title.caption;
    vnomecol := Column.FieldName;
    vtipocol := Column.Field.DataType; }
  if pos('.', self.vnomecol) > 0 then
    self.vnomecol := Trim(Copy(self.vnomecol, pos('.', self.vnomecol) + 1, 200));

  if (vtipocol = ftString) then
  begin
    vpalavra := self.DBGLista.DataSource.DataSet.FieldByName(self.vnomecol).AsString;
  end
  else
  begin
    vpalavra := '';
  end;

end;

procedure TFraBase.DBGListaColEnter(Sender: TObject);
begin
  { vtitucol := DBGLista.Columns[DBGLista.SelectedIndex].Title.caption;
    vnomecol := DBGLista.Columns[DBGLista.SelectedIndex].FieldName;
    vtipocol := DBGLista.Columns[DBGLista.SelectedIndex].Field.DataType; }
  if pos('.', self.vnomecol) > 0 then
    self.vnomecol := Trim(Copy(self.vnomecol, pos('.', self.vnomecol) + 1, 200));

  if (vtipocol = ftString) then
  begin
    vpalavra := self.DBGLista.DataSource.DataSet.FieldByName(self.vnomecol).AsString;
  end
  else
  begin
    vpalavra := '';
  end;

end;

procedure TFraBase.DBGListaColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  AjustarPosicaoBotoesFiltro(Sender);
  SalvarLarguraEPosicao;
end;

procedure TFraBase.DBGListaDblClick(Sender: TObject);
begin
  if self.PlFiltros.visible then
  begin
    if edbusca.Tag = 1 then
      self.ActSair.Execute
    else if self.ActAlterar.Enabled then
      self.ActAlterar.Execute;
  end
  else if self.ActAlterar.Enabled then
    self.ActAlterar.Execute;
end;

procedure TFraBase.DBGListaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
var
  fixRect: TRect;
  btBmp: TPanel;
  R: TRect;
  Bmp: TBitMap;

  function GetColsWidth: Integer;
  var
    i: Integer;
  begin
    Result := 0;
    for i := 0 to Column.Index do
    begin
      Result := Result + TDBGrid(Sender).Columns.Items[i].Width;
    end;
    Result := Result + 10 + (Column.Index);
  end;

begin

  { with TFriendly(DBGLista) do
    begin
    try
    if self.FindComponent('btntopofiltro' + Column.FieldName) = nil then
    begin

    Bmp := TBitMap.Create;
    with Bmp do
    begin

    TransparentColor := CLWHITE;
    Transparent := true;
    TransparentMode := tmAuto
    end;

    ImageList1.GetBitmap(0, Bmp);

    btBmp := TPanel.Create(self);
    btBmp.Name := 'btntopofiltro' + Column.FieldName;
    btBmp.Parent := DBGLista;
    btBmp.caption := '>';
    // btBmp.NumGlyphs := 1;
    // btBmp.Glyph := Bmp;

    btBmp.Top := 2;
    btBmp.Width := RowHeights[0];
    btBmp.Height := RowHeights[0] - 3;
    btBmp.Tag := GetColsWidth;
    btBmp.Hint := Column.Title.caption;

    btBmp.Left := GetColsWidth - btBmp.Width;
    btBmp.OnClick := onMostraFiltrodoBotao;

    end;
    finally
    end;
    end; }

  { }

  fixRect := Rect;

  if Odd(DSTabela.DataSet.RecNo) then
    DBGLista.Canvas.Brush.Color := $00FFF0DD // $00FFEBD7
  else
    DBGLista.Canvas.Brush.Color := CLWHITE;

  if gdSelected in State then
    with (Sender as TDBGrid).Canvas do
    begin
      Brush.Color := PEG_COR_SELCGRID;
      FillRect(fixRect);
      // Font.Color := CLWHITE;
      Font.Style := [fsbold];
    end;

  { Get active record within grids TDataLink. The active record will be
    the current record in the dataset. Check against Row that we are
    trying to Draw, -1 to offset the column headings within grid. }
  with TFriendly(DBGLista) do

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
      with Canvas do
      begin
        Brush.Color := PEG_COR_SELCGRID; { set grids canvas to win highlight colour }
        DefaultDrawColumnCell(fixRect, DataCol, Column, State); { now redraw the cell, but highlighted }
      end;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);
end;

procedure TFraBase.onMostraFiltrodoBotao(Sender: TObject);
var
  ffiltrocoluna: Tffiltrocoluna;
  vlNomeColuna: String;
  pt: TPoint;
  s: Integer;
  sqlbase: string;
  vlFiltroRetornado: string;

begin
  vlNomeColuna := Copy((Sender as TPanel).Name, 14, 200);

  sqlbase := uqtabela.SQL.text;

  sqlbase := 'select 1 as tmpselecionar, ' + vlNomeColuna + '  from ' + Copy(sqlbase, pos('from', lowercase(sqlbase)) + 4, 10000) + ' group by ' + vlNomeColuna + ' order by ' +
    vlNomeColuna;

  GetCursorPos(pt);

  Application.CreateForm(Tffiltrocoluna, ffiltrocoluna);

  ffiltrocoluna.Top := pt.Y;
  ffiltrocoluna.tmp.Connection := ZCone;
  ffiltrocoluna.filtro.Connection := ZCone;
  ffiltrocoluna.consulta.Connection := ZCone;
  ffiltrocoluna.vpNomeColuna := vlNomeColuna;
  ffiltrocoluna.vpNomeformulario := self.Name;
  ffiltrocoluna.vpclbcodigo := Acesso.Usuario.ToString;
  ffiltrocoluna.vpSqlBase := sqlbase;

  if pt.X - ffiltrocoluna.Width > 0 then
    ffiltrocoluna.Left := pt.X - ffiltrocoluna.Width
  else
    ffiltrocoluna.Left := 0;

  ffiltrocoluna.ShowModal;

  vlFiltroRetornado := ffiltrocoluna.vpSqlfiltrRetorno;

  if vlFiltroRetornado <> '' then
  begin
    if uqtabela.FilterSQL <> '' then
      uqtabela.FilterSQL := uqtabela.FilterSQL + ' and ' + vlFiltroRetornado
    else
      uqtabela.FilterSQL := vlFiltroRetornado;
  end;

  PlQtdRecno.caption := 'Registros: ' + IntToStr(self.uqtabela.RecordCount);

end;

procedure TFraBase.onOcultaFiltrodoBotao(Sender: TObject);
var
  h: hwnd;
begin

end;

procedure TFraBase.DBGListaKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (((Shift = [ssCtrl]) And (Key = VK_DELETE))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) then
    Abort;
end;

procedure TFraBase.DBGListaKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    if self.PlFiltros.visible then
      if edbusca.Tag = 1 then
      begin
        self.ActSair.Execute;
        exit;
      end;

    if self.ActAlterar.Enabled then
      self.ActAlterar.Execute;
  end
  else if Key = #27 then
    if (self.Parent is TForm) then
    begin
      PodeFechar := true;
      (self.Parent as TForm).Close;
      (self.Parent as TForm).ModalResult := mrCancel;
    end;
end;

procedure TFraBase.DBGListaKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_UP then
    if self.DSTabela.DataSet.Bof then
      if self.PlFiltros.visible then
      begin
        try
          edbusca.SetFocus;
        except
        end;
      end;
end;

procedure TFraBase.DBGListaMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin

  AjustarPosicaoBotoesFiltro(Sender);
end;

procedure TFraBase.DBGListaTitleClick(Column: TColumn);
var
  i: Integer;
  vCampoPrincipal: String;
  vRegistroAtual: String;
  ed: TEdit;
  pt: TPoint;

begin

  vCampoPrincipal := DSTabela.DataSet.Fields[0].FieldName;
  vRegistroAtual := DSTabela.DataSet.Fields[0].AsString;

  if (Column.FieldName <> 'ccovencimento') and (Column.FieldName <> 'ccoemissao') then
  begin
    if DSTabela.DataSet = uqtabela then
    begin

      if not uqtabela.SmartFetch.Enabled then
      begin
        try
          { if pos(' ASC', uqtabela.IndexFieldNames) > 0 then
            uqtabela.IndexFieldNames := Column.FieldName + ' DESC'
            else
            uqtabela.IndexFieldNames := Column.FieldName + ' ASC'; }

          uqtabela.IndexFieldNames := Column.FieldName

        except

          try
            uqtabela.IndexFieldNames := Column.FieldName;
          except

          end;
        end;
      end
      else
      begin
        try
          uqtabela.IndexFieldNames := Column.FieldName;
        except

        end;

      end;
    end;

    if DSTabela.DataSet is TVirtualTable then
      (DSTabela.DataSet as TVirtualTable).IndexFieldNames := Column.FieldName;
  end;

  vtitucol := DBGLista.Columns[Column.Index].Title.caption;
  vnomecol := Column.Field.FieldName;

  if Column.Field.FieldKind = fkData then
    vtipocol := Column.Field.DataType
  else if Column.Field.Tag = 999 then
    vtipocol := ftArray;

  if (vtipocol = ftString) then
    vpalavra := self.DSTabela.DataSet.FieldByName(vnomecol).AsString
  else
    vpalavra := '';

  for i := 0 to DBGLista.Columns.Count - 1 do
  begin
    DBGLista.Columns[i].Title.Font.Color := clBlack;
    DBGLista.Columns[i].Title.Font.Style := [];
  end;

  DBGLista.Columns[Column.Index].Title.Font.Color := clRed;
  DBGLista.Columns[Column.Index].Title.Font.Style := [fsbold];
  GrBTextoProcurar.caption := 'Buscar por ' + DBGLista.Columns[Column.Index].Title.caption + ' [+] Muda Ordem';

  // vordem := Self.DSTabela.DataSet.Fields[Column.Index].FieldName;
  vordem := Column.Field.FieldName;

  DBGLista.SelectedIndex := Column.Index;
  xordem := Column.Index;

  cls.Edit;
  clsclsordem.AsInteger := xordem;
  cls.Post;

  if DSTabela.DataSet.Active then
    DSTabela.DataSet.Locate(vCampoPrincipal, vRegistroAtual, []);

  SalvarLarguraEPosicao;

  // onMostraFiltrodoBotao(Column.FieldName);

end;

procedure TFraBase.DBGSugestaoCellClick(Column: TColumn);
begin
  if self.FindComponent('debusca') <> nil then
    TDBEdit(self.FindComponent('debusca')).Field.text := qrySugestao.Fields[0].AsString;

end;

procedure TFraBase.DBGSugestaoKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    if self.FindComponent('edbusca') <> nil then
      TEdit(self.FindComponent('edbusca')).text := qrySugestao.Fields[0].AsString;
    try
      bConfirmaSelecao.SetFocus;
    except

    end;
  end;

end;

procedure TFraBase.DBListaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  if Odd(Difi.DataSet.RecNo) then
    DBLista.Canvas.Brush.Color := $00FFEBD7
  else
    DBLista.Canvas.Brush.Color := CLWHITE;

  TDBGrid(Sender).Canvas.Font.Color := clBlack;

  if gdSelected in State then
    with (Sender as TDBGrid).Canvas do
    begin
      Brush.Color := PEG_COR_SELCGRID; // $004080FF;
      FillRect(Rect);
      Font.Style := [fsbold];
      // Font.Color := clnavy;
    end;

  TDBGrid(Sender).DefaultDrawDataCell(Rect, TDBGrid(Sender).Columns[DataCol].Field, State);
end;

procedure TFraBase.DifiUpdateData(Sender: TObject);
begin
  AjustaBotaoFiltro;

end;

procedure TFraBase.DSTabelaDataChange(Sender: TObject; Field: TField);
begin
  if not self.uqtabela.IsEmpty then
    self.vChave := self.uqtabela.Fields[0].AsString;
end;

procedure TFraBase.edbuscaEnter(Sender: TObject);
begin
  vpfiltroSugestao := '';
  // DBGListaTitleClick(DBGLista.Columns[DBGLista.SelectedIndex]);
  edbusca.SelectAll;
end;

procedure TFraBase.edbuscaKeyPress(Sender: TObject; var Key: Char);
begin
  case Key of
    #13:
      begin
        RegistraEvento(Sender);
        if edbusca.Tag = 1 then
          if DBGLista.visible then
          begin
            try
              DBGLista.SetFocus;
            except
            end;

            self.ActSair.Execute;
            exit;
          end;

        if self.ActAlterar.Enabled then
          self.ActAlterar.Execute;
      end;
    #27:
      if (self.Parent is TForm) then
      begin
        PodeFechar := true;
        (self.Parent as TForm).Close;
        (self.Parent as TForm).ModalResult := mrCancel;
      end;
  else
    edbusca.Hint := 'Digite o texto para pesquisa';
  end;
end;

procedure TFraBase.RegistraEvento(Sender: TObject);
begin
  lou.Close;
  lou.Open;

  lou.Append;
  louclbcodigo.AsInteger := Acesso.Usuario;

  louloudatahora.AsDateTime := StrtoDateTime(agora(Application, ZCone));
  loulouaplicacao.AsString := extractfilename(Application.ExeName);
  loulouformulario.AsString := self.Name;

  if (Sender is TColumn) then
  begin
    loulounomecomponente.AsString := (Sender as TColumn).grid.Name + '>' + (Sender as TColumn).FieldName;
    louloutipocomponente.AsString := 'dbgrid';
    loulouconteudocomponente.AsString := (Sender as TColumn).Field.AsString;
  end;

  if (Sender is TEdit) then
  begin
    loulounomecomponente.AsString := (Sender as TEdit).Name;
    louloutipocomponente.AsString := 'edit';
    loulouconteudocomponente.AsString := (Sender as TEdit).text;
  end;

  if (Sender is TAction) then
  begin
    loulounomecomponente.AsString := (Sender as TAction).Name;
    louloutipocomponente.AsString := 'action';
    loulouconteudocomponente.AsString := '';
  end;

  loulouacaocomponente.AsString := 'Click';

  lou.Post;

end;

procedure TFraBase.edbuscaKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
var
  vlRegAtual: Integer;
Var
  query: String;
  filtro: String;
  linha: String;
  i: Integer;
  pala1: String;
  pala2: String;
  pala3: String;
  pala4: String;
  pala5: String;

  vlsqlbase: string;
  vlInicio: Integer;
  vlNomeChave: string;
  vlCampos: String;
  vlTabela: String;
  vlSqlOriginal: string;
  LocalizacaoNormal: Boolean;

  vlNomeColuna: String;
  vTabSugestao: String;
  vCamSugestao: string;
  vifichave: string;
  X: Integer;
Begin
  X := 0;
  for X := 0 to DBGLista.Columns.Count - 1 do
  begin
    if DBGLista.Columns[X].Title.Font.Color = clRed then
      break;

  end;

  if (edbusca.Color = $00D9FFFF) or (DBGLista.Columns[X].Field.DataType = ftInteger) then // pesquisa normal
  begin

    LocalizacaoNormal := true;
  end
  else if edbusca.Color = $00AAFFFF then // filtro com sugestao
  begin

    if edbusca.text = '' then
    begin
      edbusca.Hint := '';
      edbusca.text := '';
      plSugestao.visible := False;
      ActAtualizar.Execute;
      exit;
    end;

    if (Key = $1B) or (Key = 27) then
    begin
      edbusca.Hint := '';
      edbusca.text := '';
      plSugestao.visible := False;
      ActAtualizar.Execute;
      try
        DBGLista.SetFocus;
      except

      end;
      exit;
    end;

    if (pos('.', vnomecol) = 0) then
      if vAliasTabela <> '' then
        vnomecol := vAliasTabela + '.' + vnomecol
      else
      begin
        vnomecol := Copy(vnomecol, 1, 3) + '.' + vnomecol;
      end;

    vtitucol := ifiifititulo.AsString;

    vpalavra := self.edbusca.text;

    sfi.Close;
    sfi.Params[0].AsString := self.ifiifichave.AsString;
    sfi.Open;

    { if vifichave = '' then
      begin
      sfi.Append;
      sfiifichave.AsInteger := Self.ifiifichave.AsInteger;
      sfisfitexto.AsString := Self.vpalavra;
      sfi.Post;
      end;
      sfi.Edit; }

    { if (vpalavra <> '') then
      begin
      texto.Text := vpalavra;
      end
      else
      begin
      if Self.vifichave = '' then
      begin
      texto.Text := '';
      end;
      end; }

    DBGSugestao.visible := true;
    DBGSugestao.Columns.Clear;
    DBGSugestao.Columns.add;
    DBGSugestao.Columns[0].Width := DBGSugestao.Width - 22;
    if pos('.', vnomecol) = 0 then
      vlNomeColuna := vnomecol
    else
      vlNomeColuna := Copy(vnomecol, pos('.', vnomecol) + 1, 100);

    DBGSugestao.Columns[0].FieldName := vlNomeColuna;

    vordem := vlNomeColuna;

    vTabSugestao := Copy(vlNomeColuna, 1, 3);
    vCamSugestao := vlNomeColuna;

    qrySugestao.Close;
    qrySugestao.FilterSQL := '';
    qrySugestao.Fields.Clear;
    qrySugestao.SQL.text := 'select distinct ' + vlNomeColuna + ' from ' + Copy(vlNomeColuna, 1, 3) + ' order by ' + vlNomeColuna;

    if vpfiltroSugestao <> '' then
      qrySugestao.FilterSQL := vpfiltroSugestao;

    qrySugestao.Open;

    if TEdit(Sender).text = '' then
    begin
      qrySugestao.FilterSQL := '';

      if (Key = 38) then
      begin
        if DBGSugestao.visible then
          self.bConfirmaSelecao.SetFocus;

        exit;
      end
      else
        self.ActAtualizar.Execute;

    end
    else
    begin
      if (Key = 40) then
      begin
        if DBGSugestao.visible then
        begin

          if (DBGSugestao.visible) and (DBGSugestao.Enabled) then
          begin
            try
              DBGSugestao.SetFocus;
            except

            end;
            qrySugestao.Next;
          end;

        end;

        exit;
      end;

      linha := Trim(TEdit(Sender).text);
      filtro := Trim(TEdit(Sender).text);
      i := pos(' ', linha) - 1;
      If i > 0 Then
      Begin
        pala1 := Copy(linha, 1, i);
        linha := Trim(Copy(linha, i + 1, Length(linha)));
        i := pos(' ', linha) - 1;
        If i > 0 Then
        Begin
          pala2 := Trim(Copy(linha, 1, i));
          linha := Trim(Copy(linha, i + 1, Length(linha)));

          i := pos(' ', linha) - 1;
          If i > 0 Then
          Begin
            pala3 := Copy(linha, 1, i);
            linha := Trim(Copy(linha, i + 1, Length(linha)));

            If i > 0 Then
            Begin
              pala4 := Copy(linha, 1, i);
              linha := Trim(Copy(linha, i + 1, Length(linha)));

              If i > 0 Then
              Begin
                pala5 := Copy(linha, 1, i);
                linha := Trim(Copy(linha, i + 1, Length(linha)));
              End
              Else
              Begin
                pala5 := Trim(Copy(linha, 1, Length(linha)));
              End;

            End
            Else
            Begin
              pala4 := Trim(Copy(linha, 1, Length(linha)));
            End;

          End
          Else
          Begin
            pala3 := Trim(Copy(linha, 1, Length(linha)));
          End;

        End
        Else
        Begin
          pala2 := Trim(Copy(linha, 1, Length(linha)));

        End;

      End
      Else
      Begin
        filtro := 'lower(' + vordem + ') like ' + Chr(39) + lowercase(linha) + '%' + Chr(39);
      End;

      If pala1 <> '' Then
      Begin
        filtro := ' lower(' + vordem + ') like ' + Chr(39) + lowercase(pala1) + '%' + Chr(39);
      End;

      If pala2 <> '' Then
      Begin
        filtro := filtro + ' and lower(' + vordem + ') like ' + Chr(39) + '%' + lowercase(pala2) + '%' + Chr(39);
      End;

      If pala3 <> '' Then
      Begin
        filtro := filtro + ' and lower(' + vordem + ') like ' + Chr(39) + '%' + lowercase(pala3) + '%' + Chr(39);
      End;

      If pala4 <> '' Then
      Begin
        filtro := filtro + ' and lower(' + vordem + ') like ' + Chr(39) + '%' + lowercase(pala4) + '%' + Chr(39);
      End;

      If pala5 <> '' Then
      Begin
        filtro := filtro + ' and lower(' + vordem + ') like ' + Chr(39) + '%' + lowercase(pala5) + '%' + Chr(39);
      End;

      vlsqlbase := lowercase(qrySugestao.SQL.text);

      vlNomeChave := Trim(Copy(vlsqlbase, pos(' ', vlsqlbase), 50));
      vlNomeChave := Trim(Copy(vlNomeChave, 1, pos(',', vlNomeChave) - 1));

      vlInicio := pos('from', vlsqlbase);
      vlsqlbase := Copy(vlsqlbase, vlInicio, Length(vlsqlbase));

      if pos('order by', vlsqlbase) > 0 then
      begin
        vlInicio := pos('order by', vlsqlbase);
        vlsqlbase := Copy(vlsqlbase, 1, vlInicio - 1);
      end;

      if pos('.', vlNomeChave) > 0 then
      begin
        vlTabela := Copy(vlNomeChave, 1, pos('.', vlNomeChave) - 1);
        vlNomeChave := Copy(vlNomeChave, pos('.', vlNomeChave) + 1);
        if uppercase(Trim(vlNomeChave)) = uppercase(Trim(vordem)) then
        begin
          vlCampos := vlTabela + '.' + vlNomeChave;
          filtro := StringReplace(filtro, vordem, vlCampos, [rfReplaceAll]);
        end
        else
        begin
          vlCampos := vlTabela + '.' + vlNomeChave + ', ' + vordem;
        end;

      end
      else
        vlCampos := vlTabela + '.' + vlNomeChave + ', ' + vordem;

      if uppercase(Trim(vlNomeChave)) <> uppercase(Trim(vordem)) then
      begin

        if pos('where', vlsqlbase) > 0 then
          query := 'select distinct ' + vlCampos + ' ' + vlsqlbase + ' ' + 'and ' + filtro + ' order by ' + vlCampos + ' limit 100'
        else
          query := 'select distinct ' + vlCampos + ' ' + vlsqlbase + ' ' + 'where ' + filtro + ' order by ' + vlCampos + ' limit 100';

        vlSqlOriginal := qrySugestao.SQL.text;

        if filtro <> '' then
        begin

          if pos(' limit 100', qrySugestao.SQL.text) = 0 then
            qrySugestao.SQL.text := qrySugestao.SQL.text + ' limit 100';

          If TEdit(Sender).text <> '' Then
          Begin
            if pos(' limit 100', qrySugestao.SQL.text) = 0 then
              qrySugestao.SQL.text := qrySugestao.SQL.text + ' limit 100';
          End
          else
          begin
            qrySugestao.SQL.text := StringReplace(qrySugestao.SQL.text, ' limit 100', '', [rfReplaceAll, rfIgnoreCase]);
          end;
          vpfiltroSugestao := filtro;
          qrySugestao.FilterSQL := filtro;

          if (pos('cpa', self.Name) > 0) or (pos('brp', self.Name) > 0) then
          begin
            qrySugestao.SQL.text := StringReplace(qrySugestao.SQL.text, 'from etd order by', 'from etd,etv where etd.etdcodigo=etv.etdcodigo and etv.tvicodigo=2 order by',
              [rfReplaceAll, rfIgnoreCase]);
          end
          else if (pos('cre', self.Name) > 0) or (pos('brr', self.Name) > 0) then
          begin
            qrySugestao.SQL.text := StringReplace(qrySugestao.SQL.text, 'from etd order by', 'from etd,etv where etd.etdcodigo=etv.etdcodigo and etv.tvicodigo=1 order by',
              [rfReplaceAll, rfIgnoreCase]);
          end;

          if not qrySugestao.Active then
            qrySugestao.Open;

          plSugestao.visible := true;

        end
        else
        begin

        end;

        inherited;
      end
      else
      begin
        inherited;
      end;

    end;

  end
  else
  begin

    if edbusca.text = '' then
    begin
      btLimpaBusca.Color := clBtnFace;
      uqtabela.FilterSQL := '';
      ActAtualizar.Execute;
      if (Key = 38) then
      begin
        if DBGLista.visible then
          self.DBGLista.SetFocus;
        self.uqtabela.Prior;
        exit;
      end;

      if (Key = 40) or (Key = 39) then
      begin
        if DBGLista.visible then
        begin
          try
            self.DBGLista.SetFocus;
          except

          end;
        end;
        self.uqtabela.Next;
        exit;
      end;
    end
    else
    begin
      if (self.ModoFrame = modoPesquisa) or (self.ModoFrame = modoPesqEdicao) then
      begin

        linha := Trim(edbusca.text);
        filtro := Trim(edbusca.text);
        i := pos(' ', linha) - 1;
        If i > 0 Then
        Begin
          pala1 := Copy(linha, 1, i);
          linha := Trim(Copy(linha, i + 1, Length(linha)));
          i := pos(' ', linha) - 1;
          If i > 0 Then
          Begin
            pala2 := Trim(Copy(linha, 1, i));
            linha := Trim(Copy(linha, i + 1, Length(linha)));

            i := pos(' ', linha) - 1;
            If i > 0 Then
            Begin
              pala3 := Copy(linha, 1, i);
              linha := Trim(Copy(linha, i + 1, Length(linha)));

              If i > 0 Then
              Begin
                pala4 := Copy(linha, 1, i);
                linha := Trim(Copy(linha, i + 1, Length(linha)));

                If i > 0 Then
                Begin
                  pala5 := Copy(linha, 1, i);
                  linha := Trim(Copy(linha, i + 1, Length(linha)));
                End
                Else
                Begin
                  pala5 := Trim(Copy(linha, 1, Length(linha)));
                End;

              End
              Else
              Begin
                pala4 := Trim(Copy(linha, 1, Length(linha)));
              End;

            End
            Else
            Begin
              pala3 := Trim(Copy(linha, 1, Length(linha)));
            End;

          End
          Else
          Begin
            pala2 := Trim(Copy(linha, 1, Length(linha)));

          End;

        End
        Else
        Begin
          filtro := 'lower(' + vordem + ') like ' + Chr(39) + '%' + lowercase(linha) + '%' + Chr(39);
        End;

        If pala1 <> '' Then
        Begin
          filtro := ' lower(' + vordem + ') like ' + Chr(39) + '%' + lowercase(pala1) + '%' + Chr(39);
        End;

        If pala2 <> '' Then
        Begin
          filtro := filtro + ' and lower(' + vordem + ') like ' + Chr(39) + '%' + lowercase(pala2) + '%' + Chr(39);
        End;

        If pala3 <> '' Then
        Begin
          filtro := filtro + ' and lower(' + vordem + ') like ' + Chr(39) + '%' + lowercase(pala3) + '%' + Chr(39);
        End;

        If pala4 <> '' Then
        Begin
          filtro := filtro + ' and lower(' + vordem + ') like ' + Chr(39) + '%' + lowercase(pala4) + '%' + Chr(39);
        End;

        If pala5 <> '' Then
        Begin
          filtro := filtro + ' and lower(' + vordem + ') like ' + Chr(39) + '%' + lowercase(pala5) + '%' + Chr(39);
        End;

        vlsqlbase := lowercase(uqtabela.SQL.text);

        vlNomeChave := Trim(Copy(vlsqlbase, pos(' ', vlsqlbase), 50));
        vlNomeChave := Trim(Copy(vlNomeChave, 1, pos(',', vlNomeChave) - 1));

        vlInicio := pos('from', vlsqlbase);
        vlsqlbase := Copy(vlsqlbase, vlInicio, Length(vlsqlbase));

        if pos('order by', vlsqlbase) > 0 then
        begin
          vlInicio := pos('order by', vlsqlbase);
          vlsqlbase := Copy(vlsqlbase, 1, vlInicio - 1);
        end;

        if pos('.', vlNomeChave) > 0 then
        begin
          vlTabela := Copy(vlNomeChave, 1, pos('.', vlNomeChave) - 1);
          vlNomeChave := Copy(vlNomeChave, pos('.', vlNomeChave) + 1);
          if uppercase(Trim(vlNomeChave)) = uppercase(Trim(vordem)) then
          begin
            vlCampos := vlTabela + '.' + vlNomeChave;
            filtro := StringReplace(filtro, vordem, vlCampos, [rfReplaceAll]);
          end
          else
          begin
            vlCampos := vlTabela + '.' + vlNomeChave + ', ' + vordem;
          end;

        end
        else
          vlCampos := vlTabela + '.' + vlNomeChave + ', ' + vordem;

        if uppercase(Trim(vlNomeChave)) <> uppercase(Trim(vordem)) then
        begin

          if pos('where', vlsqlbase) > 0 then
            query := 'select distinct ' + vlCampos + ' ' + vlsqlbase + ' ' + 'and ' + filtro + ' order by ' + vlCampos + ' limit 1000'
          else
            query := 'select distinct ' + vlCampos + ' ' + vlsqlbase + ' ' + 'where ' + filtro + ' order by ' + vlCampos + ' limit 1000';

          vlSqlOriginal := uqtabela.SQL.text;

          if filtro <> '' then
          begin

            if pos(' limit 1000', uqtabela.SQL.text) = 0 then
              uqtabela.SQL.text := uqtabela.SQL.text + ' limit 1000';

            If edbusca.text <> '' Then
            Begin
              if pos(' limit 1000', uqtabela.SQL.text) = 0 then
                uqtabela.SQL.text := uqtabela.SQL.text + ' limit 1000';
            End
            else
            begin
              uqtabela.SQL.text := StringReplace(uqtabela.SQL.text, ' limit 1000', '', [rfReplaceAll, rfIgnoreCase]);
            end;

            uqtabela.FilterSQL := filtro;

          end
          else
          begin

          end;

          LocalizacaoNormal := true;
        end
        else
        begin
          LocalizacaoNormal := true;
        end;
      end
      else
      begin
        LocalizacaoNormal := true;
      end;

    end;

  end;
  if LocalizacaoNormal then
  begin
    if (Key = 38) then
    begin
      if DBGLista.visible then
      begin
        try
          self.DBGLista.SetFocus;
        except

        end;
      end;
      self.uqtabela.Prior;
      exit;
    end;

    if (Key = 40) or (Key = 39) then
    begin
      if DBGLista.visible then
      begin
        try
          self.DBGLista.SetFocus;
        except

        end;
      end;
      self.uqtabela.Next;
      exit;
    end;

    if (Key = 187) Or (Key = 107) Or (Key = 118) then
    begin
      if edbusca.text = '' then
        vlRegAtual := self.uqtabela.Fields[0].AsInteger;

      if (Key = 187) Or (Key = 107) then
        AjustaOrdem(Key);

      if edbusca.text = '' then
      begin
        if uqtabela.Active then
          uqtabela.Locate(self.uqtabela.Fields[0].FieldName, vlRegAtual, []);
      end;
    end;

    if edbusca.text <> '' then
      AjustaFiltro
    else
    begin
      if DSTabela.DataSet.Active = False then
        DSTabela.DataSet.Open;
    end;

    if (Key = 118) then
      edbusca.SelectAll;

  end;

end;

procedure TFraBase.FechaFiltroTimer(Sender: TObject);
begin
  FechaFiltro.Enabled := False;
  plSugestao.visible := False;
  if edbusca.text = '' then
    self.ActAtualizar.Execute;

end;

procedure TFraBase.filAfterInsert(DataSet: TDataSet);
begin
  self.filfilsqloriginal.AsString := self.uqtabela.SQL.text;
end;

procedure TFraBase.fmdBeforePost(DataSet: TDataSet);
begin
  if fmdfmddtfinal.AsFloat < fmdfmddtinicial.AsFloat then
  begin
    ShowMessage('Data Final não pode ser menor que Data Inicial!');
    DataSet.Cancel;
  end;

end;

procedure TFraBase.fmddtfinalKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    edbusca.text := '';

    fmd.Locate('fmdtitulo', cbTipoData.text, []);

    if fmd.State <> dsbrowse then
      fmd.Post;
    self.ActAtualizar.Execute;
    try
      DBGLista.SetFocus;
    except

    end;
  end
  else if Key = #27 then
  begin
    if fmd.State <> dsbrowse then
      fmd.Cancel;
    try
      DBGLista.SetFocus;
    except

    end;
  end;
end;

procedure TFraBase.fmddtinicialKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    edbusca.text := '';

    fmd.Locate('fmdtitulo', cbTipoData.text, []);

    if fmd.State <> dsbrowse then
      fmd.Post;
    self.ActAtualizar.Execute;
    try
      fmddtfinal.SetFocus;
    except

    end;
  end
  else if Key = #27 then
  begin
    if fmd.State <> dsbrowse then
      fmd.Cancel;
    try
      DBGLista.SetFocus;
    except

    end;
  end;

end;

procedure TFraBase.FrameConstrainedResize(Sender: TObject; var MinWidth, MinHeight, MaxWidth, MaxHeight: Integer);
begin
  try
    if edbusca.visible then
      edbusca.SetFocus;
  except

  end;
end;

procedure TFraBase.FrameResize(Sender: TObject);
begin
  ShowScrollBar(DBGLista.Handle, SB_VERT, true); // forçar a mostragem barra Vertical
  ShowScrollBar(DBGLista.Handle, SB_HORZ, true); // não deixar a mostra a barra horizontal
end;

procedure TFraBase.PosicaoColuna(nomecol: string; lista: TDBGrid; vIndex: Integer);
var
  i: Integer;
begin
  for i := 0 to lista.Columns.Count - 1 do
    if lowercase(lista.Columns[i].FieldName) = lowercase(nomecol) then
    begin
      lista.Columns[i].Index := vIndex;
      break;
    end;
end;

procedure TFraBase.DeletarColuna(nomecol: string; lista: TDBGrid);
var
  i: Integer;
begin
  for i := 0 to lista.Columns.Count - 1 do
    if lowercase(lista.Columns[i].FieldName) = lowercase(nomecol) then
    begin
      lista.Columns.Delete(i);
      break;
    end;
end;

procedure TFraBase.OcultarColuna(nomecol: string; visivel: Boolean; lista: TDBGrid);
var
  i: Integer;
begin
  for i := 0 to lista.Columns.Count - 1 do
    if lowercase(lista.Columns[i].FieldName) = lowercase(nomecol) then
    begin
      lista.Columns[i].visible := visivel;
      break;
    end;
end;

procedure TFraBase.AjustaOrdem(Key: Integer);
var
  i, p: Integer;
begin
  if not(Key in [187, 107, 118]) then
    exit;

  edbusca.text := '';

  for i := 0 to self.DBGLista.Columns.Count - 1 do
    if self.DBGLista.Columns[i].FieldName = vordem then
    begin
      p := (self.DBGLista.Columns.Count - 1);

      if i = p then
        xordem := -1;

      while true do
      begin
        xordem := xordem + 1;

        if self.DBGLista.Columns[xordem].visible then
          break;

        if xordem = p then
        begin
          xordem := 0;
          break;
        end;
      end;

      vordem := self.DBGLista.Columns[xordem].FieldName;
      vpalavra := self.DSTabela.DataSet.FieldByName(vordem).AsString;

      DBGListaTitleClick(DBGLista.Columns[xordem]);

      break;
    end;

end;

procedure TFraBase.Carregar;
var
  vlDirBPL: string;
  vlNomeBPL: string;
  vlFra: TFraBase;
begin

  // try
  // LockWindowUpdate(Handle); { Handle é o handle do form q vc ta mudando }

  try

    FSQlOriginal := uqtabela.SQL.text;

    CarregaColunas;

    if self.Parent is TForm then
      TForm(self.Parent).caption := self.Titulo;

    self.Align := alClient;
    self.visible := true;

    (* Inicializa as permissões atuais do Usuário *)
    dau.Params[0].AsInteger := Acesso.Usuario;
    dau.Open;

    MontaFiltroEsp2;
  finally
    // LockWindowUpdate(0);
  end;
  { except
    LockWindowUpdate(0);
    end; }
end;

procedure TFraBase.Descarregar;
begin
  SalvaColunas;
end;

procedure TFraBase.AjustaFiltro;
var
  vlTexto: string;
begin
  if DSTabela.DataSet.Active = False then
    DSTabela.DataSet.Open;

  vlTexto := self.edbusca.text;
  if vlTexto <> '' then
    DSTabela.DataSet.Locate(self.DBGLista.Columns[xordem].FieldName, vlTexto, [loPartialKey, loCaseInsensitive]);
end;

procedure TFraBase.SalvaColunas;
begin
  if not self.uqtabela.IsEmpty then
    self.vChave := self.uqtabela.Fields[0].AsString
  else
    self.vChave := '0';

  SalvarColunas(self.DBGLista);

  cls.Close;
  cls.SQL.Clear;
  cls.SQL.text := 'select * from cls where usrcodigo=' + Acesso.Usuario.ToString + ' and clsnomeform=' + Chr(39) + self.Name + Chr(39);
  cls.Open;

  if cls.IsEmpty then
  begin
    cls.Append;
    clsusrcodigo.AsInteger := Acesso.Usuario;
    clsclsnomeform.AsString := self.Name;
  end
  else
  begin
    cls.Edit;
  end;

  if (Parent is TForm) then
    if (Parent as TForm).BorderStyle <> bsNone then
    begin
      self.clsclsposiesquerda.AsInteger := Parent.Left;
      self.clsclspositopo.AsInteger := Parent.Top;
      self.clsclsaltura.AsInteger := Parent.Height;
      self.clsclslargura.AsInteger := Parent.Width;
    end;

  self.clsclsrodape.AsInteger := self.PlRodaPe.Height;
  self.clsclsbotoes.AsInteger := self.PlBotoes.Height;
  self.clsclsselecao.AsInteger := self.PlSelecao.Height;

  self.clsclsmodo.AsInteger := 1;

  if (Parent is TForm) then
    if (Parent as TForm).WindowState <> wsNormal then
      self.clsclsmodo.AsInteger := 2;

  clsclsultimo.AsString := self.vChave;
  cls.Post;
end;

procedure TFraBase.SalvarColunas(grid: TDBGrid);
var
  vColuna: Integer;
begin

  cpg.Connection := ZCone;

  cpg.Close;
  cpg.Params[0].AsInteger := Acesso.Usuario;
  cpg.Params[1].AsString := self.Name + '-' + grid.Name;
  cpg.Open;

  if cpg.IsEmpty then
    cpg.Append
  else
    cpg.Edit;

  cpgcpgnomegrid.AsString := self.Name + '-' + grid.Name;
  cpgclbcodigo.AsInteger := Acesso.Usuario;
  cpg.Post;

  cpc.Close;
  cpc.Params[0].AsInteger := self.cpgcpgchave.AsInteger;
  cpc.Open;
  try
    for vColuna := 0 to grid.Columns.Count - 1 do
    begin
      if cpc.Locate('cpccampo', grid.Columns[vColuna].FieldName, [loCaseInsensitive]) then
        cpc.Edit
      else
        cpc.Append;

      cpccpccampo.AsString := grid.Columns[vColuna].FieldName;
      cpccpgchave.AsInteger := self.cpgcpgchave.AsInteger;
      cpccpcordem.AsInteger := grid.Columns[vColuna].Index;
      if grid.Columns[vColuna].Width > 0 then
        cpccpclargura.AsInteger := grid.Columns[vColuna].Width;
      cpccpctitulo.AsString := grid.Columns[vColuna].Title.caption;
      cpccpcvisivel.AsInteger := Ord(grid.Columns[vColuna].visible);
      cpc.Post;
    end;

  except

  end;
end;

procedure TFraBase.CarregarColunas(grid: TDBGrid);
var
  vColuna: Integer;
  vNomeColuna: String;
  vLarguraColuna: Integer;
  vTituloColuna: String;
  vVisivel: Boolean;
begin
  try

    cpg.Connection := self.ZCone;
    cpg.Close;
    cpg.Params[0].AsInteger := Acesso.Usuario;
    cpg.Params[1].AsString := self.Name + '-' + grid.Name;
    cpg.Open;

    if cpg.IsEmpty then
    begin
      cpg.Append;
      cpgcpgnomegrid.AsString := self.Name + '-' + grid.Name;
      cpgclbcodigo.AsInteger := Acesso.Usuario;
      cpg.Post;
    end;

  except
    { on e: Exception do
      ShowMessage(self.Name + '-' + grid.Name+': '+e.Message); }
  end;

  cpc.Close;
  cpc.Params[0].AsInteger := self.cpgcpgchave.AsInteger;
  cpc.Open;

  if not cpc.IsEmpty then
  begin
    (*
      ** Atualiza o CPC - Controle de Posição das Colunas com possíveis novas colunas **
    *)
    for vColuna := 0 to grid.Columns.Count - 1 do
    begin
      try
        vNomeColuna := grid.Columns[vColuna].FieldName;
        vLarguraColuna := grid.Columns[vColuna].Width;
        vTituloColuna := grid.Columns[vColuna].Title.caption;
        vVisivel := grid.Columns[vColuna].visible;

        if not self.cpc.Locate('cpccampo', vNomeColuna, [loCaseInsensitive]) then
        begin
          self.cpc.Append;
          self.cpccpccampo.AsString := vNomeColuna;
          self.cpccpgchave.AsInteger := self.cpgcpgchave.AsInteger;
          self.cpccpcordem.AsInteger := vColuna;
          if grid.Columns[vColuna].Width > 0 then
            self.cpccpclargura.AsInteger := vLarguraColuna;
          self.cpccpctitulo.AsString := vTituloColuna;
          self.cpccpcvisivel.AsInteger := Ord(vVisivel);
          self.cpc.Post;
        end;
      except
        // ShowMessage(grid.columns[vColuna].FieldName);
      end;
    end;

    (*
      ** DELETA da CPC colunas que foram removidas do GRID **
    *)
    cpc.First;
    if grid.Columns.Count <> cpc.RecordCount then
      while not cpc.Eof do
        if ColumnByFieldName(grid, cpccpccampo.AsString) = nil then // Declarada no uFuncoes.
          cpc.Delete
        else
          cpc.Next;

    (*
      ** Limpa e Remonta GRID **
    *)
    grid.Columns.Clear;
    cpc.First;
    vColuna := 0;
    while not cpc.Eof do
    begin
      grid.Columns.add;
      grid.Columns[vColuna].FieldName := cpccpccampo.AsString;
      grid.Columns[vColuna].Width := cpccpclargura.AsInteger;
      grid.Columns[vColuna].visible := cpccpcvisivel.AsInteger = 1;
      cpc.Next;
      vColuna := vColuna + 1;
    end;
  end
  else
  begin
    (*
      ** Se não existe definição de CPC, elas são criadas. **
    *)
    for vColuna := 0 to grid.Columns.Count - 1 do
    begin
      cpc.Append;
      cpccpccampo.AsString := grid.Columns[vColuna].FieldName;
      cpccpgchave.AsInteger := self.cpgcpgchave.AsInteger;
      cpccpcordem.AsInteger := vColuna;
      if grid.Columns[vColuna].Width > 0 then
        cpccpclargura.AsInteger := grid.Columns[vColuna].Width;
      cpccpctitulo.AsString := grid.Columns[vColuna].Title.caption;
      cpccpcvisivel.AsInteger := Ord(grid.Columns[vColuna].visible);
      cpc.Post;
    end;
  end;
end;

procedure TFraBase.cbTipoDataCloseUp(Sender: TObject);
begin
  AtualizaTipoData;

end;

procedure TFraBase.cbTipoDataExit(Sender: TObject);
begin
  AtualizaTipoData;
end;

procedure TFraBase.cbTipoDataKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    if fmd.State <> dsbrowse then
      fmd.Post;
    self.ActAtualizar.Execute;
    try
      fmddtinicial.SetFocus;
    except

    end;
  end
  else if Key = #27 then
  begin
    if fmd.State <> dsbrowse then
      fmd.Cancel;
    try
      DBGLista.SetFocus;
    except

    end;
  end;
end;

procedure TFraBase.CalculaTotais;
begin
  { }
end;

procedure TFraBase.CarregaColunas;
var
  i: Integer;
  vNomeForm: string;
  vHeight: Integer;
  vWidth: Integer;
  vTop: Integer;
  vLeft: Integer;

  vPlRodaPe: Integer;
  vPlBotoes: Integer;
  vPlSelecao: Integer;
begin

  vHeight := 350;
  vWidth := 550;

  vPlRodaPe := 25;
  vPlBotoes := 140;
  vTop := 110;
  vLeft := 110;

  vNomeForm := self.Name;

  CarregarColunas(DBGLista);

  self.cls.Close;
  self.cls.SQL.Clear;
  self.cls.SQL.text := 'select * from cls where usrcodigo=' + Acesso.Usuario.ToString + ' and clsnomeform=' + Chr(39) + vNomeForm + Chr(39);
  self.cls.Open;

  if not cls.IsEmpty then
  begin
    self.PlRodaPe.Height := self.clsclsrodape.AsInteger;
    self.PlBotoes.Height := self.clsclsbotoes.AsInteger;
    // Self.PlSelecao.Height := Self.clsclsselecao.AsInteger;

    if (Parent is TForm) then
      if (Parent as TForm).BorderStyle = bsNone then
      begin
        (Parent as TForm).Height := Screen.Height - 250;
        (Parent as TForm).Width := Screen.Width - 10;
        (Parent as TForm).Left := 0;
        (Parent as TForm).Top := 0;
      end
      else
      begin
        (Parent as TForm).Height := self.clsclsaltura.AsInteger;
        (Parent as TForm).Width := self.clsclslargura.AsInteger;
        (Parent as TForm).Left := self.clsclsposiesquerda.AsInteger;
        (Parent as TForm).Top := self.clsclspositopo.AsInteger;

        if self.clsclsmodo.AsInteger = 1 then
          (Parent as TForm).WindowState := wsNormal
        else
          (Parent as TForm).WindowState := wsMaximized;
      end;
  end
  else
  begin
    // se não houve seleção de coluna, coloca a 2 coluna como default

    if not uqtabela.SmartFetch.Enabled then
      uqtabela.IndexFieldNames := DBGLista.DataSource.DataSet.Fields[1].FieldName;

    vtitucol := DBGLista.Columns[1].Title.caption;
    vnomecol := DBGLista.DataSource.DataSet.Fields[1].FieldName;
    vtipocol := DBGLista.DataSource.DataSet.Fields[1].DataType;

    if (vtipocol = ftString) then
      vpalavra := self.DSTabela.DataSet.FieldByName(vnomecol).AsString
    else
      vpalavra := '';

    for i := 0 to DBGLista.Columns.Count - 1 do
    begin
      DBGLista.Columns[i].Title.Font.Color := clBlack;
      DBGLista.Columns[i].Title.Font.Style := [];
    end;

    DBGLista.Columns[1].Title.Font.Color := clRed;
    DBGLista.Columns[1].Title.Font.Style := [fsbold];
    GrBTextoProcurar.caption := 'Buscar por ' + DBGLista.Columns[1].Title.caption + ' [+] Muda Ordem ';

    vordem := self.DSTabela.DataSet.Fields[1].FieldName;
    xordem := 1;

    self.PlRodaPe.Height := vPlRodaPe;
    self.PlBotoes.Height := vPlBotoes;
    // Self.PlSelecao.Height := vPlSelecao;

    if (Parent is TForm) then
    begin
      (Parent as TForm).Height := vHeight;
      (Parent as TForm).Width := vWidth;
      (Parent as TForm).Left := vLeft;
      (Parent as TForm).Top := vTop;

      if ((Parent as TForm).BorderStyle = bsNone) then
        (Parent as TForm).WindowState := wsMaximized
      else
        (Parent as TForm).WindowState := wsNormal;
    end;

    vPlRodaPe := self.PlRodaPe.Height;
    vPlBotoes := self.PlBotoes.Height;
    vPlSelecao := self.PlSelecao.Height;

    cls.Connection := self.ZCone;
    self.cls.Close;
    self.cls.SQL.Clear;
    self.cls.SQL.text := 'select * from cls where usrcodigo=' + Acesso.Usuario.ToString + ' and clsnomeform=' + Chr(39) + vNomeForm + Chr(39);
    self.cls.Open;

    cls.Append;
    clsclsordem.AsInteger := 1;
    clsusrcodigo.AsInteger := Acesso.Usuario;
    clsclsnomeform.AsString := vNomeForm;

    if (Parent is TForm) then
      if (Parent as TForm).BorderStyle <> bsNone then
      begin
        self.clsclsaltura.AsInteger := vHeight;
        self.clsclslargura.AsInteger := vWidth;
        self.clsclsposiesquerda.AsInteger := vLeft;
        self.clsclspositopo.AsInteger := vTop;
      end;

    self.clsclsrodape.AsInteger := vPlRodaPe;

    self.clsclsbotoes.AsInteger := vPlBotoes;
    self.clsclsselecao.AsInteger := vPlSelecao;

    self.clsclsmodo.AsInteger := 2;

    if (Parent is TForm) then
      if (Parent as TForm).WindowState = wsNormal then
        self.clsclsmodo.AsInteger := 1;

    cls.Post;
  end;

  try
    DBGListaTitleClick(DBGLista.Columns[clsclsordem.AsInteger]);
  except
    (* Se coluna for excluída sistema utiliza a primeira *)
    DBGListaTitleClick(DBGLista.Columns[0]);
  end;

  for i := 0 to DBGLista.Columns.Count - 1 do
    if DBGLista.Columns[i].Title.Font.Color = clRed then
    begin
      if not uqtabela.SmartFetch.Enabled then
        uqtabela.IndexFieldNames := DBGLista.Columns[i].FieldName;

      GrBTextoProcurar.caption := 'Buscar por ' + DBGLista.Columns[i].Title.caption + ' [+] Muda Ordem ';
      vordem := DBGLista.Columns[i].FieldName;
      DBGLista.SelectedIndex := i;
      xordem := i;
      break;
    end;

  ActAtualizar.Execute;

  MontaMenu(acoes);
  MontaMenuFiltro;

  if (Parent is TForm) then
    if ((Parent as TForm).BorderStyle = bsNone) then
    begin
      (Parent as TForm).Top := 0;
      (Parent as TForm).Left := 0;
    end;

  if (ModoFrame = modoInclusao) and (FormaFrame = ffdocado) then
  begin
    if self.Parent is TPanel then
    begin

      if (self.Parent as TPanel).Parent is TTabSheet then
      begin
        if ((((((self.Parent as TPanel).Parent as TTabSheet).Parent as TPageControl).Parent) as TFrmBase).FindComponent('psituacao') as TPanel).caption = 'Incluindo' then
        begin
          if ((((((self.Parent as TPanel).Parent as TTabSheet).Parent as TPageControl).Parent) as TFrmBase).FindComponent('cfg') <> nil) then
          begin
            if ((((((self.Parent as TPanel).Parent as TTabSheet).Parent as TPageControl).Parent) as TFrmBase).FindComponent('cfg') as TUniQuery).Active then
            begin
              if ((((((self.Parent as TPanel).Parent as TTabSheet).Parent as TPageControl).Parent) as TFrmBase).FindComponent('cfg') as TUniQuery).FindField('cfgeminclusao') <> nil
              then
              begin
                if ((((((self.Parent as TPanel).Parent as TTabSheet).Parent as TPageControl).Parent) as TFrmBase).FindComponent('cfg') as TUniQuery).FindField('cfgeminclusao')
                  .AsInteger = 1 then
                begin
                  self.ActIncluir.Execute;
                end;
              end;
            end;
          end;
        end;
      end;
    end;
  end;

  AjustaLetraGrids(self.clsclsletra.AsInteger, '');
end;

procedure TFraBase.MontaMenu(vAcoes: TActionList);
var
  i, p, q: Integer;
  vnomcat: String;
  pcatbt: TPanel;
  btacao: TBitBtn;
  btamcr: TCheckBox;
  vcatatu: string;
  vlNomeAcao: string;
  vlNome: string;
  vlQtdCategorias: Integer;
  vlCategoria: String;
begin

  { if ModoFrame = modoPesquisa then
    Exit; }

  vlNome := SomenteTexto(self.Name);
  if not act.Active then
  begin
    act.Params[0].AsString := vlNome;
    act.Open;
  end;

  // recebe nome da categoria
  vnomcat := '';
  vlQtdCategorias := 1;
  vlCategoria := (vAcoes[0] as TAction).Category;

  for p := 0 to vAcoes.ActionCount - 1 do
  begin
    if ((vAcoes[p] as TAction).Category <> vlCategoria) then
    begin
      vlQtdCategorias := vlQtdCategorias + 1;
    end;
  end;

  for i := 0 to vAcoes.ActionCount - 1 do
  begin

    (*
      * Ações que não necessitam de botões visíveis
      *
      ***** Passa para próxima Action. *****
    *)
    if AnsiMatchStr(acoes[i].Name, ['ActPesquisar', 'ActSair']) then
      Continue;

    // salva o nome da categoria para ver se trocou para criar um novo painel com o titulo
    vcatatu := vAcoes[i].Category;

    // conta as vacoes para criar os botoes ou checkbox
    q := 0;
    for p := 0 to vAcoes.ActionCount - 1 do
      if ((vAcoes[p] as TAction).Category = vcatatu) then
        q := q + 1;

    // catergoria atual é uma nova catetoria
    if q = 0 then
      vcatatu := '';

{$REGION 'criacao das categorias'}
    // verifica se é uma categoria nova ou se trocou de categodia
    if (vnomcat <> vcatatu) and (vcatatu <> '') or (vcatatu = 'Folha Gerencial') then
    begin

      if (vAcoes[i].GroupIndex > 0) and (self.edbusca.Tag = 1) and (lowercase(Copy(vAcoes[i].Name, 1, 3)) <> 'spb') then
      begin
        if self.PlFiltros.visible = true then
        begin
          if (vlQtdCategorias > 1) or (vcatatu = 'Folha Gerencial') then
          begin

            if PlBotoes.FindComponent('pl' + SoLetras(semacento(vcatatu))) = nil then
            begin
              pcatbt := TPanel.Create(PlBotoes);
              pcatbt.Parent := SBBotoes;
              pcatbt.ParentColor := False;
              pcatbt.ParentBackground := False;
              pcatbt.Color := clnavy; // $00C08000;
              pcatbt.Name := 'pl' + SoLetras(semacento(vcatatu));
              pcatbt.caption := vcatatu;
              // pcatbt.Color := $00C08000;
              pcatbt.Font.Color := CLWHITE;
              pcatbt.Font.Style := [fsbold];
              pcatbt.Align := alBottom;
              pcatbt.Align := alTop;
              pcatbt.Height := 20;
            end;
          end;
        end;
      end
      else
      begin
        if (lowercase(Copy(vAcoes[i].Name, 1, 3)) <> 'bta') and (lowercase(Copy(vAcoes[i].Name, 1, 3)) <> 'spb') then
          if PlBotoes.FindComponent('pl' + SoLetras(semacento(vcatatu))) = nil then
          begin
            if (vlQtdCategorias > 1) or (vcatatu = 'Folha Gerencial') then
            begin
              pcatbt := TPanel.Create(PlBotoes);
              pcatbt.Parent := SBBotoes;
              pcatbt.ParentColor := False;
              pcatbt.ParentBackground := False;
              pcatbt.Color := clnavy; // $004080FF;
              pcatbt.caption := vcatatu;
              pcatbt.Name := 'pl' + SoLetras(semacento(vcatatu));
              pcatbt.Font.Color := CLWHITE;
              pcatbt.Font.Style := [fsbold];
              pcatbt.Align := alBottom;
              pcatbt.Align := alTop;
              pcatbt.Height := 20;
            end;
          end;
      end;
    end;
{$ENDREGION}
    // verifica se a acao esta ativa
    if (vAcoes[i].Enabled) and (Assigned(vAcoes[i].OnExecute)) then
    begin

{$REGION 'Verifica controles dea acesso para as vacoes'}
      (* ['ActPesquisar', 'ActFiltrar', 'ActAtualizar', 'ActSair', 'ActVerFiltros', 'ActConfig', 'ActConfiguracoes'] *)
      try
        if not AnsiMatchStr(vAcoes[i].Name, AcoesSemPermissao) then
          if act.Locate('actacao', vAcoes[i].Name, []) then
            vAcoes[i].Tag := self.actactcodigo.AsInteger;
      except

      end;

{$ENDREGION}
      // é uam acao com agrupamento, podendo ser check o speedbotomn
      if (vAcoes[i].GroupIndex > 0) then
      begin
        btamcr := TCheckBox.Create(PlBotaoFiltroEsp);
        btamcr.Parent := PlBotaoFiltroEsp;
        // SBBotoes
        btamcr.caption := vAcoes[i].caption;
        btamcr.Tag := vAcoes[i].Tag;
        btamcr.Name := 'b' + vAcoes[i].Name;
        btamcr.Action := vAcoes[i];
        btamcr.Align := alBottom;
        btamcr.Align := alTop;
        btamcr.Height := 22;
      end
      else
      begin

        vlNomeAcao := 'b' + vAcoes[i].Name;
        if PlBotoes.FindComponent(vlNomeAcao) = nil then
        begin
          btacao := TBitBtn.Create(PlBotoes);
          btacao.Action := vAcoes[i];
          btacao.Tag := vAcoes[i].Tag;
          btacao.Name := 'b' + vAcoes[i].Name;
          btacao.Height := 21;
          btacao.Margin := 5;
          btacao.Font.size := 9;
          btacao.Font.Name := 'Arial';
        end;

        if (lowercase(vAcoes[i].Name) = 'actfiltrar') or (lowercase(vAcoes[i].Name) = 'actverfiltros') then
        begin
          btacao.Parent := PlBotaoFiltro;
          btacao.Align := alBottom;
          btacao.Align := alTop;
          btacao.TabStop := False;
          btacao.Height := 21;
          btacao.Font.size := 8;
        end
        else if (lowercase(vAcoes[i].Name) = 'actconfiguracoes') then
        begin
          btacao.Parent := SBBotoes;
          btacao.ParentFont := False;
          btacao.caption := 'Ajustar Colunas';
          btacao.Hint := 'Colunas|Define as colunas vísíveis da lista.';
          btacao.Margin := 5;
          btacao.Align := alBottom;
          btacao.Align := alTop;
          btacao.Height := 21;
        end
        else if (lowercase(vAcoes[i].Name) = 'actconfig') then
        begin
          if (vAcoes[i].Enabled) then
          begin
            btacao.ParentFont := False;
            btacao.Parent := SBBotoes;
            btacao.caption := 'Dados Adicionais';
            btacao.Hint := vAcoes[i].caption;
            btacao.Margin := 5;
            btacao.Align := alBottom;
            btacao.Align := alTop;
            btacao.Height := 21;
            btacao.visible := true;
          end;
        end
        else
        begin
          btacao.Parent := SBBotoes;
          btacao.Align := alBottom;
          btacao.Align := alTop;
        end;

        PlSair.Width := 120;
      end;
    end;

    try
      vnomcat := vAcoes[i].Category;
    except
      break;
    end;
  end;
end;

procedure TFraBase.MontaMenuFiltro;
var
  i, p, q: Integer;
  pcatbt: TPanel;
  spbmcr: TSpeedButton;
  vcatatu: string;
begin

  for i := 0 to self.acoes.ActionCount - 1 do
  begin
    // salva o nome da categoria para ver se trocou para criar um novo painel com o titulo
    vcatatu := (self.acoes[i] as TAction).Category;

    // conta as acoes para criar os botoes ou checkbox
    q := 0;
    for p := 0 to self.acoes.ActionCount - 1 do
    begin
      if ((self.acoes[p] as TAction).Name <> 'ActPesquisar') And ((self.acoes[p] as TAction).Name <> 'ActFiltrar') And ((self.acoes[p] as TAction).Name <> 'ActAtualizar') And
        ((self.acoes[p] as TAction).Name <> 'ActSair') And ((self.acoes[p] as TAction).Name <> 'ActVerFiltros') And ((self.acoes[p] as TAction).Name <> 'ActConfig') And
        ((self.acoes[p] as TAction).Name <> 'ActConfiguracoes') and ((self.acoes[p] as TAction).Category = vcatatu) then
      begin
        q := q + 1;
      end;
    end;

    // catergoria atual é uma nova catetoria
    if q = 0 then
    begin
      vcatatu := '';
    end;

    if (lowercase(Copy(self.acoes[i].Name, 1, 3)) = 'spb') and (self.acoes[i].visible) then
    begin
      if PlBotoes.FindComponent('pl' + SoLetras(semacento(vcatatu))) = nil then
      begin

        pcatbt := TPanel.Create(PlBotoes);
        pcatbt.Parent := SBBotoes;
        pcatbt.ParentColor := False;
        pcatbt.ParentBackground := False;
        pcatbt.Color := clnavy; // $004080FF;
        pcatbt.caption := vcatatu;
        pcatbt.Name := 'pl' + SoLetras(semacento(vcatatu));
        pcatbt.Font.Color := CLWHITE;
        pcatbt.Font.Style := [fsbold];
        pcatbt.Align := alBottom;
        pcatbt.Align := alTop;
        pcatbt.Height := 20;

        pcatbt := TPanel.Create(PlBotoes);
        pcatbt.Parent := SBBotoes;
        pcatbt.ParentColor := False;
        pcatbt.ParentBackground := true;
        pcatbt.Name := 'plspb' + SoLetras(semacento(vcatatu));
        pcatbt.caption := '';
        pcatbt.Font.Color := clBlack;
        pcatbt.Align := alBottom;
        pcatbt.Align := alTop;
        pcatbt.Height := 2;
        pcatbt.BevelOuter := bvnone;

      end;

      if lowercase(Copy((self.acoes[i] as TAction).Name, 1, 3)) = 'spb' then
      begin
        spbmcr := TSpeedButton.Create(PlBotoes);
        spbmcr.Parent := pcatbt;
        // SBBotoes; // SBBotoes
        spbmcr.caption := (self.acoes[i] as TAction).caption;
        spbmcr.Tag := (self.acoes[i] as TAction).Tag;
        spbmcr.Name := 'b' + self.acoes[i].Name;
        spbmcr.Action := self.acoes[i];
        spbmcr.Down := self.acoes[i].Checked;
        spbmcr.Align := alBottom;
        spbmcr.Align := alTop;
        spbmcr.Height := 25;
        spbmcr.GroupIndex := (self.acoes[i] as TAction).GroupIndex;
        spbmcr.Margin := 5;
        spbmcr.Hint := spbmcr.Name;
        spbmcr.Font.size := 10;
        spbmcr.Font.Name := 'Arial';

        pcatbt.Height := pcatbt.Height + spbmcr.Height;
      end;
    end;
  end;
end;

procedure TFraBase.CriaAcoesDeAcesso;
var
  i, c: Integer;
  cat: string;
  vmdl: TUniQuery;
  vcrm: TUniQuery;
  vBPL: TUniQuery;
  vact: TUniQuery;
  vlChaveBPL: Integer;
  vlChaveMDL: string;
  CaptAcao: string;
  IdentAcao: string;
  NomeAcao: string;
  FormAcao: string;

begin
  try
    (*
      *
      * Criação dos Campos para Relatórios
      *
    *)
    vBPL := TUniQuery.Create(Application);
    vBPL.Connection := ZCone;
    vBPL.SQL.text := 'SELECT bplcodigo, bplfranome FROM bpl';
    vBPL.Open;

    vcrm := TUniQuery.Create(Application);
    vcrm.Connection := ZCone;
    vcrm.SQL.text := 'SELECT crmchave, bplcodigo, crmnome, crmidentificacao, tcacodigo FROM crm where bplcodigo = :bplcodigo';

    try

      if vBPL.Locate('bplfranome', self.Name, [loCaseInsensitive]) then
        vlChaveBPL := vBPL.FieldByName('bplcodigo').AsInteger
      else
        vlChaveBPL := 0;

      vcrm.Close;
      vcrm.Params[0].AsInteger := vlChaveBPL;
      vcrm.Open;

      if vlChaveBPL > 0 then
        for c := 0 to DSTabela.DataSet.Fields.Count - 1 do
        begin

          if not vcrm.Locate('crmnome', DSTabela.DataSet.Fields[c].FieldName, [loCaseInsensitive]) then
            vcrm.Append
          else
            vcrm.Edit;

          vcrm.FieldByName('bplcodigo').AsInteger := vlChaveBPL;
          vcrm.FieldByName('crmnome').AsString := DSTabela.DataSet.Fields[c].FieldName;
          vcrm.FieldByName('crmidentificacao').AsString := DSTabela.DataSet.Fields[c].DisplayLabel;
          case DSTabela.DataSet.Fields[c].DataType of
            ftString:
              vcrm.FieldByName('tcacodigo').AsInteger := tcaTexto;
            ftInteger:
              vcrm.FieldByName('tcacodigo').AsInteger := tcaInteiro;
            ftDate:
              vcrm.FieldByName('tcacodigo').AsInteger := tcaData;
            ftTime:
              vcrm.FieldByName('tcacodigo').AsInteger := tcaHora;
            ftDateTime:
              vcrm.FieldByName('tcacodigo').AsInteger := tcaAgora;
            ftFloat, ftCurrency:
              vcrm.FieldByName('tcacodigo').AsInteger := tcaFlutuante;
          else
            begin
              vcrm.FieldByName('tcacodigo').AsInteger := tcaTexto;
            end;
          end;

          vcrm.Post;
        end;
    except
      on e: Exception do
        ShowMessage(e.Message);
    end;

    (*
      *
      * Atualização dos Módulos e Ações do Sistema
      *
    *)
    vmdl := TUniQuery.Create(Application);
    vmdl.Connection := ZCone;
    vmdl.SQL.text := 'SELECT mdlcodigo, mdlidentificacao, mdldescricao, mdlnome, mdlconfig, mdlsubgrupo FROM mdl ';
    vmdl.SQL.add('WHERE mdlnome=:mdlnome  AND (mdlsubgrupo=:mdlsubgrupo OR mdlsubgrupo='''')');

    vact := TUniQuery.Create(Application);
    vact.Connection := ZCone;
    vact.SQL.text := 'SELECT actcodigo, mdlcodigo, actidentificacao, actformulario, actacao, actativa FROM act ';
    vact.SQL.add('WHERE actformulario = :actformulario AND actacao = :actacao');

    for i := 0 to self.acoes.ActionCount - 1 do
    begin
      cat := self.acoes[i].Category;

      vmdl.Close;
      vmdl.Params[0].AsString := self.Name;
      vmdl.Params[1].AsString := self.acoes[i].Category;
      vmdl.Open;

      vlChaveMDL := vmdl.Fields[0].AsString;

      if vmdl.IsEmpty then
      begin
        vmdl.Append;
        vmdl.FieldByName('mdlidentificacao').AsString := self.Titulo;
        vmdl.FieldByName('mdlsubgrupo').AsString := self.acoes[i].Category;
        vmdl.FieldByName('mdlnome').AsString := self.Name;
        vmdl.FieldByName('mdlconfig').AsInteger := self.Tag;
        vmdl.Post;

        vlChaveMDL := vmdl.Fields[0].AsString;
      end;

      if (self.acoes[i] as TAction).Enabled then
        if ((self.acoes[i] as TAction).Name <> 'ActPesquisar') And ((self.acoes[i] as TAction).Name <> 'ActFiltrar') And ((self.acoes[i] as TAction).Name <> 'ActAtualizar') And
          ((self.acoes[i] as TAction).Name <> 'ActSair') then
        begin

          vact.Close;
          vact.ParamByName('actformulario').AsString := self.Name;
          vact.ParamByName('actacao').AsString := (self.acoes[i] as TAction).Name;
          vact.Open;

          if vact.IsEmpty then
            vact.Append
          else
            vact.Edit;

          CaptAcao := (acoes[i] as TAction).caption;
          if pos(':', CaptAcao) > 0 then
            IdentAcao := Trim(Copy(CaptAcao, 1, pos(':', CaptAcao) - 1))
          else
            IdentAcao := CaptAcao;

          IdentAcao := '000 ' + IdentAcao;
          FormAcao := Name;
          NomeAcao := (acoes[i] as TAction).Name;

          vact.FieldByName('mdlcodigo').AsString := vlChaveMDL;
          vact.FieldByName('actidentificacao').AsString := IdentAcao;
          vact.FieldByName('actformulario').AsString := FormAcao;
          vact.FieldByName('actacao').AsString := NomeAcao;
          vact.FieldByName('actativa').AsInteger := 1;

          vact.Post;
        end;
    end;
  finally
    vmdl.Close;
    vact.Close;
    FreeAndNil(vmdl);
    FreeAndNil(vact);
  end;
end;

function TFraBase.CriaFormulario(pFormClass: TFrmBaseClass; pChave, pChaveMestre: String; pFiltro: String = ''): Boolean;
var
  vlRecNo: Integer;
  vlCargaFrame: TCargaFrame;
  FormBase: TFrmBase;
begin
  FRegistroFrmBase := '';

  Result := False;

  if not PlBotoes.visible then
    exit;

  if uqtabela.Active then
    vlRecNo := uqtabela.RecNo;

  vlCargaFrame := CargaFormu(Application, ZCone, Acesso, pFiltro, pChave, pChaveMestre);

  FormBase := pFormClass.Create(vlCargaFrame);

  try
    if FormBase.ShowModal = mrOk then
    begin
      FRegistroFrmBase := FormBase.vChave;;
      Result := true;
    end;

  finally
    FormBase.Free;

    self.ActAtualizar.Execute;

    if FRegistroFrmBase <> '' then
      if self.uqtabela.Active then
        if not self.uqtabela.Locate(uqtabela.Fields[0].FieldName, FRegistroFrmBase, []) then
          self.uqtabela.RecNo := vlRecNo;

    (* Identifica se está em modo de Pesquisa e define o foco para a lista *)
    if (edbusca.Tag = 1) then
      if DBGLista.visible then
      begin
        try
          self.DBGLista.SetFocus;
        except

        end;
      end;
  end;
end;

procedure TFraBase.Image2Click(Sender: TObject);
begin
  plSugestao.visible := true;
  try
    edbusca.SetFocus;
  except

  end;

end;

function TFraBase.ImprimeRelatorio(modulo: string; varquivo: string): string;
var
  relat: TImprimeRelat;
  ch: string;
begin
  pack := LoadPackage('modulos\' + modulo + '.bpl');
  if pack <> 0 then
    try
      @relat := GetProcAddress(pack, Pchar('mrfrImpressao'));
      if Assigned(relat) then
      begin
        ch := relat(Application, self.ZCone, self.DSTabela, varquivo, '', Acesso.Usuario.ToString);
        Result := ch;
      end;
    finally
      // DoUnLoadPackage(application,pack);
    end;
end;


procedure TFraBase.MadExceptionHandler1ExceptAction(action: TExceptAction;
  const exceptIntf: IMEException; var handled: Boolean);
var
  vletdApelido: string;

begin

  try
    vletdApelido := '';
    consulta.Close;
    consulta.Connection := ZCone;
    consulta.SQL.text := 'SELECT etdapelido FROM cfgmcfg, etd where cfgmcfg.cfgetdempresa=etd.etdcodigo limit 1';
    consulta.Open;
    vletdApelido := consulta.FieldByName('etdapelido').AsString;
    exceptIntf.BugReportHeader.Items[0]:= exceptIntf.BugReportHeader.Items[0] + ' ' + vletdApelido;

  except
  end;


end;

procedure TFraBase.MadExceptionHandler1Exception(const exceptIntf: IMEException;
  var handled: Boolean);
var
  vletdApelido: string;

begin

  try
    vletdApelido := '';
    consulta.Close;
    consulta.Connection := ZCone;
    consulta.SQL.text := 'SELECT etdapelido FROM cfgmcfg, etd where cfgmcfg.cfgetdempresa=etd.etdcodigo limit 1';
    consulta.Open;
    vletdApelido := consulta.FieldByName('etdapelido').AsString;
    exceptIntf.BugReportHeader.Items[0]:= exceptIntf.BugReportHeader.Items[0] + ' ' + vletdApelido;

  except
  end;


end;

procedure TFraBase.mnAcessosClick(Sender: TObject);
begin
  CriaAcoesDeAcesso;
end;

procedure TFraBase.VerAtualizacao(pacote: string);
type
  TVerificaAtualizacao = function(onwer: TApplication; varquivo: String; vPasta: String; vExtensao: string; vVersao: String = ''): String;

var
  pack: Cardinal;
  vlVerificaAtualizacao: TVerificaAtualizacao;
begin
  { if not fileexists(extractfilepath(Application.ExeName) + 'modulos\matz.bpl') then
    begin
    exit;
    end;

    pack := LoadPackage('modulos\matz.bpl');
    if pack <> 0 then
    begin
    try
    @vlVerificaAtualizacao := GetProcAddress(pack, Pchar('VerificaAtualizacao'));
    if Assigned(vlVerificaAtualizacao) then
    begin

    if (pacote = 'mcre') or (pacote = 'mcpa') then
    vlVerificaAtualizacao(Application, 'mrfi.bpl', 'modulos', '.bpl');

    if (pacote = 'mbrp') or (pacote = 'mmbrr') then
    vlVerificaAtualizacao(Application, 'mbrf.bpl', 'modulos', '.bpl');

    vlVerificaAtualizacao(Application, pacote + '.bpl', 'modulos', '.bpl');

    end;
    finally
    DoUnLoadPackage(Application, pack);
    end;
    end; }

end;

function TFraBase.MostraLista(pModulo: String; pFiltro: string = ''; pChaveMestre: string = ''): string;
var
  ExecForm: function(CargaFrame: TCargaFrame): String;
  vlCargaFrame: TCargaFrame;
begin

  { if InternetAtiva then
    begin
    VerAtualizacao(pModulo);
    end; }

  Result := '';
  pack := LoadPackage('modulos\' + pModulo + '.bpl');
  if pack <> 0 then
    try
      @ExecForm := GetProcAddress(pack, Pchar('formu'));
      if Assigned(ExecForm) then
      begin
        vlCargaFrame := CargaFrameFormu(Application, pack, ZCone, Acesso, pFiltro, pChaveMestre);
        Result := ExecForm(vlCargaFrame);
      end;
    finally
      DoUnLoadPackage(Application, pack);
    end;
end;

function TFraBase.MostraFormu(pModulo: string; pChave: string; pChaveMestre: string; pFormulario: string = 'formulario'; pFiltro: String = ''): String;
var
  ExecForm: function(CargaFrame: TCargaFrame): String;
  vlCargaFrame: TCargaFrame;
begin
  Result := '';
  try
    pack := LoadPackage('modulos\' + pModulo + '.bpl');
    if pack <> 0 then
      try
        @ExecForm := GetProcAddress(pack, Pchar(pFormulario));

        if Assigned(ExecForm) then
        begin
          vlCargaFrame := CargaFormu(Application, ZCone, Acesso, pFiltro, pChave, pChaveMestre);
          Result := ExecForm(vlCargaFrame);
        end;
      finally
        // DoUnLoadPackage(Application, pack);
      end;
  except
  end;
end;

function TFraBase.Autorizado(Sender: TObject; motivo: string = ''): Boolean;
var
  Autoriza: TAutorizacao;
  vlRetorno: string;
  vlActCodigo: Integer;
  vlPackLia: Cardinal;
  vlActFormulario: string;
  vlActAcao: string;
begin
  Result := true;

  vlActCodigo := (Sender as TAction).Tag;
  vlActFormulario := self.Name;
  vlActAcao := (Sender as TAction).Name;

  if vlActCodigo > 0 then
    if not dau.Locate('actcodigo;dauativo', VarArrayOf([vlActCodigo, 1]), []) then
    begin
      Result := False;

      vlPackLia := LoadPackage('modulos\mlia.bpl');
      if vlPackLia <> 0 then
        try
          @Autoriza := GetProcAddress(vlPackLia, Pchar('liberacao'));

          if Assigned(Autoriza) then
          begin
            vlRetorno := Autoriza(Application, self.ZCone, Acesso.Usuario.ToString, IntToStr(vlActCodigo), motivo);

            if (vlRetorno <> '0') and (vlRetorno <> '') then // retornou NÃO AUTORIZADO
              Result := true
            else
            begin
              vlRetorno := Autoriza(Application, self.ZCone, Acesso.Usuario.ToString, self.Name, motivo);

              if (vlRetorno <> '0') and (vlRetorno <> '') then // retornou NÃO AUTORIZADO
                Result := true;

            end;

          end;
        finally
          DoUnLoadPackage(Application, vlPackLia);
        end;
    end;
end;

procedure TFraBase.BAumentaLetraClick(Sender: TObject);
begin
  AjustaLetraGrids(1, 'A');
end;

procedure TFraBase.BDiminuiLetraClick(Sender: TObject);
begin
  AjustaLetraGrids(1, 'D');
end;

procedure TFraBase.AjustaLetraGrids(vQuantiMudar: Integer; vTipoMudar: string);
var
  i, c: Integer;
  vlTamanhoAtual: Integer;
begin
  cls.Refresh;
  vlTamanhoAtual := clsclsletra.AsInteger;

  if vTipoMudar = 'D' then
    vlTamanhoAtual := vlTamanhoAtual - vQuantiMudar;

  if vTipoMudar = 'A' then
    vlTamanhoAtual := vlTamanhoAtual + vQuantiMudar;

  cls.Edit;
  clsclsletra.AsInteger := vlTamanhoAtual;
  cls.Post;

  for i := 0 to self.ComponentCount - 1 do
    if (self.Components[i] is TDBGrid) then
    begin
      (self.Components[i] as TDBGrid).TitleFont.size := vlTamanhoAtual;
      (self.Components[i] as TDBGrid).Font.size := vlTamanhoAtual;

      for c := 0 to (self.Components[i] as TDBGrid).Columns.Count - 1 do
        (self.Components[i] as TDBGrid).Columns[c].Title.Font.size := vlTamanhoAtual;
    end;
end;

procedure TFraBase.BFiltroAlterarClick(Sender: TObject);
begin
  ChamaFiltro(self.ifiifichave.AsString);
end;

procedure TFraBase.BFiltroExcluirClick(Sender: TObject);
var
  sqlorigi: string;
  vwhere: string;
  i: Integer;
begin

  if ifi.Active then
  begin
    if not ifi.IsEmpty then
    begin
      sqlorigi := self.filfilsqloriginal.AsString;
      sqlorigi := StringReplace(sqlorigi, self.ifiififiltro.AsString, '', [rfReplaceAll, rfIgnoreCase]);
      sqlorigi := StringReplace(sqlorigi, #$A, '', [rfReplaceAll]);
      sqlorigi := StringReplace(sqlorigi, #$D, '', [rfReplaceAll]);

      sqlorigi := StringReplace(sqlorigi, '    ', ' ', [rfReplaceAll]);
      sqlorigi := StringReplace(sqlorigi, '   ', ' ', [rfReplaceAll]);
      sqlorigi := StringReplace(sqlorigi, '  ', ' ', [rfReplaceAll]);
      sqlorigi := Trim(sqlorigi);

      for i := 0 to 20 do
      begin
        vwhere := Trim(Copy(sqlorigi, Length(sqlorigi) - 3, 20));

        if (vwhere = 'and') then
        begin
          sqlorigi := Copy(sqlorigi, 1, Length(sqlorigi) - (Length(vwhere)));
          sqlorigi := Trim(sqlorigi);
        end;
      end;

      for i := 0 to 20 do
      begin
        vwhere := Trim(Copy(sqlorigi, Length(sqlorigi) - 5, 20));

        if (vwhere = 'where') then
          sqlorigi := Copy(sqlorigi, 1, Length(sqlorigi) - 5)
      end;

      sqlorigi := Trim(sqlorigi);

      self.fil.Edit;
      // Self.filfilsqloriginal.AsString := sqlorigi;
      self.fil.Post;

      self.ifi.Delete;
    end;
  end;

  if ifi.RecordCount = 0 then
    PlSelecao.visible := False;

  self.ActAtualizar.Execute;
end;

procedure TFraBase.BFiltroOcultarClick(Sender: TObject);
begin
  PlSelecao.visible := False;
  AjustaBotaoFiltro;
end;

procedure TFraBase.btLimpaBuscaClick(Sender: TObject);
begin
  edbusca.Hint := '';
  self.edbusca.text := '';
  Application.ProcessMessages;
  plSugestao.visible := False;
  uqtabela.FilterSQL := '';
  ActAtualizar.Execute;
  try
    edbusca.SetFocus;
  except

  end;

end;

procedure TFraBase.bConfirmaSelecaoClick(Sender: TObject);
begin
  AtualizaFiltroUQTabela;
end;

procedure TFraBase.bCancelaSelecaoClick(Sender: TObject);
begin
  edbusca.text := '';
  vpfiltroSugestao := '';
  FechaFiltro.Enabled := true;

end;

procedure TFraBase.MontaMenuInstricoes;
var
  ItemIts: TMenuItem;
begin
  its.Close;
  its.Params[0].AsString := Copy(self.Name, 1, 6);
  its.Open;

  its.First;
  MenuInstrucoes.Items.Clear;

  while not its.Eof do
  begin
    ItemIts := TMenuItem.Create(MenuInstrucoes);
    ItemIts.caption := UpperNome(itsitsidentificacao.AsString);
    ItemIts.Hint := itsitscodigo.AsString;
    ItemIts.OnClick := ChamaInstrucao;
    MenuInstrucoes.Items.add(ItemIts);
    its.Next;
  end;
end;

procedure TFraBase.MontaMenuRelatorios;
var
  ItemRel: TMenuItem;
begin
  rel.Close;
  rel.Params[0].AsString := Copy(self.Name, 1, 6);
  rel.Params[1].AsInteger := Acesso.Usuario;
  rel.Open;

  rel.First;
  MenuRelatorios.Items.Clear;

  while not rel.Eof do
  begin
    ItemRel := TMenuItem.Create(MenuRelatorios);
    ItemRel.caption := UpperNome(relrelidentificacao.AsString);
    ItemRel.Hint := relrelcodigo.AsString;
    ItemRel.OnClick := ChamaRelatorio;
    MenuRelatorios.Items.add(ItemRel);

    rel.Next;
  end;
end;

procedure TFraBase.ChamaInstricao(Sender: TObject);
begin

end;

procedure TFraBase.ChamaInstrucao(Sender: TObject);
var
  vlIstCodigo: String;
  vlNomeArq: string;
  BlobField: TBlobField;
begin
  if Sender is TMenuItem then
  begin
    vlIstCodigo := (Sender as TMenuItem).Hint;

    its.Close;
    its.Params[0].AsString := Copy(self.Name, 1, 6);
    its.Open;

    if its.Locate('itscodigo', vlIstCodigo, []) then
    begin
      vlNomeArq := extractfilepath(Application.ExeName) + 'instrucoes\' + itsitsidentificacao.AsString + '.pdf';

      if not fileexists(vlNomeArq) then
      begin
        BlobField := its.FieldByName('itspdf') as TBlobField;
        BlobField.SaveToFile(vlNomeArq);
      end;

      if fileexists(vlNomeArq) then
      begin
        MOstraInstrucao(vlNomeArq);
      end;
    end;
  end;
end;

procedure TFraBase.MOstraInstrucao(vNomeArq: string);
begin
  Application.CreateForm(tfmostraist, fmostraist);
  fmostraist.CarregaPDF(vNomeArq);
  fmostraist.Show;
end;

procedure TFraBase.ChamaRelatorio(Sender: TObject);
var
  vlRelCodigo: String;
  vlNomeArq: string;
  BlobField: TBlobField;
begin
  if Sender is TMenuItem then
  begin
    vlRelCodigo := (Sender as TMenuItem).Hint;
    rel.Close;
    rel.Params[0].AsString := Copy(self.Name, 1, 6);
    rel.Open;

    if rel.Locate('relcodigo', vlRelCodigo, []) then
    begin
      vlNomeArq := extractfilepath(Application.ExeName) + 'relat\rel' + vlRelCodigo + '.fr3';

      BlobField := rel.FieldByName('relarquivo') as TBlobField;
      BlobField.SaveToFile(vlNomeArq);
      if fileexists(vlNomeArq) then
        ImprimeRelatorio('mrfr', vlNomeArq);
    end;
  end;
end;

constructor TFraBase.Create(pCargaFrame: TCargaFrame);
var
  vlObjeto: TObject;
begin
  inherited Create(pCargaFrame.AOwner);
  self.visible := False;

  ZCone := pCargaFrame.Conexao;
  HandleHerdado := pCargaFrame.Handle;
  Acesso := pCargaFrame.Acesso;

  IdModulo := pCargaFrame.IdModulo;
  Titulo := pCargaFrame.Titulo;

  ModoFrame := pCargaFrame.ModoCarga;
  FormaFrame := pCargaFrame.FormaFrame;

  vChave := pCargaFrame.Chave;
  vChaveMestre := pCargaFrame.ChaveMestre;
  TxtFiltro := pCargaFrame.filtro;
  Aplicacao := pCargaFrame.Titulo;
  try
    if pCargaFrame.Parent <> nil then
    begin
      vlObjeto := pCargaFrame.Parent;
      Parent := pCargaFrame.Parent;
    end;
  except
    Parent := nil;
  end;

  Carregar;
end;

procedure TFraBase.SetFormaFrame(const Value: TFormaFrame);
begin
  FFormaFrame := Value;

  case FFormaFrame of
    ffdocado:
      begin
        ActSair.visible := False;
        PlFiltros.visible := False;
      end;
    ffFormu:
      case ModoFrame of
        modoPesquisa:
          begin
            edbusca.Tag := 1;
            PlBotoes.visible := False;
            ActSair.visible := False;
          end;
        modoPesqEdicao:
          begin
            edbusca.Tag := 1;
            ActSair.visible := False;
          end;
      end;
  end;
end;

procedure TFraBase.SetHandleHerdado(const Value: NativeUInt);
var
  vlDirBPL: string;
  vlNomeBPL: string;
begin
  FHandleHerdado := Value;

  if self.ClassName <> 'Tframnf' then
  begin
    vlDirBPL := GetModuleName(FHandleHerdado);
    vlNomeBPL := extractfilename(vlDirBPL);
    vlNomeBPL := vlNomeBPL + ' ' + GetAppVersionStr(vlDirBPL);
    self.PlInfo.caption := 'ID:' + vlNomeBPL;
    self.spChamaAjuda.Hint := vlNomeBPL;
  end;
end;

procedure TFraBase.SetIdModulo(const Value: string);
var
  vlDirBPL: string;
  vlNomeBPL: string;
begin
  FIdModulo := Value;
  vlDirBPL := GetModuleName(FHandleHerdado);
  vlNomeBPL := extractfilename(vlDirBPL);

  self.plid.caption := 'ID: ' + self.Name + ' R: ' + Copy(GetAppVersionStr(vlDirBPL), 7, 50);
end;

procedure TFraBase.SetModoExibicaoFrame(const Value: Integer = frmModoLista);
begin
  FModoFrameDocado := Value;
end;

procedure TFraBase.SetTitulo(const Value: string);
begin
  FTitulo := Value;
  self.PlTitulo.caption := self.Titulo;
end;

procedure TFraBase.SetZCone(const Value: TUniConnection);
var
  i: Integer;
begin
  FZCone := Value;

  for i := 0 to self.ComponentCount - 1 do
  begin
    if self.Components[i] is TUniQuery then
      (self.Components[i] as TUniQuery).Connection := self.ZCone;
  end;
end;

procedure TFraBase.RegistraAlteracaoParaCargas;
begin

  cfgalterado.Close;
  cfgalterado.ParamByName('cfgcodigo').AsInteger := Acesso.Filial;
  cfgalterado.Open;

  cfgalterado.Edit;
  cfgalteradocfgalteracao.AsString := agora(Application, ZCone);
  cfgalterado.Post;
end;

procedure TFraBase.SalvarSTG(vtabela: string; vcampochave: string);

begin

  consultashema.Close;
  consultashema.ParamByName('tabela').AsString := vtabela;
  consultashema.Open;

  if not consultashema.IsEmpty then
  begin

    if psituacao.caption = 'Incluindo' then
    begin
      stg.Close;
      stg.FilterSQL := '';
      stg.Filtered := False;
      stg.Open;

      stg.Append;
      stgstgdatacriacao.AsString := agora(Application, ZCone);
      // stgstgdataalteracao.AsString := agora(Application, ZCone);
      stgclbcodigo.AsInteger := Acesso.Usuario;
      stgstgexcluido.AsInteger := 0;
      stg.Post;

    end
    else
    begin
      stgid.Close;
      stgid.SQL.text := 'select ' + vcampochave + ',stgcodigo from ' + vtabela + ' where ' + vcampochave + '=' + uqtabela.Fields[0].AsString;
      stgid.Open;

      if stgid.IsEmpty then
      begin

        stg.Close;
        stg.FilterSQL := '';
        stg.Filtered := False;
        stg.Open;

        stg.Append;
        stgstgdatacriacao.AsString := agora(Application, ZCone);
        stgstgdataalteracao.AsString := agora(Application, ZCone);
        stgclbcodigo.AsInteger := Acesso.Usuario;
        stgstgexcluido.AsInteger := 0;
        stg.Post;

        stgid.Edit;
        stgid.FieldByName('stgcodigo').AsInteger := stgstgcodigo.AsInteger;
        stgid.Post;

      end
      else if psituacao.caption = 'Incluindo' then
      begin

        if stgid.FieldByName('stgcodigo').AsString <> '' then
        begin
          stg.Close;
          stg.FilterSQL := 'stgcodigo=' + stgid.FieldByName('stgcodigo').AsString;
          stg.Filtered := true;
          stg.Open;

          stg.Edit;
          if stgstgdatacriacao.AsString = '' then
          begin
            stgstgdatacriacao.AsString := agora(Application, ZCone);
          end;

          stgstgdataalteracao.AsString := agora(Application, ZCone);
          stgclbcodigo.AsInteger := Acesso.Usuario;
          stgstgexcluido.AsInteger := 0;
          stg.Post;

          stgid.Edit;
          stgid.FieldByName('stgcodigo').AsInteger := stgstgcodigo.AsInteger;
          stgid.Post;

        end
        else
        begin
          stgid.Close;
          stgid.SQL.text := 'select ' + vcampochave + ',stgcodigo from ' + vtabela + ' where ' + vcampochave + '=' + uqtabela.Fields[0].AsString;
          stgid.Open;

          stg.Close;
          stg.FilterSQL := '';
          stg.Filtered := False;
          stg.Open;

          stg.Append;
          // stgstgdatacriacao.AsString := agora(Application, ZCone);
          stgstgdataalteracao.AsString := agora(Application, ZCone);
          stgclbcodigo.AsInteger := Acesso.Usuario;
          stgstgexcluido.AsInteger := 0;
          stg.Post;

          stgid.Edit;
          stgid.FieldByName('stgcodigo').AsInteger := stgstgcodigo.AsInteger;
          stgid.Post;

        end;

      end
      else
      begin
        stgid.Close;
        stgid.SQL.text := 'select ' + vcampochave + ',stgcodigo from ' + vtabela + ' where ' + vcampochave + '=' + uqtabela.Fields[0].AsString;
        stgid.Open;

        if stgid.FieldByName('stgcodigo').AsString <> '' then
        begin
          stg.Close;
          stg.FilterSQL := 'stgcodigo=' + stgid.FieldByName('stgcodigo').AsString;
          stg.Filtered := true;
          stg.Open;

          stg.Edit;
          if stgstgdatacriacao.AsString = '' then
          begin
            stgstgdatacriacao.AsString := agora(Application, ZCone);
          end;

          stgstgdataalteracao.AsString := agora(Application, ZCone);
          stgclbcodigo.AsInteger := Acesso.Usuario;
          stgstgexcluido.AsInteger := 1;
          stg.Post;

          stgid.Edit;
          stgid.FieldByName('stgcodigo').AsInteger := stgstgcodigo.AsInteger;
          stgid.Post;

        end
        else
        begin
          stgid.Close;
          stgid.SQL.text := 'select ' + vcampochave + ',stgcodigo from ' + vtabela + ' where ' + vcampochave + '=' + uqtabela.Fields[0].AsString;
          stgid.Open;

          stg.Close;
          stg.FilterSQL := '';
          stg.Filtered := False;
          stg.Open;

          stg.Append;
          // stgstgdatacriacao.AsString := agora(Application, ZCone);
          stgstgdataalteracao.AsString := agora(Application, ZCone);
          stgclbcodigo.AsInteger := Acesso.Usuario;
          stgstgexcluido.AsInteger := 1;

          stg.Post;
          stgid.Edit;
          stgid.FieldByName('stgcodigo').AsInteger := stgstgcodigo.AsInteger;
          stgid.Post;

        end;

      end;

    end;

  end;

end;

end.
