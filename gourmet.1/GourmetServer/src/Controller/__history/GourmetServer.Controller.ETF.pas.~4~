unit GourmetServer.Controller.ETF;

interface

Uses
  System.Json,
  System.SysUtils,
  GourmetServer.Service.Funcoes,
  GourmetServer.Model.DAOGeneric,
  GourmetServer.Model.Entity.ETF;

Function ManutencaoETFCELULAR(var vletdcodigo: Integer; vCliente: TJsonObject): Integer;
Function ManutencaoETFFIXO(var vletdcodigo: Integer; vCliente: TJsonObject): Integer;

function BuscaCodigoTelefone(vEtdCodigo: Integer; vTelefone: string): Integer;

type
  TAPIError = class
  private
    Ferror: string;
  public
    property error: string read Ferror write Ferror;
  end;

implementation

uses
  FireDAC.Comp.Client;

function BuscaCodigoTelefone(vEtdCodigo: Integer; vTelefone: string): Integer;
var
  FDAO: iDAOGeneric<TETF>;
  vletfcodigo: Integer;
begin
  vletfcodigo := 0;
  FDAO := TDAOGeneric<TETF>.New;

  FDAO.DAO.SQL.where('etdcodigo=' + vEtdCodigo.ToString + ' and etftelefone=' + QuotedStr(sonumeros(vTelefone))).&End.Find;

  vletfcodigo := FDAO.DataSet.FieldByName('etfcodigo').asInteger;
  result := vletfcodigo;
  // (FDAO.dataset as TFDQuery).Connection.connected:=false;
end;

Function ManutencaoETFCELULAR(var vletdcodigo: Integer; vCliente: TJsonObject): Integer;
var
  FDAO: GourmetServer.Model.DAOGeneric.iDAOGeneric<TETF>;
  FETF: TETF;
  vletfcodigo: Integer;
begin
  FDAO := TDAOGeneric<TETF>.New;
  vletfcodigo := 0;

  FETF := TETF.Create;

  FETF.etfcodigo := vletfcodigo;
  FETF.etdcodigo := vletdcodigo;
  FETF.ttfcodigo := 3;
  FETF.etftelefone := sonumeros(vCliente.getvalue('mobile_phone', ''));
  FETF.etfcontato := vCliente.getvalue('name', '');
  FETF.etfdepartamento := '';
  FETF.etfativo := 1;
  FETF.jsncodigo := '';

  vletfcodigo := BuscaCodigoTelefone(vletdcodigo, FETF.etftelefone);

  if vletfcodigo = 0 then
  // incluir novo
  begin
    FETF.etfcodigo := -1;
    FDAO.DAO.Insert(FETF);
    FDAO.DAO.LastID;
    vletfcodigo := FDAO.DataSet.FieldByName('etfcodigo').asInteger;
  end
  else
  // alterar se ja existe
  begin
    FETF.etfcodigo := vletfcodigo;
    FDAO.DAO.Update(FETF);
  end;
  result := vletfcodigo;
 // (FDAO.dataset as TFDQuery).Connection.connected:=false;

end;

Function ManutencaoETFFIXO(var vletdcodigo: Integer; vCliente: TJsonObject): Integer;
var
  FDAO: GourmetServer.Model.DAOGeneric.iDAOGeneric<TETF>;
  FETF: TETF;
  vletfcodigo: Integer;
begin

  FDAO := TDAOGeneric<TETF>.New;
  vletfcodigo := 0;

  FETF := TETF.Create;

  FETF.etfcodigo := vletfcodigo;
  FETF.etdcodigo := vletdcodigo;
  FETF.ttfcodigo := 8;
  FETF.etftelefone := sonumeros(vCliente.getvalue('phone_number', ''));
  FETF.etfcontato := vCliente.getvalue('name', '');
  FETF.etfdepartamento := '';
  FETF.etfativo := 1;
  FETF.jsncodigo := '';

  vletfcodigo := BuscaCodigoTelefone(vletdcodigo, FETF.etftelefone);

  if vletfcodigo = 0 then
  // incluir novo
  begin
    FETF.etfcodigo := -1;
    FDAO.DAO.Insert(FETF);
    FDAO.DAO.LastID;
    vletfcodigo := FDAO.DataSet.FieldByName('etfcodigo').asInteger;
  end
  else
  // alterar se ja existe
  begin
    FETF.etfcodigo := vletfcodigo;
    FDAO.DAO.Update(FETF);
  end;
  result := vletfcodigo;
 (FDAO.dataset as TFDQuery).Connection.connected:=false;
end;

end.
