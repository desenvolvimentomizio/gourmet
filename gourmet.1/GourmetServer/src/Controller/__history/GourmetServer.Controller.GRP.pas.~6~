unit GourmetServer.Controller.GRP;

interface

Uses
  System.Json,
  System.SysUtils,
  Horse,
  Horse.GBSwagger,
  idHashMessageDigest,
  GourmetServer.Service.Funcoes,
  GourmetServer.Model.DAOGeneric,
  GourmetServer.Model.Entity.GRP;

procedure Registry(App: THorse);
procedure V1Insert(Req: THorseRequest; Res: THorseResponse; Next: TProc);
procedure V1GetID(Req: THorseRequest; Res: THorseResponse; Next: TProc);
procedure V1List(Req: THorseRequest; Res: THorseResponse; Next: TProc);

Function ManutencaoGRP(vGrupo: TJsonObject): Integer;
Function ManutencaoGRPIdentificacao(vNome: string; vOrigem: Integer): Integer;

function BuscaGRPNome(vNome: string; vOrigem: Integer): Integer;

type
  TAPIError = class
  private
    Ferror: string;
  public
    property error: string read Ferror write Ferror;
  end;

implementation

procedure Registry(App: THorse);
begin
  App.Post('/v1/grp', V1Insert);
  App.Get('/v1/grp/:id', V1GetID);
  App.Get('/v1/grp/', V1List);
end;

procedure V1Insert(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  FDAO: iDAOGeneric<TGRP>;
  aObject: TJsonObject;
  vJSONObject: TJsonObject;
  vlJsonGrupo: string;

begin
  FDAO := TDAOGeneric<TGRP>.New;

  vJSONObject := TJsonObject.ParseJSONValue(TEncoding.ASCII.GetBytes(Req.Body), 0) as TJsonObject;
  // vlJsonGrupo := vJSONObject.getvalue('aiqjson', '');

  Res.Send<TJsonObject>(FDAO.Insert(vJSONObject));

end;

procedure V1List(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  FDAO: iDAOGeneric<TGRP>;
  a: string;
begin
  FDAO := TDAOGeneric<TGRP>.New;
  FDAO.dao.sql.Fields('grpcodigo,  grpidentificacao,  tgrcodigo,  cgrcodigo,  grpordem,  imgcodigo,  grpremoto,   sipcodigo ').&End.Find;
  Res.Send<TJsonarray>(FDAO.DataSetAsJsonArray);
end;

procedure V1GetID(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  FDAO: iDAOGeneric<TGRP>;
  a: string;
begin
  FDAO := TDAOGeneric<TGRP>.New;
  FDAO.dao.sql.Fields('grpcodigo,  grpidentificacao,  tgrcodigo,  cgrcodigo,  grpordem,  imgcodigo,  grpremoto,   sipcodigo ')
    .Where('grpcodigo=' + Req.Params.Items['id']).&End.Find;
  Res.Send<TJsonarray>(FDAO.DataSetAsJsonArray);
end;

function BuscaGRPNome(vNome: string; vOrigem: Integer): Integer;
var
  FDAO: iDAOGeneric<TGRP>;
  vlgrpcodigo: Integer;
begin
  vlgrpcodigo := 0;
  FDAO := TDAOGeneric<TGRP>.New;
  if vOrigem = 8 then
  begin
    FDAO.dao.sql.Where('lower(grpidentificacaoaiq)=' + QuotedStr(lowercase(vNome))).&End.Find;
    vlgrpcodigo := FDAO.DataSet.FieldByName('grpcodigo').asInteger;
    if vlgrpcodigo = 0 then
    begin
      FDAO.dao.sql.Where('lower(grpidentificacao)=' + QuotedStr(lowercase(vNome))).&End.Find;
      vlgrpcodigo := FDAO.DataSet.FieldByName('grpcodigo').asInteger;
    end;

    result := vlgrpcodigo;

  end
  else
  begin
    FDAO.dao.sql.Where('lower(grpidentificacao)=' + QuotedStr(lowercase(vNome))).&End.Find;
    vlgrpcodigo := FDAO.DataSet.FieldByName('grpcodigo').asInteger;
    result := vlgrpcodigo;

  end;

end;

Function ManutencaoGRPIdentificacao(vNome: string; vOrigem: Integer): Integer;
var
  vGrupo: TJsonObject;
  vlgrpcodigo: Integer;
begin

  vlgrpcodigo := BuscaGRPNome(vNome, vOrigem);
  if vlgrpcodigo = 0 then
  begin
    vGrupo := TJsonObject.Create;
    vGrupo.AddPair('grpcodigo', vlgrpcodigo.ToString);
    vGrupo.AddPair('grpidentificacao', vNome);
    vGrupo.AddPair('tgrcodigo', '1');
    vGrupo.AddPair('cgrcodigo', '1');
    vGrupo.AddPair('grpordem', '0');
    vGrupo.AddPair('imgcodigo', '1');
    vGrupo.AddPair('grpremoto', '1');
    vGrupo.AddPair('sipcodigo', '1');
    vGrupo.AddPair('grpidentificacaoaiq', vNome);
    vGrupo.AddPair('grpidentificacaonuc', vNome);
    vGrupo.AddPair('grpidentificacaoifood', vNome);

    vlgrpcodigo := ManutencaoGRP(vGrupo);
  end;

  result := vlgrpcodigo;

end;

Function ManutencaoGRP(vGrupo: TJsonObject): Integer;
var
  FDAO: GourmetServer.Model.DAOGeneric.iDAOGeneric<TGRP>;
  FGRP: TGRP;
  vlgrpcodigo: Integer;
begin

  FDAO := TDAOGeneric<TGRP>.New;
  vlgrpcodigo := 0;

  FGRP := TGRP.Create;

  FGRP.grpcodigo := strtoint(vGrupo.getvalue('grpcodigo', ''));
  FGRP.grpidentificacao := vGrupo.getvalue('grpidentificacao', '');
  FGRP.tgrcodigo := strtoint(vGrupo.getvalue('tgrcodigo', ''));
  FGRP.cgrcodigo := strtoint(vGrupo.getvalue('cgrcodigo', ''));
  FGRP.grpordem := strtoint(vGrupo.getvalue('grpordem', ''));
  FGRP.imgcodigo := strtoint(vGrupo.getvalue('imgcodigo', ''));
  FGRP.grpremoto := strtoint(vGrupo.getvalue('grpremoto', ''));
  FGRP.sipcodigo := strtoint(vGrupo.getvalue('sipcodigo', ''));
  FGRP.grpidentificacaoaiq := vGrupo.getvalue('grpidentificacaoaiq', '');
  FGRP.grpidentificacaonuc := vGrupo.getvalue('grpidentificacaonuc', '');
  FGRP.grpidentificacaoifood := vGrupo.getvalue('grpidentificacaofood', '');

  if vlgrpcodigo = 0 then
  // incluir novo
  begin
    FGRP.grpcodigo := 0;
    FDAO.dao.Insert(FGRP);
    FDAO.dao.LastID;
    vlgrpcodigo := FDAO.DataSet.FieldByName('grpcodigo').asInteger;
  end
  else
  // alterar se ja existe
  begin
    FGRP.grpcodigo := vlgrpcodigo;
    FDAO.dao.Update(FGRP);
  end;
  result := vlgrpcodigo;

end;

end.
