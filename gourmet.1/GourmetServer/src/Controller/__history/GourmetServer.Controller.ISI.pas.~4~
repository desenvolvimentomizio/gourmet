unit GourmetServer.Controller.ISI;

interface

Uses
  Horse,
  System.Json,
  System.SysUtils,
  idHashMessageDigest,
  GourmetServer.Model.DAOGeneric,
  GourmetServer.Model.Entity.ISI;

Function ManutencaoISI(vItemSabor: TJsonObject): Integer;
Function BuscaItemISIItochave(vItoChave: String): Integer;

type
  TAPIError = class
  private
    Ferror: string;
  public
    property error: string read Ferror write Ferror;
  end;

implementation

Function BuscaItemISIItochave(vItoChave: String): Integer;
var
  FDAO: iDAOGeneric<TISI>;
begin
  FDAO := TDAOGeneric<TISI>.New;
  FDAO.DAO.SQL.where('itochave=' + vItoChave + ' order by isiitem desc limit 1 ').&End.Find;
  result := FDAO.DataSet.FieldByName('isiitem').asInteger + 1;
end;

Function ManutencaoISI(vItemSabor: TJsonObject): Integer;
var
  FDAO: GourmetServer.Model.DAOGeneric.iDAOGeneric<TISI>;
  FISI: TISI;
  vlisichave: Integer;
begin
  FDAO := TDAOGeneric<TISI>.New;

  vlisichave := vItemSabor.getvalue('isichave', '').ToInteger;;

  FISI := TISI.Create;
  FISI.isichave := vlisichave;
  FISI.sbichave := vItemSabor.getvalue('sbichave', '').ToInteger;
  FISI.tsicodigo := vItemSabor.getvalue('tsicodigo', '').ToInteger;
  FISI.procodigo := vItemSabor.getvalue('procodigo', '').ToInteger;
  FISI.isitipo := vItemSabor.getvalue('isitipo', '').ToInteger;
  FISI.itochave := vItemSabor.getvalue('itochave', '').ToInteger;
  FISI.isiquantidade := vItemSabor.getvalue('isiquantidade', '').ToInteger;
  FISI.isiacrescimo := strtofloat(vItemSabor.getvalue('isiacrescimo', ''));
  FISI.isiitem := vItemSabor.getvalue('isiitem', '').ToInteger;

  if vlisichave = 0 then
  // incluir novo
  begin
    FISI.isichave := 0;
    FDAO.DAO.Insert(FISI);
    FDAO.DAO.LastID;
    vlisichave := FDAO.DataSet.FieldByName('isichave').asInteger;
  end
  else
  // alterar se ja existe
  begin
    FISI.isichave := vlisichave;
    FDAO.DAO.Update(FISI);
  end;
  result := vlisichave;

end;

end.
