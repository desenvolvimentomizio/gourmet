unit GourmetServer.Controller.ImportaCardapioMizio;

interface

Uses
  math,
  Horse,
  System.Json,
  Horse.GBSwagger,
  idHashMessageDigest,
  GourmetServer.Service.Funcoes,
  GourmetServer.Controller.CFGMGOU,
  GourmetServer.Controller.SBR,
  GourmetServer.Controller.BRG,
  GourmetServer.Controller.PRO,
  GourmetServer.Controller.GRI,
  GourmetServer.Controller.PUN,
  GourmetServer.Controller.GRP,
  GourmetServer.Controller.UNI,
  GourmetServer.Controller.BRD,
  GourmetServer.Controller.SFN,
  GourmetServer.Controller.ISA,
  GourmetServer.Controller.V_IGA,
  GourmetServer.Model.DAOGeneric;

procedure Registry(App: THorse);
procedure V1Insert(Req: THorseRequest; Res: THorseResponse; Next: TProc);

type
  TAPIError = class
  private
    Ferror: string;
  public
    property error: string read Ferror write Ferror;
  end;

const
  vOrigem: Integer = 0;

implementation

uses
  System.SysUtils, GourmetServer.Controller.BPR;

procedure Registry(App: THorse);
begin
  App.Post('/v1/cardapioMizio', V1Insert);
end;

procedure ImportaCardapioMizio(vCardapio: TJsonObject);
var
  vlProCodigo: Integer;
  vlPronome: String;
  vlSabor: String;
  vlSbrCodigo: Integer;
  vlIngredientes: String;
  vlIsaIdentificacao: String;

  vlGrpIdentificacao: string;
  vlGrpCodigo: Integer;

  vlListaGrupos: TJsonarray;
  vlListaProdutos: TJsonarray;

  ig: Integer;
  vlQtdGrupos: Integer;

  ip: Integer;
  vlQtdProdutos: Integer;

  vlUnidade1: string;
  vlunicodigo1: Integer;

  vlUnidade2: string;
  vlunicodigo2: Integer;

  vlPreco1: string;
  vlPreco2: string;
begin

  vlListaGrupos := vCardapio.getvalue<TJsonarray>('Grupos');

  vlQtdGrupos := vlListaGrupos.Count;

  for ig := 0 to vlQtdGrupos - 1 do
  begin
    vlGrpIdentificacao := '';
    vlGrpCodigo := 0;

    vlGrpIdentificacao := trim(uppercase(vlListaGrupos[ig].getvalue('NomeGrupo', '')));
    vlGrpCodigo := manutencaoGRPIdentificacao(vlGrpIdentificacao, vOrigem);

    vlListaProdutos := vlListaGrupos[ig].getvalue<TJsonarray>('Produtos');
    vlQtdProdutos := vlListaProdutos.Count;

    for ip := 0 to vlQtdProdutos - 1 do
    begin

      vlUnidade1 := '';
      vlUnidade2 := '';
      vlPreco1 := '';
      vlPreco2 := '';
      vlPronome := '';
      vlIngredientes := '';

      vlPronome := uppercase(vlListaProdutos[ip].getvalue('Produto', ''));

      if vlPronome <> '' then
      begin

        vlProCodigo := BuscaCodigoPROProNome(vlPronome);

        vlUnidade1 := trim(uppercase(vlListaProdutos[ip].getvalue('Unidade1', '')));
        if vlUnidade2 <> '' then
        begin
          vlunicodigo1 := BuscaUNINome(vlUnidade1, vOrigem);
          if vlunicodigo1 = 0 then
          begin
            vlunicodigo1 := ManutencaoUNINome(vlUnidade1, vOrigem);
          end;
        end;

        if vlProCodigo = 0 then
        begin
          vlProCodigo := ManutencaoPROAplicativo(vlGrpIdentificacao, vlGrpCodigo, vlunicodigo1, 0, vlIngredientes);
        end;

        vlSabor := trim(uppercase(vlListaProdutos[ip].getvalue('Sabor', '')));

        if vlSabor <> '' then
        begin
          vlSbrCodigo := 0;
          vlSbrCodigo := ManutencaoSBRIdentificacao(vlSabor, vlProCodigo.ToString, '');
        end;

        vlIngredientes := uppercase(vlListaProdutos[ip].getvalue('Ingredientes', ''));

        if vlIngredientes <> '' then
        begin
          if vlSbrCodigo = 0 then
          begin
            vlSbrCodigo := ManutencaoSBRIdentificacao(vlPronome, vlProCodigo.ToString, '');
          end;

          if vlSbrCodigo <> 0 then
          begin

            while vlIngredientes <> '' do
            begin
              if pos(',', vlIngredientes) > 0 then
              begin
                vlIsaIdentificacao := trim(copy(vlIngredientes, 1, pos(',', vlIngredientes) - 1));
                vlIngredientes := trim(copy(vlIngredientes, pos(',', vlIngredientes) + 1, length(vlIngredientes)));

              end
              else if pos(' e ', vlIngredientes) > 0 then
              begin
                vlIsaIdentificacao := trim(copy(vlIngredientes, 1, pos(' e ', vlIngredientes) - 1));
                vlIngredientes := trim(copy(vlIngredientes, pos(' e ', vlIngredientes) + 1, length(vlIngredientes)));

              end
              else
              begin
                if vlIngredientes <> '' then
                begin
                  vlIsaIdentificacao := trim(vlIngredientes);
                  vlIngredientes := '';
                end;
              end;

              if vlIsaIdentificacao <> '' then
              begin
                ManutencaoISAAplicativo(vlGrpCodigo, vlSbrCodigo, vlIsaIdentificacao, '0', 0);
              end;

            end;

          end;

        end;

        vlPreco1 := trim(uppercase(vlListaProdutos[ip].getvalue('Preco1', '')));
        if vlPreco1 <> '' then
        begin
          ManutencaoPUNAplicativo(vlProCodigo, vlunicodigo1, vlPreco1);
        end;

        vlUnidade2 := trim(uppercase(vlListaProdutos[ip].getvalue('Unidade2', '')));
        if vlUnidade2 <> '' then
        begin
          vlunicodigo2 := BuscaUNINome(vlUnidade2, vOrigem);
          if vlunicodigo2 = 0 then
          begin
            vlunicodigo2 := ManutencaoUNINome(vlUnidade2, vOrigem);
          end;

        end;

        vlPreco2 := trim(uppercase(vlListaProdutos[ip].getvalue('Preco2', '')));

        if vlPreco2 <> '' then
        begin
          ManutencaoPUNAplicativo(vlProCodigo, vlunicodigo2, vlPreco2);
        end;

      end;
    end;
  end;
end;

procedure V1Insert(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  vJSonCardapio: TJsonObject;
  vJSONObject: TJsonObject;

  vJSONGrupos: TJsonarray;
  vlJsonCardapio: string;

begin

  vJSONObject := TJsonObject.ParseJSONValue(TEncoding.ASCII.GetBytes(Req.Body), 0) as TJsonObject;
  if vJSONObject <> nil then
  begin
    vJSonCardapio := vJSONObject.getvalue<TJsonObject>('data');
    if vJSonCardapio <> nil then
    begin

      vJSONGrupos := vJSonCardapio.getvalue<TJsonarray>('Grupos');
      if vJSONGrupos <> nil then
      begin

        vlJsonCardapio := vJSONGrupos.ToString;

        if vlJsonCardapio <> '' then
        begin
          ImportaCardapioMizio(vJSonCardapio);
        end;
      end;
    end;
  end;

end;

end.
