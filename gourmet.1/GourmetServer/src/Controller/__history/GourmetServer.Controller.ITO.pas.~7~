unit GourmetServer.Controller.ITO;

interface

Uses
  Horse,
  System.Json,
  System.SysUtils,
  idHashMessageDigest,
  GourmetServer.Model.DAOGeneric,
  GourmetServer.Model.Entity.ITO;

Function ManutencaoITO(vItem: TJsonObject): Integer;
Function BuscaItemITOorcchave(vOrcChave: String): Integer;

type
  TAPIError = class
  private
    Ferror: string;
  public
    property error: string read Ferror write Ferror;
  end;

implementation

Function BuscaItemITOorcchave(vOrcChave: String): Integer;
var
  FDAO: iDAOGeneric<TITO>;
begin
  FDAO := TDAOGeneric<TITO>.New;
  FDAO.DAO.SQL.where('orcchave=' + vOrcChave + ' order by itoitem desc limit 1 ').&End.Find;
  result := FDAO.DataSet.FieldByName('itoitem').asInteger + 1;
end;

Function ManutencaoITO(vItem: TJsonObject): Integer;
var
  FDAO: GourmetServer.Model.DAOGeneric.iDAOGeneric<TITO>;
  FITO: TITO;
  vlitochave: Integer;
begin

  FDAO := TDAOGeneric<TITO>.New;

  vlitochave := vItem.getvalue('itochave', '').ToInteger;;

  FITO := TITO.Create;
  FITO.itochave := vlitochave;
  FITO.orcchave := vItem.getvalue('orcchave', '').ToInteger;
  FITO.flacodigo := vItem.getvalue('flacodigo', '').ToInteger;
  FITO.procodigo := vItem.getvalue('procodigo', '').ToInteger;
  FITO.itoquantidade := vItem.getvalue('itoquantidade', '').ToDouble;
  FITO.itovalorav := vItem.getvalue('itovalorav', '').ToDouble;
  FITO.itototalav := vItem.getvalue('itototalav', '').ToDouble;
  FITO.itodescontoav := vItem.getvalue('itodescontoav', '').ToDouble;
  FITO.itosaldoav := vItem.getvalue('itosaldoav', '').ToDouble;
  FITO.itovalorap := vItem.getvalue('itovalorap', '').ToDouble;
  FITO.itototalap := vItem.getvalue('itototalap', '').ToDouble;
  FITO.itodescontoap := vItem.getvalue('itodescontoap', '').ToDouble;

  if vItem.getvalue('itooutras', '') <> '' then
  begin
    FITO.itooutras := vItem.getvalue('itooutras', '').ToDouble;
  end;

  FITO.itosaldoap := vItem.getvalue('itosaldoap', '').ToDouble;
  FITO.unicodigo := vItem.getvalue('unicodigo', '').ToInteger;
  FITO.puncodigo := vItem.getvalue('puncodigo', '').ToInteger;
  FITO.itocontendo := vItem.getvalue('itocontendo', '').ToDouble;
  FITO.tdecodigo := vItem.getvalue('tdecodigo', '').ToInteger;
  FITO.stocodigo := vItem.getvalue('stocodigo', '').ToInteger;
  FITO.itoitem := vItem.getvalue('itoitem', '').ToInteger;
  FITO.itopercdescav := vItem.getvalue('itopercdescav', '').ToDouble;
  FITO.itopercdescap := vItem.getvalue('itopercdescap', '').ToDouble;
  FITO.itoproservico := vItem.getvalue('itoproservico', '');
  FITO.itoinfadprod := vItem.getvalue('itoinfadprod', '');
  FITO.itoprocomple := vItem.getvalue('itoprocomple', '');
  FITO.tdfcodigo := vItem.getvalue('tdfcodigo', '');
  FITO.flacodigo := vItem.getvalue('flacodigo', '').ToInteger;
  FITO.pmpchave := vItem.getvalue('pmpchave', '').ToInteger;
  FITO.itoobs := vItem.getvalue('itoobs', '');
  FITO.itounidades := vItem.getvalue('itounidades', '').ToInteger;
  FITO.itoacrescimoav := vItem.getvalue('itoacrescimoav', '').ToDouble;
  FITO.clbatendente := vItem.getvalue('clbatendente', '').ToInteger;
  FITO.oricodigo := vItem.getvalue('oricodigo', '').ToInteger;



  if vlitochave = 0 then
  begin
    FITO.itochave := 0;
    FDAO.DAO.Insert(FITO);
    FDAO.DAO.LastID;
    vlitochave := FDAO.DataSet.FieldByName('itochave').asInteger;
  end
  else
  begin
    FITO.itochave := vlitochave;
    FDAO.DAO.Update(FITO);
  end;


  result := vlitochave;

end;

end.
