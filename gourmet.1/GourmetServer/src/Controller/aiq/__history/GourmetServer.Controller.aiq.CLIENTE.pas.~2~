unit GourmetServer.Controller.aiq.CLIENTE;

interface

Uses
  Horse,
  System.Json,
  System.SysUtils,
  Horse.GBSwagger,
  idHashMessageDigest,
  GourmetServer.Model.DAOGeneric,
  GourmetServer.Controller.V_CLI,
  GourmetServer.Controller.ETD,
  GourmetServer.Controller.ETV,
  GourmetServer.Controller.CDD,
  GourmetServer.Controller.UFS,
  GourmetServer.Controller.CEP,
  GourmetServer.Controller.ETF,
  GourmetServer.Controller.EDR,
  GourmetServer.Controller.ETE;

procedure Registry(App: THorse);
procedure V1Get(Req: THorseRequest; Res: THorseResponse; Next: TProc);
procedure V1Update(Req: THorseRequest; Res: THorseResponse; Next: TProc);
procedure ManutencaoCliente(vEtdCodigo: Integer; vEdrCodigo: Integer; vCliente: TJsonObject);

type
  TAPIError = class
  private
    Ferror: string;
  public
    property error: string read Ferror write Ferror;
  end;

implementation

procedure ManutencaoCliente(vEtdCodigo: Integer; vEdrCodigo: Integer; vCliente: TJsonObject);
var

  vletdcodigo: Integer;
  vledrcodigo: Integer;

begin
  vletdcodigo := vEtdCodigo;
  vledrcodigo := vEdrCodigo;

  vletdcodigo := ManutencaoETD(vletdcodigo, vCliente);
  ManutencaoEDR(vletdcodigo, vledrcodigo, vCliente);
  ManutencaoETFCELULAR(vletdcodigo, vCliente);
  ManutencaoETFFIXO(vletdcodigo, vCliente);
  ManutencaoETE(vletdcodigo, vCliente);
  ManutencaoETV(vletdcodigo);

end;

procedure Registry(App: THorse);
begin
  App.Put('/v1/etdaiq', V1Update);
  App.Get('/v1/etdaiq', V1Get);
end;

procedure V1Update(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  aObject: TJsonObject;
  vletdcodigo: Integer;
  vletfcelular: String;
  vletftelefone: String;
  vleteemail: String;
  vletdidentificacao: String;

  vledrrua: String;
  vledrnumero: String;
  vledrcodigo: Integer;

begin

  aObject := TJsonObject.Create;
  aObject := Req.Body<TJsonObject>;

  vletdcodigo := -1;
  vletdidentificacao := aObject.getvalue('name', '');
  vletfcelular := aObject.getvalue('mobile_phone', '');
  vletftelefone := aObject.getvalue('phone_number', '');
  vledrrua := aObject.getvalue('street_name', '');
  vledrnumero := aObject.getvalue('number', '');
  vleteemail := aObject.getvalue('email', '');

  vletdcodigo := BuscaCodigoETD(vletftelefone, vletfcelular, vleteemail, vletdidentificacao);
  vledrcodigo := BuscaCodigoEndereco(vletdcodigo, vledrrua, vledrnumero);
  ManutencaoCliente(vletdcodigo, vledrcodigo, aObject);

end;

procedure V1Get(Req: THorseRequest; Res: THorseResponse; Next: TProc);
{ var
  FDAO: iDAOGeneric<TETD>; }
begin
  { FDAO := TDAOGeneric<TETD>.New;

    FDAO.DAO.SQL.Fields
    ('cfgcodigo,cfgmgouvalidadenuc,cfgmgoutokenaiq, cfgmgourefreshaiq,cfgmgouvalidadeaiq,cfgmgouidlojaaiq,cfgmgouemaillojaaiq,cfgmgousenhalojaaiq, cfgmgousituacaolojaaiq')
    .&End.Find;
    Res.Send<TJsonarray>(FDAO.DataSetAsJsonArray);
  }
end;

end.
