unit ufprincipromochopp;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, UniProvider, MySQLUniProvider, Data.DB,
  DBAccess, Uni, DASQLMonitor, UniSQLMonitor, inifiles, Vcl.ExtCtrls, MemDS;

type
  Tfprincipromochopp = class(TForm)
    UniSQLMonitor: TUniSQLMonitor;
    Conexao: TUniConnection;
    MySQLUniProvider: TMySQLUniProvider;
    plrodape: TPanel;
    plbanco: TPanel;
    plservidor: TPanel;
    Inicializar: TTimer;
    promochopp: TUniQuery;
    plrelogio: TPanel;
    consulta: TUniQuery;
    Panel1: TPanel;
    procedure InicializarTimer(Sender: TObject);
    procedure FormShow(Sender: TObject);
  private
    procedure ConectaBanco;
    { Private declarations }
  public
    { Public declarations }

    vppromoproduto01:string;
    vppromovalnovo01:string;
    vppromovalorig01:string;
    vppromohorainicio01:string;
    vppromohorafinal01:string;

    vppromoproduto02:string;
    vppromovalnovo02:string;
    vppromovalorig02:string;
    vppromohorainicio02:string;
    vppromohorafinal02:string;

    vppromoproduto03:string;
    vppromovalnovo03:string;
    vppromovalorig03:string;
    vppromohorainicio03:string;
    vppromohorafinal03:string;

    vppromoproduto04:string;
    vppromovalnovo04:string;
    vppromovalorig04:string;
    vppromohorainicio04:string;
    vppromohorafinal04:string;




  end;

var
  fprincipromochopp: Tfprincipromochopp;

implementation

{$R *.dfm}

Procedure Tfprincipromochopp.ConectaBanco;
Var
  arquini: TIniFile;
  vlNomeBanco: String;
  vlPortaBanco: String;
  vlServidor: String;
  vlUsuario: String;
  vlSenha: String;
  vlMonitor: String;
  vlTipoBanco: String;
Begin
  try
    arquini := TIniFile.Create(ExtractFilePath(Application.ExeName) + 'gourmeterp.ini');
    With arquini Do
    Begin
      vlNomeBanco := ReadString('posi', 'nomebanco', 'mizio');
      vlServidor := ReadString('posi', 'servidor', '127.0.0.1');
      vlUsuario := ReadString('posi', 'usuario', 'root');
      vlSenha := ReadString('posi', 'senha', 'xda973');
      vlPortaBanco := ReadString('posi', 'portabanco', '3306');
      vlMonitor := ReadString('posi', 'monitor', '0');
      vlTipoBanco := ReadString('posi', 'tipo', 'mysql');


    vppromoproduto01:=ReadString('promocao01', 'produto', '');
    vppromovalorig01:=ReadString('promocao01', 'preconormal', '');
    vppromovalnovo01:=ReadString('promocao01', 'precopromocional', '');
    vppromohorainicio01:=ReadString('promocao01', 'horainicio', '');
    vppromohorafinal01:=ReadString('promocao01', 'horafinal', '');

    vppromovalorig01:=StringReplace(vppromovalorig01,',','.',[]);
    vppromovalnovo01:=StringReplace(vppromovalnovo01,',','.',[]);



    vppromoproduto02:=ReadString('promocao02', 'produto', '');
    vppromovalorig02:=ReadString('promocao02', 'preconormal', '');
    vppromovalnovo02:=ReadString('promocao02', 'precopromocional', '');
    vppromohorainicio02:=ReadString('promocao02', 'horainicio', '');
    vppromohorafinal02:=ReadString('promocao02', 'horafinal', '');

    vppromovalorig02:=StringReplace(vppromovalorig02,',','.',[]);
    vppromovalnovo02:=StringReplace(vppromovalnovo02,',','.',[]);


    vppromoproduto03:=ReadString('promocao03', 'produto', '');
    vppromovalorig03:=ReadString('promocao03', 'preconormal', '');
    vppromovalnovo03:=ReadString('promocao03', 'precopromocional', '');
    vppromohorainicio03:=ReadString('promocao03', 'horainicio', '');
    vppromohorafinal03:=ReadString('promocao03', 'horafinal', '');

    vppromovalorig03:=StringReplace(vppromovalorig03,',','.',[]);
    vppromovalnovo03:=StringReplace(vppromovalnovo03,',','.',[]);

    vppromoproduto04:=ReadString('promocao04', 'produto', '');
    vppromovalorig04:=ReadString('promocao04', 'preconormal', '');
    vppromovalnovo04:=ReadString('promocao04', 'precopromocional', '');
    vppromohorainicio04:=ReadString('promocao04', 'horainicio', '');
    vppromohorafinal04:=ReadString('promocao04', 'horafinal', '');

    vppromovalorig04:=StringReplace(vppromovalorig04,',','.',[]);
    vppromovalnovo04:=StringReplace(vppromovalnovo04,',','.',[]);


      if vlNomeBanco = 'sulani' then
        vlSenha := 'riticami';

    End;
    arquini.Free;

    plbanco.Caption := vlNomeBanco;
    plservidor.Caption := vlServidor;

    (* Configuração para DBMonitor *)
    if vlMonitor = '1' then
      UniSQLMonitor.Active := true
    else
      UniSQLMonitor.Active := False;

    if lowercase(vlTipoBanco) = 'mysql' then
      Conexao.ProviderName := 'mySQL';

    if lowercase(vlTipoBanco) = 'postgresql' then
      Conexao.ProviderName := 'PostgreSQL';

    Conexao.Connected := False;
    Conexao.Database := vlNomeBanco;
    Conexao.Username := vlUsuario;
    Conexao.Password := vlSenha;
    Conexao.Port := StrToInt(vlPortaBanco);
    Conexao.Server := vlServidor;

    Conexao.Connected := true;

  except
    plbanco.Caption := 'ERRO';
    plservidor.Caption := 'ERRO';

  end;
End;

procedure Tfprincipromochopp.FormShow(Sender: TObject);
begin
  Inicializar.Enabled := true;
end;

procedure Tfprincipromochopp.InicializarTimer(Sender: TObject);
begin
  Conexao.Connected := False;
  ConectaBanco;
  try
    consulta.Close;
    consulta.SQL.Text := 'select now() as agora';
    consulta.Open;

    if vppromoproduto01<>'' then
    begin
      if (time()>=strtotime(vppromohorainicio01))  and  (time()<=strtotime(vppromohorafinal01))  then
      begin
        promochopp.Close;
        promochopp.sql.text:='update pun set  punprecoav='+vppromovalnovo01+' where procodigo='+vppromoproduto01; ;
        promochopp.ExecSQL;
      end
      else
      begin
        promochopp.Close;
        promochopp.sql.text:='update pun set  punprecoav='+vppromovalorig01+' where procodigo='+vppromoproduto01; ;
        promochopp.ExecSQL;
      end;
    end;

    if vppromoproduto02<>'' then
    begin
      if (time()>=strtotime(vppromohorainicio02))  and  (time()<=strtotime(vppromohorafinal02))  then
      begin
        promochopp.Close;
        promochopp.sql.text:='update pun set  punprecoav='+vppromovalnovo02+' where procodigo='+vppromoproduto02; ;
        promochopp.ExecSQL;
      end
      else
      begin
        promochopp.Close;
        promochopp.sql.text:='update pun set  punprecoav='+vppromovalorig02+' where procodigo='+vppromoproduto02; ;
        promochopp.ExecSQL;
      end;
    end;

    if vppromoproduto03<>'' then
    begin
      if (time()>=strtotime(vppromohorainicio03))  and  (time()<=strtotime(vppromohorafinal03))  then
      begin
        promochopp.Close;
        promochopp.sql.text:='update pun set  punprecoav='+vppromovalnovo03+' where procodigo='+vppromoproduto03; ;
        promochopp.ExecSQL;
      end
      else
      begin
        promochopp.Close;
        promochopp.sql.text:='update pun set  punprecoav='+vppromovalorig03+' where procodigo='+vppromoproduto03; ;
        promochopp.ExecSQL;
      end;
    end;


    if vppromoproduto04<>'' then
    begin
      if (time()>=strtotime(vppromohorainicio04))  and  (time()<=strtotime(vppromohorafinal04))  then
      begin
        promochopp.Close;
        promochopp.sql.text:='update pun set  punprecoav='+vppromovalnovo04+' where procodigo='+vppromoproduto04; ;
        promochopp.ExecSQL;
      end
      else
      begin
        promochopp.Close;
        promochopp.sql.text:='update pun set  punprecoav='+vppromovalorig04+' where procodigo='+vppromoproduto04; ;
        promochopp.ExecSQL;
      end;
    end;


    plrelogio.Caption := consulta.FieldByName('agora').AsString;
    Application.ProcessMessages;
  except
    plrelogio.Caption := 'ERRO';
    Application.ProcessMessages;

  end;

end;

end.
