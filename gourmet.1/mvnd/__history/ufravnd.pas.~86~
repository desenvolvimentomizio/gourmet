unit ufravnd;

interface

uses
  Winapi.Windows, Vcl.Forms, ufrabase, Data.DB, Vcl.StdCtrls, Vcl.DBCtrls,
  Vcl.Mask, Vcl.ComCtrls, VirtualTable, MemDS, DBAccess, Uni, Vcl.Menus,
  System.Classes, System.Actions, Vcl.ActnList, Vcl.Buttons, Vcl.Grids,
  Vcl.DBGrids, Vcl.Imaging.jpeg, Vcl.ExtCtrls, Vcl.Imaging.pngimage,
  Vcl.Controls, Vcl.Dialogs, Vcl.Graphics, System.SysUtils, uFuncoes, uPegaBase,
  ufcremlt, System.ImageList, Vcl.ImgList, Xml.xmldom,
  Xml.XMLIntf, Xml.XMLDoc, dateutils,
  System.Diagnostics;

type
  Tfravnd = class(Tfrabase)
    cfg: tuniquery;
    consultax: tuniquery;
    Dtom: tunidatasource;
    tom: tuniquery;
    tomtomchave: TIntegerField;
    tomtofcodigo: TIntegerField;
    tommeschave: TIntegerField;
    tomtofidentificacao: TStringField;
    Ddtm: tunidatasource;
    dtm: tuniquery;
    dtmdtmchave: TIntegerField;
    dtmdtmplaca: TStringField;
    dtmdtmvolumes: TFloatField;
    dtmdtmpesobruto: TFloatField;
    dtmdtmpesoliq: TFloatField;
    dtmmeschave: TIntegerField;
    dtmetdcodigo: TIntegerField;
    dtmufscodigo: TStringField;
    dtmedrrua: TStringField;
    dtmcddnome: TStringField;
    dtmufssigla: TStringField;
    dtmetddoc1: TStringField;
    dtmetdidentificacao: TStringField;
    dtmdtmespecie: TStringField;
    dtmdtmmarcas: TStringField;
    dtmedrinscest: TStringField;
    rfm: tuniquery;
    rfmltedinheiro: TFloatField;
    rfmltechequepro: TFloatField;
    rfmltechequeter: TFloatField;
    rfmltecartcred: TFloatField;
    rfmltecartdeb: TFloatField;
    rfmltebancario: TFloatField;
    rfmltereparc: TFloatField;
    Ditm: tunidatasource;
    itm: tuniquery;
    itmitmchave: TIntegerField;
    itmmeschave: TIntegerField;
    itmitmitem: TIntegerField;
    itmprocodigo: TIntegerField;
    itmpronome: TStringField;
    itmunisimbolo: TStringField;
    itmitmvalor: TFloatField;
    itmitmquantidade: TFloatField;
    itmitmdesconto: TFloatField;
    itmitmtotal: TFloatField;
    itmcfocfop: TStringField;
    itmitmaliqipi: TFloatField;
    etd: tuniquery;
    ete: tuniquery;
    vdtm: tuniquery;
    vdtmdtmchave: TIntegerField;
    vdtmdtmplaca: TStringField;
    vdtmdtmvolumes: TFloatField;
    vdtmdtmpesobruto: TFloatField;
    vdtmdtmpesoliq: TFloatField;
    vdtmmeschave: TIntegerField;
    vdtmetdcodigo: TIntegerField;
    vdtmufscodigo: TStringField;
    vdtmedrrua: TStringField;
    vdtmcddnome: TStringField;
    vdtmufssigla: TStringField;
    vdtmetddoc1: TStringField;
    vdtmetdidentificacao: TStringField;
    vdtmdtmespecie: TStringField;
    vdtmdtmmarcas: TStringField;
    vdtmedrinscest: TStringField;
    PCDetalhes: TPageControl;
    TSObservacoes: TTabSheet;
    Label6: TLabel;
    listaobs: TDBGrid;
    TSTransporte: TTabSheet;
    Label5: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    etdcodigo: TDBEdit;
    etdidentificacao: TDBEdit;
    ufssigla: TDBEdit;
    dtmplaca: TDBEdit;
    dtmvolumes: TDBEdit;
    dtmespecie: TDBEdit;
    dtmmarcas: TDBEdit;
    dtmpesobruto: TDBEdit;
    dtmpesoliq: TDBEdit;
    Pnl1: TPanel;
    PlResumo: TPanel;
    pdetalhe: TPanel;
    Panel3: TPanel;
    listapor: TDBGrid;
    pvalordetalhe: TPanel;
    PlItens: TPanel;
    listaitm: TDBGrid;
    PlRodapeItens: TPanel;
    plQtdItens: TPanel;
    plDescontoItens: TPanel;
    plBrutoItens: TPanel;
    plLiquidoItens: TPanel;
    uqtabelameschave: TIntegerField;
    uqtabelamesemissao: TDateField;
    uqtabelatdfidentificacao: TStringField;
    uqtabelamesnumero: TIntegerField;
    uqtabelaetdcodigo: TIntegerField;
    uqtabelaetdidentificacao: TStringField;
    uqtabelamesvalor: TFloatField;
    uqtabelamesdesconto: TFloatField;
    uqtabelamestotal: TFloatField;
    uqtabelasdeidentificacao: TStringField;
    uqtabelatoeidentificacao: TStringField;
    uqtabelamesserie: TStringField;
    uqtabelaclbcodigo: TIntegerField;
    uqtabelatrmcodigo: TIntegerField;
    uqtabelamesprotocolo: TStringField;
    uqtabelasdecodigo: TStringField;
    uqtabelamesdatanfe: TDateField;
    uqtabelatemcodigo: TIntegerField;
    uqtabelatdfcodigo: TStringField;
    itmitmtotalliq: TFloatField;
    tto: tuniquery;
    ttottocodigo: TIntegerField;
    ttottoidentificacao: TStringField;
    uqtabelattocodigo: TIntegerField;
    uqtabelamesregistro: TDateField;
    ActFaturar: TAction;
    SplItens: TSplitter;
    ActGeraCupomFiscal: TAction;
    itmtoecodigo: TIntegerField;
    ActAjustaOperacao: TAction;
    dtl: tuniquery;
    Ddtl: TDataSource;
    dtlmdaidentificacao: TStringField;
    dtldtlvalor: TFloatField;
    itmproncm: TStringField;
    clb: tuniquery;
    clbclbcodigo: TIntegerField;
    clbclbidentificacao: TStringField;
    uqtabelatemidentificacao: TStringField;
    plInformacoes: TPanel;
    plEstorno: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    hcmdata: TDBEdit;
    hcmhora: TDBEdit;
    clbidentificacao: TDBEdit;
    ccm: tuniquery;
    ccmmeamotivo: TStringField;
    ccmmeacodigo: TIntegerField;
    ccmccmmotivo: TStringField;
    ccmerfchave: TIntegerField;
    Dccm: TDataSource;
    erf: tuniquery;
    erferfdata: TDateField;
    erferfhora: TTimeField;
    erfclbidentificacao: TStringField;
    Derf: TDataSource;
    erferfchave: TIntegerField;
    uqtabelaclboperador: TStringField;
    uqTotais: tuniquery;
    uqTotaismesvalor: TFloatField;
    uqTotaismesdeconto: TFloatField;
    uqTotaismestotal: TFloatField;
    uqTotaismestotalcancelado: TFloatField;
    uqTotaismestotalnf: TFloatField;
    uqItmTotais: tuniquery;
    uqItmTotaismeschave: TIntegerField;
    uqItmTotaisitmtotal: TFloatField;
    uqItmTotaisitmdesconto: TFloatField;
    uqItmTotaisitmtotalliq: TFloatField;
    uqItmTotaisitmitens: TIntegerField;
    uqtabelaflasigla: TStringField;
    uqtabelamesprodutos: TFloatField;
    uqtabelamesservicos: TFloatField;
    uqTotaismestotalprodutos: TFloatField;
    uqTotaismestotalservicos: TFloatField;
    ActAjustarEstagio: TAction;
    tit: tuniquery;
    tittitcodigo: TIntegerField;
    plDetalhes: TPanel;
    plTituloItensDetalhe: TPanel;
    btOcultaExibeDetalhe: TSpeedButton;
    uqtabelaflacodigo: TIntegerField;
    hcm: tuniquery;
    Dhcm: TDataSource;
    hcmhcmchave: TIntegerField;
    hcmmeschave: TIntegerField;
    hcmsdecodigo: TStringField;
    hcmclbcodigo: TIntegerField;
    hcmclbidentificacao: TStringField;
    hcmhcmdata: TDateField;
    hcmhcmhora: TTimeField;
    hcmhcmdescricao: TStringField;
    hcmdescricao: TDBEdit;
    plTituloItensObservacoes: TPanel;
    btOcultaExibeObservacoes: TSpeedButton;
    mAjustarFilial: TMenuItem;
    N1: TMenuItem;
    Utilitarios: TMenuItem;
    mfirfi: tuniquery;
    itmcstcodigo: TStringField;
    itmcspcodigo: TStringField;
    itmitmpis: TFloatField;
    itmitmcofins: TFloatField;
    ActAlterarCliente: TAction;
    AjustarCFOPdoItens1: TMenuItem;
    uqtabelatoecodigo: TIntegerField;
    Panel1: TPanel;
    btOcultaExibeTotais: TSpeedButton;
    uqtabelatoecfopsaida: TStringField;
    ActFinalizar: TAction;
    uqtabelamestipocomissao: TIntegerField;
    uqDtlTotais: tuniquery;
    uqDtlConvenios: tuniquery;
    DSTotaisDtls: TDataSource;
    TotaisDtls: TVirtualTable;
    TotaisDtlsmdaidentificacao: TStringField;
    TotaisDtlsdtlvalor: TFloatField;
    TotaisDtlsmdacodigo: TIntegerField;
    adm: tuniquery;
    uqtabelamesinclusao: TDateTimeField;
    ActCancelarFaturamento: TAction;
    mnMarcarcomoReclassificacao: TMenuItem;
    uqtabelameshora: TStringField;
    uqTotaismesrfaturado: TFloatField;
    mnAjustarRegimetributario: TMenuItem;
    pro: tuniquery;
    procstcodigo: TStringField;
    plResumoModalidades: TPanel;
    Panel2: TPanel;
    DBResumoModalidades: TDBGrid;
    uqDtl: tuniquery;
    uqDtlltechave: TIntegerField;
    uqDtlmdaidentificacao: TStringField;
    uqDtldtlvalor: TFloatField;
    uqDtlmdacodigo: TIntegerField;
    uqDtlmeschave: TIntegerField;
    uqtabelaccxchave: TIntegerField;
    pllinha1: TPanel;
    Pltotalvendas: TPanel;
    Pltotaldescontos: TPanel;
    Pltotalliquido: TPanel;
    pllinha2: TPanel;
    PlTotalRefaturado: TPanel;
    Pltotalnfe: TPanel;
    uqtabelamesrefeicao: TIntegerField;
    uqtabelaoriidentificacao: TStringField;
    mce: tuniquery;
    mcemcechave: TIntegerField;
    mcercrchave: TIntegerField;
    mcetmccodigo: TIntegerField;
    mcemcemotivo: TStringField;
    mcemecregistro: TDateTimeField;
    mceltechave: TIntegerField;
    mcr: tuniquery;
    mcrmcrchave: TIntegerField;
    mcrrcrchave: TIntegerField;
    mcrmcrvalor: TCurrencyField;
    mcrmcechave: TIntegerField;
    dtlltechave: TIntegerField;
    mceclbcodigo: TIntegerField;
    uqtabelamesoutras: TCurrencyField;
    orcssai: tuniquery;
    orcssaiorcchave: TIntegerField;
    orcssaiorcdataabert: TDateField;
    orcssaiorchoraabert: TTimeField;
    orcssaiorcdataencerr: TDateField;
    orcssaiorchoraencerr: TTimeField;
    orcssaietdcodigo: TIntegerField;
    orcssaietdidentificacao: TStringField;
    orcssaiorcgeral: TFloatField;
    orcssaiorcdesconto: TFloatField;
    orcssaiorctotal: TFloatField;
    orcssaiclbidentificacao: TStringField;
    orcssaiorcobs: TStringField;
    orcssaiorcnome: TStringField;
    orcssaiorcendereco: TStringField;
    orcssaiorctelefone: TStringField;
    orcssaipuocodigo: TIntegerField;
    orcssaiedrbairro: TStringField;
    orcssaiedrendereco: TStringField;
    orcssaipdghoraentrega: TStringField;
    orcssaiorcdescrpagto: TStringField;
    orcssaipdgnumero: TStringField;
    orcssaietdidentificacaoent: TStringField;
    orcssaiorcretorno: TStringField;
    orcssaitempoemproducao: TStringField;
    orcssaitempoementrega: TStringField;
    orcssaipdsidentificacao: TStringField;
    orcssaiclbcodigoent: TIntegerField;
    orcssaisituacaocaixa: TStringField;
    orcssaipdscodigo: TIntegerField;
    orcssaistocodigo: TIntegerField;
    orcssaitempototal: TTimeField;
    cfgmgoucfgmgouctadelivery: TIntegerField;
    uniResumoDtl: tuniquery;
    plTotalDtl: TPanel;
    PlTotalARefaturar: TPanel;
    dtlmdacodigo: TIntegerField;
    uqtabelamesnumeropedido: TStringField;
    uqtabelaclbidentificacao: TStringField;
    itmitmoutras: TFloatField;
    plEntrega: TPanel;
    uqItmTotaisitmoutras: TCurrencyField;
    PltotalEntrega: TPanel;
    mesrefeicao: TUniQuery;
    mAjustaVendaRefeicao: TMenuItem;
    uqtabelamdacodigo: TIntegerField;
    itmitmfrete: TCurrencyField;
    uqItmTotaisitmfrete: TCurrencyField;
    uqtabelamesfrete: TCurrencyField;
    rfmrfi: TUniQuery;
    dtldtlchave: TIntegerField;
    dtlrdcnrauto: TStringField;
    TotaisResumo: TVirtualTable;
    dtlResumo: TUniQuery;
    TotaisResumomdaidentificacao: TStringField;
    TotaisResumodtlvalor: TFloatField;
    TotaisResumomdacodigo: TIntegerField;
    TotaisResumoltechave: TIntegerField;
    TotaisResumordcnrauto: TStringField;
    TotaisResumodtlchave: TIntegerField;
    PlTotalCancelado: TPanel;
    PltotalDoacao: TPanel;
    procedure ActAlterarExecute(Sender: TObject);
    procedure ActIncluirExecute(Sender: TObject);
    procedure DBGListaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure ActAtualizarExecute(Sender: TObject);
    procedure ActCancelarExecute(Sender: TObject);
    procedure ActExcluirExecute(Sender: TObject);
    procedure listaitmDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure listaobsDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure ActSairExecute(Sender: TObject);
    procedure ActFaturarExecute(Sender: TObject);
    procedure ActGeraCupomFiscalExecute(Sender: TObject);
    procedure ActAjustaOperacaoExecute(Sender: TObject);

    procedure uqItmTotaisAfterOpen(DataSet: TDataSet);
    procedure uqItmTotaisAfterRefresh(DataSet: TDataSet);
    procedure ActAjustarEstagioExecute(Sender: TObject);

    procedure btOcultaExibeDetalheClick(Sender: TObject);
    procedure uqTotaisBeforeOpen(DataSet: TDataSet);
    procedure bConfirmaSelecaoClick(Sender: TObject);
    procedure btLimpaBuscaClick(Sender: TObject);
    procedure btOcultaExibeObservacoesClick(Sender: TObject);
    procedure mAjustarFilialClick(Sender: TObject);
    procedure ActAlterarClienteExecute(Sender: TObject);
    procedure AjustarCFOPdoItens1Click(Sender: TObject);
    procedure btOcultaExibeTotaisClick(Sender: TObject);
    procedure ActFinalizarExecute(Sender: TObject);

    procedure DBResumoModalidadesDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);

    procedure mnMarcarcomoReclassificacaoClick(Sender: TObject);
    procedure mnAjustarRegimetributarioClick(Sender: TObject);
    procedure fmddtfinalKeyPress(Sender: TObject; var Key: Char);
    procedure DSTabelaDataChange(Sender: TObject; Field: TField);
    procedure mAjustaVendaRefeicaoClick(Sender: TObject);
  private
    vntabfilesp: string;
    FSQLBaseTotais: String;
    procedure AtualizarDetalhe;
    procedure AtualizaTotaisItens;
    function CancelarRFI(vMesChave, motivo: string; vMeaCodigo: string): string;
    procedure AjustaAlturaRodaPeGrid;
    procedure InutilizarNumeracao(vMesChave: Integer; vtdfcodigo: String);
    procedure modulonfe(arq: String; Rotina: TRotinasNFe; chave: String);
    function ModuloNFCe(vfuncao, vTrmCodigo, vMesChave, vClbCodigo: string): Boolean;
    function RegistraLote(vctacodigo: string = ''): String;
    procedure CancelarRCR(vMesChave, vMotivo, vlMeaCodigo: STRING);
    procedure CalculaTotaisNovo;
    procedure AtualizarDetalheNovo;

  published
    property SQLBaseTotais: String read FSQLBaseTotais write FSQLBaseTotais;

  public
    { Public declarations }
    vpCtaCodigo: string;
    procedure Carregar; override;
    function RegistroAcessoOperacao(vactcodigo, vMotivo: string; vtabela: string = ''; vregistro: string = ''): Boolean;

  end;

  TliberacaoRFI = function(AOwner: TComponent; conexao: TUniConnection; vusuario: string; vactcodigo: string; vMotivo: string;
    vtdecodigo, vorcchave, vMesChave: String; vltecodigo, vddfcodigo: String; vForcaLogin: Boolean = false; vtabela: string = '';
    vregistro: string = ''): string;

  TCancelar = function(AOwner: TComponent; conexao: TUniConnection; vLteChave: string; vMotivo: string; vusrcodigo: string; vMesChave: string;
    vMeaCodigo: string; vtnccodigo: string): string;

  TValidaProdutos = Function(AOwner: TComponent; conexao: TUniConnection; ChaveMes: string; CodigoFilial: string = '1';
    VerificaNCM: Boolean = True): Boolean;

var
  fravnd: Tfravnd;

  // Início ID do Módulo fravnd
const
  vPlIdMd = '02.04.09.001-01';
  vPlTitMdl = 'Saídas';

  // Fim ID do Módulo fravnd

implementation

{$R *.dfm}

uses ufvndsimples, ufdtmvnd, ufvndfaturamento, ufVndAcm, ufrfivnd, ufimpnfe,
  Winapi.Messages, System.Math;

type
  { expor propriedades e metodso privadas e protegindos do dbgrid }
  TFriendly = class(TCustomDBGrid);

function formuFrame(pCargaFrame: TCargaFrame): string;
begin
  pCargaFrame.IdModulo := vPlIdMd;
  pCargaFrame.Titulo := vPlTitMdl;
  fravnd := Tfravnd.Create(pCargaFrame);
end;

procedure defineacesso(pCargaFrame: TCargaFrame);
begin
  pCargaFrame.Titulo := vPlTitMdl;
  fravnd := Tfravnd.Create(pCargaFrame);
  try
    fravnd.CriaAcoesDeAcesso;
  finally
    fravnd.Free;
  end;
end;

exports formuFrame, defineacesso;

function Tfravnd.RegistroAcessoOperacao(vactcodigo: string; vMotivo: string; vtabela: string = ''; vregistro: string = ''): Boolean;
var
  auto: TliberacaoRFI;
  vRetornoUsr: string;
  vLiberacao: Boolean;
  Pack: Cardinal;
begin

  vLiberacao := True;

  Pack := LoadPackage('modulos\mlia.bpl');
  if Pack <> 0 then
    try
      @auto := GetProcAddress(Pack, PChar('liberacao'));

      if Assigned(auto) then
      begin
        vRetornoUsr := auto(Application, Self.zcone, Acesso.Usuario.ToString, vactcodigo, vMotivo, '', '', '', '', '', True);

        if (vRetornoUsr = '0') or (vRetornoUsr = '') then // retornou NÃO AUTORIZADO
          vLiberacao := false;
      end;
    finally
      DoUnLoadPackage(Application, Pack);
    end;

  Result := vLiberacao;
end;

procedure Tfravnd.AjustaAlturaRodaPeGrid;
begin
  PnlRodapeGrid.Height := PCDetalhes.Height + plTituloItensObservacoes.Height + plDetalhes.Height;
end;

procedure Tfravnd.AjustarCFOPdoItens1Click(Sender: TObject);
begin
  inherited;
  uqtabela.First;
  while not uqtabela.eof do
  begin

    consulta.Close;
    consulta.SQL.Text := 'update itm set cfocfop=' + QuotedStr(uqtabelatoecfopsaida.AsString) + ', toecodigo=' + uqtabelatoecodigo.AsString +
      ' where meschave=' + uqtabelameschave.AsString;
    consulta.ExecSQL;
    uqtabela.Next;
  end;

end;

procedure Tfravnd.uqItmTotaisAfterOpen(DataSet: TDataSet);
begin
  AtualizaTotaisItens;
end;

procedure Tfravnd.uqItmTotaisAfterRefresh(DataSet: TDataSet);
begin
  AtualizaTotaisItens;
end;

procedure Tfravnd.uqTotaisBeforeOpen(DataSet: TDataSet);
begin
  inherited;
  uqTotais.FilterSQL := uqtabela.FilterSQL;
end;

function Tfravnd.CancelarRFI(vMesChave: string; motivo: string; vMeaCodigo: string): string;
var
  registra: TCancelar;
  Pack: Cardinal;
  vlRetorno: string;
begin
  Pack := LoadPackage('modulos\merf.bpl');
  if Pack <> 0 then
    try
      @registra := GetProcAddress(Pack, PChar('Cancelar'));

      if Assigned(registra) then
        Result := registra(Application, zcone, '', motivo, Acesso.Usuario.ToString, vMesChave, vMeaCodigo, '1');
      if Result = '' then
      begin
        vlRetorno := '0';
      end
      else
      begin
        vlRetorno := Result;
      end;

    finally
      // DoUnLoadPackage(pack);
    end;
end;

procedure Tfravnd.Carregar;
begin

  consulta.Close;
  consulta.Connection := Self.zcone;
  consulta.SQL.Text := 'SELECT cfgdefinetoeatendimento, cfgidentificatecnico, cfgidentificavendedor FROM cfgmsai;';
  consulta.Open;

  if consulta.Fields[0].AsInteger = 1 then
    ActAjustaOperacao.Visible := True;

  inherited Carregar;

  CarregarColunas(listaobs);
  CarregarColunas(listaitm);

  btOcultaExibeObservacoes.Click;
  AjustaAlturaRodaPeGrid;

end;

procedure Tfravnd.ActAjustaOperacaoExecute(Sender: TObject);
var
  ExecForm: function(AOwner: TComponent; conexao: TUniConnection; pAcesso: TAcesso; pMesChave: Integer): string;
  vlPack: NativeUInt;
Begin
  vlPack := LoadPackage('modulos\mdov.bpl');
  If vlPack <> 0 Then
    try
      @ExecForm := GetProcAddress(vlPack, PChar('formu'));

      if Assigned(ExecForm) then
        ExecForm(Application, zcone, Acesso, uqtabelameschave.AsInteger);
    finally
      DoUnLoadPackage(Application, vlPack);
    end;
End;

procedure Tfravnd.ActAlterarClienteExecute(Sender: TObject);
var
  vlEtdCodigo: string;
  vlEndereco: string;
  vlRetorno: String;
  vlTxtFiltro: string;
  vlEdrItem: String;

begin
  inherited;

  If (Self.uqtabelamesprotocolo.AsString <> '') Then
  begin
    ShowMessage('ATENÇÃO: Este registro é de uma NFE, não pode ser alterado!');
    exit;
  end;

  vlEtdCodigo := MostraLista('mcli', '', '');

  consulta.Close;
  consulta.SQL.Text := 'SELECT edr.edrcodigo FROM edr WHERE edr.tedcodigo IN (1, 3, 4) AND edr.etdcodigo = ' + vlEtdCodigo;
  consulta.Open;

  if not consulta.Locate('edrcodigo', vlEndereco, []) then
  begin
    vlEndereco := consulta.Fields[0].AsString;

    if consulta.RecordCount > 1 then
    begin
      vlTxtFiltro := 'etdcodigo = ' + vlEtdCodigo;
      vlRetorno := MostraLista('medr', vlTxtFiltro, vlEtdCodigo);

      if vlRetorno <> '' then
        vlEndereco := vlRetorno;
    end;
  end;

  If Application.MessageBox(PChar('Confirma a mofificação desta venda para o cliente Selecionado?'), PChar('Mofidicação de Cliente'),
    MB_TASKMODAL + MB_ICONQUESTION + MB_YESNO + MB_DEFBUTTON2) = idYes Then
  Begin

    consulta.Close;
    consulta.SQL.Text := 'select edritem from edr where etdcodigo=' + vlEtdCodigo + ' and edrcodigo=' + vlEndereco;
    consulta.Open;

    vlEdrItem := consulta.FieldByName('edritem').AsString;

    consulta.Close;
    consulta.SQL.Text := 'update mes set edritem=' + vlEdrItem + ', etdcodigo=' + vlEtdCodigo + ' where meschave=' + uqtabelameschave.AsString;
    consulta.ExecSQL;

  End;

end;

procedure Tfravnd.ActAjustarEstagioExecute(Sender: TObject);
begin
  inherited;
  if uqtabelatdfcodigo.AsString = 'RF' then
  begin
    Application.MessageBox(PChar('Alteração não permitida para registros de Reclassificação de Mercadoria.'), 'Atenção', MB_ICONWARNING + MB_OK);
    exit;
  end;

  if ((Self.uqtabelatdfcodigo.AsString = 'AF') or (Self.uqtabelatdfcodigo.AsString = 'RF') or (Self.uqtabelatdfcodigo.AsString = '00')) and
    ((Self.uqtabelatemcodigo.AsString = '3') or (Self.uqtabelatemcodigo.AsString = '2') or (Self.uqtabelatemcodigo.AsString = '1')) then
  begin
    If (Self.uqtabelamesprotocolo.AsString <> '') Then
      ShowMessage('ATENÇÃO: Este registro é de uma NFE, não pode ser alterado!')
    Else
    Begin
      If (Self.uqtabelatemcodigo.AsInteger IN [4, 5]) Then
        ShowMessage('ATENÇÃO: Este registro é de uma NFE, não pode ser alterado!')
      Else if Self.uqtabelaetdcodigo.AsInteger = 0 then
      begin
        ShowMessage('Atenção: Não pode ser alterados lançamentos feitos para cliente Consumidor!');
        exit;
      end;

      If Application.MessageBox(PChar('Confirma a modificação desta venda para A FATURAR?'), PChar('Mofidicação de Estágio'),
        MB_TASKMODAL + MB_ICONQUESTION + MB_YESNO + MB_DEFBUTTON2) = idYes Then
      Begin


        rfmrfi.Close;
        rfmrfi.SQL.Text := 'select rfichave from rfm where meschave=' + uqtabelameschave.AsString;
        rfmrfi.Open;

        while not rfmrfi.Eof do
        begin


         { consulta.Close;
          consulta.SQL.Text := 'delete from rfm where rfichave in ('+
                               'select rfichave from rfi where tfdcodigo=2 and rfichave=' +
                                rfmrfi.FieldByName('rfichave').AsString +')' ;
          consulta.ExecSQL; }


          consulta.Close;
          consulta.SQL.Text := 'delete from mfi where tmfcodigo=21 and  rfichave in ('+
                               'select rfichave from rfi where tfdcodigo=2 and rfichave=' +
                                rfmrfi.FieldByName('rfichave').AsString +')' ;
          consulta.ExecSQL;


          consulta.Close;
          consulta.SQL.Text := 'delete from tit where titcodigo in ('+
                               'select titcodigo from rfi where tfdcodigo=2 and rfichave=' +
                                rfmrfi.FieldByName('rfichave').AsString +')' ;
          consulta.ExecSQL;


          consulta.Close;
          consulta.SQL.Text := 'delete from rfi where tfdcodigo=2 and rfichave=' +  rfmrfi.FieldByName('rfichave').AsString;
          consulta.ExecSQL;



          rfmrfi.Next;
        end;

        dtl.First;
        while not dtl.Eof do
        begin

          consulta.Close;
          consulta.SQL.Text := 'update dtl set mdacodigo=9 where dtlchave=' +dtldtlchave.AsString;
          consulta.ExecSQL;

          dtl.Next;
        end;


        consulta.Close;
        consulta.SQL.Text := 'update mes set tdfcodigo=' + QuotedStr('AF') + ' where meschave=' + uqtabelameschave.AsString;
        consulta.ExecSQL;

      End;


    End;
  end
  else
    ShowMessage('Atenção: ' + #13 + #13 +
      'Só podem ser alterados lançamentos do tipo "Movimento em Andamento" e esteja no estágio "Digitação Manual"!' + #13 + 'Situação: ' +
      Self.uqtabelatemcodigo.AsString + #13 + 'Estágio : ' + Self.uqtabelatdfcodigo.AsString);

end;

procedure Tfravnd.ActAlterarExecute(Sender: TObject);
begin

  if (uqtabelatdfcodigo.AsString = tdfMovimentoAFaturar) or (uqtabelatdfcodigo.AsString = tdfRefaturado) then
  begin
    Application.MessageBox(PChar('Alteração não permitida para registros de ' + uqtabelatdfidentificacao.AsString + ' de Mercadoria.'), 'Atenção',
      MB_ICONWARNING + MB_OK);
    exit;
  end;

  if uqtabelattocodigo.AsInteger = ttoReclassificacao then
  begin
    Application.MessageBox(PChar('Alteração não permitida para registros de Reclassificação de Mercadoria.'), 'Atenção', MB_ICONWARNING + MB_OK);
    exit;
  end;

  If (Self.uqtabelamesprotocolo.AsString <> '') Then
  begin
    ShowMessage('ATENÇÃO: Este registro é de uma NFE, não pode ser alterado!');
  end
  Else If (Self.uqtabelasdecodigo.AsString = '02') Then
  begin
    ShowMessage('ATENÇÃO: Este registro esta cancelado, não pode ser alterado!')
  end
  else
  Begin

    If (Self.uqtabelatemcodigo.AsInteger IN [4, 5]) Then
      ShowMessage('ATENÇÃO: Este registro é de uma NFE, não pode ser alterado!')
    Else if Self.uqtabelaetdcodigo.AsInteger = 0 then
    begin
      ShowMessage('Atenção: Não pode ser alterados lançamentos feitos para cliente Consumidor!');
      exit;
    end;

    CriaFormulario(tfvndsimples, Self.uqtabelameschave.AsString, '');
  End;

end;

procedure Tfravnd.ActAtualizarExecute(Sender: TObject);
var
  vQuery, vSQLFiltroEsp, vLinhaSQL: string;
  i: Integer;
  vRegAtual: String;

  vfiltro: string;
  ztab: TComponent;

  vFieldFiltroEsp: string;
  vFieldFiltroEsp2: string;

  vlregiatu: Integer;
  sw: TStopwatch;

  vldatainicial: string;
  vldatafinal: string;
begin

  try
    SendMessage(Self.Handle, WM_SETREDRAW, Integer(false), 0);

    sw := TStopwatch.Create;

    // edbusca.Text := '';
    try
      sw.Start;
      vlregiatu := uqtabela.RecNo;

      Self.uqtabela.DisableControls;

      consulta.Close;
      consulta.SQL.Text := 'SELECT CURDATE()';
      consulta.Open;

      Self.vdataatual := consulta.Fields[0].AsFloat;

      for i := 0 to Self.ComponentCount - 1 do
      begin
        if Self.Components[i] is tuniquery then
          (Self.Components[i] as tuniquery).Connection := Self.zcone;

        if Self.Components[i] is TDBGrid then
          (Self.Components[i] as TDBGrid).ReadOnly := True;
      end;

      vRegAtual := '0';

      if uqtabela.Active = false then
      begin
        if Self.clsclsultimo.AsString <> '' then
          try
            vRegAtual := Self.clsclsultimo.AsString;
          except
          end;
      end
      else
        vRegAtual := Self.uqtabela.Fields[0].AsString;

      Self.uqtabela.Close;

      fil.Close;
      fil.SQL.Clear;
      fil.SQL.Text := 'SELECT filcodigo, clscodigo, clbcodigo, filsqloriginal FROM fil WHERE ';
      fil.SQL.Add('clscodigo = ' + Self.clsclscodigo.AsString + ' AND ');
      fil.SQL.Add('clbcodigo = ' + Self.Acesso.Usuario.ToString);
      fil.Open;

      if (not fil.IsEmpty) and (RemoverFiltro) then
        fil.Delete;

      RemoverFiltro := false;

      vfiltro := MontaFiltro;
      if vfiltro <> '' then
        PlSelecao.Visible := True
      else
        PlSelecao.Visible := false;

      if pos('order', lowercase(Self.SQLOriginal)) > 0 then
        Self.uqtabela.SQL.Text := Self.SQLOriginal + ' and ' + vfiltro;

      if vfiltro <> '' then
      begin
        if pos('where', lowercase(Self.SQLOriginal)) = 0 then
          Self.uqtabela.SQL.Text := Self.SQLOriginal + ' where ' + vfiltro
        else
          Self.uqtabela.SQL.Text := Self.SQLOriginal + ' and ' + vfiltro;
      end
      else if Self.SQLOriginal <> '' then
        Self.uqtabela.SQL.Text := Self.SQLOriginal;

      if Self.vChaveMestre <> '' then
        if Self.uqtabela.Params.Count = 1 then
          Self.uqtabela.Params[0].AsString := Self.vChaveMestre;

      ztab := Self.FindComponent(vntabfilesp);

      if ztab <> nil then
        vFieldFiltroEsp := (ztab as tuniquery).Name + '.' + (ztab as tuniquery).Fields[0].FieldName
      else
        vFieldFiltroEsp := '';

      if vFieldFiltroEsp <> '' then
      begin
        for i := 0 to Self.uqtabela.SQL.Count - 1 do
        begin
          vLinhaSQL := Self.uqtabela.SQL[i];

          if pos(vFieldFiltroEsp + '=', vLinhaSQL) = 0 then
            vQuery := vQuery + vLinhaSQL + ' ' + #13;
        end;
      end
      else
      begin
        for i := 0 to Self.uqtabela.SQL.Count - 1 do
        begin
          vLinhaSQL := Self.uqtabela.SQL[i];
          vQuery := vQuery + vLinhaSQL + ' ' + #13;
        end;
      end;

      if vQuery = '' then
        vQuery := Self.uqtabela.SQL.Text;

      vSQLFiltroEsp := '';

      if ztab <> nil then
      begin
        if pos('_', vQuery) > 0 then
        begin
          vSQLFiltroEsp := AplicaFiltroEspecial(vQuery, ztab as tuniquery);
        end
        else
        begin
          vSQLFiltroEsp := AplicaFiltroEspecial(ztab as tuniquery);
        end;

      end;

      if (vSQLFiltroEsp <> '') then
        if (pos('where', lowercase(vQuery)) > 0) then
          vSQLFiltroEsp := ' and ' + vSQLFiltroEsp
        else
          vSQLFiltroEsp := ' WHERE ' + vSQLFiltroEsp;

      if (Self.FTxtFiltrosql <> '') then
      begin
        if Self.fil.RecordCount = 0 then
        begin
          Self.fil.Append;
          Self.filclscodigo.AsInteger := Self.clsclscodigo.AsInteger;
          Self.filclbcodigo.AsInteger := Acesso.Usuario;
        end
        else
        begin
          Self.fil.Edit;
        end;

        // Self.filfilsqloriginal.AsString := Self.uqtabela.SQL.Text;
        Self.fil.Post;

        if pos('where', lowercase(vQuery + vSQLFiltroEsp)) > 0 then
          vSQLFiltroEsp := ' ' + vSQLFiltroEsp + ' and ' + Self.FTxtFiltrosql
        else
          vSQLFiltroEsp := ' where ' + Self.FTxtFiltrosql;
      end
      else
      begin
        if (pos('where', lowercase(vQuery + vSQLFiltroEsp)) = 0) and (vSQLFiltroEsp <> '') then
          vSQLFiltroEsp := ' where ' + vSQLFiltroEsp;

      end;

      if Length(vQuery + vSQLFiltroEsp) > 0 then
        Self.uqtabela.SQL.Text := vQuery + vSQLFiltroEsp;

      try
        if Self.uqtabela.Params.FindParam('flacodigo') <> nil then
          Self.uqtabela.ParamByName('flacodigo').AsInteger := Acesso.Filial;

        MontaFiltroEsp2;

        if (PlBotaoFiltroEsp2.Visible) and (PlBotaoFiltroEsp2.Hint = '') then
        begin

          try
            if not fmd.IsEmpty then
            begin

              vldatainicial := ajustadata(copy(fmddtinicial.Field.AsString, 1, 10)) + ' ' + trim(copy(fmddtinicial.Field.AsString, 11, 10));

              vldatafinal := ajustadata(copy(fmddtfinal.Field.AsString, 1, 10)) + ' ' + trim(copy(fmddtfinal.Field.AsString, 11, 10));

              Self.uqtabela.FilterSQL := copy(fmdfmdcampo.AsString, 1, 3) + '.' +  fmdfmdcampo.asstring + ' BETWEEN (' + QuotedStr(vldatainicial) + ') and (' +
                QuotedStr(vldatafinal) + ')';

              AtualizaFiltroUQTabela;
              Self.uqtabela.Open;

            end;
          except
            Self.uqtabela.FilterSQL :=  fmdfmdcampo.asstring + ' BETWEEN (' + QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtinicial.AsFloat)) + ') and (' +
              QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtfinal.AsFloat)) + ')';
            AtualizaFiltroUQTabela;
            Self.uqtabela.Open;
          end;

        end
        else
        begin
          AtualizaFiltroUQTabela;
          Self.uqtabela.Open;
        end;
      except
        if fil.Active then
        begin
          if not fil.IsEmpty then
            fil.Delete;

          ActVerFiltros.Execute;
        end;

        Self.uqtabela.SQL.Text := SQLOriginal + vSQLFiltroEsp;

        if Self.uqtabela.Params.FindParam('flacodigo') <> nil then
        begin
          Self.uqtabela.ParamByName('flacodigo').AsInteger := Acesso.Filial;
        end;

        Self.uqtabela.Open;
      end;

      PlQtdRecno.caption := 'Registros: ' + IntToStr(Self.uqtabela.RecordCount);

      if ifi.Active then
      begin
        if ifi.RecordCount = 0 then
        begin
          if SplBotoes.FindComponent('bactverfiltros') <> nil then
            (SplBotoes.FindComponent('bactverfiltros') as TBitBtn).Visible := false;
        end
        else if SplBotoes.FindComponent('bactverfiltros') <> nil then
          (SplBotoes.FindComponent('bactverfiltros') as TBitBtn).Visible := True;
      end
      else if SplBotoes.FindComponent('bactverfiltros') <> nil then
        (SplBotoes.FindComponent('bactverfiltros') as TBitBtn).Visible := false;

      if Self.uqtabela.Locate(Self.uqtabela.Fields[0].FieldName, vRegAtual, []) = false then
      begin
        try
          uqtabela.RecNo := vlregiatu - 1;
        except
          Self.uqtabela.First;
        end;
      end;
    finally
      Self.uqtabela.EnableControls;
      sw.Stop;

      PlQtdRecno.Hint := Format('Tempo Execução: %d ms', [sw.ElapsedMilliseconds]);
    end;

  finally

    SendMessage(Self.Handle, WM_SETREDRAW, Integer(True), 0);
    // Update client area
    RedrawWindow(Self.Handle, nil, 0, RDW_INVALIDATE or RDW_UPDATENOW or RDW_ALLCHILDREN);

  end;

  // Inherited;
  CalculaTotaisNovo;

  { AtualizarDetalhe; }

  if (not uqtabela.Executing) and (not uqtabela.Fetching) then
  begin

    AtualizarDetalhe;

    if not ccm.Active then
      ccm.Open;

    if not erf.Active then
      erf.Open;

  end;

end;

PROCEDURE Tfravnd.CancelarRCR(vMesChave, vMotivo, vlMeaCodigo: STRING);
var
  vlrcrchave: string;
begin
  //

  dtl.First;
  while not dtl.eof do
  begin
    if lowercase(dtlmdaidentificacao.AsString) = 'crédito' then
    begin
      consulta.Close;
      consulta.SQL.Text := 'select rcrchave from mce where mcemotivo like ' + QuotedStr('%' + vMesChave + '%') + ' order by mcechave desc limit 1';
      consulta.Open;
      if not consulta.IsEmpty then
      begin
        vlrcrchave := consulta.FieldByName('rcrchave').AsString;

        if vlrcrchave <> '' then
        begin

          mce.Close;
          mce.Open;
          mce.Append;
          mcercrchave.AsString := vlrcrchave;
          mceclbcodigo.AsInteger := Acesso.Usuario;
          mcetmccodigo.AsInteger := 3;
          mcemcemotivo.AsString := vMotivo;
          mcemecregistro.AsString := agora(Application, zcone);
          mceltechave.AsInteger := dtlltechave.AsInteger;
          mce.Post;

          mcr.Close;
          mcr.Open;
          mcr.Append;

          mcrrcrchave.AsString := vlrcrchave;
          mcrmcrvalor.AsCurrency := dtldtlvalor.AsCurrency;
          mcrmcechave.AsInteger := mcemcechave.AsInteger;

          mcr.Post;

        end;

      end;

    end;

    dtl.Next;
  end;
end;

procedure Tfravnd.ActCancelarExecute(Sender: TObject);
var
  vMotivo: string;
  vlMeaCodigo: string;
  vlAcao: string;

begin
  { inherited; }

  edbusca.Text := '';

  if uqtabelatemcodigo.AsInteger = temNFEContingencia then
  begin
    Application.MessageBox(PChar('Esta NFC-e esta EM CONTIGÊNCIA, precisa ser autorizada, para depois cancelar.'), 'ATENÇÃO', MB_OK + MB_ICONWARNING);
    Exit;
  end;



  if uqtabelasdecodigo.AsString = '02' then
  begin
    ShowMessage('ATENÇÃO: Este lançamento já esta cancelado!');
    exit;
  end;

  if (uqtabelatdfcodigo.AsString <> '00') and (uqtabelatdfcodigo.AsString <> 'AF') and (uqtabelatemcodigo.AsInteger <> 4) then
  begin
    ShowMessage('ATENÇÃO: Somente registro do tipo "Movimento em Andamento" pode ser cancelado!');
    exit;
  end;
  if (uqtabelatdfcodigo.AsString = '55') OR (uqtabelatdfcodigo.AsString = '65') then
  begin
    ShowMessage('ATENÇÃO: Este registro é uma NFE ou NFCe, deve ser cancelado na tela de NFE ou NFCe!');

    exit;
  end;

  If Self.uqtabelamesprotocolo.AsString <> '' Then
  begin
    ShowMessage('ATENÇÃO: Este registro é uma NFE, não pode ser cancelado!');
    exit;
  end;
  vlAcao := IntToStr((Sender as TAction).Tag);
  if RegistroAcessoOperacao(vlAcao, 'Registro') then
  begin

    if Autorizado(Sender) then
      If Application.MessageBox(PChar('Confirma o CANCELAMENTO da Venda selecionada?'), PChar('Cancelamento'),
        MB_TASKMODAL + MB_ICONQUESTION + MB_YESNO + MB_DEFBUTTON2) = idYes Then
      Begin
        try

          vlMeaCodigo := MostraLista('mmea', '');

          Repeat
            vMotivo := InputBox('Cancelamento TOTAL !', 'Descreva o complemento do motivo para o Cancelamento: ', '');
          Until vMotivo <> '';

          consulta.Close;
          consulta.SQL.Text := 'UPDATE mes SET sdecodigo = ''02'' WHERE meschave = ' + Self.uqtabelameschave.AsString;
          consulta.ExecSQL;

          consulta.Close;
          consulta.SQL.Text := 'INSERT INTO hcm (meschave, sdecodigo, clbcodigo, hcmdata, hcmhora, hcmdescricao) VALUES ( ';
          consulta.SQL.Add(Self.uqtabelameschave.AsString + ', ');
          consulta.SQL.Add('''02'', ');
          consulta.SQL.Add(Acesso.Usuario.ToString + ', ');
          consulta.SQL.Add(QuotedStr(ajustadata(DateToStr(date))) + ', ');
          consulta.SQL.Add(QuotedStr(Timetostr(time)) + ', ');
          consulta.SQL.Add(QuotedStr(vMotivo) + ')');
          consulta.ExecSQL;

          consulta.Close;
          consulta.SQL.Text := 'update orc,mor set orc.stocodigo=' + stoCancelado.ToString + ' where mor.orcchave=orc.orcchave and mor.meschave=' +
            Self.uqtabelameschave.AsString;
          consulta.ExecSQL;

          CancelarRFI(Self.uqtabelameschave.AsString, vMotivo, vlMeaCodigo);

          CancelarRCR(Self.uqtabelameschave.AsString, vMotivo, vlMeaCodigo);

          if (uqtabelatdfcodigo.AsString = '55') or (uqtabelatdfcodigo.AsString = '65') then
          begin
            InutilizarNumeracao(uqtabelameschave.AsInteger, uqtabelatdfcodigo.AsString);
          end;

          ShowMessage('Cancelamento realizado com sucesso!');

        except
          ShowMessage('Falha de Cancelamento!');
        end;

        Self.ActAtualizar.Execute;
      End;

  end;
end;

procedure Tfravnd.InutilizarNumeracao(vMesChave: Integer; vtdfcodigo: String);
var
  arq: string;
Begin
  if vtdfcodigo = '55' then
    modulonfe(arq, rnfInutilizarDireto, vMesChave.ToString);

  if vtdfcodigo = '65' then
    ModuloNFCe('InutilizarNumerosNFCEDireto', Acesso.Terminal.ToString, vMesChave.ToString, Acesso.Usuario.ToString);

end;

function Tfravnd.ModuloNFCe(vfuncao: string; vTrmCodigo: string; vMesChave: string; vClbCodigo: string): Boolean;
type
  Tmodulonfce = function(AOwner: TComponent; conexao: TUniConnection; vMesChave: string; vfuncao: string; Acesso: TAcesso; vImprimir: Boolean;
    vConsultouSefaz: Boolean; vemail: string): Boolean;
var
  ModuloNFCe: Tmodulonfce;
  vlRetorno: Boolean;
  vlPackNFCe: Cardinal;
begin
  Result := false;
  vlPackNFCe := 0;
  vlPackNFCe := LoadPackage('modulos\mnfegourmet.bpl');
  if vlPackNFCe <> 0 then
    @ModuloNFCe := GetProcAddress(vlPackNFCe, PChar('modulonfce'));

  if Assigned(ModuloNFCe) then
  begin
    vlRetorno := ModuloNFCe(Application, Self.zcone, vMesChave, vfuncao, Acesso, false, false, '');
    Result := vlRetorno;

  end;
  DoUnLoadPackage(Application, vlPackNFCe);
End;

Procedure Tfravnd.modulonfe(arq: String; Rotina: TRotinasNFe; chave: String);
type
  TModuloNFe = function(AOwner: TComponent; conexao: TUniConnection; varq: string; Vchave: string; vRotinaNFe: TRotinasNFe; Acesso: TAcesso;
    vConsultouSefaz: Boolean): Boolean;
var
  modnfe: TModuloNFe;

  ch: string;
  vu: string;
  vpack: Cardinal;
begin
  vpack := LoadPackage('modulos\mnfegourmet.bpl');
  if vpack <> 0 then
    try
      @modnfe := GetProcAddress(vpack, PChar('ModuloNFe'));
      if Assigned(modnfe) then
      begin
        modnfe(Application, Self.zcone, arq, chave, Rotina, Acesso, false);
      end;
    finally
      // DoUnLoadPackage(vpack);
    end;
End;

procedure Tfravnd.ActExcluirExecute(Sender: TObject);
begin
  inherited;
  If Self.uqtabelamesprotocolo.AsString <> '' Then
    ShowMessage('ATENÇÃO: Este registro é de uma NFE, não pode ser Excluído!')
  Else
    Inherited;
end;

procedure Tfravnd.ActFaturarExecute(Sender: TObject);
begin
  inherited;
  CriaFormulario(tfvndfaturamento, '', '');
end;

procedure Tfravnd.ActFinalizarExecute(Sender: TObject);
var
  vRetLote: String;
  vlMdacodigo: string;
  vlTfpCodigo: Integer;
  vlEtdCodigo: string;
  vlChave: string;
  vlCtacodigo: string;
  vltitcodigo: TstringList;
  vlltechave: TstringList;
  i:Integer;
begin
  inherited;

  if dtl.RecordCount > 0 then
  begin

    vlEtdCodigo := uqtabelaetdcodigo.AsString;
    vlChave := uqtabelameschave.AsString;

    consulta.Close;
    consulta.SQL.Text := 'select ctacodigo from lte where ltechave=' + dtlltechave.AsString;
    consulta.Open;

    vlCtacodigo := consulta.FieldByName('ctacodigo').AsString;

    dtl.First;

    vlMdacodigo := '';
    while not dtl.eof do
    begin
      if dtlmdacodigo.AsInteger = mdaConvenio then
      begin
        vlMdacodigo := mdaConvenio.ToString;
        break
      end;

      dtl.Next;
    end;

  end
  else
  begin
    vlCtacodigo := '0';
  end;

  vltitcodigo:=TstringList.Create;
  vlltechave :=TstringList.Create;

  if vlMdacodigo <> '' then
  begin

    (* Identifica se houve parte de pagamento a prazo *)
    consulta.Close;
    consulta.SQL.Text := 'SELECT rfm.meschave, dtl.mdacodigo, rfi.titcodigo, dtl.ltechave,dtl.dtlchave   FROM rfm, mfi, mlt, dtl, rfi ';
    consulta.SQL.Add('WHERE mfi.rfichave = rfm.rfichave ');
    consulta.SQL.Add('AND rfm.rfichave = rfi.rfichave ');
    consulta.SQL.Add('AND mfi.mfichave = mlt.mfichave ');
    consulta.SQL.Add('AND mlt.ltechave = dtl.ltechave ');
    consulta.SQL.Add('AND dtl.mdacodigo in (1,7) ');
    consulta.SQL.Add('AND rfm.meschave = ' + Self.uqtabelameschave.AsString);
    consulta.Open;
    while not consulta.IsEmpty  do
    begin
      vltitcodigo.add(consulta.FieldByName('titcodigo').AsString);
      vlltechave.add(consulta.FieldByName('ltechave').AsString);
      consulta.Next;
    end;

  end;

  ShowMessage('Titulo: '+vltitcodigo.Text);
  ShowMessage('Lote: '+vltitcodigo.text);

  vRetLote := RegistraLote(vlCtacodigo);

  if vRetLote <> '' then
  begin

    (* Identifica se houve parte de pagamento a prazo *)
    consulta.Close;
    consulta.SQL.Text := 'SELECT rfm.meschave, dtl.mdacodigo  FROM rfm, mfi, mlt, dtl ';
    consulta.SQL.Add('WHERE mfi.rfichave = rfm.rfichave ');
    consulta.SQL.Add('AND mfi.mfichave = mlt.mfichave ');
    consulta.SQL.Add('AND mlt.ltechave = dtl.ltechave ');
    consulta.SQL.Add('AND dtl.mdacodigo in (1,7) ');
    consulta.SQL.Add('AND rfm.meschave = ' + Self.uqtabelameschave.AsString);
    consulta.Open;

    vlMdacodigo := consulta.Fields[1].AsString;

    if vlMdacodigo = '1' then
      vlTfpCodigo := tfpAVista
    else
      vlTfpCodigo := tfpAPrazo;

    consulta.Close;

    consulta.SQL.Text := 'UPDATE mes SET tdfcodigo=' + QuotedStr(tdfMovimentoEmAndamento) + ', tfpcodigo=' + IntToStr(vlTfpCodigo) +
      ' WHERE meschave=' + Self.uqtabelameschave.AsString;
    consulta.ExecSQL;
  end;

  for I := 0 to vlltechave.Count-1 do
  begin
    consulta.Close;
    consulta.SQL.Text := 'delete from dtl where ltechave=' + vlltechave[i];
    consulta.ExecSQL;

    consulta.Close;
    consulta.SQL.Text := 'delete from lte where ltechave=' + vlltechave[i];
    consulta.ExecSQL;

  end;

  for I := 0 to  vltitcodigo.count -1 do
  begin
    consulta.Close;
    consulta.SQL.Text := 'delete from tit where titcodigo=' + vltitcodigo[i];
    consulta.ExecSQL;

    consulta.Close;
    consulta.SQL.Text := 'delete from rfi where titcodigo=' + vltitcodigo[i];
    consulta.ExecSQL;

  end;

  Self.ActAtualizar.Execute;
end;

function Tfravnd.RegistraLote(vctacodigo: string = ''): String;
type
  TRegistraLote = function(AOwner: TComponent; conexao: TUniConnection; Vchave: string; vTrmCodigo: string; principal: string; multa: string;
    juros: string; desconto: string; Acesso: TAcesso; vmodo: string; vPodeConvenio: Boolean = True; vTeclaFinalizador: Integer = 0;
    vValorFinalizador: Double = 0; vPodeCartoes: Boolean = True; pCtaCaixa: Integer = 0; vPodeTrocaDoacao: Boolean = True;
    vControleEntrega: Boolean = false): string;
var
  RegistraLote: TRegistraLote;
  vTotalBruto: String;
  vDesconto: String;
  vlvlrFinalizador: Double;
  vlCodFinalizador: Integer;
begin
  vlvlrFinalizador := 0;
  vlCodFinalizador := 0;
  Pack := LoadPackage('modulos\mlte.bpl');
  If Pack <> 0 Then
    Try
      @RegistraLote := GetProcAddress(Pack, PChar('registralote'));
      If Assigned(RegistraLote) Then
      begin
        vTotalBruto := Floattostr(uqtabelamestotal.AsFloat + uqtabelamesdesconto.AsFloat);
        vDesconto := Floattostr(uqtabelamesdesconto.AsFloat);
        Result := RegistraLote(Application, zcone, Vchave, '1', vTotalBruto, '0', '0', vDesconto, Acesso, IntToStr(tfdVenda), True, vlCodFinalizador,
          vlvlrFinalizador, True, vctacodigo.ToInteger);
      end;
    Finally

    End;
end;

procedure Tfravnd.ActGeraCupomFiscalExecute(Sender: TObject);
var
  ValidaProdutos: TValidaProdutos;
  vPodeProdutos: Boolean;
begin
  inherited;

  uqtabela.Refresh;

  if (uqtabelatdfcodigo.AsString = '2D') and (uqtabelatemcodigo.AsInteger = 9) then
  begin
    Application.MessageBox(PChar('Este registro já é um Cupom Fiscal!'), 'Atenção', MB_OK + MB_ICONWARNING);
    exit;
  end;

  if not(uqtabelatdfcodigo.AsString = '00') then
  begin
    Application.MessageBox(PChar('Cupom Fiscal não pode ser gerado!' + #13 + #13 +
      'Somente registros do tipo "Movimento em Andamento" podem ser transformados em Cupom Fiscal.'), 'Atenção', MB_OK + MB_ICONINFORMATION);
    exit;
  end;

  Pack := LoadPackage('modulos\mvpr.bpl');
  If Pack <> 0 Then
    Try
      @ValidaProdutos := GetProcAddress(Pack, PChar('ValidaProdutos'));

      If Assigned(ValidaProdutos) Then
        vPodeProdutos := ValidaProdutos(Application, zcone, uqtabelameschave.AsString);

    Finally
      DoUnLoadPackage(Application, Pack);
    End;

  case vPodeProdutos of
    True:
      begin
        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET tdfcodigo = ''2D'', temcodigo = 8 WHERE meschave = ' + uqtabelameschave.AsString;
        consulta.ExecSQL;

        Sleep(500);

        Application.MessageBox(PChar('Registro enviado para o Impressor Fiscal!' + #13 + #13 + 'Aguarde impressão e atualize a tela.'),
          'Geração de Cupom Fiscal', MB_OK + MB_ICONWARNING);
      end;
  end;

  Sleep(500);
  ActAtualizar.Execute;
end;

procedure Tfravnd.ActIncluirExecute(Sender: TObject);
begin
  inherited;
  CriaFormulario(tfvndsimples, '', '');
end;

procedure Tfravnd.ActSairExecute(Sender: TObject);
begin
  SalvarColunas(listaobs);
  SalvarColunas(listaitm);

  inherited;
end;

procedure Tfravnd.DBGListaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
Var
  bitmap: TBitmap;
  fixRect: TRect;
  bmpWidth: Integer;
  imgIndex: Integer;
Begin
  { inherited; }

  fixRect := Rect;

  If Odd(DSTabela.DataSet.RecNo) Then
    DBGLista.Canvas.Brush.Color := PEG_COR_BASE
  Else
    DBGLista.Canvas.Brush.Color := CLWHITE;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      Brush.Color := PEG_COR_SELCGRID;
      FillRect(fixRect);
      font.Style := [fsbold];
      // Font.Color := CLWHITE;
    End;

  If (Self.uqtabelasdecodigo.AsString = '02') Or (Self.uqtabelasdecodigo.AsString = '03') Or (Self.uqtabelasdecodigo.AsString = '04') Then
    DBGLista.Canvas.font.Color := clRed;

  If (Self.uqtabelamestipocomissao.AsString = '1') then
    DBGLista.Canvas.font.Style := []
  else
    DBGLista.Canvas.font.Style := [fsItalic];

  with TFriendly(DBGLista) do
    if TDataLink(DataLink).ActiveRecord = Row - 1 then
      with Canvas do
      begin
        Brush.Color := PEG_COR_SELCGRID;
        DefaultDrawColumnCell(fixRect, DataCol, Column, State);
      end;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);
end;

procedure Tfravnd.DBResumoModalidadesDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  inherited;
  GridZebrado(Sender, Rect, DataCol, Column, State);
end;

procedure Tfravnd.DSTabelaDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  AtualizarDetalheNovo;
//  AtualizarDetalhe;
end;

procedure Tfravnd.fmddtfinalKeyPress(Sender: TObject; var Key: Char);
begin
  edbusca.Text := '';
  try
    fmd.Locate('fmdtitulo', cbTipoData.Text, []);
    if fmd.State <> dsbrowse then
      fmd.Post;

    inherited;

  except

  end;

end;

procedure Tfravnd.AtualizarDetalhe;
begin
  if not dtl.Active then
    dtl.Open;

  itm.Close;
  itm.ParamByName('flacodigo').AsInteger := Acesso.Filial;
  itm.ParamByName('meschave').AsInteger := uqtabelameschave.AsInteger;
  itm.Open;

  uqItmTotais.Close;
  uqItmTotais.ParamByName('flacodigo').AsInteger := Acesso.Filial;
  uqItmTotais.ParamByName('meschave').AsInteger := uqtabelameschave.AsInteger;
  uqItmTotais.Open;

  dtl.Close;
  dtl.ParamByName('flacodigo').AsInteger := Acesso.Filial;
  dtl.ParamByName('meschave').AsInteger := uqtabelameschave.AsInteger;
  dtl.Open;

  if not tom.Active then
    tom.Open;

  if not vdtm.Active then
    vdtm.Open;

  tit.Close;
  tit.Params[0].AsInteger := uqtabelameschave.AsInteger;
  tit.Open;

  if uqtabelasdecodigo.AsString = '02' then
  begin
    plInformacoes.Visible := True;
    plEstorno.Visible := True;
    DBGLista.Repaint;

    hcm.Close;
    hcm.Params[0].AsInteger := uqtabelameschave.AsInteger;
    hcm.Open;

  end

  else
  begin
    hcm.Close;

    plInformacoes.Visible := false;
    plEstorno.Visible := false;
    DBGLista.Repaint;
  end;

end;

procedure Tfravnd.CalculaTotaisNovo;
var

  vlTotalBruto: Double;
  vlTotalDesconto: Double;
  vlTotalOutras: Double;
  vlTotalEntrega: Double;
  vlTotalLiquido: Double;

  vlTotalProdutos: Double;
  vlTotalServicos: Double;

  vlTotalNF: Double;

  vlTotalCancelado: Double;
  vlRecNo: Integer;

  vlTotalRefaturado: Double;
  vlTotalAFaturar: Double;

  vlTotalTrocaDevo: Double;
  vlTotalDoacoes: Double;
  vlTotalRefeicoes: Double;

  vlTotalTroco: Double;

  registroatual: Integer;

  vlFiltros: string;
  vlTotaisDtls: Double;

  vlFiltroEspecial:String;
  vlTipoData:string;
begin

  // inherited;

  try
    vlTotaisDtls := 0;
    vlTotalTroco := 0;
    vlTotalBruto := 0;
    vlTotalDesconto := 0;
    vlTotalOutras := 0;
    vlTotalEntrega := 0;
    vlTotalLiquido := 0;
    vlTotalRefeicoes := 0;

    vlTotalProdutos := 0;
    vlTotalServicos := 0;

    vlTotalRefaturado := 0;
    vlTotalAFaturar := 0;

    vlTotalTrocaDevo := 0;

    vlTotalNF := 0;

    vlTotalCancelado := 0;
    vlTotalTrocaDevo := 0;
    vlTotalDoacoes := 0;

    adm.Close;
    adm.ParamByName('clbcodigo').AsInteger := Acesso.Usuario;
    adm.Open;

    registroatual := uqtabela.RecNo;

    TotaisDtls.Close;
    TotaisDtls.Clear;
    TotaisDtls.Open;

    TotaisDtls.DisableControls;

    uqtabela.DisableControls;

    uniResumoDtl.DisableControls;

    uniResumoDtl.Close;

    uniResumoDtl.SQL.Text := '';

    vlTipoData:=fmdfmdcampo.asstring;
    if vlTipoData='' then
      vlTipoData:='mesemissao';


    uniResumoDtl.SQL.Add('SET lc_time_names = ' + QuotedStr('pt_BR') + '; ');
    uniResumoDtl.SQL.Add
      ('SELECT mensal.mdacodigo,  mensal.mdaidentificacao,  SUM(mensal.dtltotal) dtlvalor,  mensal.nomemes,  mensal.ano,  mensal.mes,  mensal.dia ');
    uniResumoDtl.SQL.Add
      ('FROM (SELECT    dtl.dtlchave,    lte.ltechave,    dtl.mdacodigo,    mes.meschave,    mdaidentificacao,    (dtlvalor) dtltotal, ');
    uniResumoDtl.SQL.Add('MONTH('+vlTipoData+') mes,    UPPER(MONTHNAME('+vlTipoData+')) nomemes,    YEAR('+vlTipoData+') ano,    DATE('+vlTipoData+') dia ');
    uniResumoDtl.SQL.Add('FROM mes ');
    uniResumoDtl.SQL.Add('INNER JOIN toe ON mes.toecodigo = toe.toecodigo ');
    uniResumoDtl.SQL.Add('INNER JOIN tem ON mes.temcodigo = tem.temcodigo ');
    uniResumoDtl.SQL.Add('INNER JOIN sde ON mes.sdecodigo = sde.sdecodigo ');
    uniResumoDtl.SQL.Add('LEFT JOIN rfm  ON mes.meschave = rfm.meschave ');
    uniResumoDtl.SQL.Add('LEFT JOIN rfi  ON rfm.rfichave = rfi.rfichave ');
    uniResumoDtl.SQL.Add('LEFT JOIN mfi  ON rfi.rfichave = mfi.rfichave ');
    uniResumoDtl.SQL.Add('LEFT JOIN mlt  ON mfi.mfichave = mlt.mfichave ');
    uniResumoDtl.SQL.Add('LEFT JOIN lte  ON mlt.ltechave = lte.ltechave ');
    uniResumoDtl.SQL.Add('LEFT JOIN dtl  ON lte.ltechave = dtl.ltechave ');
    uniResumoDtl.SQL.Add('LEFT JOIN mda  ON dtl.mdacodigo = mda.mdacodigo ');
    uniResumoDtl.SQL.Add('WHERE ');
    uniResumoDtl.SQL.Add(' tficodigo <> 6  AND mes.sdecodigo <> ' + QuotedStr('02') +
      ' AND dtl.mdacodigo IN (1, 3, 4, 5, 6, 9, 16)  AND mfi.tmfcodigo = 21  AND ttecodigo = 1  AND ttocodigo = 2  AND ltesituacao = 0 ');
//    uniResumoDtl.SQL.Add('AND lte.tfdcodigo=32 ');
    uniResumoDtl.SQL.Add('-- filtros ');
    uniResumoDtl.SQL.Add(' GROUP BY dtl.dtlchave,dia, mes  ' );
    uniResumoDtl.SQL.Add(' ');


    uniResumoDtl.SQL.Add('UNION ');
    uniResumoDtl.SQL.Add(' ');
    uniResumoDtl.SQL.Add('SELECT DISTINCT NULL, NULL,  NULL, mes.meschave, ' + QuotedStr('Sem Modalidade') +
      ', (mestotal),  MONTH('+vlTipoData+') mes,  UPPER(MONTHNAME('+vlTipoData+')) nomemes, YEAR('+vlTipoData+') ano,  DATE('+vlTipoData+') dia ');
    uniResumoDtl.SQL.Add('FROM mes ');
    uniResumoDtl.SQL.Add('INNER JOIN toe  ON mes.toecodigo = toe.toecodigo ');
    uniResumoDtl.SQL.Add('INNER JOIN tem ON mes.temcodigo = tem.temcodigo ');
    uniResumoDtl.SQL.Add('INNER JOIN sde  ON mes.sdecodigo = sde.sdecodigo ');
    uniResumoDtl.SQL.Add('WHERE meschave NOT IN (SELECT meschave FROM rfm) ');
    uniResumoDtl.SQL.Add(' ');
    uniResumoDtl.SQL.Add('AND mes.sdecodigo <> ' + QuotedStr('02') + ' ');
    uniResumoDtl.SQL.Add('AND ttecodigo = 1 ');
    uniResumoDtl.SQL.Add('AND ttocodigo = 2 ');
    uniResumoDtl.SQL.Add('AND mestotal > 0 ');
    uniResumoDtl.SQL.Add('-- filtros ');

    uniResumoDtl.SQL.Add('');


    uniResumoDtl.SQL.Add('UNION ');
    uniResumoDtl.SQL.Add(' ');
    uniResumoDtl.SQL.Add
      ('SELECT DISTINCT dtl.dtlchave, lte.ltechave,  dtl.mdacodigo,  mes.meschave,  mdaidentificacao,  (dtlvalor) dtltotal,  MONTH('+vlTipoData+') mes, ');
    uniResumoDtl.SQL.Add('      UPPER(MONTHNAME('+vlTipoData+')) nomemes,  YEAR('+vlTipoData+') ano, DATE('+vlTipoData+') dia ');
    uniResumoDtl.SQL.Add('FROM mes ');
    uniResumoDtl.SQL.Add('  INNER JOIN toe  ON mes.toecodigo = toe.toecodigo ');
    uniResumoDtl.SQL.Add('INNER JOIN tem ON mes.temcodigo = tem.temcodigo ');
    uniResumoDtl.SQL.Add('  INNER JOIN sde  ON mes.sdecodigo = sde.sdecodigo ');
    uniResumoDtl.SQL.Add('  INNER JOIN rfm  ON mes.meschave = rfm.meschave ');
    uniResumoDtl.SQL.Add('  INNER JOIN rfi  ON rfm.rfichave = rfi.rfichave ');
    uniResumoDtl.SQL.Add('  INNER JOIN mfi  ON rfi.rfichave = mfi.rfichave ');
    uniResumoDtl.SQL.Add('  INNER JOIN mlt  ON mfi.mfichave = mlt.mfichave ');
    uniResumoDtl.SQL.Add('  INNER JOIN lte  ON mlt.ltechave = lte.ltechave ');
    uniResumoDtl.SQL.Add('  INNER JOIN dtl  ON lte.ltechave = dtl.ltechave ');
    uniResumoDtl.SQL.Add('  INNER JOIN mda  ON dtl.mdacodigo = mda.mdacodigo ');
    uniResumoDtl.SQL.Add('WHERE  ');
    uniResumoDtl.SQL.Add('dtl.mdacodigo = 7 ');
    uniResumoDtl.SQL.Add('AND ttecodigo = 1 ');
    uniResumoDtl.SQL.Add('AND ttocodigo = 2 ');
//    uniResumoDtl.SQL.Add('AND lte.tfdcodigo=32 ');
    uniResumoDtl.SQL.Add('AND mes.sdecodigo <> ' + QuotedStr('02') + ' ');
    uniResumoDtl.SQL.Add('-- filtros ');
    uniResumoDtl.SQL.Add(' GROUP BY dtl.dtlchave,  dia,  mes) mensal ');
    uniResumoDtl.SQL.Add(' GROUP BY mdacodigo,  ano,  mes,  dia,  mdaidentificacao ');
    uniResumoDtl.SQL.Add('ORDER BY mes DESC, dia');

    try
      if not fmd.IsEmpty then
        vlFiltros := ' and ' + vlTipoData + ' BETWEEN (' + QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtinicial.AsFloat)) + ') and (' +
          QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtfinal.AsFloat)) + ')';

    except

      vlFiltros := ' and ' + vlTipoData + ' BETWEEN (' + QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtinicial.AsFloat)) + ') and (' +
        QuotedStr(FormatDateTime('yyyy-mm-dd', fmdfmddtfinal.AsFloat)) + ')  ';

    end;

    vlFiltroEspecial := MontaFiltro;

    if vlFiltroEspecial<>'' then
      vlFiltros:=vlFiltros+' and '+vlFiltroEspecial;

    uniResumoDtl.SQL.Text := StringReplace(uniResumoDtl.SQL.Text, '-- filtros', vlFiltros, [rfReplaceAll, rfIgnoreCase]);
     try
    uniResumoDtl.Open;
     except

     end;

    while not uniResumoDtl.eof do
    begin

        if TotaisDtls.Locate('mdacodigo', uniResumoDtl.FieldByName('mdacodigo').AsInteger, []) then
          TotaisDtls.Edit
        else
          TotaisDtls.Append;

        TotaisDtlsmdaidentificacao.AsString := uniResumoDtl.FieldByName('mdaidentificacao').AsString;
        TotaisDtlsdtlvalor.AsCurrency := TotaisDtlsdtlvalor.AsCurrency + uniResumoDtl.FieldByName('dtlvalor').AsCurrency;
        TotaisDtlsmdacodigo.AsInteger := uniResumoDtl.FieldByName('mdacodigo').AsInteger;
        TotaisDtls.Post;

        vlTotaisDtls := vlTotaisDtls + uniResumoDtl.FieldByName('dtlvalor').AsCurrency;

      if (uniResumoDtl.FieldByName('mdacodigo').AsInteger = mdaVale) or (uniResumoDtl.FieldByName('mdacodigo').AsInteger = mdaTrocaDevolucao) then
      begin

        vlTotalTrocaDevo := vlTotalTrocaDevo + uniResumoDtl.FieldByName('dtlvalor').AsCurrency;
      end;

      if (uniResumoDtl.FieldByName('mdacodigo').AsInteger = mdaDoacao) then
      begin

        vlTotalDoacoes := vlTotalDoacoes + uniResumoDtl.FieldByName('dtlvalor').AsCurrency;
      end;

      uniResumoDtl.Next;
    end;

    plTotalDtl.caption := 'Total R$ ' + Format('%m', [vlTotaisDtls]);

    Application.ProcessMessages;
    TotaisDtls.DisableControls;

    vlTotalBruto := 0;
    vlTotalRefaturado := 0;
    vlTotalAFaturar := 0;

    if uqtabela.Active then
    begin
      uqtabela.First;
      while not uqtabela.eof do
      begin

        if (uqtabelattocodigo.AsInteger = 2) or (uqtabelattocodigo.AsInteger = 9) then
        begin

          if (uqtabelasdecodigo.AsString = '02') or (uqtabelasdecodigo.AsString = '03') then
          begin
            vlTotalCancelado := vlTotalCancelado + uqtabelamestotal.AsCurrency;
          end
          else
          begin

            vlTotalDesconto := vlTotalDesconto + uqtabelamesdesconto.AsCurrency;
            vlTotalOutras := vlTotalOutras + uqtabelamesoutras.AsCurrency;
            vlTotalEntrega := vlTotalEntrega + uqtabelamesfrete.AsCurrency;
            vlTotalBruto := vlTotalBruto + uqtabelamesvalor.AsCurrency+uqtabelamesoutras.AsCurrency;

            if uqtabelattocodigo.AsInteger = ttoVenda then
            begin
              vlTotalProdutos := vlTotalProdutos + uqtabelamesprodutos.AsCurrency;
              vlTotalServicos := vlTotalServicos + uqtabelamesservicos.AsCurrency;
            end;
          end;

          if ((uqtabelatdfcodigo.AsString = '65') or (uqtabelatdfcodigo.AsString = '55')) and (uqtabelasdecodigo.AsString <> '02') then
            vlTotalNF := vlTotalNF + uqtabelamestotal.AsCurrency;



          if ((uqtabelatdfcodigo.AsString = tdfMovimentoAFaturar)) and (uqtabelasdecodigo.AsString <> '02') then
          begin
            vlTotalAFaturar := vlTotalAFaturar + uqtabelamesvalor.AsCurrency;
          end;

          if (uqtabelatdfcodigo.AsString = tdfRefaturado) and (uqtabelasdecodigo.AsString <> '02') then
          begin

            vlTotalRefaturado := vlTotalRefaturado + uqtabelamesvalor.AsCurrency - uqtabelamesdesconto.AsCurrency;

          end;


        end
        else
        begin
          vlTotalRefeicoes := vlTotalRefeicoes + (uqtabelamesvalor.AsCurrency - uqtabelamesdesconto.AsCurrency);
        end;
        uqtabela.Next;
      end;

      {
        if adm.FieldByName('clbsuper').AsInteger = 1 then
        begin
        plResumoModalidades.Visible := True;
        end
        else
        plResumoModalidades.Visible := false; }

      plResumoModalidades.Visible := True;

      vlTotalLiquido := vlTotalBruto - vlTotalDesconto+vlTotalEntrega;

      Pltotalvendas.caption := 'Bruto: ' + FormatFloat('##,###,##0.00', vlTotalBruto { + vlTotalCancelado  - vlTotalRefaturado } );
      Pltotaldescontos.caption := '(-) Descontos: ' + FormatFloat('##,###,##0.00', vlTotalDesconto);
      PltotalEntrega.caption := '(+) Entregas: ' + FormatFloat('##,###,##0.00', vlTotalEntrega);

      PltotalDoacao.caption := '(-) Doações: ' + FormatFloat('##,###,##0.00', vlTotalDoacoes);

      Pltotalliquido.caption := '(=) : ' + FormatFloat('##,###,##0.00', vlTotalOutras + vlTotalLiquido -
        (vlTotalTrocaDevo + vlTotalCancelado));

      PlTotalRefaturado.caption := 'Refaturado: ' + FormatFloat('##,###,##0.00', vlTotalRefaturado);

      PlTotalARefaturar.caption := 'A Faturar: ' + FormatFloat('##,###,##0.00', vlTotalAFaturar);

      Pltotalnfe.caption := 'FISCAL: ' + FormatFloat('##,###,##0.00', vlTotalNF);

      if vlTotalRefaturado = 0 then
        PlTotalRefaturado.Visible := false;

      if vlTotalCancelado > 0 then
      begin
        PlTotalCancelado.caption := 'Cancelados: ' + FormatFloat('##,###,##0.00', vlTotalCancelado);
        PlTotalCancelado.Visible := True;
      end
      else
        PlTotalCancelado.Visible := false;


      TotaisDtls.Filter := 'mdacodigo<>11';
      TotaisDtls.Filtered := True;

      TotaisDtls.IndexFieldNames := 'mdacodigo';

      if vlTotalAFaturar > 0 then
      begin
        if TotaisDtls.Locate('mdacodigo', 9, []) then
          TotaisDtls.Edit
        else
          TotaisDtls.Append;

        TotaisDtlsmdaidentificacao.AsString := 'A Faturar';
        TotaisDtlsdtlvalor.AsCurrency := vlTotalAFaturar;
        TotaisDtlsmdacodigo.AsInteger := 9;
        TotaisDtls.Post;
        vlTotaisDtls := vlTotaisDtls + vlTotalAFaturar;

      end;

      if TotaisDtls.Locate('mdacodigo', 15, []) then
      begin
        vlTotaisDtls := vlTotaisDtls - TotaisDtlsdtlvalor.AsFloat;
        TotaisDtls.Delete;

      end;

      vlTotalLiquido := vlTotalLiquido - (vlTotalDoacoes + vlTotalCancelado + vlTotalTrocaDevo);

      if vlTotaisDtls < vlTotalLiquido then
      begin

        if RoundTo(vlTotalLiquido, -2) - vlTotaisDtls > 0 then
        begin

          if TotaisDtls.Locate('mdacodigo', 99, []) then
            TotaisDtls.Edit
          else
            TotaisDtls.Append;

          TotaisDtlsmdaidentificacao.AsString := 'SEM FINALIZAR';
          TotaisDtlsdtlvalor.AsCurrency := RoundTo(vlTotalLiquido, -2) - vlTotaisDtls;
          TotaisDtlsmdacodigo.AsInteger := 99;
          TotaisDtls.Post;

        end;

      end;

      vlTotaisDtls := 0;
      TotaisDtls.First;
      while not TotaisDtls.eof do
      begin
        vlTotaisDtls := vlTotaisDtls + TotaisDtlsdtlvalor.AsCurrency;

        TotaisDtls.Next;
      end;

      plTotalDtl.caption := 'Total R$ ' + Format('%m', [vlTotaisDtls]);
      TotaisDtls.EnableControls;
    end;
  finally

    uqtabela.RecNo := registroatual;
    uqtabela.EnableControls;
    dtl.EnableControls;
    TotaisDtls.EnableControls;

  end;
end;


procedure Tfravnd.AtualizaTotaisItens;
begin
  plQtdItens.caption := 'Qt.Itens : ' + uqItmTotaisitmitens.AsString;
  plBrutoItens.caption := 'Bruto: ' + FormatFloat('#,##0.00', uqItmTotaisitmtotal.AsFloat);
  plDescontoItens.caption := 'Desconto: ' + FormatFloat('#,##0.00', uqItmTotaisitmdesconto.AsFloat);
  plEntrega.caption := 'Entrega: ' + FormatFloat('#,##0.00', uqItmTotaisitmfrete.AsFloat);

  plLiquidoItens.caption := 'Líquido: ' + FormatFloat('#,##0.00', uqItmTotaisitmtotalliq.AsFloat + uqItmTotaisitmoutras.AsFloat+uqItmTotaisitmfrete.AsFloat);
end;

procedure Tfravnd.bConfirmaSelecaoClick(Sender: TObject);
begin
  // inherited;
  inherited AtualizaFiltroUQTabela;
  CalculaTotaisNovo;

end;

procedure Tfravnd.btLimpaBuscaClick(Sender: TObject);
begin
  Self.edbusca.Text := '';
  inherited;

end;

procedure Tfravnd.btOcultaExibeDetalheClick(Sender: TObject);
begin
  inherited;
  if btOcultaExibeDetalhe.caption = '>' then
  begin
    btOcultaExibeDetalhe.caption := '<';
    PlItens.Width := 722;
  end
  else
  begin
    btOcultaExibeDetalhe.caption := '>';
    PlItens.Width := 22;
  end;
end;

procedure Tfravnd.btOcultaExibeObservacoesClick(Sender: TObject);
begin
  inherited;
  if btOcultaExibeObservacoes.caption = '-' then
  begin
    PCDetalhes.Height := 2;
    btOcultaExibeObservacoes.caption := '+';
  end
  else
  begin
    PCDetalhes.Height := 77;
    btOcultaExibeObservacoes.caption := '-';
  end;

  AjustaAlturaRodaPeGrid;

end;

procedure Tfravnd.btOcultaExibeTotaisClick(Sender: TObject);
begin
  inherited;
  if btOcultaExibeTotais.caption = '-' then
  begin
    plDetalhes.Height := 2;
    btOcultaExibeTotais.caption := '+';
  end
  else
  begin
    plDetalhes.Height := 55;
    btOcultaExibeTotais.caption := '-';
  end;

  AjustaAlturaRodaPeGrid;

end;

procedure Tfravnd.listaitmDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  inherited;

  If Odd(Ditm.DataSet.RecNo) Then
    listaitm.Canvas.Brush.Color := PEG_COR_BASE
  Else
    listaitm.Canvas.Brush.Color := CLWHITE;

  TDBGrid(Sender).Canvas.font.Color := clBlack;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      Brush.Color := PEG_COR_SELCGRID;
      FillRect(Rect);
    End;

  TDBGrid(Sender).DefaultDrawDataCell(Rect, TDBGrid(Sender).Columns[DataCol].Field, State);
end;

procedure Tfravnd.listaobsDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  inherited;

  If Odd(Dtom.DataSet.RecNo) Then
    listaobs.Canvas.Brush.Color := PEG_COR_BASE
  Else
    listaobs.Canvas.Brush.Color := CLWHITE;

  TDBGrid(Sender).Canvas.font.Color := clBlack;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      Brush.Color := PEG_COR_SELCGRID;
      FillRect(Rect);
      font.Style := [fsbold]
    End;

  TDBGrid(Sender).DefaultDrawDataCell(Rect, TDBGrid(Sender).Columns[DataCol].Field, State);
end;

procedure Tfravnd.mAjustarFilialClick(Sender: TObject);
begin
  inherited;
  uqtabela.First;
  while not uqtabela.eof do
  begin
    dtl.Close;
    dtl.SQL.Text := 'SELECT   mda.mdaidentificacao,  dtl.dtlvalor,  rfm.rfmchave, ';
    dtl.SQL.Add('mes.meschave,  rfi.rfihistorico,  mes.flacodigo,  rfi.rfichave,  mfi.mfichave,');
    dtl.SQL.Add('  mes.mestotal,  dtl.dtlchave, dtl.ltechave, dtl.flacodigo as dtlflacodigo, mlt.mltchave, ');
    dtl.SQL.Add(' rfm.flacodigo as rfmflacodigo, rfi.flacodigo as rfiflacodigo, mfi.flacodigo as mfiflacodigo,');
    dtl.SQL.Add(' lte.flacodigo as lteflacodigo, mlt.flacodigo as mltflacodigo ');
    dtl.SQL.Add('FROM rfm ');
    dtl.SQL.Add('  INNER JOIN mes  ON rfm.meschave = mes.meschave --  and rfm.flacodigo=mes.flacodigo ');
    dtl.SQL.Add('  INNER JOIN rfi  ON rfm.rfichave = rfi.rfichave --  and rfi.flacodigo=mes.flacodigo ');
    dtl.SQL.Add('  INNER JOIN mfi  ON mfi.rfichave = rfi.rfichave  -- and mfi.flacodigo=mes.flacodigo ');
    dtl.SQL.Add('  LEFT JOIN mlt  ON mlt.mfichave = mfi.mfichave ');
    dtl.SQL.Add('  LEFT JOIN dtl  ON dtl.ltechave = mlt.ltechave ');
    dtl.SQL.Add('  LEFT JOIN mda  ON dtl.mdacodigo = mda.mdacodigo ');
    dtl.SQL.Add('  LEFT JOIN lte  ON mlt.ltechave = lte.ltechave ');
    dtl.SQL.Add('WHERE rfi.tfdcodigo IN (2, 32) ');
    dtl.SQL.Add('AND IF(rfi.tfdcodigo = 2, mfi.tmfcodigo = 2, mfi.tmfcodigo) ');
    dtl.SQL.Add('AND mes.meschave = :meschave and mes.flacodigo=:flacodigo ');
    dtl.SQL.Add(' ');
    dtl.SQL.Add('-- GROUP BY dtl.dtlchave');
    dtl.ParamByName('meschave').AsInteger := uqtabelameschave.AsInteger;
    dtl.ParamByName('flacodigo').AsInteger := uqtabelaflacodigo.AsInteger;
    dtl.Open;

    dtl.First;
    while not dtl.eof do
    begin

      if dtl.FieldByName('ltechave').AsString <> '' then
      begin
        try
          consulta.Close;
          consulta.SQL.Text := 'update dtl set flacodigo=' + dtl.FieldByName('rfiflacodigo').AsString + ' where dtlchave=' +
            dtl.FieldByName('dtlchave').AsString;
          consulta.ExecSQL;
        except

        end;

        try
          consulta.Close;
          consulta.SQL.Text := 'update rfm set flacodigo=' + dtl.FieldByName('rfiflacodigo').AsString + ' where rfmchave=' +
            dtl.FieldByName('rfmchave').AsString;
          consulta.ExecSQL;
        except

        end;

        try

          consulta.Close;
          consulta.SQL.Text := 'update mfi set flacodigo=' + dtl.FieldByName('rfiflacodigo').AsString + ' where mfichave=' +
            dtl.FieldByName('mfichave').AsString;
          consulta.ExecSQL;
        except

        end;

        try

          consulta.Close;
          consulta.SQL.Text := 'update lte set flacodigo=' + dtl.FieldByName('rfiflacodigo').AsString + ' where ltechave=' +
            dtl.FieldByName('ltechave').AsString;
          consulta.ExecSQL;
        except

        end;

        try

          consulta.Close;
          consulta.SQL.Text := 'update mlt set flacodigo=' + dtl.FieldByName('rfiflacodigo').AsString + ' where mltchave=' +
            dtl.FieldByName('mltchave').AsString;
          consulta.ExecSQL;
        except

        end;

        try

          consulta.Close;
          consulta.SQL.Text := 'update mor set flacodigo=' + uqtabela.FieldByName('flacodigo').AsString + ' where meschave=' +
            uqtabela.FieldByName('meschave').AsString;
          consulta.ExecSQL;
        except

        end;

        try

          consulta.Close;
          consulta.SQL.Text := 'update itm set flacodigo=' + uqtabela.FieldByName('flacodigo').AsString + ' where meschave=' +
            uqtabela.FieldByName('meschave').AsString;
          consulta.ExecSQL;
        except

        end;

      end;
      dtl.Next;
    end;

    mfirfi.Close;
    mfirfi.ParamByName('meschave').AsInteger := uqtabelameschave.AsInteger;
    mfirfi.Open;
    while not mfirfi.eof do
    begin
      try
        consulta.Close;
        consulta.SQL.Text := 'update mfi set flacodigo=' + uqtabelaflacodigo.AsString + ' where mfichave=' + mfirfi.FieldByName('mfichave').AsString;
        consulta.ExecSQL;
      except

      end;
      mfirfi.Next;
    end;

    uqtabela.Next;
  end;
  ShowMessage('Ajuste realizado com sucesso!');

  dtl.Close;
  dtl.SQL.Text := 'SELECT   mda.mdaidentificacao,  dtl.dtlvalor,  rfm.rfmchave, ';
  dtl.SQL.Add('mes.meschave,  rfi.rfihistorico,  mes.flacodigo,  rfi.rfichave,  mfi.mfichave,');
  dtl.SQL.Add('  mes.mestotal,  dtl.dtlchave, dtl.ltechave, dtl.flacodigo as dtlflacodigo, mlt.mltchave, ');
  dtl.SQL.Add(' rfm.flacodigo as rfmflacodigo, rfi.flacodigo as rfiflacodigo, mfi.flacodigo as mfiflacodigo,');
  dtl.SQL.Add(' lte.flacodigo as lteflacodigo , mlt.flacodigo as mltflacodigo ');
  dtl.SQL.Add('FROM rfm ');
  dtl.SQL.Add('  INNER JOIN mes  ON rfm.meschave = mes.meschave   and rfm.flacodigo=mes.flacodigo ');
  dtl.SQL.Add('  INNER JOIN rfi  ON rfm.rfichave = rfi.rfichave   and rfi.flacodigo=mes.flacodigo ');
  dtl.SQL.Add('  INNER JOIN mfi  ON mfi.rfichave = rfi.rfichave  and mfi.flacodigo=mes.flacodigo ');
  dtl.SQL.Add('  LEFT JOIN mlt  ON mlt.mfichave = mfi.mfichave ');
  dtl.SQL.Add('  INNER JOIN dtl  ON dtl.ltechave = mlt.ltechave ');
  dtl.SQL.Add('  LEFT JOIN mda  ON dtl.mdacodigo = mda.mdacodigo ');
  dtl.SQL.Add('  LEFT JOIN lte  ON mlt.ltechave = lte.ltechave ');
  dtl.SQL.Add('WHERE rfi.tfdcodigo IN (2, 32) ');
  dtl.SQL.Add('AND IF(rfi.tfdcodigo = 2, mfi.tmfcodigo = 2, mfi.tmfcodigo) ');
  dtl.SQL.Add('AND mes.meschave = :meschave and mes.flacodigo=:flacodigo ');
  dtl.SQL.Add(' ');
  dtl.SQL.Add('   GROUP BY dtl.mdacodigo');
  dtl.ParamByName('meschave').AsInteger := uqtabelameschave.AsInteger;
  dtl.ParamByName('flacodigo').AsInteger := uqtabelaflacodigo.AsInteger;
  dtl.Open;

  dtl.First;

end;

procedure Tfravnd.mAjustaVendaRefeicaoClick(Sender: TObject);
begin
  inherited;

    uqtabela.First;

    while not uqtabela.Eof do
    begin
      if uqtabelameschave.AsInteger=360297 then
      begin
        showmessage('');
      end;

      mesrefeicao.Close;
      mesrefeicao.sql.Text:='SELECT mes.meschave, mdacodigo, mesvalor ';
      mesrefeicao.sql.Add('FROM mes  JOIN toe ON mes.toecodigo = toe.toecodigo ');
      mesrefeicao.sql.Add(' WHERE toe.ttecodigo=(1) ');
      mesrefeicao.sql.Add(' and toe.ttocodigo not in( 10,8,3) ');
      mesrefeicao.sql.Add(' and mes.mesrefeicao=1 ');
      mesrefeicao.sql.Add(' and mes.meschave=:meschave ');
      mesrefeicao.sql.Add(' and mes.mesvalor=:mesvalor ');

      mesrefeicao.ParamByName('meschave').AsInteger:=uqtabela.FieldByName('meschave').AsInteger+1;
      mesrefeicao.ParamByName('mesvalor').AsCurrency:=uqtabela.FieldByName('mesvalor').AsCurrency;
      mesrefeicao.Open;

      if not mesrefeicao.IsEmpty then
      begin

        if not dtl.IsEmpty then
        begin
          mesrefeicao.Edit;
          mesrefeicao.FieldByName('mdacodigo').AsString:=dtl.FieldByName('mdacodigo').AsString;
          mesrefeicao.Post;
        end;
      end;




      mesrefeicao.Close;
      mesrefeicao.sql.Text:='SELECT mes.meschave, mdacodigo, mesvalor ';
      mesrefeicao.sql.Add('FROM mes  JOIN toe ON mes.toecodigo = toe.toecodigo ');
      mesrefeicao.sql.Add(' WHERE toe.ttecodigo=(1) ');
      mesrefeicao.sql.Add(' and toe.ttocodigo not in( 10,8,3) ');
      mesrefeicao.sql.Add(' and mes.mesrefeicao=1 ');
      mesrefeicao.sql.Add(' and mes.mdacodigo=0 ');
      mesrefeicao.sql.Add(' and mes.mesinclusao=:mesinclusao ');
      mesrefeicao.sql.Add(' and mes.mesvalor=:mesvalor ');


      mesrefeicao.ParamByName('mesinclusao').AsDateTime:=uqtabela.FieldByName('mesinclusao').AsDateTime;
      mesrefeicao.ParamByName('mesvalor').AsCurrency:=uqtabela.FieldByName('mesvalor').AsCurrency;
      mesrefeicao.Open;

      if not mesrefeicao.IsEmpty then
      begin

        if not dtl.IsEmpty then
        begin
          mesrefeicao.Edit;
          mesrefeicao.FieldByName('mdacodigo').AsString:=dtl.FieldByName('mdacodigo').AsString;
          mesrefeicao.Post;
        end;
      end;




      uqtabela.Next;
    end;





end;

procedure Tfravnd.mnAjustarRegimetributarioClick(Sender: TObject);
begin
  inherited;
  {
    REGIME LUCRO PRESUMIDO

    Vamos fazer algumas alterações tanto nas entradas dos produtos como na saída.

    - Na Compra de mercadoria (ENTRADA DE MERCADORIA) separar os CFOP quando a empresa Dupe comprar com CFOP 5.102 (entrada 1.102) a venda de mercadoria sairá com CFOP 5102.

    - CST - ICMS = 090 - OUTROS

    - Na Compra de mercadoria (ENTRADA DE MERCADORIA) separar os CFOP quando a empresa Dupe comprar com CFOP 5.403 ou 5.405 (entrada 1.403 - 1.405) a venda de mercadoria sairá com CFOP 5.405.

    - CST - ICMS = 060 - ICMS COBRADO ANTERIORMENTE POR SUBSTITUIÇÃO TRIBUTARIA





  }

  uqtabela.First;
  while not uqtabela.eof do
  begin
    itm.First;
    while not itm.eof do
    begin
      pro.Close;
      pro.ParamByName('procodigo').AsString := itmprocodigo.AsString;
      pro.Open;

      if procstcodigo.AsString = '090' then
      begin

        consulta.Close;
        consulta.SQL.Text := 'update itm set cstcodigo=' + QuotedStr(procstcodigo.AsString) + ' , cfocfop=' + QuotedStr('5.102') + ', toecodigo=' +
          uqtabelatoecodigo.AsString + ' where itmchave=' + itmitmchave.AsString;
        consulta.ExecSQL;

      end;

      if procstcodigo.AsString = '060' then
      begin

        consulta.Close;
        consulta.SQL.Text := 'update itm set cstcodigo=' + QuotedStr(procstcodigo.AsString) + ' , cfocfop=' + QuotedStr('5.405') + ', toecodigo=' +
          uqtabelatoecodigo.AsString + ' where itmchave=' + itmitmchave.AsString;
        consulta.ExecSQL;

        consulta.Close;
        consulta.SQL.Text := 'update itm set cstcodigo=' + QuotedStr(procstcodigo.AsString) + ' , cfocfop=' + QuotedStr('5.405') + ', toecodigo=' +
          uqtabelatoecodigo.AsString + ' where itmchave=' + itmitmchave.AsString;
        consulta.ExecSQL;

      end;

      itm.Next;
    end;
    uqtabela.Next;
  end;
end;

procedure Tfravnd.mnMarcarcomoReclassificacaoClick(Sender: TObject);
begin
  inherited;
  consulta.Close;
  consulta.SQL.Text := 'update mes set mesreclassicacao=9 where meschave=' + uqtabelameschave.AsString;
  consulta.ExecSQL;
  Self.ActAtualizar.Execute;

end;

procedure Tfravnd.AtualizarDetalheNovo;
begin

  uqItmTotais.Close;
  uqItmTotais.ParamByName('flacodigo').AsInteger := Acesso.Filial;
  uqItmTotais.ParamByName('meschave').AsInteger := uqtabelameschave.AsInteger;
  uqItmTotais.Open;


    TotaisResumo.Close;
    TotaisResumo.Clear;
    TotaisResumo.Open;

    dtlResumo.Close;
    dtlResumo.ParamByName('flacodigo').AsInteger := Acesso.Filial;
    dtlResumo.ParamByName('meschave').AsInteger := uqtabelameschave.AsInteger;
    dtlResumo.Open;

    dtlResumo.First;
    while not dtlResumo.eof do
    begin
      TotaisResumo.Append;
      TotaisResumomdaidentificacao.AsString := dtlResumo.FieldByName('mdaidentificacao').AsString;
      TotaisResumodtlvalor.AsString := dtlResumo.FieldByName('dtlvalor').AsString;
      TotaisResumomdacodigo.AsInteger := dtlResumo.FieldByName('mdacodigo').AsInteger;
      TotaisResumoltechave.AsInteger := dtlResumo.FieldByName('ltechave').AsInteger;
      TotaisResumodtlchave.AsInteger := dtlResumo.FieldByName('dtlchave').AsInteger;
      TotaisResumordcnrauto.AsString := dtlResumo.FieldByName('rdcnrauto').AsString;

      TotaisResumo.Post;
      dtlResumo.next;
    end;


end;



end.
