unit ufpro;

interface

uses
  Winapi.Windows, Vcl.Forms, ufrmbase, Data.DB, Vcl.ExtCtrls, Vcl.DBCtrls,
  Vcl.StdCtrls, Vcl.Mask, Vcl.ImgList, Vcl.Controls, PngImageList,
  System.Classes, System.Actions, Vcl.ActnList, MemDS, DBAccess, Uni,
  Vcl.Buttons, Vcl.ComCtrls, Vcl.Dialogs, uFuncoes, System.SysUtils,
  Vcl.Graphics, ufrapun, ufrapco, System.ImageList, dateutils;

type
  Tfpro = class(Tfrmbase)
    Uni: tuniquery;
    uniunicodigo: TIntegerField;
    uniuninome: TStringField;
    mar: tuniquery;
    marmarcodigo: TIntegerField;
    marmaridentificacao: TStringField;
    trb: tuniquery;
    trbtrbcodigo: TIntegerField;
    trbtrbidentificacao: TStringField;
    tpo: tuniquery;
    tpotpocodigo: TIntegerField;
    tpotpoidentificacao: TStringField;
    icm: tuniquery;
    icmicmcodigo: TStringField;
    icmicmaliquotas: TStringField;
    grp: tuniquery;
    grpgrpcodigo: TIntegerField;
    grpgrpidentificacao: TStringField;
    registroprocodigo: TIntegerField;
    registropronome: TStringField;
    registropronomereduzido: TStringField;
    registromarcodigo: TIntegerField;
    registromaridentificacao: TStringField;
    registrogrpcodigo: TIntegerField;
    registrogrpidentificacao: TStringField;
    registrotrbcodigo: TIntegerField;
    registrotrbidentificacao: TStringField;
    registroicmcodigo: TStringField;
    registroicmaliquotas: TStringField;
    registrounicodigo: TIntegerField;
    registrouninome: TStringField;
    registrotpocodigo: TIntegerField;
    registrotpoidentificacao: TStringField;
    registroprominimo: TFloatField;
    registroproproprio: TStringField;
    registroproncm: TStringField;
    registroprocomposto: TStringField;
    registroprobalanca: TStringField;
    registroprotecla: TStringField;
    registroprovalidade: TIntegerField;
    registroproestoque: TStringField;
    registroproobs: TStringField;
    PlPun: TPanel;
    composicao: TTabSheet;
    Plpco: TPanel;
    registroproreferencia: TStringField;
    sen: tuniquery;
    sensencodigo: TIntegerField;
    sensenidentificacao: TStringField;
    registroprocompostosen: TStringField;
    registroproestoquesen: TStringField;
    registroprobalancasen: TStringField;
    cfgcfgbalanca: TIntegerField;
    unituncodigo: TIntegerField;
    cfgcfgnrseriepro: TIntegerField;
    cfgcfgrefepro: TIntegerField;
    cfgcfgcompro: TIntegerField;
    registroproqtdtrib: TFloatField;
    registroprounitrib: TIntegerField;
    registrounitrib: TStringField;
    cfgcfgunitrib: TIntegerField;
    registrosipcodigo: TIntegerField;
    tcg: tuniquery;
    tcgtcgncm: TStringField;
    tcgtcgaliqnac: TFloatField;
    tcgtcgaliqimp: TFloatField;
    Dtcg: tunidatasource;
    cfgcfgusafabricante: TIntegerField;
    cfgcfgprousaanpcodigo: TIntegerField;
    enp: tuniquery;
    enpenpcodigo: TIntegerField;
    enpenpendereco: TStringField;
    cfgcfgusaenderecamento: TIntegerField;
    cfgcfgprocodigoauto: TIntegerField;
    cfgcfgprodefineicms: TIntegerField;
    cfgcfgprousainfcompl: TIntegerField;
    Dcpb: TDataSource;
    cfgcfgidentificatecnico: TIntegerField;
    registrogracodigo: TIntegerField;
    cfgcfgusagrade: TIntegerField;
    cfgcfgdigitosbalanca: TIntegerField;
    registrodprcodigo: TIntegerField;
    dpr: tuniquery;
    dprdprcodigo: TIntegerField;
    dprdpridentificacao: TStringField;
    registrodpridentificacao: TStringField;
    registroprousagrade: TIntegerField;
    registrosenusagrade: TStringField;
    cfgcfgusacstnoproduto: TIntegerField;
    cst: tuniquery;
    cstcstcodigo: TStringField;
    cstcstidentificacao: TStringField;
    tcgtcgdescricao: TStringField;
    registrotcgdescricao: TStringField;
    gbBase: TPanel;
    Label2: TLabel;
    Label3: TLabel;
    pronome: TDBEdit;
    pronomereduzido: TDBEdit;
    procodigo: TDBEdit;
    Label1: TLabel;
    platencao: TPanel;
    gbDados: TPanel;
    Label6: TLabel;
    tpocodigo: TDBEdit;
    Label5: TLabel;
    grpcodigo: TDBEdit;
    Label9: TLabel;
    dprcodigo: TDBEdit;
    Label12: TLabel;
    unicodigo: TDBEdit;
    Label15: TLabel;
    proestoque: TDBEdit;
    Label11: TLabel;
    proncm: TDBEdit;
    btBuscaNCM: TBitBtn;
    Label8: TLabel;
    pltcgaliqnac: TPanel;
    tcgaliqnac: TDBText;
    gbValidar: TPanel;
    bvalidar: TButton;
    cfgcfgusacsinoproduto: TIntegerField;
    cfgcfgusacspnoproduto: TIntegerField;
    cfgcfgusacsfnoproduto: TIntegerField;
    csi: tuniquery;
    csp: tuniquery;
    csf: tuniquery;
    csicsicodigo: TStringField;
    csicsiidentificacao: TStringField;
    cspcspcodigo: TStringField;
    cspcspidentificacao: TStringField;
    csfcsfcodigo: TStringField;
    csfcsfidentificacao: TStringField;
    proobs: TDBMemo;
    Label10: TLabel;
    gbComposto: TPanel;
    lpprocomposto: TLabel;
    procomposto: TDBEdit;
    cfgcfgusasrv: TIntegerField;
    registroprocontabiliza: TIntegerField;
    registrosenprocontabiliza: TStringField;
    cfgcfgusactb: TIntegerField;
    registropropercreducaobaseicm: TFloatField;
    registropropisaliquota: TFloatField;
    registroprocofinsaliquota: TFloatField;
    cfgcstcodigo: TStringField;
    cfgcsicodigo: TStringField;
    cfgcsfcodigo: TStringField;
    cfgcspcodigo: TStringField;
    registroproalterarqtd: TIntegerField;
    registrosenproalterarqtd: TStringField;
    registroproremoto: TIntegerField;
    registrosenproremoto: TStringField;
    Plimagem: TTabSheet;
    Label19: TLabel;
    proimagem: TDBImage;
    OpenPictureDialog: TOpenDialog;
    btCarregaImagem: TButton;
    registroproimagem: TBlobField;
    registroprocest: TStringField;
    tce: tuniquery;
    tcetcecest: TStringField;
    tcetcedescricao: TStringField;
    Label16: TLabel;
    procest: TDBEdit;
    btBuscaCEST: TBitBtn;
    registrotcedescricao: TStringField;
    registroproproducao: TIntegerField;
    registrosenproproducao: TStringField;
    ltitutloproproducao: TLabel;
    proproducao: TDBEdit;
    cfgcfgdiferencialaliquota: TIntegerField;
    pad: tuniquery;
    padpadcodigo: TIntegerField;
    padpadidentificacao: TStringField;
    registropadcodigo: TIntegerField;
    registropadidentificacao: TStringField;
    labdifealiquota: TLabel;
    padcodigo: TDBEdit;
    cfgcfgproducaopropria: TIntegerField;
    gbbalanca: TPanel;
    lpprobalanca: TLabel;
    lcpbcodbalanca: TLabel;
    probalanca: TDBEdit;
    cpbcodbalanca: TDBEdit;
    cpb: tuniquery;
    cpbcpbcodigo: TIntegerField;
    cpbprocodigo: TIntegerField;
    cpbcpbcodbalanca: TIntegerField;
    cpbcpbsetor: TIntegerField;
    cpbcpbuniadesporkg: TIntegerField;
    gbICMS: TPanel;
    LbIcmCodigo: TLabel;
    Label14: TLabel;
    Label20: TLabel;
    Label7: TLabel;
    lbicmsforaeti: TLabel;
    icmcodigo: TDBEdit;
    propercreducaobaseicm: TDBEdit;
    propercfcp: TDBEdit;
    icmcodigofora: TDBEdit;
    cfocfop: TDBEdit;
    gbCSTCodigo: TPanel;
    lbcstcodigo: TLabel;
    cstcodigo: TDBEdit;
    gbUnidadeTributaria: TPanel;
    plprounitrib: TLabel;
    plproqtdtrib: TLabel;
    prounitrib: TDBEdit;
    proqtdtrib: TDBEdit;
    gbcsicodigo: TPanel;
    lbcsicodigo: TLabel;
    csicodigo: TDBEdit;
    gbcspcodigo: TPanel;
    lbcspcodigo: TLabel;
    Label4: TLabel;
    cspcodigo: TDBEdit;
    propisaliquota: TDBEdit;
    gbcsfcodigo: TPanel;
    lbcsfcodigo: TLabel;
    Label17: TLabel;
    csfcodigo: TDBEdit;
    procofinsaliquota: TDBEdit;
    cfgcrtcodigo: TIntegerField;
    registropromva: TStringField;
    registropropercfcp: TStringField;
    registrocfocfop: TStringField;
    registrocfocfopfora: TStringField;
    registroicmcodigofora: TStringField;
    registroicmicmcodigofora: TStringField;
    registrocstcodigo: TStringField;
    registrocsicodigo: TStringField;
    registrocspcodigo: TStringField;
    registrocsfcodigo: TStringField;
    registropropededescrserv: TIntegerField;
    registropropedetecnicoserv: TIntegerField;
    registropronumserie: TStringField;
    registrocsiidentificacao: TStringField;
    registrocspidentificacao: TStringField;
    registrocsfidentificacao: TStringField;
    registrocstidentificacao: TStringField;
    procedure FormShow(Sender: TObject);
    procedure registroAfterInsert(DataSet: TDataSet);
    procedure bvalidarClick(Sender: TObject);
    procedure DSRegistroDataChange(Sender: TObject; Field: TField);
    procedure procompostoClick(Sender: TObject);
    procedure bconfirmaClick(Sender: TObject);
    procedure paginasChange(Sender: TObject);
    procedure bcancelaClick(Sender: TObject);
    procedure pronomereduzidoEnter(Sender: TObject);
    procedure proestoqueEnter(Sender: TObject);
    procedure pronumserieEnter(Sender: TObject);
    procedure procompostoEnter(Sender: TObject);
    procedure proestoqueExit(Sender: TObject);

    procedure unicodigoExit(Sender: TObject);
    procedure proncmExit(Sender: TObject);
    procedure tpocodigoExit(Sender: TObject);
    procedure enpcodigoExit(Sender: TObject);
    procedure proncmKeyPress(Sender: TObject; var Key: Char);
    procedure procodigoExit(Sender: TObject);

    procedure btBuscaNCMClick(Sender: TObject);
    procedure enpBeforeOpen(DataSet: TDataSet);
    procedure enpcodigoEnter(Sender: TObject);

    procedure btCarregaImagemClick(Sender: TObject);
    procedure procestExit(Sender: TObject);
    procedure procestKeyPress(Sender: TObject; var Key: Char);
    procedure btBuscaCESTClick(Sender: TObject);
    procedure probalancaExit(Sender: TObject);
    procedure cpbcodbalancaEnter(Sender: TObject);
    procedure cpbcodbalancaExit(Sender: TObject);
    procedure cpbAfterInsert(DataSet: TDataSet);
    procedure FormCreate(Sender: TObject);
    procedure cfocfopExit(Sender: TObject);
    procedure icmcodigoExit(Sender: TObject);
    procedure icmcodigoforaExit(Sender: TObject);
    procedure cstcodigoExit(Sender: TObject);
    procedure prounitribEnter(Sender: TObject);
  private
    procedure salvacolunasframes;
    function TemMovimentacao: Boolean;
    procedure VerificaValidacoes;
    function PossuiVariacao: Boolean;
    procedure AjustaProdutoPesado;
  public
    { Public declarations }
    hpun: THandle;
    hprf: THandle;
    hpco: THandle;
    hvrp: THandle;
    vunibase: string;
  end;

var
  fpro: Tfpro;

  // Início ID do Módulo frapro
const
  vPlIdMd = '01.01.05.001-02';

  // Fim ID do Módulo frapro

implementation

{$R *.dfm}

procedure Tfpro.salvacolunasframes;
var
  fra: Tframe;
begin

  if hpun <> 0 then
  begin
    fra := nil;
    fra := Tfrapun(Application.FindComponent('frapun'));

    if fra <> nil then
      if (fra is Tfrapun) then
        (fra as Tfrapun).salvacolunas;
  end;

  if hpco <> 0 then
  begin
    fra := nil;
    fra := Tfrapco(Application.FindComponent('frapco'));

    if fra <> nil then
      if (fra is Tfrapco) then
        (fra as Tfrapco).salvacolunas;
  end;

end;

procedure Tfpro.unicodigoExit(Sender: TObject);
var
  videnti: string;
begin
  inherited;

  Self.ValidaSaida(Sender);

  registroprounitrib.AsString := Self.unicodigo.Text;
  registroproqtdtrib.AsFloat := 1;

  if psituacao.Caption = 'Alterando' then
    if unicodigo.ReadOnly = False then
    begin
      consulta.Close;
      consulta.SQL.Text := 'UPDATE pun SET ';
      consulta.SQL.Add('unicodigo = ' + Self.unicodigo.Field.AsString + ', ');
      consulta.SQL.Add('unicodigobase = ' + Self.unicodigo.Field.AsString + ', ');
      consulta.SQL.Add('punidentificacao = CONCAT(''1x'', (SELECT unisimbolo FROM uni WHERE uni.unicodigo = pun.unicodigo)) ');
      consulta.SQL.Add('WHERE procodigo = ' + Self.procodigo.Field.AsString + ' AND ');
      consulta.SQL.Add('unicodigo = ' + vunibase);
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'UPDATE pun SET ';
      consulta.SQL.Add('unicodigobase = ' + Self.unicodigo.Field.AsString + ', ');
      consulta.SQL.Add('punidentificacao = CONCAT(TRUNCATE(punmultiplicador,0),''x'', (SELECT unisimbolo FROM uni WHERE uni.unicodigo = ' +
        Self.unicodigo.Field.AsString + ')) ');
      consulta.SQL.Add('WHERE procodigo = ' + Self.procodigo.Field.AsString + ' AND ');
      consulta.SQL.Add('unicodigo <> ' + Self.unicodigo.Field.AsString);
      consulta.ExecSQL;
    end;

end;

procedure Tfpro.bcancelaClick(Sender: TObject);
var
  smsg: string;
begin
  if bcancela.Visible then
    bcancela.SetFocus; // Força o ActiveControl para o botão Cancelar

  if (Self.psituacao.Caption = 'Incluindo') or (Self.psituacao.Caption = 'Cancelando') then
  begin

    if psituacao.Caption = 'Alterando' then
      smsg := 'Deseja realmente abandonar as alterações ?'
    else
      smsg := 'Deseja realmente abandonar a inclusão do registro ?';

    If Application.MessageBox(PChar(smsg), 'Atenção', MB_YESNO + MB_DEFBUTTON1 + MB_ICONQUESTION) = IDYES Then
    Begin
      Self.registro.ReadOnly := False;
      Self.registro.Delete;
      Close;
    End;

  end
  else
    Close;
  { inherited; }
end;

procedure Tfpro.bconfirmaClick(Sender: TObject);
var
  pode: Boolean;
  vlSpdChave: Integer;
  vlSpdRegistro: string;
begin
  consulta.Close;
  consulta.SQL.Clear;
  consulta.SQL.Add('SELECT pun.puncodigo FROM pun');
  consulta.SQL.Add(' WHERE pun.unicodigo = ' + Self.unicodigo.Field.AsString + ' ');
  consulta.SQL.Add('   AND pun.procodigo = ' + Self.procodigo.Field.AsString);
  consulta.Open;

  if consulta.IsEmpty then
  begin
    Application.MessageBox(PChar('É necessário cadastrar uma embalagem para o produto!'), 'Atenção', MB_ICONWARNING + MB_OK);
    Exit;
  end;

  If Self.bconfirma.Caption = 'Confirma' Then
  begin

    if cfocfop.Visible then
    begin
      if registro.State = dsbrowse then
      begin
        registro.Edit;
      end;

      registrocfocfopfora.AsString := '6' + copy(cfocfop.Field.AsString, 2, 4);

      if registrocfocfopfora.AsString = '6.405' then
        registrocfocfopfora.AsString := '6.403';

    end;

    salvacolunasframes;

    (* Valida foi cadastrado Variação para produto com Grade *)
    if registroprousagrade.AsInteger = 1 then
      if not PossuiVariacao then
      begin
        Application.MessageBox(PChar('É necessário cadastrar uma variação para o produto!'), 'Atenção', MB_ICONWARNING + MB_OK);
        Exit;
      end;

    { * ajusta valores no banco, e marca para enviar carga para pdvs * }
    consulta.Close;
    consulta.SQL.Text := 'UPDATE pro SET procarga = 1 WHERE procodigo = ' + registroprocodigo.AsString;
    consulta.ExecSQL;
  end;

  if Self.psituacao.Caption = 'Incluindo' then
  begin
    consulta.Close;
    consulta.SQL.Text := 'UPDATE pun SET imecodigo = ''PENDENTE'' WHERE procodigo = ' + registroprocodigo.AsString;
    consulta.ExecSQL;

  end;

  Inherited;

  if psituacao.Caption = 'Incluindo' then
  begin

    consulta.Close;
    consulta.SQL.Text := 'SELECT   spdchave,  spdexercicio,  spddatainicial,  spddatafinal,  spddatabalanco, ';
    consulta.SQL.Add('pcccodigo,   spdativo,  spdmotivoinv,  spdvalortotal,  spdarquivo,  spdgeracao,  flacodigo,  spdpasta, ');
    consulta.SQL.Add(' spdregistro,  spdenvio, spdregistro FROM spd order by spdchave limit 1');
    consulta.Open;

    if consulta.IsEmpty then
    begin
      vlSpdRegistro := agora(Application, zcone);

      vlSpdChave := 1;
      consulta.Append;
      consulta.FieldByName('spdchave').AsInteger := vlSpdChave;
      consulta.FieldByName('spdexercicio').AsString := FormatDateTime('yyyy', StrToDate(hoje(Application, zcone)));
      consulta.FieldByName('spddatainicial').AsFloat := StrToDate(hoje(Application, zcone));
      consulta.FieldByName('spddatafinal').AsFloat := EndOfTheMonth(consulta.FieldByName('spddatainicial').AsFloat);
      consulta.FieldByName('spddatabalanco').AsFloat := consulta.FieldByName('spddatafinal').AsFloat;
      consulta.FieldByName('pcccodigo').AsString := '1.01.03.01.01';
      consulta.FieldByName('spdativo').AsString := '1';
      consulta.FieldByName('spdregistro').AsString := vlSpdRegistro;
      consulta.FieldByName('flacodigo').AsString := acesso.Filial.ToString;
      consulta.Post;

      consulta.Close;
      consulta.SQL.Text := 'SELECT   ivtchave,  spdchave,  procodigo,  pcccodigo,  ivtquantidade,';
      consulta.SQL.Add('ivtvalor,   ivttotal,  ivtproprietario,  ivtdescricao,  etdcodigo,  flacodigo,ivtregistro FROM ivt limit 0');
      consulta.Open;

      consulta.Append;
      consulta.FieldByName('spdchave').AsInteger := vlSpdChave;
      consulta.FieldByName('procodigo').AsInteger := registroprocodigo.AsInteger;
      consulta.FieldByName('pcccodigo').AsString := '1.01.03.01.01';
      consulta.FieldByName('ivtquantidade').AsInteger := 0;
      consulta.FieldByName('ivtvalor').AsInteger := 0;
      consulta.FieldByName('ivttotal').AsInteger := 0;
      consulta.FieldByName('ivtproprietario').AsInteger := 1;
      consulta.FieldByName('ivtdescricao').AsString := 'Inventário de inclusão do produto';
      consulta.FieldByName('etdcodigo').AsString := '1';
      consulta.FieldByName('ivtregistro').AsString := vlSpdRegistro;
      consulta.FieldByName('flacodigo').AsString := acesso.Filial.ToString;
      consulta.Post;

      consulta.Close;
      consulta.SQL.Text := 'SELECT   ivdchave,  spdchave,  procodigo,  pcccodigo,  ivdquantidade,';
      consulta.SQL.Add('ivdvalor,   ivdtotal,  ivdproprietario,  ivddescricao,  etdcodigo,  flacodigo, ivdregistro FROM ivd limit 0');
      consulta.Open;

      consulta.Append;
      consulta.FieldByName('spdchave').AsInteger := vlSpdChave;
      consulta.FieldByName('procodigo').AsInteger := registroprocodigo.AsInteger;
      consulta.FieldByName('pcccodigo').AsString := '1.01.03.01.01';
      consulta.FieldByName('ivdquantidade').AsInteger := 0;
      consulta.FieldByName('ivdvalor').AsInteger := 0;
      consulta.FieldByName('ivdtotal').AsInteger := 0;
      consulta.FieldByName('ivdproprietario').AsInteger := 1;
      consulta.FieldByName('ivddescricao').AsString := 'Inventário de inclusão do produto';
      consulta.FieldByName('etdcodigo').AsString := '1';
      consulta.FieldByName('ivdregistro').AsString := vlSpdRegistro;
      consulta.FieldByName('flacodigo').AsString := acesso.Filial.ToString;
      consulta.Post;

    end
    else
    begin
      vlSpdChave := consulta.FieldByName('spdchave').AsInteger;
      vlSpdRegistro := consulta.FieldByName('spdregistro').AsString;
      consulta.Close;
      consulta.SQL.Text := 'SELECT   ivtchave,  spdchave,  procodigo,  pcccodigo,  ivtquantidade,';
      consulta.SQL.Add('ivtvalor,   ivttotal,  ivtproprietario,  ivtdescricao,  etdcodigo,  flacodigo, ivtregistro FROM ivt limit 0');
      consulta.Open;

      consulta.Append;
      consulta.FieldByName('spdchave').AsInteger := vlSpdChave;
      consulta.FieldByName('procodigo').AsInteger := registroprocodigo.AsInteger;
      consulta.FieldByName('pcccodigo').AsString := '1.01.03.01.01';
      consulta.FieldByName('ivtquantidade').AsInteger := 0;
      consulta.FieldByName('ivtvalor').AsInteger := 0;
      consulta.FieldByName('ivttotal').AsInteger := 0;
      consulta.FieldByName('ivtproprietario').AsInteger := 1;
      consulta.FieldByName('ivtdescricao').AsString := 'Inventário de inclusão do produto';
      consulta.FieldByName('etdcodigo').AsString := '1';
      consulta.FieldByName('ivtregistro').AsString := vlSpdRegistro;
      consulta.FieldByName('flacodigo').AsString := acesso.Filial.ToString;

      consulta.Post;

      consulta.Close;
      consulta.SQL.Text := 'SELECT   ivdchave,  spdchave,  procodigo,  pcccodigo,  ivdquantidade,';
      consulta.SQL.Add('ivdvalor,   ivdtotal,  ivdproprietario,  ivddescricao,  etdcodigo,  flacodigo, ivdregistro FROM ivd limit 0');
      consulta.Open;

      consulta.Append;
      consulta.FieldByName('spdchave').AsInteger := vlSpdChave;
      consulta.FieldByName('procodigo').AsInteger := registroprocodigo.AsInteger;
      consulta.FieldByName('pcccodigo').AsString := '1.01.03.01.01';
      consulta.FieldByName('ivdquantidade').AsInteger := 0;
      consulta.FieldByName('ivdvalor').AsInteger := 0;
      consulta.FieldByName('ivdtotal').AsInteger := 0;
      consulta.FieldByName('ivdproprietario').AsInteger := 1;
      consulta.FieldByName('ivddescricao').AsString := 'Inventário de inclusão do produto';
      consulta.FieldByName('etdcodigo').AsString := '1';
      consulta.FieldByName('ivdregistro').AsString := vlSpdRegistro;;

      consulta.FieldByName('flacodigo').AsString := acesso.Filial.ToString;
      consulta.Post;

    end;

  end;
  if bconfirma.Caption = 'Confirma' then
  begin
    SalvarSTG('pro', 'procodigo');
  end;

  if not(ModalResult = mrOk) then
    Exit;
end;

procedure Tfpro.btBuscaCESTClick(Sender: TObject);
var
  vltcecodigo: Integer;
begin
  inherited;
  criabusca(procest, registrotcedescricao);
  procest.Hint := registrotcedescricao.AsString;

  if procest.Field.AsString <> '' then
  begin
    consulta.Close;
    consulta.SQL.Text := 'select tcecest from tce where tcechave=' + procest.Field.AsString;
    consulta.Open;

    if consulta.RecordCount = 1 then
    begin
      procest.Field.AsString := consulta.FieldByName('tcecest').AsString;
    end;

  end;

end;

procedure Tfpro.btBuscaNCMClick(Sender: TObject);
begin
  inherited;
  criabusca(proncm, registrotcgdescricao);
  proncm.Hint := registrotcgdescricao.AsString;

end;

procedure Tfpro.btCarregaImagemClick(Sender: TObject);
var
  BlobField: TBlobField;
  FileName: string;
begin

  if OpenPictureDialog.Execute then
  begin

    if registro.State = dsbrowse then
      registro.Edit;

    BlobField := registro.FieldByName('proimagem') as TBlobField;
    FileName := OpenPictureDialog.FileName;
    BlobField.LoadFromFile(FileName);
  end;

end;

procedure Tfpro.bvalidarClick(Sender: TObject);
var
  podepun: Boolean;
  podeprf: Boolean;
  fra: Tfrapun;
  vlfrapco: Tfrapco;

  i: Integer;

begin
  if registroprobalanca.AsString = '' then
    registroprobalanca.AsInteger := 0;

  if registroprocomposto.AsString = '' then
    registroprocomposto.AsInteger := 0;

  if registrotrbcodigo.AsString = '' then
    registrotrbcodigo.AsInteger := 1;

  if registroprobalanca.AsString = '' then
    registroprobalanca.AsInteger := 0;

  if registroprovalidade.AsString = '' then
    registroprovalidade.AsInteger := 0;

  if registrosipcodigo.AsString = '' then
    registrosipcodigo.AsInteger := 1;

  if registroprousagrade.AsString = '' then
    registroprousagrade.AsInteger := 0;

  if registroprocontabiliza.AsString = '' then
    registroprocontabiliza.AsInteger := 1;

  if registromarcodigo.AsString = '' then
    registromarcodigo.AsInteger := 1;

  if registroicmcodigo.AsString = '' then
    registroicmcodigo.AsString := '00';

  if registroproremoto.AsString = '' then
    registroproremoto.AsInteger := 1;

  if registroproalterarqtd.AsString = '' then
    registroproalterarqtd.AsInteger := 1;

  if registroproproducao.AsString = '' then
    registroproproducao.AsInteger := 0;

  if registropadcodigo.AsString = '' then
    registropadcodigo.AsInteger := 1;

  (*
    ** Atribui valores para Unidade e Quantidade Tributária se estiver desabilitada **
  *)

  if cfgcfgunitrib.AsInteger <> 1 then
  begin
    Self.registroprounitrib.AsInteger := Self.registrounicodigo.AsInteger;
    Self.registroproqtdtrib.AsInteger := 1;
  end;

  inherited;

  if not ValidaCamposRequeridos then
    Exit;

  Self.bvalidar.Visible := False;

  If (Self.registro.State in [dsEdit, dsInsert]) Then
    Self.registro.Post;

  consulta.Close;
  consulta.SQL.Text := 'UPDATE pun, pro ';
  consulta.SQL.Add('SET pun.pununitrib = pro.prounitrib, ');
  consulta.SQL.Add('pun.punqtdtrib = pro.proqtdtrib * pun.punmultiplicador ');
  consulta.SQL.Add('WHERE pro.procodigo = pun.procodigo AND ');
  consulta.SQL.Add('pun.procodigo = :procodigo;');
  consulta.Params[0].AsInteger := procodigo.Field.AsInteger;
  consulta.ExecSQL;

  unicodigo.Enabled := true;
  bconfirma.Enabled := true;

  hpun := CarregaFrame('mpun', PlPun, 'Produtos');
  podepun := true;
  fra := nil;
  fra := Tfrapun(Application.FindComponent('frapun'));

  if Self.psituacao.Caption = 'Incluindo' then
  begin
    if fra <> nil then
      if (fra is Tfrapun) then
        if (fra as Tfrapun).vretorno = '0' then
        begin
          podepun := False;
          Self.psituacao.Caption := 'Cancelando';
        end;
  end
  else
  begin
    podepun := true;
  end;

  if cpb.Active then
  begin
    if cpb.State <> dsbrowse then
      cpb.Post;

  end;

  podeprf := False;

  podeprf := true;

  if psituacao.Caption = 'Incluindo' then
  begin
    if procomposto.Field.AsString <> '' then
    begin
      If procomposto.Field.AsInteger = 0 Then
      Begin
        composicao.TabVisible := False;

        if hpco <> 0 then
        begin
          vlfrapco := nil;
          vlfrapco := Tfrapco(Application.FindComponent('frapco'));
          if vlfrapco <> nil then
            if (vlfrapco is Tfrapco) then
              (vlfrapco as Tfrapco).salvacolunas;
        end;

        Self.ajustabotoes;
      End
      Else
      Begin
        composicao.TabVisible := true;
        Self.ajustabotoes;

        if hpco = 0 then
          hpco := CarregaFrame('mpco', Plpco, 'Produtos', Self.registroprocodigo.AsString);
      End;
    end;

  end;

  if Situacao = 'Incluindo' then
    SelectNext(fra, true, true);

  if (podepun = False) or (podeprf = False) then
    Self.bcancela.Click;
end;

procedure Tfpro.cfocfopExit(Sender: TObject);
begin
  inherited;
  if Self.ActiveControl = bcancela then
  begin
    Exit;
  end;

  Self.ValidaSaida(Sender);

  consulta.Close;
  consulta.SQL.Text := 'select cfocfop from cfo where cfocfop=' + QuotedStr(cfocfop.Field.AsString);
  consulta.Open;

  if consulta.IsEmpty then
  begin
    Showmessage('Código de CFOP inválido!');
    cfocfop.SetFocus;
    Exit
  end;

  if cfocfop.Field.AsString = '5.405' then
  begin
    if cfgcrtcodigo.AsInteger = 1 then
    begin
      cstcodigo.Field.AsString := '500';
    end
    else
    begin
      cstcodigo.Field.AsString := '060';
    end;

    if not icmcodigofora.Visible then
      icmcodigofora.Field.AsString := '00';

    cstcodigo.Enabled := False;
    cstcodigo.ReadOnly := true;
    cstcodigo.TabStop := False;

    propercreducaobaseicm.Field.AsFloat := 0;
    propercreducaobaseicm.Enabled := False;
    propercreducaobaseicm.ReadOnly := true;
    propercreducaobaseicm.TabStop := False;

    icmcodigo.Field.AsString := '00';
    icmcodigo.Enabled := False;
    icmcodigo.ReadOnly := true;
    icmcodigo.TabStop := False;

    if bvalidar.Visible then
      bvalidar.SetFocus;

  end
  else
  begin
    if icmcodigofora.Visible then
      icmcodigofora.Field.AsString := '12';

    propercreducaobaseicm.Enabled := False;
    propercreducaobaseicm.ReadOnly := true;
    propercreducaobaseicm.TabStop := False;

    cstcodigo.Enabled := true;
    cstcodigo.ReadOnly := False;
    cstcodigo.TabStop := true;

    propercreducaobaseicm.Enabled := true;
    propercreducaobaseicm.ReadOnly := False;
    propercreducaobaseicm.TabStop := true;

    icmcodigo.Enabled := true;
    icmcodigo.ReadOnly := False;
    icmcodigo.TabStop := true;

    if psituacao.Caption = 'Incluindo' then
    begin
      cstcodigo.Field.AsString := '';
    end;

    icmcodigo.SetFocus;

  end;

  if psituacao.Caption = 'Alterando' then
  begin
    if cfocfop.Field.AsString = '5.102' then
    begin
      if cfgcrtcodigo.AsInteger = 1 then
      begin
        cstcodigo.Field.AsString := '102';
      end
      else
      begin
        cstcodigo.Field.AsString := '000';
      end;
    end;
  end;

end;

procedure Tfpro.cpbAfterInsert(DataSet: TDataSet);
begin
  inherited;
  Self.cpbprocodigo.AsString := Self.procodigo.Field.AsString;
  Self.cpbcpbsetor.AsInteger := 1;
  Self.cpbcpbuniadesporkg.AsInteger := 1;

end;

procedure Tfpro.cpbcodbalancaEnter(Sender: TObject);

var
  vlLimiteCodBalanca: string;
begin
  inherited;

  { Verificação do limite maximo de código para balança }
  if (cfgcfgdigitosbalanca.AsString = '') or (cfgcfgdigitosbalanca.AsString = '0') then
  begin
    Showmessage('Falta definição em configurações para códigos de balança!');
    Exit;
  end;

  cpbcodbalanca.MaxLength := cfgcfgdigitosbalanca.AsInteger;

  if psituacao.Caption = 'Incluindo' then
  begin
    registro.Post;
    registro.Edit;
  end;

  cpb.Close;
  cpb.Params[0].AsInteger := Self.procodigo.Field.AsInteger;
  cpb.Open;

  if cpb.IsEmpty then
  begin
    cpb.Append;

    consulta.Close;
    consulta.SQL.Text := 'select max(cpbcodbalanca) from cpb';
    consulta.Open;

    cpbprocodigo.AsInteger := Self.procodigo.Field.AsInteger;
    cpbcpbcodbalanca.AsInteger := Self.consulta.fields[0].AsInteger + 1;

  end
  else
  begin
    cpb.Edit;
  end;
  cpbcodbalanca.SelectAll;

end;

procedure Tfpro.cpbcodbalancaExit(Sender: TObject);
var
  vlLimiteCodBalanca: string;
begin
  inherited;
  Self.ValidaSaida(Sender);

  { Verificação do limite maximo de código para balança }
  if (cfgcfgdigitosbalanca.AsString = '') or (cfgcfgdigitosbalanca.AsString = '0') then
  begin
    Showmessage('Falta definição em configurações para códigos de balança!');
    Exit;
  end;

  vlLimiteCodBalanca := '99999999';
  vlLimiteCodBalanca := copy(vlLimiteCodBalanca, 1, cfgcfgdigitosbalanca.AsInteger);

  if cpbcodbalanca.Field.AsInteger > strtoint(vlLimiteCodBalanca) then
  begin
    Showmessage('Código acima do limite definido para códigos de balança:' + #13 + 'Código máximo definido em configurações ' + vlLimiteCodBalanca);
    cpbcodbalanca.Field.AsString := '';
    cpbcodbalanca.SetFocus;
    Exit;
  end;

  consulta.Close;
  consulta.SQL.Text := 'select cpbcodbalanca,procodigo from cpb where procodigo<>' + procodigo.Field.AsString + ' and cpbcodbalanca=' +
    cpbcodbalanca.Field.AsString;
  consulta.Open;
  if not consulta.IsEmpty then
  begin
    Showmessage('O produto : ' + consulta.fields[0].AsString + ' já esta usando este código de balança!');
    cpbcodbalanca.Field.AsString := '';
    cpbcodbalanca.SetFocus;
  end;

end;

procedure Tfpro.cstcodigoExit(Sender: TObject);
begin
  inherited;

  if Self.ActiveControl = bcancela then
  begin
    Exit;
  end;

  Self.ValidaSaida(Sender);

  consulta.Close;
  consulta.SQL.Text := 'select cfocfop from cfo where cfocfop=' + QuotedStr(cfocfop.Field.AsString);
  consulta.Open;

  if consulta.IsEmpty then
  begin
    Showmessage('Código de CFOP inválido!');
    cfocfop.SetFocus;
    Exit
  end;

  if cfocfop.Field.AsString = '5.405' then
  begin
    if cfgcrtcodigo.AsInteger = 1 then
    begin
      cstcodigo.Field.AsString := '500';
    end
    else
    begin
      cstcodigo.Field.AsString := '060';
    end;
  end;

end;

procedure Tfpro.DSRegistroDataChange(Sender: TObject; Field: TField);
var
  fra: Tframe;
begin
  inherited;

  if procomposto.Field.AsString <> '' then
  begin
    If procomposto.Field.AsInteger = 0 Then
    Begin
      composicao.TabVisible := False;

      if hpco <> 0 then
      begin
        fra := nil;
        fra := Tfrapco(Application.FindComponent('frapco'));
        if fra <> nil then
          if (fra is Tfrapco) then
            (fra as Tfrapco).salvacolunas;
      end;

      Self.ajustabotoes;
    End
    Else
    Begin
      if psituacao.Caption = 'Alterando' then
      begin
        composicao.TabVisible := true;
        Self.ajustabotoes;

        if hpco = 0 then
          hpco := CarregaFrame('mpco', Plpco, 'Produtos', Self.registroprocodigo.AsString);
      end;
    End;
  end;

  if Self.proncm.Field.AsString <> '' then
  begin
    Self.tcg.Close;
    Self.tcg.Params[0].AsString := Self.proncm.Field.AsString;
    Self.tcg.Open;
  end;

end;

procedure Tfpro.enpBeforeOpen(DataSet: TDataSet);
begin
  inherited;
  enp.ParamByName('flacodigo').AsInteger := acesso.Filial;

end;

procedure Tfpro.enpcodigoEnter(Sender: TObject);
begin
  inherited;
  txtFiltro := 'flacodigo=' + acesso.Filial.ToString;

end;

procedure Tfpro.enpcodigoExit(Sender: TObject);
begin
  ValidaSaida(Sender);

end;

procedure Tfpro.FormCreate(Sender: TObject);
begin
  inherited;
  Plimagem.TabVisible := False;
end;

procedure Tfpro.FormShow(Sender: TObject);
begin

  IdModulo := vPlIdMd;

  cfg.Close;
  cfg.Params[0].AsInteger := acesso.Filial;
  cfg.Open;

  if cfgcfgproducaopropria.AsInteger = 1 then
  begin

    proproducao.Visible := true;
    registroproproducao.Required := true;
    proproducao.Color := PEG_COR_VALORREQUERIDO;
  end
  else
  begin

    proproducao.Visible := False;
    proproducao.Color := clWhite;
    registroproproducao.Required := False;
  end;

  if cfgcfgcompro.AsInteger = 0 then
  begin
    procomposto.Visible := False;
    lpprocomposto.Visible := False;
    gbComposto.Visible := False;
  end;

  if cfgcfgdiferencialaliquota.AsInteger = 1 then
  begin
    padcodigo.Visible := true;
    labdifealiquota.Visible := true;

  end
  else
  begin
    padcodigo.Visible := False;
    labdifealiquota.Visible := False;
  end;

  if cfgcfgproducaopropria.AsInteger = 1 then
  begin
    ltitutloproproducao.Visible := true;
    proproducao.Visible := true;
  end
  else
  begin
    ltitutloproproducao.Visible := False;
    proproducao.Visible := False;

  end;

  { if (Plprf.Visible = False) and (Self.Height < 710) then
    Self.Height := 710; }

  if cfgcfgbalanca.AsInteger = 0 then
  begin

    cpbcodbalanca.Visible := False;
    lcpbcodbalanca.Visible := False;

    probalanca.Visible := False;
    lpprobalanca.Visible := False;
    gbbalanca.Visible := False;
  end;

  try

    if cfgcfgprocodigoauto.AsInteger = 0 then
    begin
      procodigo.Enabled := true;
      procodigo.Color := PEG_COR_VALORREQUERIDO;
      procodigo.SetFocus;
      procodigo.ReadOnly := False;
    end
    else
      pronome.SetFocus;

  except

  end;

  if psituacao.Caption = 'Alterando' then
  begin
    cpb.Close;
    cpb.Params[0].AsInteger := Self.procodigo.Field.AsInteger;
    cpb.Open;

    AjustaProdutoPesado;
  end;

  { * código individual para cst/csosn* }
  registrocstcodigo.Required := true;
  cstcodigo.Visible := true;
  lbcstcodigo.Visible := true;
  gbCSTCodigo.Visible := true;
  registrocfocfop.Required := true;

  if cfgcfgdiferencialaliquota.AsInteger = 1 then
  begin
    padcodigo.Visible := true;
    labdifealiquota.Visible := true;
    gbDados.Height := 164;

  end
  else
  begin
    padcodigo.Visible := False;
    labdifealiquota.Visible := False;
    gbDados.Height := 134;
  end;




 { * código individual para cst IPI* }
  if cfgcfgusacsinoproduto.AsInteger = 1 then
  begin
    registrocsicodigo.Required := True;
    csicodigo.Visible := True;
    lbcsicodigo.Visible := True;
    gbcsicodigo.Visible := True;
  end
  else
  begin
    registrocsicodigo.Required := False;
    csicodigo.Visible := False;
    lbcsicodigo.Visible := False;
    gbcsicodigo.Visible := False;
  end;

  { * código individual para cst PIS* }

  if cfgcfgusacspnoproduto.AsInteger = 1 then
  begin
    registrocspcodigo.Required := True;
    cspcodigo.Visible := True;
    lbcspcodigo.Visible := True;
    gbcspcodigo.Visible := True;
  end
  else
  begin
    registrocspcodigo.Required := False;
    cspcodigo.Visible := False;
    lbcspcodigo.Visible := False;
    gbcspcodigo.Visible := False;
  end;

  { * código individual para cst COFINS* }
  if cfgcfgusacsfnoproduto.AsInteger = 1 then
  begin
    registrocsfcodigo.Required := True;
    csfcodigo.Visible := True;
    lbcsfcodigo.Visible := True;
    gbcsfcodigo.Visible := True;
  end
  else
  begin
    registrocsfcodigo.Required := False;
    csfcodigo.Visible := False;
    lbcsfcodigo.Visible := False;
    gbcsfcodigo.Visible := False;
  end;


    if cfgcfgprodefineicms.AsInteger = 0 then
  begin
    icmcodigo.Visible := False;
    LbIcmCodigo.Visible := False;
    gbICMS.Visible := False;

  end
  else
  begin
    icmcodigo.Visible := True;
    LbIcmCodigo.Visible := True;
    gbICMS.Visible := True;

  end;


  { * código individual para cst/csosn* }
  if cfgcfgusacstnoproduto.AsInteger = 1 then
  begin
    registrocstcodigo.Required := True;
    cstcodigo.Visible := True;
    lbcstcodigo.Visible := True;
    gbCSTCodigo.Visible := True;
    registrocfocfop.Required := True;
  end
  else
  begin
    registrocstcodigo.Required := False;
    cstcodigo.Visible := False;
    lbcstcodigo.Visible := False;
    gbCSTCodigo.Visible := False;
    registrocfocfop.Required := False;
  end;





  if cfgcfgunitrib.AsInteger = 0 then
  begin
    prounitrib.Visible := False;
    plprounitrib.Visible := False;

    plproqtdtrib.Visible := False;
    proqtdtrib.Visible := False;
    gbUnidadeTributaria.Visible := False;

  end;

  if cfgcfgcompro.AsInteger = 0 then
  begin
    procomposto.Visible := False;
    lpprocomposto.Visible := False;
    gbComposto.Visible := False;
  end;

  icmcodigo.Visible := true;
  LbIcmCodigo.Visible := true;
  gbICMS.Visible := true;

  { if (Plprf.Visible = False) and (Self.Height < 710) then
    Self.Height := 710; }

  if psituacao.Caption = 'Alterando' then
  begin
    cpb.Close;
    cpb.Params[0].AsInteger := Self.procodigo.Field.AsInteger;
    cpb.Open;

    AjustaProdutoPesado;
  end;

  try
    if cfgcfgprocodigoauto.AsInteger = 0 then
    begin
      procodigo.Enabled := true;
      procodigo.Color := PEG_COR_VALORREQUERIDO;
      procodigo.SetFocus;
      procodigo.ReadOnly := False;
    end
    else
      pronome.SetFocus;

  except

  end;

  inherited;

  vunibase := unicodigo.Field.AsString;

  if proncm.Field.AsString <> '' then
  begin
    tcg.Params[0].AsString := Self.proncm.Field.AsString;
    tcg.Open;
  end;
  ImgBusca.GetBitmap(0, btBuscaNCM.Glyph);


  if procest.Field.AsString <> '' then
  begin
    tce.Params[0].AsString := Self.procest.Field.AsString;
    tce.Open;
  end;

  ImgBusca.GetBitmap(0, btBuscaCEST.Glyph);




  VerificaValidacoes;

end;

procedure Tfpro.icmcodigoExit(Sender: TObject);
begin
  inherited;
  if Self.ActiveControl = bcancela then
  begin
    Exit;
  end;

  Self.ValidaSaida(Sender);

  consulta.Close;
  consulta.SQL.Text := 'select icmaliquotas from icm where icmcodigo=' + QuotedStr(icmcodigo.Field.AsString);
  consulta.Open;

  if consulta.IsEmpty then
  begin
    Showmessage('Código de ICM inválido!');
    icmcodigo.SetFocus;
    Exit
  end;

end;

procedure Tfpro.icmcodigoforaExit(Sender: TObject);
begin
  inherited;

  if Self.ActiveControl = bcancela then
  begin
    Exit;
  end;

  Self.ValidaSaida(Sender);

  consulta.Close;
  consulta.SQL.Text := 'select icmaliquotas from icm where icmcodigo=' + QuotedStr(icmcodigofora.Field.AsString);
  consulta.Open;

  if consulta.IsEmpty then
  begin
    Showmessage('Código de ICM inválido!');
    icmcodigofora.SetFocus;
    Exit
  end;

end;

procedure Tfpro.paginasChange(Sender: TObject);
begin
  { inherited; }
  ajustabotoes;
end;

function Tfpro.PossuiVariacao: Boolean;
begin
  consulta.Close;
  consulta.SQL.Text := 'SELECT vrp.vrpcodigo FROM vrp WHERE vrp.procodigo = ' + registroprocodigo.AsString;
  consulta.Open;

  Result := not consulta.IsEmpty;
  consulta.Close;
end;

procedure Tfpro.probalancaExit(Sender: TObject);
begin
  inherited;

  Self.ValidaSaida(Sender);

  AjustaProdutoPesado;

end;

procedure Tfpro.AjustaProdutoPesado;
begin
  if probalanca.Field.AsInteger = 1 then
  begin
    cpbcodbalanca.Visible := true;
    lcpbcodbalanca.Visible := true;
  end
  else
  begin
    cpbcodbalanca.Visible := False;
    lcpbcodbalanca.Visible := False;
  end;

end;

procedure Tfpro.procestExit(Sender: TObject);
begin
  inherited;
  if Self.procest.Field.AsString <> '' then
  begin
    Self.tce.Close;
    Self.tce.Params[0].AsString := Self.procest.Field.AsString;
    Self.tce.Open;
  end;

  if Self.ActiveControl = btBuscaCEST then
  begin
    Self.procest.Field.AsString := '';
    Exit;
  end;

  if Self.ActiveControl = bcancela then
  begin
    Exit;
  end;

  // Self.ValidaSaida(Sender);

  if not(Self.tpocodigo.Field.AsInteger IN [tpoMaterialUsoConsumo, tpoAtivoImobilizado, tpoServicos, tpoOutras]) then
  begin
    if Self.procest.Field.AsString <> '' then
    begin
      Self.tce.Close;
      Self.tce.Params[0].AsString := Self.procest.Field.AsString;
      Self.tce.Open;

      if tce.RecordCount = 0 then
      begin
        Showmessage('ATENÇÃO: CEST inválido, não foi localizada!');
        procest.SetFocus;
      end;
    end;
  end;

end;

procedure Tfpro.procestKeyPress(Sender: TObject; var Key: Char);
begin
  inherited;
  Self.FormKeyPress(Sender, Key);
  if not(Key in [#0, #13, #8, #3, #$16, '0' .. '9']) then
    Key := #0;

end;

procedure Tfpro.procodigoExit(Sender: TObject);
begin
  inherited;
  if Self.psituacao.Caption = 'Incluindo' then
  begin
    consulta.Close;
    consulta.SQL.Text := 'select pronome from pro where procodigo=' + Self.procodigo.Field.AsString;
    consulta.Open;
    try
      if not consulta.IsEmpty then
      begin
        Showmessage('Produto ja cadastrado: ' + consulta.fields[0].AsString);
        consulta.Close;
        procodigo.Field.AsString := '';
        procodigo.SetFocus;
      end
      else
        Self.pronome.SetFocus;
    except

    end;
  end;

end;

procedure Tfpro.procompostoClick(Sender: TObject);
begin
  inherited;

  If procomposto.Field.AsInteger = 0 Then
    composicao.TabVisible := False
  Else
    composicao.TabVisible := true;
end;

procedure Tfpro.procompostoEnter(Sender: TObject);
begin
  inherited;
  procomposto.SetFocus;
end;

procedure Tfpro.proestoqueEnter(Sender: TObject);
begin
  inherited;
  proestoque.Font.Style := [fsBold];
end;

procedure Tfpro.proestoqueExit(Sender: TObject);
begin
  inherited;
  proestoque.Font.Style := [];
  Self.ValidaSaida(Sender);
end;

procedure Tfpro.proncmExit(Sender: TObject);
begin
  inherited;
  if Self.proncm.Field.AsString <> '' then
  begin
    Self.tcg.Close;
    Self.tcg.Params[0].AsString := Self.proncm.Field.AsString;
    Self.tcg.Open;
  end;

  if Self.ActiveControl = btBuscaNCM then
  begin
    Self.proncm.Field.AsString := '';
    Exit;
  end;

  if Self.ActiveControl = bcancela then
  begin
    Exit;
  end;

  Self.ValidaSaida(Sender);

  if not(Self.tpocodigo.Field.AsInteger IN [tpoMaterialUsoConsumo, tpoAtivoImobilizado, tpoServicos, tpoOutras]) then
  begin
    if Self.proncm.Field.AsString <> '' then
    begin
      Self.tcg.Close;
      Self.tcg.Params[0].AsString := Self.proncm.Field.AsString;
      Self.tcg.Open;

      if tcg.RecordCount = 0 then
      begin
        Showmessage('ATENÇÃO: NCM inválido, não foi localizada alíquota para este NCM!');
        proncm.SetFocus;
      end;
    end;
  end;
end;

procedure Tfpro.proncmKeyPress(Sender: TObject; var Key: Char);
begin
  Self.FormKeyPress(Sender, Key);
  if not(Key in [#0, #13, #8, #3, #$16, '0' .. '9']) then
    Key := #0;
end;

procedure Tfpro.pronomereduzidoEnter(Sender: TObject);
begin
  inherited;
  if registro.State = dsbrowse then
    registro.Edit;

  if Self.psituacao.Caption = 'Incluindo' then
    Self.pronomereduzido.Field.AsString := Self.pronome.Field.AsString;
end;

procedure Tfpro.pronumserieEnter(Sender: TObject);
begin
  inherited;
  // pronumserie.SetFocus;
end;

procedure Tfpro.prounitribEnter(Sender: TObject);
begin
  inherited;
  Self.txtFiltro := ' tuncodigo=' + IntToStr(tunSaida) + ' or tuncodigo=' + IntToStr(tunAmbos);
  Uni.Filter := Self.txtFiltro;
  Uni.Filtered := true;

  If psituacao.Caption = 'Incluindo' Then
  Begin
    Self.prounitrib.Text := Self.unicodigo.Text;
    Self.proqtdtrib.Field.AsFloat := 1;
  End;

end;

procedure Tfpro.registroAfterInsert(DataSet: TDataSet);
begin
  inherited;

  registroprobalanca.AsInteger := 0;
  registropronumserie.AsInteger := 0;
  registroprocomposto.AsInteger := 0;
  registroicmcodigo.AsString := '00';
  registrotrbcodigo.AsInteger := 1;
  registroprobalanca.AsInteger := 0;
  registroprovalidade.AsInteger := 0;
  registrosipcodigo.AsInteger := 1;
  registropropededescrserv.AsInteger := 1;
  registropropedetecnicoserv.AsInteger := 0;
  registroprousagrade.AsInteger := 0;
  registroprocontabiliza.AsInteger := 1;
  registrocstcodigo.AsString := cfgcstcodigo.AsString;
  registrocsicodigo.AsString := cfgcsicodigo.AsString;
  registrocspcodigo.AsString := cfgcspcodigo.AsString;
  registrocsfcodigo.AsString := cfgcsfcodigo.AsString;
  registroproproducao.AsInteger := 0;
  registropadcodigo.AsInteger := 1;
  registropropercfcp.AsFloat := 0;
  registropropercreducaobaseicm.AsFloat := 0;
  registropromva.AsFloat := 0;

  if cfgcrtcodigo.AsInteger = 1 then
  begin
    registroicmcodigofora.AsString := '00';
  end
  else
  begin
    registroicmcodigofora.AsString := '12';
  end;

end;

function Tfpro.TemMovimentacao: Boolean;
var
  loTemMov: Boolean;
begin
  loTemMov := False;

  if Self.procodigo.Field.AsString <> '' then
  begin
    consulta.Close;
    consulta.SQL.Text := 'SELECT COUNT(itmchave) FROM itm WHERE procodigo = ' + Self.procodigo.Field.AsString;
    consulta.Open;

    if consulta.fields[0].AsFloat > 0 then
      loTemMov := true;

    { consulta.Close;
      consulta.SQL.Text := 'SELECT COUNT(ivtchave) FROM ivt WHERE procodigo = ' + Self.procodigo.Field.AsString;
      consulta.Open;

      if consulta.fields[0].AsFloat > 0 then
      loTemMov := True; }

    consulta.Close;
  end;

  Result := loTemMov;
end;

procedure Tfpro.tpocodigoExit(Sender: TObject);
begin
  inherited;

  Self.ValidaSaida(Sender);

  if (Self.tpocodigo.Field.AsInteger IN [tpoServicos]) then
  begin
    proncm.Field.AsString := '00000000';
    proncm.Color := PEG_COR_VALORPADRAO;
    proncm.Enabled := False;
    proncm.Field.Required := False;
  end
  else
  begin
    proncm.Enabled := true;
    proncm.Color := PEG_COR_VALORREQUERIDO;
    proncm.Field.Required := true;
  end;

end;

procedure Tfpro.VerificaValidacoes;
begin
  if TemMovimentacao then
  begin
    platencao.Caption := 'ATENÇÃO: Produto já possui movimentação!';
    platencao.Visible := true;

    Self.txtFiltro := ' tuncodigo=' + IntToStr(tunSaida) + ' or tuncodigo=' + IntToStr(tunAmbos);
    Uni.Filter := Self.txtFiltro;
    Uni.Filtered := true;

    unicodigo.Enabled := False;
    unicodigo.ReadOnly := true;
  end
  else
  begin
    platencao.Caption := '';
    platencao.Visible := False;

    Self.txtFiltro := ' tuncodigo=' + IntToStr(tunSaida) + ' or tuncodigo=' + IntToStr(tunAmbos);
    Uni.Filter := Self.txtFiltro;
    Uni.Filtered := true;

    unicodigo.ReadOnly := False;
    unicodigo.Enabled := true;
  end;

  if (Self.tpocodigo.Field.AsInteger IN [tpoMaterialUsoConsumo, tpoAtivoImobilizado, tpoServicos, tpoOutras]) then
  begin
    proncm.Color := PEG_COR_VALORPADRAO;
    proncm.Enabled := False;
    proncm.Field.Required := False;
  end;

end;

end.
