unit uftefwifi;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Uni, Data.DB, DBAccess, MemDS, Json,Jsons,RESTRequest4D,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,upegabase,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,System.Math,
  Vcl.ExtCtrls, FireDAC.Comp.DataSet, FireDAC.Comp.Client, ufuncoes;

type
  Tftefwifi = class(TForm)
    rfm: TUniQuery;
    rfmrfmchave: TIntegerField;
    rfmrfichave: TIntegerField;
    rfmmeschave: TIntegerField;
    rfmflacodigo: TIntegerField;
    rpwemaberto: TUniQuery;
    rpwemabertorpwchave: TIntegerField;
    rpwemabertorpwjson: TMemoField;
    rctolt: TUniQuery;
    rctoltrctnrauto: TStringField;
    rctoltrctvalor: TCurrencyField;
    rctoltrctrede: TStringField;
    etd: TUniQuery;
    DSMor: TDataSource;
    mor: TUniQuery;
    mormorchave: TIntegerField;
    mormeschave: TIntegerField;
    mororcchave: TIntegerField;
    cfgmcfg: TUniQuery;
    cfgmcfgetdapelido: TStringField;
    cfgmcfgmodonfe: TStringField;
    cfgmcfgdtAtual: TDateField;
    cfgmcfgcfgmgoupedidounificado: TIntegerField;
    cfgmcfgcfgmgouproatendimento: TIntegerField;
    cfgmcfgcfgmgoutaxaatendimento: TFloatField;
    cfgmcfgcfgviascomprovante: TIntegerField;
    cfgmcfgflacodigo: TIntegerField;
    cfgmcfgcfgdigitosbalanca: TIntegerField;
    cfgmcfgcfgetiquetabalanca: TIntegerField;
    cfgmcfgcfgusapdv: TIntegerField;
    cfgmcfgcfgmgouttulocomposicao: TStringField;
    cfgmcfgcfgmgouproatendimentoparcial: TIntegerField;
    cfgmcfgcfgcontrolalimite: TIntegerField;
    cfgmcfgcfgprevisualizarimpressao: TIntegerField;
    cfgmcfgcfgmgounomelocal: TStringField;
    cfgmcfgcfgmgouqtdmesas: TIntegerField;
    cfgmcfgcfgmgoufinalizadelivery: TIntegerField;
    cfgmcfgcfgusaadc: TIntegerField;
    cfgmcfgcfgnumecertif: TStringField;
    cfgmcfgcfgsenhacertificadoa1: TStringField;
    cfgmcfgcfgctacaixa: TIntegerField;
    cfgmcfgcfgctacodigopix: TIntegerField;
    cfgmcfgcfgusanfe: TIntegerField;
    cfgmcfgcfgusanfc: TIntegerField;
    cfgmcfgcfgusaafaturar: TIntegerField;
    olt: TUniQuery;
    oltoltchave: TIntegerField;
    oltorcchave: TIntegerField;
    oltltechave: TIntegerField;
    oltoltidentificacao: TStringField;
    oltolttipo: TIntegerField;
    rpw: TUniQuery;
    rpwrpwchave: TIntegerField;
    rpwrpwtoken: TStringField;
    rpwrpwmesa: TStringField;
    rpwrpwstatus: TStringField;
    rpworcchave: TIntegerField;
    rpwcznchave: TIntegerField;
    rpwrpwjson: TMemoField;
    mes: TUniQuery;
    clt: TUniQuery;
    cltcltchave: TIntegerField;
    cltccochave: TIntegerField;
    cltltechave: TIntegerField;
    cltdtlchave: TIntegerField;
    cco: TUniQuery;
    ccoccochave: TIntegerField;
    ccoctacodigo: TIntegerField;
    ccotoccodigo: TIntegerField;
    ccocedcodigo: TIntegerField;
    ccoclbcodigo: TIntegerField;
    ccotficodigo: TIntegerField;
    ccoccoemissao: TDateField;
    ccoccovencimento: TDateField;
    ccocconumero: TStringField;
    ccoccohistorico: TStringField;
    ccoccovalor: TFloatField;
    ccoccochaveorig: TIntegerField;
    ccoccochavedest: TIntegerField;
    ccoccoconciliado: TIntegerField;
    ccomoecodigo: TIntegerField;
    ccoccoextenso: TStringField;
    ccoetdcodigo: TIntegerField;
    ccoccofavorecido: TStringField;
    ccoccodatamov: TDateField;
    ccoccodataregistro: TDateField;
    ccoccohoraregistro: TTimeField;
    ccoflacodigo: TIntegerField;
    mCco: TFDMemTable;
    mCcoccochave: TIntegerField;
    mCcoctacodigo: TIntegerField;
    mCcotoccodigo: TIntegerField;
    mCcocedcodigo: TIntegerField;
    mCcoclbcodigo: TIntegerField;
    mCcotficodigo: TIntegerField;
    mCcoccoemissao: TDateField;
    mCcoccovencimento: TDateField;
    mCcocconumero: TStringField;
    mCcoccohistorico: TStringField;
    mCcoccovalor: TFloatField;
    mCcoccochaveorig: TIntegerField;
    mCcoccochavedest: TIntegerField;
    mCcoccoconciliado: TIntegerField;
    mCcomoecodigo: TIntegerField;
    mCcoccoextenso: TStringField;
    mCcoetdcodigo: TIntegerField;
    mCcoccofavorecido: TStringField;
    mCcoccodatamov: TDateField;
    mCcoccodataregistro: TDateField;
    mCcoccohoraregistro: TTimeField;
    mCcoflacodigo: TIntegerField;
    mCcodtlchave: TIntegerField;
    mCcoltechave: TIntegerField;
    clb: TUniQuery;
    clbclbcodigo: TIntegerField;
    clbclbidentificacao: TStringField;
    rctpos: TUniQuery;
    rctposrctchave: TIntegerField;
    rctposrctvalor: TCurrencyField;
    rctposrctrede: TStringField;
    rctposrctnrauto: TStringField;
    rctposadccodigo: TIntegerField;
    rctposrctparcelas: TIntegerField;
    rctposbdccodigo: TIntegerField;
    rctposrctcomprovante1via: TStringField;
    rctposrctcomprovante2via: TStringField;
    rctposrcthora: TTimeField;
    rctposorcchave: TIntegerField;
    rctposrctstatus: TStringField;
    rctposrcttoken: TStringField;
    car: TUniQuery;
    carcarcodigo: TIntegerField;
    carcarpercmorames: TFloatField;
    carcardiasjuros: TIntegerField;
    mlt: TUniQuery;
    mltmltchave: TIntegerField;
    mltmfichave: TIntegerField;
    mltltechave: TIntegerField;
    mltflacodigo: TIntegerField;
    mfi: TUniQuery;
    mfimfichave: TIntegerField;
    mfirfichave: TIntegerField;
    mfitmfcodigo: TIntegerField;
    mfimoecodigo: TIntegerField;
    mfimfivalor: TFloatField;
    mfimfidata: TDateField;
    mfimfihistorico: TStringField;
    mfimfivalorori: TFloatField;
    mfimfiparcela: TIntegerField;
    mfiflacodigo: TIntegerField;
    dfcrfi: TFDMemTable;
    dfcrfirfichave: TIntegerField;
    dfcrfirfinumero: TStringField;
    dfcrfirfivencimento: TDateField;
    dfcrfirfivalor: TFloatField;
    dfcrfirfivalorparcela: TCurrencyField;
    dfcrfitfdcodigo: TIntegerField;
    dfcrfitficodigo: TIntegerField;
    rfi: TUniQuery;
    rfirfichave: TIntegerField;
    rfietdcodigo: TIntegerField;
    rfitfdcodigo: TIntegerField;
    rfiflacodigo: TIntegerField;
    rfitficodigo: TIntegerField;
    rfibcocodigo: TStringField;
    rficarcodigo: TIntegerField;
    rfirfiemissao: TDateField;
    rfirfivencimento: TDateField;
    rfirfinumero: TStringField;
    rfirfivalor: TFloatField;
    rfirfihistorico: TStringField;
    rfisrfcodigo: TIntegerField;
    rfifrrcodigo: TIntegerField;
    rfirfimoradia: TFloatField;
    rfirfipercmesmora: TFloatField;
    rfirfirepetir: TIntegerField;
    rfirfiprevisao: TIntegerField;
    rfirfivalorparcela: TFloatField;
    rfimoecodigo: TIntegerField;
    rfititcodigo: TIntegerField;
    rfiedrcodigo: TIntegerField;
    rfirfidatamulta: TDateField;
    rfirfivalomulta: TCurrencyField;
    mRfi: TFDMemTable;
    mRfirfichave: TIntegerField;
    mRfietdcodigo: TIntegerField;
    mRfitfdcodigo: TIntegerField;
    mRfiflacodigo: TIntegerField;
    mRfitficodigo: TIntegerField;
    mRfibcocodigo: TStringField;
    mRficarcodigo: TIntegerField;
    mRfirfiemissao: TDateField;
    mRfirfivencimento: TDateField;
    mRfirfinumero: TStringField;
    mRfirfivalor: TFloatField;
    mRfirfihistorico: TStringField;
    mRfisrfcodigo: TIntegerField;
    mRfifrrcodigo: TIntegerField;
    mRfirfimoradia: TFloatField;
    mRfirfipercmesmora: TFloatField;
    mRfirfirepetir: TIntegerField;
    mRfirfiprevisao: TIntegerField;
    mRfirfivalorparcela: TFloatField;
    mRfimoecodigo: TIntegerField;
    mRfititcodigo: TIntegerField;
    mRfiedrcodigo: TIntegerField;
    mRfidtlchave: TIntegerField;
    mRfirfidatamulta: TDateField;
    mRfirfivalomulta: TCurrencyField;
    tit: TUniQuery;
    tittitcodigo: TIntegerField;
    titetdcodigo: TIntegerField;
    tittitnumero: TStringField;
    tittitvalor: TFloatField;
    tittitemissao: TDateField;
    tittitvctoinicial: TDateField;
    tittfdcodigo: TIntegerField;
    titsrfcodigo: TIntegerField;
    tittficodigo: TIntegerField;
    tittithora: TTimeField;
    tittithistorico: TStringField;
    titclbcodigo: TIntegerField;
    tittitvalorparcela: TFloatField;
    tittitparcelas: TIntegerField;
    tittitprevisao: TIntegerField;
    titmoecodigo: TIntegerField;
    tittitmoradia: TFloatField;
    tittitvalomulta: TFloatField;
    tittitpercmesmora: TFloatField;
    tittitvalodesc: TFloatField;
    tittitpercmulta: TFloatField;
    titflacodigo: TIntegerField;
    titbcocodigo: TStringField;
    titcarcodigo: TIntegerField;
    tittitdiasmulta: TIntegerField;
    tittitdiasdesc: TIntegerField;
    titedrcodigo: TIntegerField;
    mTit: TFDMemTable;
    mTittitcodigo: TIntegerField;
    mTitetdcodigo: TIntegerField;
    mTittitnumero: TStringField;
    mTittitvalor: TFloatField;
    mTittitemissao: TDateField;
    mTittitvctoinicial: TDateField;
    mTittfdcodigo: TIntegerField;
    mTitsrfcodigo: TIntegerField;
    mTittficodigo: TIntegerField;
    mTittithora: TTimeField;
    mTittithistorico: TStringField;
    mTitclbcodigo: TIntegerField;
    mTittitvalorparcela: TFloatField;
    mTittitparcelas: TIntegerField;
    mTittitprevisao: TIntegerField;
    mTitmoecodigo: TIntegerField;
    mTittitmoradia: TFloatField;
    mTittitvalomulta: TFloatField;
    mTittitpercmesmora: TFloatField;
    mTittitvalodesc: TFloatField;
    mTittitpercmulta: TFloatField;
    mTitflacodigo: TIntegerField;
    mTitbcocodigo: TStringField;
    mTitcarcodigo: TIntegerField;
    mTittitdiasmulta: TIntegerField;
    mTittitdiasdesc: TIntegerField;
    mTitedrcodigo: TIntegerField;
    mTitdtlchave: TIntegerField;
    ltr: TUniQuery;
    ltrltrchave: TIntegerField;
    ltrrdcchave: TIntegerField;
    ltrdtlchave: TIntegerField;
    ltrrdcnrauto: TStringField;
    rdc: TUniQuery;
    rdcrdcchave: TIntegerField;
    rdcrdcvalor: TFloatField;
    rdcrdcnrauto: TStringField;
    rdcrdcdata: TDateField;
    rdcadccodigo: TIntegerField;
    rdcrdcparcelas: TIntegerField;
    rdcbdccodigo: TIntegerField;
    rdcrdccomprovante1via: TStringField;
    rdcrdccomprovante2via: TStringField;
    rdcrdchora: TTimeField;
    rdcdtlchave: TIntegerField;
    mRdc: TFDMemTable;
    mRdcrdcchave: TIntegerField;
    mRdcrdcvalor: TFloatField;
    mRdcrdcnrauto: TStringField;
    mRdcrdcdata: TDateField;
    mRdcadccodigo: TIntegerField;
    mRdcrdcparcelas: TIntegerField;
    mRdcbdccodigo: TIntegerField;
    mRdcrdccomprovante1via: TStringField;
    mRdcrdccomprovante2via: TStringField;
    mRdcdtlchave: TIntegerField;
    lte: TUniQuery;
    lteltechave: TIntegerField;
    ltetfdcodigo: TIntegerField;
    lteltedata: TDateField;
    ltelteprincipal: TFloatField;
    lteltemulta: TFloatField;
    lteltejuros: TFloatField;
    lteltedesconto: TFloatField;
    lteltetotal: TFloatField;
    ltelteextenso: TStringField;
    lteclbcodigo: TIntegerField;
    ltectacodigo: TIntegerField;
    lteltetroco: TFloatField;
    lteflacodigo: TIntegerField;
    lteccxchave: TIntegerField;
    mda: TUniQuery;
    mdamdacodigo: TIntegerField;
    mdamdaidentificacao: TStringField;
    dtl: TUniQuery;
    dtldtlchave: TIntegerField;
    dtlltechave: TIntegerField;
    dtlcedcodigo: TIntegerField;
    dtlmdacodigo: TIntegerField;
    dtldtlvalor: TFloatField;
    dtldtlvalorinfo: TFloatField;
    dtlflacodigo: TIntegerField;
    dtlccxchave: TIntegerField;
    dtldtlregistro: TDateTimeField;
    dtlmdaidentificacao: TStringField;
    dtlrdcnrauto: TStringField;
    rctorc: TUniQuery;
    rctorcrctchave: TIntegerField;
    rctorcrctvalor: TCurrencyField;
    rctorcrctrede: TStringField;
    rctorcrctnrauto: TStringField;
    rctorcadccodigo: TIntegerField;
    rctorcrctparcelas: TIntegerField;
    rctorcbdccodigo: TIntegerField;
    rctorcrctcomprovante1via: TStringField;
    rctorcrctcomprovante2via: TStringField;
    rctorcrcthora: TTimeField;
    rctorcorcchave: TIntegerField;
    rctorcrctstatus: TStringField;
    rctorcrcttoken: TStringField;
    rctorcrctjson: TStringField;
    rctorcltechave: TIntegerField;
    mestem: TUniQuery;
    orc: TUniQuery;
    bdc: TUniQuery;
    rct: TUniQuery;
    rctrctchave: TIntegerField;
    rctrctvalor: TCurrencyField;
    rctrctrede: TStringField;
    rctrctnrauto: TStringField;
    rctadccodigo: TIntegerField;
    rctrctparcelas: TIntegerField;
    rctbdccodigo: TIntegerField;
    rctrctcomprovante1via: TStringField;
    rctrctcomprovante2via: TStringField;
    rctrcthora: TTimeField;
    rctorcchave: TIntegerField;
    rctrctstatus: TStringField;
    rctrcttoken: TStringField;
    rctrctjson: TStringField;
    rctltechave: TIntegerField;
    TimerPagamento: TTimer;
    adc: TUniQuery;
    adcadccodigo: TIntegerField;
    adcadcidentificacao: TStringField;
    adcadcchaveintegracao: TStringField;
    adcadcserviconome: TStringField;
    adcetdcodigo: TIntegerField;
    adcctacodigo: TIntegerField;
    qrypos: TUniQuery;
    qryposposcodigo: TIntegerField;
    qryposposidentificacao: TStringField;
    qryposposnumeroserie: TStringField;
    rpwaberto: TUniQuery;
    rpwabertorpwchave: TIntegerField;
    rpwabertorpwtoken: TStringField;
    rpwabertorpwmesa: TStringField;
    rpwabertorpwstatus: TStringField;
    rpwabertoorcchave: TIntegerField;
    trmtef: TUniQuery;
    trmteftrmcodigo: TIntegerField;
    trmteftrmintegrapagarme: TIntegerField;
    orcstocodigo: TIntegerField;
    orcorctotalav: TFloatField;
    orcorcchave: TIntegerField;
    morlte: TUniQuery;
    morlteltechave: TIntegerField;
    ltedtl: TUniQuery;
    procedure TimerPagamentoTimer(Sender: TObject);
    procedure trmtefBeforeOpen(DataSet: TDataSet);
  private


    vpCcxchave :Integer;
    vpctacodigo:Integer;
    vpLteChave:Integer;

    vpestabelecimentocnpj:String;
    vpestabelecimentorazaosocial:String;
    vpDataAtual:TDateTime;
    vpContaPIX:Integer;

    vpCodigoADC:Integer;
    vpAdquirenteADC:String;
    vpEntidadeADC:Integer;
    vpContaAdc:Integer;

    vpEtdCodigo:Integer;
    vpEtdIdentificacao:String;


    vpValorRecebido:Currency;
    vpTeclaFinalizador:Integer;
    vpMdaCodigo:Integer;
    vpDtlChave:Integer;

    function SalvaRegistroLote: String;
    procedure DadosCaixa;
    procedure ProcessaRecebimento;
    procedure DadosConfiguracao;
    function ConfirmaRecebimento(aOrder: String): Boolean;
    function ProcessaOrcamento: Boolean;
    procedure DadosEntidadeVenda;

    function RegistraCCO(avalor: Double; aCtaCodigo: String;  adoacao: Integer = 0; aTfiCodigo:Integer=0; altechave:Integer=0; aDtlChave:Integer=0): string;
    procedure SalvaRegistroCCO(aLteChave, mccoChave: String);
    procedure SalvaRegistroCLT(aCcoChave, aLteChave: String);
    procedure FinalizaRecebimento;
    function RegistraTit(aetdcodigo: Integer; atitvalor: Currency;
      aVencimento: TDate): Integer;
    function RegistraRfi(atitcodigo: Integer; aVencimento: TDate;
      aParcela: Integer; avalor: Double): Integer;
    function SalvaRegistroTITVENDA(aLteChave: String): string;
    function SalvaRegistroCartaoCredito(aDtlChave: String): String;
    function EncerraRecebimento(aOrder: String): Boolean;
    procedure SalvaRegistroRFIVENDA(aTitCodigo, mtitcodigo, aLtechave: String;
      aSituacao: Boolean);
    procedure SalvaRegistroRFMVENDA(aRfichave: String);
    procedure SalvaRegistroMFIVENDA(arfiChave: String; aRfiValor: Currency;
      atmfCodigo: Integer; aLteChave: String);
    procedure SalvaRegistroMLTVENDA(aMfiChave, aLteChave: String);
    procedure GeraNFCe(aOrcChave: String);
    function ModuloNFCe(vfuncao, vTrmCodigo, vmeschave,
      vClbCodigo: string): Boolean;
    procedure ProcessaPagamentos(aOrcChave, aNumeroPedido,
      aIdPagamento: String);

    { Private declarations }
  public
    { Public declarations }
    zCone:TUniConnection;

    fAcesso:Tacesso;

    vpTrmCodigo:Integer;
    vpFlaCodigo:Integer;
    vpCznChave:Integer;
    vpIdPagamento:String;
    vpAdmin:String;


    vpClbCodigo:Integer;
    vpClbIdentificacao:String;
    vpOrcChave:Integer;
    vpMesChave:Integer;

    vpValorAReceber:Currency;

    procedure ProcessaPagamentosStone(aOrcChave, aNumeroPedido, aIdPagamento: String);
    function recebimentoDiretoStone(aOrcChave:String;aPedido:String;aMaquinaPOS:String; aValor:Double; aNome:string):string;
    function ExecutaCancelamentoStone(aIdPagamento: string; aOrcChave:string): boolean;


  end;

Const

  ServiceRefererName  = 'MIZIO';


var
  ftefwifi: Tftefwifi;

implementation

{$R *.dfm}

function  Tftefwifi.recebimentoDiretoStone(aOrcChave:String;aPedido:String;aMaquinaPOS:String; aValor:Double; aNome:string):string;
var
 lRes  : IResponse;
 lJson : TJson;
 vlTentativas:Integer;
 vlRequest:Boolean;
 vlIdPagamento:String;
begin

  result:='';

 { rpw.close;
  rpw.ParamByName('orcchave').AsString:=aPedido;
  rpw.ParamByName('rpwstatus').AsString:='EM ABERTO';
  rpw.ParamByName('cznchave').AsInteger:=acznchave;
  rpw.ParamByName('rpwtoken').AsString:=lblIdPagamento.Caption;
  rpw.Open;}

  adc.Close;
  adc.Connection:=zCone;
  adc.Open;
  vpAdmin :=adc.FieldByName('adcchaveintegracao').asstring;

  // Inicia o pagamento
  lJson := TJson.Create;
  try

     // customer
     with lJson.Values['customer'].AsObject  do
     begin
        lJson.Values['customer'].AsObject.Put('name', aNome);
        lJson.Values['customer'].AsObject.Put('email', 'outro@teste.com.br');
     end;

     // items
     with lJson.Values['items'].AsArray do
     begin
       with put(empty).AsObject do begin
        lJson.Values['items'].AsArray[0].AsObject.Put('amount', aValor * 100); // Valor
        lJson.Values['items'].AsArray[0].AsObject.Put('description', 'Pedido: '+ aPedido);
        lJson.Values['items'].AsArray[0].AsObject.Put('quantity', 1);
       end;
     end;

     lJson.Put('closed', false);


    with lJson.Values['poi_payment_settings'].AsObject
    do begin

      lJson.Values['poi_payment_settings'].AsObject.Put('visible', true);
      lJson.Values['poi_payment_settings'].AsObject.Put('print_order_receipt', False);


     if aMaquinaPOS<>'' then
     begin
       with lJson.Values['poi_payment_settings'].AsObject.Values['devices_serial_number'].AsArray do
        begin
            Put(aMaquinaPOS);
        end;
     end;

      lJson.Values['poi_payment_settings'].AsObject.Put('display_name', 'Pedido: '+ aPedido);

    end;

    vlTentativas:=0;
    while (vlTentativas<=10) do
    begin

      try
      lRes := TRequest.New.BaseURL('https://api.pagar.me/core/v5/orders')
                          .BasicAuthentication(vpAdmin,'')
                          .AddHeader('ServiceRefererName', ServiceRefererName)
                          .ContentType('application/json')
                          .AddBody(lJson.Stringify)
                          .Post;
        vlRequest:=true;
        break;

      except
        vlRequest:=False;
        vlTentativas:=vlTentativas+1;
        sleep(300);

      end;

    end;


    if vlRequest then
    begin

      lJson.Clear;

      if (lRes.StatusCode = 200) and ((lRes.Content) <> '') then
      begin

        lJson.Parse(lRes.Content);
        vlIdPagamento := lJson.Values['id'].AsString;

        rpw.close;
        rpw.Connection:=zCone;
        rpw.ParamByName('orcchave').AsString:=aOrcChave;
        rpw.ParamByName('rpwstatus').AsString:='EM ABERTO';
        rpw.ParamByName('cznchave').AsInteger:=vpCznChave;
        rpw.ParamByName('rpwtoken').AsString:=vpIdPagamento;
        rpw.Open;

        if rpw.IsEmpty then
        begin
          rpw.Append;
          rpwrpwtoken.AsString:=vlIdPagamento;
          rpwrpwmesa.AsString:='';
          rpwrpwstatus.AsString:='EM ABERTO';
          rpworcchave.AsString:=aOrcChave;
          rpwrpwmesa.asstring:=aPedido;
          rpwcznchave.asInteger:= vpCznChave;
          rpwrpwjson.asstring:= lRes.Content;
          rpw.Post;
        end;

      end;

    end
    else
    begin
     //  ShowMessage('Erro: '+lRes.StatusCode.ToString+#13+lRes.Content);

    end;

    result:=vlIdPagamento;

  finally
    lJson.Free;
  end;

end;

procedure  Tftefwifi.ProcessaPagamentos(aOrcChave:String;aNumeroPedido:String;aIdPagamento:String);
begin
  if uppercase(adcadcserviconome.AsString)='MIZIO' then
  begin
    ProcessaPagamentosStone(aOrcChave,aNumeroPedido,aIdPagamento);
  end;

end;


procedure  Tftefwifi.ProcessaPagamentosStone(aOrcChave:String;aNumeroPedido:String;aIdPagamento:String);
var
 lRes  : IResponse;
 lJson : TJson;
 valor : String;

 valorAReceber : Currency;
 autorizacao : String;
 tipocartao : String;
 naturezacartao : String;
 nomecliente : String;
 i,q:integer;

 jsonPagamentos:TJsonArray;

  vlTentativas:Integer;
  vlRequest:Boolean;
  vlTotalAReceber:Currency;
  vlValorRecebido:Currency;
  vlvalorAReceber:Currency;

  vllteChave:String;


  fTeclaFinalizador :Integer;
  fMdaCodigo :Integer;
  vldtlchave:Integer;

begin

  adc.Close;
  adc.Connection:=zCone;
  adc.Open;
  vpAdmin :=adc.FieldByName('adcchaveintegracao').asstring;

    lJson := TJson.Create;

    try

      vlTentativas :=0;
      while (vlTentativas<=10) do
      begin
        try


          lRes := TRequest.New.BaseURL(Format('https://api.pagar.me/core/v5/orders/%s', [aIdPagamento]))
                                  .BasicAuthentication(vpAdmin,'')
                                  .ContentType('application/json')
                                 .Get;

          vlRequest:=true;
          break;

        except
          vlRequest:=False;
          vlTentativas:=vlTentativas+1;
          sleep(300);
        end;
      end;

      if vlRequest then
      begin

        if (lRes.StatusCode = 200) and ((lRes.Content) <> '') then
        begin

          rpwemaberto.close;
          rpwemaberto.Connection:=zCone;
          rpwemaberto.ParamByName('rpwtoken').AsString:=aIdPagamento;
          rpwemaberto.Open;

          lJson.Parse(lRes.Content);


         // if (lRes.Content<>rpwemabertorpwjson.AsString) then
         // begin

            orc.close;
            orc.Connection:=zCone;
            orc.sql.Text:='select orcchave, stocodigo,orctotalav  from orc where orcchave='+aOrcChave;
            orc.Open;

            if not orc.IsEmpty then
            begin

              valorAReceber:= 0;
              vlTotalAReceber:=0;
              vlvalorAReceber:=0;

              jsonPagamentos:=lJson.Values['charges'].AsArray;

              if lJson.Values['amount'].AsString<>'' then
              begin
                  valorAReceber:= StrToCurr(lJson.Values['amount'].AsString);
                  vlTotalAReceber:=valorAReceber;
                  vlvalorAReceber:=valorAReceber;
              end;


              i:=jsonPagamentos.Count;

              if i>0 then
              begin
                vlValorRecebido:=0;
                for q := 0 to i-1 do
                begin

                  nomecliente    := jsonPagamentos.Items[q].AsObject.Values['customer'].AsObject.Values['name'].AsString;

                  valor          := jsonPagamentos.Items[q].AsObject.Values['paid_amount'].AsString;
                  vlValorRecebido  := vlValorRecebido + StrToCurr(valor);

                  tipocartao     := jsonPagamentos.Items[q].AsObject.Values['metadata'].AsObject.Values['scheme_name'].AsString;
                  naturezacartao := jsonPagamentos.Items[q].AsObject.Values['metadata'].AsObject.Values['account_funding_source'].AsString;
                  autorizacao    := jsonPagamentos.Items[q].AsObject.Values['metadata'].AsObject.Values['authorization_code'].AsString;





                  if (lowercase(naturezacartao)='debit') or (lowercase(naturezacartao)='prepaid') then
                  naturezacartao:='debito';

                  if lowercase(naturezacartao)='credit' then
                  naturezacartao:='credito';

                  if lowercase(tipocartao)='mastercard' then
                    tipocartao:='master';

                  bdc.close;
                  bdc.Connection:=zCone;
                  bdc.ParamByName('bdcidentificacao').AsString:=lowercase(tipocartao);
                  bdc.ParamByName('bdcnatureza').AsString:=lowercase(naturezacartao);
                  bdc.Open;

                  if autorizacao='' then
                  begin
                    autorizacao  := jsonPagamentos.Items[q].AsObject.Values['last_transaction'].AsObject.Values['end_to_end_id'].AsString;

                    tipocartao:='pix';
                    naturezacartao:='On line';

                    bdc.close;
                    bdc.Connection:=zCone;
                    bdc.ParamByName('bdcidentificacao').AsString:=lowercase(tipocartao);
                    bdc.ParamByName('bdcnatureza').AsString:=lowercase(naturezacartao);
                    bdc.Open;

                  end;

                  rct.close;
                  rct.Connection:=zCone;
                  rct.ParamByName('rctnrauto').AsString:=autorizacao;
                  rct.ParamByName('rcttoken').AsString:=aidPagamento;
                  rct.ParamByName('orcchave').AsString:=aOrcChave;
                  rct.Open;

                  if not rct.IsEmpty then
                  begin

                    rct.Edit;

                    rct.FieldByName('rctvalor').AsCurrency :=  StrToCurr(valor)/100;
                    rct.FieldByName('rctnrauto').asstring:=autorizacao;
                    rct.FieldByName('adccodigo').asstring:=adcadccodigo.AsString;
                    rct.FieldByName('rctparcelas').asstring:='1';

                    if bdc.IsEmpty then
                      rct.FieldByName('bdccodigo').asstring:='99'
                    else
                      rct.FieldByName('bdccodigo').asstring:=bdc.FieldByName('bdccodigo').AsString;

                    rct.FieldByName('rctcomprovante1via').asstring:=nomecliente;
                    rct.FieldByName('rctcomprovante2via').asstring:='';
                    rct.FieldByName('rcthora').AsDateTime:=now();
                    rct.FieldByName('orcchave').asstring:=aOrcChave;
                    rct.FieldByName('rctstatus').asstring:='RECEBIDO';
                    rct.FieldByName('rctrede').asstring:=UPPERCASE(tipocartao+' '+naturezacartao);
                    rct.FieldByName('rcttoken').asstring:=aidPagamento;
                    rct.FieldByName('rctjson').asstring:=lRes.Content;

                    rct.Post;

                  end
                  else if rct.IsEmpty then
                  begin

                    rct.Append;

                    rct.FieldByName('rctvalor').AsCurrency :=  StrToCurr(valor)/100;
                    rct.FieldByName('rctnrauto').asstring:=autorizacao;
                    rct.FieldByName('adccodigo').asstring:= adcadcCodigo.AsString;
                    rct.FieldByName('rctparcelas').asstring:='1';

                    if bdc.IsEmpty then
                      rct.FieldByName('bdccodigo').asstring:='99'
                    else
                      rct.FieldByName('bdccodigo').asstring:=bdc.FieldByName('bdccodigo').AsString;

                    rct.FieldByName('rctcomprovante1via').asstring:=nomecliente;
                    rct.FieldByName('rctcomprovante2via').asstring:='';
                    rct.FieldByName('rcthora').AsDateTime:=now();
                    rct.FieldByName('orcchave').asstring:=aOrcChave;
                    rct.FieldByName('rctstatus').asstring:='RECEBIDO';
                    rct.FieldByName('rctrede').asstring:=UPPERCASE(tipocartao+' '+naturezacartao);
                    rct.FieldByName('rcttoken').asstring:=aidPagamento;
                    rct.FieldByName('rctjson').asstring:=lRes.Content;

                    rct.Post;

                    vpOrcChave:=aorcchave.ToInteger;

                    vllteChave:=Trim(SalvaRegistroLote);

                    rct.Edit;
                    rct.FieldByName('ltechave').AsString:=vllteChave;
                    rct.Post;

                    olt.Close;
                    olt.Connection:=zCone;
                    olt.ParamByName('orcchave').AsString :=aOrcChave;
                    olt.ParamByName('olttipo').AsString :='0';
                    olt.Open;


                    if olt.Locate('orcchave;ltechave',vararrayof([aOrcChave,vllteChave]),[] ) then
                      olt.Edit
                    else
                      olt.Append;

                    oltorcchave.AsString:=aOrcChave;
                    oltltechave.AsString:=vllteChave;
                    oltoltidentificacao.AsString:=rctorc.FieldByName('rctcomprovante1via').asstring;
                    oltolttipo.AsInteger:=0;
                    olt.Post;


                    dtl.Close;
                    dtl.Connection:=zCone;
                    dtl.ParamByName('ltechave').AsString :=vllteChave;
                    dtl.Open;

                    if (pos(Uppercase('credito'),uppercase(rct.FieldByName('rctrede').asstring)) > 0)  then
                    begin
                      fTeclaFinalizador := 114;
                      fMdaCodigo := 4;
                    end
                    else if pos(Uppercase('debito'), uppercase(rct.FieldByName('rctrede').asstring)) > 0 then
                    begin
                      fTeclaFinalizador := 115;
                      fMdaCodigo := 5;
                    end
                    else if pos(Uppercase('pix'), uppercase(rct.FieldByName('rctrede').asstring)) > 0 then
                    begin
                      fTeclaFinalizador := 119;
                      fMdaCodigo := 6;
                    end
                    ELSE
                    BEGIN

                    END;

                    if not dtl.locate('ccxchave;MdaCodigo;lteChave;rdcnrauto;dtlvalor',
                                    vararrayof([vpccxchave,fMdaCodigo,vllteChave,autorizacao,rct.FieldByName('rctvalor').AsCurrency]),[])   then
                    begin
                      dtl.Append;

                      dtldtlvalorinfo.AsCurrency :=rct.FieldByName('rctvalor').AsCurrency;
                      dtlltechave.AsString := vllteChave;
                      dtlcedcodigo.AsInteger := 1;
                      dtlmdacodigo.AsInteger := fMdaCodigo;
                      dtldtlvalor.AsCurrency := rct.FieldByName('rctvalor').AsCurrency;
                      dtlflacodigo.AsInteger := 1;
                      dtldtlregistro.AsDateTime := now();
                      dtlccxchave.AsInteger := vpccxchave;
                      dtlrdcnrauto.asstring := autorizacao;

                      mda.Close;
                      mda.Connection:=zCone;
                      mda.ParamByName('mdacodigo').AsInteger := fMdaCodigo;
                      mda.Open;

                      dtlmdaidentificacao.AsString := mda.FieldByName('mdaidentificacao').AsString;
                      dtl.Post;

                      vldtlchave:=dtldtlchave.AsInteger;

                      lte.Edit;
                      ltelteprincipal.AsCurrency:=rct.FieldByName('rctvalor').AsCurrency;
                      lteltetotal.AsCurrency:=rct.FieldByName('rctvalor').AsCurrency;
                      lte.Post;

                    end;
                  end;
                end;
              end;
            end;


            rpw.close;
            rpw.Connection:=zCone;
            rpw.ParamByName('orcchave').AsString:=aOrcChave;
            rpw.ParamByName('rpwstatus').AsString:='EM ABERTO';
            rpw.ParamByName('cznchave').AsInteger:=vpCznChave;
            rpw.ParamByName('rpwtoken').AsString:=aIdPagamento;
            rpw.Open;

            rctpos.Close;
            rctpos.Connection:=zCone;
            rctpos.ParamByName('orcchave').AsString:=aOrcChave;
            rctpos.ParamByName('rcttoken').AsString:=aIdPagamento;
            rctpos.Open;
            rctpos.First;
            vlValorRecebido :=0 ;

            while not rctpos.Eof do
            begin
              vlValorRecebido:=vlValorRecebido+rctpos.FieldByName('rctvalor').AsCurrency;
              rctpos.Next;
            end;


            if vlValorRecebido>0 then
            begin
              vpidPagamento:=aIdPagamento;
            end
            else
            begin


              mor.Close;
              mor.Connection:=zCone;
              mor.ParamByName('orcchave').AsString:=aOrcChave;
              mor.Open;

              if not mor.IsEmpty then
              begin

                if (vlValorRecebido=0) and (valorAReceber=0) then
                begin
                  vpidPagamento:=aIdPagamento;

                  if vpIdPagamento<>'' then
                  begin
                    vpOrcChave:=aOrcChave.ToInteger;
                    vpIdPagamento:= aIdPagamento;
                    ProcessaRecebimento;
                  end;
                end;

              end;

            end;
            vpidPagamento:=aIdPagamento;
            if vpIdPagamento='' then
            begin
              exit;
            end;


            clb.Close;
            clb.Connection:=zCone;
            clb.ParamByName('orcchave').AsString:=aOrcChave;
            clb.Open;


            ///
            ///
            ///
            ///
            ///




            rctpos.Close;
            rctpos.Connection:=zCone;
            rctpos.ParamByName('orcchave').AsString:=aOrcChave;
            rctpos.ParamByName('rcttoken').AsString:=vpIdPagamento;
            rctpos.Open;
            rctpos.First;
            vlValorRecebido :=0 ;

            while not rctpos.Eof do
            begin

              vlValorRecebido:=vlValorRecebido+rctpos.FieldByName('rctvalor').AsCurrency;
              rctpos.Next;
            end;

            if vlValorRecebido>0 then
            begin
              vpidPagamento:=aIdPagamento;
            end;

            ///
            ///
            ///
            ///
            ///
            if not rpwemaberto.IsEmpty then
            begin
              rpwemaberto.Edit;
              rpwemabertorpwjson.AsString:=lres.Content;
              rpwemaberto.Post;
            end;

            if (vlValorRecebido=(vlvalorAReceber/100)) and (vlValorRecebido<>0) and (vlvalorAReceber<>0)   then
            begin
              if not orc.IsEmpty then
              begin
                vpOrcChave:=aOrcChave.ToInteger;
                vpIdPagamento:= aIdPagamento;
                ProcessaRecebimento;
              end;
            end;



         { end
          else
          begin

            orc.close;
            orc.Connection:=zCone;
            orc.sql.Text:='select orcchave, stocodigo,orctotalav  from orc where orcchave='+aOrcChave;
            orc.Open;

            vlvalorAReceber:=orc.FieldByName('orctotalav').AsCurrency;


            rctolt.Close;
            rctolt.Connection:=zCone;
            rctolt.ParamByName('orcchave').AsString:=aOrcChave;
            rctolt.Open;
            rctolt.First;
            vlValorRecebido :=0 ;

            while not rctolt.Eof do
            begin

              vlValorRecebido:=vlValorRecebido+rctolt.FieldByName('rctvalor').AsCurrency;
              rctolt.Next;
            end;


            if (vlValorRecebido=vlvalorAReceber) then
            begin
              if not orc.IsEmpty then
              begin
                vpOrcChave:=aOrcChave.ToInteger;
                vpIdPagamento:= aIdPagamento;
                ProcessaRecebimento;
              end;
            end
            else
            begin
              if vlValorRecebido>0 then
              begin
                vpidPagamento:=aIdPagamento;

              end

            end;
          end;}
        end;
      end;
    finally
      lJson.Free;
    end;
end;


Function Tftefwifi.SalvaRegistroLote:String;
var
  vlTentativas:Integer;
  vlLteChave:Integer;
begin
  morlte.Close;
  morlte.Connection:=zCone;
  morlte.parambyname('orcchave').asInteger:=vpOrcChave;
  morlte.Open;

  if morlte.IsEmpty then
    vlLteChave:=-1
  else
    vlLteChave:=morlteltechave.AsInteger;


  if vlLteChave<>-1 then
  begin
    ltedtl.Close;
    ltedtl.Connection:=zCone;
    ltedtl.sql.Text:='delete from dtl WHERE rdcnrauto LIKE '+QuotedStr('{%')+' and ltechave='+vlLteChave.ToString;
    ltedtl.ExecSQL;
  end;

  DadosCaixa;

  Result:='0';
  vlTentativas :=0;
  while vlTentativas<10 do
  begin

    try

      lte.Close;
      lte.Connection:=ZCone;
      lte.ParamByName('ltechave').AsInteger:=vlLteChave;
      lte.Open;

      if lte.IsEmpty then
        lte.Append
      else
        lte.Edit;


      ltetfdcodigo.AsInteger := tfdVenda;
      lteltedata.AsDateTime := Now();
      ltelteprincipal.ascurrency := vpValorAReceber ;
      lteltedesconto.ascurrency := 0;
      lteltetotal.ascurrency := vpValorAReceber ;
      lteflacodigo.AsInteger := vpFlaCodigo;
      lteccxchave.AsInteger := vpCcxchave;
      lteclbcodigo.AsInteger:= vpClbCodigo;
      ltectacodigo.AsInteger:= vpCtaCodigo;
      lteltetroco.AsCurrency:=0;
      lte.Post;

      Result := lteltechave.AsString;

      Break;

      lte.Close;
    Except
    on E: Exception do
      begin
        Result:='0';
        lte.Cancel;
        vlTentativas := vlTentativas +1;
        Sleep(300);
       end;
    end;

  end;


end;

procedure Tftefwifi.DadosCaixa;
var
  qccx: tuniquery;
begin

  qccx := tuniquery.Create(application);

  try
    qccx.Connection := ZCone;
    qccx.SQL.Text := 'SELECT CURRENT_TIME();';

    qccx.SQL.Text := 'SELECT ccxchave, ctacodigo FROM ccx  WHERE (ccx.trmcodigo=' + vpTrmCodigo.ToString + ' OR  ccx.trmcodigo IS null ) and ccx.clbcodigo=' +
      vpClbCodigo.ToString + ' AND ccx.ccxdatafecha is NULL order by ccxchave desc limit 1';

    qccx.Open;

    if not qccx.IsEmpty then
    begin
      vpCcxchave := qccx.FieldByName('ccxchave').AsInteger;
      vpctacodigo:= qccx.FieldByName('ctacodigo').AsInteger;
    end
    else
    begin
      vpCcxchave := 0;
    end;

  finally
    qccx.Close;
    qccx.Free;
  end;

end;

procedure Tftefwifi.ProcessaRecebimento;
begin

  TimerPagamento.Enabled:=false;

  orc.close;
  orc.sql.Text:='select orcchave, stocodigo,orctotalav  from orc where orcchave='+vpOrcChave.ToString;
  orc.Open;

 { if orc.FieldByName('stocodigo').AsInteger=0 then
  exit;}


  DadosCaixa;

  DadosConfiguracao;

  if ConfirmaRecebimento(vpIdPagamento) then
  begin


    if vpOrcChave<>0 then
    begin
      orc.Close;

      IF ProcessaOrcamento then
      begin

        DadosEntidadeVenda;

        FinalizaRecebimento;

        if not mcco.Active then
          mcco.Open;

        mcco.First;
        if not mcco.Eof then
        begin

          SalvaRegistroCCO(vplteChave.ToString, mccoccochave.AsString);
          mcco.Delete;

        end;

      end;
    end;

  end;

  orc.close;
  orc.sql.Text:='select orcchave, stocodigo,orctotalav  from orc where orcchave='+vpOrcChave.ToString;
  orc.Open;

  if orc.FieldByName('stocodigo').AsInteger=3 then
  begin
    TimerPagamento.Enabled := False;
    vpValorRecebido := 0;
   // TimerFechaTela.Enabled := True;
  end;

end;

///////////////////////////////////
///
///  carga de dados de inicialização
///
///////////////////////////////////


procedure Tftefwifi.DadosConfiguracao;
var
  vlcfg:TUniquery;
  vltrm:TUniquery;
  vladc:TUniquery;
  vlclb:TUniquery;

begin

  vlcfg:=TUniquery.Create(nil);

  vlcfg.Close;
  vlcfg.Connection := ZCone;
  vlcfg.SQL.Text:='SELECT cfgusacre, cfgcontrolalimite, cfgctacodigopix,  cfgusaadc, '+
                  'etddoc1, etdidentificacao,cfgdatapadrao '+
                  'FROM cfg, etd, cfgmsai, cfgmcre, cfgmcfg '+
                  'WHERE cfg.cfgcodigo=cfgmsai.cfgcodigo '+
                  'AND cfg.cfgcodigo=cfgmcfg.cfgcodigo '+
                  'AND cfg.cfgcodigo=cfgmcre.cfgcodigo '+
                  'AND cfgmcfg.cfgetdempresa=etd.etdcodigo  limit 1';
  vlcfg.Open;

  vpestabelecimentocnpj:=SoNumeros(vlcfg.FieldByName('etddoc1').AsString);
  vpestabelecimentorazaosocial:=trim(uppercase(vlcfg.FieldByName('etdidentificacao').AsString));
  vpDataAtual:=vlcfg.FieldByName('cfgdatapadrao').AsDateTime;
  vpContaPIX:=vlcfg.FieldByName('cfgctacodigopix').AsInteger;


  vlcfg.close;
  vlcfg.Free;

  vladc:=TUniquery.Create(nil);

  vladc.Close;
  vladc.Connection := ZCone;
  vladc.SQL.Text:='SELECT adccodigo, adcidentificacao, etdcodigo, adcpropria, '+
                  'bdccodigo, ctacodigo FROM adc  where ctacodigo<>0 and  adcencerramento is null  order by adccodigo desc limit 1';
  vladc.Open;

  vpCodigoADC:=vladc.FieldByName('adccodigo').AsInteger;
  vpAdquirenteADC:=vladc.FieldByName('adcidentificacao').AsString;
  vpEntidadeADC:=vladc.FieldByName('etdcodigo').AsInteger;
  vpContaAdc:=vladc.FieldByName('ctacodigo').AsInteger;

  clb.Close;
  clb.ParamByName('orcchave').AsInteger:=vpOrcChave;
  clb.Open;

  vpClbCodigo:=clb.FieldByName('clbcodigo').AsInteger;

  vladc.close;

  vlclb:=TUniquery.Create(nil);
  vlclb.Close;
  vlclb.Connection:=ZCone;
  vlclb.sql.Text :='SELECT clbcodigo, clbidentificacao from clb where clbcodigo=:clbcodigo ';
  vlclb.ParamByName('clbcodigo').AsInteger:= vpClbCodigo;
  vlclb.Open;

  if not vlclb.IsEmpty then
    vpClbIdentificacao :=vlclb.FieldByName('clbidentificacao').AsString
  else
    vpClbIdentificacao := 'Operado';

  vlclb.close;

end;



function Tftefwifi.ConfirmaRecebimento(aOrder:String):Boolean;
var
 lRes: IResponse;
 lJson: TJson;
 vlRequest:Boolean;
 vlTentativas:Integer;
begin

  adc.Close;
  adc.Connection:=zCone;
  adc.Open;
  vpAdmin :=adc.FieldByName('adcchaveintegracao').asstring;

  Result:= False;
  lJson := TJson.Create;

  try

    lJson.Put('status', 'paid');

    vlTentativas:=0;
    while (vlTentativas<=10) do
    begin
      try

      lRes := TRequest.New.BaseURL(Format('https://api.pagar.me/core/v5/orders/%s/closed', [aOrder]))
                          .BasicAuthentication(vpAdmin,'')
                          .ContentType('application/json')
                          .AddBody(lJson.Stringify)
                          .Patch;
          vlRequest:=true;
          break;

      except
        vlRequest:=False;
        vlTentativas:=vlTentativas+1;
        sleep(300);
      end;
    end;

    if vlRequest then
    begin
      if (lRes.StatusCode = 200) and ((lRes.Content) <> '') then
      begin
        Result := True;
      end;

      if pos('This order is closed',lRes.Content)>0 then
      begin
       Result := True;
      end;
    end
    else
      Result := False;


    if Result then
    begin

      rpw.close;
      rpw.ParamByName('orcchave').AsInteger:=vpOrcChave;
      rpw.ParamByName('rpwstatus').AsString:='EM ABERTO';
      rpw.ParamByName('cznchave').AsInteger:=vpcznchave;
      rpw.ParamByName('rpwtoken').AsString:=vpIdPagamento;
      rpw.Open;

      if not rpw.IsEmpty then
      begin
        rpw.Edit;
        rpwrpwtoken.AsString:=vpIdPagamento;
        rpwrpwmesa.AsString:='';
        rpwrpwstatus.AsString:='RECEBIDO';
        rpworcchave.AsInteger:=vpOrcChave;
        rpw.Post;
      end;

    end;



  finally
     lJson.Free;
  end;


end;

function Tftefwifi.ProcessaOrcamento:Boolean;
type
   TProcessaOrc = function(AOwner: TComponent; Conexao: TUniConnection; pChave: string; pAcesso: TAcesso; AFaturar: Boolean = False): string;

var
  vlPackopm: cardinal;
  Processa: TProcessaOrc;
  vlMesChave:String;
begin

  vpMesChave := 0;

  mor.Close;
  mor.ParamByName('orcchave').AsInteger:=vpOrcChave;
  mor.Open;

  if not mor.IsEmpty then
  begin

    vpMesChave := mor.FieldByName('meschave').AsInteger;

    if (vpMesChave<>0) then
    begin
      mestem.Close;
      mestem.Connection:=ZCone;
      mestem.SQL.Text := 'update mes set temcodigo=2 where meschave=' + vpMesChave.ToString;
      mestem.ExecSQL;
      Result:= True;
    end;

  end
  else
  begin
    Result:= False;

    vlPackopm := LoadPackage('modulos\mopm.bpl');
    if vlPackopm <> 0 then
    begin
      @Processa := GetProcAddress(vlPackopm, PChar('ProcessaOrc'));
      if Assigned(Processa) then
      begin

        vlMesChave := '';
        vlMesChave := Processa(Application, ZCone, vpOrcChave.ToString, fAcesso);

        try
          if vlMesChave<>'' then
          vpMesChave:=vlMesChave.ToInteger;
        except
          vpMesChave:=0;
        end;


        if  (vpmeschave<>0) then
        begin
          mestem.Close;
          mestem.Connection:=ZCone;
          mestem.SQL.Text := 'update mes set temcodigo=2 where meschave=' + vpmeschave.ToString;
          mestem.ExecSQL;
          Result:= True;
        end;

      end;
    end;
  end;
end;


procedure Tftefwifi.DadosEntidadeVenda;
begin

  mes.close;
  mes.Connection:=ZCone;
  mes.ParamByName('meschave').AsString:=vpMesChave.ToString;
  mes.Open;


  vpEtdCodigo:=mes.FieldByName('etdcodigo').AsInteger;
  vpEtdIdentificacao:=mes.FieldByName('etdidentificacao').AsString;

  mes.Close;

  if vpEtdCodigo=0 then
   vpEtdIdentificacao:='';

end;





function Tftefwifi.RegistraCCO(avalor: Double; aCtaCodigo: String;  adoacao: Integer = 0; aTfiCodigo:Integer=0; altechave:Integer=0; aDtlChave:Integer=0): string;
var
  vlCcoChave:Integer;
begin

  if not mcco.Active then
    mcco.Open;

  mcco.Append;
  mccoccochave.AsInteger := mcco.RecordCount+1;
  mccoctacodigo.AsString := aCtaCodigo;
  mccotoccodigo.AsInteger := tocNormal;
  mccocedcodigo.AsInteger := cedCredito;
  mccoclbcodigo.AsInteger := vpClbCodigo;
  mccotficodigo.AsInteger := aTfiCodigo;
  mccoccoemissao.AsFloat := date();
  mccoccovencimento.AsFloat :=  date();
  mccocconumero.AsString := '';
  mccoccohistorico.AsString := 'Venda : ' + vpMesChave.ToString ;
  mccoccovalor.AsFloat := avalor ;
  mccoetdcodigo.AsInteger := vpEtdCodigo;
  mccoccofavorecido.AsString := vpEtdIdentificacao;
  mccoccochaveorig.AsInteger := 0;
  mccoccochavedest.AsInteger := 0;
  mccoccodatamov.AsFloat := date();
  mccoccodataregistro.AsFloat := date();
  mccoccohoraregistro.AsFloat := Now();
  mccoccoconciliado.AsInteger := 1;
  mccomoecodigo.AsInteger := 1;
  mccoccoextenso.AsString := '';
  mccoflacodigo.AsInteger := vpFlaCodigo;
  mCcodtlchave.AsInteger := aDtlChave;
  mcco.Post;

  vlCcoChave := mccoccochave.AsInteger;


end;

procedure Tftefwifi.SalvaRegistroCCO(aLteChave:String; mccoChave:String);
var
  vlCcoChave : String;
  vlTentativas:Integer;
begin

  vlTentativas :=0;

  while vlTentativas<10 do
  begin

    try


      mcco.First;

      while not mcco.Eof do
      begin



        cco.close;
        cco.Connection:=ZCone;
        cco.ParamByName('ccohistorico').AsString:='Venda: '+vpMesChave.ToString;
        cco.Open;

       // if cco.IsEmpty then
          cco.Append;
       // else
       //   cco.Edit;

        ccoctacodigo.AsString := mccoctacodigo.AsString;
        ccotoccodigo.AsInteger := mccotoccodigo.AsInteger;
        ccocedcodigo.AsInteger := mccocedcodigo.AsInteger;
        ccoclbcodigo.AsInteger := mccoclbcodigo.AsInteger;
        ccotficodigo.AsInteger := mccotficodigo.AsInteger;
        ccoccoemissao.AsFloat := mccoccoemissao.AsFloat;
        ccoccovencimento.AsFloat := mccoccovencimento.AsFloat;
        ccocconumero.AsString := mccocconumero.AsString;
        ccoccohistorico.AsString := 'Venda: '+vpMesChave.ToString  ;
        ccoccovalor.AsFloat := mccoccovalor.AsFloat ;
        ccoetdcodigo.AsInteger := mccoetdcodigo.AsInteger;
        ccoccofavorecido.AsString := mccoccofavorecido.AsString;
        ccoccochaveorig.AsInteger := mccoccochaveorig.AsInteger;
        ccoccochavedest.AsInteger := mccoccochavedest.AsInteger;
        ccoccodatamov.AsFloat := mccoccodatamov.AsFloat ;
        ccoccodataregistro.AsFloat := mccoccodataregistro.AsFloat;
        ccoccohoraregistro.AsFloat := mccoccohoraregistro.AsFloat ;
        ccoccoconciliado.AsInteger := mccoccoconciliado.AsInteger;
        ccomoecodigo.AsInteger := mccomoecodigo.AsInteger;
        ccoccoextenso.AsString := mccoccoextenso.AsString;
        ccoflacodigo.AsInteger := mccoflacodigo.AsInteger ;
        cco.Post;


        vlCcoChave := ccoccochave.AsString;

        SalvaRegistroCLT(vlCcoChave,mCcoltechave.AsString);

        mcco.Next;

      end;

      Break;

    Except
      mcco.First;
      vlTentativas := vlTentativas +1;
      sleep(300);
    end;

  end;

end;

procedure Tftefwifi.SalvaRegistroCLT(aCcoChave:String;aLteChave:String);
var
  vlTentativas:Integer;
begin

  vlTentativas :=0;

  while vlTentativas<10 do
  begin

    try

      clt.Close;
      clt.Connection:=ZCone;
      clt.ParamByName('ccochave').AsString := aCcoChave ;
      clt.ParamByName('ltechave').AsString := aLteChave ;
      clt.ParamByName('dtlchave').AsString := mCcodtlchave.AsString ;
      clt.Open;

      if clt.IsEmpty then
        clt.Append
      else
         clt.Edit;
      cltccochave.AsString := aCcoChave;
      cltltechave.AsString := aLteChave;
      cltdtlchave.AsString := mccoDtlChave.AsString ;
      clt.Post;

      Break;

    Except
      vlTentativas := vlTentativas +1;
      sleep(300);
    end;

  end;
end;




procedure Tftefwifi.FinalizaRecebimento;
var

 vlTitCodigo:Integer;

  i:integer;
begin

  olt.Close;
  olt.Connection:=zCone;
  olt.ParamByName('orcchave').AsInteger :=vpOrcChave;
  olt.ParamByName('olttipo').AsString :='0';
  olt.Open;
  vpLteChave:=oltltechave.AsInteger;


  if vpLteChave<>0 then
  begin

    mrfi.Close;
    mrfi.Open;

    rctorc.Close;
    rctorc.ParamByName('orcchave').AsInteger := vpOrcChave;
    rctorc.Open;


    if not mtit.Active then
      mtit.Open;

    adc.Close;
    adc.Open;


    if (adc.FieldByName('etdcodigo').AsString<>'') then
    begin
      vpEntidadeADC:=adc.FieldByName('etdcodigo').AsInteger;
      vpContaAdc:=adc.FieldByName('ctacodigo').AsInteger;
    end;

    vlTitCodigo:=RegistraTit(vpEntidadeADC, vpvalorAReceber, date());

    dfcrfi.Close;
    dfcrfi.Open;

    dfcrfi.Append;
    dfcrfirfinumero.AsInteger:=vlTitCodigo;
    dfcrfirfivencimento.asfloat:=date();
    dfcrfirfivalor.AsCurrency:=vpvalorAReceber;
    dfcrfirfivalorparcela.ascurrency:=vpvalorAReceber;
    dfcrfitfdcodigo.AsInteger:=tfdVenda;
    dfcrfitficodigo.AsInteger:=tfiOutros;
    dfcrfi.Post;



    RegistraRfi(vlTitCodigo,date(),1,rctorcrctvalor.AsCurrency);

    olt.Close;
    olt.Connection:=ZCone;
    olt.ParamByName('orcchave').AsInteger :=vpOrcChave;
    olt.ParamByName('olttipo').AsString :='1';
    olt.Open;

    olt.First;
    while not olt.Eof do
    begin
      if oltolttipo.AsInteger=1 then
        vplteChave:=oltltechave.AsInteger;
      olt.Next;
    end;

    SalvaRegistroTITVENDA(vplteChave.ToString);

    i:=0;
    rctorc.First;
    while not rctorc.Eof do
    begin
      i:=i+1;
      vplteChave:=rctorcltechave.AsInteger;

      if (pos(Uppercase('credito'),uppercase(rctorcrctrede.AsString)) > 0)  then
      begin
        vpTeclaFinalizador := 114;
        vpMdaCodigo := 4;
      end
      else if pos(Uppercase('debito'), uppercase(rctorcrctrede.AsString)) > 0 then
      begin
        vpTeclaFinalizador := 115;
        vpMdaCodigo := 5;
      end
      else if pos(Uppercase('pix'), uppercase(rctorcrctrede.AsString)) > 0 then
      begin
        vpTeclaFinalizador := 119;
        vpMdaCodigo := 6;
      end;

      dtl.Close;
      dtl.Connection:=ZCone;
      dtl.ParamByName('ltechave').AsString :=rctorcltechave.AsString;
      dtl.Open;

      if not dtl.locate('ccxchave;MdaCodigo;lteChave;rdcnrauto;dtlvalor',
                      vararrayof([vpCcxchave,vpMdaCodigo,rctorcltechave.AsString, rctorcrctnrauto.AsString,rctorcrctvalor.AsCurrency]),[])   then
        dtl.Append
      else
        dtl.Edit;

      dtldtlvalorinfo.AsCurrency := rctorcrctvalor.AsCurrency;
      dtlltechave.AsString := rctorcltechave.AsString;
      dtlcedcodigo.AsInteger := 1;
      dtlmdacodigo.AsInteger := vpMdaCodigo;
      dtldtlvalor.AsCurrency := rctorcrctvalor.AsCurrency;
      dtlflacodigo.AsInteger := vpFlaCodigo;
      dtldtlregistro.AsDateTime := Now();
      dtlccxchave.AsInteger := vpCcxchave;
      dtlrdcnrauto.asstring := rctorcrctnrauto.AsString;

      mda.Close;
      mda.ParamByName('mdacodigo').AsInteger := vpMdaCodigo;
      mda.Open;

      dtlmdaidentificacao.AsString := mda.FieldByName('mdaidentificacao').AsString;
      dtl.Post;

      vpdtlchave:=dtldtlchave.AsInteger;

      SalvaRegistroCartaoCredito(vpdtlchave.ToString);

      if vpLteChave=0 then
        vplteChave:=StrToInt(Trim(SalvaRegistroLote));


      olt.Close;
      olt.Connection:=ZCone;
      olt.ParamByName('orcchave').AsInteger :=vpOrcChave;
      olt.ParamByName('olttipo').AsString :='0';
      olt.Open;

      if olt.Locate('orcchave;ltechave',vararrayof([vpOrcChave,vpLteChave]),[] ) then
        olt.Edit
      else
        olt.Append;

      oltorcchave.AsInteger:=vpOrcChave;
      oltltechave.AsInteger:=vpLteChave;
      oltoltidentificacao.AsString:=rctorc.FieldByName('rctcomprovante1via').asstring;
      oltolttipo.AsInteger:=0;
      olt.Post;

      if not mcco.Active then
        mcco.Open;

      RegistraCCO(dtldtlvalor.AsCurrency,  vpContaAdc.ToString,0,tfiCartao,vpdtlchave);

      rctorc.next;

    end;


    if not mcco.Eof then
    begin
      if mccoccochave.AsString<>'' then
      begin
        SalvaRegistroCCO(vpLteChave.ToString, mccoccochave.AsString);
      end;
    end;

    orc.close;
    orc.sql.Text:='UPDATE orc SET stocodigo = 3 WHERE orcchave = ' + vpOrcChave.ToString;
    orc.ExecSQL;

  end;

 // FinalizaRecebimentoParciais;

  rpw.close;
  rpw.ParamByName('orcchave').AsInteger:=vpOrcChave;
  rpw.ParamByName('rpwstatus').AsString:='EM ABERTO';
  rpw.ParamByName('cznchave').AsInteger:=vpcznchave;
  rpw.ParamByName('rpwtoken').AsString:=vpIdPagamento;
  rpw.Open;

  if not rpw.IsEmpty then
  begin
    rpw.Edit;
    rpwrpwtoken.AsString:=vpIdPagamento;
    rpwrpwmesa.AsString:='';
    rpwrpwstatus.AsString:='RECEBIDO';
    rpworcchave.AsInteger:=vpOrcChave;
    rpw.Post;
  end;


  rctorc.First;
  while not rctorc.Eof do
  begin


    dtl.Close;
    dtl.Connection:=ZCone;
    dtl.ParamByName('ltechave').AsString :=rctorcltechave.AsString;
    dtl.Open;

    if not dtl.IsEmpty then
    begin
      if ((dtlmdacodigo.AsInteger=4) or
         (dtlmdacodigo.AsInteger=5)) and
         (trim(dtlrdcnrauto.AsString)='') then
        dtl.Delete
      else
        dtl.Next;

    end;


    rctorc.next;
  end;

  EncerraRecebimento(vpidPagamento);

  GeraNFCe(vpOrcChave.ToString);

  vpOrcChave := 0;

  dfcrfi.close;
  mtit.Close;
  mrfi.Close;
  mrdc.Close;
  mcco.close;

end;


procedure Tftefwifi.GeraNFCe(aOrcChave:String);
var
  vlMesChave: string;
begin
  inherited;

  mor.Close;
  mor.ParamByName('orcchave').AsString := aorcchave;
  mor.Open;

  vlMesChave := mormeschave.AsString;

  ModuloNFCe('EmiteNFCe', fAcesso.Terminal.ToString, vlMesChave, fAcesso.Usuario.ToString);

end;


function Tftefwifi.ModuloNFCe(vfuncao: string; vTrmCodigo: string; vmeschave: string; vClbCodigo: string): Boolean;
type
  Tmodulonfce = function(AOwner: TComponent; Conexao: TUniConnection; vmeschave: string; vfuncao: string; Acesso: TAcesso; vImprimir: Boolean;
    vConsultouSefaz: Boolean; vemail: string): Boolean;

var
  ModuloNFCe: Tmodulonfce;
  vlRetorno: Boolean;
  vlPackNFCe: Cardinal;
  webOnLine:boolean;
begin
  Result := false;
  vlPackNFCe := 0;

  vlPackNFCe := LoadPackage('modulos\mnfegourmet.bpl');

  if vlPackNFCe <> 0 then
    @ModuloNFCe := GetProcAddress(vlPackNFCe, PChar('modulonfce'));

  if Assigned(ModuloNFCe) then
  begin
    webOnLine:=true;
    vlRetorno := ModuloNFCe(Application, Self.ZCone, vmeschave, vfuncao, fAcesso, false, false, '');
    Result := vlRetorno;
  end;

End;






function Tftefwifi.RegistraTit(aetdcodigo: Integer; atitvalor:Currency; aVencimento:TDate): Integer;
begin

  car.Close;
  car.Open;

  if not mtit.Active then
    mtit.Open;


  if mtit.IsEmpty then
    mtit.Append
  else
    mtit.Edit;

  mtittitcodigo.AsInteger := 1;
  mtittithora.AsFloat := now();
  mtitclbcodigo.AsInteger := vpClbCodigo;
  mTitbcocodigo.AsString :='000';
  mtittitprevisao.AsInteger := 0;
  mtitflacodigo.AsInteger := vpFlaCodigo;

  mtitmoecodigo.AsInteger := 1;

  mtittitnumero.AsString := 'Venda: '+vpMesChave.ToString ;
  mtitsrfcodigo.AsInteger := srfQuitado;
  mtittfdcodigo.AsInteger :=  tfdVenda;

  mtitetdcodigo.AsInteger := aetdcodigo;
  mtittitvalor.AsFloat := atitvalor;
  mtittitemissao.AsFloat := Now();
  mtittitvctoinicial.AsFloat := aVencimento;

  mtittithistorico.AsString := '';
  mtittitvalorparcela.AsFloat := atitvalor;
  mtittitparcelas.AsInteger := 1;
  mtittitmoradia.AsFloat := 0;
  mtittitvalomulta.AsFloat := 0;
  mtittitpercmesmora.AsFloat := 0;
  mtittitvalodesc.AsFloat := 0;
  mtittitpercmulta.AsFloat := 0;
  mtitcarcodigo.AsInteger := carcarcodigo.AsInteger;
  mtittitdiasmulta.AsInteger :=0;
  mtittitdiasdesc.AsInteger := 0;
  mtitdtlchave.AsInteger:=vpdtlchave;
  mtit.Post;

  Result := mtittitcodigo.AsInteger;

end;


function Tftefwifi.RegistraRfi(atitcodigo: Integer; aVencimento: TDate; aParcela: Integer; avalor: Double): Integer;
var
  vlRfiChave:Integer;
  vlRfiValor:Currency;
  vlMfiChave:Integer;
  i:Integer;
begin

{  if not mtit.IsEmpty then
  begin}

    if not mrfi.Active then
      mrfi.Open;

    dfcrfi.First;
    i:=dfcrfi.RecordCount;
    while not dfcrfi.Eof do
    begin


      mrfi.Append;
      mrfirfichave.AsInteger:=dfcrfi.RecordCount+1;
      mrfititcodigo.AsInteger := atitcodigo;
      mrfietdcodigo.AsInteger := mtitetdcodigo.AsInteger;
      mrfitfdcodigo.AsInteger := dfcrfitfdcodigo.AsInteger;
      mrfiflacodigo.AsInteger := mtitflacodigo.AsInteger;
      mrfitficodigo.AsInteger := dfcrfitficodigo.AsInteger;
      mrfibcocodigo.AsString := mtitbcocodigo.AsString;
      mrficarcodigo.AsInteger := mtitcarcodigo.AsInteger;
      mrfirfiemissao.AsDateTime := now();
      mrfirfivencimento.AsFloat := dfcrfirfivencimento.AsFloat;
      mrfirfinumero.AsString := mtittitnumero.AsString + '-' + IntToStr(aParcela);

      if mrfirfichave.AsInteger=1 then
      begin
        mrfirfivalor.AsFloat := mTittitvalor.AsCurrency;
        mrfirfivalorparcela.AsFloat :=mTittitvalor.AsCurrency;
      end
      else
      begin
        mrfirfivalor.AsFloat :=  dfcrfirfivalorparcela.AsCurrency;
        mrfirfivalorparcela.AsFloat :=dfcrfirfivalorparcela.AsCurrency;
      end;

      mrfirfihistorico.AsString := mtittithistorico.AsString;
      mrfisrfcodigo.AsInteger := mtitsrfcodigo.AsInteger;
      mrfirfiprevisao.AsInteger := 0;
      mrfidtlchave.AsInteger := vpdtlchave;

      mrfimoecodigo.AsInteger := 1;
      mrfirfirepetir.AsInteger := dfcrfi.RecordCount;

      if dfcrfi.RecordCount>1 then
        mrfifrrcodigo.AsInteger := 2
      else
        mrfifrrcodigo.AsInteger := 1;

      mrfirfipercmesmora.AsFloat :=carcarpercmorames.AsFloat;
      mrfirfidatamulta.asfloat:=0;
      mrfirfivalomulta.asfloat:=0;


      if mrfirfipercmesmora.AsFloat<>0 then
        mrfirfimoradia.AsFloat :=  roundto(((mrfirfivalorparcela.AsFloat* carcarpercmorames.AsFloat)/30), -2 );

      mrfi.Post;

      vlRfiChave:=mrfirfichave.AsInteger;
      vlRfiValor:=mrfirfivalor.AsCurrency;

      Result := vlRfiChave;

      dfcrfi.Next;

    end;

 { end;}

end;

function Tftefwifi.SalvaRegistroTITVENDA(aLteChave:String):string;
var
 vlQuitado:Boolean;
 vlTentativas:Integer;
begin
  Result:='0';

  if vpMesChave=0 then
    exit;


  if not mtit.IsEmpty then
  begin

    tit.Close;
    tit.Connection:=ZCone;
    tit.ParamByName('titnumero').AsString:='Venda: '+vpMesChave.ToString ;
    tit.ParamByName('tfdcodigo').AsInteger:=32;
    tit.Open;


    vlTentativas :=0;
    if tit.IsEmpty then
    begin

      while vlTentativas<10 do
      begin

        try

            tit.Append;

            tittithora.AsFloat := mtittithora.AsFloat;
            titclbcodigo.AsInteger := mtitclbcodigo.AsInteger;
            tittitprevisao.AsInteger := mtittitprevisao.AsInteger;
            titflacodigo.AsInteger := mtitflacodigo.AsInteger;
            titmoecodigo.AsInteger := mtitmoecodigo.AsInteger;
            tittitvctoinicial.AsFloat := mtittitvctoinicial.AsFloat;
            tittitnumero.AsString := 'Venda: '+vpMesChave.ToString ;

            tittfdcodigo.AsInteger :=32;
            titsrfcodigo.AsInteger := srfQuitado;
            vlQuitado:=True;
            tittficodigo.AsInteger := tfiOutros;

            titetdcodigo.AsInteger := mtitetdcodigo.AsInteger;


            tittitvalor.AsFloat := mtittitvalor.AsFloat;
            tittitemissao.AsFloat := mtittitemissao.AsFloat;

            tittithistorico.AsString := mtittithistorico.AsString;
            tittitvalorparcela.AsFloat := mtittitvalorparcela.AsFloat;
            tittitparcelas.AsInteger := mtittitparcelas.AsInteger;
            tittitmoradia.AsFloat := mtittitmoradia.AsFloat;
            tittitvalomulta.AsFloat := mtittitvalomulta.AsFloat;
            tittitpercmesmora.AsFloat := mtittitpercmesmora.AsFloat;
            tittitvalodesc.AsFloat := mtittitvalodesc.AsFloat;
            tittitpercmulta.AsFloat := mtittitpercmulta.AsFloat;
            titbcocodigo.AsString := '000';
            titcarcodigo.AsInteger := 1;
            tittitdiasmulta.AsInteger :=mtittitdiasmulta.AsInteger;
            tittitdiasdesc.AsInteger := mtittitdiasdesc.AsInteger;
            tit.Post;


            SalvaRegistroRFIVENDA(tittitcodigo.AsString, mtittitcodigo.AsString,aLteChave,vlQuitado);

            mrfi.Delete;
            mtit.Delete;

            Result := tittitcodigo.AsString;

            Break;


        except
        on E: Exception do
          begin
            vlTentativas := vlTentativas + 1;
            sleep(300);
          end;
        end;

      end;

    end;

  end;

end;


procedure Tftefwifi.TimerPagamentoTimer(Sender: TObject);
begin

  if zCone<>nil then
  begin

    trmtef.Close;
    trmtef.Connection:=zCone;
    trmtef.parambyname('trmcodigo').asinteger:=vpClbcodigo;
    trmtef.Open;

    if trmteftrmintegrapagarme.AsInteger=1 then
    begin
      // processa venda //

    end;

  end;

end;

procedure Tftefwifi.trmtefBeforeOpen(DataSet: TDataSet);
begin
  (DataSet as tuniquery).Connection:=zCone;
end;

function Tftefwifi.SalvaRegistroCartaoCredito(aDtlChave:String):String;
var
  vlTentativas:Integer;
begin

  if not mrdc.Active then
  exit;

  adc.Close;
  adc.Open;
  vlTentativas :=0;
  while vlTentativas<60 do
  begin

    try
      rdc.close;
      rdc.Connection:=ZCone;
      rdc.ParamByName('rdcnrauto').AsString:=dtlrdcnrauto.AsString;
      rdc.ParamByName('dtlchave').AsString:=aDtlChave;
      rdc.ParamByName('rdcdata').AsDate:=mrdcrdcdata.AsDateTime;
      rdc.ParamByName('adccodigo').AsInteger:=mrdcadccodigo.AsInteger;
      rdc.Open;

      if rdc.IsEmpty then
        rdc.Append
      else
        rdc.Edit;

      rdcrdcvalor.AsCurrency:=dtldtlvalor.AsCurrency;
      rdcrdcnrauto.AsString:=dtlrdcnrauto.AsString;
      rdcrdcdata.AsDateTime:=now();
      rdcadccodigo.AsInteger:= adc.FieldByName('adccodigo').AsInteger;

      rdcrdccomprovante1via.asstring:='';
      rdcrdccomprovante2via.asstring:='';
      rdcrdcparcelas.AsInteger:=1;



      rdcbdccodigo.AsInteger:= bdc.FieldByName('bdccodigo').AsInteger;
      rdcrdchora.asdatetime:=now();
      rdcdtlchave.AsString:=aDtlChave;
      rdc.Post;


      ltr.close;
      ltr.Connection:=ZCone;
      ltr.ParamByName('rdcchave').AsInteger:= rdc.FieldByName('rdcchave').AsInteger;
      ltr.ParamByName('rdcnrauto').AsString:= dtlrdcnrauto.AsString;
      ltr.ParamByName('dtlchave').AsString:= aDtlChave;
      ltr.Open;

      if ltr.IsEmpty then
      begin
        ltr.Append;
        ltr.FieldByName('dtlchave').AsString:=aDtlChave;
        ltr.FieldByName('rdcchave').AsInteger:= rdc.FieldByName('rdcchave').AsInteger;
        ltr.FieldByName('rdcnrauto').AsString:= dtlrdcnrauto.AsString;
        ltr.Post;
      end;

      Break;
    Except
    on E: Exception do
      begin
        vlTentativas := vlTentativas +1;
        Sleep(300);
      end;
    end;

  end;

end;

function Tftefwifi.EncerraRecebimento(aOrder:String):Boolean;
var
 lRes: IResponse;
 lJson: TJson;
 vlTentativas:Integer;
 vlRequest:Boolean;
begin

  adc.Close;
  adc.Connection:=zCone;
  adc.Open;
  vpAdmin :=adc.FieldByName('adcchaveintegracao').asstring;

  Result:= False;
  lJson := TJson.Create;
  try

    lJson.Put('status', 'paid');
    vlTentativas :=0;
    while (vlTentativas<=10) do
    begin
      try

      lRes := TRequest.New.BaseURL(Format('https://api.pagar.me/core/v5/orders/%s/closed', [aOrder]))
                          .BasicAuthentication(vpAdmin,'')
                          .ContentType('application/json')
                          .AddBody(lJson.Stringify)
                          .Patch;
            vlRequest:=true;
            break;

      except
        vlRequest:=False;
        vlTentativas:=vlTentativas+1;
        sleep(300);
      end;
    end;

    if vlRequest then
    begin

      if (lRes.StatusCode = 200) and ((lRes.Content) <> '') then
      begin
        Result := True;
      end;

      if pos('This order is closed',lRes.Content)>0 then
      begin
       Result := True;
      end;

    end;


  finally
     lJson.Free;
  end;

end;


function Tftefwifi.ExecutaCancelamentoStone(aIdPagamento:string; aOrcChave:string):boolean;
var
  lJson: TJson;
  lRes: IResponse;
  vlTentativas:Integer;
  vlRequest:Boolean;
begin

  adc.Close;
  adc.Connection:=zCone;
  adc.Open;
  vpAdmin :=adc.FieldByName('adcchaveintegracao').asstring;

  lJson := TJson.Create;
  try
    lJson.Put('status', 'canceled');
    vlTentativas:=0;
    while (vlTentativas<=10) do
    begin
      try
        lRes := TRequest.New.BaseURL(Format('https://api.pagar.me/core/v5/orders/%s/closed', [aIdPagamento]))
                         .BasicAuthentication(vpAdmin, '')
                         .ContentType('application/json')
                         .AddBody(lJson.Stringify)
                        .Patch;

        vlRequest:=true;
        break;

      except
        vlRequest:=False;
        vlTentativas:=vlTentativas+1;
        sleep(300);
      end;
    end;

    if vlRequest then
    begin
      if (lRes.StatusCode = 200) and ((lRes.Content) <> '') then
      begin

        try

        {  orc.close;
          orc.sql.Text := 'UPDATE orc SET stocodigo = 2, orcimpressao = 0 WHERE orcchave = ' + aOrcChave;
          orc.ExecSQL; }

          rpw.close;
          rpw.ParamByName('orcchave').AsString:=aOrcChave;
          rpw.ParamByName('rpwstatus').AsString:='EM ABERTO';
          rpw.ParamByName('cznchave').AsInteger:=vpcznchave;
          rpw.ParamByName('rpwtoken').AsString:=aIdPagamento;
          rpw.Open;

          if not rpw.IsEmpty then
          begin
            rpw.Edit;
            rpwrpwtoken.AsString:=aIdPagamento;
            rpwrpwstatus.AsString:='CANCELADO';
            rpworcchave.AsString:=aOrcChave;
            rpw.Post;
          end;


        except
          on E: Exception do
          begin

          end;
        end;
      end ;
    end;
  finally
    lJson.Free;
  end;
end;





procedure Tftefwifi.SalvaRegistroRFIVENDA(aTitCodigo:String;mtitcodigo:String; aLtechave:String; aSituacao:Boolean);
var
  vlRfiChave:String;
  vlRfiValor:Currency;
  vlTentativas:Integer;

begin

    vlTentativas := 0;
    while vlTentativas<10 do
    begin

      try

        rfi.Close;
        rfi.Connection:=ZCone;
        rfi.ParamByName('titcodigo').AsString := aTitCodigo;
        rfi.Open;

       // mrfi.First;

       // while not mrfi.Eof do
       // begin

            if not rfi.Locate('rfihistorico' ,mrfirfihistorico.AsString,[]) then
            begin

              rfi.Append;
              rfititcodigo.AsString := aTitCodigo ;
              rfietdcodigo.AsInteger := mtitetdcodigo.AsInteger;
              rfiflacodigo.AsInteger := mrfiflacodigo.AsInteger;
              rfibcocodigo.AsString := mrfibcocodigo.AsString;
              rficarcodigo.AsInteger := mrficarcodigo.AsInteger;
              rfitfdcodigo.AsInteger := mrfitfdcodigo.AsInteger;
              rfirfiemissao.AsDateTime := mRfirfiemissao.AsDateTime;
              rfirfivencimento.AsFloat :=mrfirfivencimento.AsFloat;
              rfirfinumero.AsString := 'Venda: '+vpMesChave.ToString ;

              if (mrfitfdcodigo.AsInteger=tfdVenda)  then
              begin

                rfitfdcodigo.AsInteger := tfdVenda;
                rfisrfcodigo.AsInteger := srfQuitado

              end
              else
              begin
                rfitfdcodigo.AsInteger := tfdReceber;
                rfisrfcodigo.AsInteger := srfEmAberto;
              end;

              rfitficodigo.AsInteger := mrfitficodigo.AsInteger;

              rfirfivalor.AsFloat := mrfirfivalor.AsFloat;

              rfirfihistorico.AsString := mrfirfihistorico.AsString;
              rfifrrcodigo.AsInteger :=  mrfifrrcodigo.AsInteger;
              rfirfimoradia.AsFloat := mrfirfimoradia.AsFloat;
              rfirfipercmesmora.AsFloat := mrfirfipercmesmora.AsFloat;
              rfirfirepetir.AsInteger := mrfirfirepetir.AsInteger;
              rfirfiprevisao.AsInteger := mrfirfiprevisao.AsInteger;
              rfirfivalorparcela.AsFloat := mrfirfivalorparcela.AsFloat;
              rfimoecodigo.AsInteger := mrfimoecodigo.AsInteger;
              rfirfidatamulta.AsFloat := mrfirfidatamulta.AsFloat;
              rfirfivalomulta.AsFloat := mrfirfivalomulta.AsFloat;

              rfi.Post;

              vlRfiValor:=rfirfivalor.AsFloat;
              vlRfiChave:=rfirfichave.AsString;


              SalvaRegistroRFMVENDA(vlRfiChave);

              SalvaRegistroMFIVENDA(vlrfiChave, vlRfiValor, tmfAReceber, aLtechave );


              if  (mrfitfdcodigo.AsInteger=tfdVenda)  then
              begin
                SalvaRegistroMFIVENDA(vlrfiChave, vlRfiValor, tmfRecebimento, aLtechave);
              end;

            end;
       //   mrfi.next;
             //  end;
        break;
      Except
        on E: Exception do
        begin
          sleep(300);
          vlTentativas := vlTentativas + 1;
        end;
      end;
    end;
end;

procedure Tftefwifi.SalvaRegistroRFMVENDA(aRfichave:String);
var
  vlTentativas : Integer;
begin

    vlTentativas := 0;

    while vlTentativas<5 do
    begin

      try

        rfm.Close;
        rfm.Connection:=ZCone;
        rfm.ParamByName('rfichave').AsString :=aRfichave;
        rfm.ParamByName('meschave').AsInteger :=vpmeschave;
        rfm.Open;

        if rfm.IsEmpty then
        begin
          rfm.Append;
          rfmrfichave.AsString := aRfichave;
          rfmflacodigo.AsInteger := vpFlaCodigo;
          rfmmeschave.AsInteger := vpmeschave;
          rfm.Post;
        end;

        rfm.Close;
        break;
      Except
      on E: Exception do
        begin
          sleep(100);
          vlTentativas := vlTentativas + 1;
        end;
      end;
    end;

end;

procedure Tftefwifi.SalvaRegistroMFIVENDA(arfiChave:String; aRfiValor:Currency; atmfCodigo:Integer; aLteChave:String);
var
  vlmfiChave: String;
  vlTentativas : Integer;
begin
    vlTentativas := 0;
    while vlTentativas<10 do
    begin

      try

        mfi.Close;
        mfi.Connection:=ZCone;
        mfi.ParamByName('rfichave').AsString := arfiChave;
        mfi.ParamByName('tmfcodigo').AsInteger := atmfCodigo;
        mfi.Open;

        if mfi.IsEmpty then
        begin

          mfi.Append;
          mfirfichave.AsString := arfiChave;
          mfitmfcodigo.AsInteger := atmfCodigo;
          mfimoecodigo.AsInteger := 1;
          mfimfivalor.AsFloat :=aRfiValor;
          mfimfidata.AsFloat := now();
          mfimfihistorico.AsString := '';
          mfimfivalorori.AsFloat :=aRfiValor;
          mfimfiparcela.AsInteger := 0;
          mfi.Post;


        end;

        vlmfiChave := mfimfichave.AsString;

        mfi.Close;

        if atmfCodigo=21 then
          SalvaRegistroMLTVENDA(vlmfiChave,aLteChave);

        break;

      Except
        on E: Exception do
        begin
          sleep(300);
          vlTentativas := vlTentativas + 1;
        end;
      end;
    end;
end;

procedure Tftefwifi.SalvaRegistroMLTVENDA(aMfiChave:String; aLteChave:String);
var
  vlTentativas : Integer;
begin
    vlTentativas := 0;
    while vlTentativas<10 do
    begin

      try

        mlt.Close;
        mlt.Connection:=ZCone;
        mlt.ParamByName('mfichave').AsString := aMfiChave;
        mlt.ParamByName('ltechave').AsString := aLteChave;
        mlt.Open;

        if mlt.IsEmpty then
        begin

          mlt.Append;
          mltmfichave.AsString := aMfiChave;
          mltltechave.AsString := aLteChave;
          mltflacodigo.AsInteger := vpFlaCodigo;
          mlt.Post;

        end;

        mlt.Close;
        break;

      Except
        on E: Exception do
        begin
          sleep(300);
          vlTentativas := vlTentativas + 1;
        end;
      end;
    end;
end;


{
adc.close;
              adc.Open;

              if adc.FieldByName('adcchaveintegracao').asstring<>'' then
              begin
                pss.close;
                pss.ParamByName('clbcodigo').AsString:=clbentclbcodigo.AsString;
                pss.Open;

                if not pss.IsEmpty then
                begin
                  if pssposnumeroserie.AsString<>'' then
                  begin
                    recebimentoDireto(orcsorcchave.AsString,
                                      orcsorcnumeropedido.AsString,
                                      pssposnumeroserie.AsString,
                                      orcsorctotal.AsCurrency);
                  end;
                end;

              end;
}










end.
