unit uFprinciEntregas;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, DBAccess, Uni, DASQLMonitor,
  UniSQLMonitor, UniProvider, MySQLUniProvider, uPegabase, ufuncoes, inifiles,
  MemDS, Vcl.ExtCtrls, Vcl.StdCtrls, System.Actions, Vcl.ActnList, Vcl.Themes,
  Vcl.Buttons, ufrmbase, frxClass, frxDACComponents, frxUniDACComponents, dateutils,
  Vcl.Grids, Vcl.DBGrids, frxDBSet, VirtualTable, frxDCtrl, frxBarcode, frxDesgn,
  System.ImageList, Vcl.ImgList, Vcl.ComCtrls, Vcl.Menus, Vcl.OleCtrls,
  Vcl.Imaging.pngimage,ugestaoentregas,json;

type
  TPanel = Class(Vcl.ExtCtrls.TPanel)
  protected
    procedure Paint; override;
  End;

type
  TGroupBox = class(Vcl.StdCtrls.TGroupBox)
    // declare this before of your form definitiondirei
  public
    procedure Paint; override;
  end;

type
  TFrmBaseClass = class of TFrmBase;

type
  TFprinciEntregas = class(TForm)
    MySQLUniProvider: TMySQLUniProvider;
    UniSQLMonitor: TUniSQLMonitor;
    Conexao: TUniConnection;
    consulta: TUniQuery;
    imp: TUniQuery;
    pltopo: TPanel;
    cfg: TUniQuery;
    cfgcfgcodigo: TIntegerField;
    cfgcfgidentificacao: TStringField;
    cfgcfgdoisprecos: TIntegerField;
    cfgcfgusasrv: TIntegerField;
    cfgcfgpedeoperador: TIntegerField;
    cfgcfgtipocomissao: TIntegerField;
    cfgcfgpercomismed: TIntegerField;
    cfgcfgusamultiplicador: TIntegerField;
    cfgcfgidentificaequip: TIntegerField;
    cfgcfgrefepro: TIntegerField;
    cfgcfgdefinetoeatendimento: TIntegerField;
    cfgcfgusaveiculo: TIntegerField;
    cfgcfgcontrolaestoquedisp: TIntegerField;
    cfgcfgpedeclientevenda: TIntegerField;
    cfgetdapelido: TStringField;
    cfgcfgusanfc: TIntegerField;
    cfgcfgusapdv: TIntegerField;
    cfgetddoc1: TStringField;
    cfgcfgetdempresa: TIntegerField;
    cfgcfgprouso: TIntegerField;
    cfgcfgtoeusofora: TIntegerField;
    cfgcfgtoeusointe: TIntegerField;
    cfgcfgtoecuffora: TIntegerField;
    cfgcfgtoecufinte: TIntegerField;
    cfgcfgviasnfe: TIntegerField;
    cfgcfgnumeronfe: TIntegerField;
    cfgcfgserienfe: TStringField;
    cfgcfgnumeronfce: TIntegerField;
    cfgcfgserienfce: TStringField;
    cfgcfgobs1: TIntegerField;
    cfgcfgobs2: TIntegerField;
    cfgcfgobs3: TIntegerField;
    cfgcfgobs4: TIntegerField;
    cfgcfgdescrinfe: TIntegerField;
    cfgcfgmodonfe: TIntegerField;
    cfgcfgemailnfe: TStringField;
    cfgcfgemailservidornfe: TStringField;
    cfgcfgemailsenhanfe: TStringField;
    cfgcfgmailportnfe: TStringField;
    cfgcfgemailusatls: TIntegerField;
    cfgcrtcodigo: TIntegerField;
    cfgcfgcstterceiros: TStringField;
    cfgetdidentificacao: TStringField;
    cfgufscodigo: TStringField;
    cfgcddcodigo: TStringField;
    cfgedrinscest: TStringField;
    cfgedrrua: TStringField;
    cfgedrnumero: TStringField;
    cfgedrbairro: TStringField;
    cfgedrcep: TStringField;
    cfgcddnome: TStringField;
    cfgufssigla: TStringField;
    cfgetftelefone: TStringField;
    cfgctdboxedominio: TStringField;
    cfgcfgmensagempdv: TStringField;
    cfgcfgservarqnfes: TStringField;
    cfgcfgusacondiconsumidor: TIntegerField;
    cfgcfgviaassinar: TIntegerField;
    cfgcfgusaadc: TIntegerField;
    cfgcfgusacre: TIntegerField;
    cfgcfgdigitosbalanca: TIntegerField;
    cfgcfgcontrolalimite: TIntegerField;
    cfgcfgidentificatecnico: TIntegerField;
    cfgcfgusacaixaprevenda: TIntegerField;
    cfgcfgusache: TIntegerField;
    cfgcfgidentificavendedor: TIntegerField;
    cfgcfgajustaperccomissao: TIntegerField;
    cfgcfgusabol: TIntegerField;
    cfgcfgusavendaforaestab: TIntegerField;
    cfgcfgdescontonoservico: TIntegerField;
    cfgcfgformapagamento: TIntegerField;
    cfgcfgformacancelamento: TIntegerField;
    cfgcfgarredondapeso: TIntegerField;
    cfgcfgusaafaturar: TIntegerField;
    cfgcfgusagou: TIntegerField;
    cfgcfgproinativsaldozero: TIntegerField;
    cfgcfgprevisualizarimpressao: TIntegerField;
    trm: TUniQuery;
    trmtrmcodigo: TIntegerField;
    trmtrmidentificacao: TStringField;
    trmtciporta: TStringField;
    trmecfcodigo: TIntegerField;
    trmtipcodigo: TIntegerField;
    trmtrmgaveta: TIntegerField;
    fla: TUniQuery;
    flaflacodigo: TIntegerField;
    flaflaidentificacao: TStringField;
    flaflasigla: TStringField;
    flaetdcodigo: TIntegerField;
    lbNomeEmpresa: TPanel;
    lterminal: TPanel;
    acoes: TActionList;
    ActAbreCaixa: TAction;
    ActFechaCaixa: TAction;
    ActListaCaixas: TAction;
    ActSangria: TAction;
    ActSuprimento: TAction;
    ActImprimeCaixa: TAction;
    ActAbreGaveta: TAction;
    ActSair: TAction;
    ActReimprimeAbertura: TAction;
    ActReimprimeSangria: TAction;
    ActReimprimeSuprimento: TAction;
    ActReimprimeFechamento: TAction;
    act: TUniQuery;
    actactcodigo: TIntegerField;
    Timer2: TTimer;
    ccx: TUniQuery;
    ccxccxchave: TIntegerField;
    ccxclbcodigo: TIntegerField;
    ccxctacodigo: TIntegerField;
    ccxccxturno: TIntegerField;
    ccxccxdataber: TDateField;
    ccxccxhoraaber: TTimeField;
    ccxccxsaldoaber: TFloatField;
    ccxccxdatafecha: TDateField;
    ccxccxhorafecha: TTimeField;
    ccxccxsaldofecha: TFloatField;
    ccxccxsangrias: TFloatField;
    ccxccxsuprimentos: TFloatField;
    Dccx: TDataSource;
    plMensagemPrincipal: TPanel;
    plRodaPe: TPanel;
    GBFuncoes: TGroupBox;
    GroupBox1: TGroupBox;
    GroupBox2: TGroupBox;
    plCentro: TPanel;
    plListaPedidos: TPanel;
    plColabordores: TPanel;
    ActAbrirCaixaEntregador: TAction;
    ActFecharCaixaEntregador: TAction;
    clbcax: TUniQuery;
    clbcaxcceabertura: TDateTimeField;
    ActSelecionarEntregador: TAction;
    ActReimprimePedido: TAction;
    ActCancelaPedido: TAction;
    ActAtualizarLista: TAction;
    relatorio: TfrxReport;
    frxUniDACComponents1: TfrxUniDACComponents;
    cfgcfgmgourelentreresumido: TStringField;
    cfgcfgmgourelentrecomple: TStringField;
    clbent: TUniQuery;
    dsOrcs: TUniDataSource;
    orcs: TUniQuery;
    lito: TUniQuery;
    litoitoitem: TIntegerField;
    litoprocodigo: TIntegerField;
    litopronome: TStringField;
    litoitoquantidade: TFloatField;
    litoitovalor: TFloatField;
    litoitototal: TFloatField;
    litoitodesconto: TFloatField;
    litoitosaldo: TFloatField;
    litoprosaldodisp: TFloatField;
    litoitochave: TIntegerField;
    litounisimbolo: TStringField;
    litounicodigo: TIntegerField;
    litoorcchave: TIntegerField;
    litotdecodigo: TIntegerField;
    litoproreferencia: TStringField;
    litoitoproservico: TStringField;
    litoitoinfadprod: TStringField;
    litotpocodigo: TIntegerField;
    litoitoprocomple: TStringField;
    litopropededescrserv: TIntegerField;
    litopropedetecnicoserv: TIntegerField;
    litovrpcodigo: TIntegerField;
    horario: TPanel;
    dsorcssai: TUniDataSource;
    orcssai: TUniQuery;
    orcssaiorcchave: TIntegerField;
    orcssaiorcdataabert: TDateField;
    orcssaiorchoraabert: TTimeField;
    orcssaiorcdataencerr: TDateField;
    orcssaiorchoraencerr: TTimeField;
    orcssaietdcodigo: TIntegerField;
    orcssaietdidentificacao: TStringField;
    orcssaiorcgeral: TFloatField;
    orcssaiorcdesconto: TFloatField;
    orcssaiorctotal: TFloatField;
    orcssaiclbidentificacao: TStringField;
    orcssaiorcobs: TStringField;
    orcssaiorcnome: TStringField;
    orcssaiorcendereco: TStringField;
    orcssaiorctelefone: TStringField;
    orcssaipuocodigo: TIntegerField;
    orcssaiedrbairro: TStringField;
    orcssaiedrendereco: TStringField;
    orcssaipdghoraentrega: TStringField;
    orcssaiorcdescrpagto: TStringField;
    orcssaipdgnumero: TStringField;
    orcssaietdidentificacaoent: TStringField;
    orcssaiorcretorno: TStringField;
    clbsit: TUniQuery;
    clbsitorcchave: TIntegerField;
    clbsitpdghoraentrega: TStringField;
    clbsitpdgnumero: TStringField;
    clbsitorcretorno: TStringField;
    listaOrcs: TDBGrid;
    sbAtualizarLista: TSpeedButton;
    frxDados: TfrxDBDataset;
    Splitter1: TSplitter;
    plbuscaaentregar: TPanel;
    edPesquisarAEntregar: TEdit;
    Panel1: TPanel;
    plbuscaentrege: TPanel;
    edPesquisarEntregues: TEdit;
    Panel3: TPanel;
    lista: TDBGrid;
    sbAbrirCaixaEntregador: TSpeedButton;
    sbFecharCaixaEntregador: TSpeedButton;
    sbSelecionarEntregador: TSpeedButton;
    sbReimprimePedido: TSpeedButton;
    sbCancelaPedido: TSpeedButton;
    sbSair: TSpeedButton;
    sbAbreCaixa: TSpeedButton;
    sbFechaCaixa: TSpeedButton;
    sbListaCaixas: TSpeedButton;
    sbSangria: TSpeedButton;
    sbSuprimento: TSpeedButton;
    sbImprimeCaixa: TSpeedButton;
    ActTrocarEntregador: TAction;
    sbTrocarEntregador: TSpeedButton;
    sbReimprimeAbertura: TSpeedButton;
    sbReimprimeSangria: TSpeedButton;
    sbReimprimeSuprimento: TSpeedButton;
    sbReimprimeFechamento: TSpeedButton;
    cfgcfgmgouctadelivery: TIntegerField;
    clb: TUniQuery;
    clbclbcodigo: TIntegerField;
    clbclbdescmaximo: TFloatField;
    clbclbsenha: TStringField;
    clbclbativo: TStringField;
    clbclbidentificacao: TStringField;
    clbclbsuper: TIntegerField;
    dau: TUniQuery;
    lcolaborador: TPanel;
    clbcaxclbcodigo: TIntegerField;
    clbcaxclbidentificacao: TStringField;
    clbentclbcodigo: TIntegerField;
    clbentclbidentificacao: TStringField;
    plQuantidadeAEntregar: TPanel;
    plQuantidadeEntregues: TPanel;
    plEsquerda: TPanel;
    plDisponiveis: TPanel;
    plTituloDisponiveis: TPanel;
    v: TPanel;
    plTituloEmEntrega: TPanel;
    Splitter2: TSplitter;
    DBGDisponiveis: TDBGrid;
    DBGNaRua: TDBGrid;
    UniDataSource1: TUniDataSource;
    UniDataSource2: TUniDataSource;
    vtDisponiveis: TVirtualTable;
    vtEmEntrega: TVirtualTable;
    vtDisponiveisclbcodigo: TIntegerField;
    vtDisponiveisclbidentificacao: TStringField;
    vtDisponiveishorachegada: TTimeField;
    vtDisponiveishorasaida: TTimeField;
    clbsitclbcodigo: TIntegerField;
    vtEmEntregaclbcodigo: TIntegerField;
    vtEmEntregaclbidentificacao: TStringField;
    vtEmEntregahorachegada: TTimeField;
    vtEmEntregahorasaida: TTimeField;
    vtEmEntregatempo: TTimeField;
    vtDisponiveistempo: TTimeField;
    dsvtEmEntrega: TUniDataSource;
    dsvtDisponiveis: TUniDataSource;
    vtDisponiveishora: TStringField;
    vtEmEntregahora: TStringField;
    orcssaitempoementrega: TStringField;
    frxDesigner1: TfrxDesigner;
    frxUserDataSet1: TfrxUserDataSet;
    frxBarCodeObject1: TfrxBarCodeObject;
    frxDialogControls1: TfrxDialogControls;
    ActTrocarPagamento: TAction;
    sbTrocarPagamento: TSpeedButton;
    ActCriaVoucher: TAction;
    sbCriaVoucher: TSpeedButton;
    orcabe: TUniQuery;
    orcabeorcchave: TIntegerField;
    orcssaipdsidentificacao: TStringField;
    orcssaiclbcodigoent: TIntegerField;
    orcssaisituacaocaixa: TStringField;
    clbsitstocodigo: TIntegerField;
    orcssaipdscodigo: TIntegerField;
    ImageList1: TImageList;
    sbCancelarEntregador: TSpeedButton;
    ActCancelarEntregdor: TAction;
    SpeedButton2: TSpeedButton;
    ActCaixasEntregadores: TAction;
    orcssaistocodigo: TIntegerField;
    clbczn: TUniQuery;
    clbcznclbcodigo: TIntegerField;
    clbcznclbidentificacao: TStringField;
    clbczncceabertura: TDateTimeField;
    clbcznccechave: TIntegerField;
    clbcznccefechamento: TDateTimeField;
    cfgcfgmgoutempoatuentrega1: TIntegerField;
    cfgcfgmgoutempoatuentrega2: TIntegerField;
    cfgcfgmgouatualizaentrega: TIntegerField;
    cfgcfgmgoutempoatuproducao: TIntegerField;
    TimerProducao: TTimer;
    Timer1: TTimer;
    imaconexao5: TImage;
    imaconexao4: TImage;
    imaconexao3: TImage;
    imaconexao2: TImage;
    IMenuInfo: TImage;
    cfgcfgmgoutempoentrega: TIntegerField;
    Label1: TLabel;
    sbRegistrarRetornos: TSpeedButton;
    ActLiberarEntrega: TAction;
    PopupMenuOrcs: TPopupMenu;
    mQuemProduziu: TMenuItem;
    verhorario: TUniQuery;
    lcozinha: TPanel;
    orcssaitempototal: TTimeField;
    plversao: TPanel;
    cfgcfgmgoucontrolaentrega: TIntegerField;
    plccxchave: TPanel;
    ActResumoEntrega: TAction;
    spResumoEntregas: TSpeedButton;
    mostra: TProgressBar;
    cfgcfgmgouretornartodos: TIntegerField;
    dtl: TUniQuery;
    dtlltechave: TIntegerField;
    dtlmdaidentificacao: TStringField;
    dtldtlvalor: TFloatField;
    mce: TUniQuery;
    mcemcechave: TIntegerField;
    mcercrchave: TIntegerField;
    mcetmccodigo: TIntegerField;
    mcemcemotivo: TStringField;
    mcemecregistro: TDateTimeField;
    mceltechave: TIntegerField;
    mceclbcodigo: TIntegerField;
    mcr: TUniQuery;
    mcrmcrchave: TIntegerField;
    mcrrcrchave: TIntegerField;
    mcrmcrvalor: TCurrencyField;
    mcrmcechave: TIntegerField;
    sbWhatsapp: TSpeedButton;
    ActWhatsAPP: TAction;
    DBGridLista: TDBGrid;
    ActRegistrarRetornos: TAction;
    edRetorno: TEdit;
    pledRetorno: TPanel;
    RegistrarRetornos1: TMenuItem;
    orcspdgnumero: TStringField;
    orcspdsidentificacao: TStringField;
    orcstempo: TStringField;
    orcsedrendereco: TStringField;
    orcsedrbairro: TStringField;
    orcsorctotal: TFloatField;
    orcsetdidentificacao: TStringField;
    orcsmitidentificacao: TStringField;
    orcsoriidentificacao: TStringField;
    orcsorcnumeropedido: TStringField;
    orcsorchoraabert: TTimeField;
    orcsorcchave: TIntegerField;
    orcsmarca: TIntegerField;
    orcsstocodigo: TIntegerField;
    orcsmoccodigo: TIntegerField;
    orcsorcliberadoentrega: TDateTimeField;
    orcsorcdataabert: TDateField;
    pcPaginas: TPageControl;
    tsPrincipal: TTabSheet;
    orcssaiorcnumeropedido: TStringField;
    ActGerarNotas: TAction;
    SBGerarNFCe: TSpeedButton;
    clbcaxccechave: TIntegerField;
    bai: TUniQuery;
    qryNumeroPedidoUniQuery1: TUniQuery;
    orcsorcpedidointegracao: TStringField;
    clbcaxmaquina: TStringField;
    clbcznmaquina: TStringField;
    clbentmaquina: TStringField;
    itoimm: TUniQuery;
    adc: TUniQuery;
    adcadccodigo: TIntegerField;
    adcadcidentificacao: TStringField;
    adcadcchaveintegracao: TStringField;
    adcadcserviconome: TStringField;
    adcetdcodigo: TIntegerField;
    adcctacodigo: TIntegerField;
    qrypos: TUniQuery;
    qryposposcodigo: TIntegerField;
    qryposposidentificacao: TStringField;
    qryposposnumeroserie: TStringField;
    rpw: TUniQuery;
    rpworcchave: TIntegerField;
    rpwrpwchave: TIntegerField;
    rpwrpwtoken: TStringField;
    rpwrpwstatus: TStringField;
    rpwrpwjson: TMemoField;
    TimerRPW: TTimer;
    imStoneonLine: TImage;
    rpwrpwmesa: TStringField;
    rpworctotalav: TFloatField;
    rpworcgeralav: TFloatField;
    rpworc: TUniQuery;
    rpworcrpwchave: TIntegerField;
    rpworcrpwtoken: TStringField;
    rpworcrpwmesa: TStringField;
    rpworcrpwstatus: TStringField;
    rpworcorcchave: TIntegerField;
    rpworccznchave: TIntegerField;
    rpworcrpwjson: TMemoField;
    rpworcorctotalav: TCurrencyField;
    orcsorcobs: TStringField;
    orcsoricodigo: TIntegerField;
    mor: TUniQuery;
    mormorchave: TIntegerField;
    mormeschave: TIntegerField;
    mororcchave: TIntegerField;
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);
    procedure FormCreate(Sender: TObject);
    procedure ActSairExecute(Sender: TObject);
    procedure ActAbrirCaixaEntregadorExecute(Sender: TObject);
    procedure ActFecharCaixaEntregadorExecute(Sender: TObject);
    procedure ActReimprimeAberturaExecute(Sender: TObject);
    procedure ActReimprimeSangriaExecute(Sender: TObject);
    procedure ActReimprimeSuprimentoExecute(Sender: TObject);
    procedure ActReimprimeFechamentoExecute(Sender: TObject);
    procedure ActAbreCaixaExecute(Sender: TObject);
    procedure ActFechaCaixaExecute(Sender: TObject);
    procedure ActListaCaixasExecute(Sender: TObject);
    procedure ActSangriaExecute(Sender: TObject);
    procedure ActSuprimentoExecute(Sender: TObject);
    procedure ActImprimeCaixaExecute(Sender: TObject);
    procedure ActAbreGavetaExecute(Sender: TObject);
    procedure ActSelecionarEntregadorExecute(Sender: TObject);
    procedure dsOrcsDataChange(Sender: TObject; Field: TField);
    procedure ActAtualizarListaExecute(Sender: TObject);
    procedure listaOrcsCellClick(Column: TColumn);
    procedure listaOrcsDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure listaOrcsEnter(Sender: TObject);
    procedure listaOrcsTitleClick(Column: TColumn);
    procedure SpeedButton5Click(Sender: TObject);
    procedure ActReimprimePedidoExecute(Sender: TObject);
    procedure listaCellClick(Column: TColumn);
    procedure ActCancelaPedidoExecute(Sender: TObject);
    procedure listaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure listaTitleClick(Column: TColumn);
    procedure edPesquisarEntreguesKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edPesquisarAEntregarKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Timer2Timer(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure DBGDisponiveisDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure DBGNaRuaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure ActTrocarEntregadorExecute(Sender: TObject);
    procedure listaEnter(Sender: TObject);
    procedure ActTrocarPagamentoExecute(Sender: TObject);
    procedure dsorcssaiDataChange(Sender: TObject; Field: TField);
    procedure listaOrcsDblClick(Sender: TObject);
    procedure listaOrcsKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure listaKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGNaRuaKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGDisponiveisKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure ActCancelarEntregdorExecute(Sender: TObject);
    procedure ActCaixasEntregadoresExecute(Sender: TObject);
    procedure listaDblClick(Sender: TObject);
    procedure acoesExecute(Action: TBasicAction; var Handled: Boolean);
    procedure Timer1Timer(Sender: TObject);
    procedure ActLiberarEntregaExecute(Sender: TObject);
    procedure mQuemProduziuClick(Sender: TObject);
    procedure listaOrcsMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure listaMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure ActResumoEntregaExecute(Sender: TObject);
    procedure ActWhatsAPPExecute(Sender: TObject);
    procedure ActRegistrarRetornosExecute(Sender: TObject);
    procedure edRetornoKeyPress(Sender: TObject; var Key: Char);
    procedure plversaoDblClick(Sender: TObject);
    procedure ActGerarNotasExecute(Sender: TObject);
    procedure listaOrcsMouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure listaOrcsMouseEnter(Sender: TObject);
    procedure listaOrcsMouseWheel(Sender: TObject; Shift: TShiftState;
      WheelDelta: Integer; MousePos: TPoint; var Handled: Boolean);
    procedure listaOrcsMouseWheelDown(Sender: TObject; Shift: TShiftState;
      MousePos: TPoint; var Handled: Boolean);
    procedure listaOrcsMouseWheelUp(Sender: TObject; Shift: TShiftState;
      MousePos: TPoint; var Handled: Boolean);
    procedure FormActivate(Sender: TObject);

  private
    { Private declarations }

    Acesso: TAcesso;
    FAcsCodigo: Integer;
    FRegistroFrmBase: String;
    function LogarSistema: Boolean;
    procedure SetAcsCodigo(const Value: Integer);
    procedure ConectaBanco;
    procedure Mostraerro(Texto: String);
    procedure FormErroShow(Sender: TObject);
    procedure FerroKeyPress(Sender: TObject; var Key: Char);
    procedure InicializacaoGeral;
    function ValidaTerminal: Boolean;
    procedure CriaAcoesDeAcesso;
    procedure AtribuiTagAcesso;
    procedure LigaTimer(Sender: TObject; var Done: Boolean);
    procedure DesligaTimer(var MSG: tagMSG; var Handled: Boolean);
    procedure Ajustabotoes(Situacao: Boolean);
    procedure AjustaCaixa;
    procedure ImprimeComprovantesCaixa(vOperacaoCaixa: Integer);
    function RegistraOperacaoCaixa(vTocCodigo: Integer): string;
    function AbreGavetaNF: Boolean;
    procedure SituacaoEntregadores;
    procedure AtualizaSituacaoItens(ChaveOrc: String; Situacao: Integer; TipoDocumento: String);
    function ExecutaSQL(Script: String): Boolean;
    function Autorizado(pAction: TAction; pMotivo: String): Boolean;
    function CancelarRFI(vMesChave, motivo, vMeaCodigo: string): string;
    function ProcessaVendas(vOrcchave: string; vAFaturar: Boolean = false): string;

    function FechaVendas(vOrcchave: string): string;
    function Finaliza(Vchave: String; vetdcodigo: String; vAcesso: TAcesso; vValorFinalizador: currency; vTeclaFinalizador: Integer;
      vorcgeralav: currency; vorcdescontoav: String): String;
    function SelecionarEntregador: Boolean;

    function RegistroAcessoOperacao(vactcodigo: string; vMotivo: string; vtabela: string = ''; vregistro: string = ''): Boolean;
    procedure CancelaVenda(vMesChave, vMeaCodigo: string);
    procedure CancelarRCR(vMesChave, vMotivo, vlMeaCodigo: STRING);
    function RegistraRetornoEntrega(Value: string): string;

    procedure AtualizaListas(vPode: Boolean = false);

    procedure LimpaRecebimentosStone(aOrcChave:Integer);
    procedure GeraNFCe(aOrcChave: String);
    function ModuloNFCe(vfuncao, vTrmCodigo, vmeschave,
      vClbCodigo: string): Boolean;

  public
    { Public declarations }
    vpIntegraStone:string;
    vpImmNumePedido: Integer;
    vpVerificaInternet: Integer;
    vpContaTempo: Integer;
    vpPodeAtualizar: Boolean;
    vpOrcChave: string;
    vpPedChave: string;
    vpCtaCodigo: string;
    vpCznChave: string;
    vlPackLia: Cardinal;
    vpCaixaAberto: Integer;
    procedure VerificaRetiraBalcao;
    function MostraLista(pModulo: String; pFiltro: string = ''; pChaveMestre: string = ''): string; overload;
    function MostraLista(pModulo: String; pModoCarga: TModoCarga; pFiltro: string = ''; pChaveMestre: string = ''): string; overload;
    function CriaFormulario(pFormClass: TFrmBaseClass; pChave, pChaveMestre: String; pFiltro: String = ''): Boolean;
  published

    property AcsCodigo: Integer read FAcsCodigo write SetAcsCodigo;

  end;


  TCancelar = function(AOwner: TComponent; Conexao: TUniConnection; vLteChave: string; vMotivo: string; vusrcodigo: string; vMesChave: string;
    vMeaCodigo: string; vtnccodigo: string): string;

  TliberacaoRFI = function(AOwner: TComponent; Conexao: TUniConnection; vusuario: string; vactcodigo: string; vMotivo: string;
    vtdecodigo, vOrcchave, vMesChave: String; vltecodigo, vddfcodigo: String; vForcaLogin: Boolean = false; vtabela: string = '';
    vregistro: string = ''): string;




var
  FprinciEntregas: TFprinciEntregas;
  ferro: TForm;
  ShuttingDown: Boolean = false;

implementation

uses
  ufcce, ulcaixaentregadores, ufccefecha, ulentregadores, uforcfpagtoent,
  ufproducao, ufwhatsapp, ufcxm, uftefwifi;

{$R *.dfm}

const
  SEnDisabled: array [Boolean] of string = ('disabled', 'enabled');

var
  HintWnd: THintWindow;

TYPE
  TFriendly = class(TCustomDBGrid);
  (* Chamada exportada para carga da BPL *)

procedure SetDateTime(Year, Month, Day, Hour, Minu, Sec, MSec: Word);
var
  NewDateTime: TSystemTime;
begin
  FillChar(NewDateTime, SizeOf(NewDateTime), #0);
  NewDateTime.wYear := Year;
  NewDateTime.wMonth := Month;
  NewDateTime.wDay := Day;
  NewDateTime.wHour := Hour;
  NewDateTime.wMinute := Minu;
  NewDateTime.wSecond := Sec;
  NewDateTime.wMilliseconds := MSec;
  SetLocalTime(NewDateTime);
end;

procedure TPanel.Paint;
const
  Alignments: array [TAlignment] of Longint = (DT_LEFT, DT_RIGHT, DT_CENTER);
  VerticalAlignments: array [TVerticalAlignment] of Longint = (DT_TOP, DT_BOTTOM, DT_VCENTER);
var
  Rect: TRect;
  LColor: TColor;
  LStyle: TCustomStyleServices;
  LDetails: TThemedElementDetails;
  TopColor: TColor;
  BottomColor: TColor;
  LBaseColor: TColor;
  LBaseTopColor: TColor;
  LBaseBottomColor: TColor;
  Flags: Longint;

  procedure AdjustColors(Bevel: TPanelBevel);
  begin
    TopColor := LBaseTopColor;
    if Bevel = bvLowered then
      TopColor := LBaseBottomColor;
    BottomColor := LBaseBottomColor;
    if Bevel = bvLowered then
      BottomColor := LBaseTopColor;
  end;

begin

  Rect := GetClientRect;

  LBaseColor := Color;
  // use the color property value to get the background color.
  LBaseTopColor := clBtnHighlight;
  LBaseBottomColor := clBtnShadow;
  LStyle := StyleServices;
  if LStyle.Enabled then
  begin
    LDetails := LStyle.GetElementDetails(tpPanelBevel);
    if LStyle.GetElementColor(LDetails, ecEdgeHighLightColor, LColor) and (LColor <> clNone) then
      LBaseTopColor := LColor;
    if LStyle.GetElementColor(LDetails, ecEdgeShadowColor, LColor) and (LColor <> clNone) then
      LBaseBottomColor := LColor;
  end;

  if BevelOuter <> bvNone then
  begin
    AdjustColors(BevelOuter);
    Frame3D(Canvas, Rect, TopColor, BottomColor, BevelWidth);
  end;
  if not(LStyle.Enabled and (csParentBackground in ControlStyle)) then
    Frame3D(Canvas, Rect, LBaseColor, LBaseColor, BorderWidth)
  else
    InflateRect(Rect, -Integer(BorderWidth), -Integer(BorderWidth));
  if BevelInner <> bvNone then
  begin
    AdjustColors(BevelInner);
    Frame3D(Canvas, Rect, TopColor, BottomColor, BevelWidth);
  end;
  with Canvas do
  begin
    if not LStyle.Enabled or not ParentBackground then
    begin
      Brush.Color := LBaseColor;
      FillRect(Rect);
    end;

    if ShowCaption and (Caption <> '') then
    begin
      Brush.Style := bsClear;
      Font := Font;
      Font.Color := clWhite;
      Font.Size := 12;
      Font.Style := [fsbold];

      Flags := DT_EXPANDTABS or DT_SINGLELINE or VerticalAlignments[VerticalAlignment] or Alignments[Alignment];
      Flags := DrawTextBiDiModeFlags(Flags);
      if LStyle.Enabled then
      begin
        LDetails := LStyle.GetElementDetails(tpPanelBackground);
        if not LStyle.GetElementColor(LDetails, ecTextColor, LColor) or (LColor = clNone) then
          LColor := Font.Color;
        if Tag > 0 then
          LColor := Tag;

        LStyle.DrawText(Handle, LDetails, Caption, Rect, TTextFormatFlags(Flags), LColor)
      end
      else
        DrawText(Handle, Caption, -1, Rect, Flags);
    end;
  end;
end;

{ TGroupBox }

procedure TGroupBox.Paint;
var
  H: Integer;
  R: TRect;
  Flags: Longint;
  CaptionRect, OuterRect: TRect;
  Size: TSize;
  Box: TThemedButton;
  Details: TThemedElementDetails;
begin

  with Canvas do
  begin
    Font := Font;

    if ThemeControl(Self) then
    begin
      if Text <> '' then
      begin
        GetTextExtentPoint32(Handle, PChar(Text), Length(Text), Size);
        CaptionRect := Rect(0, 0, Size.cx, Size.cy);
        if not UseRightToLeftAlignment then
          OffsetRect(CaptionRect, 8, 0)
        else
          OffsetRect(CaptionRect, Width - 8 - CaptionRect.Right, 0);
      end
      else
        CaptionRect := Rect(0, 0, 0, 0);

      OuterRect := ClientRect;
      OuterRect.Top := (CaptionRect.Bottom - CaptionRect.Top) div 2;
      with CaptionRect do
        ExcludeClipRect(Handle, Left, Top, Right, Bottom);
      if Enabled then
        Box := tbGroupBoxNormal
      else
        Box := tbGroupBoxDisabled;
      Details := ThemeServices.GetElementDetails(Box);
      // Draw the themed frame
      ThemeServices.DrawElement(Handle, Details, OuterRect);
      SelectClipRgn(Handle, 0);
      if Text <> '' then
      begin
        Font.Name := 'Tahoma';
        Font.Size := 11;
        Font.Style := [fsbold];
        H := TextHeight('0');
        if not UseRightToLeftAlignment then
          R := Rect(8, 0, 0, H)
        else
          R := Rect(R.Right - Canvas.TextWidth(Text) - 8, 0, 0, H);
        Flags := DrawTextBiDiModeFlags(DT_SINGLELINE);
        // Now using the Windows.DrawText
        DrawText(Handle, PChar(Text), Length(Text), R, Flags or DT_CALCRECT);
        if Tag > 0 then
          Font.Color := clWhite; // background color of the caption

        Brush.Color := Color; // background color of the caption
        DrawText(Handle, PChar(Text), Length(Text), R, Flags);
      end;
    end
    else
      inherited;
    // if the control is not themed then use the original paint method.
  end;
end;

procedure MainForm(AOwner: TApplication);
begin
  FprinciEntregas := TFprinciEntregas.Create(AOwner);
end;

function formulario(AOwner: TApplication): string;
begin
  FprinciEntregas := TFprinciEntregas.Create(AOwner);
  FprinciEntregas.ShowModal;
  FprinciEntregas.Free;
end;

exports MainForm, formulario;

Procedure TFprinciEntregas.ConectaBanco;
Var
  Arquini: Tinifile;
  vlNomeBanco: String;
  vlPortaBanco: Integer;
  vlServidor: String;
  vlUsuario: String;
  vlSenha: String;
  vlMonitor: String;
Begin
  try

    Arquini := Tinifile.Create(Extractfilepath(Application.ExeName) + 'gourmeterp.ini');
    With Arquini Do
    Begin
      vlNomeBanco := ReadString('posi', 'nomebanco', 'mizio');
      vlServidor := ReadString('posi', 'servidor', '127.0.0.1');
      vlUsuario := ReadString('posi', 'usuario', 'root');
      vlSenha := ReadString('posi', 'senha', 'xda973');
      vlPortaBanco := ReadInteger('posi', 'portabanco', 3306);
      vpIntegraStone := ReadString('posi', 'integrastone', 'Não');


      vlMonitor := ReadString('posi', 'monitor', '0');

      Acesso.Terminal := ReadInteger('posi', 'terminal', 0);
    End;
    Arquini.Free;

    (* Configuração para DBMonitor *)

    Conexao.Connected := false;
    Conexao.Database := vlNomeBanco;
    Conexao.Username := 'root';
    Conexao.Password := vlSenha;
    Conexao.Port := vlPortaBanco;
    Conexao.Server := vlServidor;
    Conexao.Connected := True;

    consulta.Close;
    consulta.Connection := Conexao;
    consulta.SQL.Clear;
    consulta.SQL.add('SET @@GLOBAL.sql_mode=' + QuotedStr(''));
    consulta.ExecSQL;

  except
    Mostraerro('A T E N Ç Ã O   -   A T E N Ç Ã O: ' + #13 + #13 + 'Falha de conexão com o SERVIDOR.' + #13 + 'Verifique se o SERVIDOR esta ligado' +
      #13 + 'e se sua rede funcionando !' + #13 + 'Ligue o SERVIDOR e depois lique os TERMINAIS.');

  end;
End;

Function TFprinciEntregas.LogarSistema: Boolean;
var
  Login: function(pAOwner: TApplication; pConexao: TUniConnection; pTerminal: Integer): Integer;
  vlResult: Integer;
  vlPack: NativeUInt;
begin
  Result := false;

  vlPack := LoadPackage('modulos\macs.bpl');
  if vlPack <> 0 then
    try
      @Login := GetProcAddress(vlPack, PChar('Acesso'));

      if Assigned(Login) then
        vlResult := Login(Application, Conexao, Acesso.Terminal);

    finally
      DoUnLoadPackage(Application, vlPack);
    end;

  if vlResult > 0 then
  begin
    Result := True;
    AcsCodigo := vlResult;
  end;
End;

procedure TFprinciEntregas.SetAcsCodigo(const Value: Integer);
begin
  FAcsCodigo := Value;

  consulta.Close;
  consulta.SQL.Text := 'SELECT acs.acschave, acs.clbcodigo, acs.flacodigo FROM acs WHERE acs.acschave = ' + FAcsCodigo.ToString;
  consulta.Open;

  Acesso.IdAcesso := consulta.Fields[0].AsInteger;
  Acesso.Usuario := consulta.Fields[1].AsInteger;
  Acesso.Filial := consulta.Fields[2].AsInteger;

  clb.Close;
  clb.Params[0].AsInteger := Acesso.Usuario;
  clb.Open;

  lcolaborador.Caption := clbclbidentificacao.AsString;

  dau.Params[0].AsString := Self.Name;
  dau.Params[1].AsInteger := Acesso.Usuario;
  dau.Open;

end;

procedure TFprinciEntregas.FerroKeyPress(Sender: TObject; var Key: Char);
Begin
  if (Key = #27) or (Key = #$1B) then
  begin
    Key := #0;
    ferro.Close;
  end;
end;

procedure SetMainForm(FormAtivo: TForm);
var
  TmpMain: ^TCustomForm;
begin
  TmpMain := @Application.MainForm;
  TmpMain^ := FormAtivo;
end;


procedure TFprinciEntregas.FormActivate(Sender: TObject);
begin
if Application.MainForm<>FprinciEntregas then
  SetMainForm(FprinciEntregas);
end;

procedure TFprinciEntregas.FormCloseQuery(Sender: TObject; var CanClose: Boolean);
begin
  CanClose := ShuttingDown;
end;

procedure TFprinciEntregas.listaCellClick(Column: TColumn);
begin
  vpOrcChave := orcssaiorcchave.AsString;
  vpPedChave := orcssaipdgnumero.AsString;
  frxDados.DataSet := orcssai;

  if sbAbreCaixa.Enabled = false then
  begin
    ActTrocarEntregador.Enabled := True;
  end
  else
  begin
    ActTrocarEntregador.Enabled := false;
  end;

end;

procedure TFprinciEntregas.listaDblClick(Sender: TObject);
begin
  ActCancelarEntregdor.Execute;
end;

procedure TFprinciEntregas.listaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);

var
  fixRect: TRect;
  Check: Integer;
  vminutos: Integer;
  vsegundos: Integer;
begin

  fixRect := Rect;

  If Odd(dsorcssai.DataSet.RecNo) Then
    lista.Canvas.Brush.Color := PEG_COR_BASE
  else
    lista.Canvas.Brush.Color := clWhite;

  { cast DBGrid to a unit friendly class thus exposing all it private bits! }
  with TFriendly(lista) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. Check against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }
        if lista.Canvas.Font.Color = clGreen then
          Brush.Color := clWhite // $004080FF;
        else
          Brush.Color := PEG_COR_SELCGRID; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(Rect, DataCol, Column, State);
      end;
    end;
  end;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      if lista.Canvas.Font.Color = clGreen then
        Brush.Color := clWhite
      else
        Brush.Color := PEG_COR_SELCGRID;
      FillRect(fixRect);
      Font.Color := clWhite;
    End;

  with TFriendly(lista) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. Check against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }
        if lista.Canvas.Font.Color = clGreen then
          Brush.Color := clsilver
        else
          Brush.Color := PEG_COR_SELCGRID; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(fixRect, DataCol, Column, State);
      end;
    end;
  end;
  if orcssaistocodigo.AsInteger = stoCancelado then
  begin
    lista.Canvas.Font.Color := clBlack;
    lista.Canvas.Brush.Color := clgray;
  end;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);

end;

procedure TFprinciEntregas.listaEnter(Sender: TObject);
begin
  frxDados.DataSet := orcssai;
end;

procedure TFprinciEntregas.listaKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (((Shift = [ssCtrl]) And (Key = VK_DELETE))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) then
    Abort;
end;

procedure TFprinciEntregas.listaMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
begin
//  vpContaTempo := 0;
end;

procedure TFprinciEntregas.listaOrcsCellClick(Column: TColumn);
var
  vlLiberado: string;
  vlAgora: string;
  myYear, myMonth, myDay: Word;
  myHour, myMin, mySec, myMilli: Word;
  vlMeschave: string;
begin
  if not listaOrcs.DataSource.DataSet.IsEmpty then
  begin

    vpOrcChave := orcsorcchave.AsString;
    vpPedChave := orcspdgnumero.AsString;
    frxDados.DataSet := orcs;

    if orcsstocodigo.AsInteger = 88 then
    begin
      Showmessage('Este pedido foi cancelado, não pode ser entrege!');
      exit;
    end;


    if Column.FieldName = 'marca' then
    begin

        vpContaTempo := 0;
        orcs.Edit;
        if orcs.Fieldbyname('marca').AsString = '1' then
          orcs.Fieldbyname('marca').AsString := '0'
        else
          orcs.Fieldbyname('marca').AsString := '1';
        orcs.Post;

    end;

    vpOrcChave := orcsorcchave.AsString;
    vpPedChave := orcspdgnumero.AsString;
    frxDados.DataSet := orcs;

  end;
end;

procedure TFprinciEntregas.listaOrcsDblClick(Sender: TObject);
begin
  if not listaOrcs.DataSource.DataSet.IsEmpty then
  begin

    listaOrcsCellClick(listaOrcs.Columns[0]);

    if listaOrcs.DataSource.DataSet.Fieldbyname('marca').AsInteger = 1 then
    begin
      if not SelecionarEntregador then
      begin
        listaOrcs.DataSource.DataSet.Edit;
        listaOrcs.DataSource.DataSet.Fieldbyname('marca').AsInteger := 0;
        listaOrcs.DataSource.DataSet.Post;
      end;

    end;
  end;

end;

procedure TFprinciEntregas.listaOrcsDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
var
  fixRect: TRect;
  Check: Integer;
  vminutos: Integer;
  vsegundos: Integer;
  index: Integer;

var
  BUTTON: Integer;
  R: TRect;
  bcolor: TColor;

begin

  fixRect := Rect;

  If Odd(dsOrcs.DataSet.RecNo) Then
    listaOrcs.Canvas.Brush.Color := PEG_COR_BASE
  else
    listaOrcs.Canvas.Brush.Color := clWhite;

  vsegundos := calcularDiferencaHoras(date, orcsorcdataabert.AsFloat, time, orcsorchoraabert.AsFloat);
  vminutos := vsegundos div 60;

  if vminutos > (30) then
  begin
    listaOrcs.Canvas.Font.Color := clRed;
    listaOrcs.Canvas.Brush.Color := clYellow;
  end;

  vsegundos := calcularDiferencaHoras(date, orcsorcdataabert.AsFloat, time, orcsorchoraabert.AsFloat);
  vminutos := vsegundos div 60;

  if vminutos > (50) then
  begin
    listaOrcs.Canvas.Font.Color := clYellow;
    listaOrcs.Canvas.Brush.Color := clRed;
  end;

  if orcsstocodigo.AsInteger = stoCancelado then
  begin
    listaOrcs.Canvas.Font.Color := clBlack;
    listaOrcs.Canvas.Brush.Color := clgray;
  end;

  { cast DBGrid to a unit friendly class thus exposing all it private bits! }
  with TFriendly(listaOrcs) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. Check against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }
        if listaOrcs.Canvas.Font.Color = clGreen then
          Brush.Color := clWhite // $004080FF;
        else
          Brush.Color := PEG_COR_SELCGRID; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(Rect, DataCol, Column, State);
      end;
    end;
  end;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      if listaOrcs.Canvas.Font.Color = clGreen then
        Brush.Color := clWhite
      else
        Brush.Color := PEG_COR_SELCGRID;
      FillRect(fixRect);
      Font.Color := clWhite;

      if orcsstocodigo.AsInteger = stoCancelado then
      begin
        listaOrcs.Canvas.Font.Color := clBlack;
        listaOrcs.Canvas.Brush.Color := clgray;
      end;

    End;

  with TFriendly(listaOrcs) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. Check against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }
        if listaOrcs.Canvas.Font.Color = clGreen then
          Brush.Color := clsilver
        else
          Brush.Color := PEG_COR_SELCGRID; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(fixRect, DataCol, Column, State);
      end;
    end;
  end;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);

  if Column.FieldName = 'marca' then
  begin


    // Desenha um checkbox no dbgrid

    listaOrcs.Canvas.FillRect(Rect);

    Check := 0;
    if Self.orcs.Fieldbyname('marca').AsString = '1' then
      Check := DFCS_CHECKED
    else
      Check := 0;

    // fixRect := Rect;
    InflateRect(fixRect, -2, -2);
    DrawFrameControl(listaOrcs.Canvas.Handle, fixRect, DFC_BUTTON, DFCS_BUTTONCHECK or Check);
  end;

end;

procedure TFprinciEntregas.listaOrcsEnter(Sender: TObject);
begin
  frxDados.DataSet := orcs;
end;

procedure TFprinciEntregas.listaOrcsKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (((Shift = [ssCtrl]) And (Key = VK_DELETE))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) then
    Abort;
end;

procedure TFprinciEntregas.listaOrcsMouseDown(Sender: TObject;
  Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
 vpContaTempo := 0;
end;

procedure TFprinciEntregas.listaOrcsMouseEnter(Sender: TObject);
begin
 vpContaTempo := 0;
end;

procedure TFprinciEntregas.listaOrcsMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
begin
 // vpContaTempo := 0;
end;

procedure TFprinciEntregas.listaOrcsMouseWheel(Sender: TObject;
  Shift: TShiftState; WheelDelta: Integer; MousePos: TPoint;
  var Handled: Boolean);
begin
 vpContaTempo := 0;
end;

procedure TFprinciEntregas.listaOrcsMouseWheelDown(Sender: TObject;
  Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
begin
 vpContaTempo := 0;
end;

procedure TFprinciEntregas.listaOrcsMouseWheelUp(Sender: TObject;
  Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
begin
 vpContaTempo := 0;
end;

procedure TFprinciEntregas.listaOrcsTitleClick(Column: TColumn);
var
  i: Integer;
begin
  if uppercase(Column.FieldName) <> 'MARCA' then
  begin

    for i := 0 to listaOrcs.Columns.Count - 1 do
    begin
      listaOrcs.Columns[i].Title.Font.Color := clBlack;
    end;

    Column.Title.Font.Color := clRed;

    orcs.IndexFieldNames := Column.FieldName;
  end;
end;

procedure TFprinciEntregas.listaTitleClick(Column: TColumn);
var
  i: Integer;
begin
  for i := 0 to lista.Columns.Count - 1 do
  begin
    lista.Columns[i].Title.Font.Color := clBlack;
  end;

  Column.Title.Font.Color := clRed;

  orcssai.IndexFieldNames := Column.FieldName;

end;

procedure TFprinciEntregas.DBGDisponiveisDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
var
  fixRect: TRect;
  Check: Integer;
  vminutos: Integer;
  vsegundos: Integer;
begin

  fixRect := Rect;

  If Odd(dsvtDisponiveis.DataSet.RecNo) Then
    lista.Canvas.Brush.Color := PEG_COR_BASE
  else
    lista.Canvas.Brush.Color := clWhite;

  { cast DBGrid to a unit friendly class thus exposing all it private bits! }
  with TFriendly(DBGDisponiveis) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. Check against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }
        if DBGDisponiveis.Canvas.Font.Color = clGreen then
          Brush.Color := clWhite // $004080FF;
        else
          Brush.Color := PEG_COR_SELCGRID; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(Rect, DataCol, Column, State);
      end;
    end;
  end;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      if DBGDisponiveis.Canvas.Font.Color = clGreen then
        Brush.Color := clWhite
      else
        Brush.Color := PEG_COR_SELCGRID;
      FillRect(fixRect);
      Font.Color := clWhite;
    End;

  with TFriendly(DBGDisponiveis) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. Check against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }
        if DBGDisponiveis.Canvas.Font.Color = clGreen then
          Brush.Color := clsilver
        else
          Brush.Color := PEG_COR_SELCGRID; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(fixRect, DataCol, Column, State);
      end;
    end;
  end;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);

end;

procedure TFprinciEntregas.DBGDisponiveisKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (((Shift = [ssCtrl]) And (Key = VK_DELETE))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) then
    Abort;
end;

procedure TFprinciEntregas.DBGNaRuaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
var
  fixRect: TRect;
  Check: Integer;
  vminutos: Integer;
  vsegundos: Integer;
  vltempo: string;
begin

  fixRect := Rect;

  If Odd(dsvtEmEntrega.DataSet.RecNo) Then
    DBGNaRua.Canvas.Brush.Color := PEG_COR_BASE
  else
    DBGNaRua.Canvas.Brush.Color := clWhite;

  vltempo := sonumeros(copy(vtEmEntregatempo.AsString, 1, 5));

  if vltempo = '' then
    vltempo := '0';

  if strtoint(vltempo) > (40) then
  begin
    DBGNaRua.Canvas.Font.Color := clYellow;
    DBGNaRua.Canvas.Brush.Color := clRed;
  end
  else if strtoint(vltempo) > (20) then
  begin
    DBGNaRua.Canvas.Font.Color := clRed;
    DBGNaRua.Canvas.Brush.Color := clYellow;
  end
  else
  begin
    DBGNaRua.Canvas.Font.Color := clBlack;
    DBGNaRua.Canvas.Brush.Color := clgray;
  end;

  {


    with TFriendly(DBGNaRua) do
    begin

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
    with Canvas do
    begin

    if DBGNaRua.Canvas.Font.Color = clGreen then
    Brush.Color := clWhite // $004080FF;
    else
    Brush.Color := PEG_COR_SELCGRID; // $004080FF;

    DefaultDrawColumnCell(Rect, DataCol, Column, State);
    end;
    end;
    end;
  }

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      if DBGNaRua.Canvas.Font.Color = clGreen then
        Brush.Color := clWhite
      else
        Brush.Color := PEG_COR_SELCGRID;
      FillRect(fixRect);
      Font.Color := clWhite;
    End;

  { with TFriendly(DBGNaRua) do
    begin

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
    with Canvas do
    begin

    if DBGNaRua.Canvas.Font.Color = clGreen then
    Brush.Color := clsilver
    else
    Brush.Color := PEG_COR_SELCGRID; // $004080FF;
    DefaultDrawColumnCell(fixRect, DataCol, Column, State);
    end;
    end;
    end; }

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);

end;

procedure TFprinciEntregas.DBGNaRuaKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (((Shift = [ssCtrl]) And (Key = VK_DELETE))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) then
    Abort;
end;

procedure TFprinciEntregas.DesligaTimer(var MSG: tagMSG; var Handled: Boolean); // desliga o timer ao entrar em atividade
begin

  vpPodeAtualizar := false;

end;

procedure TFprinciEntregas.dsOrcsDataChange(Sender: TObject; Field: TField);
begin

  try
    if orcs.IsEmpty then
    begin
      lito.Close;
      exit;
    end;

    lito.Close;
    lito.Params[0].AsString := vpOrcChave;
    lito.Open;

  finally
  end;

end;

procedure TFprinciEntregas.dsorcssaiDataChange(Sender: TObject; Field: TField);
begin

  if orcssai.Active then
  begin
    if orcssaipdgnumero.AsString <> '' then
    begin
      imp.Close;
      imp.ParamByName('immnumepedido').AsInteger := orcssaipdgnumero.AsInteger;
      imp.ParamByName('cznchave').AsString := vpCznChave;
      imp.Open;
    end;

    if orcssaitempoementrega.AsString = '' then
    begin
      ActTrocarPagamento.Enabled := false;
    end
    else
    begin

      ActTrocarPagamento.Enabled := True;
    end;

  end;

end;

procedure TFprinciEntregas.LigaTimer(Sender: TObject; var Done: Boolean); // liga o timer ao ficar ocioso
begin

  vpPodeAtualizar := True;
end;

function TFprinciEntregas.RegistraOperacaoCaixa(vTocCodigo: Integer): string;
type
  TformuCaixa = function(AOwner: TComponent; Conexao: TUniConnection; Acesso: TAcesso; vCtaCodigo: string; vTurno: string; vTrmCodigo: string;
    vOperacao: Integer; vCcxChave: String): string;
var
  RegistraCaixa: TformuCaixa;
  vlRetorno: string;
  vlPackccx: Cardinal;
begin
  Result := '';
  vlPackccx := LoadPackage('modulos\mccx.bpl');
  if vpCtaCodigo = '' then
    vpCtaCodigo := ccxctacodigo.AsString;

  if vlPackccx <> 0 then
    try
      @RegistraCaixa := GetProcAddress(vlPackccx, PChar('formuCaixa'));

      if Assigned(RegistraCaixa) then
      begin
        vlRetorno := RegistraCaixa(Application, Conexao, Acesso, vpCtaCodigo, '1', Acesso.Terminal.ToString, vTocCodigo, ccxccxchave.AsString);
        Result := vlRetorno;
      end;
    finally
      DoUnLoadPackage(Application, vlPackccx);
    end;
End;

procedure TFprinciEntregas.acoesExecute(Action: TBasicAction; var Handled: Boolean);
begin

  if (Action = ActCancelaPedido) or (Action = ActFecharCaixaEntregador) then
  begin
    Handled := false;
  end
  else
  begin

    if not Autorizado(Action as TAction, '') then
      Handled := True;

  end;
end;

procedure TFprinciEntregas.ActAbreCaixaExecute(Sender: TObject);
var
  vlValorOperacao: string;
begin
  if vpCznChave = '' then
  begin
    Showmessage('Cozinha esta fechada, não é possível abrir o caixa!');
    exit;
  end;

  vpCtaCodigo := cfgcfgmgouctadelivery.AsString;

  if vpCtaCodigo = '' then
  begin
    Application.MessageBox(PChar('Não foi possível abrir o caixa.' + #13 + 'Este terminal não possui uma conta corrente vinculada.'), 'Atenção',
      MB_ICONWARNING + MB_OK);
    exit;
  end;

  consulta.Close;
  consulta.SQL.Text := 'SELECT ccx.ccxchave , ccx.ccxdataber , ccx.ccxhoraaber, clb.clbidentificacao FROM ccx ';
  consulta.SQL.add('INNER JOIN clb ON ccx.clbcodigo = clb.clbcodigo ');
  consulta.SQL.add('WHERE ccx.ctacodigo = ' + vpCtaCodigo + ' ');
  consulta.SQL.add('AND ccx.ccxdatafecha IS NULL order by ccxchave desc limit 1');
  consulta.Open;

  if not consulta.IsEmpty then
  begin

    { Showmessage('Atenção: ' + #13 + #13 + 'Este terminal já possui um caixa aberto, não pode ser aberto outro caixa ao mesmo tempo!' + #13 + #13 + 'Caixa Aberto de: ' +
      consulta.Fields[3].AsString + #13 + //
      'Data Abertura  : ' + consulta.Fields[1].AsString + #13 + //
      'Hora Abertura  : ' + consulta.Fields[2].AsString);

      exit; }

    plccxchave.Caption := 'Caixa: ' + ccx.Fieldbyname('ccxchave').AsString;
  end
  else
  begin

  end;

  vlValorOperacao := RegistraOperacaoCaixa(tocAberturaCaixa);

  if (vlValorOperacao = '') then
  begin
    vpCaixaAberto := 0;
  end
  else
  begin

    ccx.Close;
    ccx.SQL.Text := 'SELECT   ccx.ccxchave,  ccx.clbcodigo,  ccx.ctacodigo,  ccx.ccxturno,  ccx.ccxdataber,';
    ccx.SQL.add(' ccx.ccxhoraaber,  ccx.ccxsaldoaber,  ccx.ccxdatafecha,  ccx.ccxhorafecha,  ccx.ccxsaldofecha, ');
    ccx.SQL.add(' ccx.ccxsangrias,  ccx.ccxsuprimentos FROM ccx where ccx.ctacodigo=' + vpCtaCodigo);
    ccx.SQL.add('  and ccxdatafecha is null');
    ccx.SQL.add(' ORDER BY ccx.ccxchave desc limit 1');
    ccx.Open;

    vpCaixaAberto := 1;
    ActAbreCaixa.Enabled := false;
    ActTrocarPagamento.Enabled := True;
    AjustaCaixa;

    consulta.Close;
    consulta.SQL.Text := 'update ccx set ccxtipo=2 where ccxchave=' + ccx.Fieldbyname('ccxchave').AsString;
    consulta.ExecSQL;

    plccxchave.Caption := 'Caixa: ' + ccx.Fieldbyname('ccxchave').AsString;

    if FileExists(Extractfilepath(Application.ExeName) + 'relat\AberturaCCX.fr3') then
      ImprimeComprovantesCaixa(ocxAbertura);

    Ajustabotoes(false);

  end;

end;

function TFprinciEntregas.AbreGavetaNF: Boolean;
var
  i: Integer;
begin

  if trmtrmgaveta.AsInteger = 1 then
  begin
    trm.Close;
    trm.Params[0].AsInteger := Acesso.Terminal;
    // trm.Filter := 'tipcodigo=' + IntToStr(tipTermica48Col);
    // trm.Filtered := True;
    trm.Open;
    i := 0;

    ImprimirComprovantesCCX(Application, Conexao, ccxccxchave.AsInteger, ocxGaveta, trmtciporta.AsString, tiImprimirDireto);

  end;
  Result := True;
end;

procedure TFprinciEntregas.ActAbreGavetaExecute(Sender: TObject);
begin
  AbreGavetaNF;
end;

procedure TFprinciEntregas.ActAbrirCaixaEntregadorExecute(Sender: TObject);
var
  vlFncCodigo: string;
begin

  if ActAbreCaixa.Enabled then
  begin
    Showmessage('Necessário abrir o caixa de entregas!');
    exit;
  end;

  vlFncCodigo := '';

  consulta.Close;
  consulta.Connection := Conexao;
  consulta.SQL.Text := 'select fnccodigo from fnc where upper(fncidentificacao)=' + QuotedStr('ENTREGADOR');
  consulta.Open;

  vlFncCodigo := consulta.Fieldbyname('fnccodigo').AsString;

  if vlFncCodigo = '' then
  begin

    Showmessage('É necessário usuário cadastrador com a função ENTREGADOR!');
    exit;
  end;

  consulta.Close;
  consulta.Connection := Conexao;
  consulta.SQL.Text := 'select cznchave from czn where cznfechamento IS null order by cznchave limit 1';
  consulta.Open;

  if CriaFormulario(Tfcce, '', consulta.Fields[0].AsString, 'fnccodigo=' + vlFncCodigo + ' and clbativo=' + QuotedStr('1')) then
  begin
    AtualizaListas(True);

  end;
  SituacaoEntregadores;

end;

procedure TFprinciEntregas.ActAtualizarListaExecute(Sender: TObject);

begin
  inherited;
  AtualizaListas(True);

end;

Procedure TFprinciEntregas.AtualizaSituacaoItens(ChaveOrc: String; Situacao: Integer; TipoDocumento: String);
begin
  if Situacao = stoEmCaixa then
    exit;

  consulta.Close;
  consulta.SQL.Clear;
  consulta.SQL.add('UPDATE ito SET ito.tdfcodigo=' + QuotedStr(TipoDocumento) + ' ,ito.stocodigo = ' + IntToStr(Situacao) + ' ');
  consulta.SQL.add('WHERE ito.stocodigo IN (' + IntToStr(stoEmDigitacao) + ', ');
  consulta.SQL.add(IntToStr(stoEmAberto) + ', ');
  consulta.SQL.add(IntToStr(stoEmFechamento) + ',  ');
  consulta.SQL.add(IntToStr(stoVendido) + ') ');
  consulta.SQL.add('AND ito.orcchave=' + ChaveOrc);
  consulta.ExecSQL;
end;

procedure TFprinciEntregas.edPesquisarAEntregarKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if edPesquisarAEntregar.Text <> '' then
  begin
    orcs.FilterSQL := '(immnumepedido like (' + QuotedStr('%' + trim(edPesquisarAEntregar.Text + '%')) + ') or ' + 'edrbairro like (' +
      QuotedStr(trim('%' + edPesquisarAEntregar.Text + '%')) + ') or ' + 'pds.pdsidentificacao like (' +
      QuotedStr(trim('%' + edPesquisarAEntregar.Text + '%')) + ') or  edrrua like (' + QuotedStr(trim('%' + edPesquisarAEntregar.Text + '%')) + '))';
    orcs.Filtered := True;
  end
  else
  begin
    orcs.FilterSQL := '';
    orcs.Filtered := false;
  end;

end;

procedure TFprinciEntregas.edPesquisarEntreguesKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if edPesquisarEntregues.Text <> '' then
  begin
    orcssai.FilterSQL := '(immnumepedido like (' + QuotedStr('%' + trim(edPesquisarEntregues.Text + '%')) + ') or ' + 'edrbairro like (' +
      QuotedStr(trim('%' + edPesquisarEntregues.Text + '%')) + ') or ' + 'etdidentificacao like (' +
      QuotedStr(trim('%' + edPesquisarEntregues.Text + '%')) + ') or ' + 'pds.pdsidentificacao like (' +
      QuotedStr(trim('%' + edPesquisarEntregues.Text + '%')) + ') or  clb.clbidentificacao like (' +
      QuotedStr(trim('%' + edPesquisarEntregues.Text + '%')) + ') or ' + 'c.clbidentificacao like (' +
      QuotedStr(trim('%' + edPesquisarEntregues.Text + '%')) + ') or ' + 'edrrua like (' +
      QuotedStr(trim('%' + edPesquisarEntregues.Text + '%')) + '))';
    orcssai.Filtered := True;
  end
  else
  begin
    orcssai.FilterSQL := '';
    orcssai.Filtered := false;
  end;

end;

procedure TFprinciEntregas.edRetornoKeyPress(Sender: TObject; var Key: Char);
var
  vlOrcChave: string;
begin
  if Key = #13 then
  begin
    Key := #0;

    vlOrcChave := edRetorno.Text;

    if pos('-', vlOrcChave) > 0 then
    begin
      vlOrcChave := copy(vlOrcChave, 1, pos('-', vlOrcChave) - 1);
    end;

    if Length(vlOrcChave) >= 12 then
    begin
      vlOrcChave := sonumeros(vlOrcChave);
      vlOrcChave := copy(vlOrcChave, 1, Length(vlOrcChave) - 1);
    end;

    edRetorno.Text := '';

    RegistraRetornoEntrega(vlOrcChave);
    AtualizaListas(True);
    edRetorno.setfocus;

  end;
end;

function TFprinciEntregas.RegistraRetornoEntrega(Value: string): string;
var
  vlOrcChave: string;
  vlRetorno: string;
begin

  vlOrcChave := Value;

  if vlOrcChave <> '' then
  begin

    consulta.Close;
    consulta.SQL.Text := 'select count(orcchave) from orc where orcchave=' + vlOrcChave;
    consulta.Open;

    if consulta.Active then
    begin

      consulta.Close;
      consulta.SQL.Text := 'select orcchave from orc where  orcliberadoentrega is null and orcchave=' + vlOrcChave;
      consulta.Open;

      if consulta.Fieldbyname('orcchave').AsInteger <> 0 then
      begin

        vlRetorno := agora(Application, Conexao);
        vlRetorno := ajustadata(copy(vlRetorno, 1, 10)) + ' ' + copy(vlRetorno, 12, 10);

        consulta.Close;
        consulta.SQL.Text := 'update orc set orcretorno='+QuotedStr(vlRetorno) + ',pdscodigo=5 where orcretorno is null  and orcchave=' + vlOrcChave;
        consulta.ExecSQL;

        Result := 'Retorno registrado com sucesso.';
      end
      else if consulta.Fieldbyname('orcchave').AsInteger = 0 then
      begin
        consulta.Close;
        Result := 'Pedido não localizado.';
        Showmessage(Result);
      end
      else
      begin
        consulta.Close;
        consulta.SQL.Text := 'select count(orcchave) from orc where  orcretorno<>null and orcchave=' + vlOrcChave;
        consulta.Open;

        if consulta.RecordCount = 1 then
        begin

          Result := 'Retorno já registrado.';
          Showmessage(Result);
        end;
      end;

    end;

  end
  else
  begin
    Result := 'ERRO do QRCode.';
    Showmessage(Result);
  end;

end;

function TFprinciEntregas.ExecutaSQL(Script: String): Boolean;
begin
  consulta.Close;
  consulta.SQL.Clear;
  consulta.SQL.add(Script);
  consulta.Execute;
  if consulta.RowsAffected > 0 then
    Result := True
  else
    Result := false;

end;

function TFprinciEntregas.Autorizado(pAction: TAction; pMotivo: String): Boolean;
type
  TAutorizacaoAten = function(AOwner: TComponent; Conexao: TUniConnection; vusuario: string; vactcodigo: string; vMotivo: string; vOrcchave: String;
    vTrmCodigo: String): string;
var
  Autoriza: TAutorizacaoAten;
  vlRetorno: string;
  vlActCodigo: Integer;
  vlOrcChave: string;
begin
  Result := True;

  vlActCodigo := pAction.Tag;

  if vlActCodigo > 0 then
  begin
    if not dau.Active then
    begin
      dau.ParamByName('mdlnome').AsString := Self.Name;
      dau.ParamByName('clbcodigo').AsInteger := Acesso.Usuario;
    end;

    if not dau.Locate('actcodigo;dauativo', VarArrayOf([vlActCodigo, 1]), []) then
    begin
      Result := false;

      vlPackLia := LoadPackage('modulos\mlia.bpl');
      if vlPackLia <> 0 then
        try
          @Autoriza := GetProcAddress(vlPackLia, PChar('liberacaoAten'));

          if Assigned(Autoriza) then
          begin
            vlOrcChave := orcsorcchave.AsString;
            if vlOrcChave = '' then
              vlOrcChave := '0';

            vlRetorno := Autoriza(Application, Conexao, Acesso.Usuario.ToString, IntToStr(vlActCodigo), pMotivo, vlOrcChave,
              Acesso.Terminal.ToString);

            if (vlRetorno <> '0') and (vlRetorno <> '') then
              // retornou NÃO AUTORIZADO
              Result := True;
          end;
        finally
          DoUnLoadPackage(Application, vlPackLia);
        end;
    end;
  end;
end;

function TFprinciEntregas.CancelarRFI(vMesChave: string; motivo: string; vMeaCodigo: string): string;
var
  registra: TCancelar;
  Pack: Cardinal;
  vlRetorno: string;
begin
  Pack := LoadPackage('modulos\merf.bpl');
  if Pack <> 0 then
    try
      @registra := GetProcAddress(Pack, PChar('Cancelar'));

      if Assigned(registra) then
        Result := registra(Application, Conexao, '', motivo, Acesso.Usuario.ToString, vMesChave, vMeaCodigo, '1');
      if Result = '' then
      begin
        vlRetorno := '0';
      end
      else
      begin
        vlRetorno := Result;
      end;

    finally
      // DoUnLoadPackage(pack);
    end;
end;

procedure TFprinciEntregas.ActCaixasEntregadoresExecute(Sender: TObject);
begin

  try
    SituacaoEntregadores;

    Application.CreateForm(tlentregadores, lentregadores);
    lentregadores.zCone:=conexao;
    lentregadores.Acesso:=Acesso;
    lentregadores.Caption := 'Entregadores do dia';
    lentregadores.btRelatorioDetalhado.Visible := True;

    lentregadores.btConfirma.Visible := false;
    lentregadores.btCancela.Caption := 'Fechar';
    lentregadores.frxUniDACComponents.DefaultDatabase := Self.Conexao;

    clbczn.Close;
    clbczn.ParamByName('cznchave').AsString := vpCznChave;

    clbczn.Open;

    lcozinha.Caption := 'Czn.:' + vpCznChave;

    lentregadores.Dclb.DataSet := clbczn;
    if lentregadores.ShowModal = mrOk then
    begin

    end
    else
    begin

    end;
  finally
    freeandnil(lentregadores);
  end;

end;

procedure TFprinciEntregas.ActCancelaPedidoExecute(Sender: TObject);
var
  vMotivo: string;
  vlMeaCodigo: string;
  vlOrcChave: string;
  vlPodeCancelar: Boolean;

  vlNumeroPedido: string;
  vlMeschave: string;
begin

  Timer2.Enabled := false;
  Timer1.Enabled := false;

  if frxDados.DataSet = orcs then
  begin
    vlOrcChave := orcsorcchave.AsString;
    vlPodeCancelar := True;
  end
  else
  begin
    vlOrcChave := orcssaiorcchave.AsString;

    if orcssaipdscodigo.AsInteger in [88] then
    begin
      vlPodeCancelar := false;

    end
    else
      vlPodeCancelar := True;

  end;

  consulta.Close;
  consulta.SQL.Text := 'select temcodigo from mes, mor ' + 'where mes.temcodigo in (4,5,50) and mes.meschave=mor.meschave and ' + 'mor.orcchave=' +
    vlOrcChave;
  consulta.Open;

  if not consulta.IsEmpty then
  begin
    Showmessage('Já existe um documento fiscal desta venda, verifique na tela de notas.');

    vlPodeCancelar := false;
    exit;

  end;

  if vlPodeCancelar = false then
  begin
    Timer2.Enabled := True;
    Timer1.Enabled := True;

    Showmessage('Este pedido não pode ser cancelado, ja foi entregue ou cancelado!');
    exit;
  end;

  if frxDados.DataSet = orcs then
  begin
    vlNumeroPedido := orcspdgnumero.AsString;
  end
  else
  begin
    vlNumeroPedido := orcssaipdgnumero.AsString;
  end;

  if orcs.Active then
  begin

    if Autorizado(ActCancelaPedido, 'Cancelamento do pedido') then
    begin

      if vlOrcChave <> '' then
      begin
        if MessageDlg('Tem certeza que deseja cancelar o pedido nr: ' + vlNumeroPedido + ' ?' + #13 + #13 +
          'Após o cancelamento não será mais possível recuperar os itens do pedido !', mtConfirmation, [mbYes, mbNo], 0, mbNo) = mrYes then
        begin

          vlMeaCodigo := MostraLista('mmea', '');
          if (vlMeaCodigo <> '') and (vlMeaCodigo <> '0') then
          begin

            itoimm.Close;
            itoimm.SQL.Text := 'select ito.itochave, imm.immnumepedido from imm,ito where imm.itochave=ito.itochave and ito.orcchave=' + vlOrcChave;
            itoimm.Open;

            itoimm.first;
            while not itoimm.eof do
            begin

              consulta.Close;
              consulta.SQL.Text := 'update ito set itoitempedido=' + itoimm.Fieldbyname('immnumepedido').AsString + ' where itochave=' +
                itoimm.Fieldbyname('itochave').AsString;
              consulta.ExecSQL;

              itoimm.next;
            end;

            consulta.Close;
            consulta.SQL.Text := 'delete from imp where itochave in (select itochave from ito where orcchave=' + vlOrcChave + ')';
            consulta.ExecSQL;

            if ExecutaSQL('SET @orcchave = ' + vlOrcChave + '; ' + 'UPDATE orc SET meacodigo=' + vlMeaCodigo +
              ', stocodigo = 88 WHERE orcchave = @orcchave; ' + 'UPDATE ito SET stocodigo = 88 WHERE orcchave = @orcchave; ') then
            begin

              consulta.Close;
              consulta.SQL.Text := 'select meschave from mor where orcchave=' + vlOrcChave;
              consulta.Open;

              if not consulta.IsEmpty then
              begin
                vlMeschave := consulta.Fieldbyname('meschave').AsString;
              end;

              if (vlMeschave <> '') and (vlMeschave <> '0') then
              begin
                CancelaVenda(vlMeschave, vlMeaCodigo);
              end;
              Showmessage('Pedido cancelado com sucesso !');
              orcs.Refresh;
              orcssai.Refresh;

            end
            else
            begin
              Showmessage('Não foi possivel cancelar o pedido, verifique !');
            end;

          end;
        end;
      end;
    end;

  end;

  Timer2.Enabled := True;
  Timer1.Enabled := True;

  // inherited;
end;

PROCEDURE TFprinciEntregas.CancelarRCR(vMesChave, vMotivo, vlMeaCodigo: STRING);
var
  vlrcrchave: string;
begin
  //
  dtl.Close;
  dtl.ParamByName('meschave').AsString := vMesChave;
  dtl.Open;

  dtl.first;
  while not dtl.eof do
  begin
    if lowercase(dtlmdaidentificacao.AsString) = 'crédito' then
    begin
      consulta.Close;
      consulta.SQL.Text := 'select rcrchave from mce where mcemotivo like ' + QuotedStr('%' + vMesChave + '%') + ' order by mcechave desc limit 1';
      consulta.Open;
      if not consulta.IsEmpty then
      begin
        vlrcrchave := consulta.Fieldbyname('rcrchave').AsString;

        if vlrcrchave <> '' then
        begin

          mce.Close;
          mce.Open;
          mce.Append;
          mcercrchave.AsString := vlrcrchave;
          mceclbcodigo.AsInteger := Acesso.Usuario;
          mcetmccodigo.AsInteger := 3;
          mcemcemotivo.AsString := vMotivo;
          mcemecregistro.AsString := agora(Application, Conexao);
          mceltechave.AsInteger := dtlltechave.AsInteger;
          mce.Post;

          mcr.Close;
          mcr.Open;
          mcr.Append;

          mcrrcrchave.AsString := vlrcrchave;
          mcrmcrvalor.AsCurrency := dtldtlvalor.AsCurrency;
          mcrmcechave.AsInteger := mcemcechave.AsInteger;

          mcr.Post;

        end;

      end;

    end;

    dtl.next;
  end;
end;

procedure TFprinciEntregas.CancelaVenda(vMesChave: string; vMeaCodigo: string);
var
  vMotivo: string;
  vlMeaCodigo: string;
  vlAcao: string;

begin
  { inherited; }

  { If Self.uqtabelamesprotocolo.AsString <> '' Then
    begin
    ShowMessage('ATENÇÃO: Este registro é uma NFE, não pode ser cancelado!');
    exit;
    end; }

  // try

  vlMeaCodigo := vMeaCodigo;
  vMotivo := 'Cancelamento TOTAL !';

  consulta.Close;
  consulta.SQL.Text := 'UPDATE mes SET sdecodigo = ''02'' WHERE meschave = ' + vMesChave;
  consulta.ExecSQL;

  consulta.Close;
  consulta.SQL.Text := 'INSERT INTO hcm (meschave, sdecodigo, clbcodigo, hcmdata, hcmhora, hcmdescricao) VALUES ( ';
  consulta.SQL.add(vMesChave + ', ');
  consulta.SQL.add('''02'', ');
  consulta.SQL.add(Acesso.Usuario.ToString + ', ');
  consulta.SQL.add(QuotedStr(ajustadata(DateToStr(date))) + ', ');
  consulta.SQL.add(QuotedStr(Timetostr(time)) + ', ');
  consulta.SQL.add(QuotedStr(vMotivo) + ')');
  consulta.ExecSQL;

  CancelarRFI(vMesChave, vMotivo, vlMeaCodigo);

  CancelarRCR(vMesChave, vMotivo, vlMeaCodigo);

  { if (uqtabelatdfcodigo.AsString = '55') or (uqtabelatdfcodigo.AsString = '65') then
    begin
    InutilizarNumeracao(uqtabelameschave.AsInteger, uqtabelatdfcodigo.AsString);
    end; }

  // except
  // Showmessage('Falha de Cancelamento da venda número: ' + vMesChave + '!');
  // end;

end;

procedure TFprinciEntregas.ActCancelarEntregdorExecute(Sender: TObject);
var
  vlOrcChave: string;
  vlAcao: string;
begin
  vlAcao := (Sender as TAction).Tag.ToString;

  if RegistroAcessoOperacao(vlAcao, 'Registro') then
  begin

    SituacaoEntregadores;

    { if orcssaipdscodigo.AsInteger >= 4 then
      begin
      Showmessage('Só é possivel voltar entregador pedidos não Entregues!');
      exit;
      end; }

    if orcssaistocodigo.AsInteger = stoCancelado then
    begin
      Showmessage('Este pedido foi cancelado, não pode ser mais alterado!');
      exit;
    end;

    try

      if MessageDlg('Confirma o CANCELAMENTO do entregador ' + orcssaietdidentificacaoent.AsString + '?' + #13 + 'Pedido: ' +
        orcssaipdgnumero.AsString + '  ?', mtConfirmation, [mbYes, mbNo], 0, mbNo) = IdYes then
      begin

        vlOrcChave := orcssaiorcchave.AsString;

        if orcssaiclbcodigoent.AsString <> '' then
        begin

          consulta.Close;
          consulta.Close;
          consulta.SQL.Text := 'update orc set pdscodigo=3, clbentregador=' + '0' + ' where orcchave=' + vlOrcChave;
          consulta.ExecSQL;

          consulta.Close;
          consulta.Close;
          consulta.SQL.Text := 'update imm  set imm.clbcodigoent=' + '0' + ' where itochave in (' + 'select itochave from ito where orcchave=' +
            vlOrcChave + ')';
          consulta.ExecSQL;

          LimpaRecebimentosStone(vlOrcChave.ToInteger);


        end;

      end;

    finally
      ActAtualizarLista.Execute;
    end;
  end;
end;

procedure TFprinciEntregas.SituacaoEntregadores;
var
  vlPlColab: TPanel;
  vlPlColabNome: TPanel;
  vlPlColabTempo: TPanel;

  vlCor: TColor;
  vlCorLetra: TColor;

  i: Integer;
  vlAtuDisponivel: Integer;
  vlAtuEntrega: Integer;
  DiffTimeStr: string;
begin
  i := 1;

  try
    vtEmEntrega.DisableControls;
    vtDisponiveis.DisableControls;

    if vtEmEntrega.Active then
    begin
      if not vtEmEntrega.IsEmpty then
        vlAtuEntrega := vtEmEntregaclbcodigo.AsInteger
      else
        vlAtuEntrega := 0;
    end
    else
    begin
      vlAtuEntrega := 0;
    end;

    if vtDisponiveis.Active then
    begin

      if not vtDisponiveis.IsEmpty then
        vlAtuDisponivel := vtDisponiveisclbcodigo.AsInteger
      else
        vlAtuDisponivel := 0;
    end
    else
    begin
      vlAtuDisponivel := 0;
    end;

    vtEmEntrega.Close;
    vtEmEntrega.Clear;
    vtEmEntrega.Open;

    vtDisponiveis.Close;
    vtDisponiveis.Clear;
    vtDisponiveis.Open;

    clbcax.Close;
    clbcax.ParamByName('cznchave').AsString := vpCznChave;
    clbcax.Open;

    lcozinha.Caption := 'Czn.:' + vpCznChave;

    clbcax.first;
    while not clbcax.eof do
    begin

      clbsit.Close;
      clbsit.ParamByName('clbcodigo').AsInteger := clbcaxclbcodigo.AsInteger;
      clbsit.FilterSQL := 'orcretorno is null';
      clbsit.Filtered := True;
      clbsit.Open;

      if (not clbsit.IsEmpty) then
      begin
        // esta na rua
        if (clbsitstocodigo.AsInteger <> 88) then
        begin
          DiffTimeStr := FormatDateTime('hh:nn:ss', strtodatetime(agora(Application, Conexao)) - clbsitpdghoraentrega.asdatetime);

          vtEmEntrega.Append;
          vtEmEntregaclbcodigo.AsInteger := clbcaxclbcodigo.AsInteger;
          vtEmEntregaclbidentificacao.AsString := clbcaxclbidentificacao.AsString;
          vtEmEntregahorachegada.AsFloat := clbcaxcceabertura.AsFloat;
          vtEmEntregahorasaida.AsFloat := strtotime(clbsitpdghoraentrega.AsString);
          vtEmEntregatempo.AsString := DiffTimeStr;
          vtEmEntregahora.AsString := copy(DiffTimeStr, 1, 5);
          vtEmEntrega.Post;
        end
        else
        begin

          DiffTimeStr := FormatDateTime('hh:nn:ss', strtodatetime(agora(Application, Conexao)) - clbsitpdghoraentrega.asdatetime);

          vtDisponiveis.Append;
          vtDisponiveisclbcodigo.AsInteger := clbcaxclbcodigo.AsInteger;
          vtDisponiveisclbidentificacao.AsString := clbcaxclbidentificacao.AsString;
          vtDisponiveishorachegada.AsFloat := strtotime(clbsitpdghoraentrega.AsString);
          vtDisponiveishorasaida.AsFloat := 0;
          vtDisponiveistempo.AsString := DiffTimeStr;
          vtDisponiveishora.AsString := copy(DiffTimeStr, 1, 5);
          vtDisponiveis.Post;

          vlCor := clGreen;
          vlCorLetra := clWhite;

        end;
      end
      else
      begin
        // esta na loja
        clbsit.Close;
        clbsit.ParamByName('clbcodigo').AsInteger := clbcaxclbcodigo.AsInteger;
        clbsit.FilterSQL := '';
        clbsit.Open;
        if (clbsitpdghoraentrega.AsString <> '') then
        begin

          DiffTimeStr := FormatDateTime('hh:nn:ss', strtodatetime(agora(Application, Conexao)) - clbsitorcretorno.asdatetime);

          vtDisponiveis.Append;
          vtDisponiveisclbcodigo.AsInteger := clbcaxclbcodigo.AsInteger;
          vtDisponiveisclbidentificacao.AsString := clbcaxclbidentificacao.AsString;
          vtDisponiveishorachegada.AsFloat := strtotime(clbsitorcretorno.AsString);
          vtDisponiveishorasaida.AsFloat := 0;
          vtDisponiveistempo.AsString := DiffTimeStr;
          vtDisponiveishora.AsString := copy(DiffTimeStr, 1, 5);
          vtDisponiveis.Post;

          vlCor := clGreen;
          vlCorLetra := clWhite;

        end
        else
        begin

          DiffTimeStr := FormatDateTime('hh:nn:ss', strtodatetime(agora(Application, Conexao)) - clbcaxcceabertura.asdatetime);

          vtDisponiveis.Append;
          vtDisponiveisclbcodigo.AsInteger := clbcaxclbcodigo.AsInteger;
          vtDisponiveisclbidentificacao.AsString := clbcaxclbidentificacao.AsString;
          vtDisponiveishorachegada.AsFloat := clbcaxcceabertura.AsFloat;
          vtDisponiveishorasaida.AsFloat := 0;
          vtDisponiveistempo.AsString := DiffTimeStr;
          vtDisponiveishora.AsString := copy(DiffTimeStr, 1, 5);
          vtDisponiveis.Post;

          vlCor := clYellow;
          vlCorLetra := clRed;

        end;

      end;

      clbcax.next;
    end;
    vtDisponiveis.IndexFieldNames := 'tempo DESC';
    vtEmEntrega.IndexFieldNames := 'tempo DESC';

  finally

    if vlAtuEntrega <> 0 then
      vtEmEntrega.Locate('clbcodigo', vlAtuEntrega, []);

    if vlAtuDisponivel <> 0 then
      vtDisponiveis.Locate('clbcodigo', vlAtuDisponivel, []);

    vtEmEntrega.EnableControls;
    vtDisponiveis.EnableControls;
  end;
end;

function SetSystemTime(DateTime: TDateTime): Boolean;
{ (c) by UNDO }
var
  tSetDati: TDateTime;
  vDatiBias: Variant;
  tTZI: TTimeZoneInformation;
  tST: TSystemTime;
begin
  GetTimeZoneInformation(tTZI);
  vDatiBias := tTZI.Bias / 1440;
  tSetDati := DateTime + vDatiBias;
  with tST do
  begin
    wYear := strtoint(FormatDateTime('yyyy', tSetDati));
    wMonth := strtoint(FormatDateTime('mm', tSetDati));
    wDay := strtoint(FormatDateTime('dd', tSetDati));
    wHour := strtoint(FormatDateTime('hh', tSetDati));
    wMinute := strtoint(FormatDateTime('nn', tSetDati));
    wSecond := strtoint(FormatDateTime('ss', tSetDati));
    wMilliseconds := 0;
  end;
  Result := True; // Windows.SetSystemTime(tST);
end;

function SetPCSystemTime(dDateTime: TDateTime): Boolean;
const
  SE_SYSTEMTIME_NAME = 'SeSystemtimePrivilege';
var
  hToken: THandle;
  ReturnLength: DWORD;
  tkp, PrevTokenPriv: TTokenPrivileges;
  luid: TLargeInteger;
  dSysTime: TSystemTime;
begin
  Result := false;
  if (Win32Platform = VER_PLATFORM_WIN32_NT) then
  begin
    if OpenProcessToken(GetCurrentProcess, TOKEN_ADJUST_PRIVILEGES or TOKEN_QUERY, hToken) then
    begin
      try
        if not LookupPrivilegeValue(nil, SE_SYSTEMTIME_NAME, luid) then
          exit;

        tkp.PrivilegeCount := 1;
        tkp.Privileges[0].luid := luid;
        tkp.Privileges[0].Attributes := SE_PRIVILEGE_ENABLED;
        if not AdjustTokenPrivileges(hToken, false, tkp, SizeOf(TTokenPrivileges), PrevTokenPriv, ReturnLength) then
          exit;
        if (GetLastError <> ERROR_SUCCESS) then
        begin
          raise Exception.Create(SysErrorMessage(GetLastError));
          exit;
        end;
      finally
        CloseHandle(hToken);
      end;
    end;
  end;
  DateTimeToSystemTime(dDateTime, dSysTime);
  Result := True;
end;

procedure TFprinciEntregas.SpeedButton5Click(Sender: TObject);
begin
  { todo }
end;

procedure TFprinciEntregas.Timer1Timer(Sender: TObject);
var
  myYear, myMonth, myDay, myHour, myMin, mySec, myMSec: Word;
  myDate: TDateTime;

begin

  verhorario.Close;
  verhorario.Connection := Conexao;
  verhorario.SQL.Text := 'select now() horario';
  verhorario.Open;
  if not verhorario.IsEmpty then
  begin
    myDate := verhorario.Fieldbyname('horario').asdatetime;

    DecodeDateTime(myDate, myYear, myMonth, myDay, myHour, myMin, mySec, myMSec);

    // SetPCSystemTime(myDate);
  end;

  horario.Caption := formatfloat('00', myHour) + ':' + formatfloat('00', myMin) + ':' + formatfloat('00', mySec);

  if vpVerificaInternet = 8 then
  begin

    adc.close;
    adc.Open;

    if ((adc.FieldByName('adcchaveintegracao').asstring<>''))
       and (lowercase(vpIntegraStone)='sim') then
    begin

      TimerRPW.enabled:=true;
      imStoneonLine.Visible:=true;
    end
    else
    begin
      TimerRPW.enabled:=False;
      imStoneonLine.Visible:=False;
    end;


    if IMenuInfo.Visible then
    begin
      IMenuInfo.Visible := false;
      imaconexao2.Visible := True;
      imaconexao3.Visible := false;
      imaconexao4.Visible := false;
      imaconexao5.Visible := false;
    end
    else if imaconexao2.Visible then
    begin
      IMenuInfo.Visible := false;
      imaconexao2.Visible := false;
      imaconexao3.Visible := True;
      imaconexao4.Visible := false;
      imaconexao5.Visible := false;
    end
    else if imaconexao3.Visible then
    begin
      IMenuInfo.Visible := false;
      imaconexao2.Visible := false;
      imaconexao3.Visible := false;
      imaconexao4.Visible := True;
      imaconexao5.Visible := false;
    end
    else if imaconexao4.Visible then
    begin
      IMenuInfo.Visible := false;
      imaconexao2.Visible := false;
      imaconexao3.Visible := false;
      imaconexao4.Visible := false;
      imaconexao5.Visible := True;
    end
    else if imaconexao5.Visible then
    begin
      IMenuInfo.Visible := True;
      imaconexao2.Visible := false;
      imaconexao3.Visible := false;
      imaconexao4.Visible := false;
      imaconexao5.Visible := false;
    end;
    vpVerificaInternet := 0;
  end
  else
  begin
    vpVerificaInternet := vpVerificaInternet + 1;
  end;

  vpContaTempo := vpContaTempo + 1;

  if vpContaTempo >= cfgcfgmgoutempoentrega.AsInteger then
  begin

    Label1.Caption := IntToStr(vpContaTempo) + ' de ' + cfgcfgmgoutempoentrega.AsString;
    Application.ProcessMessages;
    ActAtualizarLista.Execute;
    vpContaTempo := 0;
  end
  else
  begin
    Label1.Caption := IntToStr(vpContaTempo) + ' de ' + cfgcfgmgoutempoentrega.AsString;
    Application.ProcessMessages;
  end;

end;

procedure TFprinciEntregas.Timer2Timer(Sender: TObject);
begin

//  horario.Caption := agora(Application, Conexao);

  // Self.ActAtualizarLista.Execute;
end;

Procedure TFprinciEntregas.LimpaRecebimentosStone(aOrcChave:Integer);
var
  ftefwifi:Tftefwifi;

begin
  rpworc.close;
  rpworc.connection:=conexao;
  rpworc.parambyname('orcchave').asInteger:=aOrcChave;
  rpworc.open;

  if not rpworc.isempty then
  begin

    ftefwifi:=Tftefwifi.create(self);
                  ftefwifi.vpTrmCodigo:=Acesso.Terminal;
                  ftefwifi.vpFlaCodigo:=acesso.Filial;
                  ftefwifi.vpCznChave:=vpCznChave.ToInteger;
                  ftefwifi.vpClbCodigo:=Acesso.usuario;
                  ftefwifi.zcone:=conexao;
                  ftefwifi.vpValorAReceber:=rpworcorctotalav.ascurrency;
                  ftefwifi.ExecutaCancelamento(rpworcrpwtoken.asstring, aOrcChave.toString);
                  ftefwifi.free;

  end;
end;




procedure TFprinciEntregas.ActFechaCaixaExecute(Sender: TObject);
var
  vlCcxChave: String;
  vlMeschave: String;
begin

  Timer1.Enabled := false;

  clbcax.Close;
  clbcax.ParamByName('cznchave').AsString := vpCznChave;
  clbcax.Open;

  if not clbcax.IsEmpty then
  begin
    Showmessage('Não é possivel fechar o caixa!' + #13 + 'O entregador ' + clbcaxclbidentificacao.AsString + ' esta com o caixa aberto.');
    exit;
  end;

  if MessageDlg('Confirma fechamento de caixa de entregas ?', mtConfirmation, [mbYes, mbNo], 0, mbNo) = IdYes then
  begin
    orcssai.Open;
    orcssai.first;
    while not orcssai.eof do
    begin

      orcabe.Close;
      orcabe.ParamByName('cznchave').AsString := vpCznChave;
      orcabe.ParamByName('clbcodigoent').AsString := orcssaiclbcodigoent.AsString;
      orcabe.Open;

      orcabe.first;
      while not orcabe.eof do
      begin
        vlMeschave := '';
        vlMeschave := FechaVendas(orcssaiorcchave.AsString);
        if vlMeschave <> '' then
        begin

        end;

        orcabe.next;
      end;
      orcssai.next;
    end;

    // if AjusteCaixa('fechamento') <> '' then
    ccx.Close;
    ccx.SQL.Text := 'SELECT   ccx.ccxchave,  ccx.clbcodigo,  ccx.ctacodigo,  ccx.ccxturno,  ccx.ccxdataber,';
    ccx.SQL.add(' ccx.ccxhoraaber,  ccx.ccxsaldoaber,  ccx.ccxdatafecha,  ccx.ccxhorafecha,  ccx.ccxsaldofecha, ');
    ccx.SQL.add(' ccx.ccxsangrias,  ccx.ccxsuprimentos FROM ccx where ccx.ctacodigo=' + vpCtaCodigo);
    ccx.SQL.add('  and ccxdatafecha is null');
    ccx.SQL.add(' ORDER BY ccx.ccxchave desc limit 1');
    ccx.Open;
    plccxchave.Caption := 'Caixa: ' + ccx.Fieldbyname('ccxchave').AsString;

    vlCcxChave := ccxccxchave.AsString;

    if (ccxclbcodigo.AsInteger = Acesso.Usuario) then
    begin

      if RegistraOperacaoCaixa(tocFechamentoCaixa) <> '' then
      begin
        if vlCcxChave <> '' then
        begin
          orcabe.Close;
          orcabe.ParamByName('cznchave').AsString := vpCznChave;
          orcabe.ParamByName('clbcodigoent').AsString := Acesso.Usuario.ToString;
          orcabe.Open;

          orcabe.first;
          while not orcabe.eof do
          begin
            FechaVendas(orcabeorcchave.AsString);
            orcabe.next;
          end;

          ccx.Close;
          ccx.SQL.Text := 'SELECT   ccx.ccxchave,  ccx.clbcodigo,  ccx.ctacodigo,  ccx.ccxturno,  ccx.ccxdataber,';
          ccx.SQL.add(' ccx.ccxhoraaber,  ccx.ccxsaldoaber,  ccx.ccxdatafecha,  ccx.ccxhorafecha,  ccx.ccxsaldofecha, ');
          ccx.SQL.add(' ccx.ccxsangrias,  ccx.ccxsuprimentos FROM ccx where ccx.ctacodigo=' + vpCtaCodigo);
          ccx.SQL.add('  and ccx.ccxchave=' + vlCcxChave);
          ccx.SQL.add(' ORDER BY ccx.ccxchave desc limit 1');
          ccx.Open;

          plccxchave.Caption := 'Caixa: ' + ccx.Fieldbyname('ccxchave').AsString;
         {
          Application.CreateForm(tfcxm, fcxm);
          fcxm.Fzcone := Self.ccx.Connection;
          fcxm.vpccxchave := vlCcxChave.ToInteger;
          fcxm.ShowModal;
         }
          ImprimeComprovantesCaixa(ocxFechamento);

        end;
        AjustaCaixa;

      end;
      Ajustabotoes(false);
    end
    else
    begin

      consulta.Close;
      consulta.SQL.Text := 'SELECT ccx.ccxchave , ccx.ccxdataber , ccx.ccxhoraaber, clb.clbidentificacao FROM ccx ';
      consulta.SQL.add('INNER JOIN clb ON ccx.clbcodigo = clb.clbcodigo ');
      consulta.SQL.add('WHERE ccx.ccxdatafecha IS NULL order by ccxchave desc limit 1');
      consulta.Open;

      if not consulta.IsEmpty then
      begin

        vlCcxChave := consulta.Fieldbyname('ccxchave').AsString;

        if vlCcxChave <> '' then
        begin
          if RegistraOperacaoCaixa(tocFechamentoCaixa) <> '' then
          begin
            ccx.Close;
            ccx.SQL.Text := 'SELECT   ccx.ccxchave,  ccx.clbcodigo,  ccx.ctacodigo,  ccx.ccxturno,  ccx.ccxdataber,';
            ccx.SQL.add(' ccx.ccxhoraaber,  ccx.ccxsaldoaber,  ccx.ccxdatafecha,  ccx.ccxhorafecha,  ccx.ccxsaldofecha, ');
            ccx.SQL.add(' ccx.ccxsangrias,  ccx.ccxsuprimentos FROM ccx where ccx.ccxchave=' + vlCcxChave);
            ccx.SQL.add(' ORDER BY ccx.ccxchave');
            ccx.Open;
            plccxchave.Caption := 'Caixa: ' + ccx.Fieldbyname('ccxchave').AsString;
            {
            Application.CreateForm(tfcxm, fcxm);
            fcxm.Fzcone := Self.ccx.Connection;
            fcxm.vpccxchave := Self.ccxccxchave.AsInteger;
            fcxm.ShowModal;
            }
            ImprimeComprovantesCaixa(ocxFechamento);

          end;
          AjustaCaixa;

          Ajustabotoes(false);

        end;

      end;

    end;

  end;

  Timer1.Enabled := True;

end;

function TFprinciEntregas.RegistroAcessoOperacao(vactcodigo: string; vMotivo: string; vtabela: string = ''; vregistro: string = ''): Boolean;
var
  auto: TliberacaoRFI;
  vRetornoUsr: string;
  vLiberacao: Boolean;
  Pack: Cardinal;
begin

  vLiberacao := True;

  Pack := LoadPackage('modulos\mlia.bpl');
  if Pack <> 0 then
    try
      @auto := GetProcAddress(Pack, PChar('liberacao'));

      if Assigned(auto) then
      begin
        vRetornoUsr := auto(Application, Conexao, Acesso.Usuario.ToString, vactcodigo, vMotivo, '', '', '', '', '', True, vtabela, vregistro);

        if (vRetornoUsr = '0') or (vRetornoUsr = '') then // retornou NÃO AUTORIZADO
          vLiberacao := false;
      end;
    finally
      DoUnLoadPackage(Application, Pack);
    end;

  Result := vLiberacao;
end;

procedure TFprinciEntregas.VerificaRetiraBalcao;
begin

  clbsit.Close;
  clbsit.ParamByName('clbcodigo').AsInteger := clbcaxclbcodigo.AsInteger;
  clbsit.FilterSQL := 'orcretorno is null';
  clbsit.Filtered := True;
  clbsit.Open;

  if (not clbsit.IsEmpty) then
  begin
    clbsit.first;
    while not clbsit.eof do
    begin

      if clbsitclbcodigo.AsInteger = clbcaxclbcodigo.AsInteger then
      begin
        if clbsitorcretorno.AsString = '' then
        begin
          consulta.Close;
          consulta.SQL.Text := 'update orc set orcretorno=' + QuotedStr(Timetostr(now())) + ' where orcchave= ' + clbsitorcchave.AsString;
          consulta.ExecSQL;
        end;

      end;

      clbsit.next;
    end;

    SituacaoEntregadores;

  end;

end;

procedure TFprinciEntregas.ActFecharCaixaEntregadorExecute(Sender: TObject);
var
  vlMeschave: string;
  vlNomeArq: string;
  BlobField: TBlobField;
  vlAcao: string;
  vloricodigo: string;
begin
  inherited;

  if ActAbreCaixa.Enabled then
  begin
    Showmessage('Necessário abrir o caixa de entregas!');
    exit;
  end;

  try
    SituacaoEntregadores;

    Timer1.Enabled := false;

    vlAcao := IntToStr((Sender as TAction).Tag);

    if Autorizado(ActFecharCaixaEntregador, 'Fechamento de caixa de Entregadores') then
    begin

      Application.CreateForm(tlcaixaentregadores, lcaixaentregadores);

      clbcax.Close;
      clbcax.ParamByName('cznchave').AsString := vpCznChave;
      clbcax.Open;

      lcaixaentregadores.Dclb.DataSet := clbcax;

      if lcaixaentregadores.ShowModal = mrOk then
      begin

        VerificaRetiraBalcao;

        if (vtEmEntrega.Locate('clbcodigo', clbcaxclbcodigo.AsString, [])) and (cfgcfgmgoucontrolaentrega.AsInteger = 1) then
        begin

          Showmessage('O entregador ' + clbcaxclbidentificacao.AsString + ' esta EM ENTREGA, não pode ter o caixa fechado!');
        end
        else
        begin

          consulta.Close;
          consulta.SQL.Text := 'SELECT ccechave from cce where ccefechamento IS NULL and cznchave=' + vpCznChave + ' and  clbcodigo=' +
            clbcaxclbcodigo.AsString;
          consulta.Open;
          if not consulta.IsEmpty then
          begin
            if CriaFormulario(Tfccefecha, consulta.Fieldbyname('ccechave').AsString, consulta.Fields[0].AsString) then
            begin

              orcabe.Close;
              orcabe.ParamByName('cznchave').AsString := vpCznChave;
              orcabe.ParamByName('clbcodigoent').AsString := clbcaxclbcodigo.AsString;
              orcabe.Open;

              orcabe.first;
              while not orcabe.eof do
              begin
                vlMeschave := '';
                vlMeschave := FechaVendas(orcabeorcchave.AsString);
                if vlMeschave <> '' then
                begin
                  consulta.Close;
                  consulta.SQL.Text :=
                    'select mes.oricodigo, ori.etdcodigo orietdcodigo, mes.etdcodigo mesetdcodigo, mes.meschave  from mes,ori,mor where mes.oricodigo=ori.oricodigo and mes.meschave=mor.meschave and mor.orcchave='
                    + vpOrcChave;
                  consulta.Open;

                  if not consulta.IsEmpty then
                  begin
                    vlMeschave := consulta.Fieldbyname('meschave').AsString;

                    if (consulta.Fieldbyname('orietdcodigo').AsString <> '') and (consulta.Fieldbyname('orietdcodigo').AsString <> '0') then
                    begin

                      if (consulta.Fieldbyname('orietdcodigo').AsString <> consulta.Fieldbyname('mesetdcodigo').AsString) then
                      begin
                        vloricodigo := consulta.Fieldbyname('orietdcodigo').AsString;

                        consulta.Close;
                        consulta.SQL.Text := 'UPDATE rfi,rfm SET rfi.etdcodigo=' + vloricodigo + ' WHERE rfi.rfichave=rfm.rfichave AND rfm.meschave='
                          + vlMeschave;
                        consulta.ExecSQL;

                        consulta.Close;
                        consulta.SQL.Text := 'UPDATE v_rfi,rfm SET v_rfi.etdcodigo=' + vloricodigo +
                          ' WHERE v_rfi.rfichave=rfm.rfichave AND rfm.meschave=' + vlMeschave;
                        consulta.ExecSQL;

                        consulta.Close;
                        consulta.SQL.Text := 'UPDATE tit,rfi,rfm SET tit.etdcodigo=' + vloricodigo +
                          ' WHERE tit.titcodigo=rfi.titcodigo and rfi.rfichave=rfm.rfichave AND rfm.meschave=' + vlMeschave;
                        consulta.ExecSQL;

                      end;
                    end;
                  end;

                end;

                if trim(lowercase(vpIntegraStone))='sim' then
                begin

                  adc.close;
                  adc.Open;

                  if adc.FieldByName('adcchaveintegracao').asstring<>'' then
                  begin
                    LimpaRecebimentosStone(orcabeorcchave.asinteger);
                  end;

                end;

                orcabe.next;
              end;





              { consulta.Close;
                consulta.SQL.Text := 'select relarquivo from rel where relcodigo=' + chr(39) + cfgcfgmgourelentrecomple.AsString + chr(39);
                consulta.Open;

                vlNomeArq := Extractfilepath(Application.ExeName) + 'Relat\relatorioentdetalhado.fr3';

                BlobField := consulta.Fields[0] as TBlobField;
                BlobField.SaveToFile(vlNomeArq);

                if not FileExists(vlNomeArq) then
                begin
                Showmessage('Arquivo nao localizado: ' + vlNomeArq);
                exit;
                end;

                relatorio.LoadFromFile(vlNomeArq);

                relatorio.Variables['cznchave'] := QuotedStr(vpCznChave);
                relatorio.Variables['clbcodigo'] := QuotedStr(clbcaxclbcodigo.AsString);

                relatorio.ShowReport; }

              FprinciEntregas.consulta.Close;
              FprinciEntregas.consulta.SQL.Text := 'select relarquivo from rel where relcodigo=' + chr(39) +
                FprinciEntregas.cfgcfgmgourelentrecomple.AsString + chr(39);
              FprinciEntregas.consulta.Open;

              vlNomeArq := Extractfilepath(Application.ExeName) + 'Relat\relatorioentdetalhado.fr3';
              if FprinciEntregas.consulta.Fields[0].AsString <> '' then
              begin
                BlobField := FprinciEntregas.consulta.Fields[0] as TBlobField;
                BlobField.SaveToFile(vlNomeArq);

                if not FileExists(vlNomeArq) then
                begin
                  Showmessage('Arquivo nao localizado: ' + vlNomeArq);
                  exit;
                end;

                FprinciEntregas.relatorio.LoadFromFile(vlNomeArq);

                FprinciEntregas.relatorio.Variables['cznchave'] := QuotedStr(FprinciEntregas.vpCznChave);
                FprinciEntregas.relatorio.Variables['clbcodigoent'] := QuotedStr(clbcaxclbcodigo.AsString);

                // FprinciEntregas.relatorio.PrepareReport(true);
                FprinciEntregas.relatorio.PrintOptions.ShowDialog := false;
                FprinciEntregas.relatorio.ShowProgress := false;
                FprinciEntregas.relatorio.ShowReport;
              end;

              Showmessage('Caixa fechado com sucesso!');
              ActAtualizarLista.Execute;
            end;
          end;

        end;

      end;

    end;
  finally
    Timer1.Enabled := True;
  end;

end;

procedure TFprinciEntregas.ActGerarNotasExecute(Sender: TObject);
begin
  // inherited;
  TimerRPW.enabled:=False;
  Timer1.Enabled := false;
  TimerProducao.Enabled := false;

  MostraLista('mrdo', 'tdfcodigo=' + QuotedStr('00')); // + ' and mes.oricodigo not in (1,2,4,6) ');

  TimerProducao.Enabled := True;
  Timer1.Enabled := True;
  TimerRPW.enabled:=True;

end;

procedure TFprinciEntregas.ActImprimeCaixaExecute(Sender: TObject);
begin
  if not ActImprimeCaixa.Enabled then
    exit;

  if ccx.Active then
    ImprimeComprovantesCaixa(ocxFechamento);

  AjustaCaixa;

end;

Function TFprinciEntregas.MostraLista(pModulo: String; pFiltro: string = ''; pChaveMestre: string = ''): string;
var
  ExecForm: function(CargaFrame: TCargaFrame): String;
  vlCargaFrame: TCargaFrame;
  vlPack: NativeUInt;
begin

  { if InternetAtiva then
    begin
    VerAtualizacao(pModulo);
    end; }

  Result := '';
  vlPack := LoadPackage('modulos\' + pModulo + '.bpl');
  if vlPack <> 0 then
    try
      @ExecForm := GetProcAddress(vlPack, PChar('formu'));
      if Assigned(ExecForm) then
      begin

        vlCargaFrame := CargaFrameFormu(Application, vlPack, Conexao, Acesso, pFiltro, pChaveMestre);
        Result := ExecForm(vlCargaFrame);
      end;
    finally
      DoUnLoadPackage(Application, vlPack);
    end;
End;

Function TFprinciEntregas.MostraLista(pModulo: String; pModoCarga: TModoCarga; pFiltro: string = ''; pChaveMestre: string = ''): string;
var
  ExecForm: function(CargaFrame: TCargaFrame): String;
  vlCargaFrame: TCargaFrame;
  vlPack: NativeUInt;
begin
  Result := '';
  vlPack := LoadPackage('modulos\' + pModulo + '.bpl');
  if vlPack <> 0 then
    try
      @ExecForm := GetProcAddress(vlPack, PChar('formu'));
      if Assigned(ExecForm) then
      begin
        vlCargaFrame := CargaFrameFormu(Application, vlPack, Conexao, Acesso, pFiltro, pChaveMestre, pModoCarga);
        Result := ExecForm(vlCargaFrame);
      end;
    finally
      DoUnLoadPackage(Application, vlPack);
    end;
End;

procedure TFprinciEntregas.mQuemProduziuClick(Sender: TObject);
begin

  if Self.frxDados.DataSet.Fieldbyname('pdgnumero').AsString <> '' then
  begin

    Application.CreateForm(tfproducao, fproducao);
    fproducao.imp.Connection := Conexao;
    fproducao.imp.Close;
    fproducao.imp.ParamByName('immnumepedido').AsString := Self.frxDados.DataSet.Fieldbyname('pdgnumero').AsString;
    fproducao.imp.ParamByName('cznchave').AsString := vpCznChave;
    fproducao.imp.Open;

    fproducao.ShowModal;
  end;
end;

procedure TFprinciEntregas.plversaoDblClick(Sender: TObject);
var
  vlNomeArq: string;
  BlobField: TBlobField;
  vDirRelat: string;

begin
  inherited;
  Timer1.Enabled := false;

  // dsOrcs.DataSet.First;

  while not dsOrcs.DataSet.eof do
  begin

    listaOrcsCellClick(listaOrcs.Columns[1]);

    frxUniDACComponents1.DefaultDatabase := Conexao;

    vlNomeArq := Extractfilepath(Application.ExeName) + 'relat\comprovanteDelivery.fr3';

    if not FileExists(vlNomeArq) then
    begin
      Showmessage('Arquivo nao localizado: ' + vlNomeArq);
      exit;
    end;

    // relatorio.LoadFromFile(vlNomeArq);

    if vpOrcChave <> '' then
    begin
      consulta.Close;
      consulta.SQL.Text := 'select orcvias from orc where orcchave=' + vpOrcChave;
      consulta.Open;

      vDirRelat := Extractfilepath(Application.ExeName) + 'relat\ComprovanteDELIVERY.fr3';
      ImprimirComprovantesOrc(Application, Conexao, vpOrcChave, vDirRelat, trmtciporta.AsString, tiImprimirDireto);

    end;

    dsOrcs.DataSet.next;
  end;
  Timer1.Enabled := True;

end;


procedure TFprinciEntregas.AtualizaListas(vPode: Boolean = false);
var
  i: Integer;
  vlPodeAtualizar: Boolean;
  vlRecOcrs: Integer;
  vlRecOcrsSai: Integer;
  vlQuantos: Integer;
  vlQuantosProntos: Integer;
  vlOrdemOrcs: string;
  vlOrdemOrcssai: string;

  vlBaicodigo: string;
  vlNumePedido: string;

begin

  ccx.Close;
  ccx.SQL.Text := 'SELECT   ccx.ccxchave,  ccx.clbcodigo,  ccx.ctacodigo,  ccx.ccxturno,  ccx.ccxdataber,';
  ccx.SQL.add(' ccx.ccxhoraaber,  ccx.ccxsaldoaber,  ccx.ccxdatafecha,  ccx.ccxhorafecha,  ccx.ccxsaldofecha, ');
  ccx.SQL.add(' ccx.ccxsangrias,  ccx.ccxsuprimentos FROM ccx where ccx.ctacodigo=' + vpCtaCodigo);
  ccx.SQL.add('  and ccxdatafecha is null');
  ccx.SQL.add(' ORDER BY ccx.ccxchave desc limit 1');
  ccx.Open;

  if ccx.IsEmpty then
    exit;

  vlOrdemOrcs := '';
  vlOrdemOrcssai := '';

  if orcs.Active then
  begin
    for i := 0 to listaOrcs.Columns.Count - 1 do
    begin
      if listaOrcs.Columns[i].Title.Font.Color = clRed then
      begin
        vlOrdemOrcs := listaOrcs.Columns[i].FieldName;
      end;
    end;
  end;
  if orcssai.Active then
  begin
    for i := 0 to lista.Columns.Count - 1 do
    begin
      if lista.Columns[i].Title.Font.Color = clRed then
      begin
        vlOrdemOrcssai := lista.Columns[i].FieldName;
      end;

    end;
  end;

  if vlOrdemOrcs = '' then
  begin
    vlOrdemOrcs := 'pdgnumero';
  end;
  if vlOrdemOrcssai = '' then
  begin
    vlOrdemOrcssai := 'pdgnumero'
  end;

  SituacaoEntregadores;

  try
    consulta.Close;
    consulta.SQL.Text := 'select cznchave from czn where cznfechamento IS null order by cznchave limit 1';
    consulta.Open;
    if consulta.IsEmpty then
    begin

      Timer1.Enabled := false;
      Showmessage('Atenção:' + ''#13'' + ''#13'' + 'A Cozinha não esta aberta, solicite a abertura da Cozinha!');
      Application.Terminate;
      exit;
    end
    else
    begin
      vpCznChave := consulta.Fields[0].AsString;
    end;
    vlPodeAtualizar := True;
    vlRecOcrs := orcsorcchave.AsInteger;

    mostra.Visible := True;
    mostra.Max := orcs.RecordCount;
    mostra.Position := 0;

    orcs.DisableControls;
    if orcs.Active then
    begin
      while not orcs.eof do
      begin
        mostra.Position := mostra.Position + 1;
        Application.ProcessMessages;

        if orcsmarca.AsInteger = 1 then
        begin
          vlPodeAtualizar := false;
        end;

        orcs.next;
      end;
      orcs.first;
    end;

    if cfgcfgmgouatualizaentrega.AsInteger = 1 then
    begin
      vlPodeAtualizar := True;
    end;
    if cfg.Active then
    begin
      if vpContaTempo < cfgcfgmgoutempoentrega.AsInteger then
      begin
        vlPodeAtualizar := false;
      end
      else
      begin

        if vpPodeAtualizar then
        begin
          vlPodeAtualizar := True;
        end
        else
        begin
          vlPodeAtualizar := false;
        end;

        vlPodeAtualizar := True;
      end;
    end
    else
    begin
      vlPodeAtualizar := false;
    end;

    if vPode then
    begin
      vlPodeAtualizar := True;
    end;

    if vlPodeAtualizar then
    begin

      orcs.DisableControls;
      if orcs.Active then
      begin
        vlRecOcrs := orcsorcchave.AsInteger;
        orcs.first;
        mostra.Visible := True;
        mostra.Max := orcs.RecordCount;
        mostra.Position := 0;

        while not orcs.eof do
        begin

          bai.Close;
          bai.SQL.Text := 'select baicodigo from bai where lower(baiidentificacao)=' + QuotedStr(lowercase(orcsedrbairro.AsString));
          bai.Open;

          if not bai.IsEmpty then
            vlBaicodigo := bai.Fieldbyname('baicodigo').AsString
          else
            vlBaicodigo := '0';


          consulta.Close;
          consulta.SQL.Text := 'update orc set baicodigo=' + vlBaicodigo + ' where baicodigo=0 and orcchave=' + orcsorcchave.AsString;
          consulta.ExecSQL;


          consulta.Close;
          consulta.SQL.Text := 'update orc set baicodigo=' + vlBaicodigo + ' where baicodigo=0 and orcchave=' + orcsorcchave.AsString;
          consulta.ExecSQL;




          mostra.Position := mostra.Position + 1;

          if orcsorcchave.AsString <> '' then
          begin


            consulta.Close;
            consulta.SQL.Text :='UPDATE imm '+
                                'JOIN ito '+
                                '  ON ito.itochave = imm.itochave '+
                                ' AND ito.orcchave = '+ orcsorcchave.AsString+ ' '+
                                'SET imm.pdscodigo = 3 '+
                                'WHERE imm.pdscodigo = 2 '+
                                '  AND EXISTS (SELECT 1 '+
                                '              FROM bai '+
                                '              WHERE bai.procodigo = ito.procodigo) ';
            consulta.ExecSQL;


            consulta.Close;
            consulta.SQL.Text :=
              'update imm set pdscodigo=4 where imm.clbcodigoent<>0 and  itochave in (select itochave from ito,pro,gri where ito.procodigo=pro.procodigo and pro.grpcodigo=gri.grpcodigo and gri.gricontrolaproducao=0 and orcchave='
              + orcsorcchave.AsString + ')';
            consulta.ExecSQL;

            consulta.Close;
            consulta.SQL.Text := 'select count(immchave) prontos from ito,imm where imm.pdscodigo=3 and imm.itochave=ito.itochave  and orcchave=' +
              orcsorcchave.AsString;
            consulta.Open;

            vlQuantosProntos := consulta.Fieldbyname('prontos').AsInteger;

            consulta.Close;
            consulta.SQL.Text := 'select count(immchave) quantos from ito,imm where  imm.itochave=ito.itochave  and orcchave=' +
              orcsorcchave.AsString;
            consulta.Open;

            vlQuantos := consulta.Fieldbyname('quantos').AsInteger;

            if vlQuantos = vlQuantosProntos then
            begin
              consulta.Close;
              consulta.SQL.Text := 'update orc set  pdscodigo=3 where orcchave=' + orcsorcchave.AsString;
              consulta.ExecSQL;
            end
            else
            begin
              consulta.Close;
              consulta.SQL.Text :=
                'select count(immchave) quantos from imm where pdscodigo<=3 and imm.clbcodigoent<>0 and  itochave in (select itochave from ito,pro,gri where ito.procodigo=pro.procodigo and pro.grpcodigo=gri.grpcodigo and gri.gricontrolaproducao=0 and orcchave='
                + orcsorcchave.AsString + ')';
              consulta.Open;

              if consulta.Fieldbyname('quantos').AsInteger > 0 then
              begin

                consulta.Close;
                consulta.SQL.Text := 'update orc set pdscodigo=2 where pdscodigo<>3 and  orcchave=' + orcsorcchave.AsString;
                consulta.ExecSQL;
              end;

            end;

          end;

          orcs.next;
        end;
        orcs.Locate('orcchave', vlRecOcrs, []);

      end;
      orcs.EnableControls;
      mostra.Position := 0;
      mostra.Visible := false;

      vlRecOcrsSai := orcssaiorcchave.AsInteger;
      orcssai.DisableControls;
      horario.Caption := agora(Application, Conexao);
      orcssai.Close;
      orcs.Close;
      if not orcs.Active then
      begin
        orcs.Open;
        orcssai.Open;
        lito.Open;
      end;
      // orcs.Refresh;
      orcs.IndexFieldNames := vlOrdemOrcs;
      orcs.first;
      plQuantidadeAEntregar.Caption := 'A Entregar: ' + formatfloat('000', orcs.RecordCount);
      orcssai.IndexFieldNames := vlOrdemOrcssai;
      orcssai.first;
      plQuantidadeEntregues.Caption := 'Entregues: ' + formatfloat('000', orcssai.RecordCount);
    end;

  finally
    if orcssai.Active then
    begin
      orcssai.Locate('orcchave', vlRecOcrsSai, []);
      orcssai.EnableControls;

    end;
    if orcs.Active then
    begin
      orcs.EnableControls;
      orcs.Locate('orcchave', vlRecOcrs, []);
    end;
  end;
end;

function TFprinciEntregas.SelecionarEntregador: Boolean;
var
  vlOrcChave: string;
  vlAgora: string;
  myYear: Word;
  myMonth: Word;
  myDay: Word;
  myHour: Word;
  myMin: Word;
  mySec: Word;
  myMilli: Word;
  vlLiberado: string;
  vlEntregadoresFora: string;

  vlRetorno: string;

  vlBaicodigo: string;
  ftefwifi: Tftefwifi;


  vlorcschave:String;
  vlorcsnumeropedido:String;
  vlorcstotal:Currency;
  vlorcsetdidentificacao:String;
  vlEndereco:String;
  vlJsonEndereco:TJsonObject;
begin
  Timer2.Enabled := false;
  Timer1.Enabled := false;
  Result := True;
  try
    Application.CreateForm(tlentregadores, lentregadores);
    lentregadores.zCone:=conexao;
    lentregadores.Acesso:=Acesso;
    vlEntregadoresFora := '';
    vtEmEntrega.first;
    while not vtEmEntrega.eof do
    begin
      vlEntregadoresFora := vlEntregadoresFora + vtEmEntregaclbcodigo.AsString + ',';

      vtEmEntrega.next;
    end;
    vtEmEntrega.first;

    // vlEntregadoresFora := copy(vlEntregadoresFora, 1, Length(vlEntregadoresFora) - 1);

    vlEntregadoresFora := '';

    clbent.Close;

    clbent.ParamByName('cznchave').AsString := vpCznChave;

    if vlEntregadoresFora <> '' then
    begin

      clbent.FilterSQL := 'clbcodigo not in (' + vlEntregadoresFora + ')';

    end
    else
    begin
      clbent.FilterSQL := '';
    end;

    clbent.Open;
    lentregadores.Dclb.DataSet := clbent;
    if lentregadores.ShowModal = mrOk then
    begin

      if clbent.Active then
      begin
        if clbentclbcodigo.AsString <> '' then
        begin

          orcssai.FilterSQL := 'imm.clbcodigoent=' + clbentclbcodigo.AsString;

          orcssai.DisableControls;
          orcssai.first;

          if cfgcfgmgouretornartodos.AsInteger = 1 then
          begin

            while not orcssai.eof do
            begin
              vlRetorno := agora(Application, Conexao);
              vlRetorno := ajustadata(copy(vlRetorno, 1, 10)) + ' ' + copy(vlRetorno, 12, 10);

              if orcssaiclbcodigoent.AsString = clbentclbcodigo.AsString then
              begin
                consulta.Close;
                consulta.SQL.Text := 'update orc set pdscodigo=5, orcretorno=' + QuotedStr(vlRetorno) + ' where orcretorno is null  and orcchave=' +
                  orcssaiorcchave.AsString;
                consulta.ExecSQL;

              end;

              orcssai.next;
            end;

          end;

          orcssai.FilterSQL := '';
          orcssai.EnableControls;

          consulta.Close;
          vlAgora := agora(Application, Conexao);
          DecodeDateTime(strtodatetime(vlAgora), myYear, myMonth, myDay, myHour, myMin, mySec, myMilli);
          vlAgora := formatfloat('0000', myYear) + '-' + formatfloat('00', myMonth) + '-' + formatfloat('00', myDay) + ' ' + formatfloat('00', myHour)
            + ':' + formatfloat('00', myMin) + ':' + formatfloat('00', mySec);
          orcs.first;

          mostra.Visible := True;
          mostra.Max := orcs.RecordCount;
          mostra.Position := 0;
          orcs.DisableControls;

          while not orcs.eof do
          begin

            mostra.Position := mostra.Position + 1;
            Application.ProcessMessages;

            if orcs.Fieldbyname('marca').AsInteger = 1 then
            begin


              vlorcschave:=orcsorcchave.AsString;
              vlorcsnumeropedido:=orcsorcnumeropedido.AsString;
              vlorcstotal:=orcsorctotal.AsCurrency;
              vlorcsetdidentificacao:=orcsetdidentificacao.AsString;

              vlJsonEndereco:=TJsonObject.create;
              vlJsonEndereco.addpair('uf','MT');
              vlJsonEndereco.addpair('bairro','Centro');
              vlJsonEndereco.addpair('cidade','Sorriso');
              vlJsonEndereco.addpair('numero','0');
              vlJsonEndereco.addpair('logradouro','');
              vlJsonEndereco.addpair('referencia','');
              vlJsonEndereco.addpair('complemento','');

              vlEndereco:= '';//vlJsonEndereco.ToJSON;

              enviaPedido(sonumeros(cfgetddoc1.asstring),  vlorcschave,orcsetdidentificacao.AsString,vlEndereco,
                   orcsorctotal.AsCurrency,'novo');


              bai.Close;
              bai.SQL.Text := 'select baicodigo from bai where lower(baiidentificacao)=' + QuotedStr(lowercase(orcsedrbairro.AsString));
              bai.Open;

              if not bai.IsEmpty then
                vlBaicodigo := bai.Fieldbyname('baicodigo').AsString
              else
                vlBaicodigo := '0';

              consulta.Close;
              consulta.SQL.Text := 'update orc set baicodigo=' + vlBaicodigo + ' where baicodigo=0 and orcchave=' + orcsorcchave.AsString;
              consulta.ExecSQL;

              if orcsorcliberadoentrega.AsString <> '' then
              begin
                vlLiberado := orcsorcliberadoentrega.AsString;
              end
              else
              begin
                vlLiberado := agora(Application, Conexao);
              end;

              DecodeDateTime(strtodatetime(vlLiberado), myYear, myMonth, myDay, myHour, myMin, mySec, myMilli);
              vlLiberado := formatfloat('0000', myYear) + '-' + formatfloat('00', myMonth) + '-' + formatfloat('00', myDay) + ' ' +
                formatfloat('00', myHour) + ':' + formatfloat('00', myMin) + ':' + formatfloat('00', mySec);

              consulta.SQL.Text := 'update mes,mor set mes.clbcodigoent=' + clbentclbcodigo.AsString + ',   mes.moccodigo=' + orcsmoccodigo.AsString +
                ', mes.mesliberadoentrega=' + QuotedStr(vlLiberado) + ', mes.clbcodigoent=' + clbentclbcodigo.AsString +
                ' where mes.meschave=mor.meschave AND mor.orcchave=' + orcsorcchave.AsString;
              consulta.ExecSQL;

              consulta.SQL.Text := 'update imm set pdscodigo=4, immhoraentrega=' + chr(39) + vlAgora + chr(39) + ', clbcodigoent=' +
                clbentclbcodigo.AsString + ' where itochave in ' + '(select itochave from ito where orcchave=' + orcsorcchave.AsString + ')';
              consulta.ExecSQL;

              consulta.SQL.Text := 'update orc set pdscodigo=4, clbentregador=' + clbentclbcodigo.AsString + ', moccodigo=' + orcsmoccodigo.AsString +
                ',orchoraentrega=' + chr(39) + trim(copy(vlAgora, 11, 10)) + chr(39) + '     ,   orcdataentrega=' + chr(39) + copy(vlAgora, 1, 10) +
                chr(39) + '       where orcchave=' + orcsorcchave.AsString;
              consulta.ExecSQL;

              consulta.SQL.Text := 'update itm,mor set itm.clbentregador=' + clbentclbcodigo.AsString +
                ' where itm.meschave=mor.meschave AND mor.orcchave=' + orcsorcchave.AsString;
              consulta.ExecSQL;

              consulta.SQL.Text := 'update imm,ito set  imm.clbcodigoent=' + clbentclbcodigo.AsString +
                ' where imm.itochave=ito.itochave  and ito.orcchave=' + orcsorcchave.AsString;
              consulta.ExecSQL;



              if ((pos('levar',lowercase(orcsorcobs.asstring))>0) or
                 (pos('pix',lowercase(orcsorcobs.asstring))>0))
                 and (pos('troco',lowercase(orcsorcobs.asstring))=0) then
              begin

                adc.close;
                adc.Open;

                if adc.FieldByName('adcchaveintegracao').asstring<>'' then
                begin
                  qrypos.close;
                  qrypos.ParamByName('clbcodigo').AsString:=clbentclbcodigo.AsString;
                  qrypos.Open;

                  if not qrypos.IsEmpty then
                  begin


                    if qryposposnumeroserie.AsString<>'' then
                    begin

                      ftefwifi:=Tftefwifi.create(self);
                      ftefwifi.zcone:=conexao;
                      ftefwifi.vpCznChave:=vpCznChave.ToInteger;
                      ftefwifi.recebimentoDireto(vlorcschave,
                                                 vlorcsnumeropedido,
                                                 qryposposnumeroserie.AsString,
                                                 vlorcstotal,
                                                 vlorcsetdidentificacao);
                      ftefwifi.free;

                    end;
                  end;

                end;

              end;

              if (orcsoricodigo.asinteger=8) and
                 ((pos('online',lowercase(orcsorcobs.asstring))>0) or
                 (pos('on-line',lowercase(orcsorcobs.asstring))>0))
                 and (pos('troco',lowercase(orcsorcobs.asstring))=0) then
              begin



              end;
            end;
            orcs.next;
          end;
          orcs.EnableControls;
          mostra.Visible := false;
          mostra.Position := 0;

        end;

      end;
      { end; }
    end
    else
    begin
      Result := false;

    end;
  finally
    freeandnil(lentregadores);
    Timer1.Enabled := True;
    Timer2.Enabled := True;
    ActAtualizarLista.Execute;
  end;
end;

procedure TFprinciEntregas.ActLiberarEntregaExecute(Sender: TObject);
var
  vlOrcChave: string;
begin

  if Autorizado(ActLiberarEntrega as TAction, '') then
  begin

    // liberar entrega

    consulta.Close;
    consulta.SQL.Text :=
      'SELECT ito.orcchave FROM orc INNER JOIN ito ON orc.orcchave = ito.orcchave INNER JOIN imm ON ito.itochave = imm.itochave WHERE immnumepedido='
      + orcspdgnumero.AsString;
    consulta.Open;

    vlOrcChave := '';
    if not consulta.IsEmpty then
    begin
      vlOrcChave := consulta.Fieldbyname('orcchave').AsString;

      if vlOrcChave <> '' then
      begin

        consulta.Close;
        consulta.SQL.Text := 'update ito,imm set imm.pdscodigo=3  where imm.itochave=ito.itochave  and orcchave=' + orcsorcchave.AsString;
        consulta.ExecSQL;

        consulta.Close;
        consulta.SQL.Text := 'update orc set pdscodigo=3 where orcchave=' + vlOrcChave;
        consulta.ExecSQL;

        Self.ActAtualizarLista.Execute;
      end;
    end;

  end;
end;

procedure TFprinciEntregas.ActListaCaixasExecute(Sender: TObject);
var
  vCcxChave: string;
begin

  vCcxChave := MostraLista('mccx', '', '');
 {
  Application.CreateForm(tfcxm, fcxm);
  fcxm.Fzcone := Self.ccx.Connection;
  fcxm.vpccxchave := vCcxChave.ToInteger;
  fcxm.ShowModal;
 }
  if vCcxChave <> '' then
    ImprimirComprovantesCCX(Application, Conexao, strtoint(vCcxChave), ocxFechamento, trmtciporta.AsString, tiImprimir);

end;

procedure TFprinciEntregas.ImprimeComprovantesCaixa(vOperacaoCaixa: Integer);
begin
  ImprimirComprovantesCCX(Application, Conexao, ccxccxchave.AsInteger, vOperacaoCaixa, trmtciporta.AsString, tiImprimir);
end;

procedure TFprinciEntregas.ActRegistrarRetornosExecute(Sender: TObject);
begin
  edRetorno.setfocus;
end;

procedure TFprinciEntregas.ActReimprimeAberturaExecute(Sender: TObject);
begin
  if FileExists(Extractfilepath(Application.ExeName) + 'relat\AberturaCCX.fr3') then
    ImprimeComprovantesCaixa(ocxAbertura);
end;

procedure TFprinciEntregas.ActReimprimeFechamentoExecute(Sender: TObject);
begin
  if FileExists(Extractfilepath(Application.ExeName) + 'relat\FechamentoCCX.fr3') then
    ImprimeComprovantesCaixa(ocxFechamento);
end;

procedure TFprinciEntregas.ActReimprimePedidoExecute(Sender: TObject);
var
  vlNomeArq: string;
  BlobField: TBlobField;
  vDirRelat: string;
begin
  inherited;
  if frxDados.DataSet = orcssai then
  begin
    listaCellClick(lista.Columns[0]);
  end
  else
  begin
    listaOrcsCellClick(lista.Columns[0]);
  end;

  frxUniDACComponents1.DefaultDatabase := Conexao;

  vlNomeArq := Extractfilepath(Application.ExeName) + 'relat\comprovanteDelivery.fr3';

  { BlobField := consulta.Fields[0] as TBlobField;
    BlobField.SaveToFile(vlNomeArq); }

  if not FileExists(vlNomeArq) then
  begin
    Showmessage('Arquivo nao localizado: ' + vlNomeArq);
    exit;
  end;

  // relatorio.LoadFromFile(vlNomeArq);

  if vpOrcChave <> '' then
  begin
    consulta.Close;
    consulta.SQL.Text := 'select orcvias from orc where orcchave=' + vpOrcChave;
    consulta.Open;

    vDirRelat := Extractfilepath(Application.ExeName) + 'relat\ComprovanteDELIVERY.fr3';
    ImprimirComprovantesOrc(Application, Conexao, vpOrcChave, vDirRelat, trmtciporta.AsString, tiImprimir);

  end;
end;

procedure TFprinciEntregas.ActReimprimeSangriaExecute(Sender: TObject);
begin
  if FileExists(Extractfilepath(Application.ExeName) + 'relat\SangriaCCX.fr3') then
    ImprimeComprovantesCaixa(ocxSangria);
end;

procedure TFprinciEntregas.ActReimprimeSuprimentoExecute(Sender: TObject);
begin
  if FileExists(Extractfilepath(Application.ExeName) + 'relat\SuprimentoCCX.fr3') then
    ImprimeComprovantesCaixa(ocxSuprimento);
end;

procedure TFprinciEntregas.ActResumoEntregaExecute(Sender: TObject);
var
  vlNomeArq: string;
  BlobField: TBlobField;
begin

  if Autorizado(ActResumoEntrega, 'Resumo de Entregas') then
  begin

    FprinciEntregas.consulta.Close;
    FprinciEntregas.consulta.SQL.Text := 'select relarquivo from rel where relcodigo=' + chr(39) + FprinciEntregas.cfgcfgmgourelentreresumido.AsString
      + chr(39);
    FprinciEntregas.consulta.Open;

    vlNomeArq := Extractfilepath(Application.ExeName) + 'Relat\relatorioentsimples.fr3';

    BlobField := FprinciEntregas.consulta.Fields[0] as TBlobField;
    BlobField.SaveToFile(vlNomeArq);

    if not FileExists(vlNomeArq) then
    begin
      Showmessage('Arquivo nao localizado: ' + vlNomeArq);
      exit;
    end;

    FprinciEntregas.relatorio.LoadFromFile(vlNomeArq);

    FprinciEntregas.relatorio.Variables['cznchave'] := QuotedStr(FprinciEntregas.vpCznChave);
    FprinciEntregas.relatorio.Variables['clbcodigoent'] := QuotedStr(clbcaxclbcodigo.AsString);

    FprinciEntregas.relatorio.PrintOptions.ShowDialog := false;
    FprinciEntregas.relatorio.ShowProgress := false;
    FprinciEntregas.relatorio.ShowReport;

  end;
end;

procedure TFprinciEntregas.ActSairExecute(Sender: TObject);
begin
  ShuttingDown := True;

  Close;
end;

procedure TFprinciEntregas.ActSangriaExecute(Sender: TObject);

var
  vlValorOperacao: string;
begin

  vlValorOperacao := '0';

  vlValorOperacao := RegistraOperacaoCaixa(tocSangriaCaixa);

  if (vlValorOperacao <> '0') and (vlValorOperacao <> '') then
    if FileExists(Extractfilepath(Application.ExeName) + 'relat\SangriaCCX.fr3') then
      ImprimeComprovantesCaixa(ocxSangria);

end;

procedure TFprinciEntregas.ActSelecionarEntregadorExecute(Sender: TObject);
begin
  inherited;
  TimerRPW.enabled:=False;
  SituacaoEntregadores;

  Timer2.Enabled := false;
  SelecionarEntregador;
  Timer2.Enabled := True;
  TimerRPW.enabled:=True;

end;

procedure TFprinciEntregas.ActSuprimentoExecute(Sender: TObject);

var
  vlValorOperacao: string;
begin
  vlValorOperacao := '0';

  vlValorOperacao := RegistraOperacaoCaixa(tocSuprimentoCaixa);

  if (vlValorOperacao <> '0') and (vlValorOperacao <> '') then
    if FileExists(Extractfilepath(Application.ExeName) + 'relat\SuprimentoCCX.fr3') then
      ImprimeComprovantesCaixa(ocxSuprimento);

end;

procedure TFprinciEntregas.ActTrocarEntregadorExecute(Sender: TObject);
var
  vlClbCodigoEnt: Integer;

begin
  if Autorizado(ActTrocarEntregador, 'Trocar de entregador') then
  begin

    try
      SituacaoEntregadores;

      clbent.Close;
      clbent.ParamByName('cznchave').AsString := vpCznChave;
      clbent.Open;

      vlClbCodigoEnt := orcssaiclbcodigoent.AsInteger;

      { if not clbent.Locate('clbcodigo', vlClbCodigoEnt, []) then
        begin
        Showmessage('Este entregador ja teve seu caixa fechado.' + #13 + 'Não é Permitido a troca do entregador!');
        exit;
        end; }

      Application.CreateForm(tlentregadores, lentregadores);
      lentregadores.zCone:=conexao;
      lentregadores.Acesso:=Acesso;

      clbent.Close;
      clbent.ParamByName('cznchave').AsString := vpCznChave;

      clbent.Open;
      lentregadores.Dclb.DataSet := clbent;

      if lentregadores.ShowModal = mrOk then
      begin

        consulta.SQL.Text := 'update mes,mor set mes.clbcodigoent=' + clbentclbcodigo.AsString + ' where mes.meschave=mor.meschave  and mor.orcchave='
          + orcssaiorcchave.AsString;
        consulta.ExecSQL;

        consulta.SQL.Text := 'update orc set clbentregador=' + clbentclbcodigo.AsString + ' where orcchave=' + orcssaiorcchave.AsString;
        consulta.ExecSQL;

        consulta.SQL.Text := 'update itm,mor set itm.clbentregador=' + clbentclbcodigo.AsString + ' where itm.meschave=mor.meschave and mor.orcchave='
          + orcssaiorcchave.AsString;
        consulta.ExecSQL;

        consulta.SQL.Text := 'update imm,ito set  imm.clbcodigoent=' + clbentclbcodigo.AsString + ' where imm.itochave=ito.itochave and ito.orcchave='
          + orcssaiorcchave.AsString;
        consulta.ExecSQL;

      end
      else
      begin

      end;

    finally
      freeandnil(lentregadores);
      ActAtualizarLista.Execute;
    end;

  end;

end;

procedure TFprinciEntregas.ActTrocarPagamentoExecute(Sender: TObject);
var
  vModalResult: Integer;
  vlFormaPagto: string;
  vlObservacao: string;
  Vlchave: String;
  vletdcodigo: String;
  vlAcesso: TAcesso;
  vlValorFinalizador: currency;
  vlTeclaFinalizador: Integer;
  vlorcgeralav: currency;
  vlorcdescontoav: String;
  vlRetorno: string;

begin
  { criar }
  TimerRPW.enabled:=false;
  consulta.Close;
  consulta.SQL.Text := 'SELECT meschave FROM mor WHERE orcchave=' + orcssaiorcchave.AsString;
  consulta.Open;

  Vlchave := consulta.Fieldbyname('meschave').AsString;

  if Vlchave = '' then
  begin

    consulta.Close;
    consulta.SQL.Text := 'SELECT meschave FROM mes WHERE mesnumeropedido=' + orcssaiorcnumeropedido.AsString;
    consulta.Open;

    Vlchave := consulta.Fieldbyname('meschave').AsString;

    consulta.Close;
    consulta.SQL.Text := 'SELECT morchave, orcchave, meschave, flacodigo,   borchave,   morabertura,  morencerramento FROM mor where meschave=' +
      Vlchave + ' and orcchave=' + orcssaiorcchave.AsString;;
    consulta.Open;

    if consulta.IsEmpty then
    begin

      consulta.Append;
      consulta.Fieldbyname('meschave').AsString := Vlchave;
      consulta.Fieldbyname('orcchave').AsString := orcssaiorcchave.AsString;
      consulta.Fieldbyname('borchave').AsString := '0';
      consulta.Fieldbyname('flacodigo').AsInteger := 1;
      consulta.Post;

    end
    else
    begin
      consulta.Edit;
      consulta.Fieldbyname('meschave').AsString := Vlchave;
      consulta.Fieldbyname('orcchave').AsString := orcssaiorcchave.AsString;
      consulta.Fieldbyname('flacodigo').AsInteger := 1;
      consulta.Fieldbyname('borchave').AsString := '0';
      consulta.Post;

    end;

  end;

  vletdcodigo := orcssaietdcodigo.AsString;
  vlAcesso := Acesso;
  vlValorFinalizador := 0;
  vlTeclaFinalizador := 0;
  vlorcgeralav := orcssaiorctotal.AsCurrency + orcssaiorcdesconto.AsCurrency;
  vlorcdescontoav := orcssaiorcdesconto.AsString;

  vlRetorno := '';
  vlRetorno := Finaliza(Vlchave, vletdcodigo, vlAcesso, vlValorFinalizador, vlTeclaFinalizador, vlorcgeralav, vlorcdescontoav);

  consulta.Close;
  consulta.SQL.Text := 'SELECT tfvchave, tfvregistro,  clbcodigo,  orcchave, mdacodigoorigem, mdacodigodestino from tfv limit 0';
  consulta.Open;
  consulta.Append;

  consulta.Fieldbyname('tfvregistro').AsString := datetimetostr(now());
  consulta.Fieldbyname('clbcodigo').AsString := Acesso.Usuario.ToString;
  consulta.Fieldbyname('orcchave').AsString := Vlchave;
  consulta.Fieldbyname('mdacodigoorigem').AsString := '';
  consulta.Fieldbyname('mdacodigodestino').AsString := '';
  consulta.Post;

  consulta.Close;
  TimerRPW.enabled:=True;
end;

procedure TFprinciEntregas.ActWhatsAPPExecute(Sender: TObject);
begin
  CriaFormulario(tfwhatsapp, Acesso.Filial.ToString, '');
end;

Procedure TFprinciEntregas.Ajustabotoes(Situacao: Boolean);
Begin
  { declarodo virtual para implementacao no Vertial }
End;

procedure TFprinciEntregas.AjustaCaixa;
begin

  if cfg.Active then
  begin
    cfg.Close;
  end;

  cfg.Params[0].AsInteger := Acesso.Filial;
  cfg.Open;

  if vpCtaCodigo = '' then
  begin
    Showmessage('Verificar configurações do terminal, falta conta do terminal!');
    exit;
  end;

  ccx.Close;
  ccx.SQL.Text := 'SELECT   ccx.ccxchave,  ccx.clbcodigo,  ccx.ctacodigo,  ccx.ccxturno,  ccx.ccxdataber,';
  ccx.SQL.add(' ccx.ccxhoraaber,  ccx.ccxsaldoaber,  ccx.ccxdatafecha,  ccx.ccxhorafecha,  ccx.ccxsaldofecha, ');
  ccx.SQL.add(' ccx.ccxsangrias,  ccx.ccxsuprimentos FROM ccx where ccx.ctacodigo=' + vpCtaCodigo);
  ccx.SQL.add('  and ccxdatafecha is null');
  ccx.SQL.add(' ORDER BY ccx.ccxchave desc limit 1');
  ccx.Open;

  if (ccx.IsEmpty) then
  begin
    vpCaixaAberto := 0;
    ActAbreCaixa.Enabled := True;
    ActFechaCaixa.Enabled := false;
    ActSangria.Enabled := false;
    ActSuprimento.Enabled := false;
    ActImprimeCaixa.Enabled := false;

    ActReimprimeAbertura.Enabled := false;
    ActReimprimeSangria.Enabled := false;
    ActReimprimeSuprimento.Enabled := false;
    ActReimprimeFechamento.Enabled := false;

    plMensagemPrincipal.Caption := 'Caixa Fechado';
    plMensagemPrincipal.Visible := True;

    ActSelecionarEntregador.Enabled := false;
    ActAbrirCaixaEntregador.Enabled := false;
    ActFecharCaixaEntregador.Enabled := false;
    ActTrocarEntregador.Enabled := false;
    ActCancelaPedido.Enabled := false;
    ActTrocarPagamento.Enabled := False;
  end
  else
  begin
    vpCaixaAberto := 1;
    ActAbreCaixa.Enabled := false;
    ActFechaCaixa.Enabled := True;
    ActSangria.Enabled := True;
    ActSuprimento.Enabled := True;
    ActImprimeCaixa.Enabled := True;

    ActReimprimeAbertura.Enabled := True;
    ActReimprimeSangria.Enabled := True;
    ActReimprimeSuprimento.Enabled := True;
    ActReimprimeFechamento.Enabled := True;

    ActSelecionarEntregador.Enabled := True;
    ActAbrirCaixaEntregador.Enabled := True;
    ActFecharCaixaEntregador.Enabled := True;
    ActCancelaPedido.Enabled := True;

    plMensagemPrincipal.Caption := 'Controle ativo';
    plMensagemPrincipal.Visible := True;
    ActTrocarPagamento.Enabled := True;
  end;

  plccxchave.Caption := 'Caixa: ' + ccx.Fieldbyname('ccxchave').AsString;
end;

procedure TFprinciEntregas.FormCreate(Sender: TObject);
begin
  Screen.Cursors[crSQLWait] := Screen.Cursors[crDefault];

  Application.OnIdle := LigaTimer;
  Application.OnMessage := DesligaTimer;

  inherited;

  // cria um mutex usando um nome único
  CreateMutex(nil, false, 'mizioEntrega.OnlyOne');

  // verifica se houve erro na criação
  { if GetLastError = ERROR_ALREADY_EXISTS then
    begin
    MessageBox(0, 'Este programa já está sendo executado', 'Aviso', MB_ICONSTOP);
    Halt(0);

    end; }

  InicializacaoGeral;

  consulta.Close;
  consulta.SQL.Text := 'select cznchave from czn where cznfechamento IS null order by cznchave limit 1';
  consulta.Open;

  vpCznChave := consulta.Fieldbyname('cznchave').AsString;

  Ajustabotoes(false);

  trm.Close;
  trm.Params[0].AsString := Acesso.Terminal.ToString;
  trm.Open;

  If trm.RecordCount = 0 Then
  Begin
    Showmessage('Este terminal não esta cadastrado no sistema, verifique!');
    Application.Terminate;
  End
  Else
  Begin

    WindowState := WsMaximized;

    { if not Ajustausuario then
      Exit; }

    AjustaCaixa;

    lterminal.Caption := Self.Acesso.Terminal.ToString;

    Ajustabotoes(false);

  End;

end;

procedure TFprinciEntregas.FormErroShow(Sender: TObject);
begin
  ((Sender as TForm).FindComponent('plMensaErro') as TLabel).ParentFont := false;
  ((Sender as TForm).FindComponent('plMensaErro') as TLabel).Font.Color := clYellow;
  ((Sender as TForm).FindComponent('plMensaErro') as TLabel).Font.Size := 35;
  ((Sender as TForm).FindComponent('plMensaErro') as TLabel).Alignment := taCenter;
  ((Sender as TForm).FindComponent('plMensaErro') as TLabel).Tag := 1;
end;

procedure TFprinciEntregas.FormShow(Sender: TObject);
begin
  plversao.Caption := GetAppVersionStr(Application.ExeName);

  horario.Caption := agora(Application, Conexao);
  Screen.Cursors[crSQLWait] := Screen.Cursors[crDefault];

  AtualizaListas(True);

end;

Procedure TFprinciEntregas.Mostraerro(Texto: String);
var
  mensa: TLabel;
  topo: TPanel;

Begin

  try
    ferro := TForm.Create(Application);
    ferro.Name := 'ferro';
    ferro.Color := clRed;

    ferro.Font.Size := 25;
    ferro.Font.Color := clYellow;

    topo := TPanel.Create(ferro);
    ferro.Caption := 'Atenção:';
    topo.parent := ferro;
    topo.Name := 'plTopo';
    topo.ParentFont := false;
    topo.Caption := '';
    topo.BevelOuter := bvNone;
    topo.Height := 200;
    topo.Align := altop;
    topo.Color := clRed;

    mensa := TLabel.Create(ferro);
    mensa.parent := ferro;
    mensa.Name := 'plMensaErro';
    mensa.ParentFont := false;

    mensa.Align := alClient;

    mensa.Font.Size := 25;
    mensa.Font.Color := clYellow;
    mensa.Caption := Texto;
    mensa.Color := clRed;

    ferro.WindowState := WsMaximized;
    ferro.OnShow := FormErroShow;
    ferro.OnKeyPress := FerroKeyPress;
    // mensa.OnKeyPress := FerroKeyPress;

    ferro.ShowModal;

  finally
    freeandnil(ferro);
  end;

End;

function TFprinciEntregas.ValidaTerminal: Boolean;
begin
  trm.Close;
  trm.Params[0].AsInteger := Acesso.Terminal;
  trm.Open;

  vpCtaCodigo := cfgcfgmgouctadelivery.AsString;

  if not trm.IsEmpty then
    Result := True
  else
  begin
    Result := false;
    Application.MessageBox(PChar('Não foi possível abrir o sistema.' + #13 + 'Verifique o cadastro do terminal de número ' + Acesso.Terminal.ToString
      + '.'), 'Atenção', MB_ICONWARNING + MB_OK);
  end;
end;

procedure TFprinciEntregas.InicializacaoGeral;
Begin

  Timer1.Enabled := false;

  ConectaBanco;

  (* Realiza validações e identifica se abandona a aplicação *)
  try
    if not Conexao.Connected then
      raise Exception.Create('Falha de conexão.');

    if not LogarSistema then
      raise Exception.Create('Acesso inválido.');

    if cfg.Active then
    begin
      cfg.Close;
    end;

    cfg.Params[0].AsInteger := Acesso.Filial;
    cfg.Open;

    consulta.Close;
    consulta.SQL.Text := 'select count(clb.clbcodigo) producao from clb,fnc where clb.fnccodigo=fnc.fnccodigo and fncidentificacao=' +
      QuotedStr('PRODUÇÃO');
    consulta.Open;

    if not consulta.IsEmpty then
    begin
      if consulta.Fieldbyname('producao').AsInteger > 0 then
        DBGridLista.Visible := True
      else
        DBGridLista.Visible := false;
    end
    else
    begin
      DBGridLista.Visible := false;
    end;

    TimerProducao.Enabled := True;

    Timer2.Interval := cfgcfgmgoutempoatuproducao.AsInteger * 1000;
    Timer2.Enabled := True;

    Timer1.Enabled := True;

    if not ValidaTerminal then
      raise Exception.Create('Terminal inválido.');

  except
    on e: Exception do
    begin
      Showmessage(e.Message);
      Application.ShowMainForm := false;
      Application.Terminate;
      exit;
    end;
  end;

  (* Abre query com as configurações *)

  fla.Close;
  fla.Params[0].AsInteger := Acesso.Filial;
  fla.Open;

  Caption := 'Entregas - Mizio Sistemas (66) 3544-2765';

  lbNomeEmpresa.Caption := flaflasigla.AsString + ' - ' + trim(Self.cfgcfgidentificacao.AsString);
  lterminal.Caption := Acesso.Terminal.ToString;

  (* Atualiza os direitos de acesso e atribui a ação para Action *)
  CriaAcoesDeAcesso; // Somente habilitada quando for criada nova Action;

  AtribuiTagAcesso;

End;

procedure TFprinciEntregas.AtribuiTagAcesso;
var
  i: Integer;
begin
  act.Close;
  act.SQL.Clear;
  act.SQL.add('SELECT act.actcodigo, act.actacao');
  act.SQL.add('  FROM mdl');
  act.SQL.add(' INNER JOIN act ON mdl.mdlcodigo = act.mdlcodigo');
  act.SQL.add(' WHERE mdl.mdlnome = ''' + Self.Name + '''');
  act.Open;

  for i := 0 to Self.acoes.ActionCount - 1 do
    if act.Locate('actacao', Self.acoes[i].Name, []) then
      Self.acoes[i].Tag := Self.actactcodigo.AsInteger;
end;

procedure TFprinciEntregas.CriaAcoesDeAcesso;
var
  i: Integer;
  uqMdl: TUniQuery;
  uqAct: TUniQuery;
  vlMdlCodigo: Integer;
begin
  (*
    *
    * Atualização dos Módulos e Ações do Sistema
    *
  *)
  uqMdl := TUniQuery.Create(Application);
  uqAct := TUniQuery.Create(Application);
  try
    uqMdl.Connection := Conexao;
    uqMdl.SQL.Clear;
    uqMdl.SQL.add('SELECT mdl.mdlcodigo, mdl.mdlidentificacao, mdl.mdlnome, mdl.mdlsubgrupo');
    uqMdl.SQL.add('  FROM mdl');
    uqMdl.SQL.add(' WHERE mdl.mdlnome = :mdlnome');

    uqAct.Connection := Conexao;
    uqAct.SQL.Clear;
    uqAct.SQL.add('SELECT act.actcodigo, act.mdlcodigo, act.actidentificacao, act.actformulario, act.actacao, act.actativa');
    uqAct.SQL.add('  FROM act');
    uqAct.SQL.add(' INNER JOIN mdl ON act.mdlcodigo = mdl.mdlcodigo');
    uqAct.SQL.add(' WHERE mdl.mdlnome = :mdlnome');

    uqMdl.Params[0].AsString := Self.Name;
    uqMdl.Open;

    uqAct.Params[0].AsString := Self.Name;
    uqAct.Open;

    for i := 0 to Self.acoes.ActionCount - 1 do
      if (Self.acoes[i].Enabled) and (Self.acoes[i].Tag > -1) then
      begin

        if not uqMdl.Locate('mdlsubgrupo', Self.acoes[i].Category, []) then
        begin
          uqMdl.Append;
          uqMdl.Fieldbyname('mdlidentificacao').AsString := Application.Title;
          uqMdl.Fieldbyname('mdlsubgrupo').AsString := Self.acoes[i].Category;
          uqMdl.Fieldbyname('mdlnome').AsString := Self.Name;
          uqMdl.Post;

          vlMdlCodigo := uqMdl.Fields[0].AsInteger;

          uqMdl.Refresh;
          uqMdl.Locate('mdlcodigo', vlMdlCodigo, []);
        end
        else
          vlMdlCodigo := uqMdl.Fields[0].AsInteger;

        if uqAct.Locate('actacao', Self.acoes[i].Name, []) then
          uqAct.Edit
        else
          uqAct.Append;

        uqAct.Fieldbyname('mdlcodigo').AsInteger := vlMdlCodigo;
        uqAct.Fieldbyname('actidentificacao').AsString := '000 ' + Self.acoes[i].Caption;
        uqAct.Fieldbyname('actformulario').AsString := Self.Name;
        uqAct.Fieldbyname('actacao').AsString := Self.acoes[i].Name;
        uqAct.Fieldbyname('actativa').AsInteger := 1;

        uqAct.Post;
      end;

  finally
    uqMdl.Close;
    uqAct.Close;
    freeandnil(uqMdl);
    freeandnil(uqAct);
  end;
end;

function TFprinciEntregas.CriaFormulario(pFormClass: TFrmBaseClass; pChave, pChaveMestre: String; pFiltro: String = ''): Boolean;
var
  vlRecNo: Integer;
  vlCargaFrame: TCargaFrame;
  FormBase: TFrmBase;
begin
  FRegistroFrmBase := '';

  Result := false;

  vlCargaFrame := CargaFormu(Application, Conexao, Acesso, pFiltro, pChave, pChaveMestre);

  FormBase := pFormClass.Create(vlCargaFrame);

  try
    if FormBase.ShowModal = mrOk then
    begin
      FRegistroFrmBase := FormBase.Vchave;;
      Result := True;
    end;

  finally
    FormBase.Free;

  end;
end;

function TFprinciEntregas.ProcessaVendas(vOrcchave: string; vAFaturar: Boolean = false): string;
type
  TProcessaOrc = function(AOwner: TComponent; Conexao: TUniConnection; pChave: string; pAcesso: TAcesso; AFaturar: Boolean = false): string;

var
  Processa: TProcessaOrc;
  vlPackopm: Cardinal;
  vMesChave: String;
  vlOrcChave: string;
  vlPodeProcessar: Boolean;
begin

  vMesChave := '';
  vlOrcChave := vOrcchave;

  consulta.Close;
  consulta.SQL.Text := 'select stocodigo from orc where orcchave=' + vlOrcChave;
  consulta.Open;

  if consulta.Fieldbyname('stocodigo').AsInteger = 88 then
    vlPodeProcessar := false
  else
    vlPodeProcessar := True;

  if vlPodeProcessar then
  begin
    vlPackopm := LoadPackage('modulos\mopm.bpl');
    If vlPackopm <> 0 Then
      Try
        @Processa := GetProcAddress(vlPackopm, PChar('ProcessaOrc'));

        If Assigned(Processa) Then
        Begin
          vMesChave := '0';
          vMesChave := Processa(Application, Conexao, vlOrcChave, Acesso, vAFaturar);
        End;
      Finally
        // DoUnLoadPackage(Pack);
      End;

    If (vMesChave <> '0') and (vMesChave <> '') Then
    Begin

      consulta.Close;
      consulta.SQL.Text := 'update orc set stocodigo=' + IntToStr(stoVendido) + ' where stocodigo<>88  and orcchave=' + vlOrcChave;
      consulta.ExecSQL;

      AtualizaSituacaoItens(vlOrcChave, stoVendido, tdfMovimentoEmAndamento);

    End;

    Result := vMesChave;
  end;

end;

Function TFprinciEntregas.Finaliza(Vchave: String; vetdcodigo: String; vAcesso: TAcesso; vValorFinalizador: currency; vTeclaFinalizador: Integer;
  vorcgeralav: currency; vorcdescontoav: String): String;
type
  TRegistraLote = function(AOwner: TComponent; Conexao: TUniConnection; Vchave: string; vTrmCodigo: string; principal: string; multa: string;
    juros: string; desconto: string; Acesso: TAcesso; vmodo: string; vDia: TDate; vPodeConvenio: Boolean = True; vTeclaFinalizador: Integer = 0;
    vValorFinalizador: Double = 0; vPodeCartoes: Boolean = True; pCtaCaixa: Integer = 0; vPodeTrocaDoacao: Boolean = True;
    vControleEntrega: Boolean = false; vCcxChave: Integer = 0; vetdcodigo: Integer = 0; vComplemento:Boolean=false): string;

Var
  vlRegistra: TRegistraLote;

  Vpri: String;
  Vjur: String;
  vMulta: String;
  Vdes: String;
  vPodeConvenio: Boolean;

  vConfiguracoesTEF: TConfiguracoesTEF;

  vlPacklte: Cardinal;
  vlTotalBruto: Double;
  vlCcxChave: Integer;
  vldia: TDate;
  vltitcodigo: string;
  vlrfmchave: string;
  vlrfmchaveremover: string;
  vlrfichave: string;
  vlmfichave: string;
  vlmltchave: string;
  vlccochave: string;

Begin

  If not orcssai.Active Then
    exit;

  vlPacklte := LoadPackage('modulos\mlte.bpl');

  If vlPacklte <> 0 Then
    Try
      @vlRegistra := GetProcAddress(vlPacklte, PChar('registralotedatagourmet'));
      If Assigned(vlRegistra) Then
      Begin
        vlTotalBruto := vorcgeralav;
        Vpri := Floattostr(vlTotalBruto);
        Vdes := vorcdescontoav;

        // Vpri := buscatroca(Floattostr(vlTotalBruto), ',', '.');
        // Vdes := buscatroca(vorcdescontoav, ',', '.');
        Vjur := '0';
        vMulta := '0';

        if vetdcodigo = '0' then
          vPodeConvenio := false
        else
          vPodeConvenio := True;

        vpCtaCodigo := cfgcfgmgouctadelivery.AsString;

        consulta.Close;
        consulta.SQL.Text := 'SELECT ccx.ccxchave , ccx.ccxdataber , ccx.ccxhoraaber, clb.clbidentificacao FROM ccx ';
        consulta.SQL.add('INNER JOIN clb ON ccx.clbcodigo = clb.clbcodigo ');
        consulta.SQL.add('WHERE ccx.ctacodigo = ' + vpCtaCodigo + ' ');
        consulta.SQL.add(' AND ccx.ccxdatafecha IS NULL order by ccxchave desc limit 1');
        consulta.Open;
        vlCcxChave := consulta.Fieldbyname('ccxchave').AsInteger;

        vldia := strtodate(hoje(Application, Conexao));

        // buscar os registros anteriores nas tabelas, para depois deletar - Francielle 16/10/2020
        vltitcodigo := '';
        vlrfmchave := '';
        vlrfmchaveremover := '';
        vlrfichave := '';
        vlmfichave := '';
        vlmltchave := '';
        vlccochave := '';
        consulta.Close;
        consulta.SQL.Text := 'SELECT rfmchave FROM rfm ';
        consulta.SQL.add('INNER JOIN mor ON rfm.meschave = mor.meschave');
        consulta.SQL.add('WHERE mor.orcchave=' + orcssaiorcchave.AsString + ' ');
        consulta.SQL.add('ORDER BY rfmchave asc LIMIT 1');
        consulta.Open;

        vlrfmchaveremover := consulta.Fieldbyname('rfmchave').AsString;

        consulta.Close;
        consulta.SQL.Text := 'SELECT tit.titcodigo FROM tit ';
        consulta.SQL.add('INNER JOIN rfi ON tit.titcodigo = rfi.titcodigo');
        consulta.SQL.add('INNER JOIN rfm ON rfi.rfichave = rfm.rfichave');
        consulta.SQL.add('INNER JOIN mor ON rfm.meschave = mor.meschave');
        consulta.SQL.add('WHERE mor.orcchave=' + orcssaiorcchave.AsString + ' ');
        consulta.SQL.add('ORDER BY tit.titcodigo  asc LIMIT 1');
        consulta.Open;
        vltitcodigo := consulta.Fieldbyname('titcodigo').AsString;

        consulta.Close;
        consulta.SQL.Text := 'SELECT rfi.rfichave FROM rfi ';
        consulta.SQL.add('INNER JOIN rfm ON rfi.rfichave = rfm.rfichave');
        consulta.SQL.add('INNER JOIN mor ON rfm.meschave = mor.meschave');
        consulta.SQL.add('WHERE mor.orcchave=' + orcssaiorcchave.AsString + ' ');
        consulta.SQL.add('ORDER BY rfi.rfichave asc LIMIT 1 ');
        consulta.Open;
        vlrfichave := consulta.Fieldbyname('rfichave').AsString;

        consulta.Close;
        consulta.SQL.Text := 'SELECT cco.ccochave  FROM cco';
        consulta.SQL.add('INNER JOIN clt ON cco.ccochave = clt.ccochave');
        consulta.SQL.add('INNER JOIN lte ON clt.ltechave = lte.ltechave');
        consulta.SQL.add('INNER JOIN mlt ON lte.ltechave = mlt.ltechave');
        consulta.SQL.add('INNER JOIN mfi ON mlt.mfichave = mfi.mfichave');
        consulta.SQL.add('INNER JOIN rfi ON mfi.rfichave = rfi.rfichave');
        consulta.SQL.add('INNER JOIN rfm ON rfi.rfichave = rfm.rfichave');
        consulta.SQL.add('INNER JOIN mor ON rfm.meschave = mor.meschave');
        consulta.SQL.add('WHERE mor.orcchave=' + orcssaiorcchave.AsString + ' ');
        consulta.SQL.add('ORDER BY cco.ccochave  asc LIMIT 1 ');
        consulta.Open;
        vlccochave := consulta.Fieldbyname('ccochave').AsString;

        Result := vlRegistra(Application, Conexao, Vchave, vAcesso.Terminal.ToString, Vpri, vMulta, Vjur, Vdes, vAcesso, IntToStr(tfdVenda), vldia,
          vPodeConvenio, vTeclaFinalizador, vValorFinalizador, True, strtoint(vpCtaCodigo), false, True, vlCcxChave);

        // deleta os registros anteriores nas tabelas - Francielle 16/10/20

        if Result <> '' then
        begin
          {
            if vlrfmchaveremover <> '' then
            begin
            consulta.Close;
            consulta.SQL.Text := 'delete from rfm where rfmchave=' + vlrfmchaveremover;
            consulta.ExecSQL;

            end;

            if vlrfichave <> '' then
            begin
            consulta.Close;
            consulta.SQL.Text := 'delete FROM rfi where rfichave=' + vlrfichave;
            consulta.ExecSQL;
            end;

            if vltitcodigo <> '' then
            begin
            consulta.Close;
            consulta.SQL.Text := 'delete from tit where titcodigo=' + vltitcodigo;
            consulta.ExecSQL;
            end;

            if vlccochave <> '' then
            begin
            consulta.Close;
            consulta.SQL.Text := 'delete from cco where ccochave=' + vlccochave;
            consulta.ExecSQL;
            end;
          }
          Showmessage('Alteração finalizada com sucesso!');
        end;

      End;

    Finally

      // DoUnLoadPackage(Application, vlPacklte);
    End;

End;

function TFprinciEntregas.FechaVendas(vOrcchave: string): string;
var
  vlMeschave: string;

  vletdcodigo: String;
  vlValorFinalizador: currency;
  vlTeclaFinalizador: Integer;
  vlorcgeralav: currency;
  vlorcdescontoav: String;
  vlMorChave: String;
  vlAcesso: TAcesso;
  vlClbCodigoEnt: Integer;
  vlPodeProcessar: Boolean;
begin

  consulta.Close;
  consulta.SQL.Text :=
    'UPDATE orc o SET o.clbentregador=(SELECT clbcodigoent FROM imm,ito WHERE ito.itochave=imm.itochave and  ito.orcchave=o.orcchave group by ito.orcchave)';
  consulta.ExecSQL;

  consulta.Close;
  consulta.SQL.Text := 'select morchave,meschave from mor where orcchave=' + vOrcchave;
  consulta.Open;

  vlMorChave := '';
  vlMorChave := consulta.Fieldbyname('morchave').AsString;

  if vlMorChave = '' then
  begin

    consulta.Close;
    consulta.SQL.Text := 'select etdcodigo, orcgeralav, orcdescontoav, orctotalav, clbentregador, orcobs from orc where orcchave=' + vOrcchave;
    consulta.Open;

    if not consulta.IsEmpty then
    begin

      if pos(uppercase('Em Dinheiro'), uppercase(consulta.Fieldbyname('orcobs').AsString)) > 0 then
      begin
        vlTeclaFinalizador := 117; // F6
      end
      else if pos(uppercase('Levar máquina de Cartão - DÉBITO'), uppercase(consulta.Fieldbyname('orcobs').AsString)) > 0 then
      begin
        vlTeclaFinalizador := 115; // F4
      end
      else if pos(uppercase('Levar máquina de Cartão - CRÉDITO'), uppercase(consulta.Fieldbyname('orcobs').AsString)) > 0 then
      begin
        vlTeclaFinalizador := 114; // F3
      end
      else if pos(uppercase('Vai Assinar'), uppercase(consulta.Fieldbyname('orcobs').AsString)) > 0 then
      begin
        vlTeclaFinalizador := 120; // F9
      end
      else if pos(uppercase('A Faturar'), uppercase(consulta.Fieldbyname('orcobs').AsString)) > 0 then
      begin
        vlTeclaFinalizador := 121
      end;

      vletdcodigo := consulta.Fieldbyname('etdcodigo').AsString;
      vlValorFinalizador := consulta.Fieldbyname('orctotalav').AsCurrency;
      vlorcgeralav := consulta.Fieldbyname('orcgeralav').AsCurrency;
      vlorcdescontoav := consulta.Fieldbyname('orcdescontoav').AsString;
      vlClbCodigoEnt := consulta.Fieldbyname('clbentregador').AsInteger;

      consulta.Close;
      consulta.SQL.Text := 'update orc set stocodigo=' + IntToStr(stoVendido) + ' where stocodigo<>88 and orcchave=' + vOrcchave;
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'update ito set stocodigo=' + IntToStr(stoVendido) + ' where stocodigo<>88 and orcchave=' + vOrcchave +
        ' and stocodigo<>88';
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'update imm set cznchave=' + vpCznChave + ' where itochave in (select itochave from ito where stocodigo=' +
        IntToStr(stoVendido) + ' and orcchave=' + vOrcchave + ' and stocodigo<>88)';
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'select stocodigo from orc where orcchave=' + vOrcchave;
      consulta.Open;

      if consulta.Fieldbyname('stocodigo').AsInteger = 88 then
        vlPodeProcessar := false
      else
        vlPodeProcessar := True;

      consulta.Close;

      if vlPodeProcessar then
      begin


        if vlTeclaFinalizador = 121 then
          vlMeschave := ProcessaVendas(vOrcchave, True)
        else
          vlMeschave := ProcessaVendas(vOrcchave, false);



        vlAcesso.IdAcesso := Acesso.IdAcesso;
        vlAcesso.Filial := Acesso.Filial;
        vlAcesso.Terminal := Acesso.Filial;
        if orcsmoccodigo.AsInteger = 10 then
        begin
          vlAcesso.Usuario := Acesso.Usuario;
        end
        else
        begin
          vlAcesso.Usuario := vlClbCodigoEnt;
        end;

        adc.Close;
        adc.Open;

        if adcadcchaveintegracao.AsString='' then
        begin
          Result := Finaliza(vlMeschave, vletdcodigo, vlAcesso, vlValorFinalizador, vlTeclaFinalizador, vlorcgeralav, vlorcdescontoav);
        end;
      end;
    end;
  end
  else
  begin

  end;

end;




procedure TFprinciEntregas.GeraNFCe(aOrcChave:String);
var
  vlMesChave: string;
begin
  inherited;

  mor.Close;
  mor.ParamByName('orcchave').AsString := aorcchave;
  mor.Open;

  vlMesChave := mormeschave.AsString;

  ModuloNFCe('EmiteNFCe', Acesso.Terminal.ToString, vlMesChave, Acesso.Usuario.ToString);

end;


function TFprinciEntregas.ModuloNFCe(vfuncao: string; vTrmCodigo: string; vmeschave: string; vClbCodigo: string): Boolean;
type
  Tmodulonfce = function(AOwner: TComponent; Conexao: TUniConnection; vmeschave: string; vfuncao: string; Acesso: TAcesso; vImprimir: Boolean;
    vConsultouSefaz: Boolean; vemail: string): Boolean;

var
  ModuloNFCe: Tmodulonfce;
  vlRetorno: Boolean;
  vlPackNFCe: Cardinal;
  webOnLine:boolean;
begin
  Result := false;
  vlPackNFCe := 0;

  vlPackNFCe := LoadPackage('modulos\mnfepdv.bpl');

  if vlPackNFCe <> 0 then
    @ModuloNFCe := GetProcAddress(vlPackNFCe, PChar('modulonfcepdv'));

  if Assigned(ModuloNFCe) then
  begin
    webOnLine:=true;
    vlRetorno := ModuloNFCe(Application, conexao, vmeschave, vfuncao, Acesso, false, false, '');
    Result := vlRetorno;
  end;

End;



end.
