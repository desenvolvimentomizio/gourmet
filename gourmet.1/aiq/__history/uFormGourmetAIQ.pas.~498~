unit uFormGourmetAIQ;

interface

uses
  Winapi.Windows,
  Winapi.Messages,
  dateutils,

  System.Variants,
  System.Classes,

  Winapi.ShellAPI,
  Inifiles,

  Vcl.Graphics,
  Vcl.Controls,
  Vcl.Forms,
  Vcl.StdCtrls,
  Vcl.Dialogs,
  Vcl.ExtCtrls,
  Vcl.Grids,
  Vcl.DBGrids,
  Vcl.ComCtrls,

  Data.DB,
  FireDAC.Stan.Intf,
  FireDAC.Stan.Option,
  FireDAC.Stan.Param,
  FireDAC.Stan.Error,
  FireDAC.DatS,
  FireDAC.Phys.Intf,
  FireDAC.DApt.Intf,
  FireDAC.Comp.DataSet,
  FireDAC.Comp.Client,

  GourmetAIQ.Service.Funcoes,
  GourmetAIQ.Service.Constants,

  GourmetAIQ.Controller.AIQSRV,
  GourmetAIQ.Controller.cfgaiq,
  GourmetAIQ.Controller.czn,
  GourmetAIQ.Controller.ccx,

  GourmetAIQ.Controller.PedidoAIQ,
  GourmetAIQ.Model.Entity.PedidoAIQGourmet,
  GourmetAIQ.Model.Entity.AIQ,
  GourmetAIQ.Controller.AIQ,
  GourmetAIQ.Controller.PedidoAIQGourmet,
  GourmetServer.Model.Entity.AIQ.AIQCFG, IdBaseComponent, IdAntiFreezeBase,
  IdAntiFreeze, Vcl.WinXCtrls, DASQLMonitor, UniSQLMonitor;



// ok GET token - autenticar
// OK carregar lista de lojas
// OK abrir loja
// OK suspendar loja
// OK fechar loja

// consultar categorias
// bloquear item
// listar itens

// listar pedidos - nao lidos
// listar pedidos - busca
// listar pedidos - cancelados

// consultar pedido
// aceitar pedido - ler
// atualizar status pedido - pronto ou saiu

type
  TFormGourmetAIQ = class(TForm)
    TmRelogio: TTimer;
    logs: TMemo;
    Categorias: TFDMemTable;
    CategoriasCodigo: TStringField;
    CategoriasNome: TStringField;
    CategoriasDescricao: TStringField;
    CategoriasTempoProducao: TStringField;
    CategoriasSituacao: TStringField;
    Produtos: TFDMemTable;
    Produtoscodigo: TStringField;
    Produtosnome: TStringField;
    Produtoscategoria: TStringField;
    Pedidos: TFDMemTable;
    Pedidospedido: TStringField;
    Pedidosregistro: TStringField;
    Pedidospronto: TIntegerField;
    Pedidoslido: TIntegerField;
    Pedidoscancelado: TIntegerField;
    Pedidosnome: TStringField;
    Pedidostempoentrega: TStringField;
    Pedidosretira: TIntegerField;
    Pedidostexto: TBlobField;
    TMInicializarAplicativo: TTimer;
    Panel5: TPanel;
    Ingredientes: TFDMemTable;
    Ingredientesproduto_codigo: TStringField;
    Ingredientesnome: TStringField;
    Sabores: TFDMemTable;
    Saboresproduto_codigo: TStringField;
    Saboresnome: TStringField;
    Saboressku: TStringField;
    Saborescategoria: TStringField;
    Bordas: TFDMemTable;
    Tamanhos: TFDMemTable;
    Produtosdescription: TStringField;
    IdAntiFreeze1: TIdAntiFreeze;
    PedidosProcessados: TFDMemTable;
    DSPedidosProcessados: TDataSource;
    PedidosProcessadospedido: TStringField;
    PedidosProcessadosregistro: TStringField;
    PedidosProcessadoslido: TIntegerField;
    PedidosProcessadospronto: TIntegerField;
    PedidosProcessadosretira: TIntegerField;
    PedidosProcessadoscancelado: TIntegerField;
    PedidosProcessadosnome: TStringField;
    PedidosProcessadosentregaaiq: TIntegerField;
    plProcessados: TPanel;
    DBGridProcessados: TDBGrid;
    pltituloProcessados: TPanel;
    Panel2: TPanel;
    Panel6: TPanel;
    Edit2: TEdit;
    Button1: TButton;
    btConsultaPedidoGourmet: TButton;
    btImportarCardapio: TButton;
    plquantidade: TPanel;
    PedidosProcessadoschave: TIntegerField;
    PedidosProcessadosnumero: TStringField;
    PedidosProcessadosorcamento: TIntegerField;
    DSpedidos: TDataSource;
    DBGridRegistrados: TDBGrid;
    Pedidoscozinha: TIntegerField;
    PedidosRegistrados: TFDMemTable;
    DSPedidosRegistrados: TDataSource;
    PedidosRegistradosaiqchave: TIntegerField;
    PedidosRegistradosaiqpedido: TIntegerField;
    PedidosRegistradosaiqstatus: TIntegerField;
    PnTopoRegistraddos: TPanel;
    plquantidaderegistrados: TPanel;
    pnContador: TPanel;
    PedidosRegistradosaiqregistro: TStringField;
    CBReprocessarAutomatico: TCheckBox;
    pnRelogio: TPanel;
    plSituacao: TPanel;
    PedidosRegistradosaiqsaidaok: TIntegerField;
    PnRegistrador: TPanel;
    PedidosProcessadossaida: TStringField;
    mmListaPedidos: TMemo;
    butt: TButton;
    PedidosProcessadosnotificousaida: TIntegerField;
    mostra: TProgressBar;
    DBGrid1: TDBGrid;
    Dscategorias: TDataSource;
    Button2: TButton;
    Pedidosentrega: TFloatField;
    Pedidosvalor: TFloatField;
    Panel1: TPanel;
    cbLeitura: TCheckBox;
    plCaixa: TPanel;
    cbSaidaEntrega: TCheckBox;
    plTurno: TPanel;
    plhorariosentrega: TPanel;
    cbEntregaNoAlmoco: TCheckBox;
    cbRetiraNoAlomoco: TCheckBox;
    cbEntregaNaJanta: TCheckBox;
    cbRetiraNaJanta: TCheckBox;
    Panel3: TPanel;
    procedure TmRelogioTimer(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure DBGridAProcessarMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure TMInicializarAplicativoTimer(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure btConsultaPedidoGourmetClick(Sender: TObject);
    procedure DBGridRegistradosDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure DBGridRegistradosMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure PedidosRegistradosAfterInsert(DataSet: TDataSet);
    procedure buttClick(Sender: TObject);
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);
  private

    procedure CarregaDados(vAIQCFG: TAIQCFG);
    procedure GravaDados;
    function VerificaSituacaoLoja: string;
    procedure GerarToken(vAIQCFG: TAIQCFG);
    function VerificaToken: Boolean;

    procedure ConsultaServidorAIQ;
    procedure BaixarPedidosPortalAIQ(vAIQCFG: TAIQCFG);
    procedure EnviaPedidoAIQGourmet;
    procedure BaixaPedidosdoAIQ;

    procedure CarregaPedido(vAIQ: TAIQ);
    procedure GeraCaradapio;
    function ConsultaPedidoGourmet(vPedido: String): Integer;
    procedure MarcaPedidoSelecionadoPronto;
    procedure CarregaTabeladeProcessados;
    procedure BaixarPedidosRegistradosGourmet;
    procedure ReprocessarPedido(vPedido: string);
    procedure SalvaPosicaoatualTela;
    procedure CarregaeAjustaPosicaoTela;
    procedure ExecucaoUnica;
    procedure ReinializaAplicativo;
    procedure Processapedidos;

    { Private declarations }
  public
    { Public declarations }

    vpEntregaMeioDia: String;
    vpRetiraMeioDia: String;

    vpRetiraNoite: String;
    vpEntregaNoite: String;

    vpTopo: String;
    vpEsquerda: String;
    vpLargura: String;
    vpAltura: String;
    vpLeituraAutomatica: String;
    vpLiberacaoAutomatica: String;

    vpCznChave: Integer;
    vpCznChaveAtual: Integer;
    vpCcxChave: Integer;
    // vpcontador: Integer;
    vpAIQCFG: TAIQCFG;
    vpAiq: TAIQ;
    vpContaTempo: Integer;

  end;

var
  FormGourmetAIQ: TFormGourmetAIQ;

implementation

uses
  System.JSON, System.SysUtils;

{$R *.dfm}

function Retornaturno: String;
var
  vlAgora: TDateTime;
begin

  vlAgora := now();

  if (vlAgora >= strtodatetime(datetostr(now()) + ' 08:00:00')) and (vlAgora <= strtodatetime(datetostr(now()) + ' 16:00:00')) then
  begin
    Result := 'MEIODIA';
  end
  else if (vlAgora >= strtodatetime(datetostr(now()) + ' 16:00:01')) and (vlAgora <= strtodatetime(datetostr(incday(now(), 1)) + ' 07:59:59')) then
  begin
    Result := 'NOITE';
  end;

  FormGourmetAIQ.plTurno.caption := Result;

end;

procedure TrimAppMemorySize;
var
  MainHandle: thandle;
begin
  try
    MainHandle := OpenProcess(PROCESS_ALL_ACCESS, False, GetCurrentProcessID);
    SetProcessWorkingSetSize(MainHandle, $FFFFFFFF, $FFFFFFFF);
    CloseHandle(MainHandle);

  except
  end;
  Application.ProcessMessages;
end;

function TFormGourmetAIQ.VerificaToken: Boolean;
var
  vlDiaToken: string;
  vlDiaHoje: string;
begin
  // verifico se tenho um token
  Result := False;
  if vpAIQCFG <> NIL then
  begin
    if vpAIQCFG.cfgmgoutokenaiq <> '' then
    begin
      // verificao se ainda esta valido ou se a validade esta em branco

      // ajusta data para formato delphi se estiver no format sql
      if pos('-', datetimetostr(vpAIQCFG.cfgmgouValidadeAIQ)) > 0 then
        vpAIQCFG.cfgmgouValidadeAIQ := vpAIQCFG.cfgmgouValidadeAIQ;

      if (datetostr(vpAIQCFG.cfgmgouValidadeAIQ) <> '// ') and (trim(datetostr(vpAIQCFG.cfgmgouValidadeAIQ)) <> '') then
      begin
        // se a validade for inferior ao agora, limpa o token para carregar um novo
        if vpAIQCFG.cfgmgouValidadeAIQ < now then
        begin
          vpAIQCFG.cfgmgoutokenaiq := '';
        end;
      end
      else
      begin
        // limpa token se a validade esta em branco
        vpAIQCFG.cfgmgoutokenaiq := '';
      end;
    end;
    // se estiver sem token, gera um novo e grava no banco de dados

    if pos('/', datetimetostr(vpAIQCFG.cfgmgouValidadeAIQ)) > 0 then
    begin
      vlDiaToken := datetostr(vpAIQCFG.cfgmgouValidadeAIQ);

      vlDiaHoje := datetostr(IncHour(now(), 1));

      if vlDiaToken <> vlDiaHoje then
      begin
        vpAIQCFG.cfgmgoutokenaiq := '';
      end;

    end;

    if (vpAIQCFG.cfgmgoutokenaiq = '') then
    begin
      GerarToken(vpAIQCFG);
      try
        GravaDados;
      except

      end;
    end;

    Result := True;

  end;
end;

procedure TFormGourmetAIQ.GeraCaradapio;
var
  vlNomeCategoria: String;
  vlCardapio: TstringList;
begin
  vlCardapio := TstringList.Create;

  vlCardapio.Add('{"data":{"Grupos":[');

  Categorias.First;

  vlNomeCategoria := '';

  while not Categorias.Eof do
  begin

    vlCardapio.Add('{"NomeGrupo":"' + CategoriasNome.AsString + '","Produtos":[');
    vlNomeCategoria := CategoriasNome.AsString;

    Produtos.First;
    while not Produtos.Eof do
    begin

      vlCardapio.Add('{"Produto":"' + Produtosnome.AsString + '",');
      if Produtosdescription.AsString <> '' then
      begin
        vlCardapio.Add('"Sabor":"' + Produtosnome.AsString + '",');
        vlCardapio.Add('"Ingredientes":"' + Produtosdescription.AsString + '",');
      end;
      vlCardapio.Add('"Unidade1":"UNIDADE",');
      vlCardapio.Add('"Preco1":"0,00"');
      vlCardapio.Add('},');

      Produtos.Next;
    end;

    Categorias.Next;

    if Categorias.Eof then
    begin

      break;
    end
    else
    begin
      vlCardapio.text := copy(vlCardapio.text, 1, length(vlCardapio.text) - 1);
      vlCardapio.Add(']},');
      vlNomeCategoria := CategoriasNome.AsString;

    end;
  end;

  vlCardapio.text := copy(vlCardapio.text, 1, length(vlCardapio.text) - 1);

  vlCardapio.Add(']		}]	}}');

  vlCardapio.text := StringReplace(vlCardapio.text, #$D#$A, '', [rfReplaceAll, rfIgnoreCase]);
  vlCardapio.text := StringReplace(vlCardapio.text, #9, '', [rfReplaceAll, rfIgnoreCase]);
  vlCardapio.SaveToFile('c:\gourmet\cardapio.txt');

end;

procedure TFormGourmetAIQ.PedidosRegistradosAfterInsert(DataSet: TDataSet);
begin
  PedidosRegistradosaiqsaidaok.AsInteger := 0;
end;


procedure TFormGourmetAIQ.TMInicializarAplicativoTimer(Sender: TObject);
begin
  TMInicializarAplicativo.Enabled := False;
  ReinializaAplicativo;
end;

function TFormGourmetAIQ.VerificaSituacaoLoja: string;
begin

  if VerificaToken then
  begin

    CarregaIDLojaAIQ(vpAIQCFG);

    logs.Lines.Add(datetimetostr(now()) + ' 437 Verifica Status Loja: ' + vpAIQCFG.cfgmgousituacaolojaaiq);

    GravaDados;

    if vpAIQCFG.cfgmgousituacaolojaaiq = 'OPEN' then
    begin
      plSituacao.caption := 'Loja Aberta';
      plSituacao.Font.Color := clGreen;
      plSituacao.Color := $002D2D2D;
      pltituloProcessados.Color := plSituacao.Color;
      Panel2.Font.Color := clWhite;
      plSituacao.Visible := True;
    end
    else if vpAIQCFG.cfgmgousituacaolojaaiq = 'CLOSED' then
    begin
      plSituacao.caption := 'Loja Fechada';
      plSituacao.Font.Color := clred;
      plSituacao.Color := clYellow;
      pltituloProcessados.Color := plSituacao.Color;
      Panel2.Font.Color := clred;
      plSituacao.Visible := True;
    end
    else
    begin
      plSituacao.caption := 'Verificar';
      plSituacao.Visible := True;
    end;

    Application.ProcessMessages;

    Result := vpAIQCFG.cfgmgousituacaolojaaiq;

  end
  else
  begin
    Result := 'OFF LINE';
    plSituacao.caption := 'Sem Conexão com GourmetServer';
    plSituacao.Font.Color := clred;
    if (plSituacao.parent is TPanel) then
    begin
      (plSituacao.parent as TPanel).Color := clYellow;
    end;
    plSituacao.Visible := True;

  end;
end;

procedure TFormGourmetAIQ.GerarToken(vAIQCFG: TAIQCFG);
var
  vlValidade: string;
begin
  vpAIQCFG := GerarTokenAIQ(vAIQCFG);
  vlValidade := datetimetostr(vpAIQCFG.cfgmgouValidadeAIQ);

  logs.Lines.Add(datetimetostr(now()) + ' Gerar token Validade: ' + vlValidade);
end;

procedure TFormGourmetAIQ.GravaDados;
var
  vlStatus: Integer;
begin

  vlStatus := GravaDadosAIQCFG(vpAIQCFG);
  // vpcontador := vpcontador + 1;
  // logs.Lines.Add(datetimetostr(now()) + ' Gravar dados: ' + IntToStr(vlStatus) + ' ' + vpcontador.ToString);

end;

procedure TFormGourmetAIQ.EnviaPedidoAIQGourmet;
var
  vPedidoGourmet: TPedidoAIQGourmet;
  vlStatus: Integer;

  vlProcessar: Boolean;
  vlEntrega: Boolean;
  vlRetira: Boolean;

  vlJsonValue: tJsonValue;
  vlJsonObject: TJsonObject;

begin
  vlProcessar := False;
  vlEntrega := False;
  vlRetira := False;

  vlJsonObject := TJsonObject.Create;

  vlJsonValue := TJsonObject.ParseJSONValue(Pedidostexto.AsString);
  vlJsonObject := vlJsonValue.GetValue<TJsonObject>;

  if vlJsonObject.GetValue('is_pickup', '') = 'true' then
  begin
    vlEntrega := False;
    vlRetira := True;
  end
  else
  begin
    vlEntrega := True;
    vlRetira := False;
  end;

  if (Retornaturno = 'MEIODIA') then
  begin
    if (vlRetira = True) and (uppercase(vpRetiraMeioDia) = 'TRUE') then
    begin
      vlProcessar := True;
    end;
    if (vlEntrega = True) and (uppercase(vpEntregaMeioDia) = 'TRUE') then
    begin
      vlProcessar := True;
    end;
  end
  else if (Retornaturno = 'NOITE') then
  begin
    if (vlRetira = True) and (uppercase(vpEntregaMeioDia) = 'TRUE') then
    begin
      vlProcessar := True;
    end;
    if (vlEntrega = True) and (uppercase(vpEntregaNoite) = 'TRUE') then
    begin
      vlProcessar := True;
    end;
  end;

  if vlProcessar then
  begin

    try
      vPedidoGourmet := TPedidoAIQGourmet.Create;
      vPedidoGourmet.aiqpedido := Pedidospedido.AsString;
      vPedidoGourmet.aiqstatus := '0';
      vPedidoGourmet.aiqjson := Pedidostexto.AsString;
      vPedidoGourmet.cznchave := vpCznChave;

      if Pedidosvalor.AsString = '' then
        vPedidoGourmet.aiqvalor := '0'
      else
        vPedidoGourmet.aiqvalor := Pedidosvalor.AsString;

      if Pedidosentrega.AsString = '' then
        vPedidoGourmet.aiqentrega := '0'
      else
        vPedidoGourmet.aiqentrega := Pedidosentrega.AsString;

      vPedidoGourmet.aiqregistro := datetimetostr(now());

      logs.Lines.Add(datetimetostr(now()) + ' 586 Vai Gravar Pedido: ' + IntToStr(vlStatus) + ' ' + Pedidospedido.AsString);
      vlStatus := GravaPedidoGourmet(vPedidoGourmet);
      logs.Lines.Add(datetimetostr(now()) + ' 588 Gravou Pedido: ' + IntToStr(vlStatus) + ' ' + Pedidospedido.AsString);

    finally
      vPedidoGourmet.Free;
    end;

  end;

end;

procedure TFormGourmetAIQ.CarregaPedido(vAIQ: TAIQ);
begin
  try
    CarregaDadosAIQ(vAIQ);
  finally
  end;
end;

procedure TFormGourmetAIQ.BaixarPedidosPortalAIQ(vAIQCFG: TAIQCFG);
var
  vlSituacaoLoja: string;
begin

  if (vpCznChave <> 0) and (vpCcxChave <> 0) then
  begin

    Pedidos.Open;

    // try
    vlSituacaoLoja := '';
    vlSituacaoLoja := VerificaSituacaoLoja;

    if (vlSituacaoLoja = 'OPEN') then
    begin

      logs.Lines.Add(datetimetostr(now()) + ' 605 Consulta de pedidos nor portal ');
      CarregaPedidosAIQ(Pedidos, vpAIQCFG.cfgmgoutokenaiq, Developer_ID);
      logs.Lines.Add(datetimetostr(now()) + ' 607 Consultoue pedidos no portal ');

    end
    else
    begin
      logs.Lines.Add(datetimetostr(now()) + ' Loja fechada no APP ');
    end;

    //if (vlSituacaoLoja = 'OPEN') then
   //  begin



      logs.Lines.Add(datetimetostr(now()) + ' 643 processar  ');

      logs.Lines.Add(datetimetostr(now()) + ' 619 Pedidos agora na tabela pedidos: '+Pedidos.RecordCount.ToString);

      application.ProcessMessages;
      Pedidos.First;


      while not Pedidos.Eof do
      begin

        if Pedidostexto.AsString='' then
        begin

        logs.Lines.Add(datetimetostr(now()) + ' 624 carrega pedidos  ');

        CarregaPedidoAIQ(Pedidos, vpAIQCFG.cfgmgoutokenaiq, Pedidospedido.AsString);

        logs.Lines.Add(datetimetostr(now()) + ' 628 pedidos carregado ');
        Application.ProcessMessages;
        end
        else
          logs.Lines.Add(datetimetostr(now()) + ' 639 pedido ja carregado ');

        Pedidos.Next;
      end;


      logs.Lines.Add(datetimetostr(now()) + ' 619 Pedidos agora na tabela pedidos: '+Pedidos.RecordCount.ToString);

      application.ProcessMessages;

      Pedidos.First;
      while not Pedidos.Eof do
      begin

        logs.Lines.Add(datetimetostr(now()) + ' 649 carrega pedidos  ');

        Application.ProcessMessages;

        if Pedidos.FieldByName('lido').AsInteger = 0 then
        begin
          Pedidos.edit;
          Pedidos.FieldByName('lido').AsInteger := 1;
          Pedidos.FieldByName('cozinha').AsInteger := vpCznChave;
          Pedidos.FieldByName('registro').AsString := datetimetostr(now());
          Pedidos.Post;
          logs.Lines.Add(datetimetostr(now()) + ' Envia pedidos para GOurmet');
          EnviaPedidoAIQGourmet;
        end;

        Pedidos.Next;
      end;


   { end
    else
    begin
      logs.Lines.Add(datetimetostr(now()) + ' Loja fechada no APP');
    end;}

  end
  else
  begin
    pnRelogio.caption := 'Sem Cozinha';
  end;
end;

Procedure TFormGourmetAIQ.BaixarPedidosRegistradosGourmet;
var
  i: Integer;
  vlPedidoAIQ: TPedidoAIQGourmet;

  vlListaPedidos: Tlist;

  vlaiqchave: Integer;
  vlaiqpedido: String;
  vlaiqstatus: String;

begin
  try

    PedidosRegistrados.close;
    PedidosRegistrados.Open;

    logs.Lines.Add(datetimetostr(now()) + ' 700 Baixa pededidos registrador no Gourmet: ');

    vlListaPedidos := Tlist.Create;
    vlListaPedidos := CarregaPedidosRegistradosGourmet(vpCznChave);

    if vlListaPedidos <> nil then
    begin
      vlPedidoAIQ := TPedidoAIQGourmet.Create;

      for i := 0 to vlListaPedidos.Count - 1 do
      begin
        vlPedidoAIQ := TPedidoAIQGourmet(vlListaPedidos[i]);

        PedidosRegistrados.Append;
        PedidosRegistradosaiqchave.AsInteger := vlPedidoAIQ.aiqchave;
        PedidosRegistradosaiqpedido.AsString := vlPedidoAIQ.aiqpedido;
        PedidosRegistradosaiqstatus.AsString := vlPedidoAIQ.aiqstatus;
        PedidosRegistradosaiqregistro.AsString := datahorasqltotext(vlPedidoAIQ.aiqregistro);
        PedidosRegistrados.Post;

      end;

    end;
    PedidosRegistrados.First;

  finally
    vlListaPedidos.DisposeOf;

    plquantidaderegistrados.caption := PedidosRegistrados.RecordCount.ToString;
    Application.ProcessMessages;

  end;

end;

Procedure TFormGourmetAIQ.CarregaTabeladeProcessados;
var
  i: Integer;
  vlPedidoAIQ: TPedidoAIQGourmet;
  vlListaPedidos: Tlist;
  vlaiqchave: Integer;
  vlaiqpedido: String;
  vlaiqstatus: String;
begin

  try

    PedidosProcessados.close;
    PedidosProcessados.Open;
    PedidosProcessados.IndexFieldNames := 'registro';

    logs.Lines.Add(datetimetostr(now()) + ' 750 Consulta Pedidos no Gourmet: ');

    vlListaPedidos := Tlist.Create;
    vlListaPedidos := CarregaPedidosGourmet(vpCznChave);

    logs.Lines.Add('754: vai carregar processados');

    if vlListaPedidos <> nil then
    begin
      vlPedidoAIQ := TPedidoAIQGourmet.Create;

      logs.Lines.Add('761: Quantidade de pedidos: ' + vlListaPedidos.Count.ToString);

      for i := 0 to vlListaPedidos.Count - 1 do
      begin

        vlPedidoAIQ := TPedidoAIQGourmet(vlListaPedidos[i]);
        PedidosProcessados.Append;
        PedidosProcessadoschave.AsInteger := vlPedidoAIQ.aiqchave;
        PedidosProcessadospedido.AsString := vlPedidoAIQ.aiqpedido;
        PedidosProcessadoslido.AsString := vlPedidoAIQ.aiqstatus;

        PedidosProcessadosregistro.AsString := copy(datahorasqltotext(vlPedidoAIQ.immhoraimpresso), 12, 5);
        PedidosProcessadosnome.AsString := vlPedidoAIQ.etdidentificacao;
        PedidosProcessadosnumero.AsString := vlPedidoAIQ.immnumepedido;
        PedidosProcessadosorcamento.AsInteger := vlPedidoAIQ.orcchave;
        if vlPedidoAIQ.aiqsaida <> '' then
        begin
          PedidosProcessadossaida.AsString := copy(vlPedidoAIQ.aiqsaida, 1, 5);
        end;
        PedidosProcessados.Post;
      end;

    end
    else
    begin
      logs.Lines.Add('786: sem pedidos processados');
    end;

  finally
    PedidosProcessados.First;

    vlListaPedidos.DisposeOf;
    plquantidade.caption := DSPedidosProcessados.DataSet.RecordCount.ToString;
    Application.ProcessMessages;

  end;

end;

function TFormGourmetAIQ.ConsultaPedidoGourmet(vPedido: String): Integer;
begin
  logs.Lines.Add(datetimetostr(now()) + ' ConsultaPedido: ' + vPedido);
  Result := 0;
  Result := ConsultaPedidoAIQGourmet(vPedido);
end;

procedure TFormGourmetAIQ.MarcaPedidoSelecionadoPronto;
begin
  Pedidos.edit;
  Pedidospronto.AsInteger := 1;
  Pedidos.Post;
end;

procedure TFormGourmetAIQ.ReprocessarPedido(vPedido: string);
var
  vAIQ: TAIQ;
  vPedidoAIQGourmet: TPedidoAIQGourmet;
  vlRemocaoOrcamento: Integer;
begin

  try

    TmRelogio.Enabled := False;

    vAIQ := TAIQ.Create;
    vAIQ.aiqchave := 0;
    vAIQ.aiqpedido := Strtoint(vPedido);

    logs.Lines.Add(datetimetostr(now()) + ' 852 var carregado pedido');
    CarregaPedido(vAIQ);
    logs.Lines.Add(datetimetostr(now()) + ' 854 Pedido carregado');
    Application.ProcessMessages;


    vPedidoAIQGourmet := TPedidoAIQGourmet.Create;
    vPedidoAIQGourmet.aiqchave := vAIQ.aiqchave;
    vPedidoAIQGourmet.aiqpedido := vAIQ.aiqpedido.ToString;
    vPedidoAIQGourmet.aiqstatus := '0';
    vPedidoAIQGourmet.aiqjson := vAIQ.aiqjson;
    vPedidoAIQGourmet.cznchave := vpCznChave;
    logs.Lines.Add(datetimetostr(now()) + ' 866 Pedido:' + vPedidoAIQGourmet.aiqjson);

    if vPedidoAIQGourmet.aiqjson <> '' then
    begin

      if GravaPedidoGourmet(vPedidoAIQGourmet) = 200 then
      begin
       logs.Lines.Add(datetimetostr(now()) + ' 828 Pedido reprocessado');
      end;

    end;
  finally
    vPedidoAIQGourmet.Free;
    TmRelogio.Enabled := True;
  end;
end;

procedure TFormGourmetAIQ.CarregaeAjustaPosicaoTela;
var
  vlIni: TIniFile;
  vlperiodos: string;
begin

  vlIni := TIniFile.Create(EXTRACTFILEPATH(Application.ExeName) + 'gourmeterp.ini');
  vpTopo := vlIni.ReadString('GourmetAIQ', 'Top', '0');
  vpEsquerda := vlIni.ReadString('GourmetAIQ', 'Left', '0');
  vpLargura := vlIni.ReadString('GourmetAIQ', 'Width', '350');
  vpAltura := vlIni.ReadString('GourmetAIQ', 'Height', '350');
  vpLeituraAutomatica := vlIni.ReadString('GourmetAIQ', 'Read', 'False');
  vpLiberacaoAutomatica := vlIni.ReadString('GourmetAIQ', 'Drive', 'False');
  vpEntregaMeioDia := vlIni.ReadString('GourmetAIQ', 'EntregaMeioDia', 'True');
  vpEntregaNoite := vlIni.ReadString('GourmetAIQ', 'EntregaNoite', 'True');
  vpRetiraMeioDia := vlIni.ReadString('GourmetAIQ', 'RetiraMeioDia', 'True');
  vpRetiraNoite := vlIni.ReadString('GourmetAIQ', 'RetiraNoite', 'True');

  vlIni.Free;

  Self.Top := vpTopo.ToInteger;
  Self.Left := vpEsquerda.ToInteger;
  Self.Width := vpLargura.ToInteger;
  Self.Height := vpAltura.ToInteger;

  cbLeitura.Checked := vpLeituraAutomatica.ToBoolean;
  cbSaidaEntrega.Checked := vpLiberacaoAutomatica.ToBoolean;

  cbEntregaNoAlmoco.Checked := False;
  cbRetiraNoAlomoco.Checked := False;
  cbEntregaNaJanta.Checked := False;
  cbRetiraNaJanta.Checked := False;

  if (lowercase(vpEntregaMeioDia) = 'false') or (lowercase(vpEntregaNoite) = 'false') or (lowercase(vpRetiraMeioDia) = 'false') or
    (lowercase(vpRetiraNoite) = 'false') then
  begin
    plhorariosentrega.Visible := True;

    if (lowercase(vpEntregaMeioDia) = 'true') then
      cbEntregaNoAlmoco.Checked := True;

    if (lowercase(vpRetiraMeioDia) = 'true') then
      cbRetiraNoAlomoco.Checked := True;

    if (lowercase(vpEntregaNoite) = 'true') then
      cbEntregaNaJanta.Checked := True;

    if (lowercase(vpRetiraNoite) = 'true') then
      cbRetiraNaJanta.Checked := True;

    cbEntregaNoAlmoco.Enabled := False;
    cbRetiraNoAlomoco.Enabled := False;
    cbEntregaNaJanta.Enabled := False;
    cbRetiraNaJanta.Enabled := False;

  end
  else
  begin
    plhorariosentrega.Visible := False;
  end;

end;

procedure TFormGourmetAIQ.SalvaPosicaoatualTela;
var
  vlIni: TIniFile;
begin

  if Self.WindowState = TWindowState.wsMinimized then
  begin
    Self.WindowState := TWindowState.wsNormal;
  end;

  vpTopo := Self.Top.ToString;
  vpEsquerda := Self.Left.ToString;
  vpLargura := Self.Width.ToString;
  vpAltura := Self.Height.ToString;
  vlIni := TIniFile.Create(EXTRACTFILEPATH(Application.ExeName) + 'gourmeterp.ini');
  vlIni.WriteString('GourmetAIQ', 'Top', vpTopo);
  vlIni.WriteString('GourmetAIQ', 'Left', vpEsquerda);
  vlIni.WriteString('GourmetAIQ', 'Width', vpLargura);
  vlIni.WriteString('GourmetAIQ', 'Height', vpAltura);

  vlIni.WriteString('GourmetAIQ', 'Read', cbLeitura.Checked.ToString);
  vlIni.WriteString('GourmetAIQ', 'Drive', cbSaidaEntrega.Checked.ToString);

  vlIni.Free;
end;

procedure TFormGourmetAIQ.Button1Click(Sender: TObject);
begin

  TmRelogio.Enabled := False;
  Button1.Enabled := False;

  logs.Lines.Add(datetimetostr(now()) + ' Inicia pedido');
  ReprocessarPedido(Edit2.text);
  logs.Lines.Add(datetimetostr(now()) + ' Pedido processado');
  Application.ProcessMessages;

  Button1.Enabled := True;
  TmRelogio.Enabled := True;
end;

procedure TFormGourmetAIQ.buttClick(Sender: TObject);
var
  i: Integer;
begin
  for i := 0 to mmListaPedidos.Lines.Count - 1 do
  begin
    Edit2.text := mmListaPedidos.Lines.Strings[i];
    logs.Lines.Add(datetimetostr(now()) + ' Inicia pedido');
    Button1.Click;
    logs.Lines.Add(datetimetostr(now()) + ' Pedido processado');
    Application.ProcessMessages;

    // Processapedidos;

    // sleep(500);
  end;
end;

procedure TFormGourmetAIQ.btConsultaPedidoGourmetClick(Sender: TObject);
var
  vlRetorno: Integer;
begin

  vlRetorno := ConsultaPedidoGourmet(Edit2.text);

  logs.Lines.Add(vlRetorno.ToString);

end;

procedure TFormGourmetAIQ.CarregaDados(vAIQCFG: TAIQCFG);

begin
  vpAIQCFG := CarregaDadosAIQCFG(vAIQCFG);

  if vpAIQCFG <> nil then
  begin
    logs.Lines.Add(datetimetostr(now()) + ' Carrega ID Loja: ' + vpAIQCFG.cfgmgouIDlojaAIQ);
    Panel2.Visible := True;
  end
  else
  begin
    logs.Lines.Add(datetimetostr(now()) + ' ATENÇÃO - SERVIDOR DE INTEGRAÇÃO OFFLINE');
    Panel2.Visible := False;
    plSituacao.caption := ' ATENÇÃO - SERVIDOR DE INTEGRAÇÃO OFFLINE';
    plSituacao.Font.Color := clWhite;
    pltituloProcessados.Color := clred;

  end;
end;

procedure TFormGourmetAIQ.DBGridRegistradosDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn;
  State: TGridDrawState);
var
  fixRect: TRect;
  tmpck: Integer;
  R: TRect;
  i: Integer;
begin

  // If DBGLista.Focused Then
  // begin

  fixRect := Rect;

  if Self.PedidosRegistradosaiqstatus.AsString = '0' then
  begin
    DBGridRegistrados.Canvas.Brush.Color := clred;
    DBGridRegistrados.Canvas.Font.Color := clWhite;

  end
  else
  begin
    DBGridRegistrados.Canvas.Brush.Color := clWhite;
    DBGridRegistrados.Canvas.Font.Color := clblack;
  end;



  // end;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin

      if Self.PedidosRegistradosaiqstatus.AsString = '0' then
      begin
        Brush.Color := clred; // $004080FF;
        FillRect(fixRect);
        Font.Color := clWhite;
      end
      else
      begin
        Brush.Color := clsilver; // $004080FF;
        FillRect(fixRect);
        Font.Color := clWhite;
      end;

    End;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);

end;

procedure TFormGourmetAIQ.DBGridRegistradosMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
begin
  vpContaTempo := 0;
end;

procedure TFormGourmetAIQ.DBGridAProcessarMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
begin
  vpContaTempo := 0;
end;

procedure TFormGourmetAIQ.FormCloseQuery(Sender: TObject; var CanClose: Boolean);
begin
  SalvaPosicaoatualTela;
end;

procedure TFormGourmetAIQ.ExecucaoUnica;
begin

  CreateMutex(nil, False, PChar('GourmetAIQOnlyOne'));

  if GetLastError = ERROR_ALREADY_EXISTS then
  begin
    Halt(0); // cancela execução
  end;

end;

procedure TFormGourmetAIQ.ReinializaAplicativo;
begin

  TmRelogio.Enabled := False;

  CarregaeAjustaPosicaoTela;

  vpCznChave := 0;

  vpCznChave := BuscacznChaveAberta;
  vpCznChaveAtual := vpCznChave;

  vpCcxChave := 0;
  vpCcxChave := BuscaccxChaveAberta;

  vpAIQCFG := TAIQCFG.Create;

  CarregaDados(vpAIQCFG);

  VerificaSituacaoLoja;

  TmRelogio.Enabled := True;

end;

procedure TFormGourmetAIQ.Processapedidos;
begin
  try
    try

      TmRelogio.Enabled := False;

      vpContaTempo := vpContaTempo + 1;

      if vpContaTempo > TEMPO_PEDIDOS then
      begin

        vpContaTempo := 0;
        vpCznChave := BuscacznChaveAberta;
        vpCcxChave := BuscaccxChaveAberta;

        SalvaPosicaoatualTela;

        if vpCznChave <> vpCznChaveAtual then
        begin
          ReinializaAplicativo;
        end;

        VerificaSituacaoLoja;

        ConsultaServidorAIQ;

      end
      else
      begin
        pnContador.caption := IntToStr(vpContaTempo) + ' de ' + IntToStr(TEMPO_PEDIDOS) + ' seg 1266';
        Application.ProcessMessages;
      end;

    finally
      TrimAppMemorySize;
      TmRelogio.Enabled := True;
    end;

  except
    TmRelogio.Enabled := True;
    TrimAppMemorySize;
  end;
end;

procedure TFormGourmetAIQ.FormShow(Sender: TObject);
begin

  ExecucaoUnica;

  TMInicializarAplicativo.Enabled := True;

end;

procedure TFormGourmetAIQ.BaixaPedidosdoAIQ;
var
  vlRecno: Integer;
begin

  pnContador.caption := IntToStr(vpContaTempo) + ' de ' + IntToStr(TEMPO_PEDIDOS) + ' seg 1164';
  Application.ProcessMessages;

  logs.Lines.Add(datetimetostr(now()) + '  1170 Loja aberta, vai Vai consultar pedidos');

  logs.Lines.Add(datetimetostr(now()) + '  1177 Vai baixar pedidos do portal do aiqfome');
  BaixarPedidosPortalAIQ(vpAIQCFG);
  logs.Lines.Add(datetimetostr(now()) + '  1179 Baixou pedidos do portal do aiqfome');

  logs.Lines.Add(datetimetostr(now()) + '  1181 Vai baixar pedidos servidor GOURMET');
  BaixarPedidosRegistradosGourmet;
  logs.Lines.Add(datetimetostr(now()) + '  1183 baixou pedidos servidor GOURMET');

  vlRecno := PedidosProcessados.RecNo;

  logs.Lines.Add(datetimetostr(now()) + '  1187 Vai carregar table processados');
  CarregaTabeladeProcessados;
  logs.Lines.Add(datetimetostr(now()) + '  1189 Carregou table processados');

  Application.ProcessMessages;

  PedidosRegistrados.IndexFieldNames := 'aiqpedido';
  PedidosRegistrados.First;

  logs.Lines.Add(datetimetostr(now()) + '  1197 Vai ajustar status dos pedidos');

  while not PedidosRegistrados.Eof do
  begin

     logs.lines.add('Processado :'+PedidosRegistradosaiqpedido.AsString );



    if PedidosProcessados.Locate('pedido', PedidosRegistradosaiqpedido.AsString, []) then
    begin

      logs.lines.add('Localizou Processado :'+PedidosRegistradosaiqpedido.AsString );


      if cbLeitura.Checked then
      begin

        if (PedidosRegistradosaiqstatus.AsInteger = 1) or (PedidosRegistradosaiqstatus.AsInteger = 0)  then
        begin

          if MarcaPedidoLidoAIQ(vpAIQCFG.cfgmgoutokenaiq, PedidosRegistradosaiqpedido.AsString, Developer_ID) then
          begin
            PedidosRegistrados.edit;
            PedidosRegistradosaiqstatus.AsInteger := 2;
            PedidosRegistrados.Post;
            AjustaStatusPedidoGourmet(PedidosRegistradosaiqpedido.AsString, PedidosRegistradosaiqstatus.AsString);
          end;

        end
        else if (PedidosRegistradosaiqstatus.AsInteger = 2) and (PedidosProcessadossaida.AsString <> '') then
        begin
          if cbSaidaEntrega.Checked then
          begin

            if MarcaPedidoProntoAIQ(vpAIQCFG.cfgmgoutokenaiq, PedidosRegistradosaiqpedido.AsString, Developer_ID) then
            begin
              PedidosRegistrados.edit;
              PedidosRegistradosaiqstatus.AsInteger := 3;
              PedidosRegistrados.Post;
              AjustaStatusPedidoGourmet(PedidosRegistradosaiqpedido.AsString, PedidosRegistradosaiqstatus.AsString);
            end;
          end;
        end;

      end;

    end
    else
    begin
            logs.lines.add('Não Localizou Processado :'+PedidosRegistradosaiqpedido.AsString );
    end;
    PedidosRegistrados.Next;
  end;

  logs.Lines.Add(datetimetostr(now()) + '  1241 Ajustou status dos pedidos');

  PedidosProcessados.RecNo := vlRecno;

  PedidosRegistrados.Last;

end;

procedure TFormGourmetAIQ.ConsultaServidorAIQ;
begin

  if (vpCznChave <> 0) and (vpCcxChave <> 0) then
  begin

    plCaixa.caption := ' Caixa Normal';
    pnRelogio.Color := clblack;
    PnTopoRegistraddos.Color := pnRelogio.Color;
    if vpAIQCFG = nil then
    begin
      vpAIQCFG := TAIQCFG.Create;
    end;

    CarregaDados(vpAIQCFG);

    plSituacao.Visible := True;

    if vpAIQCFG <> nil then
    begin

      pnContador.caption := IntToStr(vpContaTempo) + ' de ' + IntToStr(TEMPO_PEDIDOS) + ' seg 1298';
      Application.ProcessMessages;

      logs.Lines.Add(datetimetostr(now()) + 'Loja: ' + vpAIQCFG.cfgmgousituacaolojaaiq);

      if vpAIQCFG.cfgmgousituacaolojaaiq = 'OPEN' then
      begin

        logs.Lines.Add(datetimetostr(now()) + ' Vai consultar pedidos');
        BaixaPedidosdoAIQ;
        logs.Lines.Add(datetimetostr(now()) + ' Baixou pedidos do aiqfome');

      end;

      logs.Lines.Add(datetimetostr(now()) + ' Temporizador: ' + vpContaTempo.ToString + ' ' + TEMPO_PEDIDOS.ToString);
      BaixarPedidosRegistradosGourmet;
      CarregaTabeladeProcessados;

    end
    else
    begin
      begin
        logs.Lines.Add(datetimetostr(now()) + ' falha cfg ');
      end;

    end;

    pnContador.Visible := True;
    pnRelogio.Color := $002D2D2D;
    plTurno.Color := pnRelogio.Color;
    PnTopoRegistraddos.Color := pnRelogio.Color;

  end
  else
  begin

    if (vpCcxChave = 0) then
    begin
      plCaixa.caption := ' Caixa Fechada';
    end;

    if (vpCznChave = 0) then
    begin
      pnRelogio.caption := ' Cozinha Fechada';
    end;

    plSituacao.Visible := False;
    pnRelogio.Color := clred;
    plTurno.Color := clred;
    pnRelogio.Font.Color := clWhite;
    PnTopoRegistraddos.Color := pnRelogio.Color;

    pnContador.caption := IntToStr(vpContaTempo) + ' de ' + IntToStr(TEMPO_PEDIDOS) + ' seg 1298';
    Application.ProcessMessages;

  end;

end;

procedure TFormGourmetAIQ.TmRelogioTimer(Sender: TObject);
begin
  pnRelogio.caption := timetostr(time());
  Application.ProcessMessages;

  Processapedidos;


  if PedidosRegistrados.Active then
  begin
  PedidosRegistrados.Last;
  end;
  if PedidosProcessados.Active then
  begin
  PedidosProcessados.Last;
  end;

end;

end.
