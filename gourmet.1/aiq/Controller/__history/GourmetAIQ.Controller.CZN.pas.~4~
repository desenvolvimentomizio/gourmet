unit GourmetAIQ.Controller.CZN;

interface

uses
  REST.Types,
  System.Json,
  REST.Json,
  REST.Client,
  DataSetConverter4D,
  DataSetConverter4D.Impl,
  GourmetServer.Model.Entity.aiq.aiqcfg,
  GourmetAIQ.DataModulo.CZN,
  GourmetAIQ.Service.Funcoes,
  GourmetAIQ.DataModulo.Connection;

function BuscacznChaveAberta: Integer;

implementation

uses
  System.SysUtils;

function BuscacznChaveAberta: Integer;
var
  vDMczn: TDMczn;
  vlCznChave: string;
  vlJSONData : TJsonvalue;
  texto:string;
begin

  try
    vDMczn := TDMczn.Create(nil);

    vDMczn.RESTRequestGourmet.Method := TRESTRequestMethod.rmGET;
    vDMczn.RESTResponseGourmet.ContentType := 'application/json; charset=utf-8';
    try
      vDMczn.RESTRequestGourmet.Execute;
    except
      sleep(2000);
      vDMczn.RESTRequestGourmet.Execute;
    end;

    if vDMczn.RESTResponseGourmet.StatusCode = 200 then
    begin

     vlJSONData := TJSONObject.ParseJSONValue(vDMczn.RESTResponseGourmet.Content, False);

      texto := vlJSONData.ToString;


      vlCznChave := vlJSONData.getvalue('cznchave', '');




      vlCznChave := vDMczn.RESTResponseGourmet.Content;
      vlCznChave := copy(vlCznChave, 2, length(vlCznChave) - 1);
      vlCznChave := copy(vlCznChave, 1, length(vlCznChave) - 1);
    end;
    if vlCznChave <> '' then
    begin
      result := vlCznChave.ToInteger;
    end
    else
    begin
      result := 0;
    end;

  finally
    vDMczn.Free;
  end;

end;

end.
