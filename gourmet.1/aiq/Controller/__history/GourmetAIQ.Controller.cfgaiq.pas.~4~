unit GourmetAIQ.Controller.cfgaiq;

interface

uses
  REST.Types,
  System.Json,
  REST.Json,
  REST.Client,
  DataSetConverter4D,
  DataSetConverter4D.Impl,
  GourmetServer.Model.Entity.aiq.aiqcfg,
  GourmetAIQ.DataModulo.cfgaiq,
  GourmetAIQ.Service.Funcoes,
  GourmetAIQ.DataModulo.Connection;

function CarregaDadosAIQCFG(vAIQ: TAIQCFG): TAIQCFG;
function GravaDadosAIQCFG(vAIQ: TAIQCFG): integer;

implementation

uses
  System.SysUtils;

function CarregaDadosAIQCFG(vAIQ: TAIQCFG): TAIQCFG;
var
  vDMcfgaiq: TDMcfgaiq;
  aObject: TJSONObject;
  vlJSONData: TJsonvalue;
  texto: string;
  vlvalidade: string;
begin

  try
    vDMcfgaiq := TDMcfgaiq.Create(nil);

    vDMcfgaiq.RESTRequestGourmet.Method := TRESTRequestMethod.rmGET;
    vDMcfgaiq.RESTResponseGourmet.ContentType := 'application/json; charset=utf-8';
    try
      vDMcfgaiq.RESTRequestGourmet.Execute;
    except
      sleep(2000);
      try
        vDMcfgaiq.RESTRequestGourmet.Execute;
      except
        vAIQ := nil;
      end;
    end;

    if vDMcfgaiq.RESTResponseGourmet.StatusCode = 200 then
    begin

      texto := vDMcfgaiq.RESTResponseGourmet.Content;
      texto := copy(texto, 2, length(texto) - 1);
      texto := copy(texto, 1, length(texto) - 1);

      vlJSONData := TJSONObject.ParseJSONValue(texto, False);

      texto := vlJSONData.ToString;
      vAIQ.cfgCodigo := vlJSONData.getvalue('cfgcodigo', '').ToInteger;
      vAIQ.cfgmgoutokenaiq := vlJSONData.getvalue('cfgmgoutokenaiq', '');
      vAIQ.cfgmgourefreshaiq := vlJSONData.getvalue('cfgmgourefreshaiq', '');
      vlvalidade := trim(vlJSONData.getvalue('cfgmgouvalidadeaiq', ''));
      if (vlvalidade <> '//') and (vlvalidade <> '') then
      begin
        vAIQ.cfgmgouvalidadeaiq := strtodatetime(datahorasqltotext(vlJSONData.getvalue('cfgmgouvalidadeaiq', '')));
      end;
      vAIQ.cfgmgouidlojaaiq := vlJSONData.getvalue('cfgmgouidlojaaiq', '');
      vAIQ.cfgmgouemaillojaaiq := vlJSONData.getvalue('cfgmgouemaillojaaiq', '');
      vAIQ.cfgmgousenhalojaaiq := vlJSONData.getvalue('cfgmgousenhalojaaiq', '');
      vAIQ.cfgmgousituacaolojaaiq := vlJSONData.getvalue('cfgmgousituacaolojaaiq', '');

    end;
    result := vAIQ;

  finally
    if vlJSONData <> nil then
      vlJSONData.Free;
    if vDMcfgaiq <> nil then
      vDMcfgaiq.Free;

  end;

end;

function GravaDadosAIQCFG(vAIQ: TAIQCFG): integer;
var
  vlUrl: string;
  vDMcfgaiq: TDMcfgaiq;
  vlParam: TRESTRequestParameter;
  texto: string;
begin

  try
    vDMcfgaiq := TDMcfgaiq.Create(nil);

    vDMcfgaiq.RESTRequestGourmet.ParamS.Clear;

    vDMcfgaiq.RESTRequestGourmet.ParamS.Add;
    vDMcfgaiq.RESTRequestGourmet.ParamS[0].ContentType := ctAPPLICATION_JSON;
    vDMcfgaiq.RESTRequestGourmet.ParamS[0].Kind := pkREQUESTBODY;
    vDMcfgaiq.RESTRequestGourmet.ParamS[0].name := 'body';
    vDMcfgaiq.RESTRequestGourmet.ParamS[0].Options := [poDoNotEncode];
    vDMcfgaiq.RESTRequestGourmet.Method := TRESTRequestMethod.rmPUT;
    vDMcfgaiq.RESTRequestGourmet.Body.Add(vAIQ);
    try
      vDMcfgaiq.RESTRequestGourmet.Execute;
    except
      sleep(2000);
      vDMcfgaiq.RESTRequestGourmet.Execute;
    end;
    result := vDMcfgaiq.RESTResponseGourmet.StatusCode;

  finally
    vDMcfgaiq.Free;
  end;
end;

end.
