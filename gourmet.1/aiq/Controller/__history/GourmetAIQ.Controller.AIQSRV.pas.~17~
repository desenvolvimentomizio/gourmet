unit GourmetAIQ.Controller.AIQSRV;

interface

uses

  GourmetAIQ.service.constants,
  GourmetAIQ.service.funcoes,
  GourmetAIQ.service.authenticationAIQ,
  GourmetAIQ.Model.Entity.AIQSRV,
  GourmetAIQ.DataModulo.AIQ,
  GourmetServer.Model.Entity.AIQ.AIQCFG;

Function CarregaIDLojaAIQ(vAIQ: TAIQCFG): TAIQCFG;
Function GerarTokenAIQ(vAIQ: TAIQCFG): TAIQCFG;

implementation

uses
  REST.Client,
  REST.Types,
  System.JSON,
  DateUtils,
  System.SysUtils;

Function CarregaIDLojaAIQ(vAIQ: TAIQCFG): TAIQCFG;
var
  vlDMAIQ: TDMAIQ;

  vlJSONData: TJsonvalue;
  vJSONItens: TJSONArray;
  vJSONPair: TJSONPair;
  vJSONObject: TJSONObject;
  a: string;
begin


  try
    vlDMAIQ := TDMAIQ.Create(nil);
    vlDMAIQ.RESTClientAIQ.Authenticator := AjustaAutenticacaoAIQ(vlDMAIQ.OAuth2AuthenticatorAIQ, vAIQ.cfgmgouTokenAIQ);
    vlDMAIQ.RESTClientAIQ.BaseURL := urlbase + PATH_ID_LOJA;
    vlDMAIQ.RESTRequestAIQ.Method := TRESTRequestMethod.rmGET;

    vlDMAIQ.RESTClientAIQ.Authenticator := vlDMAIQ.OAuth2AuthenticatorAIQ;
    vlDMAIQ.RESTRequestAIQ.Params.Clear;
    vlDMAIQ.RESTRequestAIQ.Params.AddHeader('Aiq-User-Agent', 'Pegasus (' + vAIQ.cfgmgouemaillojaaiq + ')');

    try
      vlDMAIQ.RESTRequestAIQ.Execute;
    except
      sleep(2000);
      vlDMAIQ.RESTRequestAIQ.Execute;
    end;

    a := vlDMAIQ.RESTResponseAIQ.Content;
    if vlDMAIQ.RESTResponseAIQ.StatusCode = 200 then
    begin

      vlJSONData := TJSONObject.ParseJSONValue(vlDMAIQ.RESTResponseAIQ.Content, False);
      vJSONItens := vlJSONData.GetValue<TJSONArray>('data');

      vJSONObject := vJSONItens.Items[0].GetValue<TJSONObject>();

      vJSONPair := vJSONObject.Get('id');
      vAIQ.cfgmgouIDlojaAIQ := '84824';//StringReplace(vJSONPair.JsonValue.ToString, '"', '', [rfReplaceAll, rfIgnoreCase]);

      vJSONPair := vJSONObject.Get('status');
      vAIQ.cfgmgousituacaolojaaiq := StringReplace(vJSONPair.JsonValue.ToString, '"', '', [rfReplaceAll, rfIgnoreCase]);

    end;
    result := vAIQ;
  finally
    vlDMAIQ.free;
  end;

end;

Function GerarTokenAIQ(vAIQ: TAIQCFG): TAIQCFG;
var
  vlDMAIQ: TDMAIQ;
  vlJSONData: TJsonvalue;
  vJSONItem: TJSONObject;
  vJSONPair: TJSONPair;
  a: string;
  d:TDateTime;
begin

  try
    vlDMAIQ := TDMAIQ.Create(nil);
    vlDMAIQ.RESTClientAIQ.Authenticator := vlDMAIQ.HTTPBasicAuthenticatorAIQ;
    vlDMAIQ.HTTPBasicAuthenticatorAIQ.Username := Client_ID;
    vlDMAIQ.HTTPBasicAuthenticatorAIQ.Password := Client_Secret;

    vlDMAIQ.RESTClientAIQ.BaseURL := urlbase + PATH_TOKEN;
    vlDMAIQ.RESTRequestAIQ.Params.Clear;
    /// * vAIQ.cfgmgouemaillojaaiq */
    vlDMAIQ.RESTRequestAIQ.Params.AddHeader('Aiq-User-Agent', 'pegasus(daniel@pegasussistemas.com.br)');

    /// * Developer_ID */
    /// /* Developer_Secret*/
    // vlDMAIQ.RESTRequestAIQ.Body.Add('{"username" : "' + 'kuskao' + '", "password" : "' + 'kuskao@pizza'   + '"}', TRESTContentType.ctAPPLICATION_JSON);

    vlDMAIQ.RESTRequestAIQ.Body.Add('{"username" : "' + vAIQ.cfgmgouemaillojaaiq + '", "password" : "' + vAIQ.cfgmgousenhalojaaiq + '"}',
      TRESTContentType.ctAPPLICATION_JSON);

    try
      vlDMAIQ.RESTRequestAIQ.Execute;
    except
      sleep(2000);
      vlDMAIQ.RESTRequestAIQ.Execute;
    end;

    if vlDMAIQ.RESTResponseAIQ.StatusCode = 200 then
    begin

      vlJSONData := TJSONObject.ParseJSONValue(vlDMAIQ.RESTResponseAIQ.Content, False);
      a := vlJSONData.ToString;
      vJSONItem := vlJSONData.GetValue<TJSONObject>('data');

      vJSONPair := vJSONItem.Get('access_token');
      vAIQ.cfgmgouTokenAIQ := StringReplace(vJSONPair.JsonValue.ToString, '"', '', [rfReplaceAll, rfIgnoreCase]);

      vJSONPair := vJSONItem.Get('expires_in');
      a:=vJSONPair.JsonValue.ToString;

     // d:=Intto Date( Strtoint(a));
      // vAIQ.cfgmgouValidadeAIQ := strtodatetime(vJSONPair.JsonValue.ToString);

      vAIQ.cfgmgouValidadeAIQ := strtodatetime(datetimetostr(IncSecond(now(), (StrToInt(vJSONPair.JsonValue.ToString) div 8) )));

    end;
    result := vAIQ;
  finally
    vlDMAIQ.free;
  end;

end;

end.
