unit ufnfcepdv;

interface

uses
  Winapi.Windows, System.SysUtils, Vcl.Forms, ACBrNFeDANFEFRDM,printers,
  ACBrNFeDANFEClass, ACBrNFeDANFEFR, ACBrValidador, Uni, ufuncoes,Inifiles,
  ACBrBase, ACBrDFe, ACBrNFe, Vcl.ComCtrls, System.Classes, Vcl.Controls,
  Vcl.ExtCtrls, Vcl.Dialogs, System.StrUtils, System.Math,
  pcnConversaoNFe, uPegaBase, MemDS, DBAccess, Data.DB, DateUtils, Vcl.StdCtrls,
  ACBrMail, IdComponent, IdMessage, IdIOHandler, IdIOHandlerSocket,
  IdIOHandlerStack, IdSSL, IdSSLOpenSSL, IdBaseComponent, IdTCPConnection,
  IdTCPClient, IdExplicitTLSClientServerBase, IdMessageClient, IdSMTPBase,
  IdSMTP, IdAttachment, IdAttachmentFile, ACBrDFeReport, ACBrDFeDANFeReport,
  ACBrDANFCeFortesFr, ACBrDFeUtil, midaslib, ACBrDFeSSL, blcksock, IdEMailAddress, frxClass, pcnConversao, frxDACComponents, frxUniDACComponents;

type
  Tfnfcepdv = class(TForm)
    ACBrValidador: TACBrValidador;

    consulta: TUniQuery;
    rec: TUniQuery;
    mes: TUniQuery;
    itm: TUniQuery;
    etd: TUniQuery;
    toe: TUniQuery;
    enf: TUniQuery;
    mev: TUniQuery;
    cfg: TUniQuery;
    trm: TUniQuery;
    mic: TUniQuery;
    oic: TUniQuery;
    qDtl: TUniQuery;
    rni: TUniQuery;
    NumeroNFCe: TUniQuery;
    disponivel: TUniQuery;
    limite: TUniQuery;
    yoe: TUniQuery;
    itmncm: TUniQuery;

    recreccodigo: TIntegerField;
    recrecmotivo: TStringField;
    recrecdthoraentrada: TDateTimeField;
    recrecdthorasaida: TDateTimeField;

    mesmeschave: TIntegerField;
    mestoecodigo: TIntegerField;
    mesetdcodigo: TIntegerField;
    mesmestotal: TFloatField;
    mesrefcodigo: TIntegerField;
    mestfpcodigo: TIntegerField;
    mestdfcodigo: TStringField;
    mesmesnumero: TIntegerField;
    mesmesserie: TStringField;
    mesedritem: TIntegerField;
    mesmesdatanfe: TDateField;
    mesmescoocupom: TIntegerField;
    mesmesdatacupom: TDateField;
    mesmesprotocolo: TStringField;
    mesmeschavenfe: TStringField;
    mesmesregistro: TDateField;
    mestemcodigo: TIntegerField;

    itmcfocfop: TStringField;
    itmprocodigo: TIntegerField;
    itmpronome: TStringField;
    itmpronomereduzido: TStringField;
    itmproncm: TStringField;
    itmitmdesccomple: TStringField;
    itmitmquantidade: TFloatField;
    itmunisimbolo: TStringField;
    itmitmvalor: TFloatField;
    itmitmdesconto: TFloatField;
    itmitmchave: TIntegerField;
    itmcstcodigo: TStringField;
    itmicmcodigo: TStringField;
    itmitmicm: TFloatField;
    itmitmbicm: TFloatField;
    itmitmaliqipi: TFloatField;
    itmitmbipi: TFloatField;
    itmitmipi: TFloatField;
    itmitmvlribpt: TFloatField;
    itmpunqtdtribtotal: TFloatField;
    itmunisimbolotrib: TStringField;
    itmproanpcodigo: TIntegerField;
    itmitmtotal: TFloatField;
    itmitmcargatrib: TFloatField;

    etdetddoc1: TStringField;
    etdedrcep: TStringField;
    etdedrrua: TStringField;
    etdedrnumero: TStringField;
    etdedrbairro: TStringField;
    etdcddcodigo: TStringField;
    etdcddnome: TStringField;
    etdufssigla: TStringField;
    etdetftelefone: TStringField;
    etdtpecodigo: TIntegerField;
    etdetdidentificacao: TStringField;
    etdedrinscest: TStringField;

    toettecodigo: TIntegerField;
    toetoeidentificacao: TStringField;
    toetoecodigo: TIntegerField;

    enfenfchave: TIntegerField;
    enftencodigo: TIntegerField;
    enfenfregistroevento: TDateField;
    enfenfchaveevento: TStringField;
    enfenfseqevento: TIntegerField;
    enfenfdescricao: TStringField;
    enfenfxml: TBlobField;
    enfenfcstat: TIntegerField;
    enfenfxmotivo: TStringField;

    mevmevchave: TIntegerField;
    mevenfchave: TIntegerField;
    mevmeschave: TIntegerField;

    cfgcfgcodigo: TIntegerField;
    cfgcfgnumecertif: TStringField;
    cfgcfgetdempresa: TIntegerField;
    cfgcfgviasnfe: TIntegerField;
    cfgcfgserienfe: TStringField;
    cfgcfgserienfce: TStringField;
    cfgcfgdescrinfe: TIntegerField;
    cfgcfgemailnfe: TStringField;
    cfgcfgemailservidornfe: TStringField;
    cfgcfgemailsenhanfe: TStringField;
    cfgcfgmailportnfe: TStringField;
    cfgcfgemailusatls: TIntegerField;
    cfgcrtcodigo: TIntegerField;
    cfgetdapelido: TStringField;
    cfgetdidentificacao: TStringField;
    cfgetddoc1: TStringField;
    cfgufscodigo: TStringField;
    cfgcddcodigo: TStringField;
    cfgedrinscest: TStringField;
    cfgedrrua: TStringField;
    cfgedrnumero: TStringField;
    cfgedrbairro: TStringField;
    cfgedrcep: TStringField;
    cfgcddnome: TStringField;
    cfgufssigla: TStringField;
    cfgetftelefone: TStringField;
    cfgcfgusanfc: TIntegerField;
    cfgcfgtoken1nfce: TStringField;
    cfgcfgnumecertifa1: TStringField;
    cfgcfgmodonfe: TIntegerField;
    cfgcfgidtokennfce: TStringField;
    cfgcfgviaassinar: TIntegerField;
    cfgcfgsenhacertificadoa1: TStringField;

    trmtciporta: TStringField;
    trmecfcodigo: TIntegerField;
    trmtrmcodigo: TIntegerField;
    trmtipcodigo: TIntegerField;

    micmicchave: TIntegerField;
    micmeschave: TIntegerField;
    micidccodigo: TIntegerField;
    micidcnome: TStringField;
    micidcdoc: TStringField;

    oicoicchave: TIntegerField;
    oicorcchave: TIntegerField;
    oicidccodigo: TIntegerField;
    oicidcnome: TStringField;
    oicidcdoc: TStringField;

    PlTitulo: TPanel;
    plStatusSefaz: TPanel;
    Panel1: TPanel;

    rnirnichave: TIntegerField;
    rnirniano: TStringField;
    rnirnimes: TStringField;
    rnitdfcodigo: TStringField;
    rnirninumeroinicial: TIntegerField;
    rnirninumerofinal: TIntegerField;
    rnirnijutificativa: TStringField;

    mesclbidentificacao: TStringField;
    itmitmcargatribest: TFloatField;
    mesmesprodutos: TFloatField;
    cfgcfgmensagempdv: TStringField;
    plestagio: TPanel;
    mesmesobs: TStringField;
    info: TMemo;
    etdetdnfemodelos: TStringField;
    itmcspcodigo: TStringField;
    itmcsfcodigo: TStringField;

    disponivelrfisaldocapital: TFloatField;

    limiteetdcodigo: TIntegerField;
    limiteetllimitetotal: TFloatField;
    yoeansanexo: TStringField;
    cfgcfgtoesubstforaestado: TIntegerField;
    cfgcfgtoesubstnoestado: TIntegerField;

    itmncmtoecodigo: TIntegerField;
    cfgcfgprevisualizarimpressao: TIntegerField;
    cfgcfgversao: TStringField;
    ACBrValidadorBarra: TACBrValidador;
    itmpunbarra: TStringField;
    itmpunbarrasistema: TIntegerField;
    mesmesemissao: TDateField;
    toeitm: TUniQuery;
    toeitmtoecodigo: TIntegerField;
    toeitmcstcodigo: TStringField;
    toeitmcsicodigo: TStringField;
    toeitmcspcodigo: TStringField;
    toeitmcfgpercentualpis: TFloatField;
    toeitmcsfcodigo: TStringField;
    toeitmcfgpercentualcofins: TFloatField;
    itmcsicodigo: TStringField;
    itmtoecodigo: TIntegerField;
    cfgcfgusacstnoproduto: TIntegerField;
    itmcst: TUniQuery;
    itmcstitmchave: TIntegerField;
    itmcstcstcodigo: TStringField;
    itmcstcsicodigo: TStringField;
    itmcstcspcodigo: TStringField;
    itmcstcsfcodigo: TStringField;
    itmcstitmaliqpis: TFloatField;
    itmcstitmaliqcofins: TFloatField;
    itmcstitmaliqipi: TFloatField;
    ncm: TUniQuery;
    toettocodigo: TIntegerField;
    mostra: TProgressBar;
    cfgcfgtoesubstanpnoestado: TIntegerField;
    cfgcfgtoesubstanpforaestado: TIntegerField;
    cfgcfgtoemesinte: TIntegerField;
    mesmeshoranfe: TTimeField;
    cfgcfgdefinetoeatendimento: TIntegerField;
    cfgcfgcestativo: TIntegerField;
    itmtcecest: TStringField;
    itmtpocodigo: TIntegerField;
    qTomTof: TUniQuery;
    tom: TUniQuery;
    tomtomchave: TIntegerField;
    tomtofcodigo: TIntegerField;
    tommeschave: TIntegerField;
    tomtomobs: TStringField;
    cfgcfgobs1: TIntegerField;
    cfgcfgproducaopropria: TIntegerField;
    itmproproducao: TIntegerField;
    cfgcfgtoeinteproducaopropria: TIntegerField;
    cfgcfgtoeforaproducaopropria: TIntegerField;
    itmitmpercreducaobaseicm: TFloatField;
    itmitmaliqpis: TFloatField;
    itmitmpis: TFloatField;
    itmitmbpis: TFloatField;
    itmitmaliqcofins: TFloatField;
    itmitmcofins: TFloatField;
    itmitmbcofins: TFloatField;
    itmitmfrete: TFloatField;
    itmitmoutras: TFloatField;
    cfgcfgtoeintesubsprodpropria: TIntegerField;
    cfgcfgtoeforasubsprodpropria: TIntegerField;
    itmpunidentificacao: TStringField;
    qconsulta: TUniQuery;
    mesmescodigonota: TIntegerField;
    mesmesoutras: TCurrencyField;
    itmicmaliquota: TStringField;
    cfgcfgtributacaoimendes: TIntegerField;
    itmitmbicms: TFloatField;
    itmitmmva: TFloatField;
    itmitmicms: TFloatField;
    itmitmaliqicms: TStringField;
    mesmespis: TCurrencyField;
    mesmescofins: TCurrencyField;
    itmpuncodigo: TIntegerField;
    ctd: TUniQuery;
    ctdctdcnpj: TStringField;
    cfgcfgcertificadoa1: TBlobField;
    cfgeteemail: TStringField;
    rnimeschave: TIntegerField;
    rnimeschavenfe: TStringField;
    cfgctdboxedominio: TStringField;
    mesmesfrete: TFloatField;
    cfgcfgusapdv: TIntegerField;
    mesttocodigo: TIntegerField;
    itmitmaliqicm: TStringField;
    qEnfMev: TUniQuery;
    qEnfMevenfseqevento: TIntegerField;
    qEnfMevenfdescricao: TStringField;
    qEnfMevtencodigo: TIntegerField;
    qEnfMevenfchaveevento: TStringField;
    qEnfMevenfregistroevento: TDateField;
    qEnfMevmesregistro: TDateField;
    cfgmnfe: TUniQuery;
    cfgmnfecfgemailnfe: TStringField;
    cfgmnfecfgemailservidornfe: TStringField;
    cfgmnfecfgemailsenhanfe: TStringField;
    cfgmnfecfgmailportnfe: TStringField;
    cfgmnfecfgemailusatls: TIntegerField;
    cfgmnfecfgcodigo: TIntegerField;
    cfgcfgpresencialtoedestino: TIntegerField;
    cfgcfgservarqnfes: TStringField;
    rdc: TUniQuery;
    dtl: TUniQuery;
    consultacomprovante: TUniQuery;
    ACBrNFeDANFCEFR1: TACBrNFeDANFCEFR;
    frxUniDACComponents1: TfrxUniDACComponents;
    UniQuery1: TUniQuery;
    ACBrNFeNFCe: TACBrNFe;
    tagPagamento: TUniQuery;
    ctapix: TUniQuery;
    cfgcfgctacodigopix: TIntegerField;
    mesoricodigo: TIntegerField;
    ori: TUniQuery;
    orietddoc1: TStringField;
    orietdcodigo: TIntegerField;
    orioriidentificacao: TStringField;
    tagPagamentomdatagpagamento: TIntegerField;
    tagPagamentomdadescrpagamento: TStringField;
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormShow(Sender: TObject);
    procedure IO_OpenSSLStatusInfo(const AMsg: string);
    procedure ACBrNFeNFCeTransmit(const Dados, URL, SoapAction,
      MimeType: string; var Resposta: string; var HTTPResultCode,
      InternalErrorCode: Integer);
    procedure ACBrNFeNFCeGerarLog(const ALogLine: string; var Tratado: Boolean);
  private
    Fzcone: TUniConnection;
    FWebOnLine:Boolean;

    function AjustaSituacaoNFCe(vMesChave: string; vFlaCodigo: string = '1'; VMostra: Boolean = False): Boolean;
    function EmiteNFCe(vMesChave: string; vImprimir: Boolean; vFlaCodigo: string = '1'): Boolean;
    function GeraNFCe(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function ImprimeNFCe(vMesChave: string; vFlaCodigo: string = '1'; vVisualizar: Boolean = False): Boolean;
    function GeraNomeArqNFCe(vMesChave: string; vFlaCodigo: string = '1'): string;
    procedure AjustaCaminhoGeralNF(Data: TDate);
    procedure InicializaTabelas;

//    function ValidaConsumidor(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function AssinaNota(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function SalvaEmCoontigencia(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function SalvaNormal(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;

    procedure entraemcontigencia(vStatSEFAZ: string);
    function GeraNomeArqNFCeTipo(vMesChave: string; vTipoEmissao: Integer; vFlaCodigo: string = '1'): string;
    function ConsultaNFCe(vMesChave, vArqNFCe: String; vFlaCodigo: string = '1'; vMostrar: Boolean = False): Boolean;
    procedure Setzcone(const Value: TUniConnection);
    procedure SalvarLogErro(eMessage, eStackTrace: String);
   // procedure VerifieAjustaItemcomSubstituicao(usEmitente, ufDestinatario: string);

    procedure Inicializar;
    function GeraxmlCont(vChaveNFE: string; vFlaCodigo: string = '1'): Boolean;
//    procedure VerifieAjustaItemcomConsumidorFinal;
    procedure VerifieAjustaICM;
    function LerConfiguracaoNFCe: Boolean;
    function validatemprodutos: Boolean;
    function DefineVertical: String;
    function GeraNomeNFCe: string;
    procedure ImprimeEventoNfe(vlArquivoNFce: string);
    procedure GeraNomeArqsEvento;
    function AjustarDataViaSEFAZ(vData, vHora: String): Boolean;
    procedure ajustaConexoes;
    procedure saidacontigencia;
    function VerificaValidadeCertificado: Boolean;
    function RetornaBandeira(aCodigo: Integer): TpcnBandeiracartao;
    procedure AtribuiEventosQuery;
    procedure VerificaconexaoantesdeAplicar(DataSet: TDataSet);
    procedure VerificaConexaoAntesdeExecutar(Sender: TObject);
    function ConsultaServicoSEFAZNFCE(vMostrar: Boolean = False): string;
    procedure CarregaOpcoesPadroes;
    Procedure GravaOpcoesPadroes;

  protected
    { Private declarations }
    vpConsultaVisivel: Boolean;
  published
    property zcone: TUniConnection read Fzcone write Setzcone;
    property WebOnLine: Boolean read FWebOnLine write FWebOnLine;
  public
    { Public declarations }

    vpIPServidorArquivo: String;
    vpimprimenfce: String;

    vPathXML: String;
    vpArquivoXMLEvento: String;

    vpArquivoNFce: String;
    vPathPDF: String;
    vpArquivoPDFEvento: String;

    Acesso: TAcesso;
    vpFilial: string;
    vpPastaPrincipal: string;
    vpMesChave: String;
    vpFlacodigo: String;

    vpDataAtual: TdateTime;
    vpSubPastaDoc: string;
    vpAAAAMMNNNFCe: string;
    vpTrmCodigo: string;
    vpClbCodigo: string;

    vpNomeArquivoNFCe: string;

    vpConsultouSEFAZ: Boolean;
    vpDataHoraSEFAZ: TdateTime;
    vpStatusSEFAZ: String;
    vpPathAplicativo: String;
  end;

  Tmodulonfce = function(AOwner: TComponent; conexao: TUniConnection; vmeschave: string; vfuncao: string; Acesso: TAcesso; vImprimir: Boolean;
    vConsultouSefaz: Boolean; vemail: string): Boolean;


const
  (* Tipos de Emissão de NFCe *)
  temiNormal = 1;
  temiContingencia = 2;
  temiContingenciOffLine = 9;


var
  fnfcepdv: Tfnfcepdv;

  (* Identifica situação do Web Service como Normal - OnLine *)
  vpWSNormal: Boolean = True;

implementation

uses
  ACBrUtil, System.Variants, ACBrUtil.DateTime, pingsend, ufNFCePDVComprovante;

{$R *.dfm}



function BuscaIMpressoraPadrao:String;
begin
  if Printer.Printers.Count > 0 then
  begin
    Printer.PrinterIndex := -1;
    Result:=Printer.Printers[Printer.PrinterIndex];
  end;
end;


function modulonfce(AOwner: TComponent; conexao: TUniConnection; vMesChave: string; vFuncao: string; Acesso: TAcesso; vImprimir: Boolean;
  vConsultouSefaz: Boolean; vemail: string; vWebOnline:Boolean=True): Boolean;
var
  vDia: string;
  vHora: string;

  vlTentativas:Integer;

  vlDataHoraSefaz:String;

begin

  try


    fnfcepdv := Tfnfcepdv.Create(AOwner);

    fnfcepdv.zcone := conexao;

    fnfcepdv.AtribuiEventosQuery;

    // atribui o conector a todas as querys do modulo

    fnfcepdv.ajustaConexoes;

    // carrega dados do emissor do documento
    fnfcepdv.Acesso := Acesso;
    fnfcepdv.vpTrmCodigo := Acesso.Terminal.ToString;
    fnfcepdv.vpClbCodigo := Acesso.Usuario.ToString;
    fnfcepdv.vpFlacodigo := Acesso.Filial.ToString;

    // inicializa as tabelas de configurações


    fnfcepdv.Inicializar;

    fnfcepdv.InicializaTabelas;


    (* Ajusta as configurações do Componente *)
    if not fnfcepdv.LerConfiguracaoNFCe then
    begin
      ShowMessage('Verifique as configurações para emissão de NFCe');
      Exit;
    end;

    (* Verifica dados do cliente *)

     if fnfcepdv.WebOnLine then
     begin
      vlDataHoraSefaz:=fnfcepdv.ConsultaServicoSEFAZNFCE;
      fnfcepdv.vpConsultouSEFAZ:=True;
     end

     else
     begin
      vlDataHoraSefaz:='';
      fnfcepdv.vpConsultouSEFAZ:=false;
     end;



    if vlDataHoraSefaz<>'' then
    begin

      fnfcepdv.vpDataAtual := Strtodate(trim(Copy(vlDataHoraSefaz, 1, 10)));
      fnfcepdv.vpDataHoraSEFAZ :=StrToTime(trim(Copy(vlDataHoraSefaz, 11, 10)));
      fnfcepdv.vpConsultouSEFAZ:=True;
    end
    else
    begin
     // fnfcepdv.vpDataAtual := strtodate(agora(application, conexao));
     // fnfcepdv.vpDataHoraSEFAZ := strtodatetime(agora(application, conexao));

      fnfcepdv.vpDataAtual := date();
      fnfcepdv.vpDataHoraSEFAZ := now();
      fnfcepdv.vpConsultouSEFAZ:=False;

    end;


    fnfcepdv.vpPastaPrincipal := ExtractFilePath(application.ExeName);

    if Copy(fnfcepdv.vpPastaPrincipal, Length(fnfcepdv.vpPastaPrincipal), 1) <> '\' then
      fnfcepdv.vpPastaPrincipal := fnfcepdv.vpPastaPrincipal + '\';

    fnfcepdv.vpSubPastaDoc := 'arqnfces';


    fnfcepdv.vpConsultaVisivel := False;

    fnfcepdv.AjustaCaminhoGeralNF(fnfcepdv.vpDataHoraSEFAZ);


    (* Identifica se Contingência está Ativa *)
    if fnfcepdv.rec.Active = False then
    begin
      fnfcepdv.rec.Open;
    end;

    vpWSNormal := fnfcepdv.vpConsultouSEFAZ;


    vDia := hoje(application, conexao);
    vHora := agora(application, conexao);

    fnfcepdv.vpDataAtual := strtodatetime(formatdatetime('dd/mm/yyyy', strtodate(vDia)) + ' ' + formatdatetime('hh:mm:ss', strtodatetime(vHora)));

    fnfcepdv.AjustaCaminhoGeralNF(fnfcepdv.vpDataAtual);

    if fnfcepdv.ConsultaServicoSEFAZNFCE(False)<>'' then
    begin
      fnfcepdv.vpConsultouSEFAZ:=True;
    end;


    if fnfcepdv.vpConsultouSEFAZ then
    begin
      fnfcepdv.plStatusSefaz.Caption := 'SEFAZ on-line';
      application.ProcessMessages;
    end
    else
    begin
      fnfcepdv.plStatusSefaz.Caption := 'SEFAZ sem acesso';
      application.ProcessMessages;
    end;



    fnfcepdv.vpDataAtual := strtodatetime(formatdatetime('dd/mm/yyyy', strtodate(vDia)) + ' ' + formatdatetime('hh:mm:ss', strtodatetime(vHora)));

    fnfcepdv.AjustaCaminhoGeralNF(fnfcepdv.vpDataAtual);




    fnfcepdv.vpMesChave := vMesChave;

    if (fnfcepdv.vpMesChave <> '0') and (fnfcepdv.vpMesChave <> '') then
    begin

      fnfcepdv.mes.Close;
      fnfcepdv.mes.Params[0].AsString := fnfcepdv.vpMesChave;
      fnfcepdv.mes.Open;

      if fnfcepdv.mesetdcodigo.AsInteger=0 then
      begin
        fnfcepdv.mes.edit;
        fnfcepdv.mesedritem.AsInteger:=1;
        fnfcepdv.mes.Post;
      end;




      fnfcepdv.vpNomeArquivoNFCe := fnfcepdv.GeraNomeArqNFCe(vMesChave, fnfcepdv.vpFlacodigo);
    end;

    fnfcepdv.ACBrNFeDANFCEFR1.Impressora:=BuscaIMpressoraPadrao;

    try
      case ansiIndexStr(vFuncao, ['EmiteNFCe', 'ImprimeNFCe', 'CancelaNFCe', 'ConsultaServicoSEFAZNFCE', 'VerificaExistencia', 'AjustaSituacaoNFCe',
        'InutilizarNumerosNFCE', 'InutilizarNumerosNFCEDireto', 'GerarXML', 'ReGerarXML', 'VisualizaNFCe', 'EmailNFCe', 'GerarXMLCont']) of
        0:
          Result := fnfcepdv.EmiteNFCe(vMesChave, vImprimir, fnfcepdv.vpFlacodigo);
        1:
          Result := fnfcepdv.ImprimeNFCe(vMesChave, fnfcepdv.vpFlacodigo);
        3:
          Result := True;
        10:
          Result := fnfcepdv.ImprimeNFCe(vMesChave, fnfcepdv.vpFlacodigo, True);
        12:
          Result := True; // fnfcepdv.GeraxmlCont(vMesChave, fnfcepdv.vpFlacodigo);
      end;


    except
    on e: Exception do
    begin
      Result := False;
      Application.MessageBox(PChar('Erro: '+e.Message), 'ERRO', MB_OK + MB_ICONERROR);

      vlTentativas:=0;

      while true do
      begin
         vlTentativas := vlTentativas + 1;


         if vlTentativas>60 then
         begin
           Result := False;
           break;
         end
         else
         begin
           Sleep(1000);
         end;

        case ansiIndexStr(vFuncao, ['EmiteNFCe', 'ImprimeNFCe', 'CancelaNFCe', 'ConsultaServicoSEFAZNFCE', 'VerificaExistencia', 'AjustaSituacaoNFCe',
        'InutilizarNumerosNFCE', 'InutilizarNumerosNFCEDireto', 'GerarXML', 'ReGerarXML', 'VisualizaNFCe', 'EmailNFCe', 'GerarXMLCont']) of
        0:
          begin
            try

              Result := fnfcepdv.EmiteNFCe(vMesChave, vImprimir, fnfcepdv.vpFlacodigo);
              Result := True;

            except
              Result := False;
            end;
          end;
        1:
          begin
            try
              Result := fnfcepdv.ImprimeNFCe(vMesChave, fnfcepdv.vpFlacodigo);
            except
              Result := False;
            end;
          end;
        3:
          begin
            try
              Result := True;
            except
              Result := False;
            end;
          end;

        10:
          begin
            try

              Result := fnfcepdv.ImprimeNFCe(vMesChave, fnfcepdv.vpFlacodigo, True);
            except
              Result := False;
            end;
          end;
        12:
          begin
            Result := True; // fnfcepdv.GeraxmlCont(vMesChave, fnfcepdv.vpFlacodigo);
          end;
        end;

        if Result then
          Break;

      end;

    end;

    end;

  finally

  //  System.Classes.UnRegisterClass(TACBrValidador);
  //  System.Classes.UnRegisterClass(TACBrNFe);
  //  System.Classes.UnRegisterClass(TMemo);
  //  fnfcepdv.Close;
  //  FreeAndNil(fnfcepdv);
  end;
end;

exports modulonfce;


function Tfnfcepdv.RetornaBandeira(aCodigo:Integer):TpcnBandeiracartao;
begin

  case aCodigo of
    1:Result:=bcVisa;
    2:Result:=bcMasterCard;
    3:Result:=bcAmericanExpress;
    4:Result:=bcSorocred;
    5:Result:=bcDinersClub;
    6:Result:=bcElo;
    7:Result:=bcHipercard;
    8:Result:=bcAura;
    9:Result:=bcCabal;
    10:Result:=bcAlelo;
    11:Result:=bcBanesCard;
    12:Result:=bcCalCard;
    13:Result:=bcCredz;
    14:Result:=bcDiscover;
    15:Result:=bcGoodCard;
    16:Result:=bcGreenCard;
    17:Result:=bcHiper;
    18:Result:=bcJcB;
    19:Result:=bcMais;
    20:Result:=bcMaxVan;
    21:Result:=bcPolicard;
    22:Result:=bcRedeCompras;
    23:Result:=bcSodexo;
    24:Result:=bcValeCard;
    25:Result:=bcVerocheque;
    26:Result:=bcVR;
    27:Result:=bcTicket;
    99:Result:=bcOutros;
  end;

end;



function Tfnfcepdv.VerificaValidadeCertificado: Boolean;
var
  vldia: TdateTime;
  vlVcnto: TdateTime;
begin

  try
    LerConfiguracaonfce;

    vldia := ACBrNFeNfce.SSL.CertDataVenc;

    vlVcnto := IncDay(now(), 15);

    if vldia <= vlVcnto then
    begin

      application.MessageBox(PChar('FAVOR RENOVAR CERTIFICADO DIGITAL.' + #13 + #13 + #13 + 'DATA DE VENCIMENTO: ' + datetimetostr(vldia)),
        'A T E N Ç Ã O !', MB_OK + MB_ICONERROR);
      Result := False;
    end
    else
    begin
      Result := True;
    end;

  except
    on e: Exception do
    begin
      Result := False;

      // Application.MessageBox(PChar('Falha de verficacação de validade do certifiacdo.'), 'FALHA', MB_OK + MB_ICONERROR);
    end;
  end;

end;


function RoundCurrency(const Value: Currency): Currency;
var
  V64: Int64 absolute Result;
  Decimals: Integer;
begin
  Result := Value;
  Decimals := V64 mod 100;
  Dec(V64, Decimals);
  case Decimals of
    - 99 .. -50:
      Dec(V64, 100);
    50 .. 99:
      Inc(V64, 100);
  end;
end;


procedure Tfnfcepdv.ajustaConexoes;
var
  i: Integer;
begin
  for i := 0 to self.ComponentCount - 1 do
  begin
    if self.Components[i] is TUniQuery then
    begin
      (self.Components[i] as TUniQuery).Connection := zcone;
    end;
  end;

end;

function Tfnfcepdv.DefineVertical: String;
begin
  Result := 'Mercato';
end;




procedure Tfnfcepdv.VerifieAjustaICM;
var
  vlcfop: string;
  vlcstcodigo: string;
  vlcsicodigo: string;
  vlcspcodigo: string;
  vlcsfcodigo: string;
  vlcfgpercentualpis: string;
  vlcfgpercentualcofins: string;
begin

    itm.Close;
    itm.Params[0].AsString := vpMesChave;
    itm.Params[1].AsInteger := Acesso.Filial;
    itm.Open;

    itm.First;

    While Not itm.Eof Do
    Begin
      // Fran: 03/10/2022 - quando o veritical for boutique vai gerar a nota com CFOP de dentro do estado.
      consulta.Close;
      consulta.SQL.Text := 'SELECT p.procodigo, p.pronome, p.cfocfop, p.cfocfopfora,p.icmcodigo ,p.icmcodigofora, ';
      consulta.SQL.add('(SELECT icmaliquotas FROM icm c WHERE p.icmcodigo=c.icmcodigo) icmaliquota, ');
      consulta.SQL.add('(SELECT icmaliquotas FROM icm i WHERE p.icmcodigofora=i.icmcodigo) icmaliquotafora, ');
      consulta.SQL.add('p.propercreducaobaseicm, cstcodigo,csicodigo,cspcodigo,csfcodigo,propisaliquota, procofinsaliquota  ');
      consulta.SQL.add('from pro p where p.procodigo=' + itmprocodigo.AsString);
      consulta.Open;

      vlcstcodigo := consulta.FieldByName('cstcodigo').AsString;
      vlcsicodigo := consulta.FieldByName('csicodigo').AsString;
      vlcspcodigo := consulta.FieldByName('cspcodigo').AsString;
      vlcsfcodigo := consulta.FieldByName('csfcodigo').AsString;

      vlcfgpercentualpis := consulta.FieldByName('propisaliquota').AsString;
      vlcfgpercentualcofins := consulta.FieldByName('procofinsaliquota').AsString;

      itm.Edit;
      itmcstcodigo.AsString := vlcstcodigo;

      itmcsicodigo.AsString := consulta.FieldByName('csicodigo').AsString;
      itmcspcodigo.AsString := consulta.FieldByName('cspcodigo').AsString;
      itmcsfcodigo.AsString := consulta.FieldByName('csfcodigo').AsString;

      itmitmaliqpis.AsFloat := consulta.FieldByName('propisaliquota').AsFloat;
      itmitmaliqcofins.AsFloat := consulta.FieldByName('procofinsaliquota').AsFloat;

      if itmitmaliqpis.AsString <> '0' then
      begin
        itmitmpis.AsFloat := ((itmitmvalor.AsCurrency * itmitmquantidade.AsFloat) - itmitmdesconto.AsCurrency + itmitmfrete.AsCurrency +
          itmitmoutras.AsCurrency) * (itmitmaliqpis.AsFloat / 100);
        itmitmbpis.AsCurrency := ((itmitmvalor.AsCurrency * itmitmquantidade.AsFloat) - itmitmdesconto.AsCurrency + itmitmfrete.AsCurrency +
          itmitmoutras.AsCurrency);
      end
      else
      begin
        itmitmpis.AsFloat := 0;
        itmitmbpis.AsCurrency := 0;
      end;

      if itmitmaliqcofins.AsString <> '0' then
      begin

        itmitmcofins.AsFloat := ((itmitmvalor.AsCurrency * itmitmquantidade.AsFloat) - itmitmdesconto.AsCurrency + itmitmfrete.AsCurrency +
          itmitmoutras.AsCurrency) * (itmitmaliqcofins.AsFloat / 100);
        itmitmbcofins.AsCurrency := ((itmitmvalor.AsCurrency * itmitmquantidade.AsFloat) - itmitmdesconto.AsCurrency + itmitmfrete.AsCurrency +
          itmitmoutras.AsCurrency);
      end
      else
      begin
        itmitmcofins.AsFloat := 0;
        itmitmbcofins.AsCurrency := 0;
      end;
      itm.Post;

      if (lowercase(consulta.FieldByName('icmcodigo').AsString) <> 'ff') and (lowercase(consulta.FieldByName('icmcodigo').AsString) <> 'nn') and
        (lowercase(consulta.FieldByName('icmcodigo').AsString) <> 'ii') then
      begin

        itm.Edit;

        itmicmcodigo.AsString := consulta.FieldByName('icmcodigo').AsString;
        itmitmaliqicm.AsString := consulta.FieldByName('icmaliquota').AsString;

        if (mesttocodigo.AsInteger = ttoVenda) then
        begin
          itmcfocfop.AsString := consulta.FieldByName('cfocfop').AsString;
        end;

        if itmitmaliqicm.AsString <> '' then
        begin
          if itmitmaliqicm.AsFloat > 0 then
          begin

            itmitmbicm.AsCurrency := ((itmitmvalor.AsCurrency * itmitmquantidade.AsFloat) - itmitmdesconto.AsCurrency + itmitmfrete.AsCurrency +
              itmitmoutras.AsCurrency);

            itmitmpercreducaobaseicm.AsFloat := consulta.FieldByName('propercreducaobaseicm').AsFloat;
            if itmitmpercreducaobaseicm.AsFloat > 0 then
            begin
              itmitmbicm.AsCurrency := itmitmbicm.AsCurrency - (itmitmbicm.AsCurrency * (itmitmpercreducaobaseicm.AsFloat / 100))
            end;

            itmitmicm.AsFloat := itmitmbicm.AsCurrency * (itmitmaliqicm.AsFloat / 100);

          end
          else
          begin
            itmitmpercreducaobaseicm.AsFloat := 0;
            itmitmbicm.AsCurrency := 0;
            itmitmicm.AsFloat := 0;
          end;
        end
        else
        begin
          itmitmpercreducaobaseicm.AsFloat := 0;
          itmitmbicm.AsCurrency := 0;
          itmitmicm.AsFloat := 0;
        end;

        if itmproproducao.AsInteger = 1 then
        begin
          itmtoecodigo.AsString := cfgcfgtoeinteproducaopropria.AsString;
        end;

        itm.Post;
      end;

      itm.Next;
    end;

    consulta.Close;
    consulta.SQL.Text := 'update mes set ';
    consulta.SQL.add('mesbicm=(select sum(itmbicm) from itm where mes.meschave=itm.meschave and meschave=' + mesmeschave.AsString + ') ');
    consulta.SQL.add('  ,mespis=(select sum(itmpis) from itm where mes.meschave=itm.meschave and meschave=' + mesmeschave.AsString + ') ');
    consulta.SQL.add('  ,mescofins=(select sum(itmcofins) from itm where mes.meschave=itm.meschave and meschave=' + mesmeschave.AsString + ') ');
    consulta.SQL.add('  where meschave=' + mesmeschave.AsString);
    consulta.ExecSQL;

end;


{
function Tfnfcepdv.ValidaConsumidor(vMesChave: string; vFlaCodigo: String = '1'): Boolean;
var
  vlNrDoc: string;
  vlNrCEP: string;

begin

  if cfgcfgtributacaoimendes.AsInteger = 0 then
  begin

    mes.Close;
    mes.Params[0].AsString := vMesChave;
    mes.Open;

    etd.Close;
    etd.ParamByName('etdcodigo').AsInteger := mesetdcodigo.AsInteger;
    etd.ParamByName('edritem').AsInteger := mesedritem.AsInteger;
    etd.Open;

    if trim(lowercase(etdetdidentificacao.AsString)) <> 'consumidor' then
    begin

      vlNrDoc := SomenteNumeros(self.etdetddoc1.AsString);

      case Length(vlNrDoc) of
        11:
          ACBrValidador.TipoDocto := docCPF;
        14:
          ACBrValidador.TipoDocto := docCNPJ;
      end;

      if vlNrDoc <> '0' then
      begin
        ACBrValidador.Documento := vlNrDoc;

        if not ACBrValidador.Validar then
        begin
          application.MessageBox(PChar('Erro preenchimento dos dados da NFC-e.' + #13 + #13 + #13 + 'Número do documento inválido para o Cliente:' +
            #13 + #13 + etdetdidentificacao.AsString), 'Emissão como CONSUMIDOR', MB_OK + MB_ICONERROR);
          Result := False;
          Exit;
        end;
        Result := True;
      end
      else
      begin
        Result := False;
      end;

    end
    else
    begin
      Result := True;
    end;

  end
  else
  begin
    Result := True;
  end;
end;
}

function Tfnfcepdv.GeraxmlCont(vChaveNFE: string; vFlaCodigo: string = '1'): Boolean;
begin
  try
    Result := False;

    if not vpConsultouSEFAZ then
    begin
      vpConsultaVisivel := False;

    end;

    PlTitulo.Caption := 'Gerar NFC-e';

    fnfcepdv.Show;

    plestagio.Caption := 'Carga dos dados';

    mes.Close;
    mes.Params[0].AsString := vChaveNFE;
    mes.Open;

    plestagio.Caption := 'Ajusta pastas';

    (* Ajusta caminho para poder localizar arquivo com base na data do campo mesregistro *)
    AjustaCaminhoGeralNF(self.mesmesregistro.AsFloat);

    (* Ajusta caminho para data atual pois não é uma NFE válida *)
    AjustaCaminhoGeralNF(vpDataAtual);

    plestagio.Caption := 'Gera NFC-e';

    (* Se retornou erro na geração da NFCe abandona *)
    if not GeraNFCe(vChaveNFE, fnfcepdv.vpFlacodigo) then
      Exit;

    (*
      Identifica situação do Web Service da SEFAZ
      Se não estiver normal salva NFe como Contingência
    *)
    // vpWSNormal := False;



    if not vpWSNormal then
    begin
      plestagio.Caption := 'Salva em contingencia';


      if self.SalvaEmCoontigencia(ACBrNFeNFCe, vChaveNFE) then
      begin

        vpNomeArquivoNFCe := GeraNomeArqNFCe(vChaveNFE, vFlaCodigo);
        Result := True;

      end;

    end
    else
    begin

      if self.SalvaNormal(ACBrNFeNFCe, vChaveNFE, vFlaCodigo) then
      begin
        plestagio.Caption := 'Salva normal';
        vpNomeArquivoNFCe := GeraNomeArqNFCe(vChaveNFE, vFlaCodigo);
        Result := True;
      end;


    end;
  finally

    fnfcepdv.Close;
  end;

end;

function Tfnfcepdv.GeraNomeNFCe: string;
var
  vlArqNFCe: String;
  vData: double;
  vlCNPJ: String;
  vlNrNFCe, vlNrSer, vlCodigoNFCe: Integer;

  vlUfCod: string;

begin
  vlArqNFCe := '';

  try

    if mesmesdatanfe.AsFloat = 0 then
      vData := mesmesregistro.AsFloat
    else
      vData := mesmesdatanfe.AsFloat;

    if FileExists(vlArqNFCe) then
      Exit;

    (* Tenta encontrar arquivo da NFCe com geração NORMAL *)
    vlCNPJ := SomenteNumeros(self.cfgetddoc1.AsString);
    vlUfCod := Copy(self.cfgcddcodigo.AsString, 1, 2);

    vlNrNFCe := mesmesnumero.AsInteger;
    vlCodigoNFCe := mesmescodigonota.AsInteger;

    if mesmesserie.AsString <> '' then
      vlNrSer := mesmesserie.AsInteger
    else
      vlNrSer := 1;

    vlCNPJ := SomenteNumeros(vlCNPJ);

    vlArqNFCe := Copy(vlUfCod, 1, 2);
    vlArqNFCe := vlArqNFCe + formatdatetime('yymm', vData);
    vlArqNFCe := vlArqNFCe + vlCNPJ;
    vlArqNFCe := vlArqNFCe + '65';
    vlArqNFCe := vlArqNFCe + FormatFloat('000', vlNrSer);
    vlArqNFCe := vlArqNFCe + FormatFloat('000000000', vlNrNFCe);
    vlArqNFCe := vlArqNFCe + '9';
    vlArqNFCe := vlArqNFCe + FormatFloat('00000000', vlCodigoNFCe);
    vlArqNFCe := vlArqNFCe + Modulo11(trim(vlArqNFCe));

  finally
    Result := vlArqNFCe;
  end;
end;

procedure Tfnfcepdv.GeraNomeArqsEvento;
var
  vPathXML: String;
  vPathPDF: String;
  vTipoEvento: String;

begin

  if qEnfMev.Active then
    qEnfMev.Refresh
  else
  begin
    qEnfMev.ParamByName('meschave').AsString := vpMesChave;
    qEnfMev.Open;
    qEnfMev.Last;

  end;

  vPathXML := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', qEnfMevmesregistro.AsFloat) + '\';
  vpArquivoXMLEvento := vPathXML + qEnfMevenfchaveevento.AsString + '-ProcEventoNFe.xml';

  vpArquivoNFce := GeraNomeNFCe;

  vTipoEvento := IfThen(qEnfMevtencodigo.AsInteger = tenCCe, 'CCe', 'Cancelamento');
  vPathPDF := vpPastaPrincipal + '\pdfs\' + vTipoEvento + '\';
  vpArquivoPDFEvento := vPathPDF + qEnfMevenfchaveevento.AsString + '-ProcEventoNFe.pdf';
end;

procedure Tfnfcepdv.ImprimeEventoNfe(vlArquivoNFce: string);
var
  vTipoEvento: String;
  vlArquivoXMLEvento: String;
begin
  if not LerConfiguracaoNFCe then
    Exit;

  if vlArquivoXMLEvento = '' then
    GeraNomeArqsEvento;

  if not FilesExists(vlArquivoXMLEvento) then
  begin
    application.MessageBox(PChar('Não foi possível imprimir o Evento selecionado.' + #13 + 'Arquivo XML não localizado.'), 'ATENÇÃO',
      MB_OK + MB_ICONWARNING);
    Exit;
  end;

  ACBrNFeNFCe.NotasFiscais.Clear;
  ACBrNFeNFCe.NotasFiscais.LoadFromFile(vlArquivoNFce);
  ACBrNFeDANFCEFR1.Site:=self.dtl.FieldByName('ltechave').AsString;

  ACBrNFeNFCe.EventoNFe.Evento.Clear;
  ACBrNFeNFCe.EventoNFe.LerXML(vlArquivoXMLEvento);
  ACBrNFeNFCe.ImprimirEvento;

  vTipoEvento := IfThen(ACBrNFeNFCe.EventoNFe.Evento.Items[0].infEvento.tpEvento = teCCe, 'CCe', 'Cancelamento');
  ACBrNFeNFCe.DANFE.PathPDF := vpPastaPrincipal + '\pdfs\' + vTipoEvento;

  ACBrNFeNFCe.ImprimirEventoPDF;

  ACBrNFeNFCe.NotasFiscais.Clear;
  ACBrNFeNFCe.EventoNFe.Evento.Clear;

end;

procedure Tfnfcepdv.InicializaTabelas;
var
  vlTentativas:Integer;

begin

  vlTentativas := 0;

  while True do
  begin

    try

      TRY
        cfg.Close;
        cfg.ParamByName('flacodigo').AsInteger := Acesso.Filial;
        cfg.Open;
      except
      on E: EAccessViolation do
      begin
        sleep(1000);
        vlTentativas:=vlTentativas+1;


        if vlTentativas>60 then
        Break

       end;
      end;

      TRY
      cfgmnfe.Close;
      cfgmnfe.ParamByName('cfgcodigo').AsString := '1';
      cfgmnfe.Open;

     except
      on E: EAccessViolation do
      begin

        sleep(1000);
        vlTentativas:=vlTentativas+1;
        if vlTentativas>60 then
        Break

      end;
    end;
      if cfgmnfecfgemailnfe.AsString = 'nfe@pegasussistemas.com.br' then
      begin
        TRY
        cfgmnfe.Edit;
        cfgmnfecfgemailnfe.AsString := 'nfe@miziosistemas.com.br';
        cfgmnfecfgemailservidornfe.AsString := 'mail.miziosistemas.com.br';
        cfgmnfecfgemailsenhanfe.AsString := 'MizioXda973*';
        cfgmnfe.Post;
       except
      on E: EAccessViolation do
      begin

        sleep(1000);
        vlTentativas:=vlTentativas+1;
        if vlTentativas>60 then
        Break

      end;
    end;

      end;
      TRY
      trm.Close;
      trm.SQL.Text := 'SELECT DISTINCT tci.tciporta, mit.ecfcodigo, cit.trmcodigo, mit.tipcodigo FROM tci ';
      trm.SQL.add('INNER JOIN mit  ON tci.mitcodigo = mit.mitcodigo ');
      trm.SQL.add('INNER JOIN cit ON cit.tcicodigo = tci.tcicodigo ');
      trm.SQL.add('WHERE  tci.trmcodigo = ' + vpTrmCodigo);
      trm.SQL.add(' and  cit.trmcodigo=' + vpTrmCodigo);
      trm.SQL.add(' AND mit.tipcodigo=2');
      trm.Open;

     except
      on E: EAccessViolation do
      begin


        sleep(1000);
        vlTentativas:=vlTentativas+1;
        if vlTentativas>60 then
        Break

      end;
    end;
      Panel1.Caption := 'TRM: ' + trmtrmcodigo.AsString + ' Aguarde ...';
     TRY
      if cfg.Active then
      begin

       break;
      end;
    except
      on E: EAccessViolation do
      begin

        sleep(1000);
        vlTentativas:=vlTentativas+1;
        if vlTentativas>60 then
          Break

      end;
    end;
    except
      on E: EAccessViolation do
      begin

        sleep(1000);
        vlTentativas:=vlTentativas+1;
        if vlTentativas>60 then
        Break

      end;
    end;
  end;

end;

function Tfnfcepdv.GeraNomeArqNFCe(vMesChave: string; vFlaCodigo: String = '1'): string;
var
  vlArqNFCe: String;
  vData: double;
  vlCNPJ: String;
  vlNrNFCe, vlNrSer, vlCodigoNFCe: Integer;

  vlUfCod: string;

begin
  vlArqNFCe := '';

  try

    if mesmesnumero.AsInteger = 0 then
      Exit;

    if mesmesdatanfe.AsFloat = 0 then
      vData := mesmesregistro.AsFloat
    else
      vData := mesmesdatanfe.AsFloat;

    if mesmeschavenfe.AsString <> '' then
    begin
      vlArqNFCe := mesmeschavenfe.AsString;
      vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe + '-nfe.xml';
    end;

    if FileExists(vlArqNFCe) then
      Exit;

    (* Tenta encontrar arquivo da NFCe com geração NORMAL *)
    vlCNPJ := SomenteNumeros(self.cfgetddoc1.AsString);
    vlUfCod := Copy(self.cfgcddcodigo.AsString, 1, 2);

    vlNrNFCe := mesmesnumero.AsInteger;
    vlCodigoNFCe := mesmescodigonota.AsInteger;

    if mesmesserie.AsString <> '' then
      vlNrSer := mesmesserie.AsInteger
    else
      vlNrSer := 1;

    vlCNPJ := SomenteNumeros(vlCNPJ);

    // nome da nota com emissao normal
    vlArqNFCe := Copy(vlUfCod, 1, 2);
    vlArqNFCe := vlArqNFCe + formatdatetime('yymm', vData);
    vlArqNFCe := vlArqNFCe + vlCNPJ;
    vlArqNFCe := vlArqNFCe + '65';
    vlArqNFCe := vlArqNFCe + FormatFloat('000', vlNrSer);
    vlArqNFCe := vlArqNFCe + FormatFloat('000000000', vlNrNFCe);
    vlArqNFCe := vlArqNFCe + '1';
    vlArqNFCe := vlArqNFCe + FormatFloat('00000000', vlCodigoNFCe);
    vlArqNFCe := vlArqNFCe + Modulo11(trim(vlArqNFCe));
    vlArqNFCe := vlArqNFCe + '-nfe.xml';

    vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe;

    if (cfgcfgservarqnfes.AsString <> '127.0.0.1') and (pos('\', cfgcfgservarqnfes.AsString) = 0) then
    begin
      if ConsultaXMLServidor(cfgcfgservarqnfes.AsString, vlArqNFCe) <> '' then
        Exit;
    end
    else
    begin
      if FileExists(vlArqNFCe) then
        Exit;
    end;

    (* Tenta encontrar arquivo da NFCe com emissão em CONTINGÊNCIA - CÓD 2 *)
    vlArqNFCe := Copy(vlUfCod, 1, 2);
    vlArqNFCe := vlArqNFCe + formatdatetime('yymm', vData);
    vlArqNFCe := vlArqNFCe + vlCNPJ;
    vlArqNFCe := vlArqNFCe + '65';
    vlArqNFCe := vlArqNFCe + FormatFloat('000', vlNrSer);
    vlArqNFCe := vlArqNFCe + FormatFloat('000000000', vlNrNFCe);
    vlArqNFCe := vlArqNFCe + '2';
    vlArqNFCe := vlArqNFCe + FormatFloat('00000000', vlCodigoNFCe);
    vlArqNFCe := vlArqNFCe + Modulo11(trim(vlArqNFCe));
    vlArqNFCe := vlArqNFCe + '-nfe.xml';

    vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe;

    if (cfgcfgservarqnfes.AsString <> '127.0.0.1') and (pos('\', cfgcfgservarqnfes.AsString) = 0) then
    begin
      if ConsultaXMLServidor(cfgcfgservarqnfes.AsString, vlArqNFCe) <> '' then
        Exit;
    end
    else
    begin
      if FileExists(vlArqNFCe) then
        Exit;
    end;

    (* Tenta encontrar arquivo da NFCe com emissão em CONTINGÊNCIA OFFLINE - CÓD 9 *)
    vlArqNFCe := Copy(vlUfCod, 1, 2);
    vlArqNFCe := vlArqNFCe + formatdatetime('yymm', vData);
    vlArqNFCe := vlArqNFCe + vlCNPJ;
    vlArqNFCe := vlArqNFCe + '65';
    vlArqNFCe := vlArqNFCe + FormatFloat('000', vlNrSer);
    vlArqNFCe := vlArqNFCe + FormatFloat('000000000', vlNrNFCe);
    vlArqNFCe := vlArqNFCe + '9';
    vlArqNFCe := vlArqNFCe + FormatFloat('00000000', vlCodigoNFCe);
    vlArqNFCe := vlArqNFCe + Modulo11(trim(vlArqNFCe));
    vlArqNFCe := vlArqNFCe + '-nfe.xml';

    vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe;

    if (cfgcfgservarqnfes.AsString <> '127.0.0.1') and (pos('\', cfgcfgservarqnfes.AsString) = 0) then
    begin
      if ConsultaXMLServidor(cfgcfgservarqnfes.AsString, vlArqNFCe) <> '' then
        Exit;
    end
    else
    begin
      if FileExists(vlArqNFCe) then
        Exit;
    end;

    (* Se chegou até aqui é porque arquivo não existe *)

    vlArqNFCe := '';
  finally
    Result := vlArqNFCe;
  end;
end;

function Tfnfcepdv.GeraNomeArqNFCeTipo(vMesChave: string; vTipoEmissao: Integer; vFlaCodigo: string = '1'): string;
var
  vlArqNFCe: String;
  vlData: double;
  vlCNPJ: String;
  vlNrNFCe, vlNrSer: Integer;
  vlUfCod: string;
begin
  mes.Close;
  mes.Params[0].AsString := vMesChave;
  mes.Open;

  if mesmesnumero.AsInteger = 0 then
    Exit;

  if mesmesdatanfe.AsFloat = 0 then
    vlData := mesmesregistro.AsFloat
  else
    vlData := mesmesdatanfe.AsFloat;

  (* Carrega dados para formação do nome do arquivo *)
  vlCNPJ := SomenteNumeros(self.cfgetddoc1.AsString);
  vlUfCod := Copy(self.cfgcddcodigo.AsString, 1, 2);

  vlNrNFCe := mesmesnumero.AsInteger;
  vlNrSer := mesmesserie.AsInteger;
  vlCNPJ := SomenteNumeros(vlCNPJ);

  (* Gera chave *)
  vlArqNFCe := Copy(vlUfCod, 1, 2);
  vlArqNFCe := vlArqNFCe + formatdatetime('yymm', vlData);
  vlArqNFCe := vlArqNFCe + vlCNPJ;
  vlArqNFCe := vlArqNFCe + '65';
  vlArqNFCe := vlArqNFCe + FormatFloat('000', vlNrSer);
  vlArqNFCe := vlArqNFCe + FormatFloat('000000000', vlNrNFCe);

  (* Define o tipo de emissão - 1=Normal 2=Contingencia 9=ContingenciaOffLine *)
  vlArqNFCe := vlArqNFCe + IntToStr(vTipoEmissao);

  vlArqNFCe := vlArqNFCe + FormatFloat('00000000', vlNrNFCe);
  vlArqNFCe := vlArqNFCe + Modulo11(trim(vlArqNFCe));
  vlArqNFCe := vlArqNFCe + '-nfe.xml';

  vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vlData) + '\' + vlArqNFCe;

  Result := vlArqNFCe;
end;

function Tfnfcepdv.ConsultaNFCe(vMesChave, vArqNFCe: String; vFlaCodigo: string = '1'; vMostrar: Boolean = False): Boolean;
Var
  nProt: String;
  vnrnfe: String;
  vchNFe: String;
  vdtNFe: String;
  vhrNFe: String;
  vemiNFe: string;
  vCodStatusNFe: String;
  vMsgStatusNFe: String;
  vRetorno: Boolean;
  vData: TDate;
  vlArqNFCe: string;
Begin
  vRetorno := False;

  try
    If not FileExists(vArqNFCe) Then
    begin

      if mesmesnumero.AsInteger = 0 then
        Exit;

      if mesmesdatanfe.AsFloat = 0 then
        vData := mesmesregistro.AsFloat
      else
        vData := mesmesdatanfe.AsFloat;

      if mesmeschavenfe.AsString <> '' then
      begin
        vlArqNFCe := mesmeschavenfe.AsString;
        vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe + '-nfe.xml';
      end;

    end;

    If not FileExists(vArqNFCe) Then
    begin
      ShowMessage('Arquivo não localizado!' + #13 + #13 + vArqNFCe);
      Exit;
    end;

    ACBrNFeNFCe.NotasFiscais.Clear;
    ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;

    ACBrNFeNFCe.NotasFiscais.LoadFromFile(vArqNFCe);
    ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := False;
    ACBrNFeNFCe.Consultar;

    vdtNFe := datetostr(ACBrNFeNFCe.WebServices.consulta.DhRecbto);
    vhrNFe := TimeToStr(ACBrNFeNFCe.WebServices.consulta.DhRecbto);

    vemiNFe := Copy(datetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10);
    // Fran 22/11/2022 - adiciona a data de emissao no campo mesdatanfe

    nProt := ACBrNFeNFCe.WebServices.consulta.Protocolo;
    vchNFe := ACBrNFeNFCe.WebServices.consulta.NFeChave;

    vCodStatusNFe := IntToStr(ACBrNFeNFCe.WebServices.consulta.CStat);
    vMsgStatusNFe := ACBrNFeNFCe.WebServices.consulta.xMotivo;

    vnrnfe := IntToStr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.nNF);

    (* Verifica código de retorno é igual a 100 - Uso Autorizado *)
    If (ACBrNFeNFCe.WebServices.consulta.CStat = 150) or (ACBrNFeNFCe.WebServices.consulta.CStat = 100) or
      (ACBrNFeNFCe.WebServices.consulta.CStat = 104) Then
      Try
        vRetorno := True;
        vhrNFe := TimeToStr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi);
        vdtNFe := Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.protNFe.DhRecbto), 1, 10);

        if (ACBrNFeNFCe.WebServices.consulta.CStat = 150) then
        begin
          vdtNFe := Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.protNFe.DhRecbto), 1, 10);
          vhrNFe := TimeToStr(ACBrNFeNFCe.WebServices.consulta.protNFe.DhRecbto);
          vemiNFe := Copy(datetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10);
        end
        else
        begin
          vdtNFe := Copy(datetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10);
          vhrNFe := TimeToStr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi);
          vemiNFe := Copy(datetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10);
        end;
        {
        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=1';
        consulta.ExecSQL;
        }
        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';

        consulta.SQL.add('mesregistro = ''' + vdtNFe + ''', ');
        consulta.SQL.add('mesdatanfe = ''' + vemiNFe + ''', ');
        consulta.SQL.add('meshoranfe = ' + QuotedStr(vhrNFe) + ', ');

        consulta.SQL.add('meschavenfe = ''' + vchNFe + ''', ');
        consulta.SQL.add('tdfcodigo = ''65'', ');
        consulta.SQL.add('temcodigo = 5, ');
        consulta.SQL.add('mesprotocolo = ''' + nProt + ''' WHERE ');
        consulta.SQL.add('meschave = ' + vMesChave) ;
        consulta.ExecSQL;
        {
        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=null';
        consulta.ExecSQL;
        }
        consulta.Close;
        consulta.SQL.Text := 'select mesregistro,mesnumero, meschavenfe,tdfcodigo,mesprotocolo from mes where meschave=' + vMesChave;
        consulta.Open;

        if vMostrar then
        begin

          ShowMessage('Registro: ' + consulta.Fields[0].AsString + ''#13'' + (* *)
            'Nr. NFE: ' + consulta.Fields[1].AsString + ''#13'' + (* *)
            'Chave  : ' + consulta.Fields[2].AsString + ''#13'' + #13 + #13 + (* *)
            'Código Status: ' + vCodStatusNFe + #13 + (* *)
            'Status - NFE : ' + vMsgStatusNFe + #13 + (* *)
            'Protocolo Nr.: ' + nProt + #13 + (* *)
            'Data  e  Hora: ' + vdtNFe + ' - ' + vhrNFe);

        end;

      Except
      End;
  finally
    Result := vRetorno;
  end;
End;

function Tfnfcepdv.EmiteNFCe(vMesChave: string; vImprimir: Boolean; vFlaCodigo: string = '1'): Boolean;
begin

  try

    Result := False;

    PlTitulo.Caption := 'Gerar NFC-e';
    info.Lines.add('Inicio: ' + datetimetostr(now));
    fnfcepdv.Show;

    mostra.max := 10;
    application.ProcessMessages;

    mostra.position := 2;
    application.ProcessMessages;


    // AjustaCaminhoGeralNF(Self.mesmesregistro.AsFloat);

    mostra.position := 3;
    application.ProcessMessages;

    mostra.position := 4;
    application.ProcessMessages;

    AjustaCaminhoGeralNF(vpDataAtual);

    info.Lines.add('Gerando NFCE: ' + datetimetostr(now));


    (* Se retornou erro na geração da NFCe abandona *)

    if ConsultaServicoSEFAZNFCE(False)<>'' then
    begin

      vpWSNormal:=true;

      fnfcepdv.vpConsultouSEFAZ := True;

    end;



    if not GeraNFCe(vMesChave, fnfcepdv.vpFlacodigo) then
      Exit;

    mostra.position := 5;
    application.ProcessMessages;

    if not vpWSNormal then
    begin
      plestagio.Caption := 'Salva em contingencia';
      mostra.position := 6;
      application.ProcessMessages;

      if self.SalvaEmCoontigencia(ACBrNFeNFCe, vMesChave) then
      begin

        vpNomeArquivoNFCe := GeraNomeArqNFCe(vMesChave, vFlaCodigo);

        plestagio.Caption := 'Imprime a nota';

        info.Lines.add('Imprimindo NFCE CONTINGENCIA: ' + datetimetostr(now));


        ImprimeNFCe(vMesChave, fnfcepdv.vpFlacodigo);

        info.Lines.add('NFCE Impressa: ' + datetimetostr(now));

        Result := True;

      end;
    end
    else if self.SalvaNormal(ACBrNFeNFCe, vMesChave) then
    begin

      mostra.position := 7;
      application.ProcessMessages;

      plestagio.Caption := 'Salva normal';

      info.Lines.add('Imprimindo NFCE NORMAL: ' + datetimetostr(now));

      vpNomeArquivoNFCe := GeraNomeArqNFCe(vMesChave, vFlaCodigo);
      mostra.position := 8;
      application.ProcessMessages;

      ImprimeNFCe(vMesChave, fnfcepdv.vpFlacodigo);

      info.Lines.add('NFCE Impressa: ' + datetimetostr(now));

      Result := True;
    end;
  finally
    mostra.position := 10;
    application.ProcessMessages;

    if not DirectoryExists(ExtractFilePath(application.ExeName) + 'logsnfce') then
      ForceDirectories(ExtractFilePath(application.ExeName) + 'logsnfce');

    info.Lines.SaveToFile(ExtractFilePath(application.ExeName) + 'logsnfce\' + formatdatetime('yyyymmddnnss', now()) + '.txt');

    fnfcepdv.Close;

  end;

end;

procedure Tfnfcepdv.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  inherited;
  Action := cafree;
end;

procedure Tfnfcepdv.FormShow(Sender: TObject);
begin


  inherited;
  self.Width := 620;
  self.Height := 230;

  ACBrNFeDANFCEFR1.Sistema := '(66)3544-2765 Mizio Sistemas';


end;


Procedure Tfnfcepdv.CarregaOpcoesPadroes;
Var
  Arquini: Tinifile;
Begin
  try

    Arquini := Tinifile.Create(Extractfilepath(Application.ExeName) + 'mercatoerp.ini');
    With Arquini Do
    Begin
      vpimprimenfce := ReadString('posi', 'imprimenfce', 'sim');
    End;
    Arquini.Free;

  finally

  end;
End;

Procedure Tfnfcepdv.GravaOpcoesPadroes;
Var
  Arquini: Tinifile;
Begin
  try

    Arquini := Tinifile.Create(Extractfilepath(Application.ExeName) + 'mercatoerp.ini');
    With Arquini Do
    Begin
       writeString('posi', 'imprimenfce', vpimprimenfce);
    End;
    Arquini.Free;

  finally

  end;

End;



function Tfnfcepdv.ImprimeNFCe(vMesChave: string; vFlaCodigo: string = '1'; vVisualizar: Boolean = False): Boolean;
var
  vlArqCompro: string;


begin

{  cfg.Close;
  cfg.ParamByName('flacodigo').AsInteger := Acesso.Filial;
  cfg.Open;}

  Result := False;

  mes.Close;
  mes.Params[0].AsString := vMesChave;
  mes.Open;

  AjustaCaminhoGeralNF(self.mesmesregistro.AsFloat);
  vpNomeArquivoNFCe := self.GeraNomeArqNFCe(vMesChave, vFlaCodigo);


  if not FileExists(vpNomeArquivoNFCe) then
  begin
    if (cfgcfgservarqnfes.AsString <> '127.0.0.1') and (pos('\', cfgcfgservarqnfes.AsString) = 0) then
    begin

      try

        vpNomeArquivoNFCe := BaixaXMLServidor(cfgcfgservarqnfes.AsString, vpNomeArquivoNFCe);

        if not FileExists(vpNomeArquivoNFCe) then
        begin
          vpNomeArquivoNFCe := '';
        end;

      except
      on e: Exception do
    begin

        vpNomeArquivoNFCe := '';
    end;
      end;

    end;

  end;



  if not FileExists(vpNomeArquivoNFCe) then
  begin

    if vpNomeArquivoNFCe = '' then
    begin
      ShowMessage('1681 - Arquivo XML da nota não localizado.' + #13 + 'Verifique a comunucação com servidor em ' + cfgcfgservarqnfes.AsString + '!');
      Exit;
    end;
  end;

  If FileExists(ExtractFilePath(application.ExeName) + 'report\DANFeNFCe.fr3') Then
  Begin

    qDtl.Close;
    qDtl.SQL.Clear;
    qDtl.SQL.add('SELECT distinct lte.ltechave, lte.ltetroco, lte.ltevalortaxa ');
    qDtl.SQL.add('  FROM rfm ');
    qDtl.SQL.add(' INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
    qDtl.SQL.add(' INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
    qDtl.SQL.add(' INNER JOIN lte ON mlt.ltechave = lte.ltechave ');
    qDtl.SQL.add(' WHERE rfm.meschave = ' + vMesChave);
    qDtl.Open;

    ACBrNFeDANFCEFR1.MostraSetup := False;
    ACBrNFeDANFCEFR1.MostraPreview := False;
    ACBrNFeDANFCEFR1.MostraStatus := False;

    ACBrNFeDANFCEFR1.FastFile := ExtractFilePath(application.ExeName) + 'report\DANFeNFCe.fr3';


    If FileExists(ExtractFilePath(application.ExeName) + 'logonfce.jpg') Then
      ACBrNFeDANFCEFR1.Logo := ExtractFilePath(application.ExeName) + 'logonfce.jpg';

    ACBrNFeNFCe.NotasFiscais.Clear;

    ACBrNFeNFCe.NotasFiscais.LoadFromFile(vpNomeArquivoNFCe);

    ACBrNFeDANFCEFR1.ViaConsumidor:=false;
    ACBrNFeDANFCEFR1.NumCopias:=1;
    ACBrNFeDANFCEFR1.MostraPreview := False;
    ACBrNFeDANFCEFR1.MostraStatus := False;


    ACBrNFeDANFCEFR1.Impressora:=BuscaIMpressoraPadrao;

    CarregaOpcoesPadroes;

    fnfcePDVComprovante := TfNFCePDVComprovante.Create(Self);

    try
      fnfcePDVComprovante.plMensagem.caption:= 'Imprimir NFC-e ?';

      if lowercase(vpimprimenfce)='sim' then
      begin
        fnfcePDVComprovante.ActiveControl:=fnfcePDVComprovante.btOK;
      //  fnfcePDVComprovante.btOK.SetFocus;
      end
      else
      begin
        fnfcePDVComprovante.ActiveControl:=fnfcePDVComprovante.btCancel;
      //  fnfcePDVComprovante.btCancel.SetFocus;
      end;

      if fnfcePDVComprovante.ShowModal=mrok then
      begin
        ACBrNFeNFCe.NotasFiscais.Imprimir;
        vpimprimenfce:='Sim';
        GravaOpcoesPadroes;
      end
      else
      begin
        vpimprimenfce:='Não';
        GravaOpcoesPadroes;
      end;

    finally
      fnfcePDVComprovante.Free;
    end;










    ACBrNFeDANFCEFR1.PathPDF := vpPastaPrincipal + 'pdfs\';
    ACBrNFeNFCe.NotasFiscais.ImprimirPDF;
    ACBrNFeNFCe.NotasFiscais.Clear;

    Result := True;

    if cfgcfgviaassinar.AsInteger = 0 then
      Exit;


  End;
end;

procedure Tfnfcepdv.Inicializar;
var
 vlTentativas:integer;
begin

  vlTentativas:=0;

  while True do
  begin
    cfg.Close;
    cfg.ParamByName('flacodigo').AsString := Acesso.Filial.ToString;
    cfg.Open;

    if cfg.Active then
    begin
     break;
    end
    else
    begin

      try
        cfg.Connection.Connected:=true;
        cfg.Open;
      except
        sleep(1000);
      end;

      vlTentativas:=vlTentativas+1;


      if vlTentativas>60 then
      exit
    end;
  end;

end;

Function Tfnfcepdv.validatemprodutos: Boolean;
Begin
  consulta.Close;
  consulta.SQL.Text := 'select  count(itmchave) qtd from itm,pro where itm.procodigo=pro.procodigo and tpocodigo<>' + IntToStr(tpoServicos) +
    '  and meschave=' + mesmeschave.AsString;
  consulta.Open;

  if consulta.FieldByName('qtd').AsInteger = 0 then
  begin
    Result := False;
  end
  else
  begin
    Result := True;
  end;

End;

function Tfnfcepdv.GeraNFCe(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
Var
  vErro: String;
  vMensagemErro: String;

  vMsgRetorno: String;

  vNumeroNFe: Integer;
  vChaveNFE: String;
  vProtocoloNFe: String;

  (* Acumuladores - Totais NFCe *)
  vlQtdItens: Integer;

  vlTotBC: double;
  vlTotICMS: double;

  vlTotDesc: double;
  vlTotBruto: double;
  vlTotLiq: double;

  (* Carga Tributária *)
  vlTotTrib: double;
  vlTotTribEst: double;
  vlMensagemCargaTrib: string;
  vlMensagemCartoes: string;

  (* Retornos da SEFAZ *)
  vCStat: Integer;
  vXMotivo: String;

  vDinheiro: double;
  vVoucher: double;

  vChequeProprio: double;
  vChequeTerceiros: double;
  vCartaoDebito: double;
  vCartaoCredito: double;
  vPIX: double;
  vConvenio: double;
  vAFaturar: double;
  vlTroco: double;
  vTrocaDevolucao: double;
  vVale: double;
  vDoacao: double;
  vCredito: double;

  vlTotalItens: double;
  vlTotalFinalizadores: double;

  vlValorDiferenca: double;

  (* CST e CSOSN *)
  vlCSTIcmsOK: Boolean;
  vlCSTIcms: TpcnCSTIcms;

  vlCSOSNIcmsOK: Boolean;
  vlCSOSNIcms: TpcnCSOSNIcms;
  ok: Boolean;

  { * exibe limite do cliente * }
  vlMensagemLimite: string;
  vlDatatual: string;

  vlcspcodigo: string;
  vlcsfcodigo: string;

  vlcfgpercentualpis: string;

  vlcfgpercentualcofins: string;
  vlNFCeProtocolo: string;
  vlNFCeChave: string;

  vlOutras: Currency;

  // vlAgora: String;

  vlMensagemReducaoBase: STRING;
  vlReducoes: TStringList;
  iReduz: Integer;

  vlTotalFrete: Currency;
  vlTotalTaxa: Currency;
  vlTotalLote: Currency;
  vlMensagemicmreducao: string;

  vltotaltaxaacumulado: Currency;
  vldiferencataxa: Currency;


  vlCodigoTagPagamento: Integer;
  vlCodigoTagOK: Boolean;

Begin
  info.Lines.add('Inicio abertura tabelas: ' + datetimetostr(now));

  Result := False;
  vlTotalTaxa := 0;

  vlQtdItens := 0;

  vlTotBC := 0;
  vlTotICMS := 0;

  vlTotDesc := 0;
  vlTotBruto := 0;
  vlTotLiq := 0;

  vlTotTrib := 0;
  vlTotTribEst := 0;
  vlMensagemCargaTrib := '';
  vlNFCeProtocolo := '';
  vlNFCeChave := '';



  //
  // ****** Carrega consulta da tabela mes e itm ********
  //

  cfg.Close;
  cfg.ParamByName('flacodigo').AsInteger := Acesso.Filial;
  cfg.Open;

  itm.Close;
  itm.Params[0].AsString := vMesChave;
  itm.Params[1].AsString := vFlaCodigo;
  itm.Open;

  vlReducoes := TStringList.Create;

  itm.First;
  while not itm.Eof do
  begin
    consulta.Close;
    consulta.SQL.Text := 'select propercreducaobaseicm from pro where propercreducaobaseicm>0 and procodigo=' + itmprocodigo.AsString;
    consulta.Open;
    if not consulta.IsEmpty then
    begin
      vlReducoes.add(floattostr(100 - consulta.FieldByName('propercreducaobaseicm').AsFloat) + '%');
    end;

    itm.Next;
  end;

  itm.First;

  etd.Close;
  etd.ParamByName('etdcodigo').AsInteger := mesetdcodigo.AsInteger;
  etd.ParamByName('edritem').AsInteger := mesedritem.AsInteger;
  etd.Open;

  if (cfgetddoc1.AsString = etdetddoc1.AsString) and (cfgetddoc1.AsString<>'') then
  begin
    ShowMessage('Não é permitido emitir NFCe para a prórpria empresa!');

    Exit;
  end;

  mic.Close;
  mic.Params[0].AsString := vMesChave;
  mic.Open;

  oic.Close;
  oic.Params[0].AsString := vMesChave;
  oic.Open;

  if mes.Active then
  begin
    if mestoecodigo.AsString <> '' then
    begin
      toe.Close;
      toe.SQL.Text := 'select ttecodigo,toeidentificacao,toecodigo,ttocodigo from toe where toecodigo=' + mestoecodigo.AsString;
      toe.Open;
    end;
  end;

  // vlAgora := agora(application, zcone);

  // info.Lines.add('Tabelas abertas: ' + vlAgora);

  //
  // ***** Inicia GERAÇÃO da NFe *****
  //

  IF validatemprodutos = False then
  begin
    ShowMessage('Não é permitido emissão de nota com apenas SERVIÇOS e sem MERCADORIAS!');
    Exit;
  end;

  vlNFCeProtocolo := mesmesprotocolo.AsString;
  vlNFCeChave := mesmeschavenfe.AsString;

  ACBrNFeNFCe.NotasFiscais.Clear;
  ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;


  try

    With ACBrNFeNFCe.NotasFiscais.add.NFe Do
    Begin




      infRespTec.CNPJ := '14477548000131';
      infRespTec.email := 'mizio@miziosistemas.com.br';
      infRespTec.xContato := 'Mizio Sistemas';
      infRespTec.fone := '6635442765';

      (* !
        *
        ********* Identificação da NFe - IDE ********
        *
      *)

      if mesoricodigo.AsInteger=3 then  // delivery entrega
      begin
        ide.indPres:= pcEntregaDomicilio;
        ide.indIntermed:=iiOperacaoSemIntermediador;

        Dest.EnderDest.CEP := StrToInt(SomenteNumeros(etdedrcep.AsString));
        Dest.EnderDest.xLgr := etdedrrua.AsString;
        Dest.EnderDest.nro := etdedrnumero.AsString;
        Dest.EnderDest.xCpl := '';
        Dest.EnderDest.xBairro := etdedrbairro.AsString;
        Dest.EnderDest.cMun := etdcddcodigo.AsInteger;
        Dest.EnderDest.xMun := etdcddnome.AsString;
        Dest.EnderDest.UF := UpperCase(etdufssigla.AsString);

      end
      else if (mesoricodigo.AsInteger=7) or (mesoricodigo.AsInteger=8)  then  // nuc ou aiqfome
      begin

        ide.indPres:= pcEntregaDomicilio;
        ide.indIntermed:=iiOperacaoComIntermediador;

        Dest.EnderDest.CEP := StrToInt(SomenteNumeros(etdedrcep.AsString));
        Dest.EnderDest.xLgr := etdedrrua.AsString;
        Dest.EnderDest.nro := etdedrnumero.AsString;
        Dest.EnderDest.xCpl := '';
        Dest.EnderDest.xBairro := etdedrbairro.AsString;
        Dest.EnderDest.cMun := etdcddcodigo.AsInteger;
        Dest.EnderDest.xMun := etdcddnome.AsString;
        Dest.EnderDest.UF := UpperCase(etdufssigla.AsString);

        with infIntermed do
        begin

         ori.close;
         ori.ParamByName('oricodigo').AsInteger:=mesoricodigo.AsInteger;
         ori.Open;

         infIntermed.CNPJ:=SoNumeros(orietddoc1.AsString);
         infIntermed.idCadIntTran:=orioriidentificacao.AsString;

        end;

      end
      else    // presencial no salão
      begin
        ide.indPres := pcPresencial;
        ide.indIntermed := iiSemOperacao;
      end;

      ide.cUF := cfgufscodigo.AsInteger;

      ide.natOp := 'VENDA';

      ide.hSaiEnt := vpDataAtual;

      infNFe.Versao := cfgcfgversao.AsFloat;

      if not vpWSNormal then
      begin

        ide.hSaiEnt := vpDataAtual;
        ide.dEmi := vpDataAtual;
        ide.dSaiEnt := vpDataAtual;
        ide.hSaiEnt := vpDataAtual;

        mes.Edit;
        mesmesregistro.AsString := trim(Copy(datetimetostr(vpDataAtual), 1, 10));
        mesmeshoranfe.AsString := trim(Copy(datetimetostr(vpDataAtual), 11, 8));
        mes.Post;

      end
      else
      begin

        if (Copy(vlNFCeProtocolo, 1, 15) <> '000000000000000') and (vlNFCeProtocolo <> '') then
        begin
          ide.hSaiEnt := mesmesdatanfe.AsDateTime;
          ide.dEmi := mesmesdatanfe.AsDateTime;
          ide.dSaiEnt := mesmesdatanfe.AsDateTime;
          ide.hSaiEnt := mesmesdatanfe.AsDateTime;

        end
        else
        begin

          ide.dEmi := vpDataAtual;
          ide.dSaiEnt := vpDataAtual;
          ide.hSaiEnt := vpDataAtual;

        end;
      end;

      vlDatatual := datetimetostr(vpDataAtual);

      ide.indPag := ipVista;
      ide.cUF := UFtoCUF(cfgufssigla.AsString);
      ide.cMunFG := cfgcddcodigo.AsInteger;

      ide.idDest := doInterna;

      ide.finNFe := fnNormal;
      ide.tpImp := tiNFCe;
      ide.indFinal := cfConsumidorFinal;


      ide.modelo := 65;
      ide.serie := cfgcfgserienfce.AsInteger;
      ide.tpNF := tnSaida;



      if vpWSNormal then
      begin

        ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teNormal;
        ide.tpEmis := teNormal;
      end
      else
      begin
        if rec.Active = False then
        begin
          rec.Open;
        end;

        ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teOffLine;
        ide.tpEmis := teOffLine;
        ide.dhCont := mesmesemissao.AsDateTime; // recrecdthoraentrada.AsFloat;
        ide.xJust := 'Falha de comunicação com servidores da SEFAZ.';

      end;

      ide.cMunFG := cfgcddcodigo.AsInteger;

      if cfgcfgmodonfe.AsInteger = 2 then
        ide.tpAmb := taHomologacao;

      if cfgcfgmodonfe.AsInteger = 1 then
        ide.tpAmb := taProducao;

      ide.verProc := '24.27.300.21';

      ctd.Close;
      ctd.Connection := zcone;
      ctd.Open;

      if not ctd.IsEmpty then
      begin
        if (ctdctdcnpj.AsString <> '') and (ctdctdcnpj.AsString <> '0') then
        begin
          try
            if strtofloat(SoNumeros(ctdctdcnpj.AsString)) > 0 then
            begin
              autXML.add.CNPJCPF := SoNumeros(ctdctdcnpj.AsString);
            end;
          except

          end;
        end;
      end;

      (*
        *
        ****** Emitente da NFC-e - EMIT ********
        *
      *)

      Emit.CNPJCPF := SomenteNumeros(cfgetddoc1.AsString);
      Emit.IE := SomenteNumeros(cfgedrinscest.AsString);
      Emit.IEST := '';
      Emit.xNome := cfgetdidentificacao.AsString;
      Emit.xFant := cfgetdapelido.AsString;
      Emit.EnderEmit.fone := cfgetftelefone.AsString;
      Emit.EnderEmit.CEP := StrToInt(SomenteNumeros(cfgedrcep.AsString));
      Emit.EnderEmit.xLgr := cfgedrrua.AsString;
      Emit.EnderEmit.nro := cfgedrnumero.AsString;
      Emit.EnderEmit.xCpl := '';
      Emit.EnderEmit.xBairro := cfgedrbairro.AsString;
      Emit.EnderEmit.cMun := cfgcddcodigo.AsInteger;
      Emit.EnderEmit.xMun := cfgcddnome.AsString;
      Emit.EnderEmit.UF := UpperCase(cfgufssigla.AsString);
      Emit.EnderEmit.cPais := 1058;
      Emit.EnderEmit.xPais := 'BRASIL';

      case cfgcrtcodigo.AsInteger of
        1:
          Emit.CRT := crtSimplesNacional;
        2:
          Emit.CRT := crtSimplesExcessoReceita;
        3:
          Emit.CRT := crtRegimeNormal;
      end;

      (*
        *
        ********* Destinatário da NFe **********
        *
      *)

      if ((trim(lowercase(etdetdidentificacao.AsString)) <> 'consumidor') )   and (trim(lowercase(etdetdidentificacao.AsString)) <> '')   then
      begin
        Dest.indIEDest := inNaoContribuinte;
        Dest.EnderDest.UF := Emit.EnderEmit.UF;
        if Length(SomenteNumeros(self.etdetddoc1.AsString)) >= 11 then
        begin
          Dest.CNPJCPF := SomenteNumeros(self.etdetddoc1.AsString);
          Dest.xNome := etdetdidentificacao.AsString;
        end;

      end
      else
      begin
        if mic.RecordCount = 1 then
        begin
          Dest.indIEDest := inNaoContribuinte;
          Dest.CNPJCPF := SomenteNumeros(self.micidcdoc.AsString);
          Dest.xNome := micidcnome.AsString;
          Dest.EnderDest.UF := Emit.EnderEmit.UF;
        end
        else if oic.RecordCount = 1 then
        begin
          Dest.indIEDest := inNaoContribuinte;
          Dest.CNPJCPF := SomenteNumeros(self.oicidcdoc.AsString);
          Dest.xNome := oicidcnome.AsString;
          Dest.EnderDest.UF := Emit.EnderEmit.UF;
        end;
      end;

      itm.Refresh;
      itm.IndexFieldNames := 'itmchave';
      itm.First;
      vlQtdItens := 1;

      VerifieAjustaICM;

      itm.Close;
      itm.Params[0].AsString := vpMesChave;
      itm.Params[1].AsInteger := Acesso.Filial;
      itm.Open;

      vlTotalTaxa := 0;
      vlTotalLote := 0;
      consulta.Close;
      consulta.SQL.Clear;
      consulta.SQL.add('SELECT lte.ltevalortaxa, lte.ltetotal ');
      consulta.SQL.add('  FROM rfm ');
      consulta.SQL.add(' INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
      consulta.SQL.add(' INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
      consulta.SQL.add(' INNER JOIN lte ON mlt.ltechave = lte.ltechave ');
      consulta.SQL.add(' WHERE rfm.meschave = ' + vMesChave);
      consulta.Open;

      vlTotalTaxa := consulta.FieldByName('ltevalortaxa').AsCurrency;
      vlTotalLote := consulta.FieldByName('ltetotal').AsCurrency;
      vltotaltaxaacumulado := 0;


      itm.First;
      While Not itm.Eof Do
      Begin

        if vlTotalTaxa > 0 then
        begin
          itm.Edit;
          itmitmoutras.AsCurrency := (vlTotalTaxa * (((itmitmvalor.AsCurrency * itmitmquantidade.AsFloat) - itmitmdesconto.AsCurrency) / vlTotalLote));
          itm.Post;

          vltotaltaxaacumulado := vltotaltaxaacumulado + itmitmoutras.AsCurrency;

        end;

        if (cfgcfgusacstnoproduto.AsInteger = 0) and (cfgcfgdefinetoeatendimento.AsInteger = 0) then
        begin

          toeitm.Close;
          toeitm.Connection := zcone;
          toeitm.ParamByName('toecodigo').AsInteger := itmtoecodigo.AsInteger;
          toeitm.Open;

          itmcst.Close;
          itmcst.Connection := zcone;
          itmcst.ParamByName('itmchave').AsInteger := itmitmchave.AsInteger;
          itmcst.Open;

          if itmtcecest.AsString <> '' then
          begin

            itmcst.Edit;

            itmcstcstcodigo.AsString := toeitmcstcodigo.AsString;
            itmcstcsicodigo.AsString := toeitmcsicodigo.AsString;

            itmcstcspcodigo.AsString := toeitmcspcodigo.AsString;
            itmcstcsfcodigo.AsString := toeitmcsfcodigo.AsString;
            itmcstitmaliqpis.AsFloat := toeitmcfgpercentualpis.AsFloat;
            itmcstitmaliqcofins.AsFloat := toeitmcfgpercentualcofins.AsFloat;

            itmcst.Post;
          end;

        end
        else
        begin

          toeitm.Close;
          toeitm.Connection := zcone;
          toeitm.ParamByName('toecodigo').AsInteger := itmtoecodigo.AsInteger;
          toeitm.Open;

        end;
        itm.Next;
      End;


      mes.Close;
      mes.Params[0].AsString := vMesChave;
      mes.Open;

      if vlTotalTaxa > 0 then
      begin
        mes.Edit;
        mesmesoutras.AsCurrency := vlTotalTaxa;
        mes.Post;
      end;


      vlTotalFrete := 0;
      vlOutras := 0;

      itm.First;
      While Not itm.Eof Do
      Begin

       vlOutras := vlOutras + itmitmoutras.AsCurrency;

        With Det.add Do
        Begin

          infAdProd := '';
          Prod.nItem := vlQtdItens;
          Prod.ncm := SomenteNumeros(itmproncm.AsString);

          Prod.CFOP := trim(Copy(itmcfocfop.AsString, 1, 1) + Copy(itmcfocfop.AsString, 2, 4));

          Prod.cProd := self.itmprocodigo.AsString;

          ACBrValidadorBarra.TipoDocto := docGTIN;
          ACBrValidadorBarra.Documento := Copy(itmpunbarra.AsString, 2, 13);
          if ACBrValidadorBarra.Validar then
          begin
            if itmpunbarrasistema.AsInteger = 1 then
            begin
              Prod.cEAN := 'SEM GTIN';
              Prod.cEANTrib := '';
            end
            else
            begin
              Prod.cEAN := Copy(itmpunbarra.AsString, 2, 13);
              Prod.cEANTrib := Copy(itmpunbarra.AsString, 2, 13);

            end;
          end
          else
          begin
            Prod.cEAN := 'SEM GTIN';
            Prod.cEANTrib := '';
          end;

          If cfgcfgdescrinfe.AsInteger = 0 Then
            Prod.xProd := BuscaTroca(trim(itmpronome.AsString), '%', '') + ' ' + self.itmpunidentificacao.AsString;

          If cfgcfgdescrinfe.AsInteger = 1 Then
            Prod.xProd := BuscaTroca(trim(itmpronomereduzido.AsString), '%', '') + ' ' + self.itmpunidentificacao.AsString;

          If (Copy(Prod.xProd, 1, 1) = '.') Then
            Prod.xProd := trim(Copy(Prod.xProd, 2, 300));

          Prod.qCom := self.itmitmquantidade.AsFloat;
          Prod.uCom := self.itmunisimbolo.AsString;
          Prod.vProd := self.itmitmtotal.AsFloat;

          Prod.vOutro := itmitmoutras.AsCurrency;

          Prod.qTrib := self.itmitmquantidade.AsFloat;
          Prod.vDesc := self.itmitmdesconto.AsFloat;

          Prod.vOutro := self.itmitmoutras.AsCurrency;


          Prod.vFrete :=self.itmitmfrete.AsCurrency;
          vlTotalFrete:=vlTotalFrete+self.itmitmfrete.AsCurrency;


          Prod.uTrib := self.itmunisimbolo.AsString;
          Prod.vUnTrib := (self.itmitmtotal.AsFloat) / self.itmitmquantidade.AsFloat;

          Prod.vUnCom := Prod.vUnTrib;

          vlTotDesc := vlTotDesc + Prod.vDesc;
          vlTotBruto := vlTotBruto + (Prod.vProd);
          vlTotLiq := vlTotLiq + (vlTotBruto - vlTotDesc);

          if itmtpocodigo.AsInteger = 99 then
            Prod.CEST := '01.999.00';

          Prod.CEST := itmtcecest.AsString;

          With Imposto Do
          Begin

            Imposto.vTotTrib := { itmitmcargatrib.AsFloat + } itmitmcargatribest.AsFloat;

            (* Acumula totais de carga tributária por ente Federal e Estadual *)
            vlTotTrib := vlTotTrib { + itmitmcargatrib.AsFloat };
            vlTotTribEst := vlTotTribEst + itmitmcargatribest.AsFloat;

            With ICMS Do
            Begin
              case Emit.CRT of
                crtSimplesNacional:
                  vlCSOSNIcms := StrToCSOSNIcms(vlCSOSNIcmsOK, itmcstcodigo.AsString);
                crtRegimeNormal, crtSimplesExcessoReceita:
                  vlCSTIcms := StrToCSTICMS(vlCSTIcmsOK, Copy(self.itmcstcodigo.AsString, 2, 2));
              end;

              (* CST *)
              if vlCSTIcmsOK then
                CST := vlCSTIcms;

              (* CSOSN *)
              if vlCSOSNIcmsOK then
                CSOSN := vlCSOSNIcms;

              ICMS.modBC := dbiValorOperacao;

              If (lowercase(self.itmicmcodigo.AsString) = 'ff') Or (lowercase(self.itmicmcodigo.AsString) = 'ii') Or
                (lowercase(self.itmicmcodigo.AsString) = 'nn') Then
              Begin
                ICMS.pICMS := 0;
                ICMS.vICMS := 0;
                ICMS.vBC := 0;
              End
              Else
              Begin
                If (self.itmitmicm.AsFloat = 0.01) or (self.itmitmicm.AsFloat = 0) Then
                Begin
                  ICMS.pICMS := 0;
                  ICMS.vICMS := 0;
                  ICMS.vBC := 0;
                End
                Else
                Begin
                  ICMS.pICMS := self.itmicmaliquota.AsFloat;
                  ICMS.vICMS := itmitmicm.AsFloat;
                  ICMS.vBC := itmitmbicm.AsCurrency;
                  ICMS.pRedBC := itmitmpercreducaobaseicm.AsCurrency;

                  if (itmitmbicms.AsFloat > 0) and (itmitmaliqicms.AsFloat > 0) then
                  begin
                    ICMS.modBCST := dbisMargemValorAgregado;
                    ICMS.pMVAST := itmitmmva.AsFloat;
                    ICMS.vBCST := itmitmbicms.AsFloat;
                    ICMS.pICMSST := itmitmaliqicms.AsFloat;
                    ICMS.vICMSST := itmitmicms.AsFloat;

                  end;

                End;
              End;

              vlTotICMS := vlTotICMS + ICMS.vICMS;
              vlTotBC := vlTotBC + ICMS.vBC;
            End;

            pis.CST := StrToCSTPIS(ok, itmcspcodigo.AsString);
            if itmitmaliqpis.AsFloat > 0 then
            begin
              pis.vBC := itmitmbpis.AsCurrency;
              pis.pPIS := itmitmaliqpis.AsFloat;
              pis.vPIS := itmitmpis.AsCurrency;
            end;

            COFINS.CST := StrToCSTCOFINS(ok, itmcsfcodigo.AsString);

            if itmitmaliqcofins.AsFloat > 0 then
            begin
              COFINS.vBC := itmitmbcofins.AsCurrency;
              COFINS.pCOFINS := itmitmaliqcofins.AsFloat;
              COFINS.vCOFINS := itmitmcofins.AsCurrency;
            end;

          End;
          vlQtdItens := vlQtdItens + 1;

        End;

        itm.Next;
      End;

      if ide.indPres= pcEntregaDomicilio then
      begin
        if mesmesfrete.AsCurrency>0 then
        begin
          Transp.modFrete := mfContaDestinatario;

         { Transp.Transporta.CNPJCPF:='';
          Transp.Transporta.xNome:='';
          Transp.Transporta.CNPJCPF:='';
          Transp.Transporta.IE:='';
          Transp.Transporta.xEnder:='';
          Transp.Transporta.xMun:='';
          Transp.Transporta.UF:='';}

        end
        else
        begin
          Transp.modFrete := mfSemFrete;
        end;
      end
      else
      begin
        Transp.modFrete := mfSemFrete;
      end;




      (* Trata mensagem referente Carga Tributária *)
      if (vlTotTrib + vlTotTribEst) > 0 then
      begin
        vlMensagemCargaTrib := 'Trib. aprox. R$ ';
        vlMensagemCargaTrib := vlMensagemCargaTrib + FormatFloat('#,###.00', RoundTo(vlTotTrib, -2)) + ' Federal';

        if vlTotTribEst > 0 then
          vlMensagemCargaTrib := vlMensagemCargaTrib + ' e ' + FormatFloat('#,###.00', RoundTo(vlTotTribEst, -2)) + ' Estadual';

        vlMensagemCargaTrib := vlMensagemCargaTrib + ';Fonte: IBPT 5oi7eW (Lei Federal 12.741/2012)';

      end;
      vlMensagemCargaTrib := '';

      { * Exibe situação de credito do cliente * }

      vlMensagemLimite := '';

      qTomTof.Close;
      qTomTof.Connection := zcone;
      qTomTof.SQL.Text := 'SELECT distinct tofidentificacao FROM tom, tof WHERE ';
      qTomTof.SQL.add('tom.tofcodigo = tof.tofcodigo AND ');
      qTomTof.SQL.add('tof.ticcodigo IN (' + IntToStr(ticObservacao) + ') AND ');
      qTomTof.SQL.add('tom.meschave = ' + vpMesChave + ' ');
      qTomTof.SQL.add('ORDER BY tof.tofcodigo');
      qTomTof.Open;

      if qTomTof.IsEmpty then
      begin

        if cfgcfgobs1.AsString <> '' then
        begin
          tom.Connection := zcone;
          tom.Open;

          if not tom.locate('meschave;tofcodigo', VarArrayOf([vpMesChave, cfgcfgobs1.AsInteger]), []) then
          begin
            tom.Append;
            tomtofcodigo.AsInteger := cfgcfgobs1.AsInteger;
            tommeschave.AsString := vpMesChave;
            tom.post;
          end;

        end;



        qTomTof.Close;
        qTomTof.Connection := zcone;
        qTomTof.SQL.Text := 'SELECT distinct tofidentificacao FROM tom, tof WHERE ';
        qTomTof.SQL.add('tom.tofcodigo = tof.tofcodigo AND ');
        qTomTof.SQL.add('tof.ticcodigo IN (' + IntToStr(ticObservacao) + ') AND ');
        qTomTof.SQL.add('tom.meschave = ' + vpMesChave + ' ');
        qTomTof.SQL.add('ORDER BY tof.tofcodigo');
        qTomTof.Open;

      end;

      vlMensagemReducaoBase := '';

      While Not qTomTof.Eof Do
      Begin
        if pos(trim(qTomTof.Fields[0].AsString), vlMensagemCargaTrib) = 0 then
        begin
          vlMensagemCargaTrib := vlMensagemCargaTrib + trim(qTomTof.Fields[0].AsString) + ';';
        end;
        qTomTof.Next;
      End;

      vlMensagemCartoes:='';

      consultacomprovante.Close;
      consultacomprovante.sql.Text := 'SELECT distinct dtl.dtlchave, dtl.mdacodigo, mda.mdaidentificacao, dtl.dtlvalor, rdc.rdccomprovante1via, rdc.rdccomprovante2via ';
      consultacomprovante.sql.Add('FROM mes INNER JOIN rfm ON mes.meschave = rfm.meschave ');
      consultacomprovante.sql.Add('INNER JOIN rfi ON rfm.rfichave = rfi.rfichave ');
      consultacomprovante.sql.Add('INNER JOIN mfi ON mfi.rfichave = rfi.rfichave ');
      consultacomprovante.sql.Add('INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
      consultacomprovante.sql.Add('INNER JOIN dtl ON dtl.ltechave = mlt.ltechave ');
      consultacomprovante.sql.Add('INNER JOIN mda ON dtl.mdacodigo = mda.mdacodigo ');
      consultacomprovante.sql.Add('INNER JOIN ltr ON dtl.dtlchave = ltr.dtlchave ');
      consultacomprovante.sql.Add('INNER JOIN rdc ON ltr.rdcchave = rdc.rdcchave ');
      consultacomprovante.sql.Add('WHERE rfi.tfdcodigo IN (32) ');
      consultacomprovante.sql.Add('AND dtl.mdacodigo IN (4,5,6) ');
      consultacomprovante.sql.Add('AND mes.meschave ='+vpMesChave);
      consultacomprovante.Open;

      while not consultacomprovante.Eof do
      begin

        if consultacomprovante.FieldByName('rdccomprovante1via').AsString <> '' then
        begin

          if pos(consultacomprovante.FieldByName('rdccomprovante1via').AsString,vlMensagemCartoes)=0 then
          begin
            vlMensagemCartoes:=Trim(vlMensagemCartoes+consultacomprovante.FieldByName('rdccomprovante1via').AsString);
          end;

        end;
        consultacomprovante.Next;
      end;

      InfAdic.infCpl := trim(trim(vlMensagemCargaTrib) + #13+ #13 + ' ' +
                         trim(cfgcfgmensagempdv.AsString) + #13 + #13  + ' ' +
                         trim(mesmesobs.AsString) + #13 + #13 + ' ' +
                         trim(vlMensagemLimite) + #13 + #13 + ' '+
                         trim(vlMensagemReducaoBase)+
                         #13 +#13 + ' ' +
                         vlMensagemCartoes);



      Total.ICMSTot.vTotTrib := RoundTo(vlTotTrib + vlTotTribEst, -2);

      Total.ICMSTot.vOutro := vlTotalTaxa;
      Total.ICMSTot.vFrete := mesmesfrete.AsCurrency;

      Total.ICMSTot.vBC := vlTotBC;

      Total.ICMSTot.vICMS := RoundTo(vlTotICMS, -2);
      Total.ICMSTot.vProd := RoundTo(vlTotBruto, -2);
      Total.ICMSTot.vDesc := RoundTo(vlTotDesc, -2);

      Total.ICMSTot.vNF := RoundTo((vlTotBruto - vlTotDesc + mesmesfrete.AsCurrency + vlTotalTaxa), -2);

      Total.ICMSTot.vPIS := mesmespis.AsCurrency;
      Total.ICMSTot.vCOFINS := mesmescofins.AsCurrency;

      qDtl.Close;

      qDtl.SQL.Text :='SELECT distinct dtl.dtlvalor, rfm.meschave, mda.mdacodigo modalidade, mda.mdatagpagamento mdacodigo, dtl.cedcodigo, dtl.rdcnrauto ';
      qDtl.SQL.add('FROM rfm ');
      qDtl.SQL.add('INNER JOIN rfi ON rfm.rfichave = rfi.rfichave ');
      qDtl.SQL.add('INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
      qDtl.SQL.add('INNER JOIN mlt ON mfi.mfichave =mlt.mfichave ');
      qDtl.SQL.add('INNER JOIN dtl ON mlt.ltechave = dtl.ltechave ');
      qDtl.SQL.add('INNER JOIN mda ON dtl.mdacodigo = mda.mdacodigo ');

      qDtl.SQL.add('WHERE rfm.meschave='+ self.mesmeschave.AsString + ' ');
      qDtl.SQL.add('GROUP BY  dtl.dtlchave ');
      qDtl.SQL.add('ORDER BY dtl.dtlchave ');
      qDtl.Open;






      vDinheiro := 0;
      vVoucher := 0;
      vChequeProprio := 0;
      vChequeTerceiros := 0;
      vCartaoDebito := 0;
      vCartaoCredito := 0;
      vPIX := 0;
      vConvenio := 0;
      vVale := 0;
      vDoacao := 0;
      vCredito := 0;
      vTrocaDevolucao := 0;

      vAFaturar := 0;

      vlTotalItens := 0;
      vlTotalFinalizadores := 0;


      vlTotalItens := RoundTo(vlTotBruto - vlTotDesc + vlTotalFrete + vlTotalTaxa, -2);

      while not qDtl.Eof do
      begin
        if not(qDtl.FieldByName('modalidade').AsInteger in [11, 22, 33]) then
          vlTotalFinalizadores := vlTotalFinalizadores + qDtl.FieldByName('dtlvalor').AsCurrency;

        qDtl.Next;
      end;

      
      qDtl.First;

      {
        1	Dinheiro	1
        3	Cheque Terceiros	2
        4	Cartão Crédito	3
        5	Cartão Débito	4
        7	Convênio	5
        78	Pagamento Online	5
        6	PIX	17
        8	Crédito	21
        17	Vale	21
      }


      while not qDtl.Eof do
      begin

        case qDtl.FieldByName('modalidade').AsInteger of
          mdaDinheiro:
            vDinheiro := vDinheiro + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaTrocoDinheiro:
            begin
              vlTroco := vlTroco - qDtl.FieldByName('dtlvalor').AsCurrency;
            end;
          mdaChequeProprio:
            begin
              vChequeProprio := vChequeProprio + qDtl.FieldByName('dtlvalor').AsCurrency;
              if qDtl.Eof then
              begin
                vlTroco := vlTroco + qDtl.FieldByName('dtlvalor').AsCurrency;
              end;
            end;
          mdaTrocoChequeProprio:
            begin
              vChequeProprio := vChequeProprio - qDtl.FieldByName('dtlvalor').AsCurrency;
              vlTroco := vlTroco + qDtl.FieldByName('dtlvalor').AsCurrency;
            end;
          mdaChequeTerceiros:
            vChequeTerceiros := vChequeTerceiros + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaTrocoChequeTerceiros:
            vChequeTerceiros := vChequeTerceiros - qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaCartaoDebito:
            vCartaoDebito := vCartaoDebito + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaCartaoCredito:
            vCartaoCredito := vCartaoCredito + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaPIX:
            vPIX := vPIX + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaConvenio:
            vConvenio := vConvenio + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaVale:
            vVale := vVale + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaDoacao:
            vDoacao := vDoacao + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaCredito:
            vCredito := vCredito + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaTrocaDevolucao:
            vTrocaDevolucao := vTrocaDevolucao + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaVoucher:
            vVoucher:=vVoucher+ qDtl.FieldByName('dtlvalor').AsCurrency;
        end;
        qDtl.Next;
      end;



      if mesetdcodigo.AsInteger = 0 then
      begin
        if vVoucher + vDinheiro + vChequeProprio + vChequeTerceiros + vCartaoDebito + vCartaoCredito + vConvenio + vPIX + vTrocaDevolucao + vVale + vDoacao +
          vCredito = 0 then
        begin
          vDinheiro := mesmestotal.AsCurrency;
          vlValorDiferenca := 0;
        end;

      end;

      if vDinheiro < 0 then
        vlValorDiferenca := vDinheiro;

      qDtl.Close;
      qDtl.SQL.Clear;
      qDtl.SQL.add('SELECT lte.ltetroco ltetroco,lte.ltechave ');
      qDtl.SQL.add('  FROM rfm ');
      qDtl.SQL.add(' INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
      qDtl.SQL.add(' INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
      qDtl.SQL.add(' INNER JOIN lte ON mlt.ltechave = lte.ltechave ');
      qDtl.SQL.add(' WHERE rfm.meschave = ' + vMesChave);
      qDtl.Open;

      vlTroco := 0; // qDtl.FieldByName('ltetroco').AsCurrency;

      if vlTroco < 0 then
        vlTroco := vlTroco * -1;

      if vDinheiro > 0 then
        with pag.add do
        begin

          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaDinheiro;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));


          if vlValorDiferenca <> 0 then
          begin
            vPag := vDinheiro + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
          begin
            vPag := vDinheiro + vlTroco;

          end;
        end;

      if vChequeProprio > 0 then
        with pag.add do
        begin
          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaChequeProprio;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));


          if vlValorDiferenca <> 0 then
          begin
            vPag := vChequeProprio + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vChequeProprio;
        end;

      if vChequeTerceiros > 0 then
        with pag.add do
        begin
          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaChequeTerceiros;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));

          if tagPagamento.FieldByName('mdatagpagamento').AsInteger=99 then
          begin
           xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
          end;

          if tagPagamento.FieldByName('mdatagpagamento').AsInteger=99 then
          begin
           xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
          end;


          if vlValorDiferenca <> 0 then
          begin
            vPag := vChequeTerceiros; // + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vChequeTerceiros + vlTroco;
        end;

      if vConvenio > 0 then
        with pag.add do
        begin
          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaConvenio;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));

          if tagPagamento.FieldByName('mdatagpagamento').AsInteger=99 then
          begin
           xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
          end;


          if vlValorDiferenca <> 0 then
          begin
            vPag := vConvenio + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vConvenio;
        end;

      if vVale > 0 then
        with pag.add do
        begin
          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaVale;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));


          if tagPagamento.FieldByName('mdatagpagamento').AsInteger=99 then
          begin
           xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
          end;

          if vlValorDiferenca <> 0 then
          begin
            vPag := vVale + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vVale;
        end;

      if vDoacao > 0 then
        with pag.add do
        begin
          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaDoacao;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));

          if tagPagamento.FieldByName('mdatagpagamento').AsInteger=99 then
          begin
           xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
          end;

          if vlValorDiferenca <> 0 then
          begin
            vPag := vDoacao + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vDoacao;
        end;

      if vCredito > 0 then
        with pag.add do
        begin
          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaCredito;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));

          if tagPagamento.FieldByName('mdatagpagamento').AsInteger=99 then
          begin
           xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
          end;

          if vlValorDiferenca <> 0 then
          begin
            vPag := vCredito + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vCredito;
        end;

      if vTrocaDevolucao > 0 then
        with pag.add do
        begin
          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaTrocaDevolucao;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));

          if tagPagamento.FieldByName('mdatagpagamento').AsInteger=99 then
          begin
           xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
          end;


          if vlValorDiferenca <> 0 then
          begin
            vPag := vTrocaDevolucao + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vTrocaDevolucao;

        end;


      // detalhe de dados do cartão e pix

      dtl.close;
      dtl.Connection := zcone;
      dtl.ParamByName('ltechave').AsString:=qDtl.FieldByName('ltechave').AsString;
      dtl.Open;

      dtl.First;


      while not dtl.eof do
      begin

        if (dtl.FieldByName('mdacodigo').AsInteger=mdaCartaoDebito) then
        begin

          rdc.Close;
          rdc.Connection := zcone;
          rdc.ParamByName('dtlchave').AsInteger:=dtl.FieldByName('dtlchave').AsInteger;
          rdc.Open;

          if (vCartaoDebito > 0) and (rdc.RecordCount>0) then
          with pag.add do
          begin
          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaCartaoDebito;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));

          if tagPagamento.FieldByName('mdatagpagamento').AsInteger=99 then
          begin
           xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
          end;

              vPag := rdc.FieldByName('rdcvalor').AsCurrency;

            if ((rdc.FieldByName('adccodigo').AsString<>'') and
               (rdc.FieldByName('adccodigo').AsString<>'0')) and
               (rdc.FieldByName('bdccodigo').AsInteger<>99) then
            begin

              tpIntegra:=tiPagIntegrado;

              CNPJ:= SoNumeros(rdc.FieldByName('etddoc1').AsString);
              cAut:=rdc.FieldByName('rdcnrauto').AsString;

              CNPJReceb:=SoNumeros(cfgetddoc1.AsString);
              idTermPag:=acesso.Terminal.ToString;


              case rdc.FieldByName('bdccodigo').AsInteger of
                1:TBand:= bcVisa;
                2:TBand:= bcMasterCard;
                3:TBand:= bcAmericanExpress;
                4:TBand:= bcSorocred;
                5:TBand:= bcDinersClub;
                6:TBand:= bcElo;
                7:TBand:= bcHipercard;
                8:TBand:= bcAura;
                9:TBand:= bcCabal;
                10:TBand:= bcAlelo;
                11:TBand:= bcBanesCard;
                12:TBand:= bcCalCard;
                13:TBand:= bcCredz;
                14:TBand:= bcDiscover;
                15:TBand:= bcGoodCard;
                16:TBand:= bcGreenCard;
                17:TBand:= bcHiper;
                18:TBand:= bcJcB;
                19:TBand:= bcMais;
                20:TBand:= bcMaxVan;
                21:TBand:= bcPolicard;
                22:TBand:= bcRedeCompras;
                23:TBand:= bcSodexo;
                24:TBand:= bcValeCard;
                25:TBand:= bcVerocheque;
                26:TBand:= bcVR;
                27:TBand:= bcTicket;
             10014:TBand:= 	bcDiscover;
             20001:TBand:= 	bcMasterCard;
             20002:TBand:= 	bcVisa;
             20137:TBand:= 	bcMasterCard;
                99:TBand:= bcOutros;
              end;
            end
            else
            begin
             // tpIntegra:=tiPagNaoIntegrado;
            end;

          end;

        end;

        if (dtl.FieldByName('mdacodigo').AsInteger=mdaCartaoCredito) then
        begin

          rdc.Close;
          rdc.Connection := zcone;
          rdc.ParamByName('dtlchave').AsInteger:=dtl.FieldByName('dtlchave').AsInteger;
          rdc.Open;

          if (vCartaoCredito > 0) and (rdc.RecordCount>0)  then
          with pag.add do
          begin
          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaCartaoCredito;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));

          if tagPagamento.FieldByName('mdatagpagamento').AsInteger=99 then
          begin
           xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
          end;

            vPag := rdc.FieldByName('rdcvalor').AsCurrency;

            if ((rdc.FieldByName('adccodigo').AsString<>'') and
               (rdc.FieldByName('adccodigo').AsString<>'0')) and
               (rdc.FieldByName('bdccodigo').AsInteger<>99) then

            begin
              tpIntegra:=tiPagIntegrado;
              CNPJ:= SoNumeros(rdc.FieldByName('etddoc1').AsString);

              CNPJReceb:=SoNumeros(cfgetddoc1.AsString);
              idTermPag:=acesso.Terminal.ToString;

              case rdc.FieldByName('bdccodigo').AsInteger of
                1:TBand:= bcVisa;
                2:TBand:= bcMasterCard;
                3:TBand:= bcAmericanExpress;
                4:TBand:= bcSorocred;
                5:TBand:= bcDinersClub;
                6:TBand:= bcElo;
                7:TBand:= bcHipercard;
                8:TBand:= bcAura;
                9:TBand:= bcCabal;
                10:TBand:= bcAlelo;
                11:TBand:= bcBanesCard;
                12:TBand:= bcCalCard;
                13:TBand:= bcCredz;
                14:TBand:= bcDiscover;
                15:TBand:= bcGoodCard;
                16:TBand:= bcGreenCard;
                17:TBand:= bcHiper;
                18:TBand:= bcJcB;
                19:TBand:= bcMais;
                20:TBand:= bcMaxVan;
                21:TBand:= bcPolicard;
                22:TBand:= bcRedeCompras;
                23:TBand:= bcSodexo;
                24:TBand:= bcValeCard;
                25:TBand:= bcVerocheque;
                26:TBand:= bcVR;
                27:TBand:= bcTicket;
             10014:TBand:= 	bcDiscover;
             20001:TBand:= 	bcMasterCard;
             20002:TBand:= 	bcVisa;
             20137:TBand:= 	bcMasterCard;

                99:TBand:= bcOutros;
              end;
              cAut:=rdc.FieldByName('rdcnrauto').AsString;
            end
            else
            begin
             // tpIntegra:=tiPagNaoIntegrado;
            end;

          end;

        end;


      
        if (dtl.FieldByName('mdacodigo').AsInteger=mdaPIX) then
        begin

          rdc.Close;
          rdc.Connection := zcone;
          rdc.ParamByName('dtlchave').AsInteger:=dtl.FieldByName('dtlchave').AsInteger;
          rdc.Open;

          if (vPIX > 0) and (rdc.RecordCount>0)  then
          with pag.add do
          begin
            tagPagamento.Close;
            tagPagamento.Connection:=zcone;
            tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaPIX;
            tagPagamento.Open;

            tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));

            if tagPagamento.FieldByName('mdatagpagamento').AsInteger=99 then
            begin
             xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
            end;

            vPag := rdc.FieldByName('rdcvalor').AsCurrency;

            if ((rdc.FieldByName('adccodigo').AsString<>'') and
               (rdc.FieldByName('adccodigo').AsString<>'0')) and
               (rdc.FieldByName('bdccodigo').AsInteger<>99) then
            begin
              tpIntegra:=tiPagIntegrado;

              try
                ctapix.Close;
                ctapix.Connection:=zcone;
                ctapix.ParamByName('ctacodigo').AsInteger:=cfgcfgctacodigopix.AsInteger;
                ctapix.Open;

                if ctapix.FieldByName('ctacnpjbanco').AsString<>'' then
                  CNPJ:= SoNumeros(ctapix.FieldByName('ctacnpjbanco').AsString);
              except
                CNPJ:=SoNumeros(cfgetddoc1.AsString);
              end;

              CNPJReceb:=SoNumeros(cfgetddoc1.AsString);

              idTermPag:=acesso.Terminal.ToString;

              case rdc.FieldByName('bdccodigo').AsInteger of
                1:TBand:= bcVisa;
                2:TBand:= bcMasterCard;
                3:TBand:= bcAmericanExpress;
                4:TBand:= bcSorocred;
                5:TBand:= bcDinersClub;
                6:TBand:= bcElo;
                7:TBand:= bcHipercard;
                8:TBand:= bcAura;
                9:TBand:= bcCabal;
                10:TBand:= bcAlelo;
                11:TBand:= bcBanesCard;
                12:TBand:= bcCalCard;
                13:TBand:= bcCredz;
                14:TBand:= bcDiscover;
                15:TBand:= bcGoodCard;
                16:TBand:= bcGreenCard;
                17:TBand:= bcHiper;
                18:TBand:= bcJcB;
                19:TBand:= bcMais;
                20:TBand:= bcMaxVan;
                21:TBand:= bcPolicard;
                22:TBand:= bcRedeCompras;
                23:TBand:= bcSodexo;
                24:TBand:= bcValeCard;
                25:TBand:= bcVerocheque;
                26:TBand:= bcVR;
                27:TBand:= bcTicket;
             10014:TBand:= 	bcDiscover;
             20001:TBand:= 	bcMasterCard;
             20002:TBand:= 	bcVisa;
             20137:TBand:= 	bcMasterCard;

                99:TBand:= bcOutros;
              end;

              cAut:=rdc.FieldByName('rdcnrauto').AsString;
            end
            else
            begin

            //  tpIntegra:=tiPagNaoIntegrado;
            end;

          end;

        end;

        if (dtl.FieldByName('mdacodigo').AsInteger=mdaVoucher) then
        begin

          rdc.Close;
          rdc.Connection := zcone;
          rdc.ParamByName('dtlchave').AsInteger:=dtl.FieldByName('dtlchave').AsInteger;
          rdc.Open;

          if (vVoucher > 0) and
             (rdc.RecordCount>0)  then
          with pag.add do
          begin
          tagPagamento.Close;
          tagPagamento.Connection:=zcone;
          tagPagamento.ParamByName('mdacodigo').AsInteger:=mdaVoucher;
          tagPagamento.Open;

          tPag := StrToFormaPagamento(vlCodigoTagOK,formatfloat('00', tagPagamento.FieldByName('mdatagpagamento').AsFloat));

          if (tagPagamento.FieldByName('mdatagpagamento').AsInteger=99) or
             (tagPagamento.FieldByName('mdatagpagamento').AsInteger=0) then
          begin
           xPag:=tagPagamento.FieldByName('mdadescrpagamento').AsString;
          end;

            vPag := rdc.FieldByName('rdcvalor').AsCurrency;

            if ((rdc.FieldByName('adccodigo').AsString<>'') and
               (rdc.FieldByName('adccodigo').AsString<>'0')) and
               (rdc.FieldByName('bdccodigo').AsInteger<>99) then
            begin              tpIntegra:=tiPagIntegrado;
              CNPJ:= SoNumeros(rdc.FieldByName('etddoc1').AsString);
              CNPJReceb:=SoNumeros(cfgetddoc1.AsString);
              idTermPag:=acesso.Terminal.ToString;
              case rdc.FieldByName('bdccodigo').AsInteger of
                1:TBand:= bcVisa;
                2:TBand:= bcMasterCard;
                3:TBand:= bcAmericanExpress;
                4:TBand:= bcSorocred;
                5:TBand:= bcDinersClub;
                6:TBand:= bcElo;
                7:TBand:= bcHipercard;
                8:TBand:= bcAura;
                9:TBand:= bcCabal;
                10:TBand:= bcAlelo;
                11:TBand:= bcBanesCard;
                12:TBand:= bcCalCard;
                13:TBand:= bcCredz;
                14:TBand:= bcDiscover;
                15:TBand:= bcGoodCard;
                16:TBand:= bcGreenCard;
                17:TBand:= bcHiper;
                18:TBand:= bcJcB;
                19:TBand:= bcMais;
                20:TBand:= bcMaxVan;
                21:TBand:= bcPolicard;
                22:TBand:= bcRedeCompras;
                23:TBand:= bcSodexo;
                24:TBand:= bcValeCard;
                25:TBand:= bcVerocheque;
                26:TBand:= bcVR;
                27:TBand:= bcTicket;
             10014:TBand:= 	bcDiscover;
             20001:TBand:= 	bcMasterCard;
             20002:TBand:= 	bcVisa;
             20137:TBand:= 	bcMasterCard;

                99:TBand:= bcOutros;
              end;
              cAut:=rdc.FieldByName('rdcnrauto').AsString;
            end
            else
            begin
            //  tpIntegra:=tiPagNaoIntegrado;
            end;

          end;

        end;


        dtl.next;
      end;

      if pag.Count = 0 then
      begin

        with pag.add do
        begin
          tPag := TpcnFormaPagamento(17);

          xPag:='Outros';

          if vlValorDiferenca <> 0 then
          begin
            vPag := vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vTrocaDevolucao;

        end;

      end;


      if (self.mesmesnumero.AsString <> '') and (self.mesmesnumero.AsString <> '0') then
      begin
        vNumeroNFe := self.mesmesnumero.AsInteger
      end
      else
      begin

        NumeroNFCe.ExecSQL;
        vNumeroNFe := NumeroNFCe.Fields[0].AsInteger;
      end;

      ide.nNF := vNumeroNFe;


      if (Copy(vlNFCeProtocolo, 1, 10) <> '0000000000') and (Length(trim(vlNFCeProtocolo)) > 0) then
      begin

        ide.cNF := StrToInt(FormatFloat('00000000', StrToInt(Copy(vlNFCeChave, 36, 8))));

        if Copy(vlNFCeChave, 35, 1) = '9' then
        begin

          ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teOffLine;
          ide.tpEmis := teOffLine;
          ide.dhCont := mesmesdatanfe.AsDateTime; // recrecdthoraentrada.AsFloat;
          ide.xJust := 'Falha de comunicação com servidores da SEFAZ.';

        end
        else
        begin
          ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teNormal;
          ide.tpEmis := teNormal;
        end;

      end
      else
      begin
        if (mesmescodigonota.AsString = '') or (mesmescodigonota.AsString = '0') then
        begin
          ide.cNF := GerarCodigoDFe(vNumeroNFe);
          mes.Edit;
          mesmescodigonota.AsInteger := ide.cNF;
          mes.Post;
        end
        else
        begin
          ide.cNF := mesmescodigonota.AsInteger;
        end;

      end;

      consulta.Close;
      consulta.SQL.Text := 'UPDATE mes SET ';
      consulta.SQL.add('mesnumero = ' + IntToStr(vNumeroNFe) + ', ');
      consulta.SQL.add('tdfcodigo = ''65'', ');
      consulta.SQL.add('refcodigo = 9, ');
      consulta.SQL.add('temcodigo = 4 ');
      consulta.SQL.add('WHERE meschave = ' + vMesChave);
      consulta.ExecSQL;

      info.Lines.add('Iniciar comunicação: ' + datetimetostr(now));

      if (Copy(mesmesprotocolo.AsString, 1, 15) <> '000000000000000') and (mesmesprotocolo.AsString <> '') then
      begin

        AssinaNota(ACBrNFeNFCe, vMesChave, vFlaCodigo);

        vpNomeArquivoNFCe := mesmeschavenfe.AsString;

        vpNomeArquivoNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', mesmesdatanfe.AsDateTime) + '\' + vpNomeArquivoNFCe +
          '-nfe.xml';

        ConsultaNFCe(mesmeschave.AsString, vpNomeArquivoNFCe, Acesso.Filial.ToString);

      end
      else
      begin

        if AssinaNota(ACBrNFeNFCe, vMesChave, vFlaCodigo) then
        begin
          info.Lines.add('Nota Assinada: ' + datetimetostr(now));
          Result := True;

        end;
      end;

    End;

    Result := True;

  except
    Result := False;
  end;
End;

function Tfnfcepdv.AssinaNota(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
var
  vErro: String;
  vMensagemErro: String;
begin
  Result := True;

  try

    // Assina e salva arquivo no Path definido
    vACBrNFe.NotasFiscais.Assinar;
  Except
    On E: Exception Do
    Begin

      vErro := '';
      If E.Message <> '' Then
        vErro := E.Message;

      vMensagemErro := 'Erro ao Assinar Digitalmente a NFC-e.';
      vMensagemErro := vMensagemErro + sLineBreak + 'Mensagem: ' + vErro;

      SalvarLogErro(vMensagemErro, E.StackTrace);

      vMensagemErro := vMensagemErro + sLineBreak + sLineBreak + sLineBreak + 'Utilize a opção "Imprimir com NFC-e".';

      Result := False;
    End;
  end;
end;

function Tfnfcepdv.SalvaEmCoontigencia(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
var
  vChaveNFE: string;
  vProtocoloNFe: string;
  vErro: string;
  vlArqNFCe: string;
  vData: double;
begin
  try

    info.Lines.add('Vai salvar a nota em contigencia: ' + datetimetostr(now));

    vChaveNFE := Copy(vACBrNFe.NotasFiscais.Items[0].NFe.infNFe.ID, 4, 44);

    vProtocoloNFe := '000000000000000 ' + datetostr(vpDataAtual) + ' ' + TimeToStr(vpDataAtual);

    consulta.Close;
    consulta.SQL.Text := 'UPDATE mes SET ';
    consulta.SQL.add('mesdatanfe = ' + QuotedStr(ajustadata(datetostr(vpDataAtual))) + ', ');
    consulta.SQL.add('mesregistro = ' + QuotedStr(ajustadata(datetostr(vpDataAtual))) + ', ');
    consulta.SQL.add('tdfcodigo = ' + QuotedStr('65') + ', ');
    consulta.SQL.add('refcodigo = 9, ');
    consulta.SQL.add('mesprotocolo = ' + chr(39) + vProtocoloNFe + chr(39) + ', ');
    consulta.SQL.add('temcodigo = 50, ');
    consulta.SQL.add('meschavenfe = ' + QuotedStr(vChaveNFE) + ' WHERE ');
    consulta.SQL.add('meschave = ' + vMesChave) ;
    consulta.ExecSQL;

    mes.Close;
    mes.Params[0].AsString := vMesChave;
    mes.Open;

    vlArqNFCe := vACBrNFe.NotasFiscais.Items[0].CalcularNomeArquivoCompleto;
    // vlArqNFCe := vACBrNFe.NotasFiscais.Items[0].NomeArq;

    vACBrNFe.NotasFiscais.Clear;

    if (cfgcfgservarqnfes.AsString <> '127.0.0.1') and (pos('\', cfgcfgservarqnfes.AsString) = 0) then
    begin
      EnviaXMLServidor(cfgcfgservarqnfes.AsString, vlArqNFCe);
    end;

    vACBrNFe.NotasFiscais.Clear;
    ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;

    if vChaveNFE <> '' then
    begin

      if mesmesdatanfe.AsFloat = 0 then
        vData := mesmesregistro.AsFloat
      else
        vData := mesmesdatanfe.AsFloat;

      vlArqNFCe := mesmeschavenfe.AsString;
      vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe + '-nfe.xml';
    end;

    Result := True;

    info.Lines.add('Salvar a nota em contigencia: ' + datetimetostr(now));

  Except
    On E: Exception Do
    Begin
      If E.Message = '' Then
        vErro := ''
      Else
        vErro := #13 + 'Erro: ' + E.Message;

      // application.MessageBox(PChar('Erro ao Validar a NFC-e.' + #13 + 'Mensagem: ' + vErro + #13 + #13 + #13 + 'Utilize a opção "Imprimir com NFC-e".'), 'Erro Geração NF-e',        MB_OK + MB_ICONERROR);
      Result := False;
      Exit;
    End;
  end;

end;

function Tfnfcepdv.SalvaNormal(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
var
  vChaveNFE: string;
  vProtocoloNFe: string;
  vCStat: Integer;
  vXMotivo: string;
  vErro: string;
  vlArqNFCe: String;
  vhrNFe: string;
  vNumeronfe: string;

  vChaveNFCe: string;
  VaaaammNFCe: string;
  vArqNFCe: string;
  vEmissaoNFCe: TDate;
  vlDataEmissao: TDate;

  vNovaChave: string;
  vlxmotivo: string;

  vlItem: string;
  vlTentativas:Integer;
begin

  Try
    info.Lines.add('Vai salvar a nota: ' + datetimetostr(now));




    if vACBrNFe.Enviar(0, False, False, False) then
    begin

      info.Lines.add('Enviou a nota para sefaz: ' + datetimetostr(now));

      vCStat := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.CStat;
      vXMotivo := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.xMotivo;

      vlxmotivo := vXMotivo;
      vNovaChave := trim(Copy(vlxmotivo, pos('[', vlxmotivo) + 2, 44));
      vlTentativas:=0;
      while True do
      begin

          info.Lines.add('Tentativa '+vlTentativas.ToString+' de status nota: ' + datetimetostr(now));

          sleep(300);

          ACBrNFeNFCe.Consultar;

          vCStat:= ACBrNFeNFCe.WebServices.consulta.CStat;

          if (vCStat=100) or  (vCStat=150) then
            break;

          vlTentativas:=vlTentativas+1;


          if vlTentativas>10 then
          break;



      end;

      info.Lines.add('Retornou o status da nota '+vCStat.ToString + datetimetostr(now));



      // Se código de status = 100 - Autorizado o uso da NF-e.
      If vCStat = 100 Then
      Begin
        vChaveNFE := Copy(vACBrNFe.NotasFiscais.Items[0].NFe.infNFe.ID, 4, 44);

        vProtocoloNFe := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.nProt;
        vhrNFe := TimeToStr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi);
        Copy(datetimetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.procNFe.DhRecbto), 1, 10);

        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';
        consulta.SQL.add('tdfcodigo = ' + QuotedStr('65') + ', ');
        consulta.SQL.add('refcodigo = 9, ');
        // consulta.SQL.add('mesdatanfe = ' + QuotedStr(ajustadata(DateToStr(vpDataAtual))) + ', ');
        consulta.SQL.add('mesdatanfe = ' + QuotedStr(ajustadata((Copy(datetostr(vACBrNFe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10)))) + ', ');
        consulta.SQL.add('mesregistro = ' + QuotedStr(ajustadata((Copy(datetimetostr(vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.DhRecbto), 1, 10))
          )) + ', ');
        consulta.SQL.add('mesprotocolo = ' + QuotedStr(vProtocoloNFe) + ', ');
        consulta.SQL.add('meshoranfe = ' + QuotedStr(vhrNFe) + ', ');
        consulta.SQL.add('temcodigo = 5, ');
        consulta.SQL.add('meschavenfe = ' + QuotedStr(vChaveNFE) + ' WHERE ');
        consulta.SQL.add('meschave = ' + vMesChave) ;
        consulta.ExecSQL;

        vlArqNFCe := vACBrNFe.NotasFiscais.Items[0].NomeArq;

        vACBrNFe.NotasFiscais.Clear;
        ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;

        info.Lines.add('Salvou regostro de status da nota ' + datetimetostr(now));

        if (cfgcfgservarqnfes.AsString <> '127.0.0.1') and (pos('\', cfgcfgservarqnfes.AsString) = 0) then
        begin
          EnviaXMLServidor(cfgcfgservarqnfes.AsString, vlArqNFCe);
        end;

        Result := True;
      end;
    End
    else
    begin
      vCStat := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.CStat;
      vXMotivo := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.xMotivo;

      info.Lines.add('Salvou registro de status da nota ' + datetimetostr(now));

    end;

  Except
    On E: Exception Do
    Begin

      vCStat := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.CStat;
      vXMotivo := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.xMotivo;


      if pos('Data de Validade do Certificado já expirou',  e.Message)>0 then
      begin
       Showmessage('ATENÇÃO '+#13+#13+
                   '   CERTIFICADO ESTA VENCIDO, FAVOR CONTACTAR A SUA CONTABILIDADE,'+#13+
                   '   PARA GERAR UM NOVO CERTIFICADO E GERAR A NOTA NOVAMENTE!');
                   exit;
      end;

     if pos('<enderDest>', e.Message)>0 then
     begin
       Showmessage('ATENÇÃO '+#13+#13+
                   ' VERIFICAR ENDEREÇO DO CLIENTE,'+#13+
                   'CORRIGIR OS DADOS E GERAR A NOTA NOVAMENTE!');
                   exit;
     end;



      if pos('erro não catalogado',LowerCase(E.Message) ) > 0 then
      begin

        vlItem := E.Message;
        vlItem := Copy(E.Message, pos('[', E.Message) + 1, 20);
        vlItem := SoNumeros(vlItem);

        showmessage('A T E N Ç Ã O:' + #13 + #13 + 'Sefaz fora do ar.' + #13 +'Tente novamente mais tarde!' );
          exit

      end ;

      if pos('Inativo ou Inoperante tente novamente',LowerCase(E.Message) ) > 0 then
      begin

        vlItem := E.Message;
        vlItem := Copy(E.Message, pos('[', E.Message) + 1, 20);
        vlItem := SoNumeros(vlItem);

        showmessage('A T E N Ç Ã O:' + #13 + #13 + 'Sefaz fora do ar.' + #13 +'Tente novamente mais tarde!' );
          exit

      end ;

      if (pos('Rejeicao: Informado NCM inexistente', E.Message) > 0) then
      begin

        vlItem := Copy(E.Message, pos('[', E.Message) + 1, 20);
        vlItem := SoNumeros(vlItem);

        ShowMessage('A T E N Ç Ã O:' + #13 + #13 + 'O produto :' + #13 + #13 + vACBrNFe.NotasFiscais.Items[0].NFe.Det.Items[StrToInt(vlItem) - 1]
          .Prod.xProd + ' esta com o NCM inválido!' + #13 + #13 + 'Por favor, ajustar no cadastro de Produtos');

        Exit;
      end
      else if (pos('NCM) - Conteúdo inválido.', E.Message) > 0) then
      begin

        vlItem := Copy(E.Message, pos('<', E.Message) + 1, 20);
        vlItem := SoNumeros(vlItem);

        ShowMessage('A T E N Ç Ã O:' + #13 + #13 + 'O produto :' + #13 + #13 + vACBrNFe.NotasFiscais.Items[0].NFe.Det.Items[StrToInt(vlItem) - 1]
          .Prod.xProd + ' esta com o NCM inválido!' + #13 + #13 + 'Por favor, ajustar no cadastro de Produtos');

        Exit;

      end
      else if pos('(Código de Situação da Operação  Simples Nacional)', E.Message) > 0 then
      begin

        vlItem := Copy(E.Message, pos('det nItem="', E.Message) + 1, 20);
        vlItem := SoNumeros(vlItem);

        ShowMessage('A T E N Ç Ã O:' + #13 + #13 + 'O produto :' + #13 + #13 + vACBrNFe.NotasFiscais.Items[0].NFe.Det.Items[StrToInt(vlItem) - 1]
          .Prod.xProd + #13 + ' esta com o Código CST/CSOSN inválido!' + #13 + #13 + 'Por favor, ajustar no cadastro de Produtos');

        Exit;
      end
      else if pos('GTIN', E.Message) > 0 then
      begin

        vlItem := Copy(E.Message, pos('[', E.Message) + 1, 20);
        vlItem := SoNumeros(vlItem);

        ShowMessage('A T E N Ç Ã O:' + #13 + #13 + 'O produto :' + #13 + #13 + vACBrNFe.NotasFiscais.Items[0].NFe.Det.Items[StrToInt(vlItem) - 1]
          .Prod.xProd + #13 + ' esta com o Código CÓDIGO DE BARRA inválida!' + #13 + #13 + 'Por favor, ajustar no cadastro de Produtos');

        Exit;
      end;

      Sleep(300);

      info.Lines.add('Vai consultar novamente a nota ' + datetimetostr(now));

      ACBrNFeNFCe.Consultar;

      vCStat := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.CStat;
      vXMotivo := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.xMotivo;
      vNumeronfe:=vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.chNFe;

      vNumeronfe:=copy(vNumeronfe,26,9);


      If (vCStat = 100) or (vCStat = 150) Then
      Begin
        vChaveNFE := Copy(vACBrNFe.NotasFiscais.Items[0].NFe.infNFe.ID, 4, 44);

        vProtocoloNFe := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.nProt;
        vhrNFe := TimeToStr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.procNFe.DhRecbto);
        vpDataAtual := strtodate(Copy(datetimetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.procNFe.DhRecbto), 1, 10));

        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';
        consulta.SQL.add('tdfcodigo = ' + QuotedStr('65') + ', ');
        consulta.SQL.add('refcodigo = 9, ');
        consulta.SQL.add('mesnumero = '+vNumeronfe+', ');

        // consulta.SQL.add('mesdatanfe = ' + QuotedStr(ajustadata(DateToStr(vpDataAtual))) + ', ');
        consulta.SQL.add('mesdatanfe = ' + QuotedStr(ajustadata((Copy(datetostr(vACBrNFe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10)))) + ', ');
        consulta.SQL.add('mesregistro = ' + QuotedStr(ajustadata((Copy(datetimetostr(vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.DhRecbto), 1, 10))
          )) + ', ');
        consulta.SQL.add('mesprotocolo = ' + QuotedStr(vProtocoloNFe) + ', ');
        consulta.SQL.add('meshoranfe = ' + QuotedStr(vhrNFe) + ', ');
        consulta.SQL.add('temcodigo = 5, ');
        consulta.SQL.add('meschavenfe = ' + QuotedStr(vChaveNFE) + ' WHERE ');
        consulta.SQL.add('meschave = ' + vMesChave) ;
        consulta.ExecSQL;

        mes.Close;
        mes.Params[0].AsString := fnfcepdv.vpMesChave;
        mes.Open;

        info.Lines.add('3605 Vai atualziar o banco ' + datetimetostr(now));


        try
          vlArqNFCe := GeraNomeArqNFCe(vMesChave, vFlaCodigo);
        except
        end;

        vACBrNFe.NotasFiscais.Clear;
        ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;
        Result := True;

        Exit;
      end;

      vCStat := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.CStat;
      vXMotivo := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.xMotivo;

      vErro := #13 + E.Message;

      vNovaChave := vChaveNFE;
      trim(Copy(vlxmotivo, pos('[', vlxmotivo) + 2, 44));

      vlxmotivo := vACBrNFe.WebServices.Enviar.RetornoWS;

      vlxmotivo := Copy(vlxmotivo, pos('<chNFe>', vlxmotivo) + 7, 5000);

      vNovaChave := vChaveNFE;
      vNovaChave := trim(Copy(vlxmotivo, 1, 44));

      vCStat := vACBrNFe.WebServices.Enviar.CStat;

      vlxmotivo := vErro;
      vlxmotivo := vACBrNFe.WebServices.Retorno.xMotivo;
      vNovaChave := trim(Copy(vlxmotivo, pos('[', vlxmotivo) + 2, 44));

      if vCStat = 539 then // Denegada emissão pelo sefaz
      begin

        vEmissaoNFCe := mesmesemissao.AsDateTime;
        vChaveNFCe := GeraNomeArqNFCe(vMesChave);
        VaaaammNFCe := vpPastaPrincipal + 'arqnfces' + '\' + formatdatetime('yyyymm', vEmissaoNFCe);
        vArqNFCe := vChaveNFCe;

        if FileExists(vArqNFCe) then
        begin

          ACBrNFeNFCe.NotasFiscais.Clear;
          ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;

          ACBrNFeNFCe.NotasFiscais.LoadFromFile(vArqNFCe);

          if ACBrNFeNFCe.NotasFiscais.Count > 0 then
          begin

            vProtocoloNFe := ACBrNFeNFCe.NotasFiscais.Items[0].NFe.procNFe.nProt;
            vlDataEmissao := ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi;
            try
              qconsulta.Close;
              qconsulta.SQL.Text := 'UPDATE mes SET ';
              qconsulta.SQL.add('tdfcodigo = ''65'', ');
              qconsulta.SQL.add('mesdatanfe = ''' + ajustadata(datetostr(vlDataEmissao)) + ''', ');
              qconsulta.SQL.add('mesregistro = ''' + ajustadata(datetostr(vlDataEmissao)) + ''', ');
              qconsulta.SQL.add('mesprotocolo = ''' + vProtocoloNFe + ''', ');
              qconsulta.SQL.add('temcodigo = 5, ');
              qconsulta.SQL.add('meschavenfe = ''' + vChaveNFCe + ''' ');
              qconsulta.SQL.add('WHERE meschave = ' + vMesChave);
              qconsulta.ExecSQL;
            except

            end;

          end;
        end;

      end
      else if (vCStat = 205) or (vCStat = 301) then // Denegada emissão pelo sefaz
      begin

        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';
        consulta.SQL.add('tdfcodigo = ' + QuotedStr('65') + ', ');
        consulta.SQL.add('refcodigo = 9, ');
        consulta.SQL.add('mesdatanfe = ' + QuotedStr(ajustadata(datetostr(vpDataAtual))) + ', ');
        consulta.SQL.add('mesregistro = ' + QuotedStr(ajustadata(datetostr(vpDataAtual))) + ', ');
        consulta.SQL.add('mesprotocolo = ' + QuotedStr(vProtocoloNFe) + ', ');
        consulta.SQL.add('temcodigo = 7, ');
        consulta.SQL.add('meschavenfe = ' + QuotedStr(vChaveNFE) + ' WHERE ');
        consulta.SQL.add('meschave = ' + vMesChave );
        consulta.ExecSQL;

      end

      else if (vCStat = 0) or (vCStat = 999) then // Geralmente indica falha de comunicação com a SEFAZ
      begin

        entraemcontigencia(Inttostr(vCStat)+ ' '+ E.Message);
        Sleep(500);
        vpNomeArquivoNFCe := fnfcepdv.GeraNomeArqNFCe(vMesChave, vFlaCodigo);

        GeraNFCe(vMesChave, fnfcepdv.vpFlacodigo);

        if SalvaEmCoontigencia(vACBrNFe, vMesChave) then
          Result := True
        else
          Result := False;
      end
      else
      begin
        SalvarLogErro('RETORNO GERADO PELA SEFAZ: ' + IntToStr(vCStat) + #13 + #13 + 'Erro envio da NFC-e.' + sLineBreak + E.Message, E.StackTrace);
        application.MessageBox(PChar('RETORNO GERADO PELA SEFAZ:' + #13 + #13 + 'Erro envio da NFC-e.' + #13 + 'Mensagem: ' + vErro + #13 + #13 + #13
          + 'Utilize a opção "Imprimir com NFC-e".'), 'Erro Envio NF-e', MB_OK + MB_ICONERROR);
        Result := False;
      end;
    End;
  end;
   info.Lines.add('Salvou a nota: ' + datetimetostr(now));
end;

procedure Tfnfcepdv.Setzcone(const Value: TUniConnection);
begin
  Fzcone := Value;
end;

procedure Tfnfcepdv.saidacontigencia;
var
  vlSituacao: Boolean;
begin
  vpWSNormal := True;
  vlSituacao := fnfcepdv.Visible;

  if rec.Active = False then
    rec.Open;

  if not(rec.IsEmpty) then
  begin
    rec.Edit;
    recrecdthorasaida.AsFloat := Now();
    rec.Post;
  end;

  rec.Close;

  fnfcepdv.Visible := vlSituacao;

end;

procedure Tfnfcepdv.entraemcontigencia(vStatSEFAZ: string);
var
  vlSituacao: Boolean;
begin
  vpWSNormal := False;
  vlSituacao := fnfcepdv.Visible;

  if vlSituacao = False then
    fnfcepdv.Show;

  if pos('Uma conexão com o servidor não pôde ser estabelecida', vStatSEFAZ) > 0 then
    vStatSEFAZ := '999 - ' + vStatSEFAZ;

  if rec.Active = False then
    rec.Open;

  if (rec.IsEmpty) then
  begin
    rec.Append;
    recrecdthoraentrada.AsFloat := vpDataAtual;
    recrecmotivo.AsString := 'Erro pdv 4144 :' +trim(vStatSEFAZ);
    rec.Post;
  end;

  rec.Close;

  fnfcepdv.Visible := vlSituacao;
end;

function Tfnfcepdv.AjustarDataViaSEFAZ(vData: String; vHora: String): Boolean;
var
  DataHora: TSystemTime;
  Data, Hora: TdateTime;
  Ano, mes, Dia, H, M, S, Mil: word;
begin
  Data := strtodate(vData);
  Hora := StrToTime(vHora);
  DecodeDate(Data, Ano, mes, Dia);
  DecodeTime(Hora, H, M, S, Mil);
  with DataHora do
  begin
    wYear := Ano;
    wMonth := mes;
    wDay := Dia;
    wHour := H;
    wMinute := M;
    wSecond := S;
    wMilliseconds := Mil;
  end;

  try
    SetLocalTime(DataHora);
  except
  end;
end;

{
  function Tfnfcepdv.ConsultaServicoSEFAZNFCE(vMostrar: Boolean = False): string;
  var
  vlRetornoErro: string;
  i: Integer;
  vlData: String;
  vlHora: String;

  Begin

  if LerConfiguracaoNFCe then
  begin

  vlRetornoErro := '';
  Result := '';

  PlTitulo.Caption := 'Consultando Status da SEFAZ.';

  if vMostrar then
  fnfcepdv.Show;

  try
  AjustaCaminhoGeralNF(vpDataAtual);

  ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := vMostrar;

  ACBrNFeNFCe.Configuracoes.Geral.ModeloDF := moNFCe;

  ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;

  ACBrNFeNFCe.WebServices.StatusServico.Executar;

  Result := UTF8Encode(ACBrNFeNFCe.WebServices.StatusServico.RetWS);

  vpDataHoraSEFAZ := ACBrNFeNFCe.WebServices.StatusServico.DhRecbto;

  vpStatusSEFAZ := ACBrNFeNFCe.WebServices.StatusServico.CStat.ToString;

  if vpStatusSEFAZ = '107' then
  begin

  vpWSNormal := True;

  vlData := trim(Copy(datetimetostr(vpDataHoraSEFAZ), 1, 10));
  vlHora := trim(Copy(datetimetostr(vpDataHoraSEFAZ), 11, 10));

  AjustarDataViaSEFAZ(vlData, vlHora);

  end
  else
  begin
  if vMostrar then
  begin
  application.MessageBox(PChar('ATENÇÃO: O Servidor da SEFAZ MT esta indisponível, por favor aguarde alguns minutos para nova tentativa.'),
  'Falha no servidor da SEFAZ MT', MB_OK + MB_ICONERROR);
  end;
  vpWSNormal := False;
  end;

  except
  on E: Exception do
  begin
  vlRetornoErro := E.Message;
  application.MessageBox(PChar('ATENÇÃO: O Servidor da SEFAZ MT esta indisponível, por favor aguarde alguns minutos para nova tentativa.' + #13
  + #13 + 'Mensagem: ' + #13 + vlRetornoErro), 'Falha comunicação WebService', MB_OK + MB_ICONERROR);
  end;
  end;
  end;
  End;
}
{
  function Tfnfcepdv.ConsultaServicoSEFAZNFCE: string;
  var
  vlRetornoErro: string;
  i: Integer;
  vpStatusSEFAZ: string;

  Begin
  if LerConfiguracaoNFCe then
  begin

  vlRetornoErro := '';
  Result := '';

  PlTitulo.Caption := 'Consultando Status da SEFAZ.';

  fnfcepdv.Show;

  // try
  AjustaCaminhoGeralNF(vpDataAtual);

  ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := vpConsultaVisivel;
  ACBrNFeNFCe.Configuracoes.Geral.ModeloDF := moNFCe;

  ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;

  ACBrNFeNFCe.WebServices.StatusServico.Executar;

  Result := UTF8Encode(ACBrNFeNFCe.WebServices.StatusServico.RetWS);
  vpDataHoraSEFAZ := ACBrNFeNFCe.WebServices.StatusServico.DhRecbto;
  vpStatusSEFAZ := ACBrNFeNFCe.WebServices.StatusServico.cStat.ToString;


  end;
  End;
}

Function Tfnfcepdv.AjustaSituacaoNFCe(vMesChave: string; vFlaCodigo: string = '1'; VMostra: Boolean = False): Boolean;
Var
  nProt: String;
  vnrnfe: String;
  vchNFe: String;
  vdtNFe: String;
  vhrNFe: String;
  vCodStatusNFe: String;
  vMsgStatusNFe: String;
  vMsgSituacao: string;
  vlchave: string;
  vErro: string;
  vCStat: Integer;
  vXMotivo: string;
  vMsgRetorno: string;

  vlNFCeProtocolo: string;
  vlNFCeChave: string;
  vldigVal: string;
  vemiNFe: string;
Begin
  try
    fnfcepdv.Show;
    Result := False;

    vlchave := vMesChave;
    consulta.Close;
    consulta.SQL.Text := 'select mesregistro from mes where meschave=' + vlchave;
    consulta.Open;

    fnfcepdv.vpDataAtual := consulta.FieldByName('mesregistro').AsDateTime;
    fnfcepdv.AjustaCaminhoGeralNF(fnfcepdv.vpDataAtual);

    if fnfcepdv.vpNomeArquivoNFCe = '' then
    begin
      consulta.Close;
      consulta.SQL.Text := 'update mes set temcodigo=4 where meschave=' + vlchave;
      consulta.ExecSQL;

      if VMostra then
      begin
        ShowMessage(#13 + #13 + '        Status - NFE : ' + 'P E N D E N T E' + #13 + #13 + #13 + #13 + '        ATENÇÃO:  Nota deve ser GERADA !');
      end;

      Exit;

    end;

    If not FileExists(vpNomeArquivoNFCe) Then
    Begin
      if self.mestemcodigo.AsInteger = 5 then
      begin
        vchNFe := self.mesmeschavenfe.AsString;

      end
      else
      begin
        if not vpConsultouSEFAZ then
        begin
          vpConsultaVisivel := False;
        end;

        self.GeraNFCe(vMesChave, fnfcepdv.vpFlacodigo);
      end;
      vpNomeArquivoNFCe := GeraNomeArqNFCe(vMesChave, fnfcepdv.vpFlacodigo);
    End;

    If not FileExists(vpNomeArquivoNFCe) Then
    begin
      ShowMessage('ATENÇÃO: O Arquivo ' + vpNomeArquivoNFCe + ' não foi localizado!');
      Exit(False);
    end;

    try
      vlNFCeProtocolo := mesmesprotocolo.AsString;
      vlNFCeChave := mesmeschavenfe.AsString;

      ACBrNFeNFCe.NotasFiscais.Clear;
      ACBrNFeNFCe.NotasFiscais.LoadFromFile(vpNomeArquivoNFCe);
      ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;
      ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := False;
      ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;

      ACBrNFeNFCe.Consultar;

      vdtNFe := datetostr(ACBrNFeNFCe.WebServices.consulta.DhRecbto);
      vhrNFe := TimeToStr(ACBrNFeNFCe.WebServices.consulta.DhRecbto);
      nProt := ACBrNFeNFCe.WebServices.consulta.Protocolo;
      vchNFe := ACBrNFeNFCe.WebServices.consulta.NFeChave;
      vCodStatusNFe := IntToStr(ACBrNFeNFCe.WebServices.consulta.CStat);
      vMsgStatusNFe := ACBrNFeNFCe.WebServices.consulta.xMotivo;
      vMsgStatusNFe := ACBrNFeNFCe.WebServices.consulta.xMotivo;

      (* Verifica código de retorno é igual a 100 - Uso Autorizado *)

      If (ACBrNFeNFCe.WebServices.consulta.CStat = 104) Then
      begin

        Result := True;
        {
        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=1';
        consulta.ExecSQL;
        }
        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';
        // consulta.SQL.add('mesdatanfe = ''' + ajustadata((Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.protNFe.DhRecbto), 1, 10))) + ''', ');
        consulta.SQL.add('mesdatanfe = ' + QuotedStr(ajustadata((Copy(datetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10)))) + ', ');
        consulta.SQL.add('mesregistro = ''' + ajustadata((Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.protNFe.DhRecbto), 1, 10))) + ''', ');

        consulta.SQL.add('meschavenfe = ''' + ACBrNFeNFCe.WebServices.consulta.protNFe.chNFe + ''', ');
        consulta.SQL.add('tdfcodigo = ''65'', ');
        consulta.SQL.add('meshoranfe = ' + QuotedStr(TimeToStr(ACBrNFeNFCe.WebServices.consulta.protNFe.DhRecbto)) + ', ');
        consulta.SQL.add('refcodigo = 9, ');
        consulta.SQL.add('temcodigo = 5, ');
        consulta.SQL.add('mesprotocolo = ''' + SoNumeros(ACBrNFeNFCe.WebServices.consulta.protNFe.xMotivo) + ''' WHERE ');
        consulta.SQL.add('meschave = ' + vlchave );
        consulta.ExecSQL;

        {
        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=null';
        consulta.ExecSQL;
        }
        try
          if FileExists(vpNomeArquivoNFCe) then
          begin
            if not mes.Active then
            begin
              mes.Close;
              mes.Params[0].AsString := vMesChave;
              mes.Open;
            end;

          end;

        except
        end;

        consulta.Close;
        consulta.SQL.Text := 'select mesemissao,mesnumero, meschavenfe,tdfcodigo,mesprotocolo, mesdatanfe from mes where meschave=' + vlchave +
          ' and flacodigo=' + vFlaCodigo;
        consulta.Open;

      end
      else If (ACBrNFeNFCe.WebServices.consulta.CStat = 100) { or (ACBrNFeNFCe.WebServices.Consulta.cStat = 217) } Then
      begin

        Result := True;
        {
        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=1';
        consulta.ExecSQL;
        }
        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';
        // consulta.SQL.add('mesdatanfe = ''' + ajustadata((Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.DhRecbto), 1, 10))) + ''', ');
        consulta.SQL.add('mesdatanfe = ' + QuotedStr(ajustadata((Copy(datetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10)))) + ', ');
        consulta.SQL.add('mesregistro = ''' + ajustadata((Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.DhRecbto), 1, 10))) + ''', ');

        consulta.SQL.add('meschavenfe = ''' + vchNFe + ''', ');
        consulta.SQL.add('tdfcodigo = ''65'', ');
        consulta.SQL.add('meshoranfe = ' + QuotedStr(vhrNFe) + ', ');
        consulta.SQL.add('refcodigo = 9, ');
        consulta.SQL.add('temcodigo = 5, ');
        consulta.SQL.add('mesprotocolo = ''' + nProt + ''' WHERE ');
        consulta.SQL.add('meschave = ' + vlchave);
        consulta.ExecSQL;
        {
        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=null';
        consulta.ExecSQL;
        }
        try
          if FileExists(vpNomeArquivoNFCe) then
          begin
            if not mes.Active then
            begin
              mes.Close;
              mes.Params[0].AsString := vMesChave;
              mes.Open;
            end;

          end;

        except
        end;

        consulta.Close;
        consulta.SQL.Text := 'select mesemissao,mesnumero, meschavenfe,tdfcodigo,mesprotocolo, mesdatanfe from mes where meschave=' + vlchave +
          ' and flacodigo=' + vFlaCodigo;
        consulta.Open;

        consulta.Close;
      end
      else If (ACBrNFeNFCe.WebServices.consulta.CStat = 101) Then
      begin

        Result := True;
        {
        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=1';
        consulta.ExecSQL;
        }
        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';
        consulta.SQL.add('mesemissao = ''' + ajustadata(vdtNFe) + ''', ');
        consulta.SQL.add('sdecodigo = ''02'', ');
        consulta.SQL.add('tdfcodigo = ''65'', ');
        consulta.SQL.add('refcodigo = 9, ');
        consulta.SQL.add('temcodigo = 5, ');
        consulta.SQL.add('mesprotocolo = ''' + nProt + ''' WHERE ');
        consulta.SQL.add('meschave = ' + vlchave);
        consulta.ExecSQL;
        {
        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=null';
        consulta.ExecSQL;
         }
        consulta.Close;
        consulta.SQL.Text := 'select mesemissao,mesnumero, meschavenfe,tdfcodigo,mesprotocolo, mesdatanfe from mes where meschave=' + vlchave +
          ' and flacodigo=' + vFlaCodigo;
        consulta.Open;

        consulta.Close;

      end
      else If (ACBrNFeNFCe.WebServices.consulta.CStat = 150) Then
      begin
        Result := True;
        {
        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=1';
        consulta.ExecSQL;
         }
        if (ACBrNFeNFCe.WebServices.consulta.CStat = 150) then
        begin
          vdtNFe := Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.protNFe.DhRecbto), 1, 10);
          vhrNFe := TimeToStr(ACBrNFeNFCe.WebServices.consulta.protNFe.DhRecbto);
          vemiNFe := Copy(datetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10);
        end
        else
        begin
          vdtNFe := Copy(datetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10);
          vhrNFe := TimeToStr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi);
          vemiNFe := Copy(datetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10);
        end;

        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';

        consulta.SQL.add('mesregistro = ''' + vdtNFe + ''', ');
        consulta.SQL.add('mesdatanfe = ''' + vemiNFe + ''', ');
        consulta.SQL.add('meshoranfe = ' + QuotedStr(vhrNFe) + ', ');


        // consulta.SQL.add('mesdatanfe = ' + QuotedStr(ajustadata((Copy(datetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.ide.dEmi), 1, 10)))) + ', ');
        // consulta.SQL.add('mesregistro = ''' + ajustadata((Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.DhRecbto), 1, 10))) + ''', ');

        consulta.SQL.add('meschavenfe = ''' + vchNFe + ''', ');
        consulta.SQL.add('sdecodigo = ''00'', ');
        consulta.SQL.add('tdfcodigo = ''65'', ');
        consulta.SQL.add('refcodigo = 9, ');
        consulta.SQL.add('temcodigo = 5, ');
        consulta.SQL.add('mesprotocolo = ''' + nProt + ''' WHERE ');
        consulta.SQL.add('meschave = ' + vlchave );
        consulta.ExecSQL;
        {
        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=null';
        consulta.ExecSQL;
        }
        consulta.Close;
        consulta.SQL.Text := 'select mesemissao,mesnumero, meschavenfe,tdfcodigo,mesprotocolo, mesdatanfe from mes where meschave=' + vlchave +
          ' and flacodigo=' + vFlaCodigo;
        consulta.Open;

        consulta.Close;

        try
          if FileExists(vpNomeArquivoNFCe) then
          begin
            if not mes.Active then
            begin
              mes.Close;
              mes.Params[0].AsString := vMesChave;
              mes.Open;
            end;

          end;

        except
        end;

      end;

      if VMostra then
      begin

        consulta.Close;
        consulta.SQL.Text := 'select mesemissao,mesnumero, meschavenfe,tdfcodigo,mesprotocolo, mesdatanfe from mes where meschave=' + vlchave +
          ' and flacodigo=' + vFlaCodigo;
        consulta.Open;

        ShowMessage('Registro: ' + consulta.Fields[5].AsString + ''#13'' + (* *)
          'Nr. NFE: ' + consulta.Fields[1].AsString + ''#13'' + (* *)
          'Chave  : ' + consulta.Fields[2].AsString + ''#13'' + #13 + #13 + (* *)
          'Código Status: ' + vCodStatusNFe + #13 + (* *)
          'Status - NFE : ' + vMsgStatusNFe + #13 + (* *)
          'Protocolo Nr.: ' + nProt + #13 + (* *)
          'Data  e  Hora: ' + vdtNFe + ' - ' + vhrNFe);

      end;

    except
      on e: Exception do
      begin
        entraemcontigencia(e.Message +' - Falha de comunicação com SEFAZ - MT');
      end;
    end;

  finally
  end;
End;

procedure Tfnfcepdv.IO_OpenSSLStatusInfo(const AMsg: string);
begin
  Sleep(700);
  application.ProcessMessages;
end;

procedure Tfnfcepdv.ACBrNFeNFCeGerarLog(const ALogLine: string;
  var Tratado: Boolean);
begin
  info.Lines.add(datetimetostr(now)+ ' '+ALogLine);
end;

procedure Tfnfcepdv.ACBrNFeNFCeTransmit(const Dados, URL, SoapAction,
  MimeType: string; var Resposta: string; var HTTPResultCode,
  InternalErrorCode: Integer);
begin
  info.Lines.add('Rsposta sefaz ' +Dados+': ' + datetimetostr(now));
end;

procedure Tfnfcepdv.AjustaCaminhoGeralNF(Data: TDate);
begin
  // verifca se os diretorios existem se nao ja cria os mesmos

  fnfcepdv.vpPastaPrincipal := ExtractFilePath(application.ExeName);

    if Copy(fnfcepdv.vpPastaPrincipal, Length(fnfcepdv.vpPastaPrincipal), 1) <> '\' then
      fnfcepdv.vpPastaPrincipal := fnfcepdv.vpPastaPrincipal + '\';

    fnfcepdv.vpSubPastaDoc := 'arqnfces';


  if not DirectoryExists(vpPastaPrincipal + 'pdfs') then
    ForceDirectories(vpPastaPrincipal + 'pdfs');

  if not DirectoryExists(vpPastaPrincipal) then
    ForceDirectories(vpPastaPrincipal);

  vpAAAAMMNNNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', Data) + '\';

  if not DirectoryExists(vpAAAAMMNNNFCe) then
    ForceDirectories(vpAAAAMMNNNFCe);

  ACBrNFeNFCe.Configuracoes.Arquivos.PathSalvar := vpAAAAMMNNNFCe;
  ACBrNFeDANFCEFR1.PathPDF := vpPastaPrincipal + 'pdfs\';
end;

function Tfnfcepdv.LerConfiguracaoNFCe: Boolean;
Begin

  cfg.Close;
  cfg.ParamByName('flacodigo').AsString := '1';
  cfg.Open;

  Result := True;

  ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := False;
  ACBrNFeNFCe.Configuracoes.Arquivos.PathSchemas := ExtractFilePath(application.ExeName) + 'schemas';
  ACBrNFeNFCe.Configuracoes.Arquivos.IniServicos := ExtractFilePath(application.ExeName) + 'schemas\ACBrNFeServicos.ini';

  ACBrNFeNFCe.Configuracoes.Geral.ModeloDF := moNFCe;
  ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;

  ACBrNFeNFCe.SSL.DescarregarCertificado;

  if (Length(cfgcfgsenhacertificadoa1.AsString) > 0) then
  begin
    cfgcfgcertificadoa1.SaveToFile(ExtractFilePath(application.ExeName) + 'certificado.pfx');

    ACBrNFeNFCe.Configuracoes.Certificados.ArquivoPFX := ExtractFilePath(application.ExeName) + 'certificado.pfx';
    ACBrNFeNFCe.Configuracoes.Certificados.NumeroSerie := '';

  end
  else
  begin
    ACBrNFeNFCe.Configuracoes.Certificados.NumeroSerie := self.cfgcfgnumecertifa1.AsString;
  end;
  ACBrNFeNFCe.Configuracoes.Certificados.Senha := cfgcfgsenhacertificadoa1.AsString;

  ACBrNFeNFCe.SSL.SSLType := LT_TLSv1_2;
  ACBrNFeNFCe.Configuracoes.Geral.SSLLib := libOpenSSL;
  ACBrNFeNFCe.Configuracoes.Geral.SSLCryptLib := cryOpenSSL;
  ACBrNFeNFCe.Configuracoes.Geral.SSLHttpLib := httpOpenSSL;
  ACBrNFeNFCe.Configuracoes.Geral.SSLXmlSignLib := xsLibXml2;


  ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teNormal;
  ACBrNFeNFCe.Configuracoes.Geral.Salvar := True;

  ACBrNFeNFCe.Configuracoes.WebServices.UF := UpperCase(self.cfgufssigla.AsString);

  if cfgcfgmodonfe.AsInteger = 2 then
  begin
    ACBrNFeNFCe.Configuracoes.Geral.IdCSC := FormatFloat('000000', cfgcfgidtokennfce.AsInteger);
    ACBrNFeNFCe.Configuracoes.Geral.CSC := lowercase(cfgcfgtoken1nfce.AsString);
    ACBrNFeNFCe.Configuracoes.WebServices.Ambiente := taHomologacao;
  end
  else if cfgcfgmodonfe.AsInteger = 1 then
  begin
    ACBrNFeNFCe.Configuracoes.Geral.IdCSC := FormatFloat('000000', cfgcfgidtokennfce.AsInteger);
    ACBrNFeNFCe.Configuracoes.Geral.CSC := lowercase(cfgcfgtoken1nfce.AsString);
    ACBrNFeNFCe.Configuracoes.WebServices.Ambiente := taProducao;
  end;

  ACBrNFeNFCe.Configuracoes.WebServices.TimeZoneConf.ModoDeteccao := tzManual;
  ACBrNFeNFCe.Configuracoes.WebServices.TimeZoneConf.TimeZoneStr := '-04:00';


End;



{

function Tfnfcepdv.LerConfiguracaoNFCe: Boolean;
var
  vlTentativas:Integer;
Begin
  vlTentativas := 0;

  while True do
  begin
    TRY

      VerificaConexaoAntesdeExecutar(cfg);

      cfg.Close;
      cfg.ParamByName('flacodigo').AsInteger := Acesso.Filial;
      cfg.Open;

      break;

    except
    on E: EAccessViolation do
      begin
        sleep(1000);
        vlTentativas:=vlTentativas+1;
        cfg.Open;
        if vlTentativas>60 then
        Break
      end;
    end;
  end;

  Result := True;

  ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := False;
  ACBrNFeNFCe.Configuracoes.Arquivos.PathSchemas := ExtractFilePath(application.ExeName) + 'schemas';
  ACBrNFeNFCe.Configuracoes.Arquivos.IniServicos := ExtractFilePath(application.ExeName) + 'schemas\ACBrNFeServicos.ini';

  ACBrNFeNFCe.Configuracoes.Geral.ModeloDF := moNFCe;
  ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;

  if (Length(cfgcfgsenhacertificadoa1.AsString) > 0) then
  begin
    ACBrNFeNFCe.Configuracoes.Certificados.Senha := cfgcfgsenhacertificadoa1.AsString;

    cfgcfgcertificadoa1.SaveToFile(ExtractFilePath(application.ExeName) + 'certificado.pfx');

    ACBrNFeNFCe.Configuracoes.Certificados.ArquivoPFX := ExtractFilePath(application.ExeName) + 'certificado.pfx';
    ACBrNFeNFCe.Configuracoes.Certificados.NumeroSerie := '';

  end
  else
  begin
    ACBrNFeNFCe.Configuracoes.Certificados.NumeroSerie := self.cfgcfgnumecertifa1.AsString;
  end;

  ACBrNFeNFCe.SSL.SSLType := LT_TLSv1_2;
  ACBrNFeNFCe.Configuracoes.Geral.SSLLib := libOpenSSL;
  ACBrNFeNFCe.Configuracoes.Geral.SSLCryptLib := cryOpenSSL;
  ACBrNFeNFCe.Configuracoes.Geral.SSLHttpLib := httpOpenSSL;
  ACBrNFeNFCe.Configuracoes.Geral.SSLXmlSignLib := xsLibXml2;

  ACBrNFeNFCe.Configuracoes.Certificados.Senha := cfgcfgsenhacertificadoa1.AsString;

  ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teNormal;
  ACBrNFeNFCe.Configuracoes.Geral.Salvar := True;

  ACBrNFeNFCe.Configuracoes.WebServices.UF := UpperCase(self.cfgufssigla.AsString);

  if cfgcfgmodonfe.AsInteger = 2 then
  begin
    ACBrNFeNFCe.Configuracoes.Geral.IdCSC := FormatFloat('000000', cfgcfgidtokennfce.AsInteger);
    ACBrNFeNFCe.Configuracoes.Geral.CSC := lowercase(cfgcfgtoken1nfce.AsString);
    ACBrNFeNFCe.Configuracoes.WebServices.Ambiente := taHomologacao;
  end
  else if cfgcfgmodonfe.AsInteger = 1 then
  begin
    ACBrNFeNFCe.Configuracoes.Geral.IdCSC := FormatFloat('000000', cfgcfgidtokennfce.AsInteger);
    ACBrNFeNFCe.Configuracoes.Geral.CSC := lowercase(cfgcfgtoken1nfce.AsString);
    ACBrNFeNFCe.Configuracoes.WebServices.Ambiente := taProducao;
  end;

  ACBrNFeNFCe.Configuracoes.WebServices.TimeZoneConf.ModoDeteccao := tzManual;
  ACBrNFeNFCe.Configuracoes.WebServices.TimeZoneConf.TimeZoneStr := '-04:00';

End;
}

procedure Tfnfcepdv.SalvarLogErro(eMessage, eStackTrace: String);
var
  vlMensagem: String;
  vlArquivo: String;
begin
  vlMensagem := 'Mensagem: ' + eMessage + sLineBreak + sLineBreak + eStackTrace;

  vlArquivo := ExtractFilePath(application.ExeName) + 'Logs\NFCe\' + formatdatetime('yyyymmddhhnnsszzz', vpDataAtual) + '.txt';

  SalvarTextoEmArquivo(vlMensagem, vlArquivo);
end;






procedure Tfnfcepdv.AtribuiEventosQuery;
var
  i:Integer;
begin
 for i := 0 to Self.ComponentCount - 1 do
    begin
      if Self.Components[i] is TUniQuery then
      begin
        (Self.Components[i] as TUniQuery).BeforeExecute := VerificaConexaoAntesdeExecutar;
        (Self.Components[i] as TUniQuery).BeforeOpen := VerificaconexaoantesdeAplicar;
        (Self.Components[i] as TUniQuery).BeforePost := VerificaconexaoantesdeAplicar;
        (Self.Components[i] as TUniQuery).BeforeEdit := VerificaconexaoantesdeAplicar;
        (Self.Components[i] as TUniQuery).BeforeDelete := VerificaconexaoantesdeAplicar;
      end;

    end;
end;

procedure Tfnfcepdv.VerificaconexaoantesdeAplicar(DataSet: TDataSet);
var
  i: Integer;
begin
  if DataSet <> nil then
  begin
    if (DataSet is TUniQuery) then
    begin
      if (DataSet as TUniQuery).Connection.Connected = False then
      begin
        i := 0;
        while i <= 30 do
        begin
          try

            sleep(1000);
            (DataSet as TUniQuery).Connection.Connected := True;
            exit;
          except
            i := i + 1;
          end;
        end;
      end;
    end;
  end;
end;


procedure Tfnfcepdv.VerificaConexaoAntesdeExecutar(Sender: TObject);
var
  i: Integer;
begin
  if (Sender is TUniQuery) then
  begin
    if (Sender as TUniQuery).Connection.Connected = False then
    begin
      i := 0;
      while i <= 60 do
      begin
        try

          sleep(1000);
          (Sender as TUniQuery).Connection.Connected := True;
          Break;
        except
          i := i + 1;
        end;
      end;
    end;
  end;
end;



function Tfnfcepdv.ConsultaServicoSEFAZNFCE(vMostrar: Boolean = False): string;
var
  vlRetornoErro: string;
  i: Integer;
  vlData: String;
  vlHora: String;

Begin

  if LerConfiguracaoNFCe then
  begin

    vlRetornoErro := '';
    Result := '';

    PlTitulo.Caption := 'Consultando Status da SEFAZ.';

    if vMostrar then
      fnfcepdv.Show;

    try
      AjustaCaminhoGeralNF(vpDataAtual);

      ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := vMostrar;

      ACBrNFeNFCe.Configuracoes.Geral.ModeloDF := moNFCe;

      ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;

      ACBrNFeNFCe.WebServices.StatusServico.Executar;

      Result := UTF8Encode(ACBrNFeNFCe.WebServices.StatusServico.RetWS);

      vpDataHoraSEFAZ := ACBrNFeNFCe.WebServices.StatusServico.DhRecbto;

      vpStatusSEFAZ := ACBrNFeNFCe.WebServices.StatusServico.CStat.ToString;

      if vpStatusSEFAZ = '107' then
      begin

        vpWSNormal := True;

        vlData := trim(Copy(datetimetostr(vpDataHoraSEFAZ), 1, 10));
        vlHora := trim(Copy(datetimetostr(vpDataHoraSEFAZ), 11, 10));

        AjustarDataViaSEFAZ(vlData, vlHora);

        vpDataAtual := vpDataHoraSEFAZ;

        vpConsultouSEFAZ := True;

        Result :=datetimetostr(vpDataHoraSEFAZ);

        saidacontigencia;

      end
      else
      begin

        entraemcontigencia(vpStatusSEFAZ +' Consulta direta: Portal do SEFAZ MT esta sem conexao');

        vpConsultouSEFAZ := False;

        if vMostrar then
        begin
          application.MessageBox(PChar('ATENÇÃO: O Servidor da SEFAZ MT esta indisponível, por favor aguarde alguns minutos para nova tentativa.'),
            'Falha no servidor da SEFAZ MT', MB_OK + MB_ICONERROR);
        end;

        vpWSNormal := False;

        vpDataAtual := strtodatetime(agora(application, zcone));

        Result:='';

      end;

    except
      on e: Exception do
      begin
        vlRetornoErro := e.Message;

        entraemcontigencia('Falha de conexao: '+ vlRetornoErro );
        result:='';

        // application.MessageBox(PChar('ATENÇÃO: O Servidor da SEFAZ MT esta indisponível, por favor aguarde alguns minutos para nova tentativa.' + #13
        // + #13 + 'Mensagem: ' + #13 + vlRetornoErro), 'Falha comunicação WebService', MB_OK + MB_ICONERROR);
      end;
    end;
  end;
End;



end.
