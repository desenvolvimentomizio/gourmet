unit ufImpressora01;

interface

uses
  Winapi.Windows, Winapi.Messages, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs,   Data.DB,
  MemDS, DBAccess, Uni, Vcl.StdCtrls, json, RESTRequest4D;

type
  TfImpressora01 = class(TForm)
    orc: TUniQuery;
    ito: TUniQuery;
    brd: TUniQuery;
    sbr: TUniQuery;
    isi: TUniQuery;
    cfg: TUniQuery;
    total: TUniQuery;
    ori: TUniQuery;
    mImp: TMemo;
    consulta: TUniQuery;
  private

    { Private declarations }
    procedure GeraPedido;
  public
    { Public declarations }
    fzcone:TUniConnection;
    fPedAuxi:Boolean;

    function GeraTextoPedido(aOrcchave: String; aTciCodigo:String): TStrings;
    function GeraTextoPedidoImm(aOrcchave: String; aTciCodigo:String;aImmPedido:String): TStrings;

  end;

var
  fImpressora01: TfImpressora01;


implementation

uses
  System.AnsiStrings, System.StrUtils, System.SysUtils;

{$R *.dfm}

{ TfImpressora01 }


procedure TfImpressora01.GeraPedido;
begin
  mImp.Lines.clear;
  mImp.Lines.Add('</zera>');

  // cabeçalho

  if orc.FieldByName('immnumepedido').AsInteger<4999 then
  begin

    mImp.Lines.Add('*****************************************');
    if fPedAuxi then
      mImp.Lines.Add('</fn></ad><e><a><n>AUX ENTREGA Ped. '+ orc.FieldByName('immnumepedido').AsString +'   </n></a></e>')
    else
      mImp.Lines.Add('</fn></ad><e><a><n>ENTREGA   Ped. '+ orc.FieldByName('immnumepedido').AsString +'   </n></a></e>');

  end
  else
  begin

    mImp.Lines.Add('*****************************************');
    mImp.Lines.Add('</fn></ad><e><a><n>MESA: '+orc.FieldByName('orcmesa').AsString +'     Ped. '+ orc.FieldByName('immnumepedido').AsString +'   </n></a></e>');
    mImp.Lines.Add('');
    mImp.Lines.Add('');


  end;

  while not ito.Eof do
  begin
    // itens
   mImp.Lines.Add('</fn></ae>############################################');
    mImp.Lines.Add('<n><e><a><S> '+
     IFthen(ito.FieldByName('itoquantidade').AsInteger=1,'',ito.FieldByName('itoquantidade').AsString)+

     IFthen(ito.FieldByName('pronome').AsString<>'PIZZA',
        IFthen(ito.FieldByName('uninome').AsString <>'UNIDADE',ito.FieldByName('uninome').AsString,'') +
     IFthen(ito.FieldByName('grpidentificacao').AsString ='PORÇÕES',' PORÇÃO ',' ') +
     ' '+ito.FieldByName('pronome').AsString  ,ito.FieldByName('uninome').AsString)+
    '</n></e></a></S>');

    if ito.FieldByName('itoobs').AsString<>'' then
    begin
      mImp.Lines.Add('    <e><i><s>'+copy(ito.FieldByName('itoobs').AsString,1,20)+'</i></e></s>');

      if copy(ito.FieldByName('itoobs').AsString,21,20)<>'' then
        mImp.Lines.Add('    <e><i><s>'+copy(ito.FieldByName('itoobs').AsString,21,20)+'</i></e></s>');
      if copy(ito.FieldByName('itoobs').AsString,41,20)<>'' then
        mImp.Lines.Add('    <e><i><s>'+copy(ito.FieldByName('itoobs').AsString,41,20)+'</i></e></s>');

    end;

    brd.Close;
    brd.Connection:=fzcone;
    brd.ParamByName('itochave').AsString:=ito.FieldByName('itochave').AsString;
    brd.Open;

    if not brd.IsEmpty then
    begin
     mImp.Lines.Add(' ');
       mImp.Lines.Add('<e><n><i> B O R D A S</i></n></e>');
    end;

    while not brd.Eof do
    begin
      // bordas
       mImp.Lines.Add('<e><n>     '+brd.FieldByName('brdidentificacao').AsString+'</n></e>');
      brd.Next;
    end;

    sbr.Close;
    sbr.Connection:=fzcone;
    sbr.ParamByName('itochave').AsString:=ito.FieldByName('itochave').AsString;
    sbr.Open;


    mImp.Lines.Add(' ');


    while not sbr.Eof do
    begin

      // sabores

      if ito.FieldByName('sfncodigo').AsString<>'' then
      begin

        if sbr.FieldByName('sbiobs').AsString<>'' then
        begin
          mImp.Lines.Add('   <i><e>'+sbr.FieldByName('sbridentificacao').AsString+'</e></i>');
          mImp.Lines.Add('     <i>('+sbr.FieldByName('sbiobs').AsString+')</i>');
        end
        else
        begin
          mImp.Lines.Add('<i><e> '+sbr.FieldByName('sbridentificacao').AsString+'</e></i>');
        end;

      end;

      // ingredientes

      isi.Close;
      isi.Connection:=fzcone;
      isi.ParamByName('sbichave').AsString:=sbr.FieldByName('sbichave').AsString;
      isi.Open;

      while not isi.Eof do
      begin
        // ingredientes
        if isi.FieldByName('tsicodigo').AsInteger=1 then  // sem
        begin

          mImp.Lines.Add(
            '     <in><e>'+
            copy(
            IFThen(isi.FieldByName('isitipo').AsString='1','Adicionar','')+
            ''+IFThen(isi.FieldByName('tsicodigo').AsString='3','',isi.FieldByName('tsiidentificacao').AsString)+
            ' '+isi.FieldByName('ingnome').AsString,1,20)+'</in></e>');

            if length(trim(copy(
            IFThen(isi.FieldByName('isitipo').AsString='1','Adicionar','')+
            ''+IFThen(isi.FieldByName('tsicodigo').AsString='3','',isi.FieldByName('tsiidentificacao').AsString)+
            ' '+isi.FieldByName('ingnome').AsString,21,20)))>0 then
            begin
              mImp.Lines.Add(
                '     <in><e>'+
                trim(copy(
                IFThen(isi.FieldByName('isitipo').AsString='1','Adicionar','')+
                ''+IFThen(isi.FieldByName('tsicodigo').AsString='3','',isi.FieldByName('tsiidentificacao').AsString)+
                ' '+isi.FieldByName('ingnome').AsString,21,20))+'</in></e>');
            end;

            if length(trim(copy(
            IFThen(isi.FieldByName('isitipo').AsString='1','Adicionar','')+
            ''+IFThen(isi.FieldByName('tsicodigo').AsString='3','',isi.FieldByName('tsiidentificacao').AsString)+
            ' '+isi.FieldByName('ingnome').AsString,41,20)))>0 then
            begin
              mImp.Lines.Add(
                '     <in><e>'+
                trim(copy(
                IFThen(isi.FieldByName('isitipo').AsString='1','Adicionar','')+
                ''+IFThen(isi.FieldByName('tsicodigo').AsString='3','',isi.FieldByName('tsiidentificacao').AsString)+
                ' '+isi.FieldByName('ingnome').AsString,41,20))+'</in></e>');
            end;

        end
        else
        begin
          mImp.Lines.Add(
            '     <e>'+
            copy(
            IFThen(isi.FieldByName('isitipo').AsString='1','Adicionar','')+
            ''+IFThen(isi.FieldByName('tsicodigo').AsString='3','',isi.FieldByName('tsiidentificacao').AsString)+
            ' '+isi.FieldByName('ingnome').AsString,1,20)+'</e>');

            if length(trim(copy(
            IFThen(isi.FieldByName('isitipo').AsString='1','Adicionar','')+
            ''+IFThen(isi.FieldByName('tsicodigo').AsString='3','',isi.FieldByName('tsiidentificacao').AsString)+
            ' '+isi.FieldByName('ingnome').AsString,21,20)))>0 then
            begin
              mImp.Lines.Add(
                '     <e>'+
               trim( copy(
                IFThen(isi.FieldByName('isitipo').AsString='1','Adicionar','')+
                ''+IFThen(isi.FieldByName('tsicodigo').AsString='3','',isi.FieldByName('tsiidentificacao').AsString)+
                ' '+isi.FieldByName('ingnome').AsString,21,20))+'</e>');
            end;

            if length(trim(copy(
            IFThen(isi.FieldByName('isitipo').AsString='1','Adicionar','')+
            ''+IFThen(isi.FieldByName('tsicodigo').AsString='3','',isi.FieldByName('tsiidentificacao').AsString)+
            ' '+isi.FieldByName('ingnome').AsString,41,20)))>0 then
            begin
              mImp.Lines.Add(
                '     <e>'+
                trim(copy(
                IFThen(isi.FieldByName('isitipo').AsString='1','Adicionar','')+
                ''+IFThen(isi.FieldByName('tsicodigo').AsString='3','',isi.FieldByName('tsiidentificacao').AsString)+
                ' '+isi.FieldByName('ingnome').AsString,41,20))+'</e>');
            end;

            mImp.Lines.Add('');

        end;
        isi.Next;
      end;

      sbr.Next;
    end;

    ito.Next;
  end;

  if (orc.FieldByName('immnumepedido').AsInteger<=4999) AND (fPedAuxi=FALSE) then
  begin

    mImp.Lines.Add(' ===============================================');
    mImp.Lines.Add('</fn></ad><n><e>'+ 'TOTAL  R$ '+FormatCurr('#.#0', total.FieldByName('total').AsCurrency)+' </fn></ae></n></e>');
    mImp.Lines.Add('</fn></ad>===============================================<n><e>');
    mImp.Lines.Add('');

    mImp.Lines.Add('</fn></ae>');

    mImp.Lines.Add('<n><e>'+orc.FieldByName('etdidentificacao').AsString);

    mImp.Lines.Add(orc.FieldByName('edrrua').AsString+','+orc.FieldByName('edrnumero').AsString);
    mImp.Lines.Add(orc.FieldByName('edrbairro').AsString);
    if orc.FieldByName('etftelefone').AsString<>'' then
    begin
      if length(orc.FieldByName('etftelefone').AsString)=10 then
        mImp.Lines.Add(FormatFloat('(00) 0000-0000',orc.FieldByName('etftelefone').Asfloat))
      else
        mImp.Lines.Add(FormatFloat('(00) 00000-0000',orc.FieldByName('etftelefone').Asfloat));
    end;
    if trim(orc.FieldByName('etdobs').AsString)<>'' then
    begin
      mImp.Lines.Add(' ');
      mImp.Lines.Add('<in>* Obs.: '+orc.FieldByName('etdobs').AsString+'</in>');
    end;




    mImp.Lines.Add(orc.FieldByName('edrobs').AsString);
    mImp.Lines.Add(orc.FieldByName('orcobs').AsString+'</n></e>');
    mImp.Lines.Add('**********************************************');

    mImp.Lines.Add('<n>Hr.Ped.: '+ orc.FieldByName('orcdataabert').AsString+ ' '+
                               orc.FieldByName('orchoraabert').AsString+ ' '+
                               orc.FieldByName('clbidentificacao').AsString );
    mImp.Lines.Add('Origem : '+ori.FieldByName('oriidentificacao').asstring+ ' Ped.: '+
                            ifthen(orc.FieldByName('orcpedidointegracao').asstring='',
                                   ori.FieldByName('orcnumeropedido').asstring,
                                   orc.FieldByName('orcpedidointegracao').asstring)+'</n>');

    mImp.Lines.Add('</fn></ce><qrcode_tipo>2</qrcode_tipo>');
    mImp.Lines.Add('<qrcode_largura>6</qrcode_largura>');
    mImp.Lines.Add('<qrcode_error>0</qrcode_error>');
    mImp.Lines.Add('<qrcode>'+orc.FieldByName('orcqrcode').asstring+'</qrcode>');
    mImp.Lines.Add('</ce>');
    mImp.Lines.Add('Mizio Sistemas-(66) 3544-2765. VR: 0001');

    mImp.Lines.Add(' > > > >   Final do Pedido   < < < <');
    mImp.Lines.Add('</fn></ce>.');
    mImp.Lines.Add('</corte_parcial>');
    mImp.Lines.Add('.');
  end
  else
  begin
    mImp.Lines.Add('.');
    mImp.Lines.Add('.');
    mImp.Lines.Add('</fn></ce>.');
    mImp.Lines.Add(' > > >   Final do Pedido   < < <');
    mImp.Lines.Add('.');
    mImp.Lines.Add('</corte_parcial>');
    mImp.Lines.Add('.');
  end;

end;




function TfImpressora01.GeraTextoPedido(aOrcchave: String; aTciCodigo:String): TStrings;
begin
  try
    Result:=Nil;

      cfg.close;
      cfg.Connection:=fzcone;
      cfg.Open;

      orc.close;
      orc.Connection:=fzcone;
      orc.ParamByName('orcchave').AsString:=aOrcchave;
      orc.ParamByName('tcicodigo').AsString:=aTciCodigo;
      orc.open;

      total.close;
      total.Connection:=fzcone;
      total.ParamByName('orcchave').AsString:=aOrcchave;
      total.open;

      ori.close;
      ori.Connection:=fzcone;
      ori.ParamByName('orcchave').AsString:=aOrcchave;
      ori.open;

      ito.close;
      ito.Connection:=fzcone;
      ito.ParamByName('orcchave').AsString:=aOrcchave;
      ito.ParamByName('tcicodigo').AsString:=aTciCodigo;
      ito.open;

      Gerapedido;

      Result:= mImp.Lines;


  except
  on E: Exception do
    begin
       showmessage('Erro 346 '+e.Message);
       Result:=Nil;
    end;
  end;

end;


function TfImpressora01.GeraTextoPedidoImm(aOrcchave: String; aTciCodigo:String;aImmPedido:String): TStrings;
begin
  try
    Result:=Nil;

    cfg.close;
    cfg.Connection:=fzcone;
    cfg.Open;

    orc.close;
    orc.Connection:=fzcone;
    orc.ParamByName('orcchave').AsString:=aOrcchave;
    orc.ParamByName('tcicodigo').AsString:=aTciCodigo;
    orc.open;

    total.close;
    total.Connection:=fzcone;
    total.ParamByName('orcchave').AsString:=aOrcchave;
    total.open;

    ori.close;
    ori.Connection:=fzcone;
    ori.ParamByName('orcchave').AsString:=aOrcchave;
    ori.open;

    ito.close;
    ito.Connection:=fzcone;
    ito.ParamByName('orcchave').AsString:=aOrcchave;
    ito.ParamByName('tcicodigo').AsString:=aTciCodigo;
    ito.FilterSQL:='immnumeropedido='+aImmPedido;
    ito.open;

    Gerapedido;

    Result:= mImp.Lines;

  except
  on E: Exception do
    begin
       showmessage('Erro 346 '+e.Message);
       Result:=Nil;
    end;
  end;

end;





end.
