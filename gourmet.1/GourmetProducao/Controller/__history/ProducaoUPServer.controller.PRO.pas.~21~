unit ProducaoUPServer.controller.PRO;


interface

Uses
  Horse,
  System.Json,
  Horse.GBSwagger,
  idHashMessageDigest,
  ProducaoUPServer.Model.DAOGeneric,
  ProducaoUPServer.model.entity.PRO;

procedure Registry(App: THorse);
procedure V1GetPro(Req: THorseRequest; Res: THorseResponse; Next: TProc);



type
 TAPIError = class
  private
    Ferror: string;
  public
    property error: string read Ferror write Ferror;
  end;


implementation

uses
  System.SysUtils;


procedure Registry(App: THorse);
begin
   App.Get('/v1/grp/:id', V1GetPro);
   Swagger
      .BasePath('v1')
      .Path('grp')
        .Tag('pro')

        .GET('List All', 'List All pro')
          .AddResponse(200, 'successful operation')
            .Schema(TPRO)
            .IsArray(True)
          .&End
          .AddResponse(400, 'Bad Request')
            .Schema(TAPIError)
          .&End
          .AddResponse(500, 'Internal Server Error')
            .Schema(TAPIError)
          .&End
        .&End
      .&End
    .&End;
end;



procedure V1GetPro(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  FDAO: IDAOGeneric<TPRO>;
  vlId:string;

begin

  vlId:=Req.Params.Items['id'];
  FDAO := TDaogeneric<TPRO>.New;
  FDAO
    .DAO
    .SQL
      .Fields('pro.procodigo codigo, CAP_FIRST(pro.pronome) identificacao , pro.grpcodigo grupo,  '+
      '(SELECT IF(COUNT(puncodigo)=1,CONCAT('+QuotedStr('R$ ')+', FORMAT(punprecoav,2)), '+
      '  CONCAT('+QuotedStr('de R$ ')+', FORMAT(min(punprecoav),2), '+QuotedStr(' até R$ ')+', FORMAT(max(punprecoav),2)) ) precos FROM pun WHERE tuncodigo in (1,9) and pun.procodigo=pro.procodigo) preco'
      )
      .Where('pro.sipcodigo=1 and pro.tpocodigo=0 and pro.grpcodigo='+Req.Params.Items['id'])
      .OrderBy('pro.pronome')
    .&End
   .Find;


  Res.Send<TJsonarray>(FDAO.DataSetAsJsonArray);
end;




end.
