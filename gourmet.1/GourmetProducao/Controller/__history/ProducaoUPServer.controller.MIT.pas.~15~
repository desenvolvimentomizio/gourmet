unit  ProducaoUPServer.controller.MIT;

interface

Uses
  Horse,
  System.Json,
  Horse.GBSwagger,
  idHashMessageDigest,
  Model.DAOGeneric,
  ProducaoUPServer.model.entity.MIT;

procedure Registry(App: THorse);
procedure V1Get(Req: THorseRequest; Res: THorseResponse; Next: TProc);

type
 TAPIError = class
  private
    Ferror: string;
  public
    property error: string read Ferror write Ferror;
  end;


implementation


procedure Registry(App: THorse);
begin
   App.Get('/v1/mit', V1Get);


   Swagger
      .BasePath('v1')
      .Path('mit')
        .Tag('clb')

        .GET('List All', 'List All Mits')
          .AddResponse(200, 'successful operation')
            .Schema(TMIT)
            .IsArray(True)
          .&End
          .AddResponse(400, 'Bad Request')
            .Schema(TAPIError)
          .&End
          .AddResponse(500, 'Internal Server Error')
            .Schema(TAPIError)
          .&End
        .&End
      .&End
    .&End;
end;



procedure V1Get(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  FDAO: IDAOGeneric<TMIT>;
begin
  FDAO := TDaogeneric<TMIT>.New;

  FDAO
    .DAO
    .SQL
      .Fields('mit.mitcodigo,  mit.mitidentificacao')
      .Join('inner join tci on mit.mitcodigo = tci.mitcodigo inner join gri on tci.tcicodigo = gri.tcicodigo')
      .Where('gri.gricontrolaproducao = 1')
      .OrderBy('mit.mitidentificacao')
      .GroupBy('mit.mitidentificacao,mit.mitcodigo')
     .&End
   .Find;

  Res.Send<TJsonarray>(FDAO.DataSetAsJsonArray);
end;



end.

