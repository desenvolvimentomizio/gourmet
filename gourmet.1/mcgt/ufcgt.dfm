object fcgt: Tfcgt
  Left = 0
  Top = 0
  BorderIcons = []
  BorderStyle = bsSingle
  Caption = 'Verificando Tabelas ...'
  ClientHeight = 771
  ClientWidth = 1080
  Color = clWhite
  Font.Charset = DEFAULT_CHARSET
  Font.Color = clWindowText
  Font.Height = -16
  Font.Name = 'Tahoma'
  Font.Style = [fsBold]
  OldCreateOrder = False
  Position = poScreenCenter
  OnCreate = FormCreate
  PixelsPerInch = 96
  TextHeight = 19
  object Label1: TLabel
    Left = 20
    Top = 78
    Width = 62
    Height = 19
    Caption = 'Arquivo:'
    Font.Charset = DEFAULT_CHARSET
    Font.Color = clWhite
    Font.Height = -16
    Font.Name = 'Tahoma'
    Font.Style = []
    ParentFont = False
  end
  object LlNomearq: TLabel
    Left = 104
    Top = 78
    Width = 309
    Height = 19
    AutoSize = False
    Font.Charset = DEFAULT_CHARSET
    Font.Color = clWhite
    Font.Height = -16
    Font.Name = 'Tahoma'
    Font.Style = []
    ParentFont = False
  end
  object Label2: TLabel
    Left = 20
    Top = 36
    Width = 162
    Height = 19
    Caption = 'Aten'#231#227'o: Aguarde...'
    Font.Charset = DEFAULT_CHARSET
    Font.Color = 4227327
    Font.Height = -16
    Font.Name = 'Tahoma'
    Font.Style = [fsBold]
    ParentFont = False
  end
  object Label3: TLabel
    Left = 20
    Top = 187
    Width = 159
    Height = 19
    Caption = 'Registros das Tabelas:'
    Font.Charset = DEFAULT_CHARSET
    Font.Color = clWhite
    Font.Height = -16
    Font.Name = 'Tahoma'
    Font.Style = []
    ParentFont = False
  end
  object Label4: TLabel
    Left = 20
    Top = 134
    Width = 54
    Height = 19
    Caption = 'Tabelas'
    Font.Charset = DEFAULT_CHARSET
    Font.Color = clWhite
    Font.Height = -16
    Font.Name = 'Tahoma'
    Font.Style = []
    ParentFont = False
  end
  object Label5: TLabel
    Left = 20
    Top = 103
    Width = 193
    Height = 19
    Caption = 'Sistema carregando tabelas'
    Font.Charset = DEFAULT_CHARSET
    Font.Color = clWhite
    Font.Height = -16
    Font.Name = 'Tahoma'
    Font.Style = []
    ParentFont = False
  end
  object Label6: TLabel
    Left = 20
    Top = 58
    Width = 172
    Height = 16
    Caption = 'Arquivos a processar: 000'
    Font.Charset = DEFAULT_CHARSET
    Font.Color = clWhite
    Font.Height = -13
    Font.Name = 'Tahoma'
    Font.Style = [fsBold]
    ParentFont = False
  end
  object PlTitulo: TPanel
    Left = 0
    Top = 0
    Width = 1080
    Height = 26
    Align = alTop
    Alignment = taLeftJustify
    BevelOuter = bvNone
    BorderWidth = 6
    Caption = 'Carga de Tabelas B'#225'sicas'
    Color = 12615680
    Font.Charset = DEFAULT_CHARSET
    Font.Color = clWhite
    Font.Height = -15
    Font.Name = 'Tahoma'
    Font.Style = [fsBold]
    ParentBackground = False
    ParentFont = False
    TabOrder = 0
    object plid: TPanel
      Left = 907
      Top = 6
      Width = 167
      Height = 14
      Align = alRight
      Alignment = taRightJustify
      BevelOuter = bvNone
      Caption = '99-01-000'
      Color = clNavy
      Font.Charset = DEFAULT_CHARSET
      Font.Color = clWhite
      Font.Height = -11
      Font.Name = 'Microsoft Sans Serif'
      Font.Pitch = fpVariable
      Font.Style = []
      ParentBackground = False
      ParentFont = False
      TabOrder = 0
      object PlQtdRecno: TPanel
        Left = 0
        Top = 0
        Width = 117
        Height = 14
        Align = alLeft
        Alignment = taLeftJustify
        BevelOuter = bvNone
        Caption = 'Registros: 000000'
        Color = clNavy
        Font.Charset = DEFAULT_CHARSET
        Font.Color = clWhite
        Font.Height = -11
        Font.Name = 'Microsoft Sans Serif'
        Font.Pitch = fpVariable
        Font.Style = []
        ParentBackground = False
        ParentFont = False
        TabOrder = 0
        Visible = False
      end
    end
  end
  object mostrareg: TProgressBar
    Left = 20
    Top = 208
    Width = 393
    Height = 17
    TabOrder = 1
  end
  object mostratab: TProgressBar
    Left = 20
    Top = 156
    Width = 393
    Height = 17
    TabOrder = 2
  end
  object UniScript: TUniScript
    Delimiter = '//'
    Left = 320
    Top = 104
  end
  object consulta: TUniQuery
    SQL.Strings = (
      
        'SELECT vdb.vdbversao, vdb.vdbcodigo FROM vdb ORDER BY vdb.vdbver' +
        'sao DESC LIMIT 1')
    Left = 248
    Top = 40
  end
  object vdbgera: TUniQuery
    Left = 376
    Top = 104
  end
  object vdtatual: TUniQuery
    Left = 216
    Top = 184
  end
  object vdbatual: TUniQuery
    Left = 216
    Top = 128
  end
  object ajustabanco: TUniQuery
    Left = 136
    Top = 120
  end
  object vdt: TUniQuery
    SQL.Strings = (
      'SELECT'
      '  vdt.vdtcodigo,'
      '  vdt.vdtversao,'
      '  vdt.vdtdados,'
      '  vdt.vdtalteracao'
      'FROM vdt'
      'WHERE vdt.vdtversao =:vdtversao')
    Left = 312
    Top = 40
    ParamData = <
      item
        DataType = ftUnknown
        Name = 'vdtversao'
        Value = nil
      end>
    object vdtvdtcodigo: TIntegerField
      FieldName = 'vdtcodigo'
    end
    object vdtvdtversao: TStringField
      FieldName = 'vdtversao'
      Size = 6
    end
    object vdtvdtdados: TMemoField
      FieldName = 'vdtdados'
      BlobType = ftMemo
    end
    object vdtvdtalteracao: TDateTimeField
      FieldName = 'vdtalteracao'
    end
  end
  object vdb: TUniQuery
    SQL.Strings = (
      'SELECT'
      '  vdbcodigo,'
      '  vdbversao,'
      '  vdbcomandos,'
      '  vdbalteracao'
      'FROM vdb'
      'WHERE vdbversao=:vdbversao;')
    Left = 368
    Top = 40
    ParamData = <
      item
        DataType = ftUnknown
        Name = 'vdbversao'
        Value = nil
      end>
    object vdbvdbcodigo: TIntegerField
      FieldName = 'vdbcodigo'
    end
    object vdbvdbversao: TStringField
      FieldName = 'vdbversao'
    end
    object vdbvdbalteracao: TDateTimeField
      FieldName = 'vdbalteracao'
    end
    object vdbvdbcomandos: TBlobField
      FieldName = 'vdbcomandos'
    end
  end
  object us001210: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ' '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'pro'#39
      '      AND column_name = '#39'proenvioimendes'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "pro"'
      '--'
      'ALTER TABLE pro'
      '  ADD COLUMN proenvioimendes date DEFAULT null;'
      ''
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'pro'#39
      '      AND column_name = '#39'proretornoimendes'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "pro"'
      '--'
      'ALTER TABLE pro'
      '  ADD COLUMN proretornoimendes date DEFAULT null;'
      ''
      'end if; '
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 432
    Top = 136
  end
  object us001211: TUniScript
    SQL.Strings = (
      'DROP VIEW v_pro CASCADE//'
      ''
      'CREATE'
      'DEFINER = '#39'root'#39'@'#39'%'#39
      'VIEW v_pro'
      'AS'
      'SELECT'
      '  `pro`.`procodigo` AS `procodigo`,'
      '  `pro`.`pronome` AS `pronome`,'
      '  `tpo`.`tpoidentificacao` AS `tpoidentificacao`,'
      '  `mar`.`maridentificacao` AS `maridentificacao`,'
      '  `grp`.`grpidentificacao` AS `grpidentificacao`,'
      '  `icm`.`icmaliquotas` AS `icmaliquotas`,'
      '  `pro`.`proncm` AS `proncm`,'
      '  `pro`.`prosaldo` AS `prosaldo`,'
      '  `pro`.`prosaldodisp` AS `prosaldodisp`,'
      '  `sip`.`sipcodigo` AS `sipcodigo`,'
      '  `pro`.`proobs` AS `proobs`,'
      '  `pro`.`proreferencia` AS `proreferencia`,'
      '  `uni`.`unisimbolo` AS `unisimbolo`,'
      '  `pun`.`punprecoav` AS `punprecoav`,'
      '  `pun`.`punprecoap` AS `punprecoap`,'
      '  `pro`.`tpocodigo` AS `tpocodigo`,'
      '  `pro`.`proanpcodigo` AS `proanpcodigo`,'
      '  `enp`.`enpcodigo` AS `enpcodigo`,'
      '  `enp`.`enpendereco` AS `enpendereco`,'
      '  `pro`.`propedecomple` AS `propedecomple`,'
      '  `cpb`.`cpbcodbalanca` AS `cpbcodbalanca`,'
      '  `pro`.`gracodigo` AS `gracodigo`,'
      '  `dpr`.`dpridentificacao` AS `dpridentificacao`,'
      '  `pro`.`proconsolidado` AS `proconsolidado`,'
      
        '  (((`pun`.`punprecoav` - `pun`.`puncusto`) / `pun`.`puncusto`) ' +
        '* 100) AS `punpercav`,'
      
        '  (((`pun`.`punprecoap` - `pun`.`puncusto`) / `pun`.`puncusto`) ' +
        '* 100) AS `punpercap`,'
      '  `pun`.`puncusto` AS `puncusto`,'
      '  `pro`.`grpcodigo` AS `grpcodigo`,'
      '  `pro`.`cstcodigo` AS `cstcodigo`,'
      '  `pro`.`procest` AS `procest`,'
      
        '  IF((`pro`.`proproducao` = 1), '#39'PRODUCAO PROPRIA'#39', `pun`.`imeco' +
        'digo`) AS `imecodigo`,'
      '  `pro`.`probalanca` AS `probalanca`,'
      '  `pro`.`imuid` AS `imuid`,'
      '  `pro`.`pronatrecisenta` AS `pronatrecisenta`,'
      '  `pro`.`proabc` AS `proabc`,'
      '  `pro`.`promargemcontrib` AS `promargemcontrib`,'
      '  `pro`.`proproducao` AS `proproducao`,'
      '  `pro`.`cfocfop` AS `cfocfop`,'
      '  `pro`.`cfocfopfora` AS `cfocfopfora`,'
      '  `icmfora`.`icmaliquotas` AS `icmaliquotasfora`,'
      '  `pro`.`proenvioimendes` AS `proenvioimendes`,'
      '  `pro`.`proretornoimendes` AS `proretornoimendes`'
      'FROM (((((((((((`pro`'
      '  JOIN `mar`'
      '    ON ((`pro`.`marcodigo` = `mar`.`marcodigo`)))'
      '  JOIN `grp`'
      '    ON ((`pro`.`grpcodigo` = `grp`.`grpcodigo`)))'
      '  JOIN `icm`'
      '    ON ((`pro`.`icmcodigo` = `icm`.`icmcodigo`)))'
      '  LEFT JOIN `icm` `icmfora`'
      '    ON ((`pro`.`icmcodigofora` = `icmfora`.`icmcodigo`)))'
      '  JOIN `uni`'
      '    ON ((`pro`.`unicodigo` = `uni`.`unicodigo`)))'
      '  LEFT JOIN `cpb`'
      '    ON ((`pro`.`procodigo` = `cpb`.`procodigo`)))'
      '  JOIN `sip`'
      '    ON ((`sip`.`sipcodigo` = `pro`.`sipcodigo`)))'
      '  JOIN `pun`'
      '    ON (((`pro`.`procodigo` = `pun`.`procodigo`)'
      '    AND (`pro`.`unicodigo` = `pun`.`unicodigo`))))'
      '  JOIN `tpo`'
      '    ON ((`pro`.`tpocodigo` = `tpo`.`tpocodigo`)))'
      '  JOIN `dpr`'
      '    ON ((`pro`.`dprcodigo` = `dpr`.`dprcodigo`)))'
      '  LEFT JOIN `v_enp` `enp`'
      '    ON ((`enp`.`enpcodigo` = `pro`.`enpcodigo`)))//')
    Delimiter = '//'
    Left = 232
    Top = 88
  end
  object us001212: TUniScript
    SQL.Strings = (
      'CREATE TABLE if not exists aiqmda ('
      '  aiqmdaidentificacao varchar(50) NOT NULL DEFAULT '#39#39','
      '  mdacodigo int(11) NOT NULL,'
      '  PRIMARY KEY (aiqmdaidentificacao)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci//')
    Delimiter = '//'
    Left = 320
    Top = 168
  end
  object us001213: TUniScript
    SQL.Strings = (
      ''
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ' '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'pun'#39
      '      AND column_name = '#39'punmaximoclbproducao'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "pun"'
      '--'
      'ALTER TABLE pun'
      '  ADD COLUMN punmaximoclbproducao int(11) default 1;'
      ''
      'end if; '
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      'DROP VIEW IF EXISTS v_imm CASCADE//'
      ''
      'CREATE'
      'DEFINER = '#39'root'#39'@'#39'%'#39
      'VIEW v_imm'
      'AS'
      'SELECT'
      '  `imm`.`immchave` AS `chave`,'
      '  `pro`.`pronome` AS `identificacao`,'
      
        '  LPAD(CAST(`imm`.`immnumepedido` AS char charset utf8), 4, '#39'0'#39')' +
        ' AS `pedido`,'
      
        '  TIME_FORMAT(TIMEDIFF(NOW(), `imm`.`immhoraimpresso`), '#39'%H:%i'#39')' +
        ' AS `tempo`,'
      '  `ito`.`itochave` AS `item`,'
      
        '  IF((`imm`.`immnumepedido` < 5000), '#39'ENTR'#39', CONCAT('#39'M:'#39', `orc`.' +
        '`orcmesa`)) AS `destino`,'
      '  `tci`.`tcicodigo` AS `impressora`,'
      '  `sep`.`sepcodigo` AS `setor`,'
      '  `ito`.`procodigo` AS `produto`,'
      '  `ito`.`itoquantidade` AS `quantidade`,'
      '  `ito`.`puncodigo` AS `unidade`,'
      '  `imm`.`immhoraimpresso` AS `inicio`,'
      '  `ito`.`stocodigo` AS `situacao`,'
      '  `pun`.`punmaximoclbproducao` AS `maximo`'
      'FROM ((((((((((`pro`'
      '  JOIN `gri`)'
      '  JOIN `ito`)'
      '  JOIN `imm`)'
      '  JOIN `czn`)'
      '  JOIN `clb`)'
      '  JOIN `orc`)'
      '  JOIN `tci`)'
      '  JOIN `mit`)'
      '  JOIN `sep`)'
      '  JOIN `pun`)'
      'WHERE ((`ito`.`itochave` = `imm`.`itochave`)'
      'AND (`pro`.`procodigo` = `ito`.`procodigo`)'
      'AND (`pro`.`grpcodigo` = `gri`.`grpcodigo`)'
      'AND (`gri`.`sepcodigo` = `sep`.`sepcodigo`)'
      'AND (`imm`.`cznchave` = `czn`.`cznchave`)'
      'AND ISNULL(`czn`.`cznfechamento`)'
      'AND (`orc`.`orcchave` = `ito`.`orcchave`)'
      'AND (`gri`.`tcicodigo` = `tci`.`tcicodigo`)'
      'AND (`mit`.`mitcodigo` = `tci`.`mitcodigo`)'
      'AND (`imm`.`clbcodigo` = `clb`.`clbcodigo`)'
      'AND (`orc`.`stocodigo` <> 88)'
      'AND (`ito`.`stocodigo` <> 88)'
      'AND (`ito`.`puncodigo` = `pun`.`puncodigo`)'
      'AND (`imm`.`clbcodigoent` = 0)'
      'AND (`gri`.`gricontrolaproducao` = 1)'
      'AND (`imm`.`immrecebido` <> 2)'
      
        'AND IF((`imm`.`immnumepedido` < 5000), (`imm`.`immhoraimprimir` ' +
        'IS NOT NULL), 1))'
      'ORDER BY `imm`.`immchave`//'
      ''
      ''
      '')
    Delimiter = '//'
    Left = 208
    Top = 32
  end
  object us001214: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS RegistraRefeicao//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraRefeicao (IN pFlaCodigo int'
      ', IN pTipoChave int'
      ', IN pChave int'
      ', IN pClbCodigo int'
      ', IN pValor decimal(15, 3)'
      ', IN pLteChave int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      '  SET @disable_triggers = 1;'
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DROP TEMPORARY TABLE IF EXISTS trfi;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS trfi ('
      '    ID int NOT NULL AUTO_INCREMENT,'
      '    etdcodigo int NOT NULL,'
      '    mdacodigo int NOT NULL,'
      '    tfdcodigo int NOT NULL,'
      '    numparc int NOT NULL,'
      '    dtvecto date NOT NULL,'
      '    vlrparcela decimal(12, 2),'
      '    numero varchar(20),'
      '    PRIMARY KEY (ID)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  DROP TEMPORARY TABLE IF EXISTS tdtl;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS tdtl ('
      '    ID int(11) NOT NULL AUTO_INCREMENT,'
      '    dtlchave int(11),'
      '    ltechave int(11),'
      '    cedcodigo int(1),'
      '    dtlvalor float(9, 2),'
      '    mdacodigo int(11),'
      '    PRIMARY KEY (ID)'
      ''
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SET @procodigo = (SELECT'
      '      cfgmgou.cfgmgouprorefeicao'
      '    FROM cfgmgou'
      '      INNER JOIN cfg'
      '        ON cfgmgou.cfgcodigo = cfg.cfgcodigo'
      '    WHERE cfg.cfgcodigo = 1'
      '    LIMIT 1);'
      ''
      '  IF pTipoChave = 1 THEN'
      '    SELECT'
      '      edr.edritem,'
      '      edr.ufscodigo'
      '    FROM mes'
      '      INNER JOIN edr'
      '        ON mes.etdcodigo = edr.etdcodigo'
      '        AND mes.edritem = edr.edritem'
      '    WHERE mes.meschave = pChave LIMIT 1 INTO @edritem'
      '    , @ufscodigo;'
      '  END IF;'
      ''
      ''
      '  IF pTipoChave = 0 THEN'
      '    SELECT'
      '      edr.edritem,'
      '      edr.ufscodigo'
      '    FROM orc'
      '      INNER JOIN edr'
      '        ON orc.etdcodigo = edr.etdcodigo'
      '        AND orc.edritem = edr.edritem'
      '    WHERE orc.orcchave = pChave LIMIT 1 INTO @edritem'
      '    , @ufscodigo;'
      '  END IF;'
      ''
      '  SET @toecodigo = (SELECT (SELECT'
      '          cfgmgoutoerefeicao'
      '        FROM cfgmgou'
      '        WHERE cfgcodigo = cfg.cfgcodigo)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  IF pTipoChave = 0 THEN'
      '    INSERT INTO mes (meschave'
      '    , etdcodigo'
      '    , mesemissao'
      '    , mesregistro'
      '    , tdfcodigo'
      '    , sdecodigo'
      '    , messerie'
      '    , mesnumero'
      '    , toecodigo'
      '    , mesvalor'
      '    , mesdesconto'
      '    , mesprodutos'
      '    , messervicos'
      '    , mestotal'
      '    , tfpcodigo'
      '    , refcodigo'
      '    , trfcodigo'
      '    , mesfrete'
      '    , messeguro'
      '    , mesoutras'
      '    , mesbicm'
      '    , mesicm'
      '    , mesbicms'
      '    , mesicms'
      '    , mesipi'
      '    , mespis'
      '    , mescofins'
      '    , mespiss'
      '    , mescofinss'
      '    , clbcodigo'
      '    , trmcodigo'
      '    , mesacrescimo'
      '    , messped'
      '    , temcodigo'
      '    , edritem'
      '    , tdecodigo'
      '    , mesinclusao'
      '    , mesrefeicao)'
      '      (SELECT'
      '        @novachave,'
      '        @etdcodigo := orc.etdcodigo,'
      '        CURRENT_DATE(),'
      '        CURRENT_DATE(),'
      '        '#39'00'#39','
      '        '#39'00'#39','
      '        @cfgserienfce,'
      '        0,'
      '        @toecodigo,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        pClbCodigo,'
      '        orc.trmcodigo,'
      '        0,'
      '        '#39'0'#39','
      '        1,'
      '        @edritem,'
      '        1,'
      '        NOW(),'
      '        1'
      '      FROM orc'
      '      WHERE orc.orcchave = pChave);'
      '  END IF;'
      ''
      '  IF pTipoChave = 1 THEN'
      '    INSERT INTO mes (meschave'
      '    , etdcodigo'
      '    , mesemissao'
      '    , mesregistro'
      '    , tdfcodigo'
      '    , sdecodigo'
      '    , messerie'
      '    , mesnumero'
      '    , toecodigo'
      '    , mesvalor'
      '    , mesdesconto'
      '    , mesprodutos'
      '    , messervicos'
      '    , mestotal'
      '    , tfpcodigo'
      '    , refcodigo'
      '    , trfcodigo'
      '    , mesfrete'
      '    , messeguro'
      '    , mesoutras'
      '    , mesbicm'
      '    , mesicm'
      '    , mesbicms'
      '    , mesicms'
      '    , mesipi'
      '    , mespis'
      '    , mescofins'
      '    , mespiss'
      '    , mescofinss'
      '    , clbcodigo'
      '    , trmcodigo'
      '    , mesacrescimo'
      '    , messped'
      '    , temcodigo'
      '    , edritem'
      '    , tdecodigo'
      '    , mesinclusao'
      '    , mesrefeicao)'
      '      (SELECT'
      '        @novachave,'
      '        @etdcodigo := mes.etdcodigo,'
      '        CURRENT_DATE(),'
      '        CURRENT_DATE(),'
      '        '#39'00'#39','
      '        '#39'00'#39','
      '        @cfgserienfce,'
      '        0,'
      '        @toecodigo,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        pClbCodigo,'
      '        mes.trmcodigo,'
      '        0,'
      '        '#39'0'#39','
      '        1,'
      '        @edritem,'
      '        1,'
      '        NOW(),'
      '        1'
      '      FROM mes'
      '      WHERE mes.meschave = pChave);'
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao oramento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    IF pTipoChave = 0 THEN'
      '      INSERT INTO mor (morchave'
      '      , orcchave'
      '      , meschave)'
      '        VALUES (@novachave, pChave, pMesChave);'
      '    END IF;'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro buscar paremetrizaes de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @cstcodigo = (SELECT'
      '        cstcodigo'
      '      FROM pro'
      '      WHERE pro.procodigo = @procodigo LIMIT 1);'
      ''
      '    SET @cfocfop = (SELECT'
      '        cfocfop'
      '      FROM pro'
      '      WHERE pro.procodigo = @procodigo);'
      ''
      ''
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @disable_triggers = 1;'
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      ''
      '    , icmcodigo'
      '    , itmaliqicm'
      '    , itmbicm'
      '    , itmicm'
      ''
      '    , csicodigo'
      '    , itmaliqipi'
      '    , itmbipi'
      '    , itmipi'
      ''
      '    , cspcodigo'
      '    , itmaliqpis'
      '    , itmbpis'
      '    , itmpis'
      ''
      '    , csfcodigo'
      '    , itmaliqcofins'
      '    , itmbcofins'
      '    , itmcofins'
      ''
      ''
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase)'
      '      (SELECT'
      '        @novachave,'
      '        pMesChave,'
      '        1,'
      '        pro.procodigo,'
      '        pro.cstcodigo,'
      '        1,'
      '        pValor,'
      '        0,'
      '        @toecodigo,'
      '        @cfocfop,'
      ''
      ''
      '        icmcodigo,'
      '        (SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      '          WHERE i.icmcodigo = pro.icmcodigo) icmaliquotas,'
      '        IF((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      
        '          WHERE i.icmcodigo = pro.icmcodigo) <> 0, pValor, 0) ba' +
        'seicm,'
      '        IF((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      '          WHERE i.icmcodigo = pro.icmcodigo) <> 0, (((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      
        '          WHERE i.icmcodigo = pro.icmcodigo) / 100) * pValor), 0' +
        ') valoricm,'
      ''
      '        csicodigo,'
      '        pro.proipialiquota,'
      '        IF(pro.proipialiquota <> 0, pValor, 0) baseipi,'
      
        '        IF(pro.proipialiquota <> 0, ((pro.proipialiquota / 100) ' +
        '* pValor), 0) valoripi,'
      ''
      '        cspcodigo,'
      '        pro.propisaliquota,'
      '        IF(pro.propisaliquota <> 0, pValor, 0) basepis,'
      
        '        IF(pro.propisaliquota <> 0, ((pro.propisaliquota / 100) ' +
        '* pValor), 0) valorpis,'
      ''
      ''
      '        csfcodigo,'
      '        pro.procofinsaliquota,'
      '        IF(pro.procofinsaliquota <> 0, pValor, 0) basecofins,'
      
        '        IF(pro.procofinsaliquota <> 0, ((pro.procofinsaliquota /' +
        ' 100) * pValor), 0) valorcofins,'
      ''
      ''
      '        @pcccodigo,'
      '        pValor,'
      '        pro.unicodigo,'
      '        pun.puncodigo,'
      '        pun.punmultiplicador,'
      '        @cfocfop,'
      '        (SELECT'
      '            p.unicodigobase'
      '          FROM pun p'
      '          WHERE p.puncodigo = pun.puncodigo) unicodigobase'
      '      FROM pro'
      '        INNER JOIN pun'
      '          ON pro.procodigo = pun.procodigo'
      '          AND pro.unicodigo = pun.unicodigo'
      '      WHERE pro.procodigo = @procodigo);'
      ''
      '    SET @disable_triggers = NULL;'
      ''
      ''
      ''
      '    UPDATE mes'
      '    SET mes.mesicm = (SELECT'
      '            i.itmicm'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mes.mesbicm = mestotal,'
      '        mesipi = (SELECT'
      '            i.itmipi'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mespis = (SELECT'
      '            i.itmpis'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mescofins = (SELECT'
      '            i.itmcofins'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave)'
      '    WHERE meschave = pMesChave;'
      ''
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar lote da venda refeicao'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO lte (ltechave'
      '    , flacodigo'
      '    , tfdcodigo'
      '    , ltedata'
      '    , lteprincipal'
      '    , ltejuros'
      '    , ltedesconto'
      '    , ltetotal'
      '    , lteextenso'
      '    , ltehistorico'
      '    , ltemulta'
      '    , ltesituacao'
      '    , clbcodigo'
      '    , ctacodigo'
      '    , lteregistro)'
      '      (SELECT'
      '        @novachave,'
      '        flacodigo,'
      '        tfdcodigo,'
      '        ltedata,'
      '        lteprincipal,'
      '        ltejuros,'
      '        ltedesconto,'
      '        ltetotal,'
      '        lteextenso,'
      '        ltehistorico,'
      '        ltemulta,'
      '        ltesituacao,'
      '        clbcodigo,'
      '        ctacodigo,'
      '        lteregistro'
      '      FROM lte'
      '      WHERE lte.ltechave = pLteChave);'
      ''
      '    IF ROW_COUNT() > 0 THEN'
      '      SET @ltechave = (SELECT'
      '          LAST_INSERT_ID());'
      ''
      '      UPDATE terro'
      
        '      SET Mensagem = '#39'Erro ao gravar detalhes do recebimento da ' +
        'venda refeicao'#39
      '      WHERE Chamada = pChamada;'
      ''
      '      INSERT INTO dtl (dtlchave'
      '      , ltechave'
      '      , cedcodigo'
      '      , dtlvalor'
      '      , mdacodigo)'
      '        (SELECT'
      '          @novachave,'
      '          @ltechave,'
      '          cedcodigo,'
      '          dtlvalor,'
      '          mdacodigo'
      '        FROM dtl'
      '        WHERE dtl.ltechave = pLteChave);'
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        UPDATE terro'
      
        '        SET Mensagem = '#39'Erro ao gravar registro financeiro da ve' +
        'nda refeicao'#39
      '        WHERE Chamada = pChamada;'
      ''
      '        DELETE'
      '          FROM trfi;'
      ''
      '        INSERT INTO trfi (ID'
      '        , etdcodigo'
      '        , mdacodigo'
      '        , tfdcodigo'
      '        , numparc'
      '        , dtvecto'
      '        , vlrparcela'
      '        , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE' +
        '(), pValor, pMesChave);'
      ''
      
        '        CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, pChamada, ' +
        '@TitCodigo);'
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            pMesChave'
      '          FROM rfi'
      '          WHERE rfi.titcodigo = @TitCodigo);'
      '      END IF;'
      '    END IF;'
      '  END IF;'
      ''
      '  SET @disable_triggers = NULL;'
      'END //')
    Delimiter = '//'
    Left = 256
    Top = 32
  end
  object us001215: TUniScript
    SQL.Strings = (
      ''
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ' IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.TABLE_CONSTRAINTS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND CONSTRAINT_NAME = '#39'tom_mes'#39
      '      AND TABLE_NAME = '#39'tom'#39') THEN'
      ''
      '    ALTER TABLE tom'
      '    DROP FOREIGN KEY tom_mes;'
      ''
      '  END IF;'
      ''
      ''
      ' IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.TABLE_CONSTRAINTS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND CONSTRAINT_NAME = '#39'tom_tof'#39
      '      AND TABLE_NAME = '#39'tom'#39') THEN'
      ''
      '   ALTER TABLE tom'
      '     DROP FOREIGN KEY tom_tof;'
      ''
      ''
      '  END IF;'
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      ''
      '')
    Delimiter = '//'
    Left = 464
    Top = 32
  end
  object us001216: TUniScript
    SQL.Strings = (
      ''
      ''
      'DROP PROCEDURE IF EXISTS FechaMesa//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesa (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = pOrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 13;'
      ''
      ''
      ''
      '    INSERT INTO olt (oltchave'
      '    , orcchave'
      '    , ltechave'
      '    , oltidentificacao'
      '    , olttipo)'
      
        '      VALUE (@novachave, pOrcChave, @ltechave, pNome, pTipoFecha' +
        'mento);'
      ''
      ''
      ''
      ''
      '    SET @LteDesconto = IFNULL((SELECT'
      '        SUM(lte.ltedesconto)'
      '      FROM olt'
      '        INNER JOIN lte'
      '          ON olt.ltechave = lte.ltechave'
      '      WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '    SET @OrcTotalAv = (SELECT'
      '        SUM(itovalorav * itoquantidade) totav'
      '      FROM ito,'
      '           pro'
      '      WHERE ito.procodigo = pro.procodigo'
      '      AND ito.stocodigo <> 88'
      '      AND pro.tpocodigo = 0'
      '      AND orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    IF @LteDesconto > 0 THEN'
      ''
      ''
      '      SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '      UPDATE ito, pro'
      '      SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '          itosaldoav = (ito.itototalav - itodescontoav),'
      '          itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '          itosaldoap = (ito.itototalav - itodescontoav),'
      '          itopercdescap = ROUND(@percdesc, 3),'
      '          itopercdescav = ROUND(@percdesc, 3)'
      '      WHERE ito.stocodigo <> 88'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo = 0'
      '      AND ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '      SET @centavos = @LteDesconto - (SELECT'
      '          SUM(itodescontoav)'
      '        FROM ito,'
      '             pro'
      '        WHERE ito.orcchave = pOrcChave'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0);'
      ''
      ''
      ''
      ''
      '      IF @centavos <> 0 THEN'
      ''
      '        UPDATE ito, pro'
      '        SET itodescontoav = itodescontoav + @centavos,'
      '            itodescontoap = itodescontoap + @centavos,'
      '            itosaldoav = itosaldoav + @centavos,'
      '            itosaldoap = itosaldoap + @centavos'
      '        WHERE ito.stocodigo <> 88'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0'
      '        AND ito.orcchave = pOrcChave LIMIT 1;'
      ''
      '      END IF;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      
        '          orc.orcpercdescav = IF(tito.descap > 0, (tito.descap /' +
        ' tito.totap), 0),'
      '          orc.orctotalap = (tito.totap - tito.descap)'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      '    END IF;'
      ''
      ''
      '    SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '    CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pConfi' +
        'rma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 14;'
      ''
      ''
      ''
      '    SET @VlrFechamento = (SELECT'
      '        SUM(dtl.dtlvalor) dtlvalor'
      '      FROM dtl'
      '        INNER JOIN olt'
      '          ON dtl.ltechave = olt.ltechave'
      '      WHERE olt.orcchave = pOrcChave'
      '      AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '    IF @VlrFechamento > 0 THEN'
      ''
      ''
      '      SET @etdcodigo = (SELECT'
      '          etdcodigo'
      '        FROM orc'
      '        WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '      SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      OPEN curlote;'
      '    read_loop:'
      '      LOOP'
      ''
      '        FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '        IF done THEN'
      ''
      '          LEAVE read_loop;'
      '        END IF;'
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade'
      '          AND dtl.mdacodigo != 7);'
      ''
      '        DELETE'
      '          FROM trfi'
      '        WHERE mdacodigo <> modalidade;'
      ''
      '        INSERT INTO trfi (ID'
      '        , etdcodigo'
      '        , mdacodigo'
      '        , tfdcodigo'
      '        , numparc'
      '        , dtvecto'
      '        , vlrparcela'
      '        , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE' +
        '(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '        CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem, @' +
        'TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 17;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      END LOOP;'
      ''
      ''
      '      CLOSE curlote;'
      ''
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      '    INSERT INTO rfm (rfichave'
      '    , meschave)'
      ''
      '      (SELECT DISTINCT'
      ''
      '        rfichave,'
      '        @MesChave'
      '      FROM olt'
      '        INNER JOIN mlt'
      '          ON olt.ltechave = mlt.ltechave'
      '        INNER JOIN mfi'
      '          ON mlt.mfichave = mfi.mfichave'
      '      WHERE olt.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '        orc.orctotalav = (tito.totav - tito.descav),'
      ''
      ''
      ''
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        orc.orcdataencerr = CURRENT_DATE(),'
      '        orc.orchoraencerr = CURRENT_TIME(),'
      '        orc.stocodigo = 3'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '    UPDATE ito'
      '    SET ito.stocodigo = 3'
      '    WHERE ito.orcchave = pOrcChave'
      '    AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END //'
      ''
      ''
      ''
      ''
      ''
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      oricodigo,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmacrescimoav'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmoutras)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        itoacrescimoav,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        ito.itovalorav,'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      ''
      '        (ito.itototalav) * (@totalservicos / @totalgeral)'
      ''
      ''
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END //'
      ''
      '')
    Delimiter = '//'
    Left = 448
    Top = 40
  end
  object us001217: TUniScript
    SQL.Strings = (
      ''
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'ito'#39
      '      AND column_name = '#39'itooutras'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "ito"'
      '--'
      'ALTER TABLE ito'
      '  ADD COLUMN itooutras decimal(15,3)  default 0;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 512
    Top = 32
  end
  object us001218: TUniScript
    SQL.Strings = (
      ''
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'cfg'#39
      '      AND column_name = '#39'cfgetdcodigopix'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "cfg"'
      '--'
      'ALTER TABLE cfg'
      '  ADD COLUMN cfgetdcodigopix int(11) default null;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 560
    Top = 32
  end
  object us001219: TUniScript
    SQL.Strings = (
      ''
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'aiq'#39
      '      AND column_name = '#39'aiqentrega'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "aiq"'
      '--'
      'ALTER TABLE aiq'
      '  ADD COLUMN aiqentrega decimal(15,2)  default 0;'
      ''
      'end if; '
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'aiq'#39
      '      AND column_name = '#39'aiqvalor'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "aiq"'
      '--'
      'ALTER TABLE aiq'
      '  ADD COLUMN aiqvalor decimal(15,2)  default 0;'
      ''
      'end if; '
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'nuc'#39
      '      AND column_name = '#39'nucentrega'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "nuc"'
      '--'
      'ALTER TABLE nuc'
      '  ADD COLUMN nucentrega decimal(15,2)  default 0;'
      ''
      'end if; '
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'nuc'#39
      '      AND column_name = '#39'nucvalor'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "nuc"'
      '--'
      'ALTER TABLE nuc'
      '  ADD COLUMN nucvalor decimal(15,2)  default 0;'
      ''
      'end if; '
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mes'#39
      '      AND column_name = '#39'baicodigo'#39') THEN'
      ''
      ''
      '--'
      '-- Alter table "mes"'
      '--'
      'ALTER TABLE mes'
      '  ADD COLUMN baicodigo integer  default 0;'
      ''
      'end if; '
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mes'#39
      '      AND column_name = '#39'mdacodigo'#39') THEN'
      ''
      ''
      '--'
      '-- Alter table "mes"'
      '--'
      'ALTER TABLE mes'
      '  ADD COLUMN mdacodigo integer  default 0;'
      ''
      'end if; '
      ''
      ''
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'orc'#39
      '      AND column_name = '#39'baicodigo'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "orc"'
      '--'
      'ALTER TABLE orc'
      '  ADD COLUMN baicodigo integer  default 0;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 616
    Top = 32
  end
  object us001220: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'cce'#39
      '      AND column_name = '#39'ccevalorregistro'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "cce"'
      '--'
      'ALTER TABLE cce'
      '  ADD COLUMN  ccevalorregistro decimal(12, 2) DEFAULT 0.00;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      'CREATE TABLE IF NOT EXISTS icc ('
      '  icchchave int(11) NOT NULL AUTO_INCREMENT,'
      '  ccechave int(11) DEFAULT NULL,'
      '  iccvalor decimal(10, 2) DEFAULT NULL,'
      '  cedcodigo int(11) DEFAULT NULL,'
      '  icchistorico varchar(255) DEFAULT '#39#39#39'NULL'#39#39#39','
      '  iccinclusao datetime,'
      '  clbcodigo int(11) DEFAULT NULL,'
      '  PRIMARY KEY (icchchave)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET utf8mb4'
      'COLLATE utf8mb4_general_ci'
      'COMMENT = '#39'registro de valores aos entregadores'#39'//'
      '')
    Delimiter = '//'
    Left = 672
    Top = 32
  end
  object us001221: TUniScript
    SQL.Strings = (
      ''
      ''
      'DROP PROCEDURE IF EXISTS RegistraRefeicao//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraRefeicao (IN pFlaCodigo int'
      ', IN pTipoChave int'
      ', IN pChave int'
      ', IN pClbCodigo int'
      ', IN pValor decimal(15, 3)'
      ', IN pLteChave int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      '  SET @disable_triggers = 1;'
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DROP TEMPORARY TABLE IF EXISTS trfi;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS trfi ('
      '    ID int NOT NULL AUTO_INCREMENT,'
      '    etdcodigo int NOT NULL,'
      '    mdacodigo int NOT NULL,'
      '    tfdcodigo int NOT NULL,'
      '    numparc int NOT NULL,'
      '    dtvecto date NOT NULL,'
      '    vlrparcela decimal(12, 2),'
      '    numero varchar(20),'
      '    PRIMARY KEY (ID)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  DROP TEMPORARY TABLE IF EXISTS tdtl;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS tdtl ('
      '    ID int(11) NOT NULL AUTO_INCREMENT,'
      '    dtlchave int(11),'
      '    ltechave int(11),'
      '    cedcodigo int(1),'
      '    dtlvalor float(9, 2),'
      '    mdacodigo int(11),'
      '    PRIMARY KEY (ID)'
      ''
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SET @procodigo = (SELECT'
      '      cfgmgouprorefeicao'
      '    FROM cfgmgou'
      '      INNER JOIN cfg'
      '        ON cfgmgou.cfgcodigo = cfg.cfgcodigo'
      '    WHERE cfg.cfgcodigo = 1'
      '    LIMIT 1);'
      ''
      '  IF pTipoChave = 1 THEN'
      '    SELECT'
      '      edr.edritem,'
      '      edr.ufscodigo'
      '    FROM mes'
      '      INNER JOIN edr'
      '        ON mes.etdcodigo = edr.etdcodigo'
      '        AND mes.edritem = edr.edritem'
      '    WHERE mes.meschave = pChave LIMIT 1 INTO @edritem'
      '    , @ufscodigo;'
      '  END IF;'
      ''
      ''
      '  IF pTipoChave = 0 THEN'
      '    SELECT'
      '      edr.edritem,'
      '      edr.ufscodigo'
      '    FROM orc'
      '      INNER JOIN edr'
      '        ON orc.etdcodigo = edr.etdcodigo'
      '        AND orc.edritem = edr.edritem'
      '    WHERE orc.orcchave = pChave LIMIT 1 INTO @edritem'
      '    , @ufscodigo;'
      '  END IF;'
      ''
      '  SET @toecodigo = (SELECT (SELECT'
      '          cfgmgoutoerefeicao'
      '        FROM cfgmgou'
      '        WHERE cfgcodigo = cfg.cfgcodigo)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  IF pTipoChave = 0 THEN'
      '    INSERT INTO mes (meschave'
      '    , etdcodigo'
      '    , mesemissao'
      '    , mesregistro'
      '    , tdfcodigo'
      '    , sdecodigo'
      '    , messerie'
      '    , mesnumero'
      '    , toecodigo'
      '    , mesvalor'
      '    , mesdesconto'
      '    , mesprodutos'
      '    , messervicos'
      '    , mestotal'
      '    , tfpcodigo'
      '    , refcodigo'
      '    , trfcodigo'
      '    , mesfrete'
      '    , messeguro'
      '    , mesoutras'
      '    , mesbicm'
      '    , mesicm'
      '    , mesbicms'
      '    , mesicms'
      '    , mesipi'
      '    , mespis'
      '    , mescofins'
      '    , mespiss'
      '    , mescofinss'
      '    , clbcodigo'
      '    , trmcodigo'
      '    , mesacrescimo'
      '    , messped'
      '    , temcodigo'
      '    , edritem'
      '    , tdecodigo'
      '    , mesinclusao'
      '    , mesrefeicao)'
      '      (SELECT'
      '        @novachave,'
      '        @etdcodigo := orc.etdcodigo,'
      '        CURRENT_DATE(),'
      '        CURRENT_DATE(),'
      '        '#39'00'#39','
      '        '#39'00'#39','
      '        @cfgserienfce,'
      '        0,'
      '        @toecodigo,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        pClbCodigo,'
      '        orc.trmcodigo,'
      '        0,'
      '        '#39'0'#39','
      '        1,'
      '        @edritem,'
      '        1,'
      '        NOW(),'
      '        1'
      '      FROM orc'
      '      WHERE orc.orcchave = pChave);'
      '  END IF;'
      ''
      '  IF pTipoChave = 1 THEN'
      '    INSERT INTO mes (meschave'
      '    , etdcodigo'
      '    , mesemissao'
      '    , mesregistro'
      '    , tdfcodigo'
      '    , sdecodigo'
      '    , messerie'
      '    , mesnumero'
      '    , toecodigo'
      '    , mesvalor'
      '    , mesdesconto'
      '    , mesprodutos'
      '    , messervicos'
      '    , mestotal'
      '    , tfpcodigo'
      '    , refcodigo'
      '    , trfcodigo'
      '    , mesfrete'
      '    , messeguro'
      '    , mesoutras'
      '    , mesbicm'
      '    , mesicm'
      '    , mesbicms'
      '    , mesicms'
      '    , mesipi'
      '    , mespis'
      '    , mescofins'
      '    , mespiss'
      '    , mescofinss'
      '    , clbcodigo'
      '    , trmcodigo'
      '    , mesacrescimo'
      '    , messped'
      '    , temcodigo'
      '    , edritem'
      '    , tdecodigo'
      '    , mesinclusao'
      '    , mesrefeicao)'
      '      (SELECT'
      '        @novachave,'
      '        @etdcodigo := mes.etdcodigo,'
      '        CURRENT_DATE(),'
      '        CURRENT_DATE(),'
      '        '#39'00'#39','
      '        '#39'00'#39','
      '        @cfgserienfce,'
      '        0,'
      '        @toecodigo,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        pClbCodigo,'
      '        mes.trmcodigo,'
      '        0,'
      '        '#39'0'#39','
      '        1,'
      '        @edritem,'
      '        1,'
      '        NOW(),'
      '        1'
      '      FROM mes'
      '      WHERE mes.meschave = pChave);'
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao oramento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    IF pTipoChave = 0 THEN'
      '      INSERT INTO mor (morchave'
      '      , orcchave'
      '      , meschave)'
      '        VALUES (@novachave, pChave, pMesChave);'
      '    END IF;'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro buscar paremetrizaes de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @cstcodigo = (SELECT'
      '        cstcodigo'
      '      FROM pro'
      '      WHERE pro.procodigo = @procodigo LIMIT 1);'
      ''
      '    SET @cfocfop = (SELECT'
      '        cfocfop'
      '      FROM pro'
      '      WHERE pro.procodigo = @procodigo);'
      ''
      ''
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @disable_triggers = 1;'
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      ''
      '    , icmcodigo'
      '    , itmaliqicm'
      '    , itmbicm'
      '    , itmicm'
      ''
      '    , csicodigo'
      '    , itmaliqipi'
      '    , itmbipi'
      '    , itmipi'
      ''
      '    , cspcodigo'
      '    , itmaliqpis'
      '    , itmbpis'
      '    , itmpis'
      ''
      '    , csfcodigo'
      '    , itmaliqcofins'
      '    , itmbcofins'
      '    , itmcofins'
      ''
      ''
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase)'
      '      (SELECT'
      '        @novachave,'
      '        pMesChave,'
      '        1,'
      '        pro.procodigo,'
      '        pro.cstcodigo,'
      '        1,'
      '        pValor,'
      '        0,'
      '        @toecodigo,'
      '        @cfocfop,'
      ''
      ''
      '        icmcodigo,'
      '        (SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      '          WHERE i.icmcodigo = pro.icmcodigo) icmaliquotas,'
      '        IF((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      
        '          WHERE i.icmcodigo = pro.icmcodigo) <> 0, pValor, 0) ba' +
        'seicm,'
      '        IF((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      '          WHERE i.icmcodigo = pro.icmcodigo) <> 0, (((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      
        '          WHERE i.icmcodigo = pro.icmcodigo) / 100) * pValor), 0' +
        ') valoricm,'
      ''
      '        csicodigo,'
      '        pro.proipialiquota,'
      '        IF(pro.proipialiquota <> 0, pValor, 0) baseipi,'
      
        '        IF(pro.proipialiquota <> 0, ((pro.proipialiquota / 100) ' +
        '* pValor), 0) valoripi,'
      ''
      '        cspcodigo,'
      '        pro.propisaliquota,'
      '        IF(pro.propisaliquota <> 0, pValor, 0) basepis,'
      
        '        IF(pro.propisaliquota <> 0, ((pro.propisaliquota / 100) ' +
        '* pValor), 0) valorpis,'
      ''
      ''
      '        csfcodigo,'
      '        pro.procofinsaliquota,'
      '        IF(pro.procofinsaliquota <> 0, pValor, 0) basecofins,'
      
        '        IF(pro.procofinsaliquota <> 0, ((pro.procofinsaliquota /' +
        ' 100) * pValor), 0) valorcofins,'
      ''
      ''
      '        @pcccodigo,'
      '        pValor,'
      '        pro.unicodigo,'
      '        pun.puncodigo,'
      '        pun.punmultiplicador,'
      '        @cfocfop,'
      '        (SELECT'
      '            p.unicodigobase'
      '          FROM pun p'
      '          WHERE p.puncodigo = pun.puncodigo) unicodigobase'
      '      FROM pro'
      '        INNER JOIN pun'
      '          ON pro.procodigo = pun.procodigo'
      '          AND pro.unicodigo = pun.unicodigo'
      '      WHERE pro.procodigo = @procodigo);'
      ''
      '    SET @disable_triggers = NULL;'
      ''
      ''
      ''
      '    UPDATE mes'
      '    SET mes.mesicm = (SELECT'
      '            i.itmicm'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mes.mesbicm = mestotal,'
      '        mesipi = (SELECT'
      '            i.itmipi'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mespis = (SELECT'
      '            i.itmpis'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mescofins = (SELECT'
      '            i.itmcofins'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave)'
      '    WHERE meschave = pMesChave;'
      ''
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar lote da venda refeicao'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO lte (ltechave'
      '    , flacodigo'
      '    , tfdcodigo'
      '    , ltedata'
      '    , lteprincipal'
      '    , ltejuros'
      '    , ltedesconto'
      '    , ltetotal'
      '    , lteextenso'
      '    , ltehistorico'
      '    , ltemulta'
      '    , ltesituacao'
      '    , clbcodigo'
      '    , ctacodigo'
      '    , lteregistro)'
      '      (SELECT'
      '        @novachave,'
      '        flacodigo,'
      '        tfdcodigo,'
      '        ltedata,'
      '        lteprincipal,'
      '        ltejuros,'
      '        ltedesconto,'
      '        ltetotal,'
      '        lteextenso,'
      '        ltehistorico,'
      '        ltemulta,'
      '        ltesituacao,'
      '        clbcodigo,'
      '        ctacodigo,'
      '        lteregistro'
      '      FROM lte'
      '      WHERE lte.ltechave = pLteChave);'
      ''
      '    IF ROW_COUNT() > 0 THEN'
      '      SET @ltechave = (SELECT'
      '          LAST_INSERT_ID());'
      ''
      '      UPDATE terro'
      
        '      SET Mensagem = '#39'Erro ao gravar detalhes do recebimento da ' +
        'venda refeicao'#39
      '      WHERE Chamada = pChamada;'
      ''
      '      INSERT INTO dtl (dtlchave'
      '      , ltechave'
      '      , cedcodigo'
      '      , dtlvalor'
      '      , mdacodigo)'
      '        (SELECT'
      '          @novachave,'
      '          @ltechave,'
      '          cedcodigo,'
      '          dtlvalor,'
      '          mdacodigo'
      '        FROM dtl'
      '        WHERE dtl.ltechave = pLteChave);'
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        UPDATE terro'
      
        '        SET Mensagem = '#39'Erro ao gravar registro financeiro da ve' +
        'nda refeicao'#39
      '        WHERE Chamada = pChamada;'
      ''
      '        DELETE'
      '          FROM trfi;'
      ''
      '        INSERT INTO trfi (ID'
      '        , etdcodigo'
      '        , mdacodigo'
      '        , tfdcodigo'
      '        , numparc'
      '        , dtvecto'
      '        , vlrparcela'
      '        , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE' +
        '(), pValor, pMesChave);'
      ''
      
        '        CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, pChamada, ' +
        '@TitCodigo);'
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            pMesChave'
      '          FROM rfi'
      '          WHERE rfi.titcodigo = @TitCodigo);'
      '      END IF;'
      '    END IF;'
      '  END IF;'
      ''
      '  SET @disable_triggers = NULL;'
      'END //')
    Delimiter = '//'
    Left = 744
    Top = 40
  end
  object us001222: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      'IF  EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'cfg'#39
      '      AND column_name = '#39'cfgmgouprorefeicao'#39') THEN'
      ' '
      ''
      '-- Alter table "cfg"'
      '--'
      'ALTER TABLE cfg'
      '  DROP COLUMN cfgmgouprorefeicao;'
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 792
    Top = 32
  end
  object us001223: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'cfgmgou'#39
      '      AND column_name = '#39'cfgmgoupadraovenda'#39') THEN'
      ' '
      ''
      '-- Alter table "cfgmgou"'
      '--'
      'ALTER TABLE cfgmgou'
      '  ADD COLUMN cfgmgoupadraovenda integer default 0;'
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 856
    Top = 24
  end
  object us001224: TUniScript
    SQL.Strings = (
      'REPLACE INTO mda'
      '('
      '  mdacodigo'
      ' ,mdaidentificacao'
      ')'
      'VALUES'
      '('
      '  40 -- mdacodigo - INT(11) NOT NULL'
      ' ,'#39'On Line MENUVEM'#39' -- mdaidentificacao - VARCHAR(30) NOT NULL'
      ');'
      ''
      'REPLACE INTO mda'
      '('
      '  mdacodigo'
      ' ,mdaidentificacao'
      ')'
      'VALUES'
      '('
      '  41 -- mdacodigo - INT(11) NOT NULL'
      ' ,'#39'On Line AIQFome'#39' -- mdaidentificacao - VARCHAR(30) NOT NULL'
      ');'
      ''
      ''
      'REPLACE INTO mda'
      '('
      '  mdacodigo'
      ' ,mdaidentificacao'
      ')'
      'VALUES'
      '('
      '  42 -- mdacodigo - INT(11) NOT NULL'
      ' ,'#39'On Line IFood'#39' -- mdaidentificacao - VARCHAR(30) NOT NULL'
      ');'
      ''
      'REPLACE INTO mda'
      '('
      '  mdacodigo'
      ' ,mdaidentificacao'
      ')'
      'VALUES'
      '('
      '  43 -- mdacodigo - INT(11) NOT NULL'
      ' ,'#39'On Line TemTudo'#39' -- mdaidentificacao - VARCHAR(30) NOT NULL'
      ');'
      ''
      ''
      ''
      ''
      ''
      '')
    Delimiter = '//'
    Left = 912
    Top = 24
  end
  object us001225: TUniScript
    SQL.Strings = (
      'CREATE TABLE if not exists cxm ('
      '  cxmchave int(11) NOT NULL AUTO_INCREMENT,'
      '  ccxchave int(11) DEFAULT NULL,'
      '  cxmdinheiro decimal(10, 2) DEFAULT 0.00,'
      '  cxmcartoes decimal(10, 2) DEFAULT 0.00,'
      '  cxmonlineaplicativo decimal(10, 2) DEFAULT 0.00,'
      '  cxmconvenio decimal(10, 2) DEFAULT 0.00,'
      '  cxmpix decimal(10, 2) DEFAULT 0.00,'
      '  PRIMARY KEY (cxmchave)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET utf8mb4'
      'COLLATE utf8mb4_general_ci'
      'COMMENT = '#39'caixa registro manual'#39';')
    Delimiter = '//'
    Left = 504
    Top = 80
  end
  object us001226: TUniScript
    SQL.Strings = (
      'DROP VIEW v_pro CASCADE//'
      ''
      'CREATE'
      'DEFINER = '#39'root'#39'@'#39'%'#39
      'VIEW v_pro'
      'AS'
      'SELECT'
      '  `pro`.`procodigo` AS `procodigo`,'
      '  `pro`.`pronome` AS `pronome`,'
      '  `tpo`.`tpoidentificacao` AS `tpoidentificacao`,'
      '  `mar`.`maridentificacao` AS `maridentificacao`,'
      '  `grp`.`grpidentificacao` AS `grpidentificacao`,'
      '  `icm`.`icmaliquotas` AS `icmaliquotas`,'
      '  `pro`.`proncm` AS `proncm`,'
      '  `pro`.`prosaldo` AS `prosaldo`,'
      '  `pro`.`prosaldodisp` AS `prosaldodisp`,'
      '  `sip`.`sipcodigo` AS `sipcodigo`,'
      '  `pro`.`proobs` AS `proobs`,'
      '  `pro`.`proreferencia` AS `proreferencia`,'
      '  `uni`.`unisimbolo` AS `unisimbolo`,'
      '  `pun`.`punprecoav` AS `punprecoav`,'
      '  `pun`.`punprecoap` AS `punprecoap`,'
      '  `pro`.`tpocodigo` AS `tpocodigo`,'
      '  `pro`.`proanpcodigo` AS `proanpcodigo`,'
      '  `enp`.`enpcodigo` AS `enpcodigo`,'
      '  `enp`.`enpendereco` AS `enpendereco`,'
      '  `pro`.`propedecomple` AS `propedecomple`,'
      '  `cpb`.`cpbcodbalanca` AS `cpbcodbalanca`,'
      '  `pro`.`gracodigo` AS `gracodigo`,'
      '  `dpr`.`dpridentificacao` AS `dpridentificacao`,'
      '  `pro`.`proconsolidado` AS `proconsolidado`,'
      
        '  (`pun`.`punprecoav` - `pun`.`puncusto`) / `pun`.`puncusto` * 1' +
        '00 AS `punpercav`,'
      
        '  (`pun`.`punprecoap` - `pun`.`puncusto`) / `pun`.`puncusto` * 1' +
        '00 AS `punpercap`,'
      '  `pun`.`puncusto` AS `puncusto`,'
      '  `pro`.`grpcodigo` AS `grpcodigo`,'
      '  `pro`.`cstcodigo` AS `cstcodigo`,'
      '  `pro`.`procest` AS `procest`,'
      
        '  IF(`pro`.`proproducao` = 1, '#39'PRODUCAO PROPRIA'#39', `pun`.`imecodi' +
        'go`) AS `imecodigo`,'
      '  `pro`.`probalanca` AS `probalanca`,'
      '  `pro`.`imuid` AS `imuid`,'
      '  `pro`.`pronatrecisenta` AS `pronatrecisenta`,'
      '  `pro`.`proabc` AS `proabc`,'
      '  `pro`.`promargemcontrib` AS `promargemcontrib`,'
      '  `pro`.`proproducao` AS `proproducao`,'
      '  `pro`.`cfocfop` AS `cfocfop`,'
      '  `pro`.`cfocfopfora` AS `cfocfopfora`,'
      '  `icmfora`.`icmaliquotas` AS `icmaliquotasfora`,'
      '  `pro`.`proenvioimendes` AS `proenvioimendes`,'
      '  `pro`.`proretornoimendes` AS `proretornoimendes`,'
      '  `pun`.`tuncodigo` AS `tuncodigo`'
      'FROM (((((((((((`pro`'
      '  JOIN `mar`'
      '    ON (`pro`.`marcodigo` = `mar`.`marcodigo`))'
      '  JOIN `grp`'
      '    ON (`pro`.`grpcodigo` = `grp`.`grpcodigo`))'
      '  JOIN `icm`'
      '    ON (`pro`.`icmcodigo` = `icm`.`icmcodigo`))'
      '  LEFT JOIN `icm` `icmfora`'
      '    ON (`pro`.`icmcodigofora` = `icmfora`.`icmcodigo`))'
      '  JOIN `uni`'
      '    ON (`pro`.`unicodigo` = `uni`.`unicodigo`))'
      '  LEFT JOIN `cpb`'
      '    ON (`pro`.`procodigo` = `cpb`.`procodigo`))'
      '  JOIN `sip`'
      '    ON (`sip`.`sipcodigo` = `pro`.`sipcodigo`))'
      '  JOIN `pun`'
      '    ON (`pro`.`procodigo` = `pun`.`procodigo`'
      '    AND `pro`.`unicodigo` = `pun`.`unicodigo`))'
      '  JOIN `tpo`'
      '    ON (`pro`.`tpocodigo` = `tpo`.`tpocodigo`))'
      '  JOIN `dpr`'
      '    ON (`pro`.`dprcodigo` = `dpr`.`dprcodigo`))'
      '  LEFT JOIN `v_enp` `enp`'
      '    ON (`enp`.`enpcodigo` = `pro`.`enpcodigo`));')
    Delimiter = '//'
    Left = 552
    Top = 80
  end
  object us001227: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'orc'#39
      '      AND column_name = '#39'orcpedidointegracao'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "orc"'
      '--'
      'ALTER TABLE orc'
      '  ADD COLUMN  orcpedidointegracao varchar(20);'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 608
    Top = 88
  end
  object us001228: TUniScript
    SQL.Strings = (
      'CREATE TABLE IF NOT EXISTS cxm ('
      '  cxmchave int(11) NOT NULL AUTO_INCREMENT,'
      '  ccxchave int(11) DEFAULT NULL,'
      '  cxmdinheiro decimal(10, 2) DEFAULT 0.00,'
      '  cxmcartoes decimal(10, 2) DEFAULT 0.00,'
      '  cxmonlineaplicativo decimal(10, 2) DEFAULT 0.00,'
      '  cxmconvenio decimal(10, 2) DEFAULT 0.00,'
      '  cxmpix decimal(10, 2) DEFAULT 0.00,'
      '  PRIMARY KEY (cxmchave)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET utf8mb4'
      'COLLATE utf8mb4_general_ci'
      'COMMENT = '#39'caixa registro manual'#39
      'ROW_FORMAT = DYNAMIC//')
    Delimiter = '//'
    Left = 664
    Top = 88
  end
  object us001229: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'cxm'#39
      '      AND column_name = '#39'cxmpix'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "cxm"'
      '--'
      'ALTER TABLE cxm'
      '  ADD COLUMN  cxmpix  float(9, 2) default 0;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 720
    Top = 96
  end
  object us001230: TUniScript
    SQL.Strings = (
      '--'
      
        '-- Script was generated by Devart dbForge Studio for MySQL, Vers' +
        'ion 6.3.358.0'
      '-- Product home page: http://www.devart.com/dbforge/mysql/studio'
      '-- Script date 11/03/2024 08:56:47'
      '-- Server version: 5.5.5-10.5.15-MariaDB-0+deb11u1'
      '-- Client version: 4.1'
      '--'
      ''
      'DROP PROCEDURE IF EXISTS FechaMesa//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesa (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = pOrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 13;'
      ''
      ''
      ''
      '    INSERT INTO olt (oltchave'
      '    , orcchave'
      '    , ltechave'
      '    , oltidentificacao'
      '    , olttipo)'
      
        '      VALUE (@novachave, pOrcChave, @ltechave, pNome, pTipoFecha' +
        'mento);'
      ''
      ''
      ''
      ''
      '    SET @LteDesconto = IFNULL((SELECT'
      '        SUM(lte.ltedesconto)'
      '      FROM olt'
      '        INNER JOIN lte'
      '          ON olt.ltechave = lte.ltechave'
      '      WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '    SET @OrcTotalAv = (SELECT'
      '        SUM(itovalorav * itoquantidade) totav'
      '      FROM ito,'
      '           pro'
      '      WHERE ito.procodigo = pro.procodigo'
      '      AND ito.stocodigo <> 88'
      '      AND pro.tpocodigo = 0'
      '      AND orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    IF @LteDesconto > 0 THEN'
      ''
      ''
      '      SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '      UPDATE ito, pro'
      '      SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '          itosaldoav = (ito.itototalav - itodescontoav),'
      '          itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '          itosaldoap = (ito.itototalav - itodescontoav),'
      '          itopercdescap = ROUND(@percdesc, 3),'
      '          itopercdescav = ROUND(@percdesc, 3)'
      '      WHERE ito.stocodigo <> 88'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo = 0'
      '      AND ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '      SET @centavos = @LteDesconto - (SELECT'
      '          SUM(itodescontoav)'
      '        FROM ito,'
      '             pro'
      '        WHERE ito.orcchave = pOrcChave'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0);'
      ''
      ''
      ''
      ''
      '      IF @centavos <> 0 THEN'
      ''
      '        UPDATE ito, pro'
      '        SET itodescontoav = itodescontoav + @centavos,'
      '            itodescontoap = itodescontoap + @centavos,'
      '            itosaldoav = itosaldoav + @centavos,'
      '            itosaldoap = itosaldoap + @centavos'
      '        WHERE ito.stocodigo <> 88'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0'
      '        AND ito.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      
        '          orc.orcpercdescav = IF(tito.descap > 0, (tito.descap /' +
        ' tito.totap), 0),'
      '          orc.orctotalap = (tito.totap - tito.descap)'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      '    END IF;'
      ''
      ''
      '    SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '    CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pConfi' +
        'rma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 14;'
      ''
      ''
      ''
      '    SET @VlrFechamento = (SELECT'
      '        SUM(dtl.dtlvalor) dtlvalor'
      '      FROM dtl'
      '        INNER JOIN olt'
      '          ON dtl.ltechave = olt.ltechave'
      '      WHERE olt.orcchave = pOrcChave'
      '      AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '    IF @VlrFechamento > 0 THEN'
      ''
      ''
      '      SET @etdcodigo = (SELECT'
      '          etdcodigo'
      '        FROM orc'
      '        WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '      SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      OPEN curlote;'
      '    read_loop:'
      '      LOOP'
      ''
      '        FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '        IF done THEN'
      ''
      '          LEAVE read_loop;'
      '        END IF;'
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade'
      '          AND dtl.mdacodigo != 7);'
      ''
      '        DELETE'
      '          FROM trfi'
      '        WHERE mdacodigo <> modalidade;'
      ''
      '        INSERT INTO trfi (ID'
      '        , etdcodigo'
      '        , mdacodigo'
      '        , tfdcodigo'
      '        , numparc'
      '        , dtvecto'
      '        , vlrparcela'
      '        , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE' +
        '(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '        CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem, @' +
        'TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 17;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      END LOOP;'
      ''
      ''
      '      CLOSE curlote;'
      ''
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      '    INSERT INTO rfm (rfichave'
      '    , meschave)'
      ''
      '      (SELECT DISTINCT'
      ''
      '        rfichave,'
      '        @MesChave'
      '      FROM olt'
      '        INNER JOIN mlt'
      '          ON olt.ltechave = mlt.ltechave'
      '        INNER JOIN mfi'
      '          ON mlt.mfichave = mfi.mfichave'
      '      WHERE olt.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '        orc.orctotalav = (tito.totav - tito.descav),'
      ''
      ''
      ''
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        orc.orcdataencerr = CURRENT_DATE(),'
      '        orc.orchoraencerr = CURRENT_TIME(),'
      '        orc.stocodigo = 3'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '    UPDATE ito'
      '    SET ito.stocodigo = 3'
      '    WHERE ito.orcchave = pOrcChave'
      '    AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END//'
      ''
      ''
      'DROP PROCEDURE IF EXISTS FechaMesaParcial//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesaParcial (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT DISTINCT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      ''
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = @OrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      ''
      '  SET pConfirma = @Confirma;'
      ''
      ''
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      ''
      ''
      ''
      '  SET pLteChave = 0;'
      ''
      ''
      '  SET pMesChave = 0;'
      ''
      ''
      '  SET @meschave = 0;'
      ''
      ''
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      '    IF pTipo = 1 THEN'
      ''
      ''
      '      SET @qtdItem = (SELECT'
      '          COUNT(*)'
      '        FROM titem);'
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      ''
      '        SET @ContaItem = 1;'
      ''
      ''
      ''
      '        SET ErroMensagem = 1;'
      ''
      ''
      ''
      '        INSERT INTO orc (orcchave'
      '        , etdcodigo'
      '        , clbcodigo'
      '        , fopcodigo'
      '        , tdecodigo'
      '        , stocodigo'
      '        , moccodigo'
      '        , foacodigo'
      '        , trmcodigo'
      '        , tfpcodigo'
      '        , puocodigo'
      '        , orcdataabert'
      '        , orchoraabert'
      '        , orcgeralav'
      '        , orcdescontoav'
      '        , orcpercdescav'
      '        , orctotalav'
      '        , orcgeralap'
      '        , orcdescontoap'
      '        , orcpercdescap'
      '        , orctotalap'
      '        , orcobs'
      '        , orcdestimpre'
      '        , edritem'
      '        , edrcodigo'
      '        , clbvendedor'
      '        , orcmesa'
      '        , orctelefone'
      '        , ccxchave'
      '        , cznchave)'
      '          SELECT'
      '            @novachave,'
      '            etdcodigo,'
      '            pClbCodigo,'
      '            fopcodigo,'
      '            tdecodigo,'
      '            3,'
      '            moccodigo,'
      '            foacodigo,'
      '            trmcodigo,'
      '            tfpcodigo,'
      '            puocodigo,'
      '            orcdataabert,'
      '            TIME(NOW()),'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            orcobs,'
      '            orcdestimpre,'
      '            edritem,'
      '            edrcodigo,'
      '            pClbCodigo,'
      '            orcmesa,'
      '            orctelefone,'
      '            ccxchave,'
      '            cznchave'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '        IF (ROW_COUNT() > 0) THEN'
      ''
      '          SET @orcchave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      ''
      '          SET ErroMensagem = 2;'
      ''
      ''
      ''
      '          SET @troqtd = 0;'
      ''
      ''
      '          SET @troqtd = (SELECT DISTINCT'
      '              COUNT(orcchaveorigem)'
      '            FROM tro'
      '            WHERE orcchaveorigem = pOrcChave'
      '            AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '          IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '            SET @orcchaveinicial = IFNULL((SELECT'
      '                orcchaveorigem'
      '              FROM tro'
      '              WHERE orcchavedestino = pOrcChave'
      '              ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '            INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '              VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE ' +
        'KEY UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = ' +
        '@orcchave;'
      ''
      ''
      '          END IF;'
      ''
      ''
      ''
      ''
      ''
      '          SET @item = 0;'
      ''
      ''
      '          WHILE (@ContaItem <= @qtdItem) DO'
      ''
      '            SET @item = @item + 1;'
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 3;'
      ''
      ''
      ''
      ''
      '            SELECT'
      '              titem.itochave,'
      '              qtde'
      '            FROM titem'
      '            WHERE titem.ID = @ContaItem INTO @itochave'
      '            , @qtde;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 4;'
      ''
      ''
      ''
      ''
      '            INSERT INTO ito (itochave'
      '            , orcchave'
      '            , procodigo'
      '            , puncodigo'
      '            , unicodigo'
      '            , stocodigo'
      '            , tdecodigo'
      '            , itoquantidade'
      '            , itovalorav'
      '            , itototalav'
      '            , itodescontoav'
      '            , itosaldoav'
      '            , itovalorap'
      '            , itototalap'
      '            , itodescontoap'
      '            , itosaldoap'
      '            , itocontendo'
      '            , itoproservico'
      '            , itoprocomple'
      '            , itodataalter'
      '            , itoitem'
      '            , itogint'
      '            , itopercdescap'
      '            , itopercdescav'
      '            , itoinfadprod'
      '            , itoquanticondi'
      '            , itoquantidevolcondi'
      '            , vrpcodigo'
      '            , itoobs'
      '            , itoacrescimoav'
      '            , clbatendente'
      '            , oricodigo)'
      '              SELECT'
      '                @novoito,'
      '                @orcchave,'
      '                ito.procodigo,'
      '                puncodigo,'
      '                unicodigo,'
      '                3,'
      '                tdecodigo,'
      '                @qtde,'
      '                itovalorav,'
      '                (@qtde * (itovalorav + itoacrescimoav)),'
      
        '                ROUND(((itovalorav + itoacrescimoav) * @percdesc' +
        ') * @qtde, 2),'
      
        '                (((itovalorav + itoacrescimoav) * @qtde) - (ROUN' +
        'D(((itovalorav + itoacrescimoav) * @percdesc) * @qtde, 2))),'
      '                itovalorap,'
      '                (@qtde * itovalorap),'
      '                ROUND((itototalap * @percdesc), 2),'
      '                (itototalap - itodescontoap),'
      '                itocontendo,'
      '                itoproservico,'
      '                itoprocomple,'
      '                CURRENT_DATE(),'
      '                @item,'
      '                itogint,'
      '                ROUND(@percdesc, 3),'
      '                ROUND(@percdesc, 3),'
      '                itoinfadprod,'
      '                itoquanticondi,'
      '                itoquantidevolcondi,'
      '                vrpcodigo,'
      '                itoobs,'
      '                itoacrescimoav,'
      '                clbatendente,'
      '                6'
      '              FROM ito'
      '              WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      '            SET @immitochave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      ''
      ''
      ''
      '            INSERT INTO imm (immchave,'
      '            itochave,'
      '            tcicodigo,'
      '            immimpresso,'
      '            immentregue,'
      '            immmodo,'
      '            ccxchave,'
      '            immhorapedido,'
      '            immhoraentrega,'
      '            immrecebido,'
      '            dorchave,'
      '            immnumepedido,'
      '            trmcodigo,'
      '            immdestino,'
      '            immidentificacao,'
      '            immgarsom,'
      '            immtemporetardo,'
      '            immmodoimpressao,'
      '            cznchave,'
      '            etdcodigoent,'
      '            immpratos,'
      '            immcopos,'
      '            immnumepedidoint,'
      '            clbcodigo,'
      '            immhoraimpresso,'
      '            immhoraimprimir,'
      '            immhoraentregadopedido,'
      '            immhoranotificadopedido,'
      '            immhorasaidadopedido)'
      '              SELECT'
      '                @novaimmchave,'
      '                @immitochave,'
      '                tcicodigo,'
      '                immimpresso,'
      '                immentregue,'
      '                immmodo,'
      '                ccxchave,'
      '                immhorapedido,'
      '                immhoraentrega,'
      '                immrecebido,'
      '                dorchave,'
      '                immnumepedido,'
      '                trmcodigo,'
      '                immdestino,'
      '                immidentificacao,'
      '                immgarsom,'
      '                immtemporetardo,'
      '                immmodoimpressao,'
      '                cznchave,'
      '                etdcodigoent,'
      '                immpratos,'
      '                immcopos,'
      '                immnumepedidoint,'
      '                clbcodigo,'
      '                immhoraimpresso,'
      '                immhoraimprimir,'
      '                immhoraentregadopedido,'
      '                immhoranotificadopedido,'
      '                immhorasaidadopedido'
      '              FROM imm'
      '              WHERE itochave = @itochave;'
      ''
      '            UPDATE imp'
      '            SET itochave = @immitochave'
      '            WHERE imp.itochave = @itochave;'
      ''
      ''
      ''
      '            SELECT'
      '              COUNT(itochave)'
      '            FROM sbi'
      '            WHERE sbi.itochave = @itochave INTO @qtdItemSbi;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItemsbi = 1;'
      ''
      ''
      ''
      '            WHILE (@ContaItemsbi <= @qtdItemSbi) DO'
      ''
      ''
      '              INSERT INTO sbi'
      '                (SELECT'
      '                  @outrachave,'
      '                  @immitochave,'
      '                  sbrcodigo,'
      '                  sbiobs,'
      '                  sbiitem,'
      '                  bprchave'
      '                FROM sbi'
      '                WHERE itochave = @itochave'
      '                AND sbi.sbiitem = @ContaItemsbi);'
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @ultimosbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      '              END IF;'
      ''
      ''
      ''
      ''
      '              SELECT'
      '                COUNT(itochave)'
      '              FROM isi'
      '              WHERE itochave = @itochave'
      '              AND isiitem = @ContaItemsbi INTO @qtdItemisi;'
      ''
      ''
      ''
      ''
      '              IF @qtdItemisi > 0 THEN'
      ''
      ''
      '                INSERT INTO isi'
      '                  (SELECT'
      '                    @novaisichave,'
      '                    @ultimosbichave,'
      '                    tsicodigo,'
      '                    procodigo,'
      '                    isitipo,'
      '                    @immitochave,'
      '                    isiitem,'
      '                    isiquantidade,'
      '                    0'
      '                  FROM isi'
      '                  WHERE itochave = @itochave'
      '                  AND isiitem = @ContaItemsbi);'
      ''
      '              END IF;'
      ''
      ''
      ''
      '              SET @ContaItemsbi = @ContaItemsbi + 1;'
      ''
      ''
      '            END WHILE;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 5;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            UPDATE ito'
      '            SET ito.itoquantidade = (ito.itoquantidade - @qtde),'
      
        '                ito.itototalav = (ito.itoquantidade * ito.itoval' +
        'orav),'
      
        '                ito.itosaldoav = (ito.itototalav - itodescontoav' +
        '),'
      
        '                ito.itototalap = (ito.itoquantidade * ito.itoval' +
        'orap),'
      '                ito.itosaldoap = (itototalap - itodescontoap)'
      '            WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItem = @ContaItem + 1;'
      ''
      ''
      '          END WHILE;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 6;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      '              orc.orcdescontoav = tito.descav,'
      
        '              orc.orcpercdescav = IF(tito.descav > 0, (tito.desc' +
        'av / tito.totav), 0),'
      '              orc.orctotalav = (tito.totav - tito.descav),'
      '              orc.orcgeralap = tito.totap,'
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = @orcchave;'
      ''
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '              orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      '        SET ErroMensagem = 8;'
      ''
      ''
      
        '        CALL RegistraMes(@orcchave, pClbCodigo, ErroMensagem, pC' +
        'onfirma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 10;'
      ''
      ''
      ''
      ''
      '        SET @troqtd = 0;'
      ''
      ''
      '        SET @troqtd = (SELECT DISTINCT'
      '            COUNT(orcchaveorigem)'
      '          FROM tro'
      '          WHERE orcchaveorigem = pOrcChave'
      '          AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '        IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '          SET @orcchaveinicial = IFNULL((SELECT'
      '              orcchaveorigem'
      '            FROM tro'
      '            WHERE orcchavedestino = pOrcChave'
      '            ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '          INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '            VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE KE' +
        'Y UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = @o' +
        'rcchave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 11;'
      ''
      ''
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, @OrcChave, @ltechave, pNome, 1);'
      '      ELSE'
      ''
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, pOrcChave, @ltechave, pNome, 0);'
      '      END IF;'
      ''
      ''
      ''
      '      IF (@qtdItem > 0)'
      '        AND (@orcchave > 0) THEN'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = @orcchave'
      '          AND dtl.mdacodigo != 7);'
      ''
      ''
      '        IF @VlrFechamento > 0 THEN'
      ''
      ''
      '          SET @etdcodigo = (SELECT'
      '              etdcodigo'
      '            FROM orc'
      '            WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      '          SET ErroMensagem = 15;'
      ''
      ''
      '          OPEN curlote;'
      '        read_loop:'
      '          LOOP'
      ''
      '            FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '            IF done THEN'
      ''
      '              LEAVE read_loop;'
      '            END IF;'
      ''
      ''
      '            SET @VlrFechamento = (SELECT'
      '                SUM(dtl.dtlvalor) dtlvalor'
      '              FROM dtl'
      '                INNER JOIN olt'
      '                  ON dtl.ltechave = olt.ltechave'
      '              WHERE olt.orcchave = @orcchave'
      '              AND dtl.ltechave = lote'
      '              AND dtl.mdacodigo = modalidade'
      '              AND dtl.mdacodigo != 7);'
      ''
      '            DELETE'
      '              FROM trfi'
      '            WHERE mdacodigo <> modalidade;'
      ''
      '            INSERT INTO trfi (ID'
      '            , etdcodigo'
      '            , mdacodigo'
      '            , tfdcodigo'
      '            , numparc'
      '            , dtvecto'
      '            , vlrparcela'
      '            , numero)'
      
        '              VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_' +
        'DATE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '            SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '            CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, ErroMe' +
        'nsagem, @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 9;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          END LOOP;'
      ''
      ''
      '          CLOSE curlote;'
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      ''
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            @MesChave'
      '          FROM olt'
      '            INNER JOIN mlt'
      '              ON olt.ltechave = mlt.ltechave'
      '            INNER JOIN mfi'
      '              ON mlt.mfichave = mfi.mfichave'
      '          WHERE olt.orcchave = @OrcChave);'
      ''
      '      END IF;'
      ''
      ''
      ''
      '    ELSE'
      ''
      ''
      '      SET ErroMensagem = 13;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      INSERT INTO olt (oltchave'
      '      , orcchave'
      '      , ltechave'
      '      , oltidentificacao'
      '      , olttipo)'
      
        '        VALUE (@novachave, @orcchave, @ltechave, pNome, pTipoFec' +
        'hamento);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET @LteDesconto = IFNULL((SELECT'
      '          SUM(lte.ltedesconto)'
      '        FROM olt'
      '          INNER JOIN lte'
      '            ON olt.ltechave = lte.ltechave'
      '        WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '      SET @OrcTotalAv = (SELECT'
      '          SUM(itovalorav * itoquantidade) totav'
      '        FROM ito'
      '        WHERE orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '      IF @LteDesconto > 0 THEN'
      ''
      ''
      '        SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '        UPDATE ito'
      '        SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '            itosaldoav = (ito.itototalav - itodescontoav),'
      '            itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '            itosaldoap = (ito.itototalav - itodescontoav),'
      '            itopercdescap = ROUND(@percdesc, 3),'
      '            itopercdescav = ROUND(@percdesc, 3)'
      '        WHERE ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '        SET @centavos = @LteDesconto - (SELECT'
      '            SUM(itodescontoav)'
      '          FROM ito'
      '          WHERE ito.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '        IF @centavos <> 0 THEN'
      ''
      '          UPDATE ito'
      '          SET itodescontoav = itodescontoav + @centavos,'
      '              itodescontoap = itodescontoap + @centavos,'
      '              itosaldoav = itosaldoav + @centavos,'
      '              itosaldoap = itosaldoap + @centavos'
      '          WHERE ito.orcchave = pOrcChave;'
      ''
      '        END IF;'
      ''
      ''
      ''
      '        UPDATE orc'
      '        INNER JOIN (SELECT'
      '            ito.orcchave,'
      '            SUM(itototalav) totav,'
      '            SUM(itodescontoav) descav,'
      '            SUM(itototalap) totap,'
      '            SUM(itodescontoap) descap'
      '          FROM ito'
      '          WHERE stocodigo != 88'
      '          GROUP BY ito.orcchave) tito'
      '          ON tito.orcchave = orc.orcchave'
      '        SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '            orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '            orc.orcdescontoav = tito.descap,'
      
        '            orc.orcpercdescav = IF(tito.descap > 0, (tito.descap' +
        ' / tito.totap), 0),'
      '            orc.orctotalap = (tito.totap - tito.descap)'
      '        WHERE orc.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '      CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pCon' +
        'firma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET ErroMensagem = 14;'
      ''
      ''
      ''
      '      SET @VlrFechamento = (SELECT'
      '          SUM(dtl.dtlvalor) dtlvalor'
      '        FROM dtl'
      '          INNER JOIN olt'
      '            ON dtl.ltechave = olt.ltechave'
      '        WHERE olt.orcchave = pOrcChave'
      '        AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '      IF @VlrFechamento > 0 THEN'
      ''
      ''
      '        SET @etdcodigo = (SELECT'
      '            etdcodigo'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        OPEN curlote;'
      '      read_loop:'
      '        LOOP'
      ''
      '          FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '          IF done THEN'
      ''
      '            LEAVE read_loop;'
      '          END IF;'
      ''
      '          SET @VlrFechamento = (SELECT'
      '              SUM(dtl.dtlvalor) dtlvalor'
      '            FROM dtl'
      '              INNER JOIN olt'
      '                ON dtl.ltechave = olt.ltechave'
      '            WHERE olt.orcchave = pOrcChave'
      '            AND dtl.ltechave = lote'
      '            AND dtl.mdacodigo = modalidade'
      '            AND dtl.mdacodigo != 7);'
      ''
      ''
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '            VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DA' +
        'TE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '          SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '          CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem,' +
        ' @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 17;'
      ''
      ''
      ''
      '          INSERT INTO rfm (rfmchave'
      '          , rfichave'
      '          , meschave)'
      ''
      '            (SELECT DISTINCT'
      '              @novachave,'
      '              rfichave,'
      '              @MesChave'
      '            FROM olt'
      '              INNER JOIN mlt'
      '                ON olt.ltechave = mlt.ltechave'
      '              INNER JOIN mfi'
      '                ON mlt.mfichave = mfi.mfichave'
      '            WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '        END LOOP;'
      ''
      ''
      '        CLOSE curlote;'
      ''
      '      END IF;'
      ''
      ''
      '      INSERT INTO rfm (rfmchave'
      '      , rfichave'
      '      , meschave)'
      ''
      '        (SELECT DISTINCT'
      '          @novachave,'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '      SET ErroMensagem = 18;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      '          orc.orcpercdescav = @percdesc,'
      '          orc.orctotalap = (tito.totap - tito.descap),'
      '          orc.orcdataencerr = CURRENT_DATE(),'
      '          orc.orchoraencerr = CURRENT_TIME(),'
      '          orc.stocodigo = 3'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.stocodigo = 3'
      '      WHERE ito.orcchave = pOrcChave'
      '      AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '    END IF;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END //')
    Delimiter = '//'
    Left = 808
    Top = 96
  end
  object us001235: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcomprovante'#39') THEN'
      ''
      'ALTER TABLE trm'
      
        '   CHANGE COLUMN trmterminalcomprovante trmterminalcomprovante1v' +
        'ia varchar(8000);'
      ' '
      'end if; '
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcomprovante2via'#39') THEN'
      ''
      'ALTER TABLE trm'
      
        '  ADD COLUMN trmterminalcomprovante2via varchar(8000) DEFAULT '#39#39 +
        ' ;'
      ' '
      'end if; '
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      '')
    Delimiter = '//'
    Left = 752
    Top = 136
  end
  object us001242: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaIndices//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaIndices ()'
      'BEGIN'
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mfi'#39
      '      AND INDEX_NAME = '#39'mfisituacao'#39') THEN'
      ''
      ''
      'ALTER TABLE mfi'
      '  ADD INDEX mfisituacao (mfisituacao);'
      ''
      '  END IF;'
      ''
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mfi'#39
      '      AND INDEX_NAME = '#39'mfidata'#39') THEN'
      ''
      'ALTER TABLE mfi'
      '  ADD INDEX mfidata (mfidata);'
      ''
      '  END IF;'
      ''
      ''
      'END//'
      ''
      'CALL AtualizaIndices()//'
      ''
      '')
    Left = 824
    Top = 216
  end
  object us001241: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaIndices//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaIndices ()'
      'BEGIN'
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'v_rfi'#39
      '      AND INDEX_NAME = '#39'v_rfi_rfivencimento'#39') THEN'
      ''
      ''
      'ALTER TABLE v_rfi'
      '  ADD INDEX v_rfi_rfivencimento (rfivencimento);'
      ''
      '  END IF;'
      ''
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'v_rfi'#39
      '      AND INDEX_NAME = '#39'v_rfi_srfcodigo'#39') THEN'
      ''
      'ALTER TABLE v_rfi'
      '  ADD INDEX v_rfi_srfcodigo (srfcodigo);'
      ''
      '  END IF;'
      ''
      ''
      'END//'
      ''
      'CALL AtualizaIndices()//'
      ''
      '')
    Left = 768
    Top = 216
  end
  object us001240: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'ltr'#39
      '      AND column_name = '#39'rdcnrauto'#39') THEN'
      ''
      'ALTER TABLE ltr'
      '  ADD COLUMN rdcnrauto VARCHAR(200) NOT NULL DEFAULT '#39#39';'
      ''
      ' '
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      '')
    Delimiter = '//'
    Left = 712
    Top = 216
  end
  object us001239: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'clt'#39
      '      AND column_name = '#39'dtlchave'#39') THEN'
      ''
      'ALTER TABLE clt'
      '  ADD COLUMN dtlchave INT(11) NOT NULL DEFAULT 0;'
      ' '
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      '')
    Delimiter = '//'
    Left = 648
    Top = 216
  end
  object us001238: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rdc'#39
      '      AND column_name = '#39'rdcnrauto'#39') THEN'
      ''
      'ALTER TABLE rdc'
      '  CHANGE COLUMN rdcnrauto rdcnrauto VARCHAR(200);'
      ' '
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      '')
    Left = 584
    Top = 216
  end
  object us001237: TUniScript
    SQL.Strings = (
      'drop table if exists rct//'
      ''
      'CREATE TABLE IF NOT EXISTS rct ('
      '  rctchave int(11) NOT NULL AUTO_INCREMENT,'
      '  rctvalor float(9, 3) NOT NULL DEFAULT 0.000 ,'
      '  rctnrauto varchar(200) DEFAULT '#39#39','
      '  adccodigo int(11) NOT NULL,'
      '  rctparcelas int(3) NOT NULL DEFAULT 1 ,'
      '  bdccodigo int(11) DEFAULT NULL,'
      '  rctcomprovante1via varchar(1000) DEFAULT '#39#39','
      '  rctcomprovante2via varchar(1000) DEFAULT '#39#39','
      '  rcthora time,'
      '  orcchave int(11) DEFAULT 0,'
      '  rctstatus varchar(50) DEFAULT '#39#39','
      '  PRIMARY KEY (rctchave)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci'
      
        'COMMENT = '#39'Registro temporario dos detalhes da opera'#231'ao com cart' +
        #227'o'#39
      'ROW_FORMAT = DYNAMIC//')
    Delimiter = '//'
    Left = 528
    Top = 216
  end
  object us001236: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ' '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'imu'#39
      '      AND column_name = '#39'imuanp'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "imu"'
      '--'
      'ALTER TABLE imu'
      '  ADD COLUMN imuanp varchar(10) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Left = 816
    Top = 144
  end
  object us001234: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcomprovante'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmterminalcomprovante VARCHAR(50000) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 704
    Top = 136
  end
  object us001233: TUniScript
    SQL.Strings = (
      'drop table if exists rct//'
      ''
      'CREATE TABLE IF NOT EXISTS rct ('
      '  rctchave int(11) NOT NULL AUTO_INCREMENT,'
      '  rctvalor float(9, 3) NOT NULL DEFAULT 0.000 ,'
      '  rctnrauto varchar(100) DEFAULT '#39#39','
      '  adccodigo int(11) NOT NULL,'
      '  rctparcelas int(3) NOT NULL DEFAULT 1 ,'
      '  bdccodigo int(11) DEFAULT NULL,'
      '  rctcomprovante1via varchar(1000) DEFAULT '#39#39','
      '  rctcomprovante2via varchar(1000) DEFAULT '#39#39','
      '  rcthora time,'
      '  orcchave int(11) DEFAULT 0,'
      '  rctstatus varchar(50) DEFAULT '#39#39','
      '  PRIMARY KEY (rctchave)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci'
      
        'COMMENT = '#39'Registro temporario dos detalhes da opera'#231'ao com cart' +
        #227'o'#39
      'ROW_FORMAT = DYNAMIC//')
    Delimiter = '//'
    Left = 640
    Top = 136
  end
  object us001232: TUniScript
    SQL.Strings = (
      
        'ALTER TABLE bdc CHANGE COLUMN bdccodigo bdccodigo INT(11) NOT NU' +
        'LL//'
      ''
      'DELETE from bdc//'
      ''
      'INSERT into bdc VALUES ('#39'01'#39','#9#39'VISA'#39')//'
      'INSERT into bdc VALUES ('#39'02'#39','#9#39'MASTERCARD'#39')//'
      'INSERT into bdc VALUES ('#39'03'#39','#9#39'AMERICAN'#39')//'
      'INSERT into bdc VALUES ('#39'04'#39','#9#39'SOROCRED'#39')//'
      'INSERT into bdc VALUES ('#39'05'#39','#9#39'DINERS'#39')//'
      'INSERT into bdc VALUES ('#39'06'#39','#9#39'ELO'#39')//'
      'INSERT into bdc VALUES ('#39'07'#39','#9#39'HIPERCARD'#39')//'
      'INSERT into bdc VALUES ('#39'08'#39','#9#39'AURA'#39')//'
      'INSERT into bdc VALUES ('#39'09'#39','#9#39'CABAL'#39')//'
      'INSERT into bdc VALUES ('#39'10'#39','#9#39'ALELO'#39')//'
      'INSERT into bdc VALUES ('#39'11'#39','#9#39'BANES'#39')//'
      'INSERT into bdc VALUES ('#39'12'#39','#9#39'CALCARD'#39')//'
      'INSERT into bdc VALUES ('#39'13'#39','#9#39'CREDZ'#39')//'
      'INSERT into bdc VALUES ('#39'14'#39','#9#39'DISCOVER'#39')//'
      'INSERT into bdc VALUES ('#39'15'#39','#9#39'GOODCARD'#39')//'
      'INSERT into bdc VALUES ('#39'16'#39','#9#39'GREENCARD'#39')//'
      'INSERT into bdc VALUES ('#39'17'#39','#9#39'HIPER'#39')//'
      'INSERT into bdc VALUES ('#39'18'#39','#9#39'JCB'#39')//'
      'INSERT into bdc VALUES ('#39'19'#39','#9#39'MAIS'#39')//'
      'INSERT into bdc VALUES ('#39'20'#39','#9#39'MAXVAN'#39')//'
      'INSERT into bdc VALUES ('#39'21'#39','#9#39'POLICARD'#39')//'
      'INSERT into bdc VALUES ('#39'22'#39','#9#39'REDECOMPRAS'#39')//'
      'INSERT into bdc VALUES ('#39'23'#39','#9#39'SODEXO'#39')//'
      'INSERT into bdc VALUES ('#39'24'#39','#9#39'VALECARD'#39')//'
      'INSERT into bdc VALUES ('#39'25'#39','#9#39'VEROCHEQUE'#39')//'
      'INSERT into bdc VALUES ('#39'26'#39','#9#39'VR'#39')//'
      'INSERT into bdc VALUES ('#39'27'#39','#9#39'TICKET'#39')//'
      'INSERT into bdc VALUES ('#39'99'#39','#9#39'OUTROS'#39')//')
    Delimiter = '//'
    Left = 584
    Top = 136
  end
  object us001231: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmestabelecimentotipotef'#39') THEN'
      ''
      'ALTER TABLE trm'
      
        '  ADD COLUMN trmestabelecimentotipotef VARCHAR(255) DEFAULT NULL' +
        ';'
      ''
      'end if; '
      ''
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcodempresa'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmterminalcodempresa VARCHAR(255) DEFAULT NULL;'
      ''
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcodfilial'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmterminalcodfilial VARCHAR(255) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcodterminal'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmterminalcodterminal VARCHAR(255) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalenderecoservidor'#39') THEN'
      ''
      'ALTER TABLE trm'
      
        '  ADD COLUMN trmterminalenderecoservidor VARCHAR(255) DEFAULT NU' +
        'LL;'
      ''
      'end if; '
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalportapinpad'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmterminalportapinpad VARCHAR(255) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 512
    Top = 136
  end
  object us001243: TUniScript
    SQL.Strings = (
      ''
      'DROP TABLE IF EXISTS tfv//'
      ''
      'CREATE TABLE tfv ('
      '  tfvchave int(11) DEFAULT NULL,'
      '  tfvregistro datetime DEFAULT NULL,'
      '  clbcodigo int(11) DEFAULT NULL,'
      '  orcchave int(11) DEFAULT NULL,'
      '  mdacodigoorigem int(11) DEFAULT NULL,'
      '  mdacodigodestino int(11) DEFAULT NULL'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci//')
    Delimiter = '//'
    Left = 872
    Top = 224
  end
  object us001244: TUniScript
    SQL.Strings = (
      ''
      ''
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      oricodigo,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmacrescimoav'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmoutras)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        itoacrescimoav,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        ito.itovalorav,'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      ''
      
        '        (ito.itototalav - itoacrescimoav) * (@totalservicos / @t' +
        'otalgeral)'
      ''
      ''
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END //'
      '')
    Delimiter = '//'
    Left = 928
    Top = 224
  end
  object us001245: TUniScript
    SQL.Strings = (
      ''
      ''
      ''
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      '  /* daniel 03/07/2024 19:15 */'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      oricodigo,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmacrescimoav'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmoutras)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        itoacrescimoav,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        ito.itovalorav,'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      ''
      
        '        (ito.itovalorav * itoquantidade) * (@totalservicos / @to' +
        'talgeral)'
      ''
      ''
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END //')
    Delimiter = '//'
    Left = 520
    Top = 280
  end
  object us001246: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS FechaMesa//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesa (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = pOrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 13;'
      ''
      ''
      ''
      '    INSERT INTO olt (oltchave'
      '    , orcchave'
      '    , ltechave'
      '    , oltidentificacao'
      '    , olttipo)'
      
        '      VALUE (@novachave, pOrcChave, @ltechave, pNome, pTipoFecha' +
        'mento);'
      ''
      ''
      ''
      ''
      '    SET @LteDesconto = IFNULL((SELECT'
      '        SUM(lte.ltedesconto)'
      '      FROM olt'
      '        INNER JOIN lte'
      '          ON olt.ltechave = lte.ltechave'
      '      WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '    SET @OrcTotalAv = (SELECT'
      '        SUM(itovalorav * itoquantidade) totav'
      '      FROM ito,'
      '           pro'
      '      WHERE ito.procodigo = pro.procodigo'
      '      AND ito.stocodigo <> 88'
      '      AND pro.tpocodigo = 0'
      '      AND orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    IF @LteDesconto > 0 THEN'
      ''
      ''
      '      SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '      UPDATE ito, pro'
      '      SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '          itosaldoav = (ito.itototalav - itodescontoav),'
      '          itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '          itosaldoap = (ito.itototalav - itodescontoav),'
      '          itopercdescap = ROUND(@percdesc, 3),'
      '          itopercdescav = ROUND(@percdesc, 3)'
      '      WHERE ito.stocodigo <> 88'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo = 0'
      '      AND ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '      SET @centavos = @LteDesconto - (SELECT'
      '          SUM(itodescontoav)'
      '        FROM ito,'
      '             pro'
      '        WHERE ito.orcchave = pOrcChave'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0);'
      ''
      ''
      ''
      ''
      '      IF @centavos <> 0 THEN'
      ''
      '        UPDATE ito, pro'
      '        SET itodescontoav = itodescontoav + @centavos,'
      '            itodescontoap = itodescontoap + @centavos,'
      '            itosaldoav = itosaldoav + @centavos,'
      '            itosaldoap = itosaldoap + @centavos'
      '        WHERE ito.stocodigo <> 88'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0'
      '        AND ito.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      
        '          orc.orcpercdescav = IF(tito.descap > 0, (tito.descap /' +
        ' tito.totap), 0),'
      '          orc.orctotalap = (tito.totap - tito.descap)'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      '    END IF;'
      ''
      ''
      '    SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '    CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pConfi' +
        'rma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 14;'
      ''
      ''
      ''
      '    SET @VlrFechamento = (SELECT'
      '        SUM(dtl.dtlvalor) dtlvalor'
      '      FROM dtl'
      '        INNER JOIN olt'
      '          ON dtl.ltechave = olt.ltechave'
      '      WHERE olt.orcchave = pOrcChave'
      '      AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '    IF @VlrFechamento > 0 THEN'
      ''
      ''
      '      SET @etdcodigo = (SELECT'
      '          etdcodigo'
      '        FROM orc'
      '        WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '      SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      OPEN curlote;'
      '    read_loop:'
      '      LOOP'
      ''
      '        FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '        IF done THEN'
      ''
      '          LEAVE read_loop;'
      '        END IF;'
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade'
      '          AND dtl.mdacodigo != 7);'
      ''
      '        DELETE'
      '          FROM trfi'
      '        WHERE mdacodigo <> modalidade;'
      ''
      '        INSERT INTO trfi (ID'
      '        , etdcodigo'
      '        , mdacodigo'
      '        , tfdcodigo'
      '        , numparc'
      '        , dtvecto'
      '        , vlrparcela'
      '        , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE' +
        '(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '        CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem, @' +
        'TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 17;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      END LOOP;'
      ''
      ''
      '      CLOSE curlote;'
      ''
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      '    INSERT INTO rfm (rfichave'
      '    , meschave)'
      ''
      '      (SELECT DISTINCT'
      ''
      '        rfichave,'
      '        @MesChave'
      '      FROM olt'
      '        INNER JOIN mlt'
      '          ON olt.ltechave = mlt.ltechave'
      '        INNER JOIN mfi'
      '          ON mlt.mfichave = mfi.mfichave'
      '      WHERE olt.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '        orc.orctotalav = (tito.totav - tito.descav),'
      ''
      ''
      ''
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        orc.orcdataencerr = CURRENT_DATE(),'
      '        orc.orchoraencerr = CURRENT_TIME(),'
      '        orc.stocodigo = 3'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '    UPDATE ito'
      '    SET ito.stocodigo = 3'
      '    WHERE ito.orcchave = pOrcChave'
      '    AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS FechaMesaParcial//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesaParcial (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT DISTINCT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      ''
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = @OrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      ''
      '  SET pConfirma = @Confirma;'
      ''
      ''
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      ''
      ''
      ''
      '  SET pLteChave = 0;'
      ''
      ''
      '  SET pMesChave = 0;'
      ''
      ''
      '  SET @meschave = 0;'
      ''
      ''
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      '    IF pTipo = 1 THEN'
      ''
      ''
      '      SET @qtdItem = (SELECT'
      '          COUNT(*)'
      '        FROM titem);'
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      ''
      '        SET @ContaItem = 1;'
      ''
      ''
      ''
      '        SET ErroMensagem = 1;'
      ''
      ''
      ''
      '        INSERT INTO orc (orcchave'
      '        , etdcodigo'
      '        , clbcodigo'
      '        , fopcodigo'
      '        , tdecodigo'
      '        , stocodigo'
      '        , moccodigo'
      '        , foacodigo'
      '        , trmcodigo'
      '        , tfpcodigo'
      '        , puocodigo'
      '        , orcdataabert'
      '        , orchoraabert'
      '        , orcgeralav'
      '        , orcdescontoav'
      '        , orcpercdescav'
      '        , orctotalav'
      '        , orcgeralap'
      '        , orcdescontoap'
      '        , orcpercdescap'
      '        , orctotalap'
      '        , orcobs'
      '        , orcdestimpre'
      '        , edritem'
      '        , edrcodigo'
      '        , clbvendedor'
      '        , orcmesa'
      '        , orctelefone'
      '        , ccxchave'
      '        , cznchave)'
      '          SELECT'
      '            @novachave,'
      '            etdcodigo,'
      '            pClbCodigo,'
      '            fopcodigo,'
      '            tdecodigo,'
      '            3,'
      '            moccodigo,'
      '            foacodigo,'
      '            trmcodigo,'
      '            tfpcodigo,'
      '            puocodigo,'
      '            orcdataabert,'
      '            TIME(NOW()),'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            orcobs,'
      '            orcdestimpre,'
      '            edritem,'
      '            edrcodigo,'
      '            pClbCodigo,'
      '            orcmesa,'
      '            orctelefone,'
      '            ccxchave,'
      '            cznchave'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '        IF (ROW_COUNT() > 0) THEN'
      ''
      '          SET @orcchave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      ''
      '          SET ErroMensagem = 2;'
      ''
      ''
      ''
      '          SET @troqtd = 0;'
      ''
      ''
      '          SET @troqtd = (SELECT DISTINCT'
      '              COUNT(orcchaveorigem)'
      '            FROM tro'
      '            WHERE orcchaveorigem = pOrcChave'
      '            AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '          IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '            SET @orcchaveinicial = IFNULL((SELECT'
      '                orcchaveorigem'
      '              FROM tro'
      '              WHERE orcchavedestino = pOrcChave'
      '              ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '            INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '              VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE ' +
        'KEY UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = ' +
        '@orcchave;'
      ''
      ''
      '          END IF;'
      ''
      ''
      ''
      ''
      ''
      '          SET @item = 0;'
      ''
      ''
      '          WHILE (@ContaItem <= @qtdItem) DO'
      ''
      '            SET @item = @item + 1;'
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 3;'
      ''
      ''
      ''
      ''
      '            SELECT'
      '              titem.itochave,'
      '              qtde'
      '            FROM titem'
      '            WHERE titem.ID = @ContaItem INTO @itochave'
      '            , @qtde;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 4;'
      ''
      ''
      ''
      ''
      '            INSERT INTO ito (itochave'
      '            , orcchave'
      '            , procodigo'
      '            , puncodigo'
      '            , unicodigo'
      '            , stocodigo'
      '            , tdecodigo'
      '            , itoquantidade'
      '            , itovalorav'
      '            , itototalav'
      '            , itodescontoav'
      '            , itosaldoav'
      '            , itovalorap'
      '            , itototalap'
      '            , itodescontoap'
      '            , itosaldoap'
      '            , itocontendo'
      '            , itoproservico'
      '            , itoprocomple'
      '            , itodataalter'
      '            , itoitem'
      '            , itogint'
      '            , itopercdescap'
      '            , itopercdescav'
      '            , itoinfadprod'
      '            , itoquanticondi'
      '            , itoquantidevolcondi'
      '            , vrpcodigo'
      '            , itoobs'
      '            , itoacrescimoav'
      '            , clbatendente'
      '            , oricodigo)'
      '              SELECT'
      '                @novoito,'
      '                @orcchave,'
      '                ito.procodigo,'
      '                puncodigo,'
      '                unicodigo,'
      '                3,'
      '                tdecodigo,'
      '                @qtde,'
      '                itovalorav,'
      '                (@qtde * (itovalorav + itoacrescimoav)),'
      
        '                ROUND(((itovalorav + itoacrescimoav) * @percdesc' +
        ') * @qtde, 2),'
      
        '                (((itovalorav + itoacrescimoav) * @qtde) - (ROUN' +
        'D(((itovalorav + itoacrescimoav) * @percdesc) * @qtde, 2))),'
      '                itovalorap,'
      '                (@qtde * itovalorap),'
      '                ROUND((itototalap * @percdesc), 2),'
      '                (itototalap - itodescontoap),'
      '                itocontendo,'
      '                itoproservico,'
      '                itoprocomple,'
      '                CURRENT_DATE(),'
      '                @item,'
      '                itogint,'
      '                ROUND(@percdesc, 3),'
      '                ROUND(@percdesc, 3),'
      '                itoinfadprod,'
      '                itoquanticondi,'
      '                itoquantidevolcondi,'
      '                vrpcodigo,'
      '                itoobs,'
      '                itoacrescimoav,'
      '                clbatendente,'
      '                6'
      '              FROM ito'
      '              WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      '            SET @immitochave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      ''
      ''
      ''
      '            INSERT INTO imm (immchave,'
      '            itochave,'
      '            tcicodigo,'
      '            immimpresso,'
      '            immentregue,'
      '            immmodo,'
      '            ccxchave,'
      '            immhorapedido,'
      '            immhoraentrega,'
      '            immrecebido,'
      '            dorchave,'
      '            immnumepedido,'
      '            trmcodigo,'
      '            immdestino,'
      '            immidentificacao,'
      '            immgarsom,'
      '            immtemporetardo,'
      '            immmodoimpressao,'
      '            cznchave,'
      '            etdcodigoent,'
      '            immpratos,'
      '            immcopos,'
      '            immnumepedidoint,'
      '            clbcodigo,'
      '            immhoraimpresso,'
      '            immhoraimprimir,'
      '            immhoraentregadopedido,'
      '            immhoranotificadopedido,'
      '            immhorasaidadopedido)'
      '              SELECT'
      '                @novaimmchave,'
      '                @immitochave,'
      '                tcicodigo,'
      '                immimpresso,'
      '                immentregue,'
      '                immmodo,'
      '                ccxchave,'
      '                immhorapedido,'
      '                immhoraentrega,'
      '                immrecebido,'
      '                dorchave,'
      '                immnumepedido,'
      '                trmcodigo,'
      '                immdestino,'
      '                immidentificacao,'
      '                immgarsom,'
      '                immtemporetardo,'
      '                immmodoimpressao,'
      '                cznchave,'
      '                etdcodigoent,'
      '                immpratos,'
      '                immcopos,'
      '                immnumepedidoint,'
      '                clbcodigo,'
      '                immhoraimpresso,'
      '                immhoraimprimir,'
      '                immhoraentregadopedido,'
      '                immhoranotificadopedido,'
      '                immhorasaidadopedido'
      '              FROM imm'
      '              WHERE itochave = @itochave;'
      ''
      '            UPDATE imp'
      '            SET itochave = @immitochave'
      '            WHERE imp.itochave = @itochave;'
      ''
      ''
      ''
      '            SELECT'
      '              COUNT(itochave)'
      '            FROM sbi'
      '            WHERE sbi.itochave = @itochave INTO @qtdItemSbi;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItemsbi = 1;'
      ''
      ''
      ''
      '            WHILE (@ContaItemsbi <= @qtdItemSbi) DO'
      ''
      ''
      '              INSERT INTO sbi'
      '                (SELECT'
      '                  @outrachave,'
      '                  @immitochave,'
      '                  sbrcodigo,'
      '                  sbiobs,'
      '                  sbiitem,'
      '                  bprchave'
      '                FROM sbi'
      '                WHERE itochave = @itochave'
      '                AND sbi.sbiitem = @ContaItemsbi);'
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @ultimosbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      '              END IF;'
      ''
      ''
      ''
      ''
      '              SELECT'
      '                COUNT(itochave)'
      '              FROM isi'
      '              WHERE itochave = @itochave'
      '              AND isiitem = @ContaItemsbi INTO @qtdItemisi;'
      ''
      ''
      ''
      ''
      '              IF @qtdItemisi > 0 THEN'
      ''
      ''
      '                INSERT INTO isi'
      '                  (SELECT'
      '                    @novaisichave,'
      '                    @ultimosbichave,'
      '                    tsicodigo,'
      '                    procodigo,'
      '                    isitipo,'
      '                    @immitochave,'
      '                    isiitem,'
      '                    isiquantidade,'
      '                    0'
      '                  FROM isi'
      '                  WHERE itochave = @itochave'
      '                  AND isiitem = @ContaItemsbi);'
      ''
      '              END IF;'
      ''
      ''
      ''
      '              SET @ContaItemsbi = @ContaItemsbi + 1;'
      ''
      ''
      '            END WHILE;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 5;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            UPDATE ito'
      '            SET ito.itoquantidade = (ito.itoquantidade - @qtde),'
      
        '                ito.itototalav = (ito.itoquantidade * ito.itoval' +
        'orav),'
      
        '                ito.itosaldoav = (ito.itototalav - itodescontoav' +
        '),'
      
        '                ito.itototalap = (ito.itoquantidade * ito.itoval' +
        'orap),'
      '                ito.itosaldoap = (itototalap - itodescontoap)'
      '            WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItem = @ContaItem + 1;'
      ''
      ''
      '          END WHILE;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 6;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      '              orc.orcdescontoav = tito.descav,'
      
        '              orc.orcpercdescav = IF(tito.descav > 0, (tito.desc' +
        'av / tito.totav), 0),'
      '              orc.orctotalav = (tito.totav - tito.descav),'
      '              orc.orcgeralap = tito.totap,'
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = @orcchave;'
      ''
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '              orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      '        SET ErroMensagem = 8;'
      ''
      ''
      
        '        CALL RegistraMes(@orcchave, pClbCodigo, ErroMensagem, pC' +
        'onfirma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 10;'
      ''
      ''
      ''
      ''
      '        SET @troqtd = 0;'
      ''
      ''
      '        SET @troqtd = (SELECT DISTINCT'
      '            COUNT(orcchaveorigem)'
      '          FROM tro'
      '          WHERE orcchaveorigem = pOrcChave'
      '          AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '        IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '          SET @orcchaveinicial = IFNULL((SELECT'
      '              orcchaveorigem'
      '            FROM tro'
      '            WHERE orcchavedestino = pOrcChave'
      '            ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '          INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '            VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE KE' +
        'Y UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = @o' +
        'rcchave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 11;'
      ''
      ''
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, @OrcChave, @ltechave, pNome, 1);'
      '      ELSE'
      ''
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, pOrcChave, @ltechave, pNome, 0);'
      '      END IF;'
      ''
      ''
      ''
      '      IF (@qtdItem > 0)'
      '        AND (@orcchave > 0) THEN'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = @orcchave'
      '          AND dtl.mdacodigo != 7);'
      ''
      ''
      '        IF @VlrFechamento > 0 THEN'
      ''
      ''
      '          SET @etdcodigo = (SELECT'
      '              etdcodigo'
      '            FROM orc'
      '            WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      '          SET ErroMensagem = 15;'
      ''
      ''
      '          OPEN curlote;'
      '        read_loop:'
      '          LOOP'
      ''
      '            FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '            IF done THEN'
      ''
      '              LEAVE read_loop;'
      '            END IF;'
      ''
      ''
      '            SET @VlrFechamento = (SELECT'
      '                SUM(dtl.dtlvalor) dtlvalor'
      '              FROM dtl'
      '                INNER JOIN olt'
      '                  ON dtl.ltechave = olt.ltechave'
      '              WHERE olt.orcchave = @orcchave'
      '              AND dtl.ltechave = lote'
      '              AND dtl.mdacodigo = modalidade'
      '              AND dtl.mdacodigo != 7);'
      ''
      '            DELETE'
      '              FROM trfi'
      '            WHERE mdacodigo <> modalidade;'
      ''
      '            INSERT INTO trfi (ID'
      '            , etdcodigo'
      '            , mdacodigo'
      '            , tfdcodigo'
      '            , numparc'
      '            , dtvecto'
      '            , vlrparcela'
      '            , numero)'
      
        '              VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_' +
        'DATE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '            SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '            CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, ErroMe' +
        'nsagem, @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 9;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          END LOOP;'
      ''
      ''
      '          CLOSE curlote;'
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      ''
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            @MesChave'
      '          FROM olt'
      '            INNER JOIN mlt'
      '              ON olt.ltechave = mlt.ltechave'
      '            INNER JOIN mfi'
      '              ON mlt.mfichave = mfi.mfichave'
      '          WHERE olt.orcchave = @OrcChave);'
      ''
      '      END IF;'
      ''
      ''
      ''
      '    ELSE'
      ''
      ''
      '      SET ErroMensagem = 13;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      INSERT INTO olt (oltchave'
      '      , orcchave'
      '      , ltechave'
      '      , oltidentificacao'
      '      , olttipo)'
      
        '        VALUE (@novachave, @orcchave, @ltechave, pNome, pTipoFec' +
        'hamento);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET @LteDesconto = IFNULL((SELECT'
      '          SUM(lte.ltedesconto)'
      '        FROM olt'
      '          INNER JOIN lte'
      '            ON olt.ltechave = lte.ltechave'
      '        WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '      SET @OrcTotalAv = (SELECT'
      '          SUM(itovalorav * itoquantidade) totav'
      '        FROM ito'
      '        WHERE orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '      IF @LteDesconto > 0 THEN'
      ''
      ''
      '        SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '        UPDATE ito'
      '        SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '            itosaldoav = (ito.itototalav - itodescontoav),'
      '            itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '            itosaldoap = (ito.itototalav - itodescontoav),'
      '            itopercdescap = ROUND(@percdesc, 3),'
      '            itopercdescav = ROUND(@percdesc, 3)'
      '        WHERE ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '        SET @centavos = @LteDesconto - (SELECT'
      '            SUM(itodescontoav)'
      '          FROM ito'
      '          WHERE ito.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '        IF @centavos <> 0 THEN'
      ''
      '          UPDATE ito'
      '          SET itodescontoav = itodescontoav + @centavos,'
      '              itodescontoap = itodescontoap + @centavos,'
      '              itosaldoav = itosaldoav + @centavos,'
      '              itosaldoap = itosaldoap + @centavos'
      '          WHERE ito.orcchave = pOrcChave;'
      ''
      '        END IF;'
      ''
      ''
      ''
      '        UPDATE orc'
      '        INNER JOIN (SELECT'
      '            ito.orcchave,'
      '            SUM(itototalav) totav,'
      '            SUM(itodescontoav) descav,'
      '            SUM(itototalap) totap,'
      '            SUM(itodescontoap) descap'
      '          FROM ito'
      '          WHERE stocodigo != 88'
      '          GROUP BY ito.orcchave) tito'
      '          ON tito.orcchave = orc.orcchave'
      '        SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '            orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '            orc.orcdescontoav = tito.descap,'
      
        '            orc.orcpercdescav = IF(tito.descap > 0, (tito.descap' +
        ' / tito.totap), 0),'
      '            orc.orctotalap = (tito.totap - tito.descap)'
      '        WHERE orc.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '      CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pCon' +
        'firma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET ErroMensagem = 14;'
      ''
      ''
      ''
      '      SET @VlrFechamento = (SELECT'
      '          SUM(dtl.dtlvalor) dtlvalor'
      '        FROM dtl'
      '          INNER JOIN olt'
      '            ON dtl.ltechave = olt.ltechave'
      '        WHERE olt.orcchave = pOrcChave'
      '        AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '      IF @VlrFechamento > 0 THEN'
      ''
      ''
      '        SET @etdcodigo = (SELECT'
      '            etdcodigo'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        OPEN curlote;'
      '      read_loop:'
      '        LOOP'
      ''
      '          FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '          IF done THEN'
      ''
      '            LEAVE read_loop;'
      '          END IF;'
      ''
      '          SET @VlrFechamento = (SELECT'
      '              SUM(dtl.dtlvalor) dtlvalor'
      '            FROM dtl'
      '              INNER JOIN olt'
      '                ON dtl.ltechave = olt.ltechave'
      '            WHERE olt.orcchave = pOrcChave'
      '            AND dtl.ltechave = lote'
      '            AND dtl.mdacodigo = modalidade'
      '            AND dtl.mdacodigo != 7);'
      ''
      ''
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '            VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DA' +
        'TE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '          SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '          CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem,' +
        ' @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 17;'
      ''
      ''
      ''
      '          INSERT INTO rfm (rfmchave'
      '          , rfichave'
      '          , meschave)'
      ''
      '            (SELECT DISTINCT'
      '              @novachave,'
      '              rfichave,'
      '              @MesChave'
      '            FROM olt'
      '              INNER JOIN mlt'
      '                ON olt.ltechave = mlt.ltechave'
      '              INNER JOIN mfi'
      '                ON mlt.mfichave = mfi.mfichave'
      '            WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '        END LOOP;'
      ''
      ''
      '        CLOSE curlote;'
      ''
      '      END IF;'
      ''
      ''
      '      INSERT INTO rfm (rfmchave'
      '      , rfichave'
      '      , meschave)'
      ''
      '        (SELECT DISTINCT'
      '          @novachave,'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '      SET ErroMensagem = 18;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      '          orc.orcpercdescav = @percdesc,'
      '          orc.orctotalap = (tito.totap - tito.descap),'
      '          orc.orcdataencerr = CURRENT_DATE(),'
      '          orc.orchoraencerr = CURRENT_TIME(),'
      '          orc.stocodigo = 3'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.stocodigo = 3'
      '      WHERE ito.orcchave = pOrcChave'
      '      AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '    END IF;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS MobGravaItens//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      
        'PROCEDURE MobGravaItens (IN pOrcChave int, IN pClbCodigo int, IN' +
        ' pFlaCodigo int, IN pTipoItem int, OUT pConfirma int, OUT pMensa' +
        'gem varchar(65000))'
      'BEGIN'
      ''
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      '  DECLARE vimmmodo integer DEFAULT 1;'
      '  DECLARE vcfgmgoupedidounificado integer DEFAULT 0;'
      '  DECLARE itemisi integer DEFAULT 0;'
      '  DECLARE itemsbi integer DEFAULT 0;'
      ''
      ''
      ''
      '  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION BEGIN'
      '    SET ErroException = 1;'
      '    SET pConfirma = ErroException;'
      ''
      '    ROLLBACK;'
      ''
      '    SET pMensagem = (SELECT'
      
        '        CASE WHEN ErroMensagem = 1 THEN '#39'1 - Erro nao identifica' +
        'do.'#39' WHEN ErroMensagem = 2 THEN '#39'2 - Nao foi possivel verificar ' +
        'se existe itens da mesa.'#39' WHEN ErroMensagem = 3 THEN '#39'3 - Nao fo' +
        'i possivel gravar itens da mesa.'#39' WHEN ErroMensagem = 4 THEN '#39'4 ' +
        '- Nao foi possivel gerar pedido na cozinha.'#39' WHEN ErroMensagem =' +
        ' 5 THEN '#39'5 - Nao foi possivel gravar itens, cozinha ja encerrou ' +
        'as atividades.'#39' WHEN ErroMensagem = 6 THEN '#39'6 - Nao foi possivel' +
        ' registrar dados auxiliares dos itens.'#39' WHEN ErroMensagem = 7 TH' +
        'EN '#39'7 - Nao foi possivel registrar mudancas de ingredientes.'#39' WH' +
        'EN ErroMensagem = 8 THEN '#39'8 - Nao foi possivel liberar pedido pa' +
        'ra impressao.'#39' ELSE '#39'Erro inesperado.'#39' END'
      '      FROM dual);'
      '  END;'
      ''
      '  DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '    ID int NOT NULL AUTO_INCREMENT,'
      '    sbrcodigo int,'
      '    sbiobs varchar(100),'
      '    bprchave int,'
      '    sbiitem int,'
      '    PRIMARY KEY (ID)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  START TRANSACTION;'
      ''
      '    SET @vcfgmgoupedidounificado = (SELECT'
      '        cfgmgoupedidounificado'
      '      FROM cfgmgou LIMIT 1);'
      ''
      '    IF @vcfgmgoupedidounificado = 1 THEN'
      '      SET @vimmmodo = 9;'
      '    END IF;'
      ''
      '    IF @vcfgmgoupedidounificado = 0 THEN'
      '      SET @vimmmodo = 1;'
      '    END IF;'
      ''
      '    SET @stocodigo = (SELECT'
      '        stocodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    IF @stocodigo IN (1, 2) THEN'
      '      UPDATE orc'
      '      SET stocodigo = 1'
      '      WHERE orcchave = pOrcChave;'
      '    END IF;'
      ''
      '    SET ErroMensagem = 2;'
      ''
      '    SET @item = IFNULL((SELECT'
      '        MAX(itoitem)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChave), 0);'
      '    SET @qtd = (SELECT'
      '        COUNT(*)'
      '      FROM tito);'
      ''
      '    SET ErroMensagem = 4;'
      ''
      '    SET @MocCodigo = (SELECT'
      '        orc.moccodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    SET @clbcodigo = (SELECT'
      '        clbcodigo'
      '      FROM tito LIMIT 1);'
      ''
      '    IF @MocCodigo = 5 THEN'
      ''
      '      SET @cznchave = (SELECT'
      '          cznchave'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL LIMIT 1);'
      ''
      '      SET @immnumepedido = (SELECT'
      '          (IFNULL(MAX(imm.immnumepedido), 0) + 1) immnumepedido'
      '        FROM imm'
      '        WHERE imm.cznchave = @cznchave'
      '        AND imm.immmodo = 1);'
      ''
      '      IF @immnumepedido < IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000) THEN'
      '        SET @immnumepedido = IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000);'
      '      END IF;'
      ''
      '    END IF;'
      ''
      '    SET @posicao = 1;'
      ''
      '    SET @itemisi = 0;'
      '    SET @itemisi1 = 0;'
      ''
      '    SET @valortotaladicionais = 0;'
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      '      SET @valortotaladicionais = 0;'
      ''
      '      SET ErroMensagem = 3;'
      ''
      '      SET @item = (@item + 1);'
      '      SET @itemisi = (@itemisi + 1);'
      ''
      '      INSERT INTO ito (itochave'
      '      , orcchave'
      '      , procodigo'
      '      , puncodigo'
      '      , unicodigo'
      '      , stocodigo'
      '      , tdecodigo'
      '      , itoquantidade'
      '      , itovalorav'
      '      , itodescontoav'
      '      , itototalav'
      '      , itosaldoav'
      '      , itovalorap'
      '      , itodescontoap'
      '      , itototalap'
      '      , itosaldoap'
      '      , itocontendo'
      '      , itoproservico'
      '      , itoprocomple'
      '      , itodataalter'
      '      , itoitem'
      '      , itogint'
      '      , itopercdescap'
      '      , itopercdescav'
      '      , itoinfadprod'
      '      , itoquanticondi'
      '      , itoquantidevolcondi'
      '      , vrpcodigo'
      '      , itoobs'
      '      , flacodigo'
      '      , clbatendente'
      '      , oricodigo)'
      ''
      '        (SELECT'
      '          @novachave,'
      '          pOrcChave,'
      '          tito.procodigo,'
      '          tito.puncodigo,'
      '          uni.unicodigo,'
      '          2,'
      '          1,'
      '          tito.qtde,'
      '          pun.punprecoav,'
      '          0,'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          pun.punprecoap,'
      '          0,'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          pun.punmultiplicador,'
      '          '#39#39','
      '          '#39#39','
      '          CURRENT_DATE(),'
      '          @item,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          NULL,'
      '          tito.obs,'
      '          pFlaCodigo,'
      '          clbcodigo,'
      '          1'
      '        FROM tito'
      '          INNER JOIN pun'
      '            ON tito.puncodigo = pun.puncodigo'
      '          INNER JOIN uni'
      '            ON pun.unicodigo = uni.unicodigo'
      '        WHERE tito.ID = @posicao);'
      ''
      ''
      ''
      ''
      ''
      '      IF (SELECT'
      '            ROW_COUNT()) > 0 THEN'
      '        SET @itochave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      '        SELECT'
      '          procodigo,'
      '          obs,'
      '          sfnid,'
      '          sfncodigo,'
      '          copos,'
      '          pratos'
      '        FROM tito'
      '        WHERE tito.ID = @posicao INTO @procodigo'
      '        , @obs'
      '        , @sfnid'
      '        , @sfncodigo'
      '        , @copos'
      '        , @pratos;'
      ''
      ''
      ''
      ''
      '        IF @MocCodigo = 5 THEN'
      '          SET ErroMensagem = 6;'
      ''
      ''
      '          SELECT'
      '            gri.griminuretardo,'
      '            gri.tcicodigo'
      '          FROM gri'
      '            INNER JOIN pro'
      '              ON pro.grpcodigo = gri.grpcodigo'
      '            INNER JOIN ito'
      '              ON pro.procodigo = ito.procodigo'
      '          WHERE ito.itochave = @itochave INTO @griminuretardo'
      '          , @tcicodigo;'
      ''
      ''
      '          INSERT INTO imm (itochave'
      '          , tcicodigo'
      '          , immmodo'
      '          , cznchave'
      '          , immtemporetardo'
      '          , immnumepedido'
      '          , immhorapedido'
      '          , trmcodigo'
      '          , immdestino'
      '          , immcopos'
      '          , immpratos'
      '          , clbcodigo)'
      
        '            VALUES (@itochave, @tcicodigo, @vimmmodo, @cznchave,' +
        ' @griminuretardo, @immnumepedido, NOW(), 1, 1, @copos, @pratos, ' +
        'pClbCodigo);'
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      '          IF @sfncodigo > 0 THEN'
      ''
      '            SELECT'
      '              COUNT(brdcodigo)'
      ''
      '            FROM tbrd'
      '            WHERE tbrd.sfnid = @sfnid'
      '            AND tbrd.sfncodigo = @sfncodigo INTO @qtdbordas;'
      ''
      '            IF @qtdbordas > 0 THEN'
      '              INSERT INTO bri (brichave'
      '              , itochave'
      '              , brdcodigo'
      '              , briincluir)'
      '                (SELECT'
      '                  0,'
      '                  @itochave,'
      '                  brdcodigo,'
      '                  1'
      '                FROM tbrd'
      '                WHERE tbrd.sfnid = @sfnid'
      '                AND tbrd.sfncodigo = @sfncodigo);'
      ''
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      ''
      '                SET @vlborda = (SELECT'
      '                    pun.punprecoav punprecoav'
      '                  FROM bri'
      '                    INNER JOIN ito'
      '                      ON bri.itochave = ito.itochave'
      '                    INNER JOIN brd'
      '                      ON bri.brdcodigo = brd.brdcodigo'
      '                    INNER JOIN pro'
      '                      ON brd.procodigo = pro.procodigo'
      '                    INNER JOIN pun'
      '                      ON pro.procodigo = pun.procodigo'
      '                      AND ito.unicodigo = pun.unicodigo'
      '                  WHERE bri.itochave = @itochave LIMIT 1);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '                IF @vlborda > 0 THEN'
      '                  UPDATE ito'
      
        '                  SET ito.itovalorav = (ito.itovalorav + @vlbord' +
        'a),'
      
        '                      ito.itovalorap = (ito.itovalorap + @vlbord' +
        'a),'
      
        '                      ito.itototalav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itototalap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itosaldoav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2) - ito.itodescontoav,'
      
        '                      ito.itosaldoap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2) - ito.itodescontoav'
      ''
      '                  WHERE ito.itochave = @itochave;'
      '                END IF;'
      '              END IF;'
      ''
      ''
      '            END IF;'
      ''
      '            DELETE'
      '              FROM tsbi;'
      ''
      '            SET @novasbiid = 0;'
      ''
      ''
      ''
      ''
      ''
      ''
      '            DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '            CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '              ID int NOT NULL AUTO_INCREMENT,'
      '              sbrcodigo int,'
      '              sbiobs varchar(100),'
      '              bprchave int,'
      '              sbiitem int,'
      '              PRIMARY KEY (ID)'
      '            ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      ''
      ''
      '            INSERT INTO tsbi'
      '              (SELECT'
      '                @chavenova,'
      '                tisi.sbrcodigo,'
      '                tisi.obs,'
      '                tisi.bprchave,'
      '                tisi.isiitem'
      ''
      '              FROM tisi'
      '              WHERE tisi.isiitem = @posicao'
      ''
      '              AND tisi.isitipo = 2);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @possbi = 1;'
      ''
      ''
      ''
      ''
      '            SET @posqtd = (SELECT'
      '                COUNT(*)'
      '              FROM tsbi);'
      ''
      ''
      '            IF @posqtd > 0 THEN'
      '              SET itemsbi = itemsbi + 1;'
      '            END IF;'
      ''
      ''
      ''
      ''
      '            WHILE (@possbi <= @posqtd) DO'
      ''
      '              SET @itemisi1 = @itemisi1 + 1;'
      ''
      '              INSERT INTO sbi (sbichave'
      '              , itochave'
      '              , sbrcodigo'
      '              , sbiobs'
      '              , bprchave'
      '              , sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  tsbi.sbrcodigo,'
      '                  tsbi.sbiobs,'
      '                  tsbi.bprchave,'
      '                  tsbi.sbiitem'
      '                FROM tsbi'
      '                WHERE tsbi.sbiitem = @sfnid'
      '                AND tsbi.ID = @possbi);'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      ''
      ''
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      ''
      '                SET @sbrcodigo = (SELECT'
      '                    sbrcodigo'
      '                  FROM sbi'
      '                  WHERE sbichave = @sbichave);'
      ''
      ''
      ''
      '                INSERT INTO isi (isichave'
      '                , sbichave'
      '                , tsicodigo'
      '                , procodigo'
      '                , itochave'
      '                , isiitem'
      '                , isitipo'
      '                , isiquantidade)'
      '                  (SELECT'
      '                    @novachave,'
      '                    @sbichave,'
      '                    tisi.tsicodigo,'
      '                    tisi.procodigo,'
      '                    @itochave,'
      '                    @possbi,'
      '                    tisi.isitipo,'
      '                    tisi.isiquantidade'
      '                  FROM tisi'
      '                  WHERE tisi.sfnid = @sfnid'
      '                  AND tisi.sfncodigo = @sfncodigo'
      '                  AND tisi.sbrcodigo = @sbrcodigo'
      '                  AND (tisi.isitipo != 2)'
      '                  AND tisi.isiitem = @posicao);'
      ''
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      ''
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      ''
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      ''
      ''
      ''
      ''
      '                END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '              END IF;'
      '              SET @possbi = (@possbi + 1);'
      '            END WHILE;'
      ''
      '            DELETE'
      '              FROM isi'
      '            WHERE itochave = @itochave'
      '              AND (isitipo = 0'
      '              AND tsicodigo = 3);'
      ''
      '            IF (@valortotaladicionais IS NOT NULL) THEN'
      '              UPDATE ito'
      '              SET itooutras = @valortotaladicionais'
      '              WHERE itochave = @itochave;'
      '            END IF;'
      ''
      ''
      ''
      ''
      ''
      '            DELETE'
      '              FROM isi'
      '            WHERE itochave = @itochave'
      '              AND (isitipo = 0'
      '              AND tsicodigo = 3);'
      ''
      ''
      ''
      '          ELSE'
      ''
      '            IF (SELECT'
      '                  COUNT(*)'
      '                FROM tisi) = 0 THEN'
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  sbr.sbrcodigo,'
      '                  @obs,'
      '                  1'
      '                FROM sbr'
      '                WHERE sbr.procodigo = @procodigo LIMIT 1);'
      '            ELSE'
      ''
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.bprchave'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novachave,'
      '                  @itochave,'
      '                  tisi.sbrcodigo,'
      
        '                  IF(IFNULL(tisi.obs, '#39#39') != '#39#39', tisi.obs, @obs)' +
        ','
      '                  tisi.bprchave,'
      '                  tisi.isiitem'
      '                FROM tisi'
      '                  INNER JOIN sbr'
      '                    ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                WHERE tisi.isiitem = @itemisi'
      '                AND sbr.procodigo = @procodigo LIMIT 1);'
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      '                IF pTipoItem = 1 THEN'
      '                  INSERT INTO isi (isichave'
      '                  , sbichave'
      '                  , tsicodigo'
      '                  , procodigo'
      '                  , itochave'
      '                  , isiitem'
      '                  , isitipo'
      '                  , isiquantidade)'
      '                    (SELECT DISTINCT'
      '                      @novachave,'
      '                      @sbichave,'
      '                      tisi.tsicodigo,'
      '                      tisi.procodigo,'
      '                      @itochave,'
      '                      @itemisi,'
      '                      tisi.isitipo,'
      '                      tisi.isiquantidade'
      '                    FROM tisi'
      '                      INNER JOIN sbr'
      '                        ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                    WHERE sbr.procodigo = @procodigo'
      '                    AND tisi.isiitem = @itemisi);'
      '                END IF;'
      ''
      ''
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      ''
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      ''
      ''
      ''
      '                END IF;'
      '              END IF;'
      ''
      '              IF (@valortotaladicionais IS NOT NULL) THEN'
      '                UPDATE ito'
      '                SET itooutras = @valortotaladicionais'
      '                WHERE itochave = @itochave;'
      '              END IF;'
      ''
      ''
      '            END IF;'
      ''
      '          END IF;'
      '        END IF;'
      ''
      '      END IF;'
      ''
      '      DELETE'
      '        FROM isi'
      '      WHERE itochave = @itochave'
      '        AND (isitipo = 0'
      '        AND tsicodigo = 3);'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.itovalorav = (ito.itovalorav),'
      '          ito.itovalorap = (ito.itovalorap),'
      
        '          ito.itototalav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade) + (itooutras * ito.itoquantidade), 2),'
      
        '          ito.itototalap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade) + (itooutras * ito.itoquantidade), 2),'
      
        '          ito.itosaldoav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav,'
      
        '          ito.itosaldoap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav'
      '      WHERE ito.itochave = @itochave;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      ''
      ''
      ''
      '    END WHILE;'
      ''
      '    SET ErroMensagem = 8;'
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(ito.itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(ito.itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      '        orc.orcdescontoav = tito.descav,'
      '        orc.orcpercdescav = 0,'
      '        orc.orctotalav = (tito.totav - tito.descav),'
      '        orc.orcgeralap = tito.totap,'
      '        orc.orcdescontoap = tito.descap,'
      '        orc.orcpercdescap = 0,'
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        stocodigo = @stocodigo'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '    IF NOT ErroException THEN'
      ''
      '      DELETE'
      '        FROM tito;'
      '      DELETE'
      '        FROM tbrd;'
      ''
      '      DELETE'
      '        FROM tisi;'
      ''
      ''
      '      DELETE'
      '        FROM tsbi;'
      ''
      '    COMMIT;'
      ''
      '    SET pConfirma = ErroException;'
      '    SET pMensagem = '#39'Pedido gravado com sucesso !'#39';'
      '  END IF;'
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS MobGravaItensGourmet//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      
        'PROCEDURE MobGravaItensGourmet (IN pOrcChave int, IN pClbCodigo ' +
        'int, IN pFlaCodigo int, IN pTipoItem int, OUT pConfirma int, OUT' +
        ' pMensagem varchar(65000))'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      '  DECLARE vimmmodo integer DEFAULT 1;'
      '  DECLARE vcfgmgoupedidounificado integer DEFAULT 0;'
      '  DECLARE itemisi integer DEFAULT 0;'
      '  DECLARE itemsbi integer DEFAULT 0;'
      '  DECLARE trmvendarapida integer DEFAULT 0;'
      '  DECLARE immhoraimpresso datetime DEFAULT NULL;'
      ''
      ''
      ''
      '  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION BEGIN'
      '    SET ErroException = 1;'
      '    SET pConfirma = ErroException;'
      ''
      '    ROLLBACK;'
      ''
      '    SET pMensagem = (SELECT'
      
        '        CASE WHEN ErroMensagem = 1 THEN '#39'1 - Erro nao identifica' +
        'do.'#39' WHEN ErroMensagem = 2 THEN '#39'2 - Nao foi possivel verificar ' +
        'se existe itens da mesa.'#39' WHEN ErroMensagem = 3 THEN '#39'3 - Nao fo' +
        'i possivel gravar itens da mesa.'#39' WHEN ErroMensagem = 4 THEN '#39'4 ' +
        '- Nao foi possivel gerar pedido na cozinha.'#39' WHEN ErroMensagem =' +
        ' 5 THEN '#39'5 - Nao foi possivel gravar itens, cozinha ja encerrou ' +
        'as atividades.'#39' WHEN ErroMensagem = 6 THEN '#39'6 - Nao foi possivel' +
        ' registrar dados auxiliares dos itens.'#39' WHEN ErroMensagem = 7 TH' +
        'EN '#39'7 - Nao foi possivel registrar mudancas de ingredientes.'#39' WH' +
        'EN ErroMensagem = 8 THEN '#39'8 - Nao foi possivel liberar pedido pa' +
        'ra impressao.'#39' ELSE ErroMensagem END'
      '      FROM dual);'
      '  END;'
      ''
      '  DROP TABLE IF EXISTS tsbi;'
      '  DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '    ID int NOT NULL AUTO_INCREMENT,'
      '    sbrcodigo int,'
      '    sbiobs varchar(100),'
      '    bprchave int,'
      '    sbiitem int,'
      '    PRIMARY KEY (ID)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  START TRANSACTION;'
      ''
      '    SET @vcfgmgoupedidounificado = (SELECT'
      '        cfgmgoupedidounificado'
      '      FROM cfgmgou LIMIT 1);'
      ''
      '    IF @vcfgmgoupedidounificado = 1 THEN'
      '      SET @vimmmodo = 9;'
      '    END IF;'
      ''
      '    IF @vcfgmgoupedidounificado = 0 THEN'
      '      SET @vimmmodo = 1;'
      '    END IF;'
      ''
      '    SET @stocodigo = (SELECT'
      '        stocodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    IF @stocodigo IN (1, 2) THEN'
      '      UPDATE orc'
      '      SET stocodigo = 1'
      '      WHERE orcchave = pOrcChave;'
      '    END IF;'
      ''
      '    SET ErroMensagem = 2;'
      ''
      '    SET @item = IFNULL((SELECT'
      '        MAX(itoitem)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChave), 0);'
      '    SET @qtd = (SELECT'
      '        COUNT(*)'
      '      FROM tito);'
      ''
      '    SET ErroMensagem = 4;'
      ''
      '    SET @MocCodigo = (SELECT'
      '        orc.moccodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    SET @clbcodigo = (SELECT'
      '        clbcodigo'
      '      FROM tito LIMIT 1);'
      ''
      '    IF @MocCodigo = 5 THEN'
      ''
      '      SET @cznchave = (SELECT'
      '          cznchave'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL LIMIT 1);'
      ''
      '      SET @immnumepedido = (SELECT'
      '          (IFNULL(MAX(imm.immnumepedido), 0) + 1) immnumepedido'
      '        FROM imm'
      '        WHERE imm.cznchave = @cznchave'
      '        AND imm.immmodo = 1);'
      ''
      '      IF @immnumepedido < IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000) THEN'
      '        SET @immnumepedido = IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000);'
      '      END IF;'
      ''
      '    END IF;'
      ''
      '    SET @posicao = 1;'
      ''
      '    SET @itemisi = 0;'
      '    SET @itemisi1 = 0;'
      ''
      '    SET @valortotaladicionais = 0;'
      ''
      '    WHILE (@posicao <= @qtd) DO'
      '      SET @valortotaladicionais = 0;'
      ''
      '      SET ErroMensagem = 3;'
      ''
      '      SET @item = (@item + 1);'
      '      SET @itemisi = (@itemisi + 1);'
      ''
      '      INSERT INTO ito (itochave'
      '      , orcchave'
      '      , procodigo'
      '      , puncodigo'
      '      , unicodigo'
      '      , stocodigo'
      '      , tdecodigo'
      '      , itoquantidade'
      '      , itovalorav'
      '      , itodescontoav'
      '      , itototalav'
      '      , itosaldoav'
      '      , itovalorap'
      '      , itodescontoap'
      '      , itototalap'
      '      , itosaldoap'
      '      , itocontendo'
      '      , itoproservico'
      '      , itoprocomple'
      '      , itodataalter'
      '      , itoitem'
      '      , itogint'
      '      , itopercdescap'
      '      , itopercdescav'
      '      , itoinfadprod'
      '      , itoquanticondi'
      '      , itoquantidevolcondi'
      '      , vrpcodigo'
      '      , itoobs'
      '      , flacodigo'
      '      , clbatendente'
      '      , oricodigo)'
      ''
      '        (SELECT'
      '          @novachave,'
      '          pOrcChave,'
      '          tito.procodigo,'
      '          tito.puncodigo,'
      '          uni.unicodigo,'
      '          2,'
      '          1,'
      '          tito.qtde,'
      '          pun.punprecoav,'
      '          0,'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          pun.punprecoap,'
      '          0,'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          pun.punmultiplicador,'
      '          '#39#39','
      '          '#39#39','
      '          CURRENT_DATE(),'
      '          @item,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          NULL,'
      '          tito.obs,'
      '          pFlaCodigo,'
      '          clbcodigo,'
      '          6'
      '        FROM tito'
      '          INNER JOIN pun'
      '            ON tito.puncodigo = pun.puncodigo'
      '          INNER JOIN uni'
      '            ON pun.unicodigo = uni.unicodigo'
      '        WHERE tito.ID = @posicao);'
      ''
      ''
      ''
      ''
      ''
      '      IF (SELECT'
      '            ROW_COUNT()) > 0 THEN'
      '        SET @itochave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      '        SELECT'
      '          procodigo,'
      '          obs,'
      '          sfnid,'
      '          sfncodigo,'
      '          copos,'
      '          pratos'
      '        FROM tito'
      '        WHERE tito.ID = @posicao INTO @procodigo'
      '        , @obs'
      '        , @sfnid'
      '        , @sfncodigo'
      '        , @copos'
      '        , @pratos;'
      ''
      ''
      ''
      ''
      '        IF @MocCodigo = 5 THEN'
      '          SET ErroMensagem = 6;'
      ''
      ''
      '          SELECT'
      '            gri.griminuretardo,'
      '            gri.tcicodigo'
      '          FROM gri'
      '            INNER JOIN pro'
      '              ON pro.grpcodigo = gri.grpcodigo'
      '            INNER JOIN ito'
      '              ON pro.procodigo = ito.procodigo'
      '          WHERE ito.itochave = @itochave INTO @griminuretardo'
      '          , @tcicodigo;'
      ''
      '          SET ErroMensagem = 61;'
      ''
      '          SET @immhoraimpresso = IFNULL((SELECT'
      '              NOW()'
      '            FROM trm'
      '            WHERE trmmesavendarapida IN (SELECT'
      '                orcmesa'
      '              FROM orc'
      '              WHERE orcchave = pOrcChave) LIMIT 1), NULL);'
      ''
      '          SET ErroMensagem = 162;'
      ''
      '          INSERT INTO imm (itochave'
      '          , tcicodigo'
      '          , immmodo'
      '          , cznchave'
      '          , immtemporetardo'
      '          , immnumepedido'
      '          , immhorapedido'
      '          , trmcodigo'
      '          , immdestino'
      '          , immcopos'
      '          , immpratos'
      '          , clbcodigo'
      '          , immhoraimpresso)'
      ''
      
        '            VALUES (@itochave, @tcicodigo, @vimmmodo, @cznchave,' +
        ' @griminuretardo, @immnumepedido, NOW(), 1, 1, @copos, @pratos, ' +
        'pClbCodigo, @immhoraimpresso);'
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      '          IF @sfncodigo > 0 THEN'
      ''
      '            SELECT'
      '              COUNT(brdcodigo)'
      ''
      '            FROM tbrd'
      '            WHERE tbrd.sfnid = @sfnid'
      '            AND tbrd.sfncodigo = @sfncodigo INTO @qtdbordas;'
      ''
      '            IF @qtdbordas > 0 THEN'
      '              INSERT INTO bri (brichave'
      '              , itochave'
      '              , brdcodigo'
      '              , briincluir)'
      '                (SELECT'
      '                  @novachave,'
      '                  @itochave,'
      '                  brdcodigo,'
      '                  1'
      '                FROM tbrd'
      '                WHERE tbrd.sfnid = @sfnid'
      '                AND tbrd.sfncodigo = @sfncodigo);'
      ''
      ''
      '              SET ErroMensagem = 71;'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      ''
      '                SET @vlborda = IFNULL((SELECT'
      '                    pun.punprecoav punprecoav'
      '                  FROM bri'
      '                    INNER JOIN ito'
      '                      ON bri.itochave = ito.itochave'
      '                    INNER JOIN brd'
      '                      ON bri.brdcodigo = brd.brdcodigo'
      '                    INNER JOIN pro'
      '                      ON brd.procodigo = pro.procodigo'
      '                    INNER JOIN pun'
      '                      ON pro.procodigo = pun.procodigo'
      '                      AND ito.unicodigo = pun.unicodigo'
      '                  WHERE bri.itochave = @itochave LIMIT 1), 0);'
      ''
      '                SET ErroMensagem = 72;'
      ''
      '                IF @vlborda > 0 THEN'
      '                  UPDATE ito'
      
        '                  SET ito.itovalorav = (ito.itovalorav + @vlbord' +
        'a),'
      
        '                      ito.itovalorap = (ito.itovalorap + @vlbord' +
        'a),'
      
        '                      ito.itototalav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itototalap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itosaldoav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2) - ito.itodescontoav,'
      
        '                      ito.itosaldoap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2) - ito.itodescontoav'
      ''
      '                  WHERE ito.itochave = @itochave;'
      '                END IF;'
      '              END IF;'
      ''
      ''
      '            END IF;'
      ''
      '            DELETE'
      '              FROM tsbi;'
      ''
      '            SET ErroMensagem = 73;'
      ''
      '            DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '            CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '              ID int NOT NULL AUTO_INCREMENT,'
      '              sbrcodigo int,'
      '              sbiobs varchar(100),'
      '              bprchave int,'
      '              sbiitem int,'
      '              PRIMARY KEY (ID)'
      '            ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '            SET @novasbiid = 0;'
      ''
      '            SET ErroMensagem = 74;'
      ''
      '            INSERT INTO tsbi'
      '              (SELECT'
      '                tisi.ID,'
      '                tisi.sbrcodigo,'
      '                tisi.obs,'
      '                tisi.bprchave,'
      '                tisi.isiitem'
      '              FROM tisi'
      '              WHERE tisi.isitipo = 2);'
      ''
      ''
      ''
      ''
      ''
      '            SET @possbi = 1;'
      ''
      '            SET ErroMensagem = 74;'
      ''
      '            WHILE (@possbi <= @posicao) DO'
      '              INSERT INTO sbi (sbichave'
      '              , itochave'
      '              , sbrcodigo'
      '              , sbiobs'
      '              , bprchave'
      '              , sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  tsbi.sbrcodigo,'
      '                  tsbi.sbiobs,'
      '                  tsbi.bprchave,'
      '                  tsbi.sbiitem'
      '                FROM tsbi'
      '                WHERE tsbi.sbiitem = @item);'
      ''
      '              SET ErroMensagem = 75;'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      ''
      '                SET @sbrcodigo = (SELECT'
      '                    sbrcodigo'
      '                  FROM sbi'
      '                  WHERE sbichave = @sbichave);'
      ''
      '                SET ErroMensagem = 76;'
      ''
      '                INSERT INTO isi (isichave'
      '                , sbichave'
      '                , tsicodigo'
      '                , procodigo'
      '                , itochave'
      '                , isiitem'
      '                , isitipo'
      '                , isiquantidade)'
      '                  (SELECT'
      '                    @novachave,'
      '                    (SELECT'
      '                        sbichave'
      '                      FROM sbi'
      '                      WHERE itochave = @itochave'
      '                      AND sbrcodigo = tisi.sbrcodigo) sbichave,'
      '                    tisi.tsicodigo,'
      '                    tisi.procodigo,'
      '                    @itochave,'
      '                    tisi.isiitem,'
      '                    tisi.isitipo,'
      '                    tisi.isiquantidade'
      '                  FROM tisi'
      ''
      '                  WHERE tisi.isitipo != 2);'
      ''
      '                SET ErroMensagem = 77;'
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      ''
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      ''
      '                  IF (@valortotaladicionais IS NOT NULL) THEN'
      '                    UPDATE ito'
      
        '                    SET itooutras = itooutras + @valortotaladici' +
        'onais'
      '                    WHERE itochave = @itochave;'
      '                  END IF;'
      '                  SET ErroMensagem = 78;'
      ''
      '                END IF;'
      ''
      '              END IF;'
      '              SET @possbi = (@possbi + 1);'
      '              SET @valortotaladicionais = 0;'
      '            END WHILE;'
      ''
      ''
      '            SET ErroMensagem = 78;'
      ''
      ''
      ''
      ''
      ''
      '          ELSE'
      ''
      '            IF (SELECT'
      '                  COUNT(*)'
      '                FROM tisi) = 0 THEN'
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  sbr.sbrcodigo,'
      '                  @obs,'
      '                  1'
      '                FROM sbr'
      '                WHERE sbr.procodigo = @procodigo LIMIT 1);'
      '            ELSE'
      '              SET ErroMensagem = 79;'
      ''
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.bprchave'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novachave,'
      '                  @itochave,'
      '                  tisi.sbrcodigo,'
      
        '                  IF(IFNULL(tisi.obs, '#39#39') != '#39#39', tisi.obs, @obs)' +
        ','
      '                  tisi.bprchave,'
      '                  tisi.isiitem'
      '                FROM tisi'
      '                  INNER JOIN sbr'
      '                    ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                WHERE sbr.procodigo = @procodigo LIMIT 1);'
      ''
      ''
      ''
      '              SET ErroMensagem = 80;'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      ''
      '                INSERT INTO isi (isichave'
      '                , sbichave'
      '                , tsicodigo'
      '                , procodigo'
      '                , itochave'
      '                , isiitem'
      '                , isitipo'
      '                , isiquantidade)'
      '                  (SELECT DISTINCT'
      '                    @novachaveisi,'
      '                    @sbichave,'
      '                    tisi.tsicodigo,'
      '                    tisi.procodigo,'
      '                    @itochave,'
      '                    @itemisi,'
      '                    tisi.isitipo,'
      '                    tisi.isiquantidade'
      '                  FROM tisi'
      '                    INNER JOIN sbr'
      '                      ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                  WHERE sbr.procodigo = @procodigo);'
      '                SET ErroMensagem = 81;'
      ''
      ''
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      '                  SET ErroMensagem = 82;'
      ''
      '                  IF (@valortotaladicionais IS NOT NULL) THEN'
      ''
      '                    UPDATE ito'
      
        '                    SET itooutras = itooutras + @valortotaladici' +
        'onais'
      '                    WHERE itochave = @itochave;'
      '                  END IF;'
      ''
      ''
      '                END IF;'
      '              END IF;'
      '            END IF;'
      ''
      '          END IF;'
      '        END IF;'
      ''
      '      END IF;'
      ''
      '      SET ErroMensagem = 83;'
      '      UPDATE ito'
      '      SET ito.itovalorav = (ito.itovalorav),'
      '          ito.itovalorap = (ito.itovalorap),'
      
        '          ito.itototalav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade) + (itooutras * ito.itoquantidade), 2),'
      
        '          ito.itototalap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade) + (itooutras * ito.itoquantidade), 2),'
      
        '          ito.itosaldoav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav,'
      
        '          ito.itosaldoap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav'
      '      WHERE ito.itochave = @itochave;'
      ''
      ''
      '      SET ErroMensagem = 84;'
      ''
      '      SET @posicao = @posicao + 1;'
      '      SET @valortotaladicionais = 0;'
      '    END WHILE;'
      ''
      '    SET ErroMensagem = 8;'
      '    SET ErroMensagem = 85;'
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(ito.itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(ito.itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      '        orc.orcdescontoav = tito.descav,'
      '        orc.orcpercdescav = 0,'
      '        orc.orctotalav = (tito.totav - tito.descav),'
      '        orc.orcgeralap = tito.totap,'
      '        orc.orcdescontoap = tito.descap,'
      '        orc.orcpercdescap = 0,'
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        stocodigo = @stocodigo'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '    IF NOT ErroException THEN'
      ''
      '      DELETE'
      '        FROM tito;'
      '      DELETE'
      '        FROM tbrd;'
      ''
      '      DELETE'
      '        FROM tisi;'
      ''
      '      DELETE'
      '        FROM tsbi;'
      ''
      '      DELETE'
      '        FROM trdc;'
      ''
      '    COMMIT;'
      ''
      '    SET pConfirma = ErroException;'
      '    SET pMensagem = '#39'Pedido gravado com sucesso !'#39';'
      '  END IF;'
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      '  /* daniel 03/07/2024 19:15 */'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      oricodigo,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmacrescimoav'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmoutras)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        itoacrescimoav,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        ito.itovalorav,'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      ''
      
        '        (ito.itovalorav * itoquantidade) * (@totalservicos / @to' +
        'talgeral)'
      ''
      ''
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END'
      '//'
      '')
    Delimiter = '//'
    Left = 584
    Top = 280
  end
  object us001247: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) + itooutras outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav - @totalservicos,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      oricodigo,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmacrescimoav'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmoutras)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        itoacrescimoav,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        ito.itovalorav + itooutras,'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      '        (@totalservicos) * (itototalav / (@totalgeral))'
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END //')
    Delimiter = '//'
    Left = 680
    Top = 288
  end
  object us001248: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) + itooutras outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav - @totalservicos,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      oricodigo,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmacrescimoav'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmoutras)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        0,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        ito.itovalorav + itoacrescimoav,'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      '        (@totalservicos) * (itototalav / (@totalgeral))'
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END //')
    Delimiter = '//'
    Left = 752
    Top = 280
  end
  object us001249: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav - @totalservicos,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      oricodigo,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmacrescimoav'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmoutras)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        0,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        IF((SELECT'
      '            tpocodigo'
      '          FROM pro p'
      
        '          WHERE p.procodigo = ito.procodigo) = 0, ito.itovalorav' +
        ' + itooutras, ito.itovalorav),'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      
        '        (@totalservicos) * ((itototalav - itooutras) / (@totalge' +
        'ral))'
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END //')
    Delimiter = '//'
    Left = 832
    Top = 280
  end
  object us001250: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav - @totalservicos,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      oricodigo,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmacrescimoav'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmoutras)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        0,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        IF((SELECT'
      '            tpocodigo'
      '          FROM pro p'
      
        '          WHERE p.procodigo = ito.procodigo) = 0, ito.itovalorav' +
        ' + itooutras, ito.itovalorav),'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      
        '        (@totalservicos) * ((itototalav - itooutras) / (@totalge' +
        'ral))'
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END //'
      ''
      '')
    Delimiter = '//'
    Left = 888
    Top = 280
  end
  object us001251: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS FechaMesaParcial//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesaParcial (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT DISTINCT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      ''
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = @OrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      ''
      '  SET pConfirma = @Confirma;'
      ''
      ''
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      ''
      ''
      ''
      '  SET pLteChave = 0;'
      ''
      ''
      '  SET pMesChave = 0;'
      ''
      ''
      '  SET @meschave = 0;'
      ''
      ''
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      '    IF pTipo = 1 THEN'
      ''
      ''
      '      SET @qtdItem = (SELECT'
      '          COUNT(*)'
      '        FROM titem);'
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      ''
      '        SET @ContaItem = 1;'
      ''
      ''
      ''
      '        SET ErroMensagem = 1;'
      ''
      ''
      ''
      '        INSERT INTO orc (orcchave'
      '        , etdcodigo'
      '        , clbcodigo'
      '        , fopcodigo'
      '        , tdecodigo'
      '        , stocodigo'
      '        , moccodigo'
      '        , foacodigo'
      '        , trmcodigo'
      '        , tfpcodigo'
      '        , puocodigo'
      '        , orcdataabert'
      '        , orchoraabert'
      '        , orcgeralav'
      '        , orcdescontoav'
      '        , orcpercdescav'
      '        , orctotalav'
      '        , orcgeralap'
      '        , orcdescontoap'
      '        , orcpercdescap'
      '        , orctotalap'
      '        , orcobs'
      '        , orcdestimpre'
      '        , edritem'
      '        , edrcodigo'
      '        , clbvendedor'
      '        , orcmesa'
      '        , orctelefone'
      '        , ccxchave'
      '        , cznchave)'
      '          SELECT'
      '            @novachave,'
      '            etdcodigo,'
      '            pClbCodigo,'
      '            fopcodigo,'
      '            tdecodigo,'
      '            3,'
      '            moccodigo,'
      '            foacodigo,'
      '            trmcodigo,'
      '            tfpcodigo,'
      '            puocodigo,'
      '            orcdataabert,'
      '            TIME(NOW()),'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            orcobs,'
      '            orcdestimpre,'
      '            edritem,'
      '            edrcodigo,'
      '            pClbCodigo,'
      '            orcmesa,'
      '            orctelefone,'
      '            ccxchave,'
      '            cznchave'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '        IF (ROW_COUNT() > 0) THEN'
      ''
      '          SET @orcchave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      ''
      '          SET ErroMensagem = 2;'
      ''
      ''
      ''
      '          SET @troqtd = 0;'
      ''
      ''
      '          SET @troqtd = (SELECT DISTINCT'
      '              COUNT(orcchaveorigem)'
      '            FROM tro'
      '            WHERE orcchaveorigem = pOrcChave'
      '            AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '          IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '            SET @orcchaveinicial = IFNULL((SELECT'
      '                orcchaveorigem'
      '              FROM tro'
      '              WHERE orcchavedestino = pOrcChave'
      '              ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '            INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '              VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE ' +
        'KEY UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = ' +
        '@orcchave;'
      ''
      ''
      '          END IF;'
      ''
      ''
      ''
      ''
      ''
      '          SET @item = 0;'
      ''
      ''
      '          WHILE (@ContaItem <= @qtdItem) DO'
      ''
      '            SET @item = @item + 1;'
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 3;'
      ''
      ''
      ''
      ''
      '            SELECT'
      '              titem.itochave,'
      '              qtde'
      '            FROM titem'
      '            WHERE titem.ID = @ContaItem INTO @itochave'
      '            , @qtde;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 4;'
      ''
      ''
      ''
      ''
      '            INSERT INTO ito (itochave'
      '            , orcchave'
      '            , procodigo'
      '            , puncodigo'
      '            , unicodigo'
      '            , stocodigo'
      '            , tdecodigo'
      '            , itoquantidade'
      '            , itovalorav'
      '            , itototalav'
      '            , itodescontoav'
      '            , itosaldoav'
      '            , itovalorap'
      '            , itototalap'
      '            , itodescontoap'
      '            , itosaldoap'
      '            , itocontendo'
      '            , itoproservico'
      '            , itoprocomple'
      '            , itodataalter'
      '            , itoitem'
      '            , itogint'
      '            , itopercdescap'
      '            , itopercdescav'
      '            , itoinfadprod'
      '            , itoquanticondi'
      '            , itoquantidevolcondi'
      '            , vrpcodigo'
      '            , itoobs'
      '            , itoacrescimoav'
      '            , clbatendente'
      '            , oricodigo'
      '            , itooutras)'
      '              SELECT'
      '                @novoito,'
      '                @orcchave,'
      '                ito.procodigo,'
      '                puncodigo,'
      '                unicodigo,'
      '                3,'
      '                tdecodigo,'
      '                @qtde,'
      '                itovalorav,'
      '                (@qtde * (itovalorav + itooutras)),'
      
        '                ROUND(((itovalorav + itooutras) * @percdesc) * @' +
        'qtde, 2),'
      
        '                (((itovalorav + itooutras) * @qtde) - (ROUND(((i' +
        'tovalorav + itooutras) * @percdesc) * @qtde, 2))),'
      '                itovalorap,'
      '                (@qtde * itovalorap),'
      '                ROUND((itototalap * @percdesc), 2),'
      '                (itototalap - itodescontoap),'
      '                itocontendo,'
      '                itoproservico,'
      '                itoprocomple,'
      '                CURRENT_DATE(),'
      '                @item,'
      '                itogint,'
      '                ROUND(@percdesc, 3),'
      '                ROUND(@percdesc, 3),'
      '                itoinfadprod,'
      '                itoquanticondi,'
      '                itoquantidevolcondi,'
      '                vrpcodigo,'
      '                itoobs,'
      '                itoacrescimoav,'
      '                clbatendente,'
      '                6,'
      '                itooutras'
      '              FROM ito'
      '              WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      '            SET @immitochave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      ''
      ''
      ''
      '            INSERT INTO imm (immchave,'
      '            itochave,'
      '            tcicodigo,'
      '            immimpresso,'
      '            immentregue,'
      '            immmodo,'
      '            ccxchave,'
      '            immhorapedido,'
      '            immhoraentrega,'
      '            immrecebido,'
      '            dorchave,'
      '            immnumepedido,'
      '            trmcodigo,'
      '            immdestino,'
      '            immidentificacao,'
      '            immgarsom,'
      '            immtemporetardo,'
      '            immmodoimpressao,'
      '            cznchave,'
      '            etdcodigoent,'
      '            immpratos,'
      '            immcopos,'
      '            immnumepedidoint,'
      '            clbcodigo,'
      '            immhoraimpresso,'
      '            immhoraimprimir,'
      '            immhoraentregadopedido,'
      '            immhoranotificadopedido,'
      '            immhorasaidadopedido)'
      '              SELECT'
      '                @novaimmchave,'
      '                @immitochave,'
      '                tcicodigo,'
      '                immimpresso,'
      '                immentregue,'
      '                immmodo,'
      '                ccxchave,'
      '                immhorapedido,'
      '                immhoraentrega,'
      '                immrecebido,'
      '                dorchave,'
      '                immnumepedido,'
      '                trmcodigo,'
      '                immdestino,'
      '                immidentificacao,'
      '                immgarsom,'
      '                immtemporetardo,'
      '                immmodoimpressao,'
      '                cznchave,'
      '                etdcodigoent,'
      '                immpratos,'
      '                immcopos,'
      '                immnumepedidoint,'
      '                clbcodigo,'
      '                immhoraimpresso,'
      '                immhoraimprimir,'
      '                immhoraentregadopedido,'
      '                immhoranotificadopedido,'
      '                immhorasaidadopedido'
      '              FROM imm'
      '              WHERE itochave = @itochave;'
      ''
      '            UPDATE imp'
      '            SET itochave = @immitochave'
      '            WHERE imp.itochave = @itochave;'
      ''
      ''
      ''
      '            SELECT'
      '              COUNT(itochave)'
      '            FROM sbi'
      '            WHERE sbi.itochave = @itochave INTO @qtdItemSbi;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItemsbi = 1;'
      ''
      ''
      ''
      '            WHILE (@ContaItemsbi <= @qtdItemSbi) DO'
      ''
      ''
      '              INSERT INTO sbi'
      '                (SELECT'
      '                  @outrachave,'
      '                  @immitochave,'
      '                  sbrcodigo,'
      '                  sbiobs,'
      '                  sbiitem,'
      '                  bprchave'
      '                FROM sbi'
      '                WHERE itochave = @itochave'
      '                AND sbi.sbiitem = @ContaItemsbi);'
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @ultimosbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      '              END IF;'
      ''
      ''
      ''
      ''
      '              SELECT'
      '                COUNT(itochave)'
      '              FROM isi'
      '              WHERE itochave = @itochave'
      '              AND isiitem = @ContaItemsbi INTO @qtdItemisi;'
      ''
      ''
      ''
      ''
      '              IF @qtdItemisi > 0 THEN'
      ''
      ''
      '                INSERT INTO isi'
      '                  (SELECT'
      '                    @novaisichave,'
      '                    @ultimosbichave,'
      '                    tsicodigo,'
      '                    procodigo,'
      '                    isitipo,'
      '                    @immitochave,'
      '                    isiitem,'
      '                    isiquantidade,'
      '                    0'
      '                  FROM isi'
      '                  WHERE itochave = @itochave'
      '                  AND isiitem = @ContaItemsbi);'
      ''
      '              END IF;'
      ''
      ''
      ''
      '              SET @ContaItemsbi = @ContaItemsbi + 1;'
      ''
      ''
      '            END WHILE;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 5;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            UPDATE ito'
      '            SET ito.itoquantidade = (ito.itoquantidade - @qtde),'
      
        '                ito.itototalav = (ito.itoquantidade * ito.itoval' +
        'orav),'
      
        '                ito.itosaldoav = (ito.itototalav - itodescontoav' +
        '),'
      
        '                ito.itototalap = (ito.itoquantidade * ito.itoval' +
        'orap),'
      '                ito.itosaldoap = (itototalap - itodescontoap)'
      '            WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItem = @ContaItem + 1;'
      ''
      ''
      '          END WHILE;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 6;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      '              orc.orcdescontoav = tito.descav,'
      
        '              orc.orcpercdescav = IF(tito.descav > 0, (tito.desc' +
        'av / tito.totav), 0),'
      '              orc.orctotalav = (tito.totav - tito.descav),'
      '              orc.orcgeralap = tito.totap,'
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = @orcchave;'
      ''
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '              orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      '        SET ErroMensagem = 8;'
      ''
      ''
      
        '        CALL RegistraMes(@orcchave, pClbCodigo, ErroMensagem, pC' +
        'onfirma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 10;'
      ''
      ''
      ''
      ''
      '        SET @troqtd = 0;'
      ''
      ''
      '        SET @troqtd = (SELECT DISTINCT'
      '            COUNT(orcchaveorigem)'
      '          FROM tro'
      '          WHERE orcchaveorigem = pOrcChave'
      '          AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '        IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '          SET @orcchaveinicial = IFNULL((SELECT'
      '              orcchaveorigem'
      '            FROM tro'
      '            WHERE orcchavedestino = pOrcChave'
      '            ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '          INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '            VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE KE' +
        'Y UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = @o' +
        'rcchave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 11;'
      ''
      ''
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, @OrcChave, @ltechave, pNome, 1);'
      '      ELSE'
      ''
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, pOrcChave, @ltechave, pNome, 0);'
      '      END IF;'
      ''
      ''
      ''
      '      IF (@qtdItem > 0)'
      '        AND (@orcchave > 0) THEN'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = @orcchave'
      '          AND dtl.mdacodigo != 7);'
      ''
      ''
      '        IF @VlrFechamento > 0 THEN'
      ''
      ''
      '          SET @etdcodigo = (SELECT'
      '              etdcodigo'
      '            FROM orc'
      '            WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      '          SET ErroMensagem = 15;'
      ''
      ''
      '          OPEN curlote;'
      '        read_loop:'
      '          LOOP'
      ''
      '            FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '            IF done THEN'
      ''
      '              LEAVE read_loop;'
      '            END IF;'
      ''
      ''
      '            SET @VlrFechamento = (SELECT'
      '                SUM(dtl.dtlvalor) dtlvalor'
      '              FROM dtl'
      '                INNER JOIN olt'
      '                  ON dtl.ltechave = olt.ltechave'
      '              WHERE olt.orcchave = @orcchave'
      '              AND dtl.ltechave = lote'
      '              AND dtl.mdacodigo = modalidade'
      '              AND dtl.mdacodigo != 7);'
      ''
      '            DELETE'
      '              FROM trfi'
      '            WHERE mdacodigo <> modalidade;'
      ''
      '            INSERT INTO trfi (ID'
      '            , etdcodigo'
      '            , mdacodigo'
      '            , tfdcodigo'
      '            , numparc'
      '            , dtvecto'
      '            , vlrparcela'
      '            , numero)'
      
        '              VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_' +
        'DATE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '            SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '            CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, ErroMe' +
        'nsagem, @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 9;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          END LOOP;'
      ''
      ''
      '          CLOSE curlote;'
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      ''
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            @MesChave'
      '          FROM olt'
      '            INNER JOIN mlt'
      '              ON olt.ltechave = mlt.ltechave'
      '            INNER JOIN mfi'
      '              ON mlt.mfichave = mfi.mfichave'
      '          WHERE olt.orcchave = @OrcChave);'
      ''
      '      END IF;'
      ''
      ''
      ''
      '    ELSE'
      ''
      ''
      '      SET ErroMensagem = 13;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      INSERT INTO olt (oltchave'
      '      , orcchave'
      '      , ltechave'
      '      , oltidentificacao'
      '      , olttipo)'
      
        '        VALUE (@novachave, @orcchave, @ltechave, pNome, pTipoFec' +
        'hamento);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET @LteDesconto = IFNULL((SELECT'
      '          SUM(lte.ltedesconto)'
      '        FROM olt'
      '          INNER JOIN lte'
      '            ON olt.ltechave = lte.ltechave'
      '        WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '      SET @OrcTotalAv = (SELECT'
      '          SUM(itovalorav * itoquantidade) totav'
      '        FROM ito'
      '        WHERE orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '      IF @LteDesconto > 0 THEN'
      ''
      ''
      '        SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '        UPDATE ito'
      '        SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '            itosaldoav = (ito.itototalav - itodescontoav),'
      '            itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '            itosaldoap = (ito.itototalav - itodescontoav),'
      '            itopercdescap = ROUND(@percdesc, 3),'
      '            itopercdescav = ROUND(@percdesc, 3)'
      '        WHERE ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '        SET @centavos = @LteDesconto - (SELECT'
      '            SUM(itodescontoav)'
      '          FROM ito'
      '          WHERE ito.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '        IF @centavos <> 0 THEN'
      ''
      '          UPDATE ito'
      '          SET itodescontoav = itodescontoav + @centavos,'
      '              itodescontoap = itodescontoap + @centavos,'
      '              itosaldoav = itosaldoav + @centavos,'
      '              itosaldoap = itosaldoap + @centavos'
      '          WHERE ito.orcchave = pOrcChave;'
      ''
      '        END IF;'
      ''
      ''
      ''
      '        UPDATE orc'
      '        INNER JOIN (SELECT'
      '            ito.orcchave,'
      '            SUM(itototalav) totav,'
      '            SUM(itodescontoav) descav,'
      '            SUM(itototalap) totap,'
      '            SUM(itodescontoap) descap'
      '          FROM ito'
      '          WHERE stocodigo != 88'
      '          GROUP BY ito.orcchave) tito'
      '          ON tito.orcchave = orc.orcchave'
      '        SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '            orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '            orc.orcdescontoav = tito.descap,'
      
        '            orc.orcpercdescav = IF(tito.descap > 0, (tito.descap' +
        ' / tito.totap), 0),'
      '            orc.orctotalap = (tito.totap - tito.descap)'
      '        WHERE orc.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '      CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pCon' +
        'firma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET ErroMensagem = 14;'
      ''
      ''
      ''
      '      SET @VlrFechamento = (SELECT'
      '          SUM(dtl.dtlvalor) dtlvalor'
      '        FROM dtl'
      '          INNER JOIN olt'
      '            ON dtl.ltechave = olt.ltechave'
      '        WHERE olt.orcchave = pOrcChave'
      '        AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '      IF @VlrFechamento > 0 THEN'
      ''
      ''
      '        SET @etdcodigo = (SELECT'
      '            etdcodigo'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        OPEN curlote;'
      '      read_loop:'
      '        LOOP'
      ''
      '          FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '          IF done THEN'
      ''
      '            LEAVE read_loop;'
      '          END IF;'
      ''
      '          SET @VlrFechamento = (SELECT'
      '              SUM(dtl.dtlvalor) dtlvalor'
      '            FROM dtl'
      '              INNER JOIN olt'
      '                ON dtl.ltechave = olt.ltechave'
      '            WHERE olt.orcchave = pOrcChave'
      '            AND dtl.ltechave = lote'
      '            AND dtl.mdacodigo = modalidade'
      '            AND dtl.mdacodigo != 7);'
      ''
      ''
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '            VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DA' +
        'TE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '          SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '          CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem,' +
        ' @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 17;'
      ''
      ''
      ''
      '          INSERT INTO rfm (rfmchave'
      '          , rfichave'
      '          , meschave)'
      ''
      '            (SELECT DISTINCT'
      '              @novachave,'
      '              rfichave,'
      '              @MesChave'
      '            FROM olt'
      '              INNER JOIN mlt'
      '                ON olt.ltechave = mlt.ltechave'
      '              INNER JOIN mfi'
      '                ON mlt.mfichave = mfi.mfichave'
      '            WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '        END LOOP;'
      ''
      ''
      '        CLOSE curlote;'
      ''
      '      END IF;'
      ''
      ''
      '      INSERT INTO rfm (rfmchave'
      '      , rfichave'
      '      , meschave)'
      ''
      '        (SELECT DISTINCT'
      '          @novachave,'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '      SET ErroMensagem = 18;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      '          orc.orcpercdescav = @percdesc,'
      '          orc.orctotalap = (tito.totap - tito.descap),'
      '          orc.orcdataencerr = CURRENT_DATE(),'
      '          orc.orchoraencerr = CURRENT_TIME(),'
      '          orc.stocodigo = 3'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.stocodigo = 3'
      '      WHERE ito.orcchave = pOrcChave'
      '      AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '    END IF;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END //')
    Left = 944
    Top = 280
  end
  object us001252: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS MobGravaItens//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      
        'PROCEDURE MobGravaItens (IN pOrcChave int, IN pClbCodigo int, IN' +
        ' pFlaCodigo int, IN pTipoItem int, OUT pConfirma int, OUT pMensa' +
        'gem varchar(65000))'
      'BEGIN'
      ''
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      '  DECLARE vimmmodo integer DEFAULT 1;'
      '  DECLARE vcfgmgoupedidounificado integer DEFAULT 0;'
      '  DECLARE itemisi integer DEFAULT 0;'
      '  DECLARE itemsbi integer DEFAULT 0;'
      ''
      ''
      ''
      '  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION BEGIN'
      '    SET ErroException = 1;'
      '    SET pConfirma = ErroException;'
      ''
      '    ROLLBACK;'
      ''
      '    SET pMensagem = (SELECT'
      
        '        CASE WHEN ErroMensagem = 1 THEN '#39'1 - Erro nao identifica' +
        'do.'#39' WHEN ErroMensagem = 2 THEN '#39'2 - Nao foi possivel verificar ' +
        'se existe itens da mesa.'#39' WHEN ErroMensagem = 3 THEN '#39'3 - Nao fo' +
        'i possivel gravar itens da mesa.'#39' WHEN ErroMensagem = 4 THEN '#39'4 ' +
        '- Nao foi possivel gerar pedido na cozinha.'#39' WHEN ErroMensagem =' +
        ' 5 THEN '#39'5 - Nao foi possivel gravar itens, cozinha ja encerrou ' +
        'as atividades.'#39' WHEN ErroMensagem = 6 THEN '#39'6 - Nao foi possivel' +
        ' registrar dados auxiliares dos itens.'#39' WHEN ErroMensagem = 7 TH' +
        'EN '#39'7 - Nao foi possivel registrar mudancas de ingredientes.'#39' WH' +
        'EN ErroMensagem = 8 THEN '#39'8 - Nao foi possivel liberar pedido pa' +
        'ra impressao.'#39' ELSE '#39'Erro inesperado.'#39' END'
      '      FROM dual);'
      '  END;'
      ''
      '  DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '    ID int NOT NULL AUTO_INCREMENT,'
      '    sbrcodigo int,'
      '    sbiobs varchar(100),'
      '    bprchave int,'
      '    sbiitem int,'
      '    PRIMARY KEY (ID)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  START TRANSACTION;'
      ''
      '    SET @vcfgmgoupedidounificado = (SELECT'
      '        cfgmgoupedidounificado'
      '      FROM cfgmgou LIMIT 1);'
      ''
      '    IF @vcfgmgoupedidounificado = 1 THEN'
      '      SET @vimmmodo = 9;'
      '    END IF;'
      ''
      '    IF @vcfgmgoupedidounificado = 0 THEN'
      '      SET @vimmmodo = 1;'
      '    END IF;'
      ''
      '    SET @stocodigo = (SELECT'
      '        stocodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    IF @stocodigo IN (1, 2) THEN'
      '      UPDATE orc'
      '      SET stocodigo = 1'
      '      WHERE orcchave = pOrcChave;'
      '    END IF;'
      ''
      '    SET ErroMensagem = 2;'
      ''
      '    SET @item = IFNULL((SELECT'
      '        MAX(itoitem)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChave), 0);'
      '    SET @qtd = (SELECT'
      '        COUNT(*)'
      '      FROM tito);'
      ''
      '    SET ErroMensagem = 4;'
      ''
      '    SET @MocCodigo = (SELECT'
      '        orc.moccodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    SET @clbcodigo = (SELECT'
      '        clbcodigo'
      '      FROM tito LIMIT 1);'
      ''
      '    IF @MocCodigo = 5 THEN'
      ''
      '      SET @cznchave = (SELECT'
      '          cznchave'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL LIMIT 1);'
      ''
      '      SET @immnumepedido = (SELECT'
      '          (IFNULL(MAX(imm.immnumepedido), 0) + 1) immnumepedido'
      '        FROM imm'
      '        WHERE imm.cznchave = @cznchave'
      '        AND imm.immmodo = 1);'
      ''
      '      IF @immnumepedido < IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000) THEN'
      '        SET @immnumepedido = IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000);'
      '      END IF;'
      ''
      '    END IF;'
      ''
      '    SET @posicao = 1;'
      ''
      '    SET @itemisi = 0;'
      '    SET @itemisi1 = 0;'
      ''
      '    SET @valortotaladicionais = 0;'
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      '      SET @valortotaladicionais = 0;'
      ''
      '      SET ErroMensagem = 3;'
      ''
      '      SET @item = (@item + 1);'
      '      SET @itemisi = (@itemisi + 1);'
      ''
      '      INSERT INTO ito (itochave'
      '      , orcchave'
      '      , procodigo'
      '      , puncodigo'
      '      , unicodigo'
      '      , stocodigo'
      '      , tdecodigo'
      '      , itoquantidade'
      '      , itovalorav'
      '      , itodescontoav'
      '      , itototalav'
      '      , itosaldoav'
      '      , itovalorap'
      '      , itodescontoap'
      '      , itototalap'
      '      , itosaldoap'
      '      , itocontendo'
      '      , itoproservico'
      '      , itoprocomple'
      '      , itodataalter'
      '      , itoitem'
      '      , itogint'
      '      , itopercdescap'
      '      , itopercdescav'
      '      , itoinfadprod'
      '      , itoquanticondi'
      '      , itoquantidevolcondi'
      '      , vrpcodigo'
      '      , itoobs'
      '      , flacodigo'
      '      , clbatendente'
      '      , oricodigo)'
      ''
      '        (SELECT'
      '          @novachave,'
      '          pOrcChave,'
      '          tito.procodigo,'
      '          tito.puncodigo,'
      '          uni.unicodigo,'
      '          2,'
      '          1,'
      '          tito.qtde,'
      '          pun.punprecoav,'
      '          0,'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          pun.punprecoap,'
      '          0,'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          pun.punmultiplicador,'
      '          '#39#39','
      '          '#39#39','
      '          CURRENT_DATE(),'
      '          @item,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          NULL,'
      '          tito.obs,'
      '          pFlaCodigo,'
      '          clbcodigo,'
      '          1'
      '        FROM tito'
      '          INNER JOIN pun'
      '            ON tito.puncodigo = pun.puncodigo'
      '          INNER JOIN uni'
      '            ON pun.unicodigo = uni.unicodigo'
      '        WHERE tito.ID = @posicao);'
      ''
      ''
      ''
      ''
      ''
      '      IF (SELECT'
      '            ROW_COUNT()) > 0 THEN'
      '        SET @itochave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      '        SELECT'
      '          procodigo,'
      '          obs,'
      '          sfnid,'
      '          sfncodigo,'
      '          copos,'
      '          pratos'
      '        FROM tito'
      '        WHERE tito.ID = @posicao INTO @procodigo'
      '        , @obs'
      '        , @sfnid'
      '        , @sfncodigo'
      '        , @copos'
      '        , @pratos;'
      ''
      ''
      ''
      ''
      '        IF @MocCodigo = 5 THEN'
      '          SET ErroMensagem = 6;'
      ''
      ''
      '          SELECT'
      '            gri.griminuretardo,'
      '            gri.tcicodigo'
      '          FROM gri'
      '            INNER JOIN pro'
      '              ON pro.grpcodigo = gri.grpcodigo'
      '            INNER JOIN ito'
      '              ON pro.procodigo = ito.procodigo'
      '          WHERE ito.itochave = @itochave INTO @griminuretardo'
      '          , @tcicodigo;'
      ''
      ''
      '          INSERT INTO imm (itochave'
      '          , tcicodigo'
      '          , immmodo'
      '          , cznchave'
      '          , immtemporetardo'
      '          , immnumepedido'
      '          , immhorapedido'
      '          , trmcodigo'
      '          , immdestino'
      '          , immcopos'
      '          , immpratos'
      '          , clbcodigo)'
      
        '            VALUES (@itochave, @tcicodigo, @vimmmodo, @cznchave,' +
        ' @griminuretardo, @immnumepedido, NOW(), 1, 1, @copos, @pratos, ' +
        'pClbCodigo);'
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      '          IF @sfncodigo > 0 THEN'
      ''
      '            SELECT'
      '              COUNT(brdcodigo)'
      ''
      '            FROM tbrd'
      '            WHERE tbrd.sfnid = @sfnid'
      '            AND tbrd.sfncodigo = @sfncodigo INTO @qtdbordas;'
      ''
      '            IF @qtdbordas > 0 THEN'
      '              INSERT INTO bri (brichave'
      '              , itochave'
      '              , brdcodigo'
      '              , briincluir)'
      '                (SELECT'
      '                  0,'
      '                  @itochave,'
      '                  brdcodigo,'
      '                  1'
      '                FROM tbrd'
      '                WHERE tbrd.sfnid = @sfnid'
      '                AND tbrd.sfncodigo = @sfncodigo);'
      ''
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      ''
      '                SET @vlborda = (SELECT'
      '                    pun.punprecoav punprecoav'
      '                  FROM bri'
      '                    INNER JOIN ito'
      '                      ON bri.itochave = ito.itochave'
      '                    INNER JOIN brd'
      '                      ON bri.brdcodigo = brd.brdcodigo'
      '                    INNER JOIN pro'
      '                      ON brd.procodigo = pro.procodigo'
      '                    INNER JOIN pun'
      '                      ON pro.procodigo = pun.procodigo'
      '                      AND ito.unicodigo = pun.unicodigo'
      '                  WHERE bri.itochave = @itochave LIMIT 1);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '                IF @vlborda > 0 THEN'
      '                  UPDATE ito'
      
        '                  SET ito.itovalorav = (ito.itovalorav + @vlbord' +
        'a),'
      
        '                      ito.itovalorap = (ito.itovalorap + @vlbord' +
        'a),'
      
        '                      ito.itototalav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itototalap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itosaldoav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2) - ito.itodescontoav,'
      
        '                      ito.itosaldoap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2) - ito.itodescontoav'
      ''
      '                  WHERE ito.itochave = @itochave;'
      '                END IF;'
      '              END IF;'
      ''
      ''
      '            END IF;'
      ''
      '            DELETE'
      '              FROM tsbi;'
      ''
      '            SET @novasbiid = 0;'
      ''
      ''
      ''
      ''
      ''
      ''
      '            DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '            CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '              ID int NOT NULL AUTO_INCREMENT,'
      '              sbrcodigo int,'
      '              sbiobs varchar(100),'
      '              bprchave int,'
      '              sbiitem int,'
      '              PRIMARY KEY (ID)'
      '            ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      ''
      ''
      '            INSERT INTO tsbi'
      '              (SELECT'
      '                @chavenova,'
      '                tisi.sbrcodigo,'
      '                tisi.obs,'
      '                tisi.bprchave,'
      '                tisi.isiitem'
      ''
      '              FROM tisi'
      '              WHERE tisi.isiitem = @posicao'
      ''
      '              AND tisi.isitipo = 2);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @possbi = 1;'
      ''
      ''
      ''
      ''
      '            SET @posqtd = (SELECT'
      '                COUNT(*)'
      '              FROM tsbi);'
      ''
      ''
      '            IF @posqtd > 0 THEN'
      '              SET itemsbi = itemsbi + 1;'
      '            END IF;'
      ''
      ''
      ''
      ''
      '            WHILE (@possbi <= @posqtd) DO'
      ''
      '              SET @itemisi1 = @itemisi1 + 1;'
      ''
      '              INSERT INTO sbi (sbichave'
      '              , itochave'
      '              , sbrcodigo'
      '              , sbiobs'
      '              , bprchave'
      '              , sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  tsbi.sbrcodigo,'
      '                  tsbi.sbiobs,'
      '                  tsbi.bprchave,'
      '                  tsbi.sbiitem'
      '                FROM tsbi'
      '                WHERE tsbi.sbiitem = @sfnid'
      '                AND tsbi.ID = @possbi);'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      ''
      ''
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      ''
      '                SET @sbrcodigo = (SELECT'
      '                    sbrcodigo'
      '                  FROM sbi'
      '                  WHERE sbichave = @sbichave);'
      ''
      ''
      ''
      '                INSERT INTO isi (isichave'
      '                , sbichave'
      '                , tsicodigo'
      '                , procodigo'
      '                , itochave'
      '                , isiitem'
      '                , isitipo'
      '                , isiquantidade)'
      '                  (SELECT'
      '                    @novachave,'
      '                    @sbichave,'
      '                    tisi.tsicodigo,'
      '                    tisi.procodigo,'
      '                    @itochave,'
      '                    @possbi,'
      '                    tisi.isitipo,'
      '                    tisi.isiquantidade'
      '                  FROM tisi'
      '                  WHERE tisi.sfnid = @sfnid'
      '                  AND tisi.sfncodigo = @sfncodigo'
      '                  AND tisi.sbrcodigo = @sbrcodigo'
      '                  AND (tisi.isitipo != 2)'
      '                  AND tisi.isiitem = @posicao);'
      ''
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      ''
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      ''
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      ''
      ''
      ''
      ''
      '                END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '              END IF;'
      '              SET @possbi = (@possbi + 1);'
      '            END WHILE;'
      ''
      '            DELETE'
      '              FROM isi'
      '            WHERE itochave = @itochave'
      '              AND (isitipo = 0'
      '              AND tsicodigo = 3);'
      ''
      '            IF (@valortotaladicionais IS NOT NULL) THEN'
      '              UPDATE ito'
      '              SET itoacrescimoav = @valortotaladicionais'
      '              WHERE itochave = @itochave;'
      '            END IF;'
      ''
      ''
      ''
      ''
      ''
      '            DELETE'
      '              FROM isi'
      '            WHERE itochave = @itochave'
      '              AND (isitipo = 0'
      '              AND tsicodigo = 3);'
      ''
      ''
      ''
      '          ELSE'
      ''
      '            IF (SELECT'
      '                  COUNT(*)'
      '                FROM tisi) = 0 THEN'
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  sbr.sbrcodigo,'
      '                  @obs,'
      '                  1'
      '                FROM sbr'
      '                WHERE sbr.procodigo = @procodigo LIMIT 1);'
      '            ELSE'
      ''
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.bprchave'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novachave,'
      '                  @itochave,'
      '                  tisi.sbrcodigo,'
      
        '                  IF(IFNULL(tisi.obs, '#39#39') != '#39#39', tisi.obs, @obs)' +
        ','
      '                  tisi.bprchave,'
      '                  tisi.isiitem'
      '                FROM tisi'
      '                  INNER JOIN sbr'
      '                    ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                WHERE tisi.isiitem = @itemisi'
      '                AND sbr.procodigo = @procodigo LIMIT 1);'
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      '                IF pTipoItem = 1 THEN'
      '                  INSERT INTO isi (isichave'
      '                  , sbichave'
      '                  , tsicodigo'
      '                  , procodigo'
      '                  , itochave'
      '                  , isiitem'
      '                  , isitipo'
      '                  , isiquantidade)'
      '                    (SELECT DISTINCT'
      '                      @novachave,'
      '                      @sbichave,'
      '                      tisi.tsicodigo,'
      '                      tisi.procodigo,'
      '                      @itochave,'
      '                      @itemisi,'
      '                      tisi.isitipo,'
      '                      tisi.isiquantidade'
      '                    FROM tisi'
      '                      INNER JOIN sbr'
      '                        ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                    WHERE sbr.procodigo = @procodigo'
      '                    AND tisi.isiitem = @itemisi);'
      '                END IF;'
      ''
      ''
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      ''
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      ''
      ''
      ''
      '                END IF;'
      '              END IF;'
      ''
      '              IF (@valortotaladicionais IS NOT NULL) THEN'
      '                UPDATE ito'
      '                SET itoacrescimoav = @valortotaladicionais'
      '                WHERE itochave = @itochave;'
      '              END IF;'
      ''
      ''
      '            END IF;'
      ''
      '          END IF;'
      '        END IF;'
      ''
      '      END IF;'
      ''
      '      DELETE'
      '        FROM isi'
      '      WHERE itochave = @itochave'
      '        AND (isitipo = 0'
      '        AND tsicodigo = 3);'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.itovalorav = (ito.itovalorav),'
      '          ito.itovalorap = (ito.itovalorap),'
      
        '          ito.itototalav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade) + (itoacrescimoav * ito.itoquantidade), 2),'
      
        '          ito.itototalap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade) + (itoacrescimoav * ito.itoquantidade), 2),'
      
        '          ito.itosaldoav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav,'
      
        '          ito.itosaldoap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav'
      '      WHERE ito.itochave = @itochave;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      ''
      ''
      ''
      '    END WHILE;'
      ''
      '    SET ErroMensagem = 8;'
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(ito.itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(ito.itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      '        orc.orcdescontoav = tito.descav,'
      '        orc.orcpercdescav = 0,'
      '        orc.orctotalav = (tito.totav - tito.descav),'
      '        orc.orcgeralap = tito.totap,'
      '        orc.orcdescontoap = tito.descap,'
      '        orc.orcpercdescap = 0,'
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        stocodigo = @stocodigo'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '    IF NOT ErroException THEN'
      ''
      '      DELETE'
      '        FROM tito;'
      '      DELETE'
      '        FROM tbrd;'
      ''
      '      DELETE'
      '        FROM tisi;'
      ''
      ''
      '      DELETE'
      '        FROM tsbi;'
      ''
      '    COMMIT;'
      ''
      '    SET pConfirma = ErroException;'
      '    SET pMensagem = '#39'Pedido gravado com sucesso !'#39';'
      '  END IF;'
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS MobGravaItensGourmet//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      
        'PROCEDURE MobGravaItensGourmet (IN pOrcChave int, IN pClbCodigo ' +
        'int, IN pFlaCodigo int, IN pTipoItem int, OUT pConfirma int, OUT' +
        ' pMensagem varchar(65000))'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      '  DECLARE vimmmodo integer DEFAULT 1;'
      '  DECLARE vcfgmgoupedidounificado integer DEFAULT 0;'
      '  DECLARE itemisi integer DEFAULT 0;'
      '  DECLARE itemsbi integer DEFAULT 0;'
      '  DECLARE trmvendarapida integer DEFAULT 0;'
      '  DECLARE immhoraimpresso datetime DEFAULT NULL;'
      ''
      ''
      ''
      '  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION BEGIN'
      '    SET ErroException = 1;'
      '    SET pConfirma = ErroException;'
      ''
      '    ROLLBACK;'
      ''
      '    SET pMensagem = (SELECT'
      
        '        CASE WHEN ErroMensagem = 1 THEN '#39'1 - Erro nao identifica' +
        'do.'#39' WHEN ErroMensagem = 2 THEN '#39'2 - Nao foi possivel verificar ' +
        'se existe itens da mesa.'#39' WHEN ErroMensagem = 3 THEN '#39'3 - Nao fo' +
        'i possivel gravar itens da mesa.'#39' WHEN ErroMensagem = 4 THEN '#39'4 ' +
        '- Nao foi possivel gerar pedido na cozinha.'#39' WHEN ErroMensagem =' +
        ' 5 THEN '#39'5 - Nao foi possivel gravar itens, cozinha ja encerrou ' +
        'as atividades.'#39' WHEN ErroMensagem = 6 THEN '#39'6 - Nao foi possivel' +
        ' registrar dados auxiliares dos itens.'#39' WHEN ErroMensagem = 7 TH' +
        'EN '#39'7 - Nao foi possivel registrar mudancas de ingredientes.'#39' WH' +
        'EN ErroMensagem = 8 THEN '#39'8 - Nao foi possivel liberar pedido pa' +
        'ra impressao.'#39' ELSE ErroMensagem END'
      '      FROM dual);'
      '  END;'
      ''
      '  DROP TABLE IF EXISTS tsbi;'
      '  DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '    ID int NOT NULL AUTO_INCREMENT,'
      '    sbrcodigo int,'
      '    sbiobs varchar(100),'
      '    bprchave int,'
      '    sbiitem int,'
      '    PRIMARY KEY (ID)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  START TRANSACTION;'
      ''
      '    SET @vcfgmgoupedidounificado = (SELECT'
      '        cfgmgoupedidounificado'
      '      FROM cfgmgou LIMIT 1);'
      ''
      '    IF @vcfgmgoupedidounificado = 1 THEN'
      '      SET @vimmmodo = 9;'
      '    END IF;'
      ''
      '    IF @vcfgmgoupedidounificado = 0 THEN'
      '      SET @vimmmodo = 1;'
      '    END IF;'
      ''
      '    SET @stocodigo = (SELECT'
      '        stocodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    IF @stocodigo IN (1, 2) THEN'
      '      UPDATE orc'
      '      SET stocodigo = 1'
      '      WHERE orcchave = pOrcChave;'
      '    END IF;'
      ''
      '    SET ErroMensagem = 2;'
      ''
      '    SET @item = IFNULL((SELECT'
      '        MAX(itoitem)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChave), 0);'
      '    SET @qtd = (SELECT'
      '        COUNT(*)'
      '      FROM tito);'
      ''
      '    SET ErroMensagem = 4;'
      ''
      '    SET @MocCodigo = (SELECT'
      '        orc.moccodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    SET @clbcodigo = (SELECT'
      '        clbcodigo'
      '      FROM tito LIMIT 1);'
      ''
      '    IF @MocCodigo = 5 THEN'
      ''
      '      SET @cznchave = (SELECT'
      '          cznchave'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL LIMIT 1);'
      ''
      '      SET @immnumepedido = (SELECT'
      '          (IFNULL(MAX(imm.immnumepedido), 0) + 1) immnumepedido'
      '        FROM imm'
      '        WHERE imm.cznchave = @cznchave'
      '        AND imm.immmodo = 1);'
      ''
      '      IF @immnumepedido < IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000) THEN'
      '        SET @immnumepedido = IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000);'
      '      END IF;'
      ''
      '    END IF;'
      ''
      '    SET @posicao = 1;'
      ''
      '    SET @itemisi = 0;'
      '    SET @itemisi1 = 0;'
      ''
      '    SET @valortotaladicionais = 0;'
      ''
      '    WHILE (@posicao <= @qtd) DO'
      '      SET @valortotaladicionais = 0;'
      ''
      '      SET ErroMensagem = 3;'
      ''
      '      SET @item = (@item + 1);'
      '      SET @itemisi = (@itemisi + 1);'
      ''
      '      INSERT INTO ito (itochave'
      '      , orcchave'
      '      , procodigo'
      '      , puncodigo'
      '      , unicodigo'
      '      , stocodigo'
      '      , tdecodigo'
      '      , itoquantidade'
      '      , itovalorav'
      '      , itodescontoav'
      '      , itototalav'
      '      , itosaldoav'
      '      , itovalorap'
      '      , itodescontoap'
      '      , itototalap'
      '      , itosaldoap'
      '      , itocontendo'
      '      , itoproservico'
      '      , itoprocomple'
      '      , itodataalter'
      '      , itoitem'
      '      , itogint'
      '      , itopercdescap'
      '      , itopercdescav'
      '      , itoinfadprod'
      '      , itoquanticondi'
      '      , itoquantidevolcondi'
      '      , vrpcodigo'
      '      , itoobs'
      '      , flacodigo'
      '      , clbatendente'
      '      , oricodigo)'
      ''
      '        (SELECT'
      '          @novachave,'
      '          pOrcChave,'
      '          tito.procodigo,'
      '          tito.puncodigo,'
      '          uni.unicodigo,'
      '          2,'
      '          1,'
      '          tito.qtde,'
      '          pun.punprecoav,'
      '          0,'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          pun.punprecoap,'
      '          0,'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          pun.punmultiplicador,'
      '          '#39#39','
      '          '#39#39','
      '          CURRENT_DATE(),'
      '          @item,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          NULL,'
      '          tito.obs,'
      '          pFlaCodigo,'
      '          clbcodigo,'
      '          6'
      '        FROM tito'
      '          INNER JOIN pun'
      '            ON tito.puncodigo = pun.puncodigo'
      '          INNER JOIN uni'
      '            ON pun.unicodigo = uni.unicodigo'
      '        WHERE tito.ID = @posicao);'
      ''
      ''
      ''
      ''
      ''
      '      IF (SELECT'
      '            ROW_COUNT()) > 0 THEN'
      '        SET @itochave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      '        SELECT'
      '          procodigo,'
      '          obs,'
      '          sfnid,'
      '          sfncodigo,'
      '          copos,'
      '          pratos'
      '        FROM tito'
      '        WHERE tito.ID = @posicao INTO @procodigo'
      '        , @obs'
      '        , @sfnid'
      '        , @sfncodigo'
      '        , @copos'
      '        , @pratos;'
      ''
      ''
      ''
      ''
      '        IF @MocCodigo = 5 THEN'
      '          SET ErroMensagem = 6;'
      ''
      ''
      '          SELECT'
      '            gri.griminuretardo,'
      '            gri.tcicodigo'
      '          FROM gri'
      '            INNER JOIN pro'
      '              ON pro.grpcodigo = gri.grpcodigo'
      '            INNER JOIN ito'
      '              ON pro.procodigo = ito.procodigo'
      '          WHERE ito.itochave = @itochave INTO @griminuretardo'
      '          , @tcicodigo;'
      ''
      '          SET ErroMensagem = 61;'
      ''
      '          SET @immhoraimpresso = IFNULL((SELECT'
      '              NOW()'
      '            FROM trm'
      '            WHERE trmmesavendarapida IN (SELECT'
      '                orcmesa'
      '              FROM orc'
      '              WHERE orcchave = pOrcChave) LIMIT 1), NULL);'
      ''
      '          SET ErroMensagem = 162;'
      ''
      '          INSERT INTO imm (itochave'
      '          , tcicodigo'
      '          , immmodo'
      '          , cznchave'
      '          , immtemporetardo'
      '          , immnumepedido'
      '          , immhorapedido'
      '          , trmcodigo'
      '          , immdestino'
      '          , immcopos'
      '          , immpratos'
      '          , clbcodigo'
      '          , immhoraimpresso)'
      ''
      
        '            VALUES (@itochave, @tcicodigo, @vimmmodo, @cznchave,' +
        ' @griminuretardo, @immnumepedido, NOW(), 1, 1, @copos, @pratos, ' +
        'pClbCodigo, @immhoraimpresso);'
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      '          IF @sfncodigo > 0 THEN'
      ''
      '            SELECT'
      '              COUNT(brdcodigo)'
      ''
      '            FROM tbrd'
      '            WHERE tbrd.sfnid = @sfnid'
      '            AND tbrd.sfncodigo = @sfncodigo INTO @qtdbordas;'
      ''
      '            IF @qtdbordas > 0 THEN'
      '              INSERT INTO bri (brichave'
      '              , itochave'
      '              , brdcodigo'
      '              , briincluir)'
      '                (SELECT'
      '                  @novachave,'
      '                  @itochave,'
      '                  brdcodigo,'
      '                  1'
      '                FROM tbrd'
      '                WHERE tbrd.sfnid = @sfnid'
      '                AND tbrd.sfncodigo = @sfncodigo);'
      ''
      ''
      '              SET ErroMensagem = 71;'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      ''
      '                SET @vlborda = IFNULL((SELECT'
      '                    pun.punprecoav punprecoav'
      '                  FROM bri'
      '                    INNER JOIN ito'
      '                      ON bri.itochave = ito.itochave'
      '                    INNER JOIN brd'
      '                      ON bri.brdcodigo = brd.brdcodigo'
      '                    INNER JOIN pro'
      '                      ON brd.procodigo = pro.procodigo'
      '                    INNER JOIN pun'
      '                      ON pro.procodigo = pun.procodigo'
      '                      AND ito.unicodigo = pun.unicodigo'
      '                  WHERE bri.itochave = @itochave LIMIT 1), 0);'
      ''
      '                SET ErroMensagem = 72;'
      ''
      '                IF @vlborda > 0 THEN'
      '                  UPDATE ito'
      
        '                  SET ito.itovalorav = (ito.itovalorav + @vlbord' +
        'a),'
      
        '                      ito.itovalorap = (ito.itovalorap + @vlbord' +
        'a),'
      
        '                      ito.itototalav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itototalap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itosaldoav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2) - ito.itodescontoav,'
      
        '                      ito.itosaldoap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2) - ito.itodescontoav'
      ''
      '                  WHERE ito.itochave = @itochave;'
      '                END IF;'
      '              END IF;'
      ''
      ''
      '            END IF;'
      ''
      '            DELETE'
      '              FROM tsbi;'
      ''
      '            SET ErroMensagem = 73;'
      ''
      '            DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '            CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '              ID int NOT NULL AUTO_INCREMENT,'
      '              sbrcodigo int,'
      '              sbiobs varchar(100),'
      '              bprchave int,'
      '              sbiitem int,'
      '              PRIMARY KEY (ID)'
      '            ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '            SET @novasbiid = 0;'
      ''
      '            SET ErroMensagem = 74;'
      ''
      '            INSERT INTO tsbi'
      '              (SELECT'
      '                tisi.ID,'
      '                tisi.sbrcodigo,'
      '                tisi.obs,'
      '                tisi.bprchave,'
      '                tisi.isiitem'
      '              FROM tisi'
      '              WHERE tisi.isitipo = 2);'
      ''
      ''
      ''
      ''
      ''
      '            SET @possbi = 1;'
      ''
      '            SET ErroMensagem = 74;'
      ''
      '            WHILE (@possbi <= @posicao) DO'
      '              INSERT INTO sbi (sbichave'
      '              , itochave'
      '              , sbrcodigo'
      '              , sbiobs'
      '              , bprchave'
      '              , sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  tsbi.sbrcodigo,'
      '                  tsbi.sbiobs,'
      '                  tsbi.bprchave,'
      '                  tsbi.sbiitem'
      '                FROM tsbi'
      '                WHERE tsbi.sbiitem = @item);'
      ''
      '              SET ErroMensagem = 75;'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      ''
      '                SET @sbrcodigo = (SELECT'
      '                    sbrcodigo'
      '                  FROM sbi'
      '                  WHERE sbichave = @sbichave);'
      ''
      '                SET ErroMensagem = 76;'
      ''
      '                INSERT INTO isi (isichave'
      '                , sbichave'
      '                , tsicodigo'
      '                , procodigo'
      '                , itochave'
      '                , isiitem'
      '                , isitipo'
      '                , isiquantidade)'
      '                  (SELECT'
      '                    @novachave,'
      '                    (SELECT'
      '                        sbichave'
      '                      FROM sbi'
      '                      WHERE itochave = @itochave'
      '                      AND sbrcodigo = tisi.sbrcodigo) sbichave,'
      '                    tisi.tsicodigo,'
      '                    tisi.procodigo,'
      '                    @itochave,'
      '                    tisi.isiitem,'
      '                    tisi.isitipo,'
      '                    tisi.isiquantidade'
      '                  FROM tisi'
      ''
      '                  WHERE tisi.isitipo != 2);'
      ''
      '                SET ErroMensagem = 77;'
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      ''
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      ''
      '                  IF (@valortotaladicionais IS NOT NULL) THEN'
      '                    UPDATE ito'
      
        '                    SET itoacrescimoav = itoacrescimoav + @valor' +
        'totaladicionais'
      '                    WHERE itochave = @itochave;'
      '                  END IF;'
      '                  SET ErroMensagem = 78;'
      ''
      '                END IF;'
      ''
      '              END IF;'
      '              SET @possbi = (@possbi + 1);'
      '              SET @valortotaladicionais = 0;'
      '            END WHILE;'
      ''
      ''
      '            SET ErroMensagem = 78;'
      ''
      ''
      ''
      ''
      ''
      '          ELSE'
      ''
      '            IF (SELECT'
      '                  COUNT(*)'
      '                FROM tisi) = 0 THEN'
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  sbr.sbrcodigo,'
      '                  @obs,'
      '                  1'
      '                FROM sbr'
      '                WHERE sbr.procodigo = @procodigo LIMIT 1);'
      '            ELSE'
      '              SET ErroMensagem = 79;'
      ''
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.bprchave'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novachave,'
      '                  @itochave,'
      '                  tisi.sbrcodigo,'
      
        '                  IF(IFNULL(tisi.obs, '#39#39') != '#39#39', tisi.obs, @obs)' +
        ','
      '                  tisi.bprchave,'
      '                  tisi.isiitem'
      '                FROM tisi'
      '                  INNER JOIN sbr'
      '                    ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                WHERE sbr.procodigo = @procodigo LIMIT 1);'
      ''
      ''
      ''
      '              SET ErroMensagem = 80;'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      ''
      '                INSERT INTO isi (isichave'
      '                , sbichave'
      '                , tsicodigo'
      '                , procodigo'
      '                , itochave'
      '                , isiitem'
      '                , isitipo'
      '                , isiquantidade)'
      '                  (SELECT DISTINCT'
      '                    @novachaveisi,'
      '                    @sbichave,'
      '                    tisi.tsicodigo,'
      '                    tisi.procodigo,'
      '                    @itochave,'
      '                    @itemisi,'
      '                    tisi.isitipo,'
      '                    tisi.isiquantidade'
      '                  FROM tisi'
      '                    INNER JOIN sbr'
      '                      ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                  WHERE sbr.procodigo = @procodigo);'
      '                SET ErroMensagem = 81;'
      ''
      ''
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      '                  SET ErroMensagem = 82;'
      ''
      '                  IF (@valortotaladicionais IS NOT NULL) THEN'
      ''
      '                    UPDATE ito'
      
        '                    SET itoacrescimoav = itoacrescimoav + @valor' +
        'totaladicionais'
      '                    WHERE itochave = @itochave;'
      '                  END IF;'
      ''
      ''
      '                END IF;'
      '              END IF;'
      '            END IF;'
      ''
      '          END IF;'
      '        END IF;'
      ''
      '      END IF;'
      ''
      '      SET ErroMensagem = 83;'
      '      UPDATE ito'
      '      SET ito.itovalorav = (ito.itovalorav),'
      '          ito.itovalorap = (ito.itovalorap),'
      
        '          ito.itototalav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade) + (itoacrescimoav * ito.itoquantidade), 2),'
      
        '          ito.itototalap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade) + (itoacrescimoav * ito.itoquantidade), 2),'
      
        '          ito.itosaldoav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav,'
      
        '          ito.itosaldoap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav'
      '      WHERE ito.itochave = @itochave;'
      ''
      ''
      '      SET ErroMensagem = 84;'
      ''
      '      SET @posicao = @posicao + 1;'
      '      SET @valortotaladicionais = 0;'
      '    END WHILE;'
      ''
      '    SET ErroMensagem = 8;'
      '    SET ErroMensagem = 85;'
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(ito.itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(ito.itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      '        orc.orcdescontoav = tito.descav,'
      '        orc.orcpercdescav = 0,'
      '        orc.orctotalav = (tito.totav - tito.descav),'
      '        orc.orcgeralap = tito.totap,'
      '        orc.orcdescontoap = tito.descap,'
      '        orc.orcpercdescap = 0,'
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        stocodigo = @stocodigo'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '    IF NOT ErroException THEN'
      ''
      '      DELETE'
      '        FROM tito;'
      '      DELETE'
      '        FROM tbrd;'
      ''
      '      DELETE'
      '        FROM tisi;'
      ''
      '      DELETE'
      '        FROM tsbi;'
      ''
      '      DELETE'
      '        FROM trdc;'
      ''
      '    COMMIT;'
      ''
      '    SET pConfirma = ErroException;'
      '    SET pMensagem = '#39'Pedido gravado com sucesso !'#39';'
      '  END IF;'
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav - @totalservicos,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      oricodigo,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmoutras'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmacrescimoav)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        0,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        ito.itovalorav + itoacrescimoav itoacrescimoav,'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      '        IF((SELECT'
      '            tpocodigo'
      '          FROM pro p'
      
        '          WHERE p.procodigo = ito.procodigo) = 0, 0, (@totalserv' +
        'icos) * ((itototalav - itooutras) / (@totalgeral)))'
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END'
      '//'
      '')
    Delimiter = '//'
    Left = 1000
    Top = 280
  end
  object us001253: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS FechaMesaParcial//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesaParcial (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT DISTINCT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      ''
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = @OrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      ''
      '  SET pConfirma = @Confirma;'
      ''
      ''
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      ''
      ''
      ''
      '  SET pLteChave = 0;'
      ''
      ''
      '  SET pMesChave = 0;'
      ''
      ''
      '  SET @meschave = 0;'
      ''
      ''
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      '    IF pTipo = 1 THEN'
      ''
      ''
      '      SET @qtdItem = (SELECT'
      '          COUNT(*)'
      '        FROM titem);'
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      ''
      '        SET @ContaItem = 1;'
      ''
      ''
      ''
      '        SET ErroMensagem = 1;'
      ''
      ''
      ''
      '        INSERT INTO orc (orcchave'
      '        , etdcodigo'
      '        , clbcodigo'
      '        , fopcodigo'
      '        , tdecodigo'
      '        , stocodigo'
      '        , moccodigo'
      '        , foacodigo'
      '        , trmcodigo'
      '        , tfpcodigo'
      '        , puocodigo'
      '        , orcdataabert'
      '        , orchoraabert'
      '        , orcgeralav'
      '        , orcdescontoav'
      '        , orcpercdescav'
      '        , orctotalav'
      '        , orcgeralap'
      '        , orcdescontoap'
      '        , orcpercdescap'
      '        , orctotalap'
      '        , orcobs'
      '        , orcdestimpre'
      '        , edritem'
      '        , edrcodigo'
      '        , clbvendedor'
      '        , orcmesa'
      '        , orctelefone'
      '        , ccxchave'
      '        , cznchave)'
      '          SELECT'
      '            @novachave,'
      '            etdcodigo,'
      '            pClbCodigo,'
      '            fopcodigo,'
      '            tdecodigo,'
      '            3,'
      '            moccodigo,'
      '            foacodigo,'
      '            trmcodigo,'
      '            tfpcodigo,'
      '            puocodigo,'
      '            orcdataabert,'
      '            TIME(NOW()),'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            orcobs,'
      '            orcdestimpre,'
      '            edritem,'
      '            edrcodigo,'
      '            pClbCodigo,'
      '            orcmesa,'
      '            orctelefone,'
      '            ccxchave,'
      '            cznchave'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '        IF (ROW_COUNT() > 0) THEN'
      ''
      '          SET @orcchave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      ''
      '          SET ErroMensagem = 2;'
      ''
      ''
      ''
      '          SET @troqtd = 0;'
      ''
      ''
      '          SET @troqtd = (SELECT DISTINCT'
      '              COUNT(orcchaveorigem)'
      '            FROM tro'
      '            WHERE orcchaveorigem = pOrcChave'
      '            AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '          IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '            SET @orcchaveinicial = IFNULL((SELECT'
      '                orcchaveorigem'
      '              FROM tro'
      '              WHERE orcchavedestino = pOrcChave'
      '              ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '            INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '              VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE ' +
        'KEY UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = ' +
        '@orcchave;'
      ''
      ''
      '          END IF;'
      ''
      ''
      ''
      ''
      ''
      '          SET @item = 0;'
      ''
      ''
      '          WHILE (@ContaItem <= @qtdItem) DO'
      ''
      '            SET @item = @item + 1;'
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 3;'
      ''
      ''
      ''
      ''
      '            SELECT'
      '              titem.itochave,'
      '              qtde'
      '            FROM titem'
      '            WHERE titem.ID = @ContaItem INTO @itochave'
      '            , @qtde;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 4;'
      ''
      ''
      ''
      ''
      '            INSERT INTO ito (itochave'
      '            , orcchave'
      '            , procodigo'
      '            , puncodigo'
      '            , unicodigo'
      '            , stocodigo'
      '            , tdecodigo'
      '            , itoquantidade'
      '            , itovalorav'
      '            , itototalav'
      '            , itodescontoav'
      '            , itosaldoav'
      '            , itovalorap'
      '            , itototalap'
      '            , itodescontoap'
      '            , itosaldoap'
      '            , itocontendo'
      '            , itoproservico'
      '            , itoprocomple'
      '            , itodataalter'
      '            , itoitem'
      '            , itogint'
      '            , itopercdescap'
      '            , itopercdescav'
      '            , itoinfadprod'
      '            , itoquanticondi'
      '            , itoquantidevolcondi'
      '            , vrpcodigo'
      '            , itoobs'
      '            , itoacrescimoav'
      '            , clbatendente'
      '            , oricodigo'
      '            , itooutras)'
      '              SELECT'
      '                @novoito,'
      '                @orcchave,'
      '                ito.procodigo,'
      '                puncodigo,'
      '                unicodigo,'
      '                3,'
      '                tdecodigo,'
      '                @qtde,'
      '                itovalorav + itoacrescimoav,'
      '                (@qtde * (itovalorav + itoacrescimoav)),'
      
        '                ROUND(((itovalorav + itoacrescimoav) * @percdesc' +
        ') * @qtde, 2),'
      
        '                (((itovalorav + itoacrescimoav) * @qtde) - (ROUN' +
        'D(((itovalorav + itoacrescimoav) * @percdesc) * @qtde, 2))),'
      '                itovalorap,'
      '                (@qtde * itovalorap),'
      '                ROUND((itototalap * @percdesc), 2),'
      '                (itototalap - itodescontoap),'
      '                itocontendo,'
      '                itoproservico,'
      '                itoprocomple,'
      '                CURRENT_DATE(),'
      '                @item,'
      '                itogint,'
      '                ROUND(@percdesc, 3),'
      '                ROUND(@percdesc, 3),'
      '                itoinfadprod,'
      '                itoquanticondi,'
      '                itoquantidevolcondi,'
      '                vrpcodigo,'
      '                itoobs,'
      '                itoacrescimoav,'
      '                clbatendente,'
      '                6,'
      '                itooutras'
      '              FROM ito'
      '              WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      '            SET @immitochave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      ''
      ''
      ''
      '            INSERT INTO imm (immchave,'
      '            itochave,'
      '            tcicodigo,'
      '            immimpresso,'
      '            immentregue,'
      '            immmodo,'
      '            ccxchave,'
      '            immhorapedido,'
      '            immhoraentrega,'
      '            immrecebido,'
      '            dorchave,'
      '            immnumepedido,'
      '            trmcodigo,'
      '            immdestino,'
      '            immidentificacao,'
      '            immgarsom,'
      '            immtemporetardo,'
      '            immmodoimpressao,'
      '            cznchave,'
      '            etdcodigoent,'
      '            immpratos,'
      '            immcopos,'
      '            immnumepedidoint,'
      '            clbcodigo,'
      '            immhoraimpresso,'
      '            immhoraimprimir,'
      '            immhoraentregadopedido,'
      '            immhoranotificadopedido,'
      '            immhorasaidadopedido)'
      '              SELECT'
      '                @novaimmchave,'
      '                @immitochave,'
      '                tcicodigo,'
      '                immimpresso,'
      '                immentregue,'
      '                immmodo,'
      '                ccxchave,'
      '                immhorapedido,'
      '                immhoraentrega,'
      '                immrecebido,'
      '                dorchave,'
      '                immnumepedido,'
      '                trmcodigo,'
      '                immdestino,'
      '                immidentificacao,'
      '                immgarsom,'
      '                immtemporetardo,'
      '                immmodoimpressao,'
      '                cznchave,'
      '                etdcodigoent,'
      '                immpratos,'
      '                immcopos,'
      '                immnumepedidoint,'
      '                clbcodigo,'
      '                immhoraimpresso,'
      '                immhoraimprimir,'
      '                immhoraentregadopedido,'
      '                immhoranotificadopedido,'
      '                immhorasaidadopedido'
      '              FROM imm'
      '              WHERE itochave = @itochave;'
      ''
      '            UPDATE imp'
      '            SET itochave = @immitochave'
      '            WHERE imp.itochave = @itochave;'
      ''
      ''
      ''
      '            SELECT'
      '              COUNT(itochave)'
      '            FROM sbi'
      '            WHERE sbi.itochave = @itochave INTO @qtdItemSbi;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItemsbi = 1;'
      ''
      ''
      ''
      '            WHILE (@ContaItemsbi <= @qtdItemSbi) DO'
      ''
      ''
      '              INSERT INTO sbi'
      '                (SELECT'
      '                  @outrachave,'
      '                  @immitochave,'
      '                  sbrcodigo,'
      '                  sbiobs,'
      '                  sbiitem,'
      '                  bprchave'
      '                FROM sbi'
      '                WHERE itochave = @itochave'
      '                AND sbi.sbiitem = @ContaItemsbi);'
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @ultimosbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      '              END IF;'
      ''
      ''
      ''
      ''
      '              SELECT'
      '                COUNT(itochave)'
      '              FROM isi'
      '              WHERE itochave = @itochave'
      '              AND isiitem = @ContaItemsbi INTO @qtdItemisi;'
      ''
      ''
      ''
      ''
      '              IF @qtdItemisi > 0 THEN'
      ''
      ''
      '                INSERT INTO isi'
      '                  (SELECT'
      '                    @novaisichave,'
      '                    @ultimosbichave,'
      '                    tsicodigo,'
      '                    procodigo,'
      '                    isitipo,'
      '                    @immitochave,'
      '                    isiitem,'
      '                    isiquantidade,'
      '                    0'
      '                  FROM isi'
      '                  WHERE itochave = @itochave'
      '                  AND isiitem = @ContaItemsbi);'
      ''
      '              END IF;'
      ''
      ''
      ''
      '              SET @ContaItemsbi = @ContaItemsbi + 1;'
      ''
      ''
      '            END WHILE;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 5;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            UPDATE ito'
      '            SET ito.itoquantidade = (ito.itoquantidade - @qtde),'
      
        '                ito.itototalav = (ito.itoquantidade * ito.itoval' +
        'orav),'
      
        '                ito.itosaldoav = (ito.itototalav - itodescontoav' +
        '),'
      
        '                ito.itototalap = (ito.itoquantidade * ito.itoval' +
        'orap),'
      '                ito.itosaldoap = (itototalap - itodescontoap)'
      '            WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItem = @ContaItem + 1;'
      ''
      ''
      '          END WHILE;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 6;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      '              orc.orcdescontoav = tito.descav,'
      
        '              orc.orcpercdescav = IF(tito.descav > 0, (tito.desc' +
        'av / tito.totav), 0),'
      '              orc.orctotalav = (tito.totav - tito.descav),'
      '              orc.orcgeralap = tito.totap,'
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = @orcchave;'
      ''
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '              orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      '        SET ErroMensagem = 8;'
      ''
      ''
      
        '        CALL RegistraMes(@orcchave, pClbCodigo, ErroMensagem, pC' +
        'onfirma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 10;'
      ''
      ''
      ''
      ''
      '        SET @troqtd = 0;'
      ''
      ''
      '        SET @troqtd = (SELECT DISTINCT'
      '            COUNT(orcchaveorigem)'
      '          FROM tro'
      '          WHERE orcchaveorigem = pOrcChave'
      '          AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '        IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '          SET @orcchaveinicial = IFNULL((SELECT'
      '              orcchaveorigem'
      '            FROM tro'
      '            WHERE orcchavedestino = pOrcChave'
      '            ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '          INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '            VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE KE' +
        'Y UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = @o' +
        'rcchave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 11;'
      ''
      ''
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, @OrcChave, @ltechave, pNome, 1);'
      '      ELSE'
      ''
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, pOrcChave, @ltechave, pNome, 0);'
      '      END IF;'
      ''
      ''
      ''
      '      IF (@qtdItem > 0)'
      '        AND (@orcchave > 0) THEN'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = @orcchave'
      '          AND dtl.mdacodigo != 7);'
      ''
      ''
      '        IF @VlrFechamento > 0 THEN'
      ''
      ''
      '          SET @etdcodigo = (SELECT'
      '              etdcodigo'
      '            FROM orc'
      '            WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      '          SET ErroMensagem = 15;'
      ''
      ''
      '          OPEN curlote;'
      '        read_loop:'
      '          LOOP'
      ''
      '            FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '            IF done THEN'
      ''
      '              LEAVE read_loop;'
      '            END IF;'
      ''
      ''
      '            SET @VlrFechamento = (SELECT'
      '                SUM(dtl.dtlvalor) dtlvalor'
      '              FROM dtl'
      '                INNER JOIN olt'
      '                  ON dtl.ltechave = olt.ltechave'
      '              WHERE olt.orcchave = @orcchave'
      '              AND dtl.ltechave = lote'
      '              AND dtl.mdacodigo = modalidade'
      '              AND dtl.mdacodigo != 7);'
      ''
      '            DELETE'
      '              FROM trfi'
      '            WHERE mdacodigo <> modalidade;'
      ''
      '            INSERT INTO trfi (ID'
      '            , etdcodigo'
      '            , mdacodigo'
      '            , tfdcodigo'
      '            , numparc'
      '            , dtvecto'
      '            , vlrparcela'
      '            , numero)'
      
        '              VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_' +
        'DATE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '            SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '            CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, ErroMe' +
        'nsagem, @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 9;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          END LOOP;'
      ''
      ''
      '          CLOSE curlote;'
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      ''
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            @MesChave'
      '          FROM olt'
      '            INNER JOIN mlt'
      '              ON olt.ltechave = mlt.ltechave'
      '            INNER JOIN mfi'
      '              ON mlt.mfichave = mfi.mfichave'
      '          WHERE olt.orcchave = @OrcChave);'
      ''
      '      END IF;'
      ''
      ''
      ''
      '    ELSE'
      ''
      ''
      '      SET ErroMensagem = 13;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      INSERT INTO olt (oltchave'
      '      , orcchave'
      '      , ltechave'
      '      , oltidentificacao'
      '      , olttipo)'
      
        '        VALUE (@novachave, @orcchave, @ltechave, pNome, pTipoFec' +
        'hamento);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET @LteDesconto = IFNULL((SELECT'
      '          SUM(lte.ltedesconto)'
      '        FROM olt'
      '          INNER JOIN lte'
      '            ON olt.ltechave = lte.ltechave'
      '        WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '      SET @OrcTotalAv = (SELECT'
      '          SUM(itovalorav * itoquantidade) totav'
      '        FROM ito'
      '        WHERE orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '      IF @LteDesconto > 0 THEN'
      ''
      ''
      '        SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '        UPDATE ito'
      '        SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '            itosaldoav = (ito.itototalav - itodescontoav),'
      '            itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '            itosaldoap = (ito.itototalav - itodescontoav),'
      '            itopercdescap = ROUND(@percdesc, 3),'
      '            itopercdescav = ROUND(@percdesc, 3)'
      '        WHERE ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '        SET @centavos = @LteDesconto - (SELECT'
      '            SUM(itodescontoav)'
      '          FROM ito'
      '          WHERE ito.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '        IF @centavos <> 0 THEN'
      ''
      '          UPDATE ito'
      '          SET itodescontoav = itodescontoav + @centavos,'
      '              itodescontoap = itodescontoap + @centavos,'
      '              itosaldoav = itosaldoav + @centavos,'
      '              itosaldoap = itosaldoap + @centavos'
      '          WHERE ito.orcchave = pOrcChave;'
      ''
      '        END IF;'
      ''
      ''
      ''
      '        UPDATE orc'
      '        INNER JOIN (SELECT'
      '            ito.orcchave,'
      '            SUM(itototalav) totav,'
      '            SUM(itodescontoav) descav,'
      '            SUM(itototalap) totap,'
      '            SUM(itodescontoap) descap'
      '          FROM ito'
      '          WHERE stocodigo != 88'
      '          GROUP BY ito.orcchave) tito'
      '          ON tito.orcchave = orc.orcchave'
      '        SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '            orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '            orc.orcdescontoav = tito.descap,'
      
        '            orc.orcpercdescav = IF(tito.descap > 0, (tito.descap' +
        ' / tito.totap), 0),'
      '            orc.orctotalap = (tito.totap - tito.descap)'
      '        WHERE orc.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '      CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pCon' +
        'firma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET ErroMensagem = 14;'
      ''
      ''
      ''
      '      SET @VlrFechamento = (SELECT'
      '          SUM(dtl.dtlvalor) dtlvalor'
      '        FROM dtl'
      '          INNER JOIN olt'
      '            ON dtl.ltechave = olt.ltechave'
      '        WHERE olt.orcchave = pOrcChave'
      '        AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '      IF @VlrFechamento > 0 THEN'
      ''
      ''
      '        SET @etdcodigo = (SELECT'
      '            etdcodigo'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        OPEN curlote;'
      '      read_loop:'
      '        LOOP'
      ''
      '          FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '          IF done THEN'
      ''
      '            LEAVE read_loop;'
      '          END IF;'
      ''
      '          SET @VlrFechamento = (SELECT'
      '              SUM(dtl.dtlvalor) dtlvalor'
      '            FROM dtl'
      '              INNER JOIN olt'
      '                ON dtl.ltechave = olt.ltechave'
      '            WHERE olt.orcchave = pOrcChave'
      '            AND dtl.ltechave = lote'
      '            AND dtl.mdacodigo = modalidade'
      '            AND dtl.mdacodigo != 7);'
      ''
      ''
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '            VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DA' +
        'TE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '          SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '          CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem,' +
        ' @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 17;'
      ''
      ''
      ''
      '          INSERT INTO rfm (rfmchave'
      '          , rfichave'
      '          , meschave)'
      ''
      '            (SELECT DISTINCT'
      '              @novachave,'
      '              rfichave,'
      '              @MesChave'
      '            FROM olt'
      '              INNER JOIN mlt'
      '                ON olt.ltechave = mlt.ltechave'
      '              INNER JOIN mfi'
      '                ON mlt.mfichave = mfi.mfichave'
      '            WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '        END LOOP;'
      ''
      ''
      '        CLOSE curlote;'
      ''
      '      END IF;'
      ''
      ''
      '      INSERT INTO rfm (rfmchave'
      '      , rfichave'
      '      , meschave)'
      ''
      '        (SELECT DISTINCT'
      '          @novachave,'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '      SET ErroMensagem = 18;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      '          orc.orcpercdescav = @percdesc,'
      '          orc.orctotalap = (tito.totap - tito.descap),'
      '          orc.orcdataencerr = CURRENT_DATE(),'
      '          orc.orchoraencerr = CURRENT_TIME(),'
      '          orc.stocodigo = 3'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.stocodigo = 3'
      '      WHERE ito.orcchave = pOrcChave'
      '      AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '    END IF;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END //')
    Left = 520
    Top = 344
  end
  object us001254: TUniScript
    SQL.Strings = (
      ''
      ''
      ''
      ''
      'DROP PROCEDURE IF EXISTS FechaMesa//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesa (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = pOrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 13;'
      ''
      ''
      ''
      '    INSERT INTO olt (oltchave'
      '    , orcchave'
      '    , ltechave'
      '    , oltidentificacao'
      '    , olttipo)'
      
        '      VALUE (@novachave, pOrcChave, @ltechave, pNome, pTipoFecha' +
        'mento);'
      ''
      ''
      ''
      ''
      '    SET @LteDesconto = IFNULL((SELECT'
      '        SUM(lte.ltedesconto)'
      '      FROM olt'
      '        INNER JOIN lte'
      '          ON olt.ltechave = lte.ltechave'
      '      WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '    SET @OrcTotalAv = (SELECT'
      '        SUM(itovalorav * itoquantidade) totav'
      '      FROM ito,'
      '           pro'
      '      WHERE ito.procodigo = pro.procodigo'
      '      AND ito.stocodigo <> 88'
      '      AND pro.tpocodigo = 0'
      '      AND orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    IF @LteDesconto > 0 THEN'
      ''
      ''
      '      SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '      UPDATE ito, pro'
      
        '      SET itodescontoav = ROUND(((itototalav + itoacrescimoav + ' +
        'itooutras) * @percdesc), 2),'
      '          itosaldoav = (ito.itototalav - itodescontoav),'
      '          itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '          itosaldoap = (ito.itototalav - itodescontoav),'
      '          itopercdescap = ROUND(@percdesc, 3),'
      '          itopercdescav = ROUND(@percdesc, 3)'
      '      WHERE ito.stocodigo <> 88'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo = 0'
      '      AND ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '      SET @centavos = @LteDesconto - (SELECT'
      '          SUM(itodescontoav)'
      '        FROM ito,'
      '             pro'
      '        WHERE ito.orcchave = pOrcChave'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0);'
      ''
      ''
      ''
      ''
      '      IF @centavos <> 0 THEN'
      ''
      '        UPDATE ito, pro'
      '        SET itodescontoav = itodescontoav + @centavos,'
      '            itodescontoap = itodescontoap + @centavos,'
      '            itosaldoav = itosaldoav + @centavos,'
      '            itosaldoap = itosaldoap + @centavos'
      '        WHERE ito.stocodigo <> 88'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0'
      '        AND ito.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      
        '          orc.orcpercdescav = IF(tito.descap > 0, (tito.descap /' +
        ' tito.totap), 0),'
      '          orc.orctotalap = (tito.totap - tito.descap)'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      '    END IF;'
      ''
      ''
      '    SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '    CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pConfi' +
        'rma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 14;'
      ''
      ''
      ''
      '    SET @VlrFechamento = (SELECT'
      '        SUM(dtl.dtlvalor) dtlvalor'
      '      FROM dtl'
      '        INNER JOIN olt'
      '          ON dtl.ltechave = olt.ltechave'
      '      WHERE olt.orcchave = pOrcChave'
      '      AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '    IF @VlrFechamento > 0 THEN'
      ''
      ''
      '      SET @etdcodigo = (SELECT'
      '          etdcodigo'
      '        FROM orc'
      '        WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '      SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      OPEN curlote;'
      '    read_loop:'
      '      LOOP'
      ''
      '        FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '        IF done THEN'
      ''
      '          LEAVE read_loop;'
      '        END IF;'
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade'
      '          AND dtl.mdacodigo != 7);'
      ''
      '        DELETE'
      '          FROM trfi'
      '        WHERE mdacodigo <> modalidade;'
      ''
      '        INSERT INTO trfi (ID'
      '        , etdcodigo'
      '        , mdacodigo'
      '        , tfdcodigo'
      '        , numparc'
      '        , dtvecto'
      '        , vlrparcela'
      '        , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE' +
        '(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '        CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem, @' +
        'TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 17;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      END LOOP;'
      ''
      ''
      '      CLOSE curlote;'
      ''
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      '    INSERT INTO rfm (rfichave'
      '    , meschave)'
      ''
      '      (SELECT DISTINCT'
      ''
      '        rfichave,'
      '        @MesChave'
      '      FROM olt'
      '        INNER JOIN mlt'
      '          ON olt.ltechave = mlt.ltechave'
      '        INNER JOIN mfi'
      '          ON mlt.mfichave = mfi.mfichave'
      '      WHERE olt.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '        orc.orctotalav = (tito.totav - tito.descav),'
      ''
      ''
      ''
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        orc.orcdataencerr = CURRENT_DATE(),'
      '        orc.orchoraencerr = CURRENT_TIME(),'
      '        orc.stocodigo = 3'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '    UPDATE ito'
      '    SET ito.stocodigo = 3'
      '    WHERE ito.orcchave = pOrcChave'
      '    AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS FechaMesaParcial//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesaParcial (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT DISTINCT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      ''
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = @OrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      ''
      '  SET pConfirma = @Confirma;'
      ''
      ''
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      ''
      ''
      ''
      '  SET pLteChave = 0;'
      ''
      ''
      '  SET pMesChave = 0;'
      ''
      ''
      '  SET @meschave = 0;'
      ''
      ''
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      '    IF pTipo = 1 THEN'
      ''
      ''
      '      SET @qtdItem = (SELECT'
      '          COUNT(*)'
      '        FROM titem);'
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      ''
      '        SET @ContaItem = 1;'
      ''
      ''
      ''
      '        SET ErroMensagem = 1;'
      ''
      ''
      ''
      '        INSERT INTO orc (orcchave'
      '        , etdcodigo'
      '        , clbcodigo'
      '        , fopcodigo'
      '        , tdecodigo'
      '        , stocodigo'
      '        , moccodigo'
      '        , foacodigo'
      '        , trmcodigo'
      '        , tfpcodigo'
      '        , puocodigo'
      '        , orcdataabert'
      '        , orchoraabert'
      '        , orcgeralav'
      '        , orcdescontoav'
      '        , orcpercdescav'
      '        , orctotalav'
      '        , orcgeralap'
      '        , orcdescontoap'
      '        , orcpercdescap'
      '        , orctotalap'
      '        , orcobs'
      '        , orcdestimpre'
      '        , edritem'
      '        , edrcodigo'
      '        , clbvendedor'
      '        , orcmesa'
      '        , orctelefone'
      '        , ccxchave'
      '        , cznchave)'
      '          SELECT'
      '            @novachave,'
      '            etdcodigo,'
      '            pClbCodigo,'
      '            fopcodigo,'
      '            tdecodigo,'
      '            3,'
      '            moccodigo,'
      '            foacodigo,'
      '            trmcodigo,'
      '            tfpcodigo,'
      '            puocodigo,'
      '            orcdataabert,'
      '            TIME(NOW()),'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            orcobs,'
      '            orcdestimpre,'
      '            edritem,'
      '            edrcodigo,'
      '            pClbCodigo,'
      '            orcmesa,'
      '            orctelefone,'
      '            ccxchave,'
      '            cznchave'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '        IF (ROW_COUNT() > 0) THEN'
      ''
      '          SET @orcchave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      ''
      '          SET ErroMensagem = 2;'
      ''
      ''
      ''
      '          SET @troqtd = 0;'
      ''
      ''
      '          SET @troqtd = (SELECT DISTINCT'
      '              COUNT(orcchaveorigem)'
      '            FROM tro'
      '            WHERE orcchaveorigem = pOrcChave'
      '            AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '          IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '            SET @orcchaveinicial = IFNULL((SELECT'
      '                orcchaveorigem'
      '              FROM tro'
      '              WHERE orcchavedestino = pOrcChave'
      '              ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '            INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '              VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE ' +
        'KEY UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = ' +
        '@orcchave;'
      ''
      ''
      '          END IF;'
      ''
      ''
      ''
      ''
      ''
      '          SET @item = 0;'
      ''
      ''
      '          WHILE (@ContaItem <= @qtdItem) DO'
      ''
      '            SET @item = @item + 1;'
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 3;'
      ''
      ''
      ''
      ''
      '            SELECT'
      '              titem.itochave,'
      '              qtde'
      '            FROM titem'
      '            WHERE titem.ID = @ContaItem INTO @itochave'
      '            , @qtde;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 4;'
      ''
      ''
      ''
      ''
      '            INSERT INTO ito (itochave'
      '            , orcchave'
      '            , procodigo'
      '            , puncodigo'
      '            , unicodigo'
      '            , stocodigo'
      '            , tdecodigo'
      '            , itoquantidade'
      '            , itovalorav'
      '            , itototalav'
      '            , itodescontoav'
      '            , itosaldoav'
      '            , itovalorap'
      '            , itototalap'
      '            , itodescontoap'
      '            , itosaldoap'
      '            , itocontendo'
      '            , itoproservico'
      '            , itoprocomple'
      '            , itodataalter'
      '            , itoitem'
      '            , itogint'
      '            , itopercdescap'
      '            , itopercdescav'
      '            , itoinfadprod'
      '            , itoquanticondi'
      '            , itoquantidevolcondi'
      '            , vrpcodigo'
      '            , itoobs'
      '            , itoacrescimoav'
      '            , clbatendente'
      '            , oricodigo'
      '            , itooutras)'
      '              SELECT'
      '                @novoito,'
      '                @orcchave,'
      '                ito.procodigo,'
      '                puncodigo,'
      '                unicodigo,'
      '                3,'
      '                tdecodigo,'
      '                @qtde,'
      '                itovalorav + itoacrescimoav,'
      
        '                (@qtde * (itovalorav + itoacrescimoav + itooutra' +
        's)),'
      
        '                ROUND(((itovalorav + itoacrescimoav + itooutras)' +
        ' * @percdesc) * @qtde, 2),'
      
        '                (((itovalorav + itoacrescimoav + itooutras) * @q' +
        'tde) - (ROUND(((itovalorav + itoacrescimoav + itooutras) * @perc' +
        'desc) * @qtde, 2))),'
      '                itovalorap,'
      '                (@qtde * itovalorap),'
      '                ROUND((itototalap * @percdesc), 2),'
      '                (itototalap - itodescontoap),'
      '                itocontendo,'
      '                itoproservico,'
      '                itoprocomple,'
      '                CURRENT_DATE(),'
      '                @item,'
      '                itogint,'
      '                ROUND(@percdesc, 3),'
      '                ROUND(@percdesc, 3),'
      '                itoinfadprod,'
      '                itoquanticondi,'
      '                itoquantidevolcondi,'
      '                vrpcodigo,'
      '                itoobs,'
      '                itoacrescimoav,'
      '                clbatendente,'
      '                6,'
      '                itooutras'
      '              FROM ito'
      '              WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      '            SET @immitochave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      ''
      ''
      ''
      '            INSERT INTO imm (immchave,'
      '            itochave,'
      '            tcicodigo,'
      '            immimpresso,'
      '            immentregue,'
      '            immmodo,'
      '            ccxchave,'
      '            immhorapedido,'
      '            immhoraentrega,'
      '            immrecebido,'
      '            dorchave,'
      '            immnumepedido,'
      '            trmcodigo,'
      '            immdestino,'
      '            immidentificacao,'
      '            immgarsom,'
      '            immtemporetardo,'
      '            immmodoimpressao,'
      '            cznchave,'
      '            etdcodigoent,'
      '            immpratos,'
      '            immcopos,'
      '            immnumepedidoint,'
      '            clbcodigo,'
      '            immhoraimpresso,'
      '            immhoraimprimir,'
      '            immhoraentregadopedido,'
      '            immhoranotificadopedido,'
      '            immhorasaidadopedido)'
      '              SELECT'
      '                @novaimmchave,'
      '                @immitochave,'
      '                tcicodigo,'
      '                immimpresso,'
      '                immentregue,'
      '                immmodo,'
      '                ccxchave,'
      '                immhorapedido,'
      '                immhoraentrega,'
      '                immrecebido,'
      '                dorchave,'
      '                immnumepedido,'
      '                trmcodigo,'
      '                immdestino,'
      '                immidentificacao,'
      '                immgarsom,'
      '                immtemporetardo,'
      '                immmodoimpressao,'
      '                cznchave,'
      '                etdcodigoent,'
      '                immpratos,'
      '                immcopos,'
      '                immnumepedidoint,'
      '                clbcodigo,'
      '                immhoraimpresso,'
      '                immhoraimprimir,'
      '                immhoraentregadopedido,'
      '                immhoranotificadopedido,'
      '                immhorasaidadopedido'
      '              FROM imm'
      '              WHERE itochave = @itochave;'
      ''
      '            UPDATE imp'
      '            SET itochave = @immitochave'
      '            WHERE imp.itochave = @itochave;'
      ''
      ''
      ''
      '            SELECT'
      '              COUNT(itochave)'
      '            FROM sbi'
      '            WHERE sbi.itochave = @itochave INTO @qtdItemSbi;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItemsbi = 1;'
      ''
      ''
      ''
      '            WHILE (@ContaItemsbi <= @qtdItemSbi) DO'
      ''
      ''
      '              INSERT INTO sbi'
      '                (SELECT'
      '                  @outrachave,'
      '                  @immitochave,'
      '                  sbrcodigo,'
      '                  sbiobs,'
      '                  sbiitem,'
      '                  bprchave'
      '                FROM sbi'
      '                WHERE itochave = @itochave'
      '                AND sbi.sbiitem = @ContaItemsbi);'
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @ultimosbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      '              END IF;'
      ''
      ''
      ''
      ''
      '              SELECT'
      '                COUNT(itochave)'
      '              FROM isi'
      '              WHERE itochave = @itochave'
      '              AND isiitem = @ContaItemsbi INTO @qtdItemisi;'
      ''
      ''
      ''
      ''
      '              IF @qtdItemisi > 0 THEN'
      ''
      ''
      '                INSERT INTO isi'
      '                  (SELECT'
      '                    @novaisichave,'
      '                    @ultimosbichave,'
      '                    tsicodigo,'
      '                    procodigo,'
      '                    isitipo,'
      '                    @immitochave,'
      '                    isiitem,'
      '                    isiquantidade,'
      '                    0'
      '                  FROM isi'
      '                  WHERE itochave = @itochave'
      '                  AND isiitem = @ContaItemsbi);'
      ''
      '              END IF;'
      ''
      ''
      ''
      '              SET @ContaItemsbi = @ContaItemsbi + 1;'
      ''
      ''
      '            END WHILE;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 5;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            UPDATE ito'
      '            SET ito.itoquantidade = (ito.itoquantidade - @qtde),'
      
        '                ito.itototalav = (ito.itoquantidade * ito.itoval' +
        'orav),'
      
        '                ito.itosaldoav = (ito.itototalav - itodescontoav' +
        '),'
      
        '                ito.itototalap = (ito.itoquantidade * ito.itoval' +
        'orap),'
      '                ito.itosaldoap = (itototalap - itodescontoap)'
      '            WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItem = @ContaItem + 1;'
      ''
      ''
      '          END WHILE;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 6;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      '              orc.orcdescontoav = tito.descav,'
      
        '              orc.orcpercdescav = IF(tito.descav > 0, (tito.desc' +
        'av / tito.totav), 0),'
      '              orc.orctotalav = (tito.totav - tito.descav),'
      '              orc.orcgeralap = tito.totap,'
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = @orcchave;'
      ''
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '              orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      '        SET ErroMensagem = 8;'
      ''
      ''
      
        '        CALL RegistraMes(@orcchave, pClbCodigo, ErroMensagem, pC' +
        'onfirma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 10;'
      ''
      ''
      ''
      ''
      '        SET @troqtd = 0;'
      ''
      ''
      '        SET @troqtd = (SELECT DISTINCT'
      '            COUNT(orcchaveorigem)'
      '          FROM tro'
      '          WHERE orcchaveorigem = pOrcChave'
      '          AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '        IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '          SET @orcchaveinicial = IFNULL((SELECT'
      '              orcchaveorigem'
      '            FROM tro'
      '            WHERE orcchavedestino = pOrcChave'
      '            ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '          INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '            VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE KE' +
        'Y UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = @o' +
        'rcchave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 11;'
      ''
      ''
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, @OrcChave, @ltechave, pNome, 1);'
      '      ELSE'
      ''
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, pOrcChave, @ltechave, pNome, 0);'
      '      END IF;'
      ''
      ''
      ''
      '      IF (@qtdItem > 0)'
      '        AND (@orcchave > 0) THEN'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = @orcchave'
      '          AND dtl.mdacodigo != 7);'
      ''
      ''
      '        IF @VlrFechamento > 0 THEN'
      ''
      ''
      '          SET @etdcodigo = (SELECT'
      '              etdcodigo'
      '            FROM orc'
      '            WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      '          SET ErroMensagem = 15;'
      ''
      ''
      '          OPEN curlote;'
      '        read_loop:'
      '          LOOP'
      ''
      '            FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '            IF done THEN'
      ''
      '              LEAVE read_loop;'
      '            END IF;'
      ''
      ''
      '            SET @VlrFechamento = (SELECT'
      '                SUM(dtl.dtlvalor) dtlvalor'
      '              FROM dtl'
      '                INNER JOIN olt'
      '                  ON dtl.ltechave = olt.ltechave'
      '              WHERE olt.orcchave = @orcchave'
      '              AND dtl.ltechave = lote'
      '              AND dtl.mdacodigo = modalidade'
      '              AND dtl.mdacodigo != 7);'
      ''
      '            DELETE'
      '              FROM trfi'
      '            WHERE mdacodigo <> modalidade;'
      ''
      '            INSERT INTO trfi (ID'
      '            , etdcodigo'
      '            , mdacodigo'
      '            , tfdcodigo'
      '            , numparc'
      '            , dtvecto'
      '            , vlrparcela'
      '            , numero)'
      
        '              VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_' +
        'DATE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '            SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '            CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, ErroMe' +
        'nsagem, @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 9;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          END LOOP;'
      ''
      ''
      '          CLOSE curlote;'
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      ''
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            @MesChave'
      '          FROM olt'
      '            INNER JOIN mlt'
      '              ON olt.ltechave = mlt.ltechave'
      '            INNER JOIN mfi'
      '              ON mlt.mfichave = mfi.mfichave'
      '          WHERE olt.orcchave = @OrcChave);'
      ''
      '      END IF;'
      ''
      ''
      ''
      '    ELSE'
      ''
      ''
      '      SET ErroMensagem = 13;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      INSERT INTO olt (oltchave'
      '      , orcchave'
      '      , ltechave'
      '      , oltidentificacao'
      '      , olttipo)'
      
        '        VALUE (@novachave, @orcchave, @ltechave, pNome, pTipoFec' +
        'hamento);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET @LteDesconto = IFNULL((SELECT'
      '          SUM(lte.ltedesconto)'
      '        FROM olt'
      '          INNER JOIN lte'
      '            ON olt.ltechave = lte.ltechave'
      '        WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '      SET @OrcTotalAv = (SELECT'
      '          SUM(itovalorav * itoquantidade) totav'
      '        FROM ito'
      '        WHERE orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '      IF @LteDesconto > 0 THEN'
      ''
      ''
      '        SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '        UPDATE ito'
      '        SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '            itosaldoav = (ito.itototalav - itodescontoav),'
      '            itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '            itosaldoap = (ito.itototalav - itodescontoav),'
      '            itopercdescap = ROUND(@percdesc, 3),'
      '            itopercdescav = ROUND(@percdesc, 3)'
      '        WHERE ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '        SET @centavos = @LteDesconto - (SELECT'
      '            SUM(itodescontoav)'
      '          FROM ito'
      '          WHERE ito.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '        IF @centavos <> 0 THEN'
      ''
      '          UPDATE ito'
      '          SET itodescontoav = itodescontoav + @centavos,'
      '              itodescontoap = itodescontoap + @centavos,'
      '              itosaldoav = itosaldoav + @centavos,'
      '              itosaldoap = itosaldoap + @centavos'
      '          WHERE ito.orcchave = pOrcChave;'
      ''
      '        END IF;'
      ''
      ''
      ''
      '        UPDATE orc'
      '        INNER JOIN (SELECT'
      '            ito.orcchave,'
      '            SUM(itototalav) totav,'
      '            SUM(itodescontoav) descav,'
      '            SUM(itototalap) totap,'
      '            SUM(itodescontoap) descap'
      '          FROM ito'
      '          WHERE stocodigo != 88'
      '          GROUP BY ito.orcchave) tito'
      '          ON tito.orcchave = orc.orcchave'
      '        SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '            orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '            orc.orcdescontoav = tito.descap,'
      
        '            orc.orcpercdescav = IF(tito.descap > 0, (tito.descap' +
        ' / tito.totap), 0),'
      '            orc.orctotalap = (tito.totap - tito.descap)'
      '        WHERE orc.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '      CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pCon' +
        'firma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET ErroMensagem = 14;'
      ''
      ''
      ''
      '      SET @VlrFechamento = (SELECT'
      '          SUM(dtl.dtlvalor) dtlvalor'
      '        FROM dtl'
      '          INNER JOIN olt'
      '            ON dtl.ltechave = olt.ltechave'
      '        WHERE olt.orcchave = pOrcChave'
      '        AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '      IF @VlrFechamento > 0 THEN'
      ''
      ''
      '        SET @etdcodigo = (SELECT'
      '            etdcodigo'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        OPEN curlote;'
      '      read_loop:'
      '        LOOP'
      ''
      '          FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '          IF done THEN'
      ''
      '            LEAVE read_loop;'
      '          END IF;'
      ''
      '          SET @VlrFechamento = (SELECT'
      '              SUM(dtl.dtlvalor) dtlvalor'
      '            FROM dtl'
      '              INNER JOIN olt'
      '                ON dtl.ltechave = olt.ltechave'
      '            WHERE olt.orcchave = pOrcChave'
      '            AND dtl.ltechave = lote'
      '            AND dtl.mdacodigo = modalidade'
      '            AND dtl.mdacodigo != 7);'
      ''
      ''
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '            VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DA' +
        'TE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '          SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '          CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem,' +
        ' @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 17;'
      ''
      ''
      ''
      '          INSERT INTO rfm (rfmchave'
      '          , rfichave'
      '          , meschave)'
      ''
      '            (SELECT DISTINCT'
      '              @novachave,'
      '              rfichave,'
      '              @MesChave'
      '            FROM olt'
      '              INNER JOIN mlt'
      '                ON olt.ltechave = mlt.ltechave'
      '              INNER JOIN mfi'
      '                ON mlt.mfichave = mfi.mfichave'
      '            WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '        END LOOP;'
      ''
      ''
      '        CLOSE curlote;'
      ''
      '      END IF;'
      ''
      ''
      '      INSERT INTO rfm (rfmchave'
      '      , rfichave'
      '      , meschave)'
      ''
      '        (SELECT DISTINCT'
      '          @novachave,'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '      SET ErroMensagem = 18;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      '          orc.orcpercdescav = @percdesc,'
      '          orc.orctotalap = (tito.totap - tito.descap),'
      '          orc.orcdataencerr = CURRENT_DATE(),'
      '          orc.orchoraencerr = CURRENT_TIME(),'
      '          orc.stocodigo = 3'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.stocodigo = 3'
      '      WHERE ito.orcchave = pOrcChave'
      '      AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '    END IF;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END'
      '//'
      '')
    Delimiter = '//'
    Left = 592
    Top = 344
  end
  object us001255: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmestabelecimentotipotef'#39') THEN'
      ''
      'ALTER TABLE trm'
      
        '  ADD COLUMN trmestabelecimentotipotef VARCHAR(255) DEFAULT NULL' +
        ';'
      ''
      'end if; '
      ''
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcodempresa'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmterminalcodempresa VARCHAR(255) DEFAULT NULL;'
      ''
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcodfilial'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmterminalcodfilial VARCHAR(255) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcodterminal'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmterminalcodterminal VARCHAR(255) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalenderecoservidor'#39') THEN'
      ''
      'ALTER TABLE trm'
      
        '  ADD COLUMN trmterminalenderecoservidor VARCHAR(255) DEFAULT NU' +
        'LL;'
      ''
      'end if; '
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalportapinpad'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmterminalportapinpad VARCHAR(255) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 24
    Top = 240
  end
  object us001256: TUniScript
    Delimiter = '//'
    Left = 96
    Top = 240
  end
  object us001257: TUniScript
    SQL.Strings = (
      'drop table if exists rct//'
      ''
      'CREATE TABLE IF NOT EXISTS rct ('
      '  rctchave int(11) NOT NULL AUTO_INCREMENT,'
      '  rctvalor float(9, 3) NOT NULL DEFAULT 0.000 ,'
      '  rctnrauto varchar(100) DEFAULT '#39#39','
      '  adccodigo int(11) NOT NULL,'
      '  rctparcelas int(3) NOT NULL DEFAULT 1 ,'
      '  bdccodigo int(11) DEFAULT NULL,'
      '  rctcomprovante1via varchar(1000) DEFAULT '#39#39','
      '  rctcomprovante2via varchar(1000) DEFAULT '#39#39','
      '  rcthora time,'
      '  orcchave int(11) DEFAULT 0,'
      '  rctstatus varchar(50) DEFAULT '#39#39','
      '  PRIMARY KEY (rctchave)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci'
      
        'COMMENT = '#39'Registro temporario dos detalhes da opera'#231'ao com cart' +
        #227'o'#39
      'ROW_FORMAT = DYNAMIC//')
    Delimiter = '//'
    Left = 152
    Top = 240
  end
  object us001258: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcomprovante'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmterminalcomprovante VARCHAR(5000) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 208
    Top = 240
  end
  object us001259: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      '  IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND table_name = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcomprovante'#39') THEN'
      ''
      '    IF NOT EXISTS (SELECT'
      '          *'
      '        FROM information_schema.COLUMNS'
      '        WHERE TABLE_SCHEMA = DATABASE()'
      '        AND table_name = '#39'trm'#39
      '        AND column_name = '#39'trmterminalcomprovante1via'#39') THEN'
      ''
      '      ALTER TABLE trm'
      
        '      CHANGE COLUMN trmterminalcomprovante trmterminalcomprovant' +
        'e1via varchar(8000);'
      ''
      '    END IF;'
      '  END IF;'
      ''
      ''
      ''
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND table_name = '#39'trm'#39
      '      AND column_name = '#39'trmterminalcomprovante2via'#39') THEN'
      ''
      '    ALTER TABLE trm'
      
        '    ADD COLUMN trmterminalcomprovante2via varchar(8000) DEFAULT ' +
        #39#39';'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      '')
    Delimiter = '//'
    Left = 264
    Top = 240
  end
  object us001260: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ' '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'imu'#39
      '      AND column_name = '#39'imuanp'#39') THEN'
      ' '
      ''
      '--'
      '-- Alter table "imu"'
      '--'
      'ALTER TABLE imu'
      '  ADD COLUMN imuanp varchar(10) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 336
    Top = 240
  end
  object us001261: TUniScript
    SQL.Strings = (
      'drop table if exists rct//'
      ''
      'CREATE TABLE IF NOT EXISTS rct ('
      '  rctchave int(11) NOT NULL AUTO_INCREMENT,'
      '  rctvalor float(9, 3) NOT NULL DEFAULT 0.000 ,'
      '  rctnrauto varchar(200) DEFAULT '#39#39','
      '  adccodigo int(11) NOT NULL,'
      '  rctparcelas int(3) NOT NULL DEFAULT 1 ,'
      '  bdccodigo int(11) DEFAULT NULL,'
      '  rctcomprovante1via varchar(1000) DEFAULT '#39#39','
      '  rctcomprovante2via varchar(1000) DEFAULT '#39#39','
      '  rcthora time,'
      '  orcchave int(11) DEFAULT 0,'
      '  rctstatus varchar(50) DEFAULT '#39#39','
      '  PRIMARY KEY (rctchave)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci'
      
        'COMMENT = '#39'Registro temporario dos detalhes da opera'#231'ao com cart' +
        #227'o'#39
      'ROW_FORMAT = DYNAMIC//')
    Delimiter = '//'
    Left = 32
    Top = 304
  end
  object us001262: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rdc'#39
      '      AND column_name = '#39'rdcnrauto'#39') THEN'
      ''
      'ALTER TABLE rdc'
      '  CHANGE COLUMN rdcnrauto rdcnrauto VARCHAR(200);'
      ' '
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      '')
    Delimiter = '//'
    Left = 88
    Top = 304
  end
  object us001263: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'clt'#39
      '      AND column_name = '#39'dtlchave'#39') THEN'
      ''
      'ALTER TABLE clt'
      '  ADD COLUMN dtlchave INT(11) NOT NULL DEFAULT 0;'
      ' '
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      '')
    Delimiter = '//'
    Left = 152
    Top = 304
  end
  object us001264: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'ltr'#39
      '      AND column_name = '#39'rdcnrauto'#39') THEN'
      ''
      'ALTER TABLE ltr'
      '  ADD COLUMN rdcnrauto VARCHAR(200) NOT NULL DEFAULT '#39#39';'
      ''
      ' '
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      '')
    Delimiter = '//'
    Left = 216
    Top = 304
  end
  object us001265: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaIndices//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaIndices ()'
      'BEGIN'
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'v_rfi'#39
      '      AND INDEX_NAME = '#39'v_rfi_rfivencimento'#39') THEN'
      ''
      ''
      'ALTER TABLE v_rfi'
      '  ADD INDEX v_rfi_rfivencimento (rfivencimento);'
      ''
      '  END IF;'
      ''
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'v_rfi'#39
      '      AND INDEX_NAME = '#39'v_rfi_srfcodigo'#39') THEN'
      ''
      'ALTER TABLE v_rfi'
      '  ADD INDEX v_rfi_srfcodigo (srfcodigo);'
      ''
      '  END IF;'
      ''
      ''
      'END//'
      ''
      'CALL AtualizaIndices()//'
      ''
      '')
    Delimiter = '//'
    Left = 272
    Top = 304
  end
  object us001266: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaIndices//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaIndices ()'
      'BEGIN'
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mfi'#39
      '      AND INDEX_NAME = '#39'mfisituacao'#39') THEN'
      ''
      ''
      'ALTER TABLE mfi'
      '  ADD INDEX mfisituacao (mfisituacao);'
      ''
      '  END IF;'
      ''
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mfi'#39
      '      AND INDEX_NAME = '#39'mfidata'#39') THEN'
      ''
      'ALTER TABLE mfi'
      '  ADD INDEX mfidata (mfidata);'
      ''
      '  END IF;'
      ''
      ''
      'END//'
      ''
      'CALL AtualizaIndices()//'
      ''
      '')
    Delimiter = '//'
    Left = 328
    Top = 304
  end
  object us001267: TUniScript
    SQL.Strings = (
      'DROP TABLE IF EXISTS bdc//'
      ''
      'CREATE TABLE bdc ('
      '  bdccodigo int(11) NOT NULL,'
      '  bdcidentificacao varchar(50) DEFAULT '#39'NULL'#39','
      '  trmestabelecimentotipotef varchar(255) NOT NULL,'
      '  PRIMARY KEY (bdccodigo, trmestabelecimentotipotef)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci'
      'COMMENT = '#39'Bandeira para Cart'#195#163'o de credito ou debito'#39
      'ROW_FORMAT = DYNAMIC//'
      ''
      ''
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (17, '#39'HIPER'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (18, '#39'JCB'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (19, '#39'MAIS'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (20, '#39'MAXVAN'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (21, '#39'POLICARD'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (22, '#39'REDECOMPRAS'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (23, '#39'SODEXO'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (24, '#39'VALECARD'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (25, '#39'VEROCHEQUE'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (26, '#39'VR'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (27, '#39'TICKET'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (99, '#39'OUTROS'#39', '#39'PayGoweb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (1, '#39'Visa (Cr'#233'dito)'#39', '#39'Skytef'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (1, '#39'Visa'#39', '#39'PayGoWeb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (11, '#39'JCB (Cr'#233'dito)'#39', '#39'sytef'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (10014, '#39'Discovery (Voucher)'#39', '#39'sytef'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (20001, '#39'Maestro (D'#233'bito)'#39', '#39'sytef'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (20002, '#39'Visa Electron (D'#233'bito)'#39', '#39'sytef'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (20137, '#39'Telenet (D'#233'bito)'#39', '#39'sytef'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (2, '#39'Mastercard (Cr'#233'dito)'#39', '#39'Sytef'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (2, '#39'Mastercard'#39', '#39'PayGoWeb'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef) VALUES (4, '#39'American Express (Cr'#233'dito)'#39', '#39'SyTef'#39')//')
    Delimiter = '//'
    Left = 24
    Top = 360
  end
  object us001268: TUniScript
    SQL.Strings = (
      'dROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'bdc'#39
      '      AND column_name = '#39'trmestabelecimentotipotef'#39') THEN'
      ''
      'ALTER TABLE bdc'
      
        '  ADD COLUMN trmestabelecimentotipotef VARCHAR(250) DEFAULT NULL' +
        ';'
      ' '
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rdc'#39
      '      AND column_name = '#39'dtlchave'#39') THEN'
      ''
      '--'
      '-- Alter table "rdc"'
      '--'
      'ALTER TABLE rdc'
      '  ADD COLUMN dtlchave INT(11) DEFAULT 0;'
      ''
      ''
      'end if; '
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      'DROP PROCEDURE IF EXISTS AtualizaIndices//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaIndices ()'
      'BEGIN'
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mes'#39
      '      AND INDEX_NAME = '#39'mesdatanfe'#39') THEN'
      ''
      ''
      ''
      ''
      '-- Alter table "mes"'
      '--'
      'ALTER TABLE mes'
      '  ADD INDEX mesdatanfe (mesdatanfe);'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaIndices()//'
      ''
      ''
      ''
      ''
      '')
    Delimiter = '//'
    Left = 88
    Top = 360
  end
  object us001269: TUniScript
    SQL.Strings = (
      'dROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rct'#39
      '      AND column_name = '#39'rctrede'#39') THEN'
      ''
      'ALTER TABLE rct'
      '  ADD COLUMN rctrede VARCHAR(100) DEFAULT NULL;'
      ' '
      'end if; '
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      '')
    Delimiter = '//'
    Left = 144
    Top = 360
  end
  object us001270: TUniScript
    SQL.Strings = (
      ''
      'DROP TABLE bdc//'
      ''
      'CREATE TABLE IF NOT EXISTS bdc ('
      '  bdccodigo int(11) NOT NULL,'
      '  bdcidentificacao varchar(100) DEFAULT NULL,'
      '  trmestabelecimentotipotef varchar(255) NOT NULL,'
      '  bdcnaturza varchar(50) NOT NULL,'
      '  PRIMARY KEY (bdccodigo, trmestabelecimentotipotef, bdcnaturza)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci'
      'COMMENT = '#39'Bandeira para Cartao de credito ou debito'#39
      'ROW_FORMAT = DYNAMIC//'
      ''
      ''
      ''
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(1, '#39'Visa'#39', '#39'PayGoWeb'#39', '#39'D'#233'bito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(1, '#39'Visa'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(2, '#39'Mastercard'#39', '#39'PayGoWeb'#39', '#39'D'#233'bito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(2, '#39'Master'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(3, '#39'Diners'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(4, '#39'Amex'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(6, '#39'Sidecard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      
        '(7, '#39'Private label generico'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')' +
        '//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(8, '#39'Redeshop'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(9, '#39'Pao de acucar'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(10, '#39'Finivest'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(11, '#39'JCB'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(12, '#39'Hiper'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(13, '#39'Aura'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(14, '#39'Losango'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(15, '#39'Sorocred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(17, '#39'HIPER'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(18, '#39'JCB'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(19, '#39'MAIS'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(20, '#39'MAXVAN'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(21, '#39'POLICARD'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(22, '#39'REDECOMPRAS'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(23, '#39'SODEXO'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(24, '#39'VALECARD'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(25, '#39'VEROCHEQUE'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(26, '#39'VR'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(27, '#39'TICKET'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(28, '#39'VISA ELECTRO'#39', '#39'PayGoWeb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(29, '#39'MAESTRO'#39', '#39'PayGoWeb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(29, '#39'Softway'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(30, '#39'99'#39', '#39'PayGoWeb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(30, '#39'Cabal'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(31, '#39'ELO DEBITO'#39', '#39'PayGoWeb'#39', '#39'D'#233'bito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(31, '#39'Elo'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(33, '#39'ELO'#39', '#39'PayGoWeb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(33, '#39'Policard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(35, '#39'Banescard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(38, '#39'Cetelem'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(41, '#39'Sicredi'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(43, '#39'Coopercred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(45, '#39'AVista'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(57, '#39'Mais'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(58, '#39'Banpara'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(60, '#39'Amazoncard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(61, '#39'Yamada'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(62, '#39'Goiascard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(63, '#39'Credpar'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(64, '#39'Boticario'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(65, '#39'Ascard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(66, '#39'Jetpar'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(67, '#39'Maxxcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(68, '#39'Garantido'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(69, '#39'Amazonprime'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(70, '#39'Credz'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(71, '#39'Credishop'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(72, '#39'Ticket'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(73, '#39'Libercard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(78, '#39'Peela'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(84, '#39'Banrisul'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(86, '#39'Verdecard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(86, '#39'Verdecard'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(87, '#39'Refeisul'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(90, '#39'Calcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(91, '#39'Banese'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(93, '#39'Tricard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(94, '#39'Tricard'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(95, '#39'ApoloCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(96, '#39'GlobalCooper'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(97, '#39'PraTi'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(98, '#39'SupperCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(99, '#39'OUTROS'#39', '#39'PayGoweb'#39', '#39'Cr'#233'dito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(99, '#39'Qualita'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(101, '#39'Tecbiz'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(102, '#39'Todo'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(104, '#39'VecellCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(105, '#39'Maxxvan'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(107, '#39'Accentiv'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(108, '#39'ASPEB'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(109, '#39'Vale Express'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(114, '#39'Daycard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(118, '#39'RVCards'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(119, '#39'Leader'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(121, '#39'Telenet'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(124, '#39'TicketLog'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(127, '#39'Softnex'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(130, '#39'Goodcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(131, '#39'PagSimples'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(132, '#39'ICards'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(137, '#39'Fortbrasil'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(138, '#39'VoxCred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(140, '#39'BorbaNet'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(141, '#39'Vegascard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(142, '#39'Bigcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(143, '#39'BonusCred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(144, '#39'Volus'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(145, '#39'Convenios Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(147, '#39'Diamante Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(148, '#39'Fortcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(149, '#39'Jet Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(150, '#39'OneCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(151, '#39'PersonalCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(152, '#39'System Farma'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(153, '#39'Liv'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(155, '#39'Siapnet'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(156, '#39'Sindspam'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(157, '#39'Personalidade Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(158, '#39'RG Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(159, '#39'Taurus Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(160, '#39'Facilcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(161, '#39'Algorix'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(163, '#39'Atacadao'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(164, '#39'Carrefour'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(165, '#39'Portalcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(166, '#39'AVBR'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(167, '#39'Vuon'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(168, '#39'CredCesta'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(169, '#39'MarketPay'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(170, '#39'LifeCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(171, '#39'TrioCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(172, '#39'ACCredito'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(173, '#39'BNBClube'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(174, '#39'Brasil Convenios'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(175, '#39'CDC Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(176, '#39'GraalCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(177, '#39'GrandCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(178, '#39'Itacard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(179, '#39'Redemed'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(180, '#39'Sianet'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(181, '#39'ECXCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(182, '#39'Dotz'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(183, '#39'Acicredi'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(184, '#39'Aesp Convenio'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(185, '#39'Aguia Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(186, '#39'ArcomcrediCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(187, '#39'Assufop Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(188, '#39'Avantisys'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(189, '#39'BandCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(190, '#39'CampeloCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(191, '#39'Cartao Confianca'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(192, '#39'Cartao Hortifruti'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(193, '#39'Irani'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(194, '#39'Cartao LeveMais'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(195, '#39'Cartao Montreal'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(196, '#39'Cartao Nalin'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(197, '#39'Cartoes Braizinho'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(198, '#39'CattanCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(199, '#39'CattanCard FortBrasil'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(200, '#39'Clube Demais'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(201, '#39'Coopecic Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(202, '#39'Cooperativo'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(203, '#39'Credialto Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(204, '#39'Credinova Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(205, '#39'Credipinho Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(207, '#39'Imperatriz'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(208, '#39'Lagoacred Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(209, '#39'MaisFacil'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(210, '#39'NeoCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(211, '#39'PitCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(212, '#39'Queiroz Premium'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(213, '#39'Rede Cuidar'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(214, '#39'Savegnago'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(215, '#39'Sertao Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(216, '#39'Servir'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(217, '#39'Siacard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(218, '#39'Sim'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(219, '#39'Sitecc'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(220, '#39'Sollus'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(221, '#39'StiloA Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(222, '#39'SuperCred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(223, '#39'Tipcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(224, '#39'Torra Torra'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(225, '#39'UaiCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(226, '#39'VipCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(227, '#39'Zema'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(228, '#39'Siscred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(229, '#39'Siapnet'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(230, '#39'Sysdata'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(231, '#39'Bradescard'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(232, '#39'Bradescard Elo'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(233, '#39'Bradescard Visa'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      
        '(234, '#39'Bradescard Mastercard'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39 +
        ')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(235, '#39'GoldenFarma'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(236, '#39'Meu Vale'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(237, '#39'MaisFacil'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(239, '#39'Uauh'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(240, '#39'Brasilcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(241, '#39'Siapnet Ideal'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(242, '#39'Boa Convenios'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(243, '#39'CredFacil'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(244, '#39'Ascipam'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(245, '#39'MGCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(246, '#39'QCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(247, '#39'Coopelife'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(248, '#39'VS Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(249, '#39'Idealcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(250, '#39'Familly'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(251, '#39'CredPublico'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(252, '#39'Mury'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(253, '#39'MasterPlus'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(255, '#39'ClubeCampo'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(256, '#39'NutriCheck'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(257, '#39'SoulCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(258, '#39'Card Ideal'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(259, '#39'Ultracred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(260, '#39'Pilarcred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(261, '#39'Samerica'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(262, '#39'Lecard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(263, '#39'Cielo QR Code'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(264, '#39'Croscard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(265, '#39'ValeMais'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(266, '#39'AvanCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(267, '#39'Eucard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(268, '#39'Sancard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(269, '#39'Verocheque'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(270, '#39'FaceCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(271, '#39'Cardban'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(272, '#39'Unik'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(273, '#39'Bonus CBA'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(274, '#39'Esplana'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(275, '#39'Agiplan'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(276, '#39'Fortbrasil'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(277, '#39'Abc'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(278, '#39'AVista'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(279, '#39'Minascred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(280, '#39'Oboecard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(281, '#39'Redecompras'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(282, '#39'Valecard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(283, '#39'GPA'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(284, '#39'Alelo'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(285, '#39'Cardco'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(286, '#39'CCS'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(287, '#39'Central Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(288, '#39'Check Check'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(289, '#39'Compro Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(290, '#39'Conv Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(291, '#39'DaCasa'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(292, '#39'EdmCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(293, '#39'Expansiva'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(294, '#39'Maxicred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(295, '#39'Multicheque'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(296, '#39'Protege'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(297, '#39'Seicon'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(298, '#39'Sigacred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(299, '#39'Supercard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'INSERT INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimentot' +
        'ipotef, bdcnaturza) VALUES'
      '(300, '#39'TCredit'#39', '#39'Skytef'#39', '#39'Credito'#39')//')
    Delimiter = '//'
    Left = 200
    Top = 360
  end
  object us001271: TUniScript
    SQL.Strings = (
      'dROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'edr'#39
      '      AND column_name = '#39'edrativo'#39') THEN'
      ''
      '--'
      '-- Alter table "edr"'
      '--'
      'ALTER TABLE edr'
      '  ADD COLUMN edrativo INT(11) DEFAULT 1;'
      ''
      ' '
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'etf'#39
      '      AND column_name = '#39'etfativo'#39') THEN'
      ''
      '--'
      '-- Alter table "etf"'
      '--'
      'ALTER TABLE etf'
      '  ADD COLUMN etfativo INT(11) DEFAULT 1;'
      ''
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      '')
    Delimiter = '//'
    Left = 256
    Top = 360
  end
  object us001272: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mda'#39
      '      AND column_name = '#39'mdatagpagamento'#39') THEN'
      ''
      'ALTER TABLE mda'
      '  ADD COLUMN mdatagpagamento int(11) NOT NULL default 0;'
      ''
      ' '
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mda'#39
      '      AND column_name = '#39'mdadescrpagamento'#39') THEN'
      ''
      'ALTER TABLE mda'
      '  ADD COLUMN mdadescrpagamento varchar(50) NOT NULL default '#39#39';'
      ' '
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      'SET @var = IF((SELECT'
      '    TRUE'
      '  FROM information_schema.TABLE_CONSTRAINTS'
      '  WHERE CONSTRAINT_SCHEMA = DATABASE()'
      '  AND TABLE_NAME = '#39'ctp'#39
      '  AND CONSTRAINT_NAME = '#39'ctp_mda_mdacodigo'#39
      
        '  AND CONSTRAINT_TYPE = '#39'FOREIGN KEY'#39') = TRUE, '#39'ALTER TABLE ctp ' +
        'DROP FOREIGN KEY ctp_mda_mdacodigo'#39', '#39'SELECT 1'#39')//'
      'PREPARE stmt FROM @var//'
      'EXECUTE stmt//'
      'DEALLOCATE PREPARE stmt//'
      ''
      'SET @var = IF((SELECT'
      '    TRUE'
      '  FROM information_schema.TABLE_CONSTRAINTS'
      '  WHERE CONSTRAINT_SCHEMA = DATABASE()'
      '  AND TABLE_NAME = '#39'ctp'#39
      '  AND CONSTRAINT_NAME = '#39'ctp_mda'#39
      
        '  AND CONSTRAINT_TYPE = '#39'FOREIGN KEY'#39') = TRUE, '#39'ALTER TABLE ctp ' +
        'DROP FOREIGN KEY ctp_mda'#39', '#39'SELECT 1'#39')//'
      'PREPARE stmt FROM @var//'
      'EXECUTE stmt//'
      'DEALLOCATE PREPARE stmt//'
      ''
      ''
      ''
      'SET @var = IF((SELECT'
      '    TRUE'
      '  FROM information_schema.TABLE_CONSTRAINTS'
      '  WHERE CONSTRAINT_SCHEMA = DATABASE()'
      '  AND TABLE_NAME = '#39'dtl'#39
      '  AND CONSTRAINT_NAME = '#39'dtl_mda_mdacodigo'#39
      
        '  AND CONSTRAINT_TYPE = '#39'FOREIGN KEY'#39') = TRUE, '#39'ALTER TABLE dtl ' +
        'DROP FOREIGN KEY dtl_mda_mdacodigo'#39', '#39'SELECT 1'#39')//'
      'PREPARE stmt FROM @var//'
      'EXECUTE stmt//'
      'DEALLOCATE PREPARE stmt//'
      ''
      'SET @var = IF((SELECT'
      '    TRUE'
      '  FROM information_schema.TABLE_CONSTRAINTS'
      '  WHERE CONSTRAINT_SCHEMA = DATABASE()'
      '  AND TABLE_NAME = '#39'dtl'#39
      '  AND CONSTRAINT_NAME = '#39'mda_mdacodigo'#39
      
        '  AND CONSTRAINT_TYPE = '#39'FOREIGN KEY'#39') = TRUE, '#39'ALTER TABLE dtl ' +
        'DROP FOREIGN KEY mda_mdacodigo'#39', '#39'SELECT 1'#39')//'
      'PREPARE stmt FROM @var//'
      'EXECUTE stmt//'
      'DEALLOCATE PREPARE stmt//'
      ''
      'SET @var = IF((SELECT'
      '    TRUE'
      '  FROM information_schema.TABLE_CONSTRAINTS'
      '  WHERE CONSTRAINT_SCHEMA = DATABASE()'
      '  AND TABLE_NAME = '#39'fin'#39
      '  AND CONSTRAINT_NAME = '#39'fin_mda_mdacodigo'#39
      
        '  AND CONSTRAINT_TYPE = '#39'FOREIGN KEY'#39') = TRUE, '#39'ALTER TABLE fin ' +
        'DROP FOREIGN KEY fin_mda_mdacodigo'#39', '#39'SELECT 1'#39')//'
      'PREPARE stmt FROM @var//'
      'EXECUTE stmt//'
      'DEALLOCATE PREPARE stmt//'
      ''
      ''
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(0, '#39'N'#227'o se Aplica'#39', 0, '#39#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(1, '#39'Dinheiro'#39', 1, '#39'Dinheiro'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(2, '#39'Cheque Pr'#243'prio'#39', 0, '#39#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(3, '#39'Cheque Terceiros'#39', 2, '#39'Cheque'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(4, '#39'Cart'#227'o Cr'#233'dito'#39', 3, '#39'Cart'#227'o de Cr'#233'dito'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(5, '#39'Cart'#227'o D'#233'bito'#39', 4, '#39'Cart'#227'o de D'#233'bito'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(6, '#39'PIX'#39', 17, '#39'Pagamento Instant'#226'neo (PIX) - Din'#226'mico'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(7, '#39'Conv'#234'nio'#39', 5, '#39'Outros Crediarios'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(8, '#39'Cr'#233'dito'#39', 21, '#39'Cr'#233'dito em Loja'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(9, '#39'A Faturar'#39', 0, '#39#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(10, '#39'Verba'#39', 0, '#39#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(11, '#39'Troco Dinheiro'#39', 0, '#39#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(12, '#39'Cart'#227'o Voucher'#39', 0, '#39#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(15, '#39'Troca'#39', 99, '#39'Outros'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(16, '#39'Doa'#231#227'o'#39', 99, '#39'Outros'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(17, '#39'Vale'#39', 21, '#39'Cr'#233'dito em Loja'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(18, '#39'Garantia'#39', 0, '#39#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(22, '#39'Troco Cheque Proprio'#39', 0, '#39#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(33, '#39'Troco Cheque Terceiros'#39', 0, '#39#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(77, '#39'Troco Vale'#39', 0, '#39#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(78, '#39'Pagamento Online'#39', 5, '#39'Crediario Digital'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(90, '#39'Sem Pagamento'#39', 90, '#39'Sem Pagamento'#39')//'
      
        'replace INTO mda(mdacodigo, mdaidentificacao, mdatagpagamento, m' +
        'dadescrpagamento) VALUES'
      '(99, '#39'Outros'#39', 99, '#39'Outros'#39')//'
      ''
      ''
      '')
    Delimiter = '//'
    Left = 312
    Top = 360
  end
  object us001273: TUniScript
    SQL.Strings = (
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(1, 1, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(2, 7, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(3, 4, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(4, 5, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(5, 3, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(6, 1, 42)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(7, 11, 42)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(8, 4, 42)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(9, 5, 42)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(10, 22, 42)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(11, 33, 42)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(12, 11, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(13, 22, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(14, 33, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(15, 1, 3)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(16, 2, 3)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(18, 3, 42)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(19, 1, 22)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(20, 11, 22)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(21, 4, 22)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(22, 5, 22)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(23, 22, 22)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(24, 33, 22)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(25, 2, 22)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(26, 3, 22)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(27, 3, 3)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(28, 1, 7)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(29, 3, 7)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(30, 8, 42)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(31, 8, 3)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(32, 10, 22)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(33, 10, 3)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(34, 1, 70)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(35, 3, 70)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(36, 1, 75)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(37, 2, 75)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(38, 8, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(39, 15, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(40, 16, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(41, 17, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(42, 18, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(43, 77, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(45, 4, 70)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(46, 5, 70)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(47, 6, 32)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(48, 6, 22)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(49, 6, 42)//'
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(50, 6, 70)//')
    Delimiter = '//'
    Left = 376
    Top = 360
  end
  object us001274: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rdc'#39
      '      AND column_name = '#39'dtlchave'#39') THEN'
      ''
      'ALTER TABLE rdc'
      '  ADD COLUMN dtlchave INT(11) DEFAULT 0;'
      ''
      ' '
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      '')
    Delimiter = '//'
    Left = 24
    Top = 416
  end
  object us001275: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'cta'#39
      '      AND column_name = '#39'ctacnpjbanco'#39') THEN'
      ''
      'ALTER TABLE cta'
      '  ADD COLUMN ctacnpjbanco VARCHAR(20) NOT NULL DEFAULT '#39#39';'
      ''
      ' '
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 88
    Top = 416
  end
  object us001276: TUniScript
    SQL.Strings = (
      'CREATE TABLE IF NOT EXISTS ori ('
      '  oricodigo int(11) NOT NULL,'
      '  oriidentificacao varchar(50) NOT NULL,'
      '  etdcodigo int(11) DEFAULT 0,'
      '  sipcodigo int(11) DEFAULT 1,'
      '  PRIMARY KEY (oricodigo)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci'
      'COMMENT = '#39'Origens'#39
      'ROW_FORMAT = DYNAMIC//'
      ''
      ''
      
        'REPLACE INTO ori(oricodigo, oriidentificacao, etdcodigo, sipcodi' +
        'go) VALUES (1, '#39'Tablet'#39', 0, 1)//'
      
        'REPLACE INTO ori(oricodigo, oriidentificacao, etdcodigo, sipcodi' +
        'go) VALUES (2, '#39'Cardapio'#39', 0, 1)//'
      
        'REPLACE INTO ori(oricodigo, oriidentificacao, etdcodigo, sipcodi' +
        'go) VALUES (3, '#39'Delivery'#39', 0, 1)//'
      
        'REPLACE INTO ori(oricodigo, oriidentificacao, etdcodigo, sipcodi' +
        'go) VALUES (4, '#39'Aplicativo'#39', 0, 1)//'
      
        'REPLACE INTO ori(oricodigo, oriidentificacao, etdcodigo, sipcodi' +
        'go) VALUES (5, '#39'Site'#39', 0, 1)//'
      
        'REPLACE INTO ori(oricodigo, oriidentificacao, etdcodigo, sipcodi' +
        'go) VALUES (6, '#39'Caixa'#39', 0, 1)//'
      
        'REPLACE INTO ori(oricodigo, oriidentificacao, etdcodigo, sipcodi' +
        'go) VALUES (7, '#39'Nuc'#39', 0, 1)//'
      
        'REPLACE INTO ori(oricodigo, oriidentificacao, etdcodigo, sipcodi' +
        'go) VALUES (8, '#39'AiqFome'#39', 0, 1)//'
      
        'REPLACE INTO ori(oricodigo, oriidentificacao, etdcodigo, sipcodi' +
        'go) VALUES (9, '#39'Ifood'#39', 0, 1)//')
    Delimiter = '//'
    Left = 152
    Top = 408
  end
  object us001277: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmtermanaladquirente'#39') THEN'
      ''
      'ALTER TABLE trm'
      
        '  ADD COLUMN trmtermanaladquirente VARCHAR(100) NOT NULL DEFAULT' +
        ' '#39#39';'
      ''
      ' '
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mes'#39
      '      AND column_name = '#39'oricodigo'#39') THEN'
      ''
      'ALTER TABLE mes'
      '  ADD COLUMN oricodigo int(11) DEFAULT 6;'
      ''
      ' '
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'orc'#39
      '      AND column_name = '#39'oricodigo'#39') THEN'
      ''
      'ALTER TABLE orc'
      '  ADD COLUMN oricodigo int(11) DEFAULT 6;'
      ''
      ' '
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Delimiter = '//'
    Left = 200
    Top = 416
  end
  object us001278: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mce'#39
      '      AND column_name = '#39'ltechavegui'#39') THEN'
      ''
      'ALTER TABLE mce'
      '  ADD COLUMN ltechavegui VARCHAR(200) NOT NULL DEFAULT '#39#39';'
      ''
      ' '
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'lcv'#39
      '      AND column_name = '#39'ltechavegui'#39') THEN'
      ''
      'ALTER TABLE lcv'
      '  ADD COLUMN ltechavegui VARCHAR(200) NOT NULL DEFAULT '#39#39';'
      ''
      ' '
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      'DROP PROCEDURE IF EXISTS AtualizaConstraints//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaConstraints()'
      'BEGIN'
      ''
      ''
      '  IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.TABLE_CONSTRAINTS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'lcv'#39
      '      AND CONSTRAINT_NAME = '#39'lcv_lte_ltechave'#39') THEN'
      ''
      '  ALTER TABLE lcv DROP FOREIGN KEY lcv_lte_ltechave;'
      ''
      '  '
      '  END IF;'
      ''
      ''
      ''
      '  IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.TABLE_CONSTRAINTS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'lcv'#39
      '      AND CONSTRAINT_NAME = '#39'lcv_mcr_mcrchave'#39') THEN'
      ''
      '  ALTER TABLE lcv DROP FOREIGN KEY lcv_mcr_mcrchave;'
      ''
      '  '
      '  END IF;'
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaConstraints()//'
      ''
      ''
      '')
    Delimiter = '//'
    Left = 264
    Top = 408
  end
  object us001279: TUniScript
    SQL.Strings = (
      'CREATE TABLE IF NOT EXISTS irr ('
      '  irrchave int(11) NOT NULL AUTO_INCREMENT,'
      '  etdcodigo int(11) DEFAULT 0,'
      '  irrpercentual decimal(10, 3) DEFAULT 0.000,'
      '  clbcodigo int(11) DEFAULT 0,'
      '  irrregistro datetime DEFAULT NULL,'
      '  irralteracao datetime DEFAULT NULL,'
      '  PRIMARY KEY (irrchave)'
      ')'
      'ENGINE = INNODB'
      'AUTO_INCREMENT = 1'
      'CHARACTER SET utf8mb4'
      'COLLATE utf8mb4_general_ci'
      'COMMENT = '#39'Percentual de ir retido para entidade'#39
      'ROW_FORMAT = DYNAMIC//')
    Delimiter = '//'
    Left = 320
    Top = 416
  end
  object us001280: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'adc'#39
      '      AND column_name = '#39'adcchaveintegracao'#39') THEN'
      ''
      'ALTER TABLE adc'
      '  ADD COLUMN adcchaveintegracao VARCHAR(500) DEFAULT NULL;'
      ''
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'adc'#39
      '      AND column_name = '#39'adcserviconome'#39') THEN'
      ''
      'ALTER TABLE adc'
      '  ADD COLUMN adcserviconome VARCHAR(500) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      'CREATE TABLE IF NOT EXISTS pos ('
      '  poscodigo int(11) NOT NULL AUTO_INCREMENT,'
      '  posidentificacao varchar(50) DEFAULT '#39'NULL'#39','
      '  posnumeroserie varchar(255) DEFAULT '#39'NULL'#39','
      '  PRIMARY KEY (poscodigo)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET utf8mb4'
      'COLLATE utf8mb4_general_ci'
      'COMMENT = '#39'Terminais de venda smartpos'#39
      'ROW_FORMAT = DYNAMIC//'
      ''
      ''
      '')
    Delimiter = '//'
    Left = 376
    Top = 416
  end
  object us001281: TUniScript
    SQL.Strings = (
      'CREATE TABLE if not exists pmc ('
      '  GGREM varchar(50) NOT NULL,'
      '  REGISTRO varchar(255) DEFAULT NULL,'
      '  EAN varchar(50) DEFAULT NULL,'
      '  PF varchar(50) DEFAULT NULL,'
      '  PRODUTO varchar(255) DEFAULT NULL,'
      '  APRESENTACAO varchar(1000) DEFAULT NULL,'
      '  PRIMARY KEY (GGREM)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET utf8mb4'
      'COLLATE utf8mb4_general_ci'
      'COMMENT = '#39'Tabela de precos ao consumidor de medicamento'#39
      'ROW_FORMAT = DYNAMIC;')
    Delimiter = '//'
    Left = 40
    Top = 472
  end
  object us001282: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'adc'#39
      '      AND column_name = '#39'adcchaveintegracao'#39') THEN'
      ''
      'ALTER TABLE adc'
      '  ADD COLUMN adcchaveintegracao VARCHAR(500) DEFAULT NULL;'
      ''
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'adc'#39
      '      AND column_name = '#39'adcserviconome'#39') THEN'
      ''
      'ALTER TABLE adc'
      '  ADD COLUMN adcserviconome VARCHAR(500) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      'CREATE TABLE IF NOT EXISTS pos ('
      '  poscodigo int(11) NOT NULL AUTO_INCREMENT,'
      '  posidentificacao varchar(50) DEFAULT '#39'NULL'#39','
      '  posnumeroserie varchar(255) DEFAULT '#39'NULL'#39','
      '  PRIMARY KEY (poscodigo)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET utf8mb4'
      'COLLATE utf8mb4_general_ci'
      'COMMENT = '#39'Terminais de venda smartpos'#39
      'ROW_FORMAT = DYNAMIC//'
      ''
      ''
      '')
    Delimiter = '//'
    Left = 88
    Top = 472
  end
  object us001283: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS RegistraRefeicao//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraRefeicao (IN pFlaCodigo int'
      ', IN pTipoChave int'
      ', IN pChave int'
      ', IN pClbCodigo int'
      ', IN pValor decimal(15, 3)'
      ', IN pLteChave int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      '  SET @disable_triggers = 1;'
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DROP TEMPORARY TABLE IF EXISTS trfi;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS trfi ('
      '    ID int NOT NULL AUTO_INCREMENT,'
      '    etdcodigo int NOT NULL,'
      '    mdacodigo int NOT NULL,'
      '    tfdcodigo int NOT NULL,'
      '    numparc int NOT NULL,'
      '    dtvecto date NOT NULL,'
      '    vlrparcela decimal(12, 2),'
      '    numero varchar(20),'
      '    PRIMARY KEY (ID)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  DROP TEMPORARY TABLE IF EXISTS tdtl;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS tdtl ('
      '    ID int(11) NOT NULL AUTO_INCREMENT,'
      '    dtlchave int(11),'
      '    ltechave int(11),'
      '    cedcodigo int(1),'
      '    dtlvalor float(9, 2),'
      '    mdacodigo int(11),'
      '    PRIMARY KEY (ID)'
      ''
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @mdacodigo = (SELECT'
      '      mdacodigo'
      '    FROM dtl'
      '    WHERE dtl.ltechave = pLteChave LIMIT 1);'
      ''
      ''
      '  SET @cznchave = (SELECT'
      '      cznchave'
      '    FROM czn'
      '    ORDER BY cznchave DESC LIMIT 1);'
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SET @procodigo = (SELECT'
      '      cfgmgouprorefeicao'
      '    FROM cfgmgou'
      '      INNER JOIN cfg'
      '        ON cfgmgou.cfgcodigo = cfg.cfgcodigo'
      '    WHERE cfg.cfgcodigo = 1'
      '    LIMIT 1);'
      ''
      '  IF pTipoChave = 1 THEN'
      '    SELECT'
      '      edr.edritem,'
      '      edr.ufscodigo'
      '    FROM mes'
      '      INNER JOIN edr'
      '        ON mes.etdcodigo = edr.etdcodigo'
      '        AND mes.edritem = edr.edritem'
      '    WHERE mes.meschave = pChave LIMIT 1 INTO @edritem'
      '    , @ufscodigo;'
      '  END IF;'
      ''
      ''
      '  IF pTipoChave = 0 THEN'
      '    SELECT'
      '      edr.edritem,'
      '      edr.ufscodigo'
      '    FROM orc'
      '      INNER JOIN edr'
      '        ON orc.etdcodigo = edr.etdcodigo'
      '        AND orc.edritem = edr.edritem'
      '    WHERE orc.orcchave = pChave LIMIT 1 INTO @edritem'
      '    , @ufscodigo;'
      '  END IF;'
      ''
      '  SET @toecodigo = (SELECT (SELECT'
      '          cfgmgoutoerefeicao'
      '        FROM cfgmgou'
      '        WHERE cfgcodigo = cfg.cfgcodigo)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  IF pTipoChave = 0 THEN'
      '    INSERT INTO mes (meschave'
      '    , etdcodigo'
      '    , mesemissao'
      '    , mesregistro'
      '    , tdfcodigo'
      '    , sdecodigo'
      '    , messerie'
      '    , mesnumero'
      '    , toecodigo'
      '    , mesvalor'
      '    , mesdesconto'
      '    , mesprodutos'
      '    , messervicos'
      '    , mestotal'
      '    , tfpcodigo'
      '    , refcodigo'
      '    , trfcodigo'
      '    , mesfrete'
      '    , messeguro'
      '    , mesoutras'
      '    , mesbicm'
      '    , mesicm'
      '    , mesbicms'
      '    , mesicms'
      '    , mesipi'
      '    , mespis'
      '    , mescofins'
      '    , mespiss'
      '    , mescofinss'
      '    , clbcodigo'
      '    , trmcodigo'
      '    , mesacrescimo'
      '    , messped'
      '    , temcodigo'
      '    , edritem'
      '    , tdecodigo'
      '    , mesinclusao'
      '    , mesrefeicao'
      '    , mdacodigo'
      '    , cznchave)'
      '      (SELECT'
      '        @novachave,'
      '        @etdcodigo := orc.etdcodigo,'
      '        CURRENT_DATE(),'
      '        CURRENT_DATE(),'
      '        '#39'00'#39','
      '        '#39'00'#39','
      '        @cfgserienfce,'
      '        0,'
      '        @toecodigo,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        pClbCodigo,'
      '        orc.trmcodigo,'
      '        0,'
      '        '#39'0'#39','
      '        1,'
      '        @edritem,'
      '        1,'
      '        NOW(),'
      '        1,'
      '        @mdacodigo,'
      '        @cznchave'
      '      FROM orc'
      '      WHERE orc.orcchave = pChave);'
      '  END IF;'
      ''
      '  IF pTipoChave = 1 THEN'
      '    INSERT INTO mes (meschave'
      '    , etdcodigo'
      '    , mesemissao'
      '    , mesregistro'
      '    , tdfcodigo'
      '    , sdecodigo'
      '    , messerie'
      '    , mesnumero'
      '    , toecodigo'
      '    , mesvalor'
      '    , mesdesconto'
      '    , mesprodutos'
      '    , messervicos'
      '    , mestotal'
      '    , tfpcodigo'
      '    , refcodigo'
      '    , trfcodigo'
      '    , mesfrete'
      '    , messeguro'
      '    , mesoutras'
      '    , mesbicm'
      '    , mesicm'
      '    , mesbicms'
      '    , mesicms'
      '    , mesipi'
      '    , mespis'
      '    , mescofins'
      '    , mespiss'
      '    , mescofinss'
      '    , clbcodigo'
      '    , trmcodigo'
      '    , mesacrescimo'
      '    , messped'
      '    , temcodigo'
      '    , edritem'
      '    , tdecodigo'
      '    , mesinclusao'
      '    , mesrefeicao'
      '    , mdacodigo'
      '    , cznchave)'
      '      (SELECT'
      '        @novachave,'
      '        @etdcodigo := mes.etdcodigo,'
      '        CURRENT_DATE(),'
      '        CURRENT_DATE(),'
      '        '#39'00'#39','
      '        '#39'00'#39','
      '        @cfgserienfce,'
      '        0,'
      '        @toecodigo,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        pClbCodigo,'
      '        mes.trmcodigo,'
      '        0,'
      '        '#39'0'#39','
      '        1,'
      '        @edritem,'
      '        1,'
      '        NOW(),'
      '        1,'
      '        @mdacodigo,'
      '        @cznchave'
      '      FROM mes'
      '      WHERE mes.meschave = pChave);'
      '  END IF;'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao oramento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    IF pTipoChave = 0 THEN'
      '      INSERT INTO mor (morchave'
      '      , orcchave'
      '      , meschave)'
      '        VALUES (@novachave, pChave, pMesChave);'
      '    END IF;'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro buscar paremetrizaes de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @cstcodigo = (SELECT'
      '        cstcodigo'
      '      FROM pro'
      '      WHERE pro.procodigo = @procodigo LIMIT 1);'
      ''
      '    SET @cfocfop = (SELECT'
      '        cfocfop'
      '      FROM pro'
      '      WHERE pro.procodigo = @procodigo);'
      ''
      ''
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @disable_triggers = 1;'
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      ''
      '    , icmcodigo'
      '    , itmaliqicm'
      '    , itmbicm'
      '    , itmicm'
      ''
      '    , csicodigo'
      '    , itmaliqipi'
      '    , itmbipi'
      '    , itmipi'
      ''
      '    , cspcodigo'
      '    , itmaliqpis'
      '    , itmbpis'
      '    , itmpis'
      ''
      '    , csfcodigo'
      '    , itmaliqcofins'
      '    , itmbcofins'
      '    , itmcofins'
      ''
      ''
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase)'
      '      (SELECT'
      '        @novachave,'
      '        pMesChave,'
      '        1,'
      '        pro.procodigo,'
      '        pro.cstcodigo,'
      '        1,'
      '        pValor,'
      '        0,'
      '        @toecodigo,'
      '        @cfocfop,'
      ''
      ''
      '        icmcodigo,'
      '        (SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      '          WHERE i.icmcodigo = pro.icmcodigo) icmaliquotas,'
      '        IF((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      
        '          WHERE i.icmcodigo = pro.icmcodigo) <> 0, pValor, 0) ba' +
        'seicm,'
      '        IF((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      '          WHERE i.icmcodigo = pro.icmcodigo) <> 0, (((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      
        '          WHERE i.icmcodigo = pro.icmcodigo) / 100) * pValor), 0' +
        ') valoricm,'
      ''
      '        csicodigo,'
      '        pro.proipialiquota,'
      '        IF(pro.proipialiquota <> 0, pValor, 0) baseipi,'
      
        '        IF(pro.proipialiquota <> 0, ((pro.proipialiquota / 100) ' +
        '* pValor), 0) valoripi,'
      ''
      '        cspcodigo,'
      '        pro.propisaliquota,'
      '        IF(pro.propisaliquota <> 0, pValor, 0) basepis,'
      
        '        IF(pro.propisaliquota <> 0, ((pro.propisaliquota / 100) ' +
        '* pValor), 0) valorpis,'
      ''
      ''
      '        csfcodigo,'
      '        pro.procofinsaliquota,'
      '        IF(pro.procofinsaliquota <> 0, pValor, 0) basecofins,'
      
        '        IF(pro.procofinsaliquota <> 0, ((pro.procofinsaliquota /' +
        ' 100) * pValor), 0) valorcofins,'
      ''
      ''
      '        @pcccodigo,'
      '        pValor,'
      '        pro.unicodigo,'
      '        pun.puncodigo,'
      '        pun.punmultiplicador,'
      '        @cfocfop,'
      '        (SELECT'
      '            p.unicodigobase'
      '          FROM pun p'
      '          WHERE p.puncodigo = pun.puncodigo) unicodigobase'
      '      FROM pro'
      '        INNER JOIN pun'
      '          ON pro.procodigo = pun.procodigo'
      '          AND pro.unicodigo = pun.unicodigo'
      '      WHERE pro.procodigo = @procodigo);'
      ''
      '    SET @disable_triggers = NULL;'
      ''
      ''
      ''
      '    UPDATE mes'
      '    SET mes.mesicm = (SELECT'
      '            i.itmicm'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mes.mesbicm = mestotal,'
      '        mesipi = (SELECT'
      '            i.itmipi'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mespis = (SELECT'
      '            i.itmpis'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mescofins = (SELECT'
      '            i.itmcofins'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave)'
      '    WHERE meschave = pMesChave;'
      ''
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar lote da venda refeicao'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO lte (ltechave'
      '    , flacodigo'
      '    , tfdcodigo'
      '    , ltedata'
      '    , lteprincipal'
      '    , ltejuros'
      '    , ltedesconto'
      '    , ltetotal'
      '    , lteextenso'
      '    , ltehistorico'
      '    , ltemulta'
      '    , ltesituacao'
      '    , clbcodigo'
      '    , ctacodigo'
      '    , lteregistro)'
      '      (SELECT'
      '        @novachave,'
      '        flacodigo,'
      '        tfdcodigo,'
      '        ltedata,'
      '        lteprincipal,'
      '        ltejuros,'
      '        ltedesconto,'
      '        ltetotal,'
      '        lteextenso,'
      '        ltehistorico,'
      '        ltemulta,'
      '        ltesituacao,'
      '        clbcodigo,'
      '        ctacodigo,'
      '        lteregistro'
      '      FROM lte'
      '      WHERE lte.ltechave = pLteChave);'
      ''
      '    IF ROW_COUNT() > 0 THEN'
      '      SET @ltechave = (SELECT'
      '          LAST_INSERT_ID());'
      ''
      '      UPDATE terro'
      
        '      SET Mensagem = '#39'Erro ao gravar detalhes do recebimento da ' +
        'venda refeicao'#39
      '      WHERE Chamada = pChamada;'
      ''
      '      INSERT INTO dtl (dtlchave'
      '      , ltechave'
      '      , cedcodigo'
      '      , dtlvalor'
      '      , mdacodigo)'
      '        (SELECT'
      '          @novachave,'
      '          @ltechave,'
      '          cedcodigo,'
      '          dtlvalor,'
      '          mdacodigo'
      '        FROM dtl'
      '        WHERE dtl.ltechave = pLteChave);'
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        UPDATE terro'
      
        '        SET Mensagem = '#39'Erro ao gravar registro financeiro da ve' +
        'nda refeicao'#39
      '        WHERE Chamada = pChamada;'
      ''
      '        DELETE'
      '          FROM trfi;'
      ''
      '        INSERT INTO trfi (ID'
      '        , etdcodigo'
      '        , mdacodigo'
      '        , tfdcodigo'
      '        , numparc'
      '        , dtvecto'
      '        , vlrparcela'
      '        , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE' +
        '(), pValor, pMesChave);'
      ''
      
        '        CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, pChamada, ' +
        '@TitCodigo);'
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            pMesChave'
      '          FROM rfi'
      '          WHERE rfi.titcodigo = @TitCodigo);'
      '      END IF;'
      '    END IF;'
      '  END IF;'
      ''
      '  SET @disable_triggers = NULL;'
      'END //')
    Delimiter = '//'
    Left = 152
    Top = 472
  end
  object us001284: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalservicos = IFNULL(@totalservicos, 0);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav - @totalservicos,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      oricodigo,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmoutras'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmacrescimoav)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        0,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        ito.itovalorav + itoacrescimoav itoacrescimoav,'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      '        IF((SELECT'
      '            tpocodigo'
      '          FROM pro p'
      
        '          WHERE p.procodigo = ito.procodigo) = 0, 0, (@totalserv' +
        'icos) * ((itototalav - itooutras) / (@totalgeral)))'
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END //')
    Delimiter = '//'
    Left = 200
    Top = 472
  end
  object us001285: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaIndices//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaIndices ()'
      'BEGIN'
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mes'#39
      '      AND INDEX_NAME = '#39'mesregistro'#39') THEN'
      ''
      ''
      'ALTER TABLE mes'
      '  ADD INDEX mesregistro (mesregistro);'
      ''
      '  END IF;'
      ''
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mes'#39
      '      AND INDEX_NAME = '#39'mesdatanfe'#39') THEN'
      ''
      'ALTER TABLE mes'
      '  ADD INDEX mesdatanfe (mesdatanfe);'
      ''
      '  END IF;'
      ''
      ''
      'END//'
      ''
      'CALL AtualizaIndices()//'
      ''
      '')
    Delimiter = '//'
    Left = 256
    Top = 464
  end
  object us001286: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS FechaMesaParcial//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesaParcial (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT DISTINCT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      ''
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = @OrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      ''
      '  SET pConfirma = @Confirma;'
      ''
      ''
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      ''
      ''
      ''
      '  SET pLteChave = 0;'
      ''
      ''
      '  SET pMesChave = 0;'
      ''
      ''
      '  SET @meschave = 0;'
      ''
      ''
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      '    IF pTipo = 1 THEN'
      ''
      ''
      '      SET @qtdItem = (SELECT'
      '          COUNT(*)'
      '        FROM titem);'
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      ''
      '        SET @ContaItem = 1;'
      ''
      ''
      ''
      '        SET ErroMensagem = 1;'
      ''
      ''
      ''
      '        INSERT INTO orc (orcchave'
      '        , etdcodigo'
      '        , clbcodigo'
      '        , fopcodigo'
      '        , tdecodigo'
      '        , stocodigo'
      '        , moccodigo'
      '        , foacodigo'
      '        , trmcodigo'
      '        , tfpcodigo'
      '        , puocodigo'
      '        , orcdataabert'
      '        , orchoraabert'
      '        , orcgeralav'
      '        , orcdescontoav'
      '        , orcpercdescav'
      '        , orctotalav'
      '        , orcgeralap'
      '        , orcdescontoap'
      '        , orcpercdescap'
      '        , orctotalap'
      '        , orcobs'
      '        , orcdestimpre'
      '        , edritem'
      '        , edrcodigo'
      '        , clbvendedor'
      '        , orcmesa'
      '        , orctelefone'
      '        , ccxchave'
      '        , cznchave)'
      '          SELECT'
      '            @novachave,'
      '            etdcodigo,'
      '            pClbCodigo,'
      '            fopcodigo,'
      '            tdecodigo,'
      '            3,'
      '            moccodigo,'
      '            foacodigo,'
      '            trmcodigo,'
      '            tfpcodigo,'
      '            puocodigo,'
      '            orcdataabert,'
      '            TIME(NOW()),'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            orcobs,'
      '            orcdestimpre,'
      '            edritem,'
      '            edrcodigo,'
      '            pClbCodigo,'
      '            orcmesa,'
      '            orctelefone,'
      '            ccxchave,'
      '            cznchave'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '        IF (ROW_COUNT() > 0) THEN'
      ''
      '          SET @orcchave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      ''
      '          SET ErroMensagem = 2;'
      ''
      ''
      ''
      '          SET @troqtd = 0;'
      ''
      ''
      '          SET @troqtd = (SELECT DISTINCT'
      '              COUNT(orcchaveorigem)'
      '            FROM tro'
      '            WHERE orcchaveorigem = pOrcChave'
      '            AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '          IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '            SET @orcchaveinicial = IFNULL((SELECT'
      '                orcchaveorigem'
      '              FROM tro'
      '              WHERE orcchavedestino = pOrcChave'
      '              ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '            INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '              VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE ' +
        'KEY UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = ' +
        '@orcchave;'
      ''
      ''
      '          END IF;'
      ''
      ''
      ''
      ''
      ''
      '          SET @item = 0;'
      ''
      ''
      '          WHILE (@ContaItem <= @qtdItem) DO'
      ''
      '            SET @item = @item + 1;'
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 3;'
      ''
      ''
      ''
      ''
      '            SELECT'
      '              titem.itochave,'
      '              qtde'
      '            FROM titem'
      '            WHERE titem.ID = @ContaItem INTO @itochave'
      '            , @qtde;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 4;'
      ''
      ''
      ''
      ''
      '            INSERT INTO ito (itochave'
      '            , orcchave'
      '            , procodigo'
      '            , puncodigo'
      '            , unicodigo'
      '            , stocodigo'
      '            , tdecodigo'
      '            , itoquantidade'
      '            , itovalorav'
      '            , itototalav'
      '            , itodescontoav'
      '            , itosaldoav'
      '            , itovalorap'
      '            , itototalap'
      '            , itodescontoap'
      '            , itosaldoap'
      '            , itocontendo'
      '            , itoproservico'
      '            , itoprocomple'
      '            , itodataalter'
      '            , itoitem'
      '            , itogint'
      '            , itopercdescap'
      '            , itopercdescav'
      '            , itoinfadprod'
      '            , itoquanticondi'
      '            , itoquantidevolcondi'
      '            , vrpcodigo'
      '            , itoobs'
      '            , itoacrescimoav'
      '            , clbatendente'
      '            , oricodigo'
      '            , itooutras)'
      '              SELECT'
      '                @novoito,'
      '                @orcchave,'
      '                ito.procodigo,'
      '                puncodigo,'
      '                unicodigo,'
      '                3,'
      '                tdecodigo,'
      '                @qtde,'
      '                itovalorav + itoacrescimoav,'
      
        '                (@qtde * (itovalorav + itoacrescimoav + itooutra' +
        's)),'
      
        '                ROUND(((itovalorav + itoacrescimoav + itooutras)' +
        ' * @percdesc) * @qtde, 2),'
      
        '                (((itovalorav + itoacrescimoav + itooutras) * @q' +
        'tde) - (ROUND(((itovalorav + itoacrescimoav + itooutras) * @perc' +
        'desc) * @qtde, 2))),'
      '                itovalorap,'
      '                (@qtde * itovalorap),'
      '                ROUND((itototalap * @percdesc), 2),'
      '                (itototalap - itodescontoap),'
      '                itocontendo,'
      '                itoproservico,'
      '                itoprocomple,'
      '                CURRENT_DATE(),'
      '                @item,'
      '                itogint,'
      '                ROUND(@percdesc, 3),'
      '                ROUND(@percdesc, 3),'
      '                itoinfadprod,'
      '                itoquanticondi,'
      '                itoquantidevolcondi,'
      '                vrpcodigo,'
      '                itoobs,'
      '                itoacrescimoav,'
      '                clbatendente,'
      '                6,'
      '                itooutras'
      '              FROM ito'
      '              WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      '            SET @immitochave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      ''
      ''
      ''
      '            INSERT INTO imm (immchave,'
      '            itochave,'
      '            tcicodigo,'
      '            immimpresso,'
      '            immentregue,'
      '            immmodo,'
      '            ccxchave,'
      '            immhorapedido,'
      '            immhoraentrega,'
      '            immrecebido,'
      '            dorchave,'
      '            immnumepedido,'
      '            trmcodigo,'
      '            immdestino,'
      '            immidentificacao,'
      '            immgarsom,'
      '            immtemporetardo,'
      '            immmodoimpressao,'
      '            cznchave,'
      '            etdcodigoent,'
      '            immpratos,'
      '            immcopos,'
      '            immnumepedidoint,'
      '            clbcodigo,'
      '            immhoraimpresso,'
      '            immhoraimprimir,'
      '            immhoraentregadopedido,'
      '            immhoranotificadopedido,'
      '            immhorasaidadopedido)'
      '              SELECT'
      '                @novaimmchave,'
      '                @immitochave,'
      '                tcicodigo,'
      '                immimpresso,'
      '                immentregue,'
      '                immmodo,'
      '                ccxchave,'
      '                immhorapedido,'
      '                immhoraentrega,'
      '                immrecebido,'
      '                dorchave,'
      '                immnumepedido,'
      '                trmcodigo,'
      '                immdestino,'
      '                immidentificacao,'
      '                immgarsom,'
      '                immtemporetardo,'
      '                immmodoimpressao,'
      '                cznchave,'
      '                etdcodigoent,'
      '                immpratos,'
      '                immcopos,'
      '                immnumepedidoint,'
      '                clbcodigo,'
      '                immhoraimpresso,'
      '                immhoraimprimir,'
      '                immhoraentregadopedido,'
      '                immhoranotificadopedido,'
      '                immhorasaidadopedido'
      '              FROM imm'
      '              WHERE itochave = @itochave;'
      ''
      '            UPDATE imp'
      '            SET itochave = @immitochave'
      '            WHERE imp.itochave = @itochave;'
      ''
      ''
      ''
      '            SELECT'
      '              COUNT(itochave)'
      '            FROM sbi'
      '            WHERE sbi.itochave = @itochave INTO @qtdItemSbi;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItemsbi = 1;'
      ''
      ''
      ''
      '            WHILE (@ContaItemsbi <= @qtdItemSbi) DO'
      ''
      ''
      '              INSERT INTO sbi'
      '                (SELECT'
      '                  @outrachave,'
      '                  @immitochave,'
      '                  sbrcodigo,'
      '                  sbiobs,'
      '                  sbiitem,'
      '                  bprchave'
      '                FROM sbi'
      '                WHERE itochave = @itochave'
      '                AND sbi.sbiitem = @ContaItemsbi);'
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @ultimosbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      '              END IF;'
      ''
      ''
      ''
      ''
      '              SELECT'
      '                COUNT(itochave)'
      '              FROM isi'
      '              WHERE itochave = @itochave'
      '              AND isiitem = @ContaItemsbi INTO @qtdItemisi;'
      ''
      ''
      ''
      ''
      '              IF @qtdItemisi > 0 THEN'
      ''
      ''
      '                INSERT INTO isi'
      '                  (SELECT'
      '                    @novaisichave,'
      '                    @ultimosbichave,'
      '                    tsicodigo,'
      '                    procodigo,'
      '                    isitipo,'
      '                    @immitochave,'
      '                    isiitem,'
      '                    isiquantidade,'
      '                    0'
      '                  FROM isi'
      '                  WHERE itochave = @itochave'
      '                  AND isiitem = @ContaItemsbi);'
      ''
      '              END IF;'
      ''
      ''
      ''
      '              SET @ContaItemsbi = @ContaItemsbi + 1;'
      ''
      ''
      '            END WHILE;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 5;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            UPDATE ito'
      '            SET ito.itoquantidade = (ito.itoquantidade - @qtde),'
      
        '                ito.itototalav = (ito.itoquantidade * ito.itoval' +
        'orav),'
      
        '                ito.itosaldoav = (ito.itototalav - itodescontoav' +
        '),'
      
        '                ito.itototalap = (ito.itoquantidade * ito.itoval' +
        'orap),'
      '                ito.itosaldoap = (itototalap - itodescontoap)'
      '            WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItem = @ContaItem + 1;'
      ''
      ''
      '          END WHILE;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 6;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      '              orc.orcdescontoav = tito.descav,'
      
        '              orc.orcpercdescav = IF(tito.descav > 0, (tito.desc' +
        'av / tito.totav), 0),'
      '              orc.orctotalav = (tito.totav - tito.descav),'
      '              orc.orcgeralap = tito.totap,'
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = @orcchave;'
      ''
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '              orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      '        SET ErroMensagem = 8;'
      ''
      ''
      
        '        CALL RegistraMes(@orcchave, pClbCodigo, ErroMensagem, pC' +
        'onfirma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 10;'
      ''
      ''
      ''
      ''
      '        SET @troqtd = 0;'
      ''
      ''
      '        SET @troqtd = (SELECT DISTINCT'
      '            COUNT(orcchaveorigem)'
      '          FROM tro'
      '          WHERE orcchaveorigem = pOrcChave'
      '          AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '        IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '          SET @orcchaveinicial = IFNULL((SELECT'
      '              orcchaveorigem'
      '            FROM tro'
      '            WHERE orcchavedestino = pOrcChave'
      '            ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '          INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '            VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE KE' +
        'Y UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = @o' +
        'rcchave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 11;'
      ''
      ''
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, @OrcChave, @ltechave, pNome, 1);'
      '      ELSE'
      ''
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, pOrcChave, @ltechave, pNome, 0);'
      '      END IF;'
      ''
      ''
      ''
      '      IF (@qtdItem > 0)'
      '        AND (@orcchave > 0) THEN'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = @orcchave'
      '          AND dtl.mdacodigo != 7);'
      ''
      ''
      '        IF @VlrFechamento > 0 THEN'
      ''
      ''
      '          SET @etdcodigo = (SELECT'
      '              etdcodigo'
      '            FROM orc'
      '            WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      '          SET ErroMensagem = 15;'
      ''
      ''
      '          OPEN curlote;'
      '        read_loop:'
      '          LOOP'
      ''
      '            FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '            IF done THEN'
      ''
      '              LEAVE read_loop;'
      '            END IF;'
      ''
      ''
      '            SET @VlrFechamento = (SELECT'
      '                SUM(dtl.dtlvalor) dtlvalor'
      '              FROM dtl'
      '                INNER JOIN olt'
      '                  ON dtl.ltechave = olt.ltechave'
      '              WHERE olt.orcchave = @orcchave'
      '              AND dtl.ltechave = lote'
      '              AND dtl.mdacodigo = modalidade'
      '              AND dtl.mdacodigo != 7);'
      ''
      '            DELETE'
      '              FROM trfi'
      '            WHERE mdacodigo <> modalidade;'
      ''
      '            INSERT INTO trfi (ID'
      '            , etdcodigo'
      '            , mdacodigo'
      '            , tfdcodigo'
      '            , numparc'
      '            , dtvecto'
      '            , vlrparcela'
      '            , numero)'
      
        '              VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_' +
        'DATE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '            SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '            CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, ErroMe' +
        'nsagem, @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 9;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          END LOOP;'
      ''
      ''
      '          CLOSE curlote;'
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      ''
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            @MesChave'
      '          FROM olt'
      '            INNER JOIN mlt'
      '              ON olt.ltechave = mlt.ltechave'
      '            INNER JOIN mfi'
      '              ON mlt.mfichave = mfi.mfichave'
      '          WHERE olt.orcchave = @OrcChave);'
      ''
      '      END IF;'
      ''
      ''
      ''
      '    ELSE'
      ''
      ''
      '      SET ErroMensagem = 13;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      INSERT INTO olt (oltchave'
      '      , orcchave'
      '      , ltechave'
      '      , oltidentificacao'
      '      , olttipo)'
      
        '        VALUE (@novachave, @orcchave, @ltechave, pNome, pTipoFec' +
        'hamento);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET @LteDesconto = IFNULL((SELECT'
      '          SUM(lte.ltedesconto)'
      '        FROM olt'
      '          INNER JOIN lte'
      '            ON olt.ltechave = lte.ltechave'
      '        WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '      SET @OrcTotalAv = (SELECT'
      '          SUM(itovalorav * itoquantidade) totav'
      '        FROM ito'
      '        WHERE orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '      IF @LteDesconto > 0 THEN'
      ''
      ''
      '        SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '        UPDATE ito'
      '        SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '            itosaldoav = (ito.itototalav - itodescontoav),'
      '            itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '            itosaldoap = (ito.itototalav - itodescontoav),'
      '            itopercdescap = ROUND(@percdesc, 3),'
      '            itopercdescav = ROUND(@percdesc, 3)'
      '        WHERE ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '        SET @centavos = @LteDesconto - (SELECT'
      '            SUM(itodescontoav)'
      '          FROM ito'
      '          WHERE ito.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '        IF @centavos <> 0 THEN'
      ''
      '          UPDATE ito'
      '          SET itodescontoav = itodescontoav + @centavos,'
      '              itodescontoap = itodescontoap + @centavos,'
      '              itosaldoav = itosaldoav + @centavos,'
      '              itosaldoap = itosaldoap + @centavos'
      '          WHERE ito.orcchave = pOrcChave;'
      ''
      '        END IF;'
      ''
      ''
      ''
      '        UPDATE orc'
      '        INNER JOIN (SELECT'
      '            ito.orcchave,'
      '            SUM(itototalav) totav,'
      '            SUM(itodescontoav) descav,'
      '            SUM(itototalap) totap,'
      '            SUM(itodescontoap) descap'
      '          FROM ito'
      '          WHERE stocodigo != 88'
      '          GROUP BY ito.orcchave) tito'
      '          ON tito.orcchave = orc.orcchave'
      '        SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '            orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '            orc.orcdescontoav = tito.descap,'
      
        '            orc.orcpercdescav = IF(tito.descap > 0, (tito.descap' +
        ' / tito.totap), 0),'
      '            orc.orctotalap = (tito.totap - tito.descap)'
      '        WHERE orc.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '      CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pCon' +
        'firma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET ErroMensagem = 14;'
      ''
      ''
      ''
      '      SET @VlrFechamento = (SELECT'
      '          SUM(dtl.dtlvalor) dtlvalor'
      '        FROM dtl'
      '          INNER JOIN olt'
      '            ON dtl.ltechave = olt.ltechave'
      '        WHERE olt.orcchave = pOrcChave'
      '        AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '      IF @VlrFechamento > 0 THEN'
      ''
      ''
      '        SET @etdcodigo = (SELECT'
      '            etdcodigo'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        OPEN curlote;'
      '      read_loop:'
      '        LOOP'
      ''
      '          FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '          IF done THEN'
      ''
      '            LEAVE read_loop;'
      '          END IF;'
      ''
      '          SET @VlrFechamento = (SELECT'
      '              SUM(dtl.dtlvalor) dtlvalor'
      '            FROM dtl'
      '              INNER JOIN olt'
      '                ON dtl.ltechave = olt.ltechave'
      '            WHERE olt.orcchave = pOrcChave'
      '            AND dtl.ltechave = lote'
      '            AND dtl.mdacodigo = modalidade'
      '            AND dtl.mdacodigo != 7);'
      ''
      ''
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '            VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DA' +
        'TE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '          SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '          CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem,' +
        ' @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 17;'
      ''
      ''
      ''
      '          INSERT INTO rfm (rfmchave'
      '          , rfichave'
      '          , meschave)'
      ''
      '            (SELECT DISTINCT'
      '              @novachave,'
      '              rfichave,'
      '              @MesChave'
      '            FROM olt'
      '              INNER JOIN mlt'
      '                ON olt.ltechave = mlt.ltechave'
      '              INNER JOIN mfi'
      '                ON mlt.mfichave = mfi.mfichave'
      '            WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '        END LOOP;'
      ''
      ''
      '        CLOSE curlote;'
      ''
      '      END IF;'
      ''
      ''
      '      INSERT INTO rfm (rfmchave'
      '      , rfichave'
      '      , meschave)'
      ''
      '        (SELECT DISTINCT'
      '          @novachave,'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '      SET ErroMensagem = 18;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      '          orc.orcpercdescav = @percdesc,'
      '          orc.orctotalap = (tito.totap - tito.descap),'
      '          orc.orcdataencerr = CURRENT_DATE(),'
      '          orc.orchoraencerr = CURRENT_TIME(),'
      '          orc.stocodigo = 3'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.stocodigo = 3'
      '      WHERE ito.orcchave = pOrcChave'
      '      AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '    END IF;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS MobGravaItens//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      
        'PROCEDURE MobGravaItens (IN pOrcChave int, IN pClbCodigo int, IN' +
        ' pFlaCodigo int, IN pTipoItem int, OUT pConfirma int, OUT pMensa' +
        'gem varchar(65000))'
      'BEGIN'
      ''
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      '  DECLARE vimmmodo integer DEFAULT 1;'
      '  DECLARE vcfgmgoupedidounificado integer DEFAULT 0;'
      '  DECLARE itemisi integer DEFAULT 0;'
      '  DECLARE itemsbi integer DEFAULT 0;'
      ''
      ''
      ''
      '  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION BEGIN'
      '    SET ErroException = 1;'
      '    SET pConfirma = ErroException;'
      ''
      '    ROLLBACK;'
      ''
      '    SET pMensagem = (SELECT'
      
        '        CASE WHEN ErroMensagem = 1 THEN '#39'1 - Erro nao identifica' +
        'do.'#39' WHEN ErroMensagem = 2 THEN '#39'2 - Nao foi possivel verificar ' +
        'se existe itens da mesa.'#39' WHEN ErroMensagem = 3 THEN '#39'3 - Nao fo' +
        'i possivel gravar itens da mesa.'#39' WHEN ErroMensagem = 4 THEN '#39'4 ' +
        '- Nao foi possivel gerar pedido na cozinha.'#39' WHEN ErroMensagem =' +
        ' 5 THEN '#39'5 - Nao foi possivel gravar itens, cozinha ja encerrou ' +
        'as atividades.'#39' WHEN ErroMensagem = 6 THEN '#39'6 - Nao foi possivel' +
        ' registrar dados auxiliares dos itens.'#39' WHEN ErroMensagem = 7 TH' +
        'EN '#39'7 - Nao foi possivel registrar mudancas de ingredientes.'#39' WH' +
        'EN ErroMensagem = 8 THEN '#39'8 - Nao foi possivel liberar pedido pa' +
        'ra impressao.'#39' ELSE '#39'Erro inesperado.'#39' END'
      '      FROM dual);'
      '  END;'
      ''
      '  DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '    ID int NOT NULL AUTO_INCREMENT,'
      '    sbrcodigo int,'
      '    sbiobs varchar(100),'
      '    bprchave int,'
      '    sbiitem int,'
      '    PRIMARY KEY (ID)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  START TRANSACTION;'
      ''
      '    SET @vcfgmgoupedidounificado = (SELECT'
      '        cfgmgoupedidounificado'
      '      FROM cfgmgou LIMIT 1);'
      ''
      '    IF @vcfgmgoupedidounificado = 1 THEN'
      '      SET @vimmmodo = 9;'
      '    END IF;'
      ''
      '    IF @vcfgmgoupedidounificado = 0 THEN'
      '      SET @vimmmodo = 1;'
      '    END IF;'
      ''
      '    SET @stocodigo = (SELECT'
      '        stocodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    IF @stocodigo IN (1, 2) THEN'
      '      UPDATE orc'
      '      SET stocodigo = 1'
      '      WHERE orcchave = pOrcChave;'
      '    END IF;'
      ''
      '    SET ErroMensagem = 2;'
      ''
      '    SET @item = IFNULL((SELECT'
      '        MAX(itoitem)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChave), 0);'
      '    SET @qtd = (SELECT'
      '        COUNT(*)'
      '      FROM tito);'
      ''
      '    SET ErroMensagem = 4;'
      ''
      '    SET @MocCodigo = (SELECT'
      '        orc.moccodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    SET @clbcodigo = (SELECT'
      '        clbcodigo'
      '      FROM tito LIMIT 1);'
      ''
      '    IF @MocCodigo = 5 THEN'
      ''
      '      SET @cznchave = (SELECT'
      '          cznchave'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL LIMIT 1);'
      ''
      '      SET @immnumepedido = (SELECT'
      '          (IFNULL(MAX(imm.immnumepedido), 0) + 1) immnumepedido'
      '        FROM imm'
      '        WHERE imm.cznchave = @cznchave'
      '        AND imm.immmodo = 1);'
      ''
      '      IF @immnumepedido < IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000) THEN'
      '        SET @immnumepedido = IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000);'
      '      END IF;'
      ''
      '    END IF;'
      ''
      '    SET @posicao = 1;'
      ''
      '    SET @itemisi = 0;'
      '    SET @itemisi1 = 0;'
      ''
      '    SET @valortotaladicionais = 0;'
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      '      SET @valortotaladicionais = 0;'
      ''
      '      SET ErroMensagem = 3;'
      ''
      '      SET @item = (@item + 1);'
      '      SET @itemisi = (@itemisi + 1);'
      ''
      '      INSERT INTO ito (itochave'
      '      , orcchave'
      '      , procodigo'
      '      , puncodigo'
      '      , unicodigo'
      '      , stocodigo'
      '      , tdecodigo'
      '      , itoquantidade'
      '      , itovalorav'
      '      , itodescontoav'
      '      , itototalav'
      '      , itosaldoav'
      '      , itovalorap'
      '      , itodescontoap'
      '      , itototalap'
      '      , itosaldoap'
      '      , itocontendo'
      '      , itoproservico'
      '      , itoprocomple'
      '      , itodataalter'
      '      , itoitem'
      '      , itogint'
      '      , itopercdescap'
      '      , itopercdescav'
      '      , itoinfadprod'
      '      , itoquanticondi'
      '      , itoquantidevolcondi'
      '      , vrpcodigo'
      '      , itoobs'
      '      , flacodigo'
      '      , clbatendente'
      '      , oricodigo)'
      ''
      '        (SELECT'
      '          @novachave,'
      '          pOrcChave,'
      '          tito.procodigo,'
      '          tito.puncodigo,'
      '          uni.unicodigo,'
      '          2,'
      '          1,'
      '          tito.qtde,'
      '          pun.punprecoav,'
      '          0,'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          pun.punprecoap,'
      '          0,'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          pun.punmultiplicador,'
      '          '#39#39','
      '          '#39#39','
      '          CURRENT_DATE(),'
      '          @item,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          NULL,'
      '          tito.obs,'
      '          pFlaCodigo,'
      '          clbcodigo,'
      '          1'
      '        FROM tito'
      '          INNER JOIN pun'
      '            ON tito.puncodigo = pun.puncodigo'
      '          INNER JOIN uni'
      '            ON pun.unicodigo = uni.unicodigo'
      '        WHERE tito.ID = @posicao);'
      ''
      ''
      ''
      ''
      ''
      '      IF (SELECT'
      '            ROW_COUNT()) > 0 THEN'
      '        SET @itochave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      '        SELECT'
      '          procodigo,'
      '          obs,'
      '          sfnid,'
      '          sfncodigo,'
      '          copos,'
      '          pratos'
      '        FROM tito'
      '        WHERE tito.ID = @posicao INTO @procodigo'
      '        , @obs'
      '        , @sfnid'
      '        , @sfncodigo'
      '        , @copos'
      '        , @pratos;'
      ''
      ''
      ''
      ''
      '        IF @MocCodigo = 5 THEN'
      '          SET ErroMensagem = 6;'
      ''
      ''
      '          SELECT'
      '            gri.griminuretardo,'
      '            gri.tcicodigo'
      '          FROM gri'
      '            INNER JOIN pro'
      '              ON pro.grpcodigo = gri.grpcodigo'
      '            INNER JOIN ito'
      '              ON pro.procodigo = ito.procodigo'
      '          WHERE ito.itochave = @itochave INTO @griminuretardo'
      '          , @tcicodigo;'
      ''
      ''
      '          INSERT INTO imm (itochave'
      '          , tcicodigo'
      '          , immmodo'
      '          , cznchave'
      '          , immtemporetardo'
      '          , immnumepedido'
      '          , immhorapedido'
      '          , trmcodigo'
      '          , immdestino'
      '          , immcopos'
      '          , immpratos'
      '          , clbcodigo)'
      
        '            VALUES (@itochave, @tcicodigo, @vimmmodo, @cznchave,' +
        ' @griminuretardo, @immnumepedido, NOW(), 1, 1, @copos, @pratos, ' +
        'pClbCodigo);'
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      '          IF @sfncodigo > 0 THEN'
      ''
      '            SELECT'
      '              COUNT(brdcodigo)'
      ''
      '            FROM tbrd'
      '            WHERE tbrd.sfnid = @sfnid'
      '            AND tbrd.sfncodigo = @sfncodigo INTO @qtdbordas;'
      ''
      '            IF @qtdbordas > 0 THEN'
      '              INSERT INTO bri (brichave'
      '              , itochave'
      '              , brdcodigo'
      '              , briincluir)'
      '                (SELECT'
      '                  0,'
      '                  @itochave,'
      '                  brdcodigo,'
      '                  1'
      '                FROM tbrd'
      '                WHERE tbrd.sfnid = @sfnid'
      '                AND tbrd.sfncodigo = @sfncodigo);'
      ''
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      ''
      '                SET @vlborda = (SELECT'
      '                    pun.punprecoav punprecoav'
      '                  FROM bri'
      '                    INNER JOIN ito'
      '                      ON bri.itochave = ito.itochave'
      '                    INNER JOIN brd'
      '                      ON bri.brdcodigo = brd.brdcodigo'
      '                    INNER JOIN pro'
      '                      ON brd.procodigo = pro.procodigo'
      '                    INNER JOIN pun'
      '                      ON pro.procodigo = pun.procodigo'
      '                      AND ito.unicodigo = pun.unicodigo'
      '                  WHERE bri.itochave = @itochave LIMIT 1);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '                IF @vlborda > 0 THEN'
      '                  UPDATE ito'
      
        '                  SET ito.itovalorav = (ito.itovalorav + @vlbord' +
        'a),'
      
        '                      ito.itovalorap = (ito.itovalorap + @vlbord' +
        'a),'
      
        '                      ito.itototalav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itototalap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itosaldoav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2) - ito.itodescontoav,'
      
        '                      ito.itosaldoap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2) - ito.itodescontoav'
      ''
      '                  WHERE ito.itochave = @itochave;'
      '                END IF;'
      '              END IF;'
      ''
      ''
      '            END IF;'
      ''
      '            DELETE'
      '              FROM tsbi;'
      ''
      '            SET @novasbiid = 0;'
      ''
      ''
      ''
      ''
      ''
      ''
      '            DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '            CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '              ID int NOT NULL AUTO_INCREMENT,'
      '              sbrcodigo int,'
      '              sbiobs varchar(100),'
      '              bprchave int,'
      '              sbiitem int,'
      '              PRIMARY KEY (ID)'
      '            ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      ''
      ''
      '            INSERT INTO tsbi'
      '              (SELECT'
      '                @chavenova,'
      '                tisi.sbrcodigo,'
      '                tisi.obs,'
      '                tisi.bprchave,'
      '                tisi.isiitem'
      ''
      '              FROM tisi'
      '              WHERE tisi.isiitem = @posicao'
      ''
      '              AND tisi.isitipo = 2);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @possbi = 1;'
      ''
      ''
      ''
      ''
      '            SET @posqtd = (SELECT'
      '                COUNT(*)'
      '              FROM tsbi);'
      ''
      ''
      '            IF @posqtd > 0 THEN'
      '              SET itemsbi = itemsbi + 1;'
      '            END IF;'
      ''
      ''
      ''
      ''
      '            WHILE (@possbi <= @posqtd) DO'
      ''
      '              SET @itemisi1 = @itemisi1 + 1;'
      ''
      '              INSERT INTO sbi (sbichave'
      '              , itochave'
      '              , sbrcodigo'
      '              , sbiobs'
      '              , bprchave'
      '              , sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  tsbi.sbrcodigo,'
      '                  tsbi.sbiobs,'
      '                  tsbi.bprchave,'
      '                  tsbi.sbiitem'
      '                FROM tsbi'
      '                WHERE tsbi.sbiitem = @sfnid'
      '                AND tsbi.ID = @possbi);'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      ''
      ''
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      ''
      '                SET @sbrcodigo = (SELECT'
      '                    sbrcodigo'
      '                  FROM sbi'
      '                  WHERE sbichave = @sbichave);'
      ''
      ''
      ''
      '                INSERT INTO isi (isichave'
      '                , sbichave'
      '                , tsicodigo'
      '                , procodigo'
      '                , itochave'
      '                , isiitem'
      '                , isitipo'
      '                , isiquantidade)'
      '                  (SELECT'
      '                    @novachave,'
      '                    @sbichave,'
      '                    tisi.tsicodigo,'
      '                    tisi.procodigo,'
      '                    @itochave,'
      '                    @possbi,'
      '                    tisi.isitipo,'
      '                    tisi.isiquantidade'
      '                  FROM tisi'
      '                  WHERE tisi.sfnid = @sfnid'
      '                  AND tisi.sfncodigo = @sfncodigo'
      '                  AND tisi.sbrcodigo = @sbrcodigo'
      '                  AND (tisi.isitipo != 2)'
      '                  AND tisi.isiitem = @posicao);'
      ''
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      ''
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      ''
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      ''
      ''
      ''
      ''
      '                END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '              END IF;'
      '              SET @possbi = (@possbi + 1);'
      '            END WHILE;'
      ''
      '            DELETE'
      '              FROM isi'
      '            WHERE itochave = @itochave'
      '              AND (isitipo = 0'
      '              AND tsicodigo = 3);'
      ''
      '            IF (@valortotaladicionais IS NOT NULL) THEN'
      '              UPDATE ito'
      '              SET itoacrescimoav = @valortotaladicionais'
      '              WHERE itochave = @itochave;'
      '            END IF;'
      ''
      ''
      ''
      ''
      ''
      '            DELETE'
      '              FROM isi'
      '            WHERE itochave = @itochave'
      '              AND (isitipo = 0'
      '              AND tsicodigo = 3);'
      ''
      ''
      ''
      '          ELSE'
      ''
      '            IF (SELECT'
      '                  COUNT(*)'
      '                FROM tisi) = 0 THEN'
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  sbr.sbrcodigo,'
      '                  @obs,'
      '                  1'
      '                FROM sbr'
      '                WHERE sbr.procodigo = @procodigo LIMIT 1);'
      '            ELSE'
      ''
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.bprchave'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novachave,'
      '                  @itochave,'
      '                  tisi.sbrcodigo,'
      
        '                  IF(IFNULL(tisi.obs, '#39#39') != '#39#39', tisi.obs, @obs)' +
        ','
      '                  tisi.bprchave,'
      '                  tisi.isiitem'
      '                FROM tisi'
      '                  INNER JOIN sbr'
      '                    ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                WHERE tisi.isiitem = @itemisi'
      '                AND sbr.procodigo = @procodigo LIMIT 1);'
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      '                IF pTipoItem = 1 THEN'
      '                  INSERT INTO isi (isichave'
      '                  , sbichave'
      '                  , tsicodigo'
      '                  , procodigo'
      '                  , itochave'
      '                  , isiitem'
      '                  , isitipo'
      '                  , isiquantidade)'
      '                    (SELECT DISTINCT'
      '                      @novachave,'
      '                      @sbichave,'
      '                      tisi.tsicodigo,'
      '                      tisi.procodigo,'
      '                      @itochave,'
      '                      @itemisi,'
      '                      tisi.isitipo,'
      '                      tisi.isiquantidade'
      '                    FROM tisi'
      '                      INNER JOIN sbr'
      '                        ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                    WHERE sbr.procodigo = @procodigo'
      '                    AND tisi.isiitem = @itemisi);'
      '                END IF;'
      ''
      ''
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      ''
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      ''
      ''
      ''
      '                END IF;'
      '              END IF;'
      ''
      '              IF (@valortotaladicionais IS NOT NULL) THEN'
      '                UPDATE ito'
      '                SET itoacrescimoav = @valortotaladicionais'
      '                WHERE itochave = @itochave;'
      '              END IF;'
      ''
      ''
      '            END IF;'
      ''
      '          END IF;'
      '        END IF;'
      ''
      '      END IF;'
      ''
      '      DELETE'
      '        FROM isi'
      '      WHERE itochave = @itochave'
      '        AND (isitipo = 0'
      '        AND tsicodigo = 3);'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.itovalorav = (ito.itovalorav),'
      '          ito.itovalorap = (ito.itovalorap),'
      
        '          ito.itototalav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade) + (itoacrescimoav * ito.itoquantidade), 2),'
      
        '          ito.itototalap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade) + (itoacrescimoav * ito.itoquantidade), 2),'
      
        '          ito.itosaldoav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav,'
      
        '          ito.itosaldoap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav'
      '      WHERE ito.itochave = @itochave;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      ''
      ''
      ''
      '    END WHILE;'
      ''
      '    SET ErroMensagem = 8;'
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(ito.itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(ito.itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      '        orc.orcdescontoav = tito.descav,'
      '        orc.orcpercdescav = 0,'
      '        orc.orctotalav = (tito.totav - tito.descav),'
      '        orc.orcgeralap = tito.totap,'
      '        orc.orcdescontoap = tito.descap,'
      '        orc.orcpercdescap = 0,'
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        stocodigo = @stocodigo'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '    IF NOT ErroException THEN'
      ''
      '      DELETE'
      '        FROM tito;'
      '      DELETE'
      '        FROM tbrd;'
      ''
      '      DELETE'
      '        FROM tisi;'
      ''
      ''
      '      DELETE'
      '        FROM tsbi;'
      ''
      '    COMMIT;'
      ''
      '    SET pConfirma = ErroException;'
      '    SET pMensagem = '#39'Pedido gravado com sucesso !'#39';'
      '  END IF;'
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS MobGravaItensGourmet//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      
        'PROCEDURE MobGravaItensGourmet (IN pOrcChave int, IN pClbCodigo ' +
        'int, IN pFlaCodigo int, IN pTipoItem int, OUT pConfirma int, OUT' +
        ' pMensagem varchar(65000))'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      '  DECLARE vimmmodo integer DEFAULT 1;'
      '  DECLARE vcfgmgoupedidounificado integer DEFAULT 0;'
      '  DECLARE itemisi integer DEFAULT 0;'
      '  DECLARE itemsbi integer DEFAULT 0;'
      '  DECLARE trmvendarapida integer DEFAULT 0;'
      '  DECLARE immhoraimpresso datetime DEFAULT NULL;'
      ''
      ''
      ''
      '  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION BEGIN'
      '    SET ErroException = 1;'
      '    SET pConfirma = ErroException;'
      ''
      '    ROLLBACK;'
      ''
      '    SET pMensagem = (SELECT'
      
        '        CASE WHEN ErroMensagem = 1 THEN '#39'1 - Erro nao identifica' +
        'do.'#39' WHEN ErroMensagem = 2 THEN '#39'2 - Nao foi possivel verificar ' +
        'se existe itens da mesa.'#39' WHEN ErroMensagem = 3 THEN '#39'3 - Nao fo' +
        'i possivel gravar itens da mesa.'#39' WHEN ErroMensagem = 4 THEN '#39'4 ' +
        '- Nao foi possivel gerar pedido na cozinha.'#39' WHEN ErroMensagem =' +
        ' 5 THEN '#39'5 - Nao foi possivel gravar itens, cozinha ja encerrou ' +
        'as atividades.'#39' WHEN ErroMensagem = 6 THEN '#39'6 - Nao foi possivel' +
        ' registrar dados auxiliares dos itens.'#39' WHEN ErroMensagem = 7 TH' +
        'EN '#39'7 - Nao foi possivel registrar mudancas de ingredientes.'#39' WH' +
        'EN ErroMensagem = 8 THEN '#39'8 - Nao foi possivel liberar pedido pa' +
        'ra impressao.'#39' ELSE ErroMensagem END'
      '      FROM dual);'
      '  END;'
      ''
      '  DROP TABLE IF EXISTS tsbi;'
      '  DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '    ID int NOT NULL AUTO_INCREMENT,'
      '    sbrcodigo int,'
      '    sbiobs varchar(100),'
      '    bprchave int,'
      '    sbiitem int,'
      '    PRIMARY KEY (ID)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  START TRANSACTION;'
      ''
      '    SET @vcfgmgoupedidounificado = (SELECT'
      '        cfgmgoupedidounificado'
      '      FROM cfgmgou LIMIT 1);'
      ''
      '    IF @vcfgmgoupedidounificado = 1 THEN'
      '      SET @vimmmodo = 9;'
      '    END IF;'
      ''
      '    IF @vcfgmgoupedidounificado = 0 THEN'
      '      SET @vimmmodo = 1;'
      '    END IF;'
      ''
      '    SET @stocodigo = (SELECT'
      '        stocodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    IF @stocodigo IN (1, 2) THEN'
      '      UPDATE orc'
      '      SET stocodigo = 1'
      '      WHERE orcchave = pOrcChave;'
      '    END IF;'
      ''
      '    SET ErroMensagem = 2;'
      ''
      '    SET @item = IFNULL((SELECT'
      '        MAX(itoitem)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChave), 0);'
      '    SET @qtd = (SELECT'
      '        COUNT(*)'
      '      FROM tito);'
      ''
      '    SET ErroMensagem = 4;'
      ''
      '    SET @MocCodigo = (SELECT'
      '        orc.moccodigo'
      '      FROM orc'
      '      WHERE orcchave = pOrcChave);'
      ''
      '    SET @clbcodigo = (SELECT'
      '        clbcodigo'
      '      FROM tito LIMIT 1);'
      ''
      '    IF @MocCodigo = 5 THEN'
      ''
      '      SET @cznchave = (SELECT'
      '          cznchave'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL LIMIT 1);'
      ''
      '      SET @immnumepedido = (SELECT'
      '          (IFNULL(MAX(imm.immnumepedido), 0) + 1) immnumepedido'
      '        FROM imm'
      '        WHERE imm.cznchave = @cznchave'
      '        AND imm.immmodo = 1);'
      ''
      '      IF @immnumepedido < IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000) THEN'
      '        SET @immnumepedido = IFNULL((SELECT'
      '            cfgmgounumepedint'
      '          FROM cfgmgou LIMIT 1), 5000);'
      '      END IF;'
      ''
      '    END IF;'
      ''
      '    SET @posicao = 1;'
      ''
      '    SET @itemisi = 0;'
      '    SET @itemisi1 = 0;'
      ''
      '    SET @valortotaladicionais = 0;'
      ''
      '    WHILE (@posicao <= @qtd) DO'
      '      SET @valortotaladicionais = 0;'
      ''
      '      SET ErroMensagem = 3;'
      ''
      '      SET @item = (@item + 1);'
      '      SET @itemisi = (@itemisi + 1);'
      ''
      '      INSERT INTO ito (itochave'
      '      , orcchave'
      '      , procodigo'
      '      , puncodigo'
      '      , unicodigo'
      '      , stocodigo'
      '      , tdecodigo'
      '      , itoquantidade'
      '      , itovalorav'
      '      , itodescontoav'
      '      , itototalav'
      '      , itosaldoav'
      '      , itovalorap'
      '      , itodescontoap'
      '      , itototalap'
      '      , itosaldoap'
      '      , itocontendo'
      '      , itoproservico'
      '      , itoprocomple'
      '      , itodataalter'
      '      , itoitem'
      '      , itogint'
      '      , itopercdescap'
      '      , itopercdescav'
      '      , itoinfadprod'
      '      , itoquanticondi'
      '      , itoquantidevolcondi'
      '      , vrpcodigo'
      '      , itoobs'
      '      , flacodigo'
      '      , clbatendente'
      '      , oricodigo)'
      ''
      '        (SELECT'
      '          @novachave,'
      '          pOrcChave,'
      '          tito.procodigo,'
      '          tito.puncodigo,'
      '          uni.unicodigo,'
      '          2,'
      '          1,'
      '          tito.qtde,'
      '          pun.punprecoav,'
      '          0,'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          ROUND((qtde * pun.punprecoav), 2),'
      '          pun.punprecoap,'
      '          0,'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          ROUND((qtde * pun.punprecoap), 2),'
      '          pun.punmultiplicador,'
      '          '#39#39','
      '          '#39#39','
      '          CURRENT_DATE(),'
      '          @item,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          '#39#39','
      '          0,'
      '          0,'
      '          NULL,'
      '          tito.obs,'
      '          pFlaCodigo,'
      '          clbcodigo,'
      '          6'
      '        FROM tito'
      '          INNER JOIN pun'
      '            ON tito.puncodigo = pun.puncodigo'
      '          INNER JOIN uni'
      '            ON pun.unicodigo = uni.unicodigo'
      '        WHERE tito.ID = @posicao);'
      ''
      ''
      ''
      ''
      ''
      '      IF (SELECT'
      '            ROW_COUNT()) > 0 THEN'
      '        SET @itochave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      '        SELECT'
      '          procodigo,'
      '          obs,'
      '          sfnid,'
      '          sfncodigo,'
      '          copos,'
      '          pratos'
      '        FROM tito'
      '        WHERE tito.ID = @posicao INTO @procodigo'
      '        , @obs'
      '        , @sfnid'
      '        , @sfncodigo'
      '        , @copos'
      '        , @pratos;'
      ''
      ''
      ''
      ''
      '        IF @MocCodigo = 5 THEN'
      '          SET ErroMensagem = 6;'
      ''
      ''
      '          SELECT'
      '            gri.griminuretardo,'
      '            gri.tcicodigo'
      '          FROM gri'
      '            INNER JOIN pro'
      '              ON pro.grpcodigo = gri.grpcodigo'
      '            INNER JOIN ito'
      '              ON pro.procodigo = ito.procodigo'
      '          WHERE ito.itochave = @itochave INTO @griminuretardo'
      '          , @tcicodigo;'
      ''
      '          SET ErroMensagem = 61;'
      ''
      '          SET @immhoraimpresso = IFNULL((SELECT'
      '              NOW()'
      '            FROM trm'
      '            WHERE trmmesavendarapida IN (SELECT'
      '                orcmesa'
      '              FROM orc'
      '              WHERE orcchave = pOrcChave) LIMIT 1), NULL);'
      ''
      '          SET ErroMensagem = 162;'
      ''
      '          INSERT INTO imm (itochave'
      '          , tcicodigo'
      '          , immmodo'
      '          , cznchave'
      '          , immtemporetardo'
      '          , immnumepedido'
      '          , immhorapedido'
      '          , trmcodigo'
      '          , immdestino'
      '          , immcopos'
      '          , immpratos'
      '          , clbcodigo'
      '          , immhoraimpresso)'
      ''
      
        '            VALUES (@itochave, @tcicodigo, @vimmmodo, @cznchave,' +
        ' @griminuretardo, @immnumepedido, NOW(), 1, 1, @copos, @pratos, ' +
        'pClbCodigo, @immhoraimpresso);'
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      '          IF @sfncodigo > 0 THEN'
      ''
      '            SELECT'
      '              COUNT(brdcodigo)'
      ''
      '            FROM tbrd'
      '            WHERE tbrd.sfnid = @sfnid'
      '            AND tbrd.sfncodigo = @sfncodigo INTO @qtdbordas;'
      ''
      '            IF @qtdbordas > 0 THEN'
      '              INSERT INTO bri (brichave'
      '              , itochave'
      '              , brdcodigo'
      '              , briincluir)'
      '                (SELECT'
      '                  @novachave,'
      '                  @itochave,'
      '                  brdcodigo,'
      '                  1'
      '                FROM tbrd'
      '                WHERE tbrd.sfnid = @sfnid'
      '                AND tbrd.sfncodigo = @sfncodigo);'
      ''
      ''
      '              SET ErroMensagem = 71;'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      ''
      '                SET @vlborda = IFNULL((SELECT'
      '                    pun.punprecoav punprecoav'
      '                  FROM bri'
      '                    INNER JOIN ito'
      '                      ON bri.itochave = ito.itochave'
      '                    INNER JOIN brd'
      '                      ON bri.brdcodigo = brd.brdcodigo'
      '                    INNER JOIN pro'
      '                      ON brd.procodigo = pro.procodigo'
      '                    INNER JOIN pun'
      '                      ON pro.procodigo = pun.procodigo'
      '                      AND ito.unicodigo = pun.unicodigo'
      '                  WHERE bri.itochave = @itochave LIMIT 1), 0);'
      ''
      '                SET ErroMensagem = 72;'
      ''
      '                IF @vlborda > 0 THEN'
      '                  UPDATE ito'
      
        '                  SET ito.itovalorav = (ito.itovalorav + @vlbord' +
        'a),'
      
        '                      ito.itovalorap = (ito.itovalorap + @vlbord' +
        'a),'
      
        '                      ito.itototalav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itototalap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2),'
      
        '                      ito.itosaldoav = ROUND((ito.itovalorav * i' +
        'to.itoquantidade), 2) - ito.itodescontoav,'
      
        '                      ito.itosaldoap = ROUND((ito.itovalorap * i' +
        'to.itoquantidade), 2) - ito.itodescontoav'
      ''
      '                  WHERE ito.itochave = @itochave;'
      '                END IF;'
      '              END IF;'
      ''
      ''
      '            END IF;'
      ''
      '            DELETE'
      '              FROM tsbi;'
      ''
      '            SET ErroMensagem = 73;'
      ''
      '            DROP TEMPORARY TABLE IF EXISTS tsbi;'
      ''
      '            CREATE TEMPORARY TABLE IF NOT EXISTS tsbi ('
      '              ID int NOT NULL AUTO_INCREMENT,'
      '              sbrcodigo int,'
      '              sbiobs varchar(100),'
      '              bprchave int,'
      '              sbiitem int,'
      '              PRIMARY KEY (ID)'
      '            ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '            SET @novasbiid = 0;'
      ''
      '            SET ErroMensagem = 74;'
      ''
      '            INSERT INTO tsbi'
      '              (SELECT'
      '                tisi.ID,'
      '                tisi.sbrcodigo,'
      '                tisi.obs,'
      '                tisi.bprchave,'
      '                tisi.isiitem'
      '              FROM tisi'
      '              WHERE tisi.isitipo = 2);'
      ''
      ''
      ''
      ''
      ''
      '            SET @possbi = 1;'
      ''
      '            SET ErroMensagem = 74;'
      ''
      '            WHILE (@possbi <= @posicao) DO'
      '              INSERT INTO sbi (sbichave'
      '              , itochave'
      '              , sbrcodigo'
      '              , sbiobs'
      '              , bprchave'
      '              , sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  tsbi.sbrcodigo,'
      '                  tsbi.sbiobs,'
      '                  tsbi.bprchave,'
      '                  tsbi.sbiitem'
      '                FROM tsbi'
      '                WHERE tsbi.sbiitem = @item);'
      ''
      '              SET ErroMensagem = 75;'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      ''
      '                SET @sbrcodigo = (SELECT'
      '                    sbrcodigo'
      '                  FROM sbi'
      '                  WHERE sbichave = @sbichave);'
      ''
      '                SET ErroMensagem = 76;'
      ''
      '                INSERT INTO isi (isichave'
      '                , sbichave'
      '                , tsicodigo'
      '                , procodigo'
      '                , itochave'
      '                , isiitem'
      '                , isitipo'
      '                , isiquantidade)'
      '                  (SELECT'
      '                    @novachave,'
      '                    (SELECT'
      '                        sbichave'
      '                      FROM sbi'
      '                      WHERE itochave = @itochave'
      '                      AND sbrcodigo = tisi.sbrcodigo) sbichave,'
      '                    tisi.tsicodigo,'
      '                    tisi.procodigo,'
      '                    @itochave,'
      '                    tisi.isiitem,'
      '                    tisi.isitipo,'
      '                    tisi.isiquantidade'
      '                  FROM tisi'
      ''
      '                  WHERE tisi.isitipo != 2);'
      ''
      '                SET ErroMensagem = 77;'
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      ''
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      ''
      '                  IF (@valortotaladicionais IS NOT NULL) THEN'
      '                    UPDATE ito'
      
        '                    SET itoacrescimoav = itoacrescimoav + @valor' +
        'totaladicionais'
      '                    WHERE itochave = @itochave;'
      '                  END IF;'
      '                  SET ErroMensagem = 78;'
      ''
      '                END IF;'
      ''
      '              END IF;'
      '              SET @possbi = (@possbi + 1);'
      '              SET @valortotaladicionais = 0;'
      '            END WHILE;'
      ''
      ''
      '            SET ErroMensagem = 78;'
      ''
      ''
      ''
      ''
      ''
      '          ELSE'
      ''
      '            IF (SELECT'
      '                  COUNT(*)'
      '                FROM tisi) = 0 THEN'
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novasbichave,'
      '                  @itochave,'
      '                  sbr.sbrcodigo,'
      '                  @obs,'
      '                  1'
      '                FROM sbr'
      '                WHERE sbr.procodigo = @procodigo LIMIT 1);'
      '            ELSE'
      '              SET ErroMensagem = 79;'
      ''
      '              INSERT INTO sbi (sbi.sbichave'
      '              , sbi.itochave'
      '              , sbi.sbrcodigo'
      '              , sbi.sbiobs'
      '              , sbi.bprchave'
      '              , sbi.sbiitem)'
      '                (SELECT'
      '                  @novachave,'
      '                  @itochave,'
      '                  tisi.sbrcodigo,'
      
        '                  IF(IFNULL(tisi.obs, '#39#39') != '#39#39', tisi.obs, @obs)' +
        ','
      '                  tisi.bprchave,'
      '                  tisi.isiitem'
      '                FROM tisi'
      '                  INNER JOIN sbr'
      '                    ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                WHERE sbr.procodigo = @procodigo LIMIT 1);'
      ''
      ''
      ''
      '              SET ErroMensagem = 80;'
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @sbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      ''
      ''
      '                INSERT INTO isi (isichave'
      '                , sbichave'
      '                , tsicodigo'
      '                , procodigo'
      '                , itochave'
      '                , isiitem'
      '                , isitipo'
      '                , isiquantidade)'
      '                  (SELECT DISTINCT'
      '                    @novachaveisi,'
      '                    @sbichave,'
      '                    tisi.tsicodigo,'
      '                    tisi.procodigo,'
      '                    @itochave,'
      '                    @itemisi,'
      '                    tisi.isitipo,'
      '                    tisi.isiquantidade'
      '                  FROM tisi'
      '                    INNER JOIN sbr'
      '                      ON tisi.sbrcodigo = sbr.sbrcodigo'
      '                  WHERE sbr.procodigo = @procodigo);'
      '                SET ErroMensagem = 81;'
      ''
      ''
      '                IF (SELECT'
      '                      ROW_COUNT()) > 0 THEN'
      '                  SET @isichave = (SELECT'
      '                      LAST_INSERT_ID());'
      '                  SET @valortotaladicionais = (SELECT'
      
        '                      SUM(pun.punprecoav * isiquantidade) punpre' +
        'coav'
      '                    FROM isi'
      '                      INNER JOIN sbi'
      '                        ON isi.sbichave = sbi.sbichave'
      '                      INNER JOIN sbr'
      '                        ON sbi.sbrcodigo = sbr.sbrcodigo'
      '                      INNER JOIN pro'
      '                        ON isi.procodigo = pro.procodigo'
      '                      INNER JOIN pun'
      '                        ON pro.procodigo = pun.procodigo'
      '                        AND pro.unicodigo = pun.unicodigo'
      '                    WHERE sbrcobraadicional = 1'
      '                    AND isi.itochave = @itochave'
      '                    AND isi.isitipo = 1'
      '                    AND pun.punprecoav > 0);'
      '                  SET ErroMensagem = 82;'
      ''
      '                  IF (@valortotaladicionais IS NOT NULL) THEN'
      ''
      '                    UPDATE ito'
      
        '                    SET itoacrescimoav = itoacrescimoav + @valor' +
        'totaladicionais'
      '                    WHERE itochave = @itochave;'
      '                  END IF;'
      ''
      ''
      '                END IF;'
      '              END IF;'
      '            END IF;'
      ''
      '          END IF;'
      '        END IF;'
      ''
      '      END IF;'
      ''
      '      SET ErroMensagem = 83;'
      '      UPDATE ito'
      '      SET ito.itovalorav = (ito.itovalorav),'
      '          ito.itovalorap = (ito.itovalorap),'
      
        '          ito.itototalav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade) + (itoacrescimoav * ito.itoquantidade), 2),'
      
        '          ito.itototalap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade) + (itoacrescimoav * ito.itoquantidade), 2),'
      
        '          ito.itosaldoav = ROUND((ito.itovalorav * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav,'
      
        '          ito.itosaldoap = ROUND((ito.itovalorap * ito.itoquanti' +
        'dade), 2) - ito.itodescontoav'
      '      WHERE ito.itochave = @itochave;'
      ''
      ''
      '      SET ErroMensagem = 84;'
      ''
      '      SET @posicao = @posicao + 1;'
      '      SET @valortotaladicionais = 0;'
      '    END WHILE;'
      ''
      '    SET ErroMensagem = 8;'
      '    SET ErroMensagem = 85;'
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(ito.itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(ito.itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      '        orc.orcdescontoav = tito.descav,'
      '        orc.orcpercdescav = 0,'
      '        orc.orctotalav = (tito.totav - tito.descav),'
      '        orc.orcgeralap = tito.totap,'
      '        orc.orcdescontoap = tito.descap,'
      '        orc.orcpercdescap = 0,'
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        stocodigo = @stocodigo'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '    IF NOT ErroException THEN'
      ''
      '      DELETE'
      '        FROM tito;'
      '      DELETE'
      '        FROM tbrd;'
      ''
      '      DELETE'
      '        FROM tisi;'
      ''
      '      DELETE'
      '        FROM tsbi;'
      ''
      '      DELETE'
      '        FROM trdc;'
      ''
      '    COMMIT;'
      ''
      '    SET pConfirma = ErroException;'
      '    SET pMensagem = '#39'Pedido gravado com sucesso !'#39';'
      '  END IF;'
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS TransfereMesa//'
      'CREATE DEFINER = '#39'root'#39'@'#39'localhost'#39
      'PROCEDURE TransfereMesa (IN pOrcChave int'
      ', OUT pConfirma int'
      ', OUT pMensagem varchar(65000))'
      'BEGIN'
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      ''
      ''
      ''
      ''
      '  SET ErroMensagem = 2;'
      ''
      '  DROP TEMPORARY TABLE IF EXISTS tmp;'
      '  CREATE TEMPORARY TABLE tmp ('
      '    secao int NOT NULL,'
      '    id int NOT NULL,'
      '    chave int NOT NULL,'
      '    PRIMARY KEY (secao, id)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  SET @qtd = (SELECT'
      '      COUNT(*)'
      '    FROM ttro);'
      '  SET @posicao = 1;'
      ''
      ''
      '  WHILE (@posicao <= @qtd) DO'
      ''
      '    SELECT'
      '      orcchave'
      '    FROM ttro'
      '    WHERE ID = @posicao INTO @orcchave;'
      ''
      '    SELECT'
      '      orcchaveorigem'
      '    FROM tro'
      '    WHERE orcchavedestino = @orcchave INTO @orcchaveorigem;'
      ''
      ''
      '    SELECT'
      '      clbcodigo'
      '    FROM ttro'
      '    WHERE ID = @posicao INTO @ttroclbcodigo;'
      ''
      '    SELECT'
      '      registro'
      '    FROM ttro'
      '    WHERE ID = @posicao INTO @ttroregistro;'
      ''
      '    UPDATE olt'
      '    SET orcchave = pOrcChave'
      '    WHERE orcchave = @orcchave;'
      ''
      '    UPDATE unm'
      '    SET unm.orcchave = pOrcChave'
      '    WHERE orcchave = @orcchave;'
      ''
      ''
      '    IF IFNULL(@orcchaveorigem, 0) = 0 THEN'
      '      INSERT INTO tro (tro.trochave'
      '      , tro.orcchaveorigem'
      '      , tro.orcchavedestino'
      '      , tro.clbcodigo'
      '      , tro.troregistro)'
      
        '        VALUES (@novachave, @orcchave, pOrcChave, @ttroclbcodigo' +
        ', @ttroregistro);'
      '    ELSE'
      '      INSERT INTO tro (tro.trochave'
      '      , tro.orcchaveorigem'
      '      , tro.orcchavedestino'
      '      , tro.clbcodigo'
      '      , tro.troregistro)'
      
        '        VALUES (@novachave, @orcchaveorigem, pOrcChave, @ttroclb' +
        'codigo, @ttroregistro);'
      ''
      '    END IF;'
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 7;'
      ''
      '    SET @totalitens = ROUND(IFNULL((SELECT'
      '        SUM(itototalav)'
      '      FROM ito'
      '      WHERE ito.orcchave = @OrcChave'
      '      AND stocodigo IN (1, 2, 5)), 0), 2);'
      ''
      '    UPDATE orc'
      '    SET orc.orcgeralav = @totalitens,'
      '        orc.orcgeralap = @totalitens,'
      '        orc.orctotalav = @totalitens,'
      '        orc.orctotalap = @totalitens'
      '    WHERE orc.orcchave = @OrcChave;'
      ''
      '    SET ErroMensagem = 4;'
      ''
      '    DELETE'
      '      FROM tmp;'
      ''
      '    SET @pos = 0;'
      '    INSERT INTO tmp (secao'
      '    , id'
      '    , chave)'
      '      (SELECT'
      '        1,'
      '        @pos := (@pos + 1),'
      '        ito.itochave'
      '      FROM ito'
      '      WHERE orcchave = @orcchave'
      '      AND stocodigo IN (1, 2, 5));'
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @tmp1cont = 1;'
      '      SET @tmp1qtde = (SELECT'
      '          COUNT(*)'
      '        FROM tmp'
      '        WHERE secao = 1);'
      ''
      '      WHILE (@tmp1cont <= @tmp1qtde) DO'
      ''
      '        SELECT'
      '          CHAVE'
      '        FROM tmp'
      '        WHERE ID = @tmp1cont'
      '        AND secao = 1 INTO @OLD_itochave;'
      ''
      '        INSERT INTO ito (orcchave'
      '        , procodigo'
      '        , puncodigo'
      '        , unicodigo'
      '        , stocodigo'
      '        , tdecodigo'
      '        , itoquantidade'
      '        , itovalorav'
      '        , itodescontoav'
      '        , itototalav'
      '        , itosaldoav'
      '        , itovalorap'
      '        , itodescontoap'
      '        , itototalap'
      '        , itosaldoap'
      '        , itocontendo'
      '        , itoproservico'
      '        , itoprocomple'
      '        , itodataalter'
      '        , itoitem'
      '        , itogint'
      '        , itopercdescap'
      '        , itopercdescav'
      '        , itoinfadprod'
      '        , itoquanticondi'
      '        , itoquantidevolcondi'
      '        , vrpcodigo'
      '        , itoobs'
      '        , itoacrescimoav)'
      '          (SELECT'
      '            pOrcChave,'
      '            procodigo,'
      '            puncodigo,'
      '            unicodigo,'
      '            2,'
      '            tdecodigo,'
      '            itoquantidade,'
      '            itovalorav,'
      '            itodescontoav,'
      '            itototalav,'
      '            itosaldoav,'
      '            itovalorap,'
      '            itodescontoap,'
      '            itototalap,'
      '            itosaldoap,'
      '            itocontendo,'
      '            itoproservico,'
      '            itoprocomple,'
      '            itodataalter,'
      '            (SELECT'
      '                COUNT(*) + 1'
      '              FROM ito'
      '              WHERE orcchave = pOrcChave),'
      '            itogint,'
      '            itopercdescap,'
      '            itopercdescav,'
      '            itoinfadprod,'
      '            itoquanticondi,'
      '            itoquantidevolcondi,'
      '            vrpcodigo,'
      '            itoobs,'
      '            itoacrescimoav'
      '          FROM ito'
      '          WHERE itochave = @OLD_itochave);'
      ''
      '        SET @itochave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      '        UPDATE imm'
      '        SET imm.itochave = @itochave'
      '        WHERE itochave = @OLD_itochave;'
      ''
      ''
      '        SET ErroMensagem = 5;'
      ''
      '        DELETE'
      '          FROM tmp'
      '        WHERE secao = 2;'
      ''
      '        SET @pos = 0;'
      '        INSERT INTO tmp (secao'
      '        , id'
      '        , chave)'
      '          (SELECT'
      '            2,'
      '            @pos := (@pos + 1),'
      '            sbi.sbichave'
      '          FROM sbi'
      '          WHERE sbi.itochave = @OLD_itochave);'
      ''
      '        IF (SELECT'
      '              ROW_COUNT()) > 0 THEN'
      '          SET @tmp2cont = 1;'
      '          SET @tmp2qtde = (SELECT'
      '              COUNT(*)'
      '            FROM tmp'
      '            WHERE secao = 2);'
      ''
      '          WHILE (@tmp2cont <= @tmp2qtde) DO'
      ''
      '            SET ErroMensagem = 5;'
      ''
      '            SELECT'
      '              CHAVE'
      '            FROM tmp'
      '            WHERE ID = @tmp2cont'
      '            AND secao = 2 INTO @OLD_sbichave;'
      ''
      '            INSERT INTO sbi (itochave'
      '            , sbrcodigo'
      '            , sbiobs'
      '            , sbiitem'
      '            , bprchave)'
      '              (SELECT'
      '                @itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM sbi'
      '              WHERE sbichave = @OLD_sbichave);'
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @sbichave = (SELECT'
      '                  LAST_INSERT_ID());'
      ''
      '              SET ErroMensagem = 6;'
      ''
      '              INSERT INTO isi (sbichave'
      '              , tsicodigo'
      '              , procodigo'
      '              , isitipo'
      '              , itochave'
      '              , isiitem'
      '              , isiquantidade)'
      '                (SELECT'
      '                  @sbichave,'
      '                  tsicodigo,'
      '                  procodigo,'
      '                  isitipo,'
      '                  itochave,'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi'
      '                WHERE sbichave = @OLD_sbichave);'
      '            END IF;'
      ''
      '            SET @tmp2cont = (@tmp2cont + 1);'
      '          END WHILE;'
      '        END IF;'
      ''
      ''
      '        SET ErroMensagem = 3;'
      ''
      '        UPDATE orc'
      '        SET stocodigo = 9'
      '        WHERE orcchave = @orcchave;'
      ''
      '        UPDATE ito'
      '        SET stocodigo = 9'
      '        WHERE orcchave = @orcchave'
      '        AND stocodigo = 2;'
      ''
      '        SET @tmp1cont = (@tmp1cont + 1);'
      '      END WHILE;'
      '    END IF;'
      ''
      '    SET @posicao = (@posicao + 1);'
      '  END WHILE;'
      ''
      '  SET ErroMensagem = 7;'
      ''
      '  SET @totalitens = ROUND(IFNULL((SELECT'
      '      SUM(itototalav)'
      '    FROM ito'
      '    WHERE ito.orcchave = pOrcChave'
      '    AND stocodigo IN (1, 2, 5)), 0), 2);'
      ''
      '  UPDATE orc'
      '  SET orc.orcgeralav = @totalitens,'
      '      orc.orcgeralap = @totalitens,'
      '      orc.orctotalav = @totalitens,'
      '      orc.orctotalap = @totalitens'
      '  WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '  SET pConfirma = ErroException;'
      '  SET pMensagem = '#39'Mesas transferidas com sucesso !'#39';'
      ''
      ''
      ''
      'END//')
    Delimiter = '//'
    Left = 312
    Top = 480
  end
  object us001287: TUniScript
    SQL.Strings = (
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(301, '#39'Total'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(302, '#39'Hotcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(303, '#39'Formosa'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(304, '#39'Valecon'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(305, '#39'Banco GE'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(306, '#39'DTransfer'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(307, '#39'Expandcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(308, '#39'Softcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(309, '#39'Cocipa'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(310, '#39'Simcred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(311, '#39'DDTotal'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(312, '#39'Eletrozema'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(313, '#39'Finamax'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(314, '#39'SCCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(315, '#39'Valeshop'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(316, '#39'GCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(317, '#39'Topcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(318, '#39'Somarcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(319, '#39'Condor'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(320, '#39'Usecred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(321, '#39'DMcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(322, '#39'Bancred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(323, '#39'Braziliancard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(324, '#39'Fidelize'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(325, '#39'Workercard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(326, '#39'ACCcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(327, '#39'Cartao Evangelico'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(328, '#39'Barigui'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(329, '#39'Gazincred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(330, '#39'Validata'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(331, '#39'Upsight'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(332, '#39'Resomaq'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(333, '#39'Orgcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(334, '#39'Smartn'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(335, '#39'Credicesta'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(336, '#39'Nutricard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(337, '#39'Foxwincard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(338, '#39'Softway'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(339, '#39'SQCF'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(340, '#39'JGV'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(341, '#39'MAR'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(342, '#39'CSF'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(343, '#39'Praticard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(344, '#39'Sysprocard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(345, '#39'Autoexpresso'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(346, '#39'Novocard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(347, '#39'Consignum'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(348, '#39'Mettacard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(349, '#39'Fleetcor'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(350, '#39'UniMais'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(351, '#39'Aceito'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(352, '#39'Zaffari'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(353, '#39'AtualGroup'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(354, '#39'Leccacond'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(355, '#39'Orbitall'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(356, '#39'Tecban'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(357, '#39'Getnet'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(358, '#39'Fidelidade Mais'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(359, '#39'Fancard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(360, '#39'IBI'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(361, '#39'Conductor'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      
        '(362, '#39'Bradesco Private Label'#39', '#39'Skytef'#39', '#39'Credito Private Label' +
        #39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(363, '#39'GR Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(364, '#39'LiderCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(365, '#39'SinCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(366, '#39'SindPlus'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(367, '#39'TotalCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(368, '#39'UnirCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(369, '#39'Usecard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(370, '#39'CajuCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(371, '#39'FranCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(372, '#39'SindCred'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(373, '#39'ViaCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(374, '#39'Asfel'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(375, '#39'Atfpmb'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(376, '#39'Cred Vip'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(377, '#39'Assomise Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(378, '#39'ACSPMESP'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(379, '#39'008 Cards'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(380, '#39'DMTPlus'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(381, '#39'Global Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(382, '#39'Trinnus'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(383, '#39'Forte Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(384, '#39'Simec'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(385, '#39'Qualidade'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(386, '#39'Abrapetite'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(387, '#39'Alliance'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(388, '#39'City Business'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(389, '#39'Convenicard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(390, '#39'Drogabella'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(391, '#39'Flexocard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(392, '#39'Hugcards'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(393, '#39'Quatrocard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(394, '#39'Romcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(395, '#39'Systemcard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(396, '#39'Unocard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(397, '#39'Utilizecards'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(398, '#39'Utilizecards'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(399, '#39'Verycard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(400, '#39'VMX'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(401, '#39'Autocred card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(402, '#39'Bluecash'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(403, '#39'Micromob'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(404, '#39'Qualicard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(405, '#39'Qualicard'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(406, '#39'ACIACCARD'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(407, '#39'Kawakami'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(408, '#39'Mais'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(409, '#39'Dibs'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(410, '#39'Kallan'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(411, '#39'Ed'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(412, '#39'ShoeBiz'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(413, '#39'Torra Torra'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(414, '#39'Khelf'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(415, '#39'Muito'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(416, '#39'Di Gaspi'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(417, '#39'Pontal Card'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(418, '#39'Humanitarian'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(419, '#39'Novo Mundo'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(420, '#39'TennisBar'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(421, '#39'Mais Mega Loja'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(422, '#39'Saito'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(423, '#39'Demanos Dimanos'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(424, '#39'Elmo'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(425, '#39'Tesoura de Ouro'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(426, '#39'Lojao do Bras'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      
        '(427, '#39'Freecenter Calcados'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')/' +
        '/'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      
        '(428, '#39'Magazine da Economia'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')' +
        '//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(429, '#39'Polyelle'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(430, '#39'Kattan'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(431, '#39'Emanuelle PE'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(432, '#39'Emmanuelle SE'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(433, '#39'Katuxa Calcados'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(434, '#39'Grippon SP'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(435, '#39'Eskala'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(436, '#39'Deny Sports'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(437, '#39'Princesa'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(438, '#39'Del Fiori'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      
        '(439, '#39'Paqueta Calcados LT'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')/' +
        '/'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(440, '#39'3B'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(441, '#39'Roldao Atacadista'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(442, '#39'Estudio Shoes'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(443, '#39'Passarela Modas'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(444, '#39'Itapua'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(445, '#39'Objetiva'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(446, '#39'Ponto Mix'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(447, '#39'Casa e Video'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(448, '#39'Sonho dos Pes'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(449, '#39'Sapatella'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(450, '#39'Leader'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(451, '#39'Costazul Alimentos'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(452, '#39'SuperPrix'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(453, '#39'Campe'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(454, '#39'Kiab'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(455, '#39'Fonsec'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(456, '#39'SK'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(457, '#39'Di Santinni'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(458, '#39'Hakuo'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(459, '#39'Zinzane'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(460, '#39'Taco'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(461, '#39'Epa E'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(462, '#39'Alegria'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(463, '#39'Rede Litoral'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(464, '#39'Caedu'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(465, '#39'Zuken Vip'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(466, '#39'Econ Card'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(467, '#39'Bello Card'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(468, '#39'Aptare'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(469, '#39'Midway'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(470, '#39'Midway Mastercard'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(471, '#39'Midway Visa'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(472, '#39'TeuCard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(473, '#39'Greencard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(474, '#39'UPI'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(475, '#39'Dafiti'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(476, '#39'Discover'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(477, '#39'ViaSoftPay'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(478, '#39'Somapay'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(479, '#39'Bracov'#39', '#39'Skytef'#39', '#39'Credito'#39')//')
    Delimiter = '//'
    Left = 440
    Top = 432
  end
  object us001288: TUniScript
    SQL.Strings = (
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10001, '#39'Ticket'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10002, '#39'Visa'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10003, '#39'Sodexo'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10004, '#39'Nutricash'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10005, '#39'Greencard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10006, '#39'Planvale'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10007, '#39'Banquet'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10008, '#39'Verocheque'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10009, '#39'Sapore'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10010, '#39'BNBClube'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10011, '#39'Valecard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10012, '#39'Cabal'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10014, '#39'Diners'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10019, '#39'Alelo'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10021, '#39'Alelo'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10022, '#39'Alelo'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10023, '#39'Alelo'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10024, '#39'Ticket'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10025, '#39'Ticket'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10027, '#39'Ticket'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10028, '#39'Sodexo'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10029, '#39'Sodexo'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10030, '#39'Sodexo'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10031, '#39'Sodexo'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10032, '#39'Sodexo'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10033, '#39'Sodexo'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10037, '#39'Sorocred'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10039, '#39'Valemulti'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10040, '#39'Valefrota'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10044, '#39'Coopercred'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10046, '#39'Valefacil'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10047, '#39'VR'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10048, '#39'VR'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10049, '#39'VR'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10050, '#39'VR'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10051, '#39'Planvale'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10052, '#39'Refeisul'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10053, '#39'Nutricash'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10054, '#39'Ticket'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10055, '#39'Valecard'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10056, '#39'Coopercred'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10070, '#39'VR'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10071, '#39'Planvale'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10072, '#39'Planvale'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10073, '#39'Planvale'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10074, '#39'Planvale'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10075, '#39'Planvale'#39', '#39'Skytef'#39', '#39'Voucher Farmacia'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10076, '#39'Peela'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10077, '#39'Libercard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10082, '#39'Elo'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10082, '#39'Alelo'#39', '#39'Skytef'#39', '#39'Combustivel Frota'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10083, '#39'VR'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10088, '#39'Refeisul'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10089, '#39'Refeisul'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10090, '#39'Verocheque'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10100, '#39'Qualita'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10103, '#39'Todo'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10110, '#39'Vale Express'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10112, '#39'Goldicard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10113, '#39'Fleetcard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10116, '#39'HubPrePaid'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10117, '#39'FlexFrota'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10122, '#39'Telenet'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10123, '#39'Telenet'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10125, '#39'TicketLog'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10129, '#39'Softnex'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10132, '#39'Goodcard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10133, '#39'Goodcard'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10134, '#39'Goodcard'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10135, '#39'Goodcard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10136, '#39'Veloe'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10137, '#39'Coopercred'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10138, '#39'Coopercred'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10139, '#39'Wizeo'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10140, '#39'Ben VisaVale'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10141, '#39'Ben VisaVale'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10142, '#39'Abrapetite'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10143, '#39'AvanCard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10144, '#39'Biq'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10146, '#39'BonusCred'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10147, '#39'Convenios Card'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10149, '#39'CrediAlimentacao'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10150, '#39'Eucard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10151, '#39'FaceCard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10152, '#39'Fleetcard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10153, '#39'Lecard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10154, '#39'Nutricard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10155, '#39'Senff'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10156, '#39'SindPlus'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10157, '#39'Usecred'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10158, '#39'Valeshop'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10159, '#39'Vegascard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10160, '#39'VS Card'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10161, '#39'Rotacard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10162, '#39'Policard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10163, '#39'Policard'#39', '#39'Skytef'#39', '#39'Combustivel Frota'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10164, '#39'Policard'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10165, '#39'Policard'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10168, '#39'Policard'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10169, '#39'Senff'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10170, '#39'Senff'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10171, '#39'Senff'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10172, '#39'Coopercred'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10173, '#39'Greencard'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10174, '#39'Greencard'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10175, '#39'Greencard'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10176, '#39'Verocheque'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10177, '#39'Verocheque'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10178, '#39'Policard'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10179, '#39'Policard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10180, '#39'Valeshop'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10181, '#39'Portalcard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10182, '#39'PersonalCard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10183, '#39'LifeCard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10184, '#39'TrioCard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10185, '#39'ACCredito'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10186, '#39'ECXCard'#39', '#39'Skytef'#39', '#39'Combustivel Frota'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10187, '#39'TruckPag'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10188, '#39'Visa'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10189, '#39'Master'#39', '#39'Skytef'#39', '#39'Credito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10190, '#39'Azul Card'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10191, '#39'BandCard'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10192, '#39'Banese'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10193, '#39'Bank'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10194, '#39'BiCartoes'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10195, '#39'Bigcard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10196, '#39'Bluebank'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10197, '#39'CampeloCard'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10198, '#39'Cartao Confianca'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10199, '#39'Irani'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10200, '#39'Irani'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10201, '#39'Clube Demais'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10202, '#39'Condor'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10203, '#39'Ediz'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10204, '#39'Enscon Card'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10205, '#39'Formosa'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10206, '#39'GiraCard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10207, '#39'Idealcard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10208, '#39'Imperatriz'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10209, '#39'Neus'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10210, '#39'Neus Minas'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10211, '#39'PagueMenos'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10212, '#39'PG Card'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10213, '#39'Queiroz Premium'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10214, '#39'Queiroz Premium'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10215, '#39'SindConvenios'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10216, '#39'Sollus'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10217, '#39'Sollus'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10218, '#39'SuperCred'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10219, '#39'ValeMais'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10220, '#39'ValeMais'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10221, '#39'Valle Real'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10222, '#39'Vegas'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10223, '#39'PagueMenos'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10224, '#39'Paracatu Card'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10225, '#39'Servir'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10226, '#39'Sertao Card'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10227, '#39'Sintram'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10228, '#39'ValeMais'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10229, '#39'Valle Real'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10230, '#39'Master'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10231, '#39'Master'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10232, '#39'Siapnet'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10233, '#39'Siapnet'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10234, '#39'Siapnet'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10235, '#39'Siapnet'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10236, '#39'Siapnet'#39', '#39'Skytef'#39', '#39'Combustivel Frota'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10237, '#39'Valecard'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10238, '#39'Valecard'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10239, '#39'Valepres Sysdata'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10240, '#39'Valepres Peela'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10241, '#39'Sysdata'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10242, '#39'Alelo'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10252, '#39'BlackHawk'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10253, '#39'Vegascard'#39', '#39'Skytef'#39', '#39'Combustivel Frota'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10254, '#39'Onesmart'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10255, '#39'Card Ideal'#39', '#39'Skytef'#39', '#39'Combustivel Frota'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10256, '#39'ConnectyPay'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10257, '#39'ABM Cash'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10258, '#39'Uauh'#39', '#39'Skytef'#39', '#39'Combustivel Frota'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10259, '#39'Uauh'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10260, '#39'Uauh'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10261, '#39'Uauh'#39', '#39'Skytef'#39', '#39'Voucher Farmacia'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10262, '#39'Uauh'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10263, '#39'Volus'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10264, '#39'Romcard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10265, '#39'Verocheque'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10266, '#39'Master'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10267, '#39'Amex'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10268, '#39'Itau'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10269, '#39'Sodexo'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10270, '#39'Cabal'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10271, '#39'Cabal'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10272, '#39'Cabal'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10273, '#39'Bonus CBA'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10274, '#39'Bonus CBA'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10275, '#39'Tipcard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10276, '#39'Biq'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10277, '#39'BNBClube'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10278, '#39'Nutricash'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10279, '#39'Greencard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10280, '#39'Credialiment'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10281, '#39'Refeisul'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10282, '#39'Valecard'#39', '#39'Skytef'#39', '#39'Nenhum'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10283, '#39'Valecard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10284, '#39'Valefrota'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10285, '#39'VR'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10286, '#39'GPA'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10287, '#39'Banpara'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10288, '#39'Amazoncard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10289, '#39'Yamada'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10290, '#39'Goiascard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10291, '#39'Credpar'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10292, '#39'Maxxcard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10293, '#39'Banese'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10294, '#39'GCard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10295, '#39'Topcard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10296, '#39'Gax'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10297, '#39'Upsight'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10298, '#39'Smartn'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10299, '#39'Sollus'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10300, '#39'SQCF'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10301, '#39'Bigcard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10302, '#39'JGV'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10303, '#39'Senff'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10304, '#39'Fleetcor'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10305, '#39'EPay'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10306, '#39'Fancard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10307, '#39'SindPlus'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10308, '#39'Usecard'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10309, '#39'Usecard'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10310, '#39'Convenios Card'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10311, '#39'Trinnus'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10312, '#39'Abrapetite'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10313, '#39'HubPrePaid'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10314, '#39'HubPrePaid'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10315, '#39'Ben VisaVale'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10316, '#39'Mercado Pago'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10317, '#39'IzPay'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10318, '#39'Vee'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10319, '#39'MoneyPag'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10320, '#39'Cielo'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10321, '#39'PicPay'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10322, '#39'4all'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10323, '#39'TaPago'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10324, '#39'Troco Simples'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10325, '#39'BeeVale'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10326, '#39'BrinksPay'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10327, '#39'PagBank'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10328, '#39'Oro'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10329, '#39'Bamex'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10330, '#39'Bamex'#39', '#39'Skytef'#39', '#39'Combustivel Frota'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10331, '#39'ViaSoftPay'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10353, '#39'IDid'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10354, '#39'Cash Berti'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10355, '#39'Sorocred'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10356, '#39'Sorocred'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10357, '#39'Cabal'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10358, '#39'Cabal'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10359, '#39'Nutricash'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10360, '#39'Nutricash'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10361, '#39'Nutricash'#39', '#39'Skytef'#39', '#39'Voucher Beneficio'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10362, '#39'Maxxcard'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10363, '#39'Maxxcard'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10364, '#39'Maxxcard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10365, '#39'Maxxcard'#39', '#39'Skytef'#39', '#39'Voucher Cultura'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10366, '#39'Volus'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10367, '#39'Volus'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10368, '#39'PersonalCard'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10369, '#39'PersonalCard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10370, '#39'Sorocred'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10371, '#39'Onesmart'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10372, '#39'Onesmart'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10373, '#39'PersonalCard'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10374, '#39'Pay Face'#39', '#39'Skytef'#39', '#39'Carteira Digital'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10375, '#39'OneCard'#39', '#39'Skytef'#39', '#39'Combustivel Frota'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10376, '#39'008 Cards'#39', '#39'Skytef'#39', '#39'Combustivel Frota'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10377, '#39'008 Cards'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10378, '#39'008 Cards'#39', '#39'Skytef'#39', '#39'Voucher Refeicao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10379, '#39'008 Cards'#39', '#39'Skytef'#39', '#39'Voucher Alimentacao'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10380, '#39'Fitcard'#39', '#39'Skytef'#39', '#39'Voucher'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(10381, '#39'Alelo'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//')
    Delimiter = '//'
    Left = 24
    Top = 520
  end
  object us001289: TUniScript
    SQL.Strings = (
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20001, '#39'Master'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20002, '#39'Visa'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20003, '#39'Cabal'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20032, '#39'Elo'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20034, '#39'Policard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20036, '#39'Banescard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20037, '#39'Hiper'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20042, '#39'Sicredi'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20059, '#39'Banpara'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20071, '#39'Sorocred'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20072, '#39'Maxxicard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20073, '#39'Maxxicard'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20074, '#39'Maxxicard'#39', '#39'Skytef'#39', '#39'Gift'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20075, '#39'Maxxicard'#39', '#39'Skytef'#39', '#39'Combustivel'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20076, '#39'Ticket'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20085, '#39'Banrisul'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20092, '#39'Banese'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20106, '#39'Maxxvan'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20111, '#39'Vale Express'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20115, '#39'Daycard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20120, '#39'ConvenioFacil'#39', '#39'Skytef'#39', '#39'Credito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20126, '#39'TicketLog'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20128, '#39'Softnex'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20131, '#39'Goodcard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20132, '#39'Coopercred'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20133, '#39'Vegascard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20134, '#39'Liv'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20136, '#39'Siapnet'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20137, '#39'Telenet'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20138, '#39'Sindspam'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20139, '#39'Algorix'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20140, '#39'Portalcard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20141, '#39'PersonalCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20142, '#39'LifeCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20143, '#39'TrioCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20144, '#39'ACCredito'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20145, '#39'BNBClube'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20146, '#39'Brasil Convenios'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20147, '#39'CDC Card'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20148, '#39'GraalCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20149, '#39'GrandCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20150, '#39'Itacard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20151, '#39'Sianet'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20152, '#39'Verdecard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20153, '#39'Dotz'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20154, '#39'Sysdata'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20155, '#39'BlackHawk'#39', '#39'Skytef'#39', '#39'Debito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20156, '#39'Meu Vale'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20157, '#39'Siapnet'#39', '#39'Skytef'#39', '#39'Debito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20158, '#39'Siapnet Ideal'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20159, '#39'Boa Convenios'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20160, '#39'CredFacil'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20161, '#39'Ascipam'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20162, '#39'MGCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20163, '#39'QCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20164, '#39'Coopelife'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20165, '#39'VS Card'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20166, '#39'Idealcard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20167, '#39'Familly'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20168, '#39'CredPublico'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20169, '#39'Mury'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20170, '#39'MasterPlus'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20172, '#39'ClubeCampo'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20173, '#39'NutriCheck'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20174, '#39'SoulCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20175, '#39'Card Ideal'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20176, '#39'Ultracred'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20177, '#39'Pilarcred'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20178, '#39'Samerica'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20179, '#39'Cielo QR Code'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20180, '#39'Abrapetite'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20181, '#39'Planvale'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20182, '#39'ValeMais'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20184, '#39'Romcard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20185, '#39'Eucard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20186, '#39'Sancard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20187, '#39'FaceCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20189, '#39'Cabal'#39', '#39'Skytef'#39', '#39'Debito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20190, '#39'Minascred'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20191, '#39'Greencard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20192, '#39'Valecard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20193, '#39'Maxxcard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20194, '#39'Givex'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20195, '#39'DDTotal'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20196, '#39'SCCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20197, '#39'Valeshop'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20198, '#39'Bancred'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20199, '#39'Braziliancard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20200, '#39'Workercard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20201, '#39'Banestik'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20202, '#39'Gazincred'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20203, '#39'MarketPay'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20204, '#39'Validata'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20205, '#39'Upsight'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20206, '#39'Resomaq'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20207, '#39'Orgcard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20208, '#39'Credicesta'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20209, '#39'Nutricard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20210, '#39'Foxwincard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20211, '#39'Bigcard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20212, '#39'JGV'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20213, '#39'Libercard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20214, '#39'CSF'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20215, '#39'Fleetcor'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20216, '#39'SoroVale'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20217, '#39'AtualGroup'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20218, '#39'Tecban'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20219, '#39'Getnet'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20220, '#39'EPay'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20221, '#39'Bonus Carrefour'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20222, '#39'GR Card'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20223, '#39'LiderCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20224, '#39'SinCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20225, '#39'SindPlus'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20226, '#39'TotalCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20227, '#39'UnirCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20228, '#39'Usecard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20229, '#39'CajuCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20230, '#39'Convenios Card'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20231, '#39'FranCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20232, '#39'SindCred'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20233, '#39'ViaCard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20234, '#39'Asfel'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20235, '#39'Atfpmb'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20236, '#39'Cred Vip'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20237, '#39'Assomise Card'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20238, '#39'ACSPMESP'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20239, '#39'008 Cards'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20240, '#39'DMTPlus'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20241, '#39'Global Card'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20242, '#39'Trinnus'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20243, '#39'Forte Card'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20244, '#39'AVBR'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20245, '#39'Bello Card'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20246, '#39'Aptare'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20247, '#39'Zema'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20248, '#39'Midway Mastercard'#39', '#39'Skytef'#39', '#39'Debito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20249, '#39'Midway Visa'#39', '#39'Skytef'#39', '#39'Debito Private Label'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20250, '#39'Agiplan'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20251, '#39'Volus'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20252, '#39'Fitcard'#39', '#39'Skytef'#39', '#39'Debito'#39')//'
      
        'REPLACE INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(20253, '#39'Bracov'#39', '#39'Skytef'#39', '#39'Debito'#39')//')
    Delimiter = '//'
    Left = 88
    Top = 528
  end
  object us001290: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'pos'#39
      '      AND column_name = '#39'clbcodigo'#39') THEN'
      ' '
      '--'
      '-- Alter table "pos"'
      '--'
      'ALTER TABLE pos'
      '  ADD COLUMN clbcodigo INT(11) DEFAULT 0;'
      ''
      ''
      'end if; '
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rct'#39
      '      AND column_name = '#39'rcttoken'#39') THEN'
      ''
      '--'
      '-- Alter table "rct"'
      '--'
      'ALTER TABLE rct'
      '  ADD COLUMN rcttoken VARCHAR(500) DEFAULT NULL;'
      ''
      ''
      'end if; '
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rct'#39
      '      AND column_name = '#39'rctjson'#39') THEN'
      ''
      '--'
      '-- Alter table "rct"'
      '--'
      'ALTER TABLE rct'
      '  ADD COLUMN rctjson VARCHAR(5000) DEFAULT NULL;'
      ''
      ''
      'end if; '
      ''
      ''
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      '')
    Left = 144
    Top = 528
  end
  object us001291: TUniScript
    SQL.Strings = (
      'replace INTO ffd(ffdcodigo, mdacodigo, tfdcodigo) VALUES'
      '(51, 78, 32)//')
    Left = 200
    Top = 528
  end
  object us001292: TUniScript
    SQL.Strings = (
      
        'Replace INTO bdc(bdccodigo, bdcidentificacao, trmestabelecimento' +
        'tipotef, bdcnaturza) VALUES'
      '(99, '#39'OUTROS'#39', '#39'Skytef'#39', '#39'Debito'#39')//')
    Left = 256
    Top = 528
  end
  object us001293: TUniScript
    SQL.Strings = (
      'CREATE TABLE IF NOT EXISTS rpw ('
      '  rpwchave int(11) NOT NULL AUTO_INCREMENT,'
      '  rpwtoken varchar(255) DEFAULT '#39'NULL'#39','
      '  rpwmesa varchar(10) DEFAULT '#39'NULL'#39','
      '  rpwstatus varchar(30) DEFAULT '#39'NULL'#39','
      '  orcchave int(11) DEFAULT NULL,'
      '  PRIMARY KEY (rpwchave)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET utf8mb4'
      'COLLATE utf8mb4_general_ci'
      'COMMENT = '#39'Registro de envio de recebimentos wifi'#39
      'ROW_FORMAT = DYNAMIC;')
    Left = 312
    Top = 528
  end
  object us001294: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'mes'#39
      '      AND column_name = '#39'mespedidointegracao'#39') THEN'
      ''
      'ALTER TABLE mes'
      '  ADD COLUMN mespedidointegracao VARCHAR(50) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Left = 368
    Top = 464
  end
  object us001295: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rct'#39
      '      AND column_name = '#39'rctjson'#39') THEN'
      ''
      ''
      'ALTER TABLE rct'
      '  CHANGE COLUMN rctjson rctjson VARCHAR(50000) DEFAULT NULL;'
      ''
      'end if; '
      ''
      ''
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rct'#39
      '      AND column_name = '#39'ltechave'#39') THEN'
      ''
      ''
      'ALTER TABLE rct'
      '  ADD COLUMN ltechave INT(11) DEFAULT 0;'
      ''
      ''
      'end if; '
      ''
      ''
      ''
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      '')
    Left = 400
    Top = 456
  end
  object us001296: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'lte'#39
      '      AND column_name = '#39'tdfcodigo'#39') THEN'
      ''
      ''
      '--'
      '-- Alter table "lte"'
      '--'
      'ALTER TABLE lte'
      '  ADD COLUMN tdfcodigo INT(11) DEFAULT 0;'
      ''
      ''
      ''
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      '')
    Left = 369
    Top = 528
  end
  object us001297: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmintegrapagarme'#39') THEN'
      ''
      '--'
      '-- Alter table "trm"'
      '--'
      'ALTER TABLE trm'
      '  ADD COLUMN trmintegrapagarme INT(11) DEFAULT 0 ;'
      'end if; '
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rpw'#39
      '      AND column_name = '#39'cznchave'#39') THEN'
      ''
      '--'
      '-- Alter table "rpw"'
      '--'
      'ALTER TABLE rpw'
      '  ADD COLUMN cznchave INT(11) DEFAULT 0 ;'
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Left = 424
    Top = 520
  end
  object us001298: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'rpw'#39
      '      AND column_name = '#39'rpwjson'#39') THEN'
      ''
      '--'
      '-- Alter table "rpw"'
      '--'
      'ALTER TABLE rpw'
      '  ADD COLUMN rpwjson varchar(30000) default null;'
      'end if; '
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Left = 24
    Top = 592
  end
  object us001299: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS RegistraRefeicao//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraRefeicao (IN pFlaCodigo int'
      ', IN pTipoChave int'
      ', IN pChave int'
      ', IN pClbCodigo int'
      ', IN pValor decimal(15, 3)'
      ', IN pLteChave int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      '  SET @disable_triggers = 1;'
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DROP TEMPORARY TABLE IF EXISTS trfi;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS trfi ('
      '    ID int NOT NULL AUTO_INCREMENT,'
      '    etdcodigo int NOT NULL,'
      '    mdacodigo int NOT NULL,'
      '    tfdcodigo int NOT NULL,'
      '    numparc int NOT NULL,'
      '    dtvecto date NOT NULL,'
      '    vlrparcela decimal(12, 2),'
      '    numero varchar(20),'
      '    PRIMARY KEY (ID)'
      '  ) ENGINE = INNODB DEFAULT charset = latin1;'
      ''
      ''
      '  DROP TEMPORARY TABLE IF EXISTS tdtl;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS tdtl ('
      '    ID int(11) NOT NULL AUTO_INCREMENT,'
      '    dtlchave int(11),'
      '    ltechave int(11),'
      '    cedcodigo int(1),'
      '    dtlvalor float(9, 2),'
      '    mdacodigo int(11),'
      '    PRIMARY KEY (ID)'
      ''
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @mdacodigo = (SELECT'
      '      mdacodigo'
      '    FROM dtl'
      '    WHERE dtl.ltechave = pLteChave LIMIT 1);'
      ''
      ''
      '  SET @cznchave = (SELECT'
      '      cznchave'
      '    FROM czn'
      '    ORDER BY cznchave DESC LIMIT 1);'
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SET @procodigo = (SELECT'
      '      cfgmgouprorefeicao'
      '    FROM cfgmgou'
      '      INNER JOIN cfg'
      '        ON cfgmgou.cfgcodigo = cfg.cfgcodigo'
      '    WHERE cfg.cfgcodigo = 1'
      '    LIMIT 1);'
      ''
      '  IF pTipoChave = 1 THEN'
      '    SELECT'
      '      edr.edritem,'
      '      edr.ufscodigo'
      '    FROM mes'
      '      INNER JOIN edr'
      '        ON mes.etdcodigo = edr.etdcodigo'
      '        AND mes.edritem = edr.edritem'
      '    WHERE mes.meschave = pChave LIMIT 1 INTO @edritem'
      '    , @ufscodigo;'
      '  END IF;'
      ''
      ''
      '  IF pTipoChave = 0 THEN'
      '    SELECT'
      '      edr.edritem,'
      '      edr.ufscodigo'
      '    FROM orc'
      '      INNER JOIN edr'
      '        ON orc.etdcodigo = edr.etdcodigo'
      '        AND orc.edritem = edr.edritem'
      '    WHERE orc.orcchave = pChave LIMIT 1 INTO @edritem'
      '    , @ufscodigo;'
      '  END IF;'
      ''
      '  SET @toecodigo = (SELECT (SELECT'
      '          cfgmgoutoerefeicao'
      '        FROM cfgmgou'
      '        WHERE cfgcodigo = cfg.cfgcodigo)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  IF pTipoChave = 0 THEN'
      '    INSERT INTO mes (meschave'
      '    , etdcodigo'
      '    , mesemissao'
      '    , mesregistro'
      '    , tdfcodigo'
      '    , sdecodigo'
      '    , messerie'
      '    , mesnumero'
      '    , toecodigo'
      '    , mesvalor'
      '    , mesdesconto'
      '    , mesprodutos'
      '    , messervicos'
      '    , mestotal'
      '    , tfpcodigo'
      '    , refcodigo'
      '    , trfcodigo'
      '    , mesfrete'
      '    , messeguro'
      '    , mesoutras'
      '    , mesbicm'
      '    , mesicm'
      '    , mesbicms'
      '    , mesicms'
      '    , mesipi'
      '    , mespis'
      '    , mescofins'
      '    , mespiss'
      '    , mescofinss'
      '    , clbcodigo'
      '    , trmcodigo'
      '    , mesacrescimo'
      '    , messped'
      '    , temcodigo'
      '    , edritem'
      '    , tdecodigo'
      '    , mesinclusao'
      '    , mesrefeicao'
      '    , mdacodigo'
      '    , cznchave'
      '    , oricodigo)'
      '      (SELECT'
      '        @novachave,'
      '        @etdcodigo := orc.etdcodigo,'
      '        CURRENT_DATE(),'
      '        CURRENT_DATE(),'
      '        '#39'00'#39','
      '        '#39'00'#39','
      '        @cfgserienfce,'
      '        0,'
      '        @toecodigo,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        pClbCodigo,'
      '        orc.trmcodigo,'
      '        0,'
      '        '#39'0'#39','
      '        1,'
      '        @edritem,'
      '        1,'
      '        NOW(),'
      '        1,'
      '        @mdacodigo,'
      '        @cznchave,'
      '        6'
      '      FROM orc'
      '      WHERE orc.orcchave = pChave);'
      '  END IF;'
      ''
      '  IF pTipoChave = 1 THEN'
      '    INSERT INTO mes (meschave'
      '    , etdcodigo'
      '    , mesemissao'
      '    , mesregistro'
      '    , tdfcodigo'
      '    , sdecodigo'
      '    , messerie'
      '    , mesnumero'
      '    , toecodigo'
      '    , mesvalor'
      '    , mesdesconto'
      '    , mesprodutos'
      '    , messervicos'
      '    , mestotal'
      '    , tfpcodigo'
      '    , refcodigo'
      '    , trfcodigo'
      '    , mesfrete'
      '    , messeguro'
      '    , mesoutras'
      '    , mesbicm'
      '    , mesicm'
      '    , mesbicms'
      '    , mesicms'
      '    , mesipi'
      '    , mespis'
      '    , mescofins'
      '    , mespiss'
      '    , mescofinss'
      '    , clbcodigo'
      '    , trmcodigo'
      '    , mesacrescimo'
      '    , messped'
      '    , temcodigo'
      '    , edritem'
      '    , tdecodigo'
      '    , mesinclusao'
      '    , mesrefeicao'
      '    , mdacodigo'
      '    , cznchave'
      '    , oricodigo)'
      '      (SELECT'
      '        @novachave,'
      '        @etdcodigo := mes.etdcodigo,'
      '        CURRENT_DATE(),'
      '        CURRENT_DATE(),'
      '        '#39'00'#39','
      '        '#39'00'#39','
      '        @cfgserienfce,'
      '        0,'
      '        @toecodigo,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        pValor,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        0,'
      '        pClbCodigo,'
      '        mes.trmcodigo,'
      '        0,'
      '        '#39'0'#39','
      '        1,'
      '        @edritem,'
      '        1,'
      '        NOW(),'
      '        1,'
      '        @mdacodigo,'
      '        @cznchave,'
      '        6'
      '      FROM mes'
      '      WHERE mes.meschave = pChave);'
      '  END IF;'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao oramento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    IF pTipoChave = 0 THEN'
      '      INSERT INTO mor (morchave'
      '      , orcchave'
      '      , meschave)'
      '        VALUES (@novachave, pChave, pMesChave);'
      '    END IF;'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro buscar paremetrizaes de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @cstcodigo = (SELECT'
      '        cstcodigo'
      '      FROM pro'
      '      WHERE pro.procodigo = @procodigo LIMIT 1);'
      ''
      '    SET @cfocfop = (SELECT'
      '        cfocfop'
      '      FROM pro'
      '      WHERE pro.procodigo = @procodigo);'
      ''
      ''
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @disable_triggers = 1;'
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      ''
      '    , icmcodigo'
      '    , itmaliqicm'
      '    , itmbicm'
      '    , itmicm'
      ''
      '    , csicodigo'
      '    , itmaliqipi'
      '    , itmbipi'
      '    , itmipi'
      ''
      '    , cspcodigo'
      '    , itmaliqpis'
      '    , itmbpis'
      '    , itmpis'
      ''
      '    , csfcodigo'
      '    , itmaliqcofins'
      '    , itmbcofins'
      '    , itmcofins'
      ''
      ''
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase)'
      '      (SELECT'
      '        @novachave,'
      '        pMesChave,'
      '        1,'
      '        pro.procodigo,'
      '        pro.cstcodigo,'
      '        1,'
      '        pValor,'
      '        0,'
      '        @toecodigo,'
      '        @cfocfop,'
      ''
      ''
      '        icmcodigo,'
      '        (SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      '          WHERE i.icmcodigo = pro.icmcodigo) icmaliquotas,'
      '        IF((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      
        '          WHERE i.icmcodigo = pro.icmcodigo) <> 0, pValor, 0) ba' +
        'seicm,'
      '        IF((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      '          WHERE i.icmcodigo = pro.icmcodigo) <> 0, (((SELECT'
      '            i.icmaliquotas'
      '          FROM icm i'
      
        '          WHERE i.icmcodigo = pro.icmcodigo) / 100) * pValor), 0' +
        ') valoricm,'
      ''
      '        csicodigo,'
      '        pro.proipialiquota,'
      '        IF(pro.proipialiquota <> 0, pValor, 0) baseipi,'
      
        '        IF(pro.proipialiquota <> 0, ((pro.proipialiquota / 100) ' +
        '* pValor), 0) valoripi,'
      ''
      '        cspcodigo,'
      '        pro.propisaliquota,'
      '        IF(pro.propisaliquota <> 0, pValor, 0) basepis,'
      
        '        IF(pro.propisaliquota <> 0, ((pro.propisaliquota / 100) ' +
        '* pValor), 0) valorpis,'
      ''
      ''
      '        csfcodigo,'
      '        pro.procofinsaliquota,'
      '        IF(pro.procofinsaliquota <> 0, pValor, 0) basecofins,'
      
        '        IF(pro.procofinsaliquota <> 0, ((pro.procofinsaliquota /' +
        ' 100) * pValor), 0) valorcofins,'
      ''
      ''
      '        @pcccodigo,'
      '        pValor,'
      '        pro.unicodigo,'
      '        pun.puncodigo,'
      '        pun.punmultiplicador,'
      '        @cfocfop,'
      '        (SELECT'
      '            p.unicodigobase'
      '          FROM pun p'
      '          WHERE p.puncodigo = pun.puncodigo) unicodigobase'
      '      FROM pro'
      '        INNER JOIN pun'
      '          ON pro.procodigo = pun.procodigo'
      '          AND pro.unicodigo = pun.unicodigo'
      '      WHERE pro.procodigo = @procodigo);'
      ''
      '    SET @disable_triggers = NULL;'
      ''
      ''
      ''
      '    UPDATE mes'
      '    SET mes.mesicm = (SELECT'
      '            i.itmicm'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mes.mesbicm = mestotal,'
      '        mesipi = (SELECT'
      '            i.itmipi'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mespis = (SELECT'
      '            i.itmpis'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave),'
      '        mescofins = (SELECT'
      '            i.itmcofins'
      '          FROM itm i'
      '          WHERE i.meschave = pMesChave)'
      '    WHERE meschave = pMesChave;'
      ''
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar lote da venda refeicao'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO lte (ltechave'
      '    , flacodigo'
      '    , tfdcodigo'
      '    , ltedata'
      '    , lteprincipal'
      '    , ltejuros'
      '    , ltedesconto'
      '    , ltetotal'
      '    , lteextenso'
      '    , ltehistorico'
      '    , ltemulta'
      '    , ltesituacao'
      '    , clbcodigo'
      '    , ctacodigo'
      '    , lteregistro)'
      '      (SELECT'
      '        @novachave,'
      '        flacodigo,'
      '        tfdcodigo,'
      '        ltedata,'
      '        lteprincipal,'
      '        ltejuros,'
      '        ltedesconto,'
      '        ltetotal,'
      '        lteextenso,'
      '        ltehistorico,'
      '        ltemulta,'
      '        ltesituacao,'
      '        clbcodigo,'
      '        ctacodigo,'
      '        lteregistro'
      '      FROM lte'
      '      WHERE lte.ltechave = pLteChave);'
      ''
      '    IF ROW_COUNT() > 0 THEN'
      '      SET @ltechave = (SELECT'
      '          LAST_INSERT_ID());'
      ''
      '      UPDATE terro'
      
        '      SET Mensagem = '#39'Erro ao gravar detalhes do recebimento da ' +
        'venda refeicao'#39
      '      WHERE Chamada = pChamada;'
      ''
      '      INSERT INTO dtl (dtlchave'
      '      , ltechave'
      '      , cedcodigo'
      '      , dtlvalor'
      '      , mdacodigo)'
      '        (SELECT'
      '          @novachave,'
      '          @ltechave,'
      '          cedcodigo,'
      '          dtlvalor,'
      '          mdacodigo'
      '        FROM dtl'
      '        WHERE dtl.ltechave = pLteChave);'
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        UPDATE terro'
      
        '        SET Mensagem = '#39'Erro ao gravar registro financeiro da ve' +
        'nda refeicao'#39
      '        WHERE Chamada = pChamada;'
      ''
      '        DELETE'
      '          FROM trfi;'
      ''
      '        INSERT INTO trfi (ID'
      '        , etdcodigo'
      '        , mdacodigo'
      '        , tfdcodigo'
      '        , numparc'
      '        , dtvecto'
      '        , vlrparcela'
      '        , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE' +
        '(), pValor, pMesChave);'
      ''
      
        '        CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, pChamada, ' +
        '@TitCodigo);'
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            pMesChave'
      '          FROM rfi'
      '          WHERE rfi.titcodigo = @TitCodigo);'
      '      END IF;'
      '    END IF;'
      '  END IF;'
      ''
      '  SET @disable_triggers = NULL;'
      'END //'
      ''
      '')
    Left = 88
    Top = 592
  end
  object us001300: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS FechaMesaParcial//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesaParcial (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT DISTINCT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      ''
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = @OrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      ''
      '  SET pConfirma = @Confirma;'
      ''
      ''
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      ''
      ''
      ''
      '  SET pLteChave = 0;'
      ''
      ''
      '  SET pMesChave = 0;'
      ''
      ''
      '  SET @meschave = 0;'
      ''
      ''
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      '    IF pTipo = 1 THEN'
      ''
      ''
      '      SET @qtdItem = (SELECT'
      '          COUNT(*)'
      '        FROM titem);'
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      ''
      '        SET @ContaItem = 1;'
      ''
      ''
      ''
      '        SET ErroMensagem = 1;'
      ''
      ''
      ''
      '        INSERT INTO orc (orcchave'
      '        , etdcodigo'
      '        , clbcodigo'
      '        , fopcodigo'
      '        , tdecodigo'
      '        , stocodigo'
      '        , moccodigo'
      '        , foacodigo'
      '        , trmcodigo'
      '        , tfpcodigo'
      '        , puocodigo'
      '        , orcdataabert'
      '        , orchoraabert'
      '        , orcgeralav'
      '        , orcdescontoav'
      '        , orcpercdescav'
      '        , orctotalav'
      '        , orcgeralap'
      '        , orcdescontoap'
      '        , orcpercdescap'
      '        , orctotalap'
      '        , orcobs'
      '        , orcdestimpre'
      '        , edritem'
      '        , edrcodigo'
      '        , clbvendedor'
      '        , orcmesa'
      '        , orctelefone'
      '        , ccxchave'
      '        , cznchave'
      '        , oricodigo)'
      '          SELECT'
      '            @novachave,'
      '            etdcodigo,'
      '            pClbCodigo,'
      '            fopcodigo,'
      '            tdecodigo,'
      '            3,'
      '            moccodigo,'
      '            foacodigo,'
      '            trmcodigo,'
      '            tfpcodigo,'
      '            puocodigo,'
      '            orcdataabert,'
      '            TIME(NOW()),'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            orcobs,'
      '            orcdestimpre,'
      '            edritem,'
      '            edrcodigo,'
      '            pClbCodigo,'
      '            orcmesa,'
      '            orctelefone,'
      '            ccxchave,'
      '            cznchave,'
      '            6'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '        IF (ROW_COUNT() > 0) THEN'
      ''
      '          SET @orcchave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      ''
      '          SET ErroMensagem = 2;'
      ''
      ''
      ''
      '          SET @troqtd = 0;'
      ''
      ''
      '          SET @troqtd = (SELECT DISTINCT'
      '              COUNT(orcchaveorigem)'
      '            FROM tro'
      '            WHERE orcchaveorigem = pOrcChave'
      '            AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '          IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '            SET @orcchaveinicial = IFNULL((SELECT'
      '                orcchaveorigem'
      '              FROM tro'
      '              WHERE orcchavedestino = pOrcChave'
      '              ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '            INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '              VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE ' +
        'KEY UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = ' +
        '@orcchave;'
      ''
      ''
      '          END IF;'
      ''
      ''
      ''
      ''
      ''
      '          SET @item = 0;'
      ''
      ''
      '          WHILE (@ContaItem <= @qtdItem) DO'
      ''
      '            SET @item = @item + 1;'
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 3;'
      ''
      ''
      ''
      ''
      '            SELECT'
      '              titem.itochave,'
      '              qtde'
      '            FROM titem'
      '            WHERE titem.ID = @ContaItem INTO @itochave'
      '            , @qtde;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 4;'
      ''
      ''
      ''
      ''
      '            INSERT INTO ito (itochave'
      '            , orcchave'
      '            , procodigo'
      '            , puncodigo'
      '            , unicodigo'
      '            , stocodigo'
      '            , tdecodigo'
      '            , itoquantidade'
      '            , itovalorav'
      '            , itototalav'
      '            , itodescontoav'
      '            , itosaldoav'
      '            , itovalorap'
      '            , itototalap'
      '            , itodescontoap'
      '            , itosaldoap'
      '            , itocontendo'
      '            , itoproservico'
      '            , itoprocomple'
      '            , itodataalter'
      '            , itoitem'
      '            , itogint'
      '            , itopercdescap'
      '            , itopercdescav'
      '            , itoinfadprod'
      '            , itoquanticondi'
      '            , itoquantidevolcondi'
      '            , vrpcodigo'
      '            , itoobs'
      '            , itoacrescimoav'
      '            , clbatendente'
      '            , oricodigo'
      '            , itooutras)'
      '              SELECT'
      '                @novoito,'
      '                @orcchave,'
      '                ito.procodigo,'
      '                puncodigo,'
      '                unicodigo,'
      '                3,'
      '                tdecodigo,'
      '                @qtde,'
      '                itovalorav + itoacrescimoav,'
      
        '                (@qtde * (itovalorav + itoacrescimoav + itooutra' +
        's)),'
      
        '                ROUND(((itovalorav + itoacrescimoav + itooutras)' +
        ' * @percdesc) * @qtde, 2),'
      
        '                (((itovalorav + itoacrescimoav + itooutras) * @q' +
        'tde) - (ROUND(((itovalorav + itoacrescimoav + itooutras) * @perc' +
        'desc) * @qtde, 2))),'
      '                itovalorap,'
      '                (@qtde * itovalorap),'
      '                ROUND((itototalap * @percdesc), 2),'
      '                (itototalap - itodescontoap),'
      '                itocontendo,'
      '                itoproservico,'
      '                itoprocomple,'
      '                CURRENT_DATE(),'
      '                @item,'
      '                itogint,'
      '                ROUND(@percdesc, 3),'
      '                ROUND(@percdesc, 3),'
      '                itoinfadprod,'
      '                itoquanticondi,'
      '                itoquantidevolcondi,'
      '                vrpcodigo,'
      '                itoobs,'
      '                itoacrescimoav,'
      '                clbatendente,'
      '                6,'
      '                itooutras'
      '              FROM ito'
      '              WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      '            SET @immitochave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      ''
      ''
      ''
      '            INSERT INTO imm (immchave,'
      '            itochave,'
      '            tcicodigo,'
      '            immimpresso,'
      '            immentregue,'
      '            immmodo,'
      '            ccxchave,'
      '            immhorapedido,'
      '            immhoraentrega,'
      '            immrecebido,'
      '            dorchave,'
      '            immnumepedido,'
      '            trmcodigo,'
      '            immdestino,'
      '            immidentificacao,'
      '            immgarsom,'
      '            immtemporetardo,'
      '            immmodoimpressao,'
      '            cznchave,'
      '            etdcodigoent,'
      '            immpratos,'
      '            immcopos,'
      '            immnumepedidoint,'
      '            clbcodigo,'
      '            immhoraimpresso,'
      '            immhoraimprimir,'
      '            immhoraentregadopedido,'
      '            immhoranotificadopedido,'
      '            immhorasaidadopedido)'
      '              SELECT'
      '                @novaimmchave,'
      '                @immitochave,'
      '                tcicodigo,'
      '                immimpresso,'
      '                immentregue,'
      '                immmodo,'
      '                ccxchave,'
      '                immhorapedido,'
      '                immhoraentrega,'
      '                immrecebido,'
      '                dorchave,'
      '                immnumepedido,'
      '                trmcodigo,'
      '                immdestino,'
      '                immidentificacao,'
      '                immgarsom,'
      '                immtemporetardo,'
      '                immmodoimpressao,'
      '                cznchave,'
      '                etdcodigoent,'
      '                immpratos,'
      '                immcopos,'
      '                immnumepedidoint,'
      '                clbcodigo,'
      '                immhoraimpresso,'
      '                immhoraimprimir,'
      '                immhoraentregadopedido,'
      '                immhoranotificadopedido,'
      '                immhorasaidadopedido'
      '              FROM imm'
      '              WHERE itochave = @itochave;'
      ''
      '            UPDATE imp'
      '            SET itochave = @immitochave'
      '            WHERE imp.itochave = @itochave;'
      ''
      ''
      ''
      '            SELECT'
      '              COUNT(itochave)'
      '            FROM sbi'
      '            WHERE sbi.itochave = @itochave INTO @qtdItemSbi;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItemsbi = 1;'
      ''
      ''
      ''
      '            WHILE (@ContaItemsbi <= @qtdItemSbi) DO'
      ''
      ''
      '              INSERT INTO sbi'
      '                (SELECT'
      '                  @outrachave,'
      '                  @immitochave,'
      '                  sbrcodigo,'
      '                  sbiobs,'
      '                  sbiitem,'
      '                  bprchave'
      '                FROM sbi'
      '                WHERE itochave = @itochave'
      '                AND sbi.sbiitem = @ContaItemsbi);'
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @ultimosbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      '              END IF;'
      ''
      ''
      ''
      ''
      '              SELECT'
      '                COUNT(itochave)'
      '              FROM isi'
      '              WHERE itochave = @itochave'
      '              AND isiitem = @ContaItemsbi INTO @qtdItemisi;'
      ''
      ''
      ''
      ''
      '              IF @qtdItemisi > 0 THEN'
      ''
      ''
      '                INSERT INTO isi'
      '                  (SELECT'
      '                    @novaisichave,'
      '                    @ultimosbichave,'
      '                    tsicodigo,'
      '                    procodigo,'
      '                    isitipo,'
      '                    @immitochave,'
      '                    isiitem,'
      '                    isiquantidade,'
      '                    0'
      '                  FROM isi'
      '                  WHERE itochave = @itochave'
      '                  AND isiitem = @ContaItemsbi);'
      ''
      '              END IF;'
      ''
      ''
      ''
      '              SET @ContaItemsbi = @ContaItemsbi + 1;'
      ''
      ''
      '            END WHILE;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 5;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            UPDATE ito'
      '            SET ito.itoquantidade = (ito.itoquantidade - @qtde),'
      
        '                ito.itototalav = (ito.itoquantidade * ito.itoval' +
        'orav),'
      
        '                ito.itosaldoav = (ito.itototalav - itodescontoav' +
        '),'
      
        '                ito.itototalap = (ito.itoquantidade * ito.itoval' +
        'orap),'
      '                ito.itosaldoap = (itototalap - itodescontoap)'
      '            WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItem = @ContaItem + 1;'
      ''
      ''
      '          END WHILE;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 6;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      '              orc.orcdescontoav = tito.descav,'
      
        '              orc.orcpercdescav = IF(tito.descav > 0, (tito.desc' +
        'av / tito.totav), 0),'
      '              orc.orctotalav = (tito.totav - tito.descav),'
      '              orc.orcgeralap = tito.totap,'
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = @orcchave;'
      ''
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '              orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      '        SET ErroMensagem = 8;'
      ''
      ''
      
        '        CALL RegistraMes(@orcchave, pClbCodigo, ErroMensagem, pC' +
        'onfirma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 10;'
      ''
      ''
      ''
      ''
      '        SET @troqtd = 0;'
      ''
      ''
      '        SET @troqtd = (SELECT DISTINCT'
      '            COUNT(orcchaveorigem)'
      '          FROM tro'
      '          WHERE orcchaveorigem = pOrcChave'
      '          AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '        IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '          SET @orcchaveinicial = IFNULL((SELECT'
      '              orcchaveorigem'
      '            FROM tro'
      '            WHERE orcchavedestino = pOrcChave'
      '            ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '          INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '            VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE KE' +
        'Y UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = @o' +
        'rcchave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 11;'
      ''
      ''
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, @OrcChave, @ltechave, pNome, 1);'
      '      ELSE'
      ''
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, pOrcChave, @ltechave, pNome, 0);'
      '      END IF;'
      ''
      ''
      ''
      '      IF (@qtdItem > 0)'
      '        AND (@orcchave > 0) THEN'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = @orcchave'
      '          AND dtl.mdacodigo != 7);'
      ''
      ''
      '        IF @VlrFechamento > 0 THEN'
      ''
      ''
      '          SET @etdcodigo = (SELECT'
      '              etdcodigo'
      '            FROM orc'
      '            WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      '          SET ErroMensagem = 15;'
      ''
      ''
      '          OPEN curlote;'
      '        read_loop:'
      '          LOOP'
      ''
      '            FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '            IF done THEN'
      ''
      '              LEAVE read_loop;'
      '            END IF;'
      ''
      ''
      '            SET @VlrFechamento = (SELECT'
      '                SUM(dtl.dtlvalor) dtlvalor'
      '              FROM dtl'
      '                INNER JOIN olt'
      '                  ON dtl.ltechave = olt.ltechave'
      '              WHERE olt.orcchave = @orcchave'
      '              AND dtl.ltechave = lote'
      '              AND dtl.mdacodigo = modalidade'
      '              AND dtl.mdacodigo != 7);'
      ''
      '            DELETE'
      '              FROM trfi'
      '            WHERE mdacodigo <> modalidade;'
      ''
      '            INSERT INTO trfi (ID'
      '            , etdcodigo'
      '            , mdacodigo'
      '            , tfdcodigo'
      '            , numparc'
      '            , dtvecto'
      '            , vlrparcela'
      '            , numero)'
      
        '              VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_' +
        'DATE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '            SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '            CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, ErroMe' +
        'nsagem, @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 9;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          END LOOP;'
      ''
      ''
      '          CLOSE curlote;'
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      ''
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            @MesChave'
      '          FROM olt'
      '            INNER JOIN mlt'
      '              ON olt.ltechave = mlt.ltechave'
      '            INNER JOIN mfi'
      '              ON mlt.mfichave = mfi.mfichave'
      '          WHERE olt.orcchave = @OrcChave);'
      ''
      '      END IF;'
      ''
      ''
      ''
      '    ELSE'
      ''
      ''
      '      SET ErroMensagem = 13;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      INSERT INTO olt (oltchave'
      '      , orcchave'
      '      , ltechave'
      '      , oltidentificacao'
      '      , olttipo)'
      
        '        VALUE (@novachave, @orcchave, @ltechave, pNome, pTipoFec' +
        'hamento);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET @LteDesconto = IFNULL((SELECT'
      '          SUM(lte.ltedesconto)'
      '        FROM olt'
      '          INNER JOIN lte'
      '            ON olt.ltechave = lte.ltechave'
      '        WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '      SET @OrcTotalAv = (SELECT'
      '          SUM(itovalorav * itoquantidade) totav'
      '        FROM ito'
      '        WHERE orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '      IF @LteDesconto > 0 THEN'
      ''
      ''
      '        SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '        UPDATE ito'
      '        SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '            itosaldoav = (ito.itototalav - itodescontoav),'
      '            itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '            itosaldoap = (ito.itototalav - itodescontoav),'
      '            itopercdescap = ROUND(@percdesc, 3),'
      '            itopercdescav = ROUND(@percdesc, 3)'
      '        WHERE ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '        SET @centavos = @LteDesconto - (SELECT'
      '            SUM(itodescontoav)'
      '          FROM ito'
      '          WHERE ito.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '        IF @centavos <> 0 THEN'
      ''
      '          UPDATE ito'
      '          SET itodescontoav = itodescontoav + @centavos,'
      '              itodescontoap = itodescontoap + @centavos,'
      '              itosaldoav = itosaldoav + @centavos,'
      '              itosaldoap = itosaldoap + @centavos'
      '          WHERE ito.orcchave = pOrcChave;'
      ''
      '        END IF;'
      ''
      ''
      ''
      '        UPDATE orc'
      '        INNER JOIN (SELECT'
      '            ito.orcchave,'
      '            SUM(itototalav) totav,'
      '            SUM(itodescontoav) descav,'
      '            SUM(itototalap) totap,'
      '            SUM(itodescontoap) descap'
      '          FROM ito'
      '          WHERE stocodigo != 88'
      '          GROUP BY ito.orcchave) tito'
      '          ON tito.orcchave = orc.orcchave'
      '        SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '            orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '            orc.orcdescontoav = tito.descap,'
      
        '            orc.orcpercdescav = IF(tito.descap > 0, (tito.descap' +
        ' / tito.totap), 0),'
      '            orc.orctotalap = (tito.totap - tito.descap)'
      '        WHERE orc.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '      CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pCon' +
        'firma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET ErroMensagem = 14;'
      ''
      ''
      ''
      '      SET @VlrFechamento = (SELECT'
      '          SUM(dtl.dtlvalor) dtlvalor'
      '        FROM dtl'
      '          INNER JOIN olt'
      '            ON dtl.ltechave = olt.ltechave'
      '        WHERE olt.orcchave = pOrcChave'
      '        AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '      IF @VlrFechamento > 0 THEN'
      ''
      ''
      '        SET @etdcodigo = (SELECT'
      '            etdcodigo'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        OPEN curlote;'
      '      read_loop:'
      '        LOOP'
      ''
      '          FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '          IF done THEN'
      ''
      '            LEAVE read_loop;'
      '          END IF;'
      ''
      '          SET @VlrFechamento = (SELECT'
      '              SUM(dtl.dtlvalor) dtlvalor'
      '            FROM dtl'
      '              INNER JOIN olt'
      '                ON dtl.ltechave = olt.ltechave'
      '            WHERE olt.orcchave = pOrcChave'
      '            AND dtl.ltechave = lote'
      '            AND dtl.mdacodigo = modalidade'
      '            AND dtl.mdacodigo != 7);'
      ''
      ''
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '            VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DA' +
        'TE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '          SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '          CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem,' +
        ' @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 17;'
      ''
      ''
      ''
      '          INSERT INTO rfm (rfmchave'
      '          , rfichave'
      '          , meschave)'
      ''
      '            (SELECT DISTINCT'
      '              @novachave,'
      '              rfichave,'
      '              @MesChave'
      '            FROM olt'
      '              INNER JOIN mlt'
      '                ON olt.ltechave = mlt.ltechave'
      '              INNER JOIN mfi'
      '                ON mlt.mfichave = mfi.mfichave'
      '            WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '        END LOOP;'
      ''
      ''
      '        CLOSE curlote;'
      ''
      '      END IF;'
      ''
      ''
      '      INSERT INTO rfm (rfmchave'
      '      , rfichave'
      '      , meschave)'
      ''
      '        (SELECT DISTINCT'
      '          @novachave,'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '      SET ErroMensagem = 18;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      '          orc.orcpercdescav = @percdesc,'
      '          orc.orctotalap = (tito.totap - tito.descap),'
      '          orc.orcdataencerr = CURRENT_DATE(),'
      '          orc.orchoraencerr = CURRENT_TIME(),'
      '          orc.stocodigo = 3'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.stocodigo = 3'
      '      WHERE ito.orcchave = pOrcChave'
      '      AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '    END IF;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pRefeicao > 0 THEN'
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      
        '    SET @valor := (pLtePrincipal + pLteJuros + pLteMulta + pTaxa' +
        ') - pLteDesconto;'
      ''
      ''
      ''
      
        '    CALL RegistraRefeicao(pFlaCodigo, 0, pOrcChave, pClbCodigo, ' +
        '@valor, pLteChave, ErroMensagem, @Confirma, @meschave);'
      ''
      '  END IF;'
      ''
      ''
      '  IF @meschave > 0 THEN'
      ''
      '    SET pMesChave = @meschave;'
      ''
      ''
      '  ELSE'
      ''
      '    SET pMesChave = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      ''
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      ''
      ''
      ''
      'END //')
    Delimiter = '//'
    Left = 144
    Top = 592
  end
  object us001301: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalservicos = IFNULL(@totalservicos, 0);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav - @totalservicos,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      6,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmoutras'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmacrescimoav)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        0,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        ito.itovalorav + itoacrescimoav itoacrescimoav,'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        oricodigo,'
      '        IF((SELECT'
      '            tpocodigo'
      '          FROM pro p'
      
        '          WHERE p.procodigo = ito.procodigo) = 0, 0, (@totalserv' +
        'icos) * ((itototalav - itooutras) / (@totalgeral)))'
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END //')
    Delimiter = '//'
    Left = 192
    Top = 592
  end
  object us001302: TUniScript
    SQL.Strings = (
      'DROP VIEW v_cli CASCADE//'
      ''
      'CREATE'
      'DEFINER = '#39'root'#39'@'#39'%'#39
      'VIEW v_cli'
      'AS'
      'SELECT DISTINCT'
      '  `etd`.`etdcodigo` AS `etdcodigo`,'
      '  `etd`.`etdidentificacao` AS `etdidentificacao`,'
      '  `etd`.`etddoc1` AS `etddoc1`,'
      '  `etf`.`etftelefone` AS `etftelefone`,'
      '  `etf`.`etfsenha` AS `etfsenha`,'
      '  `ete`.`eteemail` AS `eteemail`'
      'FROM (((`etd`'
      '  JOIN `etf`'
      '    ON (`etd`.`etdcodigo` = `etf`.`etdcodigo`))'
      '  JOIN `etv`'
      '    ON (`etd`.`etdcodigo` = `etv`.`etdcodigo`))'
      '  LEFT JOIN `ete`'
      '    ON (`etd`.`etdcodigo` = `ete`.`etdcodigo`))'
      'WHERE `etv`.`tvicodigo` = 1//')
    Delimiter = '//'
    Left = 240
    Top = 592
  end
  object us001303: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS RegistraMes//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraMes (IN pOrcChava int'
      ', IN pClbCodigo int'
      ', IN pChamada int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int)'
      'BEGIN'
      ''
      '  /* daniel 02/01/2025 08:50  */'
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao gravar venda'#39');'
      ''
      '  SET @totalservicos = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND pro.tpocodigo = 9'
      '    AND ito.stocodigo <> 88);'
      ''
      '  SET @totalservicos = IFNULL(@totalservicos, 0);'
      ''
      '  SET @totalgeral = (SELECT'
      ''
      '      SUM(ito.itoquantidade * ito.itovalorav) outras'
      '    FROM ito,'
      '         pro'
      '    WHERE ito.orcchave = pOrcChava'
      '    AND pro.tpocodigo = 0'
      '    AND ito.itoquantidade > 0'
      '    AND ito.procodigo = pro.procodigo'
      '    AND ito.stocodigo <> 88);'
      ''
      ''
      ''
      ''
      '  SET @cfgserienfce = (SELECT'
      '      cfgserienfce'
      '    FROM cfgmnfe LIMIT 1);'
      ''
      '  SELECT'
      '    edr.edritem,'
      '    edr.ufscodigo'
      '  FROM orc'
      '    INNER JOIN edr'
      '      ON orc.etdcodigo = edr.etdcodigo'
      '      AND orc.edritem = edr.edritem'
      '  WHERE orc.orcchave = pOrcChava LIMIT 1 INTO @edritem'
      '  , @ufscodigo;'
      ''
      '  SET @toecodigo = (SELECT'
      
        '      IF(edr.ufscodigo = @ufscodigo, cfgmsai.cfgtoemesinte, cfgm' +
        'sai.cfgtoemesfora)'
      '    FROM cfg'
      '      INNER JOIN cfgmcfg'
      '        ON cfg.cfgcodigo = cfgmcfg.cfgcodigo'
      '      INNER JOIN cfgmsai'
      '        ON cfg.cfgcodigo = cfgmsai.cfgcodigo'
      '      INNER JOIN edr'
      '        ON cfgmcfg.cfgetdempresa = edr.etdcodigo'
      '        AND edr.tedcodigo = 1'
      '    LIMIT 1);'
      ''
      '  INSERT INTO mes (meschave'
      '  , etdcodigo'
      '  , mesemissao'
      '  , mesregistro'
      '  , tdfcodigo'
      '  , sdecodigo'
      '  , messerie'
      '  , mesnumero'
      '  , toecodigo'
      '  , mesvalor'
      '  , mesdesconto'
      '  , mesprodutos'
      '  , messervicos'
      '  , mestotal'
      '  , tfpcodigo'
      '  , refcodigo'
      '  , trfcodigo'
      '  , mesfrete'
      '  , messeguro'
      '  , mesoutras'
      '  , mesbicm'
      '  , mesicm'
      '  , mesbicms'
      '  , mesicms'
      '  , mesipi'
      '  , mespis'
      '  , mescofins'
      '  , mespiss'
      '  , mescofinss'
      '  , clbcodigo'
      '  , trmcodigo'
      '  , mesacrescimo'
      '  , messped'
      '  , temcodigo'
      '  , edritem'
      '  , tdecodigo'
      '  , mesinclusao'
      '  , flacodigo'
      '  , mestelefone'
      '  , ccxchave'
      '  , oricodigo'
      '  , cznchave)'
      '    (SELECT'
      '      @novachave,'
      '      orc.etdcodigo,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      (SELECT'
      '          DATE(cznabertura) dia'
      '        FROM czn'
      '        WHERE cznfechamento IS NULL'
      '        ORDER BY cznchave DESC LIMIT 1) orcdataabert,'
      '      '#39'00'#39','
      '      '#39'00'#39','
      '      @cfgserienfce,'
      '      0,'
      '      @toecodigo,'
      '      orc.orcgeralav - @totalservicos,'
      '      orc.orcdescontoav,'
      '      orc.orctotalav,'
      '      0,'
      '      orc.orctotalav,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      @totalservicos,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      0,'
      '      pClbCodigo,'
      '      orc.trmcodigo,'
      '      0,'
      '      '#39'0'#39','
      '      1,'
      '      @edritem,'
      '      1,'
      '      NOW(),'
      '      orc.flacodigo,'
      '      orc.orctelefone,'
      '      orc.ccxchave,'
      '      6,'
      '      cznchave'
      '    FROM orc'
      '    WHERE orc.orcchave = pOrcChava);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      ''
      '    SET pMesChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao vincular venda ao amento'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    INSERT INTO mor (morchave'
      '    , orcchave'
      '    , meschave)'
      '      VALUES (@mornovachave, pOrcChava, pMesChave);'
      ''
      '    UPDATE terro'
      
        '    SET Mensagem = '#39'Erro buscar paremetriz'#195#402#198#8217#195#162#226#8218#172#197#161#195#402#226#8364#353#195#8218#194#181'es' +
        ' de venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = 0;'
      '    SET @cstcodigo = (SELECT'
      '        cfgcsosn'
      '      FROM cfgmnfe LIMIT 1);'
      '    SET @cfocfop = (SELECT'
      '        toecfopsaida'
      '      FROM toe'
      '      WHERE toecodigo = @toecodigo);'
      '    SET @pcccodigo = (SELECT'
      '        cfgpccvenda'
      '      FROM cfgmspd LIMIT 1);'
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao gravar itens da venda'#39
      '    WHERE Chamada = pChamada;'
      ''
      '    SET @item = (@item + 1);'
      ''
      ''
      '    INSERT INTO itm (itmchave'
      '    , meschave'
      '    , itmoutras'
      '    , itmitem'
      '    , procodigo'
      '    , cstcodigo'
      '    , itmquantidade'
      '    , itmvalor'
      '    , itmdesconto'
      '    , toecodigo'
      '    , cfocfop'
      '    , icmcodigo'
      '    , csicodigo'
      '    , cspcodigo'
      '    , csfcodigo'
      '    , pcccodigo'
      '    , itmtotal'
      '    , unicodigo'
      '    , puncodigo'
      '    , itmcontendo'
      '    , cfocfopdestinacao'
      '    , unicodigobase'
      '    , flacodigo'
      '    , itochave'
      '    , clbatendente'
      '    , oricodigo'
      '    , itmacrescimoav)'
      '      (SELECT'
      '        @itmnovachave,'
      '        pMesChave,'
      '        0,'
      '        itoitem,'
      '        ito.procodigo,'
      '        @cstcodigo,'
      '        ito.itoquantidade,'
      '        ito.itovalorav + itoacrescimoav itoacrescimoav,'
      '        ito.itodescontoav,'
      '        @toecodigo,'
      '        @cfocfop,'
      '        '#39'00'#39','
      '        '#39'99'#39','
      '        '#39'49'#39','
      '        '#39'49'#39','
      '        @pcccodigo,'
      '        ito.itototalav,'
      '        ito.unicodigo,'
      '        ito.puncodigo,'
      '        ito.itocontendo,'
      '        @cfocfop,'
      '        (SELECT'
      '            pun.unicodigobase'
      '          FROM pun'
      '          WHERE pun.puncodigo = ito.puncodigo LIMIT 1),'
      '        ito.flacodigo,'
      '        itochave,'
      '        clbatendente,'
      '        6,'
      '        IF((SELECT'
      '            tpocodigo'
      '          FROM pro p'
      
        '          WHERE p.procodigo = ito.procodigo) = 0, 0, (@totalserv' +
        'icos) * ((itototalav - itooutras) / (@totalgeral)))'
      ''
      '      FROM ito,'
      '           pro'
      '      WHERE ito.orcchave = pOrcChava'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo IN (0)'
      '      AND ito.itoquantidade > 0'
      '      AND ito.stocodigo <> 88'
      '      AND ((ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimento'
      '        FROM cfgmgou))'
      '      AND (ito.procodigo NOT IN (SELECT'
      '          cfgmgouproatendimentoparcial'
      '        FROM cfgmgou))));'
      ''
      ''
      '    IF (SELECT'
      '          ROW_COUNT()) > 0 THEN'
      '      SET @itmchavesbv = (SELECT'
      '          LAST_INSERT_ID());'
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET @qtd = (SELECT'
      '        COUNT(itochave)'
      '      FROM ito'
      '      WHERE ito.orcchave = pOrcChava);'
      ''
      ''
      ''
      ''
      '    SET @posicao = 1;'
      ''
      ''
      ''
      '    WHILE (@posicao <= @qtd) DO'
      ''
      ''
      '      SET @sbiitochavindv = (SELECT'
      '          itochave'
      '        FROM ito'
      '        WHERE ito.orcchave = pOrcChava'
      '        AND ito.itoitem = @posicao'
      '        AND itoquantidade > 0'
      '        AND stocodigo <> 88'
      '        AND ((ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimento'
      '          FROM cfgmgou))'
      '        AND (ito.procodigo NOT IN (SELECT'
      '            cfgmgouproatendimentoparcial'
      '          FROM cfgmgou))));'
      ''
      '      IF @sbiitochavindv <> '#39#39' THEN'
      ''
      ''
      ''
      ''
      '        SET @qtdsbi = (SELECT'
      '            COUNT(sbi.sbichave)'
      '          FROM sbi,'
      '               ito'
      '          WHERE sbi.itochave = ito.itochave'
      '          AND ito.orcchave = pOrcChava'
      '          AND ito.itochave = @sbiitochavindv'
      '          AND ito.itoquantidade > 0'
      '          AND ito.stocodigo <> 88'
      '          AND ((ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimento'
      '            FROM cfgmgou))'
      '          AND (ito.procodigo NOT IN (SELECT'
      '              cfgmgouproatendimentoparcial'
      '            FROM cfgmgou))));'
      ''
      '        SET @posicaosbi = 0;'
      ''
      '        WHILE (@posicaosbi <= @qtdsbi) DO'
      ''
      '          SET @posicaosbi = @posicaosbi + 1;'
      ''
      ''
      ''
      ''
      '          SET @sbiitochave = (SELECT'
      '              sbi.itochave'
      '            FROM sbi,'
      '                 ito'
      '            WHERE sbi.itochave = ito.itochave'
      '            AND ito.orcchave = pOrcChava'
      '            AND sbi.sbiitem = @posicaosbi'
      '            AND sbi.itochave = @sbiitochavindv'
      '            AND ito.itoquantidade > 0'
      '            AND ito.stocodigo <> 88'
      '            AND ((ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimento'
      '              FROM cfgmgou))'
      '            AND (ito.procodigo NOT IN (SELECT'
      '                cfgmgouproatendimentoparcial'
      '              FROM cfgmgou))) LIMIT 1);'
      ''
      ''
      ''
      '          IF (@sbiitochave IS NOT NULL) THEN'
      ''
      '            INSERT INTO sbv (sbvchave,'
      '            itmchave,'
      '            itochave,'
      '            sbrcodigo,'
      '            sbvobs,'
      '            sbvitem,'
      '            bprchave)'
      '              SELECT'
      '                @sbvchave,'
      '                (SELECT'
      '                    itmchave'
      '                  FROM itm'
      '                  WHERE itochave = ito.itochave'
      '                  AND ito.stocodigo <> 88'
      '                  AND ((ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimento'
      '                    FROM cfgmgou))'
      '                  AND (ito.procodigo NOT IN (SELECT'
      '                      cfgmgouproatendimentoparcial'
      '                    FROM cfgmgou))) LIMIT 1),'
      '                ito.itochave,'
      '                sbrcodigo,'
      '                sbiobs,'
      '                sbiitem,'
      '                bprchave'
      '              FROM ito,'
      '                   sbi'
      '              WHERE ito.itochave = sbi.itochave'
      '              AND ito.orcchave = pOrcChava'
      '              AND ito.stocodigo <> 88'
      '              AND ((ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimento'
      '                FROM cfgmgou))'
      '              AND (ito.procodigo NOT IN (SELECT'
      '                  cfgmgouproatendimentoparcial'
      '                FROM cfgmgou)))'
      '              AND sbi.sbiitem = @posicaosbi'
      '              AND sbi.itochave = @sbiitochavindv'
      '              AND ito.itoquantidade > 0;'
      ''
      ''
      '            IF (SELECT'
      '                  ROW_COUNT()) > 0 THEN'
      '              SET @chavesbv = (SELECT'
      '                  LAST_INSERT_ID());'
      '            END IF;'
      ''
      ''
      '            SELECT'
      '              COUNT(isichave)'
      '            FROM isi'
      '            WHERE isi.isiitem = @posicaosbi'
      '            AND isi.itochave = @sbiitochavindv INTO @qtdisv;'
      ''
      ''
      ''
      '            IF @qtdisv > 0 THEN'
      ''
      '              INSERT INTO isv (sbvchave,'
      '              tsicodigo,'
      '              procodigo,'
      '              isvtipo,'
      '              itochave,'
      '              itmchave,'
      '              isvitem,'
      '              isvquantidade)'
      '                SELECT'
      '                  @chavesbv,'
      '                  tsicodigo,'
      '                  isi.procodigo,'
      '                  isitipo,'
      '                  isi.itochave,'
      '                  (SELECT'
      '                      itmchave'
      '                    FROM itm'
      '                    WHERE itm.itochave = isi.itochave LIMIT 1),'
      '                  isiitem,'
      '                  isiquantidade'
      '                FROM isi,'
      '                     ito'
      '                WHERE isi.isiitem = @posicaosbi'
      '                AND isi.itochave = @sbiitochavindv'
      '                AND ito.itochave = isi.itochave'
      '                AND ito.itoquantidade > 0'
      '                AND ito.stocodigo <> 88'
      '                AND ((ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimento'
      '                  FROM cfgmgou))'
      '                AND (ito.procodigo NOT IN (SELECT'
      '                    cfgmgouproatendimentoparcial'
      '                  FROM cfgmgou)));'
      ''
      '            END IF;'
      '          END IF;'
      '        END WHILE;'
      '      END IF;'
      ''
      ''
      '      SET @posicao = @posicao + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      ''
      'END //'
      ''
      ''
      ''
      '')
    Delimiter = '//'
    Left = 296
    Top = 592
  end
  object us001304: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS FechaMesaParcial//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesaParcial (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      '  /* daniel 02/01/202508:50 */'
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT DISTINCT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      ''
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = @OrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      ''
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      '  ELSE'
      '    SET @percdesc = 0;'
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      '    SET pLteChave = @ltechave;'
      ''
      '    IF pTipo = 1 THEN'
      ''
      '      SET @qtdItem = (SELECT'
      '          COUNT(*)'
      '        FROM titem);'
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      ''
      '        SET @ContaItem = 1;'
      ''
      '        SET ErroMensagem = 1;'
      ''
      '        INSERT INTO orc (orcchave'
      '        , etdcodigo'
      '        , clbcodigo'
      '        , fopcodigo'
      '        , tdecodigo'
      '        , stocodigo'
      '        , moccodigo'
      '        , foacodigo'
      '        , trmcodigo'
      '        , tfpcodigo'
      '        , puocodigo'
      '        , orcdataabert'
      '        , orchoraabert'
      '        , orcgeralav'
      '        , orcdescontoav'
      '        , orcpercdescav'
      '        , orctotalav'
      '        , orcgeralap'
      '        , orcdescontoap'
      '        , orcpercdescap'
      '        , orctotalap'
      '        , orcobs'
      '        , orcdestimpre'
      '        , edritem'
      '        , edrcodigo'
      '        , clbvendedor'
      '        , orcmesa'
      '        , orctelefone'
      '        , ccxchave'
      '        , cznchave'
      '        , oricodigo)'
      '          SELECT'
      '            @novachave,'
      '            etdcodigo,'
      '            pClbCodigo,'
      '            fopcodigo,'
      '            tdecodigo,'
      '            3,'
      '            moccodigo,'
      '            foacodigo,'
      '            trmcodigo,'
      '            tfpcodigo,'
      '            puocodigo,'
      '            orcdataabert,'
      '            TIME(NOW()),'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            orcobs,'
      '            orcdestimpre,'
      '            edritem,'
      '            edrcodigo,'
      '            pClbCodigo,'
      '            orcmesa,'
      '            orctelefone,'
      '            ccxchave,'
      '            cznchave,'
      '            6'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '        IF (ROW_COUNT() > 0) THEN'
      ''
      '          SET @orcchave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      ''
      '          SET ErroMensagem = 2;'
      ''
      ''
      ''
      '          SET @troqtd = 0;'
      ''
      ''
      '          SET @troqtd = (SELECT DISTINCT'
      '              COUNT(orcchaveorigem)'
      '            FROM tro'
      '            WHERE orcchaveorigem = pOrcChave'
      '            AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '          IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '            SET @orcchaveinicial = IFNULL((SELECT'
      '                orcchaveorigem'
      '              FROM tro'
      '              WHERE orcchavedestino = pOrcChave'
      '              ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '            INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '              VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE ' +
        'KEY UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = ' +
        '@orcchave;'
      ''
      ''
      '          END IF;'
      ''
      ''
      ''
      ''
      ''
      '          SET @item = 0;'
      ''
      ''
      '          WHILE (@ContaItem <= @qtdItem) DO'
      ''
      '            SET @item = @item + 1;'
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 3;'
      ''
      ''
      ''
      ''
      '            SELECT'
      '              titem.itochave,'
      '              qtde'
      '            FROM titem'
      '            WHERE titem.ID = @ContaItem INTO @itochave'
      '            , @qtde;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 4;'
      ''
      ''
      ''
      ''
      '            INSERT INTO ito (itochave'
      '            , orcchave'
      '            , procodigo'
      '            , puncodigo'
      '            , unicodigo'
      '            , stocodigo'
      '            , tdecodigo'
      '            , itoquantidade'
      '            , itovalorav'
      '            , itototalav'
      '            , itodescontoav'
      '            , itosaldoav'
      '            , itovalorap'
      '            , itototalap'
      '            , itodescontoap'
      '            , itosaldoap'
      '            , itocontendo'
      '            , itoproservico'
      '            , itoprocomple'
      '            , itodataalter'
      '            , itoitem'
      '            , itogint'
      '            , itopercdescap'
      '            , itopercdescav'
      '            , itoinfadprod'
      '            , itoquanticondi'
      '            , itoquantidevolcondi'
      '            , vrpcodigo'
      '            , itoobs'
      '            , itoacrescimoav'
      '            , clbatendente'
      '            , oricodigo'
      '            , itooutras)'
      '              SELECT'
      '                @novoito,'
      '                @orcchave,'
      '                ito.procodigo,'
      '                puncodigo,'
      '                unicodigo,'
      '                3,'
      '                tdecodigo,'
      '                @qtde,'
      '                itovalorav + itoacrescimoav,'
      
        '                (@qtde * (itovalorav + itoacrescimoav + itooutra' +
        's)),'
      
        '                ROUND(((itovalorav + itoacrescimoav + itooutras)' +
        ' * @percdesc) * @qtde, 2),'
      
        '                (((itovalorav + itoacrescimoav + itooutras) * @q' +
        'tde) - (ROUND(((itovalorav + itoacrescimoav + itooutras) * @perc' +
        'desc) * @qtde, 2))),'
      '                itovalorap,'
      '                (@qtde * itovalorap),'
      '                ROUND((itototalap * @percdesc), 2),'
      '                (itototalap - itodescontoap),'
      '                itocontendo,'
      '                itoproservico,'
      '                itoprocomple,'
      '                CURRENT_DATE(),'
      '                @item,'
      '                itogint,'
      '                ROUND(@percdesc, 3),'
      '                ROUND(@percdesc, 3),'
      '                itoinfadprod,'
      '                itoquanticondi,'
      '                itoquantidevolcondi,'
      '                vrpcodigo,'
      '                itoobs,'
      '                itoacrescimoav,'
      '                clbatendente,'
      '                6,'
      '                itooutras'
      '              FROM ito'
      '              WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      '            SET @immitochave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      ''
      ''
      ''
      '            INSERT INTO imm (immchave,'
      '            itochave,'
      '            tcicodigo,'
      '            immimpresso,'
      '            immentregue,'
      '            immmodo,'
      '            ccxchave,'
      '            immhorapedido,'
      '            immhoraentrega,'
      '            immrecebido,'
      '            dorchave,'
      '            immnumepedido,'
      '            trmcodigo,'
      '            immdestino,'
      '            immidentificacao,'
      '            immgarsom,'
      '            immtemporetardo,'
      '            immmodoimpressao,'
      '            cznchave,'
      '            etdcodigoent,'
      '            immpratos,'
      '            immcopos,'
      '            immnumepedidoint,'
      '            clbcodigo,'
      '            immhoraimpresso,'
      '            immhoraimprimir,'
      '            immhoraentregadopedido,'
      '            immhoranotificadopedido,'
      '            immhorasaidadopedido)'
      '              SELECT'
      '                @novaimmchave,'
      '                @immitochave,'
      '                tcicodigo,'
      '                immimpresso,'
      '                immentregue,'
      '                immmodo,'
      '                ccxchave,'
      '                immhorapedido,'
      '                immhoraentrega,'
      '                immrecebido,'
      '                dorchave,'
      '                immnumepedido,'
      '                trmcodigo,'
      '                immdestino,'
      '                immidentificacao,'
      '                immgarsom,'
      '                immtemporetardo,'
      '                immmodoimpressao,'
      '                cznchave,'
      '                etdcodigoent,'
      '                immpratos,'
      '                immcopos,'
      '                immnumepedidoint,'
      '                clbcodigo,'
      '                immhoraimpresso,'
      '                immhoraimprimir,'
      '                immhoraentregadopedido,'
      '                immhoranotificadopedido,'
      '                immhorasaidadopedido'
      '              FROM imm'
      '              WHERE itochave = @itochave;'
      ''
      '            UPDATE imp'
      '            SET itochave = @immitochave'
      '            WHERE imp.itochave = @itochave;'
      ''
      ''
      ''
      '            SELECT'
      '              COUNT(itochave)'
      '            FROM sbi'
      '            WHERE sbi.itochave = @itochave INTO @qtdItemSbi;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItemsbi = 1;'
      ''
      ''
      ''
      '            WHILE (@ContaItemsbi <= @qtdItemSbi) DO'
      ''
      ''
      '              INSERT INTO sbi'
      '                (SELECT'
      '                  @outrachave,'
      '                  @immitochave,'
      '                  sbrcodigo,'
      '                  sbiobs,'
      '                  sbiitem,'
      '                  bprchave'
      '                FROM sbi'
      '                WHERE itochave = @itochave'
      '                AND sbi.sbiitem = @ContaItemsbi);'
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @ultimosbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      '              END IF;'
      ''
      ''
      ''
      ''
      '              SELECT'
      '                COUNT(itochave)'
      '              FROM isi'
      '              WHERE itochave = @itochave'
      '              AND isiitem = @ContaItemsbi INTO @qtdItemisi;'
      ''
      ''
      ''
      ''
      '              IF @qtdItemisi > 0 THEN'
      ''
      ''
      '                INSERT INTO isi'
      '                  (SELECT'
      '                    @novaisichave,'
      '                    @ultimosbichave,'
      '                    tsicodigo,'
      '                    procodigo,'
      '                    isitipo,'
      '                    @immitochave,'
      '                    isiitem,'
      '                    isiquantidade,'
      '                    0'
      '                  FROM isi'
      '                  WHERE itochave = @itochave'
      '                  AND isiitem = @ContaItemsbi);'
      ''
      '              END IF;'
      ''
      ''
      ''
      '              SET @ContaItemsbi = @ContaItemsbi + 1;'
      ''
      ''
      '            END WHILE;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 5;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            UPDATE ito'
      '            SET ito.itoquantidade = (ito.itoquantidade - @qtde),'
      
        '                ito.itototalav = (ito.itoquantidade * ito.itoval' +
        'orav),'
      
        '                ito.itosaldoav = (ito.itototalav - itodescontoav' +
        '),'
      
        '                ito.itototalap = (ito.itoquantidade * ito.itoval' +
        'orap),'
      '                ito.itosaldoap = (itototalap - itodescontoap)'
      '            WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItem = @ContaItem + 1;'
      ''
      ''
      '          END WHILE;'
      ''
      '          SET ErroMensagem = 6;'
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      '              orc.orcdescontoav = tito.descav,'
      
        '              orc.orcpercdescav = IF(tito.descav > 0, (tito.desc' +
        'av / tito.totav), 0),'
      '              orc.orctotalav = (tito.totav - tito.descav),'
      '              orc.orcgeralap = tito.totap,'
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = @orcchave;'
      ''
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '              orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      '        SET ErroMensagem = 8;'
      ''
      ''
      
        '        CALL RegistraMes(@orcchave, pClbCodigo, ErroMensagem, pC' +
        'onfirma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 10;'
      ''
      ''
      ''
      ''
      '        SET @troqtd = 0;'
      ''
      ''
      '        SET @troqtd = (SELECT DISTINCT'
      '            COUNT(orcchaveorigem)'
      '          FROM tro'
      '          WHERE orcchaveorigem = pOrcChave'
      '          AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '        IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '          SET @orcchaveinicial = IFNULL((SELECT'
      '              orcchaveorigem'
      '            FROM tro'
      '            WHERE orcchavedestino = pOrcChave'
      '            ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '          INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '            VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE KE' +
        'Y UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = @o' +
        'rcchave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 11;'
      ''
      ''
      ''
      ''
      ''
      '      IF (@qtdItem > 0) THEN'
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, @OrcChave, @ltechave, pNome, 1);'
      '      ELSE'
      ''
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, pOrcChave, @ltechave, pNome, 0);'
      '      END IF;'
      ''
      ''
      ''
      '      IF (@qtdItem > 0)'
      '        AND (@orcchave > 0) THEN'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = @orcchave'
      '          AND dtl.mdacodigo != 7);'
      ''
      ''
      '        IF @VlrFechamento > 0 THEN'
      ''
      ''
      '          SET @etdcodigo = (SELECT'
      '              etdcodigo'
      '            FROM orc'
      '            WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      '          SET ErroMensagem = 15;'
      ''
      ''
      '          OPEN curlote;'
      '        read_loop:'
      '          LOOP'
      ''
      '            FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '            IF done THEN'
      ''
      '              LEAVE read_loop;'
      '            END IF;'
      ''
      ''
      '            SET @VlrFechamento = (SELECT'
      '                SUM(dtl.dtlvalor) dtlvalor'
      '              FROM dtl'
      '                INNER JOIN olt'
      '                  ON dtl.ltechave = olt.ltechave'
      '              WHERE olt.orcchave = @orcchave'
      '              AND dtl.ltechave = lote'
      '              AND dtl.mdacodigo = modalidade'
      '              AND dtl.mdacodigo != 7);'
      ''
      '            DELETE'
      '              FROM trfi'
      '            WHERE mdacodigo <> modalidade;'
      ''
      '            INSERT INTO trfi (ID'
      '            , etdcodigo'
      '            , mdacodigo'
      '            , tfdcodigo'
      '            , numparc'
      '            , dtvecto'
      '            , vlrparcela'
      '            , numero)'
      
        '              VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_' +
        'DATE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '            SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '            CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, ErroMe' +
        'nsagem, @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 9;'
      ''
      ''
      ''
      ''
      ''
      ''
      '          END LOOP;'
      ''
      ''
      '          CLOSE curlote;'
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      ''
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            @MesChave'
      '          FROM olt'
      '            INNER JOIN mlt'
      '              ON olt.ltechave = mlt.ltechave'
      '            INNER JOIN mfi'
      '              ON mlt.mfichave = mfi.mfichave'
      '          WHERE olt.orcchave = @OrcChave);'
      ''
      '      END IF;'
      ''
      ''
      ''
      '    ELSE'
      ''
      ''
      '      SET ErroMensagem = 13;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      INSERT INTO olt (oltchave'
      '      , orcchave'
      '      , ltechave'
      '      , oltidentificacao'
      '      , olttipo)'
      
        '        VALUE (@novachave, @orcchave, @ltechave, pNome, pTipoFec' +
        'hamento);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET @LteDesconto = IFNULL((SELECT'
      '          SUM(lte.ltedesconto)'
      '        FROM olt'
      '          INNER JOIN lte'
      '            ON olt.ltechave = lte.ltechave'
      '        WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '      SET @OrcTotalAv = (SELECT'
      '          SUM(itovalorav * itoquantidade) totav'
      '        FROM ito'
      '        WHERE orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '      IF @LteDesconto > 0 THEN'
      ''
      ''
      '        SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '        UPDATE ito'
      '        SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '            itosaldoav = (ito.itototalav - itodescontoav),'
      '            itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '            itosaldoap = (ito.itototalav - itodescontoav),'
      '            itopercdescap = ROUND(@percdesc, 3),'
      '            itopercdescav = ROUND(@percdesc, 3)'
      '        WHERE ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '        SET @centavos = @LteDesconto - (SELECT'
      '            SUM(itodescontoav)'
      '          FROM ito'
      '          WHERE ito.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '        IF @centavos <> 0 THEN'
      ''
      '          UPDATE ito'
      '          SET itodescontoav = itodescontoav + @centavos,'
      '              itodescontoap = itodescontoap + @centavos,'
      '              itosaldoav = itosaldoav + @centavos,'
      '              itosaldoap = itosaldoap + @centavos'
      '          WHERE ito.orcchave = pOrcChave;'
      ''
      '        END IF;'
      ''
      ''
      ''
      '        UPDATE orc'
      '        INNER JOIN (SELECT'
      '            ito.orcchave,'
      '            SUM(itototalav) totav,'
      '            SUM(itodescontoav) descav,'
      '            SUM(itototalap) totap,'
      '            SUM(itodescontoap) descap'
      '          FROM ito'
      '          WHERE stocodigo != 88'
      '          GROUP BY ito.orcchave) tito'
      '          ON tito.orcchave = orc.orcchave'
      '        SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '            orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '            orc.orcdescontoav = tito.descap,'
      
        '            orc.orcpercdescav = IF(tito.descap > 0, (tito.descap' +
        ' / tito.totap), 0),'
      '            orc.orctotalap = (tito.totap - tito.descap)'
      '        WHERE orc.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '      CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pCon' +
        'firma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '      SET ErroMensagem = 14;'
      ''
      ''
      ''
      '      SET @VlrFechamento = (SELECT'
      '          SUM(dtl.dtlvalor) dtlvalor'
      '        FROM dtl'
      '          INNER JOIN olt'
      '            ON dtl.ltechave = olt.ltechave'
      '        WHERE olt.orcchave = pOrcChave'
      '        AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '      IF @VlrFechamento > 0 THEN'
      ''
      ''
      '        SET @etdcodigo = (SELECT'
      '            etdcodigo'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '        OPEN curlote;'
      '      read_loop:'
      '        LOOP'
      ''
      '          FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '          IF done THEN'
      ''
      '            LEAVE read_loop;'
      '          END IF;'
      ''
      '          SET @VlrFechamento = (SELECT'
      '              SUM(dtl.dtlvalor) dtlvalor'
      '            FROM dtl'
      '              INNER JOIN olt'
      '                ON dtl.ltechave = olt.ltechave'
      '            WHERE olt.orcchave = pOrcChave'
      '            AND dtl.ltechave = lote'
      '            AND dtl.mdacodigo = modalidade'
      '            AND dtl.mdacodigo != 7);'
      ''
      ''
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '            VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DA' +
        'TE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '          SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '          CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem,' +
        ' @TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '          SET ErroMensagem = 17;'
      ''
      ''
      ''
      '          INSERT INTO rfm (rfmchave'
      '          , rfichave'
      '          , meschave)'
      ''
      '            (SELECT DISTINCT'
      '              @novachave,'
      '              rfichave,'
      '              @MesChave'
      '            FROM olt'
      '              INNER JOIN mlt'
      '                ON olt.ltechave = mlt.ltechave'
      '              INNER JOIN mfi'
      '                ON mlt.mfichave = mfi.mfichave'
      '            WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '        END LOOP;'
      ''
      ''
      '        CLOSE curlote;'
      ''
      '      END IF;'
      ''
      ''
      '      INSERT INTO rfm (rfmchave'
      '      , rfichave'
      '      , meschave)'
      ''
      '        (SELECT DISTINCT'
      '          @novachave,'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = @OrcChave);'
      ''
      ''
      '      SET ErroMensagem = 18;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      '          orc.orcpercdescav = @percdesc,'
      '          orc.orctotalap = (tito.totap - tito.descap),'
      '          orc.orcdataencerr = CURRENT_DATE(),'
      '          orc.orchoraencerr = CURRENT_TIME(),'
      '          orc.stocodigo = 3'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.stocodigo = 3'
      '      WHERE ito.orcchave = pOrcChave'
      '      AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '    END IF;'
      ''
      '  END IF;'
      ''
      ''
      ''
      '  IF @meschave > 0 THEN'
      '    SET pMesChave = @meschave;'
      '  ELSE'
      '    SET pMesChave = 0;'
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      'END //'
      ''
      ''
      '')
    Left = 344
    Top = 592
  end
  object us001305: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS FechaMesa//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesa (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      ''
      '  /* daniel 02/01/202508:50 */'
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = pOrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 13;'
      ''
      ''
      ''
      '    INSERT INTO olt (oltchave'
      '    , orcchave'
      '    , ltechave'
      '    , oltidentificacao'
      '    , olttipo)'
      
        '      VALUE (@novachave, pOrcChave, @ltechave, pNome, pTipoFecha' +
        'mento);'
      ''
      ''
      ''
      ''
      '    SET @LteDesconto = IFNULL((SELECT'
      '        SUM(lte.ltedesconto)'
      '      FROM olt'
      '        INNER JOIN lte'
      '          ON olt.ltechave = lte.ltechave'
      '      WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '    SET @OrcTotalAv = (SELECT'
      '        SUM(itovalorav * itoquantidade) totav'
      '      FROM ito,'
      '           pro'
      '      WHERE ito.procodigo = pro.procodigo'
      '      AND ito.stocodigo <> 88'
      '      AND pro.tpocodigo = 0'
      '      AND orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    IF @LteDesconto > 0 THEN'
      ''
      ''
      '      SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '      UPDATE ito, pro'
      
        '      SET itodescontoav = ROUND(((itototalav + itoacrescimoav + ' +
        'itooutras) * @percdesc), 2),'
      '          itosaldoav = (ito.itototalav - itodescontoav),'
      '          itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '          itosaldoap = (ito.itototalav - itodescontoav),'
      '          itopercdescap = ROUND(@percdesc, 3),'
      '          itopercdescav = ROUND(@percdesc, 3)'
      '      WHERE ito.stocodigo <> 88'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo = 0'
      '      AND ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '      SET @centavos = @LteDesconto - (SELECT'
      '          SUM(itodescontoav)'
      '        FROM ito,'
      '             pro'
      '        WHERE ito.orcchave = pOrcChave'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0);'
      ''
      ''
      ''
      ''
      '      IF @centavos <> 0 THEN'
      ''
      '        UPDATE ito, pro'
      '        SET itodescontoav = itodescontoav + @centavos,'
      '            itodescontoap = itodescontoap + @centavos,'
      '            itosaldoav = itosaldoav + @centavos,'
      '            itosaldoap = itosaldoap + @centavos'
      '        WHERE ito.stocodigo <> 88'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0'
      '        AND ito.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      
        '          orc.orcpercdescav = IF(tito.descap > 0, (tito.descap /' +
        ' tito.totap), 0),'
      '          orc.orctotalap = (tito.totap - tito.descap)'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      '    END IF;'
      ''
      ''
      '    SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '    CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pConfi' +
        'rma, pMensagem, @meschave);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 14;'
      ''
      ''
      ''
      '    SET @VlrFechamento = (SELECT'
      '        SUM(dtl.dtlvalor) dtlvalor'
      '      FROM dtl'
      '        INNER JOIN olt'
      '          ON dtl.ltechave = olt.ltechave'
      '      WHERE olt.orcchave = pOrcChave'
      '      AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '    IF @VlrFechamento > 0 THEN'
      ''
      ''
      '      SET @etdcodigo = (SELECT'
      '          etdcodigo'
      '        FROM orc'
      '        WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '      SET ErroMensagem = 15;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      OPEN curlote;'
      '    read_loop:'
      '      LOOP'
      ''
      '        FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '        IF done THEN'
      ''
      '          LEAVE read_loop;'
      '        END IF;'
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade'
      '          AND dtl.mdacodigo != 7);'
      ''
      '        DELETE'
      '          FROM trfi'
      '        WHERE mdacodigo <> modalidade;'
      ''
      '        INSERT INTO trfi (ID'
      '        , etdcodigo'
      '        , mdacodigo'
      '        , tfdcodigo'
      '        , numparc'
      '        , dtvecto'
      '        , vlrparcela'
      '        , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE' +
        '(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '        CALL RegistraTitulo(pFlaCodigo, lote, 1, ErroMensagem, @' +
        'TitCodigo);'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '        SET ErroMensagem = 17;'
      ''
      ''
      ''
      ''
      ''
      ''
      '      END LOOP;'
      ''
      ''
      '      CLOSE curlote;'
      ''
      '    END IF;'
      ''
      ''
      ''
      ''
      ''
      '    INSERT INTO rfm (rfichave'
      '    , meschave)'
      ''
      '      (SELECT DISTINCT'
      ''
      '        rfichave,'
      '        @MesChave'
      '      FROM olt'
      '        INNER JOIN mlt'
      '          ON olt.ltechave = mlt.ltechave'
      '        INNER JOIN mfi'
      '          ON mlt.mfichave = mfi.mfichave'
      '      WHERE olt.orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '        orc.orctotalav = (tito.totav - tito.descav),'
      ''
      ''
      ''
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        orc.orcdataencerr = CURRENT_DATE(),'
      '        orc.orchoraencerr = CURRENT_TIME(),'
      '        orc.stocodigo = 3'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      '    UPDATE ito'
      '    SET ito.stocodigo = 3'
      '    WHERE ito.orcchave = pOrcChave'
      '    AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF @meschave > 0 THEN'
      '    SET pMesChave = @meschave;'
      '  ELSE'
      '    SET pMesChave = 0;'
      '  END IF;'
      ''
      '  SET pConfirma = ErroException;'
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      'END //')
    Left = 392
    Top = 592
  end
  object us001306: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS RegistraTituloVenda//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraTituloVenda(IN pFlaCodigo int'
      ', IN pLteChave int'
      ', IN pMdaCodigo int'
      ', IN pChamada int'
      ', OUT pTitCodigo int)'
      'BEGIN'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      '  DELETE'
      '    FROM terro;'
      ''
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao incluir Titulo'#39');'
      ''
      ''
      '  SELECT'
      '    etdcodigo,'
      '    tfdcodigo,'
      '    dtvecto'
      '  FROM trfi'
      '  ORDER BY dtvecto DESC LIMIT 1 INTO @etdcodigo'
      '  , @tfdcodigo'
      '  , @dtvenctoInicial;'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      ''
      '  SET @rdcnrauto = IFNULL((SELECT'
      '      rdc.rdcnrauto'
      '    FROM lte,'
      '         dtl,'
      '         ltr,'
      '         rdc'
      '    WHERE dtl.dtlchave = ltr.dtlchave'
      '    AND lte.ltechave = dtl.ltechave'
      '    AND ltr.rdcchave = rdc.rdcchave'
      '    AND dtl.mdacodigo = pMdaCodigo'
      '    AND lte.ltechave = pLteChave), '#39#39');'
      ''
      ''
      '  SET @vlrtitulo = (SELECT'
      '      SUM(vlrparcela)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @ContaParcela = (SELECT'
      '      MIN(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @QtdParcela = (SELECT'
      '      MAX(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @totparcela = (SELECT'
      '      COUNT(*)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @numparcela = 0;'
      ''
      ''
      '  INSERT INTO tit (titcodigo'
      '  , etdcodigo'
      '  , tfdcodigo'
      '  , flacodigo'
      '  , tficodigo'
      '  , bcocodigo'
      '  , carcodigo'
      '  , titemissao'
      '  , tithora'
      '  , clbcodigo'
      '  , titparcelas'
      '  , titvctoinicial'
      '  , titnumero'
      '  , titvalorparcela'
      '  , titvalor'
      '  , tithistorico'
      '  , srfcodigo'
      '  , moecodigo)'
      
        '    VALUES (@novachave, @etdcodigo, 32, pFlaCodigo, 9, '#39'000'#39', 1,' +
        ' CURRENT_DATE(), CURRENT_TIME(), @clbcodigo, @QtdParcela, @dtven' +
        'ctoInicial, '#39#39', @vlrtitulo, @vlrtitulo, '#39#39', IF(@tfdcodigo = 32, ' +
        '2, 0), 1);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pTitCodigo = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao Gerar Parcelas'#39
      '    WHERE Chamada = pChamada;'
      ''
      ''
      '    WHILE (@ContaParcela <= @QtdParcela) DO'
      '      IF pMdaCodigo = IFNULL((SELECT'
      '            mdacodigo'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela), 0) THEN'
      '        SET @numparcela = @numparcela + 1;'
      '        INSERT INTO rfi (rfichave'
      '        , titcodigo'
      '        , etdcodigo'
      '        , tfdcodigo'
      '        , flacodigo'
      '        , tficodigo'
      '        , bcocodigo'
      '        , carcodigo'
      '        , rfiemissao'
      '        , rfivencimento'
      '        , rfinumero'
      '        , rfivalor'
      '        , rfihistorico'
      '        , srfcodigo'
      '        , frrcodigo'
      '        , rfivalorparcela'
      '        , moecodigo'
      '        , rdcnrauto)'
      '          SELECT'
      '            @novachave,'
      '            pTitCodigo,'
      '            trfi.etdcodigo,'
      '            @tfdcodigo := 32,'
      '            pFlaCodigo,'
      '            IF(trfi.tfdcodigo = 2, 10, 9),'
      '            '#39'000'#39','
      '            1,'
      '            CURRENT_DATE(),'
      '            trfi.dtvecto,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), '#39#39'), trfi.numparc, '#39'/'#39', @totparcela),'
      '            @vlrParcela := trfi.vlrparcela,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), CONCAT(pTitCodigo, '#39' - '#39')), trfi.numparc, '#39'/'#39', @totpa' +
        'rcela),'
      '            IF(trfi.tfdcodigo = 2, 0, 2),'
      '            999,'
      '            trfi.vlrparcela,'
      '            1,'
      '            @rdcnrauto'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela;'
      ''
      ''
      '        IF ROW_COUNT() > 0 THEN'
      '          SET @rficodigo = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      '          UPDATE terro'
      
        '          SET Mensagem = '#39'Erro ao gerar movimento inicial da par' +
        'cela'#39
      '          WHERE Chamada = pChamada;'
      ''
      ''
      '          INSERT INTO mfi (mfichave'
      '          , rfichave'
      '          , tmfcodigo'
      '          , moecodigo'
      '          , mfivalor'
      '          , mfidata)'
      
        '            VALUES (@novachave, @rficodigo, 2, 1, @vlrParcela, C' +
        'URRENT_DATE());'
      ''
      ''
      '          IF ROW_COUNT() > 0 THEN'
      '            SET @mfichave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar ligacao entre moviment' +
        'o e parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      ''
      '            INSERT INTO mlt (mltchave'
      '            , mfichave'
      '            , ltechave)'
      '              VALUES (@novachave, @mfichave, pLteChave);'
      ''
      ''
      ''
      ''
      '          END IF;'
      ''
      ''
      '          IF @tfdcodigo = 32 THEN'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar movimento de recebimen' +
        'to da parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      ''
      ''
      ''
      ''
      '            INSERT INTO mfi (mfichave'
      '            , rfichave'
      '            , tmfcodigo'
      '            , moecodigo'
      '            , mfivalor'
      '            , mfidata)'
      
        '              VALUES (@novachave, @rficodigo, 21, 1, @vlrParcela' +
        ', CURRENT_DATE());'
      ''
      ''
      ''
      '            IF ROW_COUNT() > 0 THEN'
      '              SET @mfichave = (SELECT'
      '                  LAST_INSERT_ID());'
      ''
      '              UPDATE terro'
      
        '              SET Mensagem = '#39'Erro ao gerar ligacao entre movime' +
        'nto e parcela'#39
      '              WHERE Chamada = pChamada;'
      ''
      ''
      '              INSERT INTO mlt (mltchave'
      '              , mfichave'
      '              , ltechave)'
      '                VALUES (@novachave, @mfichave, pLteChave);'
      '            END IF;'
      '          END IF;'
      '        END IF;'
      '      END IF;'
      ''
      '      SET @ContaParcela = @ContaParcela + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      'END //')
    Delimiter = '//'
    Left = 448
    Top = 584
  end
  object us001307: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS RegistraFinanceiro//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraFinanceiro (IN pFlaCodigo int'
      ', IN pLteChave int'
      ', IN pMdaCodigo int'
      ', IN pChamada int'
      ', in pTitCodigo int'
      ', OUT rTitCodigo int)'
      'BEGIN'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      '  DELETE'
      '    FROM terro;'
      ''
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao incluir Titulo'#39');'
      ''
      ''
      '  SELECT'
      '    etdcodigo,'
      '    tfdcodigo,'
      '    dtvecto'
      '  FROM trfi'
      '  ORDER BY dtvecto DESC LIMIT 1 INTO @etdcodigo'
      '  , @tfdcodigo'
      '  , @dtvenctoInicial;'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      ''
      '  SET @rdcnrauto = IFNULL((SELECT'
      '      rdc.rdcnrauto'
      '    FROM lte,'
      '         dtl,'
      '         ltr,'
      '         rdc'
      '    WHERE dtl.dtlchave = ltr.dtlchave'
      '    AND lte.ltechave = dtl.ltechave'
      '    AND ltr.rdcchave = rdc.rdcchave'
      '    AND dtl.mdacodigo = pMdaCodigo'
      '    AND lte.ltechave = pLteChave), '#39#39');'
      ''
      ''
      '  SET @vlrtitulo = (SELECT'
      '      SUM(vlrparcela)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @ContaParcela = (SELECT'
      '      MIN(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @QtdParcela = (SELECT'
      '      MAX(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @totparcela = (SELECT'
      '      COUNT(*)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @numparcela = 0;'
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao Gerar Parcelas'#39
      '    WHERE Chamada = pChamada;'
      ''
      ''
      '    WHILE (@ContaParcela <= @QtdParcela) DO'
      '      IF pMdaCodigo = IFNULL((SELECT'
      '            mdacodigo'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela), 0) THEN'
      '        SET @numparcela = @numparcela + 1;'
      '        INSERT INTO rfi (rfichave'
      '        , titcodigo'
      '        , etdcodigo'
      '        , tfdcodigo'
      '        , flacodigo'
      '        , tficodigo'
      '        , bcocodigo'
      '        , carcodigo'
      '        , rfiemissao'
      '        , rfivencimento'
      '        , rfinumero'
      '        , rfivalor'
      '        , rfihistorico'
      '        , srfcodigo'
      '        , frrcodigo'
      '        , rfivalorparcela'
      '        , moecodigo'
      '        , rdcnrauto)'
      '          SELECT'
      '            @novachave,'
      '            pTitCodigo,'
      '            trfi.etdcodigo,'
      '            @tfdcodigo := trfi.tfdcodigo,'
      '            pFlaCodigo,'
      '            IF(trfi.tfdcodigo = 2, 10, 9),'
      '            '#39'000'#39','
      '            1,'
      '            CURRENT_DATE(),'
      '            trfi.dtvecto,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), '#39#39'), trfi.numparc, '#39'/'#39', @totparcela),'
      '            @vlrParcela := trfi.vlrparcela,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), CONCAT(pTitCodigo, '#39' - '#39')), trfi.numparc, '#39'/'#39', @totpa' +
        'rcela),'
      '            IF(trfi.tfdcodigo = 2, 0, 2),'
      '            999,'
      '            trfi.vlrparcela,'
      '            1,'
      '            @rdcnrauto'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela;'
      ''
      ''
      '        IF ROW_COUNT() > 0 THEN'
      '          SET @rficodigo = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      '          UPDATE terro'
      
        '          SET Mensagem = '#39'Erro ao gerar movimento inicial da par' +
        'cela'#39
      '          WHERE Chamada = pChamada;'
      ''
      ''
      '          INSERT INTO mfi (mfichave'
      '          , rfichave'
      '          , tmfcodigo'
      '          , moecodigo'
      '          , mfivalor'
      '          , mfidata)'
      
        '            VALUES (@novachave, @rficodigo, 2, 1, @vlrParcela, C' +
        'URRENT_DATE());'
      ''
      ''
      '          IF ROW_COUNT() > 0 THEN'
      '            SET @mfichave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar ligacao entre moviment' +
        'o e parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      ''
      '            INSERT INTO mlt (mltchave'
      '            , mfichave'
      '            , ltechave)'
      '              VALUES (@novachave, @mfichave, pLteChave);'
      ''
      '          END IF;'
      ''
      ''
      '          IF @tfdcodigo = 32 THEN'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar movimento de recebimen' +
        'to da parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      '            INSERT INTO mfi (mfichave'
      '            , rfichave'
      '            , tmfcodigo'
      '            , moecodigo'
      '            , mfivalor'
      '            , mfidata)'
      
        '              VALUES (@novachave, @rficodigo, 21, 1, @vlrParcela' +
        ', CURRENT_DATE());'
      ''
      '            IF ROW_COUNT() > 0 THEN'
      '              SET @mfichave = (SELECT'
      '                  LAST_INSERT_ID());'
      ''
      '              UPDATE terro'
      
        '              SET Mensagem = '#39'Erro ao gerar ligacao entre movime' +
        'nto e parcela'#39
      '              WHERE Chamada = pChamada;'
      ''
      ''
      '              INSERT INTO mlt (mltchave'
      '              , mfichave'
      '              , ltechave)'
      '                VALUES (@novachave, @mfichave, pLteChave);'
      '            END IF;'
      '          END IF;'
      '        END IF;'
      '      END IF;'
      ''
      '      SET @ContaParcela = @ContaParcela + 1;'
      '    END WHILE;'
      ''
      '  SET rTitCodigo:=pTitCodigo;'
      ''
      'END//')
    Delimiter = '//'
    Left = 32
    Top = 648
  end
  object us001308: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS FechaMesa//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesa (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      '  -- daniel 02/01/2025 10:40'
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = pOrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      '    SET ErroMensagem = 13;'
      ''
      ''
      ''
      '    INSERT INTO olt (oltchave'
      '    , orcchave'
      '    , ltechave'
      '    , oltidentificacao'
      '    , olttipo)'
      
        '      VALUE (@novachave, pOrcChave, @ltechave, pNome, pTipoFecha' +
        'mento);'
      ''
      ''
      '    SET @LteDesconto = IFNULL((SELECT'
      '        SUM(lte.ltedesconto)'
      '      FROM olt'
      '        INNER JOIN lte'
      '          ON olt.ltechave = lte.ltechave'
      '      WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '    SET @OrcTotalAv = (SELECT'
      '        SUM(itovalorav * itoquantidade) totav'
      '      FROM ito,'
      '           pro'
      '      WHERE ito.procodigo = pro.procodigo'
      '      AND ito.stocodigo <> 88'
      '      AND pro.tpocodigo = 0'
      '      AND orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    IF @LteDesconto > 0 THEN'
      ''
      ''
      '      SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      ''
      ''
      '      UPDATE ito, pro'
      
        '      SET itodescontoav = ROUND(((itototalav + itoacrescimoav + ' +
        'itooutras) * @percdesc), 2),'
      '          itosaldoav = (ito.itototalav - itodescontoav),'
      '          itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '          itosaldoap = (ito.itototalav - itodescontoav),'
      '          itopercdescap = ROUND(@percdesc, 3),'
      '          itopercdescav = ROUND(@percdesc, 3)'
      '      WHERE ito.stocodigo <> 88'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo = 0'
      '      AND ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '      SET @centavos = @LteDesconto - (SELECT'
      '          SUM(itodescontoav)'
      '        FROM ito,'
      '             pro'
      '        WHERE ito.orcchave = pOrcChave'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0);'
      ''
      ''
      ''
      ''
      '      IF @centavos <> 0 THEN'
      ''
      '        UPDATE ito, pro'
      '        SET itodescontoav = itodescontoav + @centavos,'
      '            itodescontoap = itodescontoap + @centavos,'
      '            itosaldoav = itosaldoav + @centavos,'
      '            itosaldoap = itosaldoap + @centavos'
      '        WHERE ito.stocodigo <> 88'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0'
      '        AND ito.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      
        '          orc.orcpercdescav = IF(tito.descap > 0, (tito.descap /' +
        ' tito.totap), 0),'
      '          orc.orctotalap = (tito.totap - tito.descap)'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      '    END IF;'
      ''
      ''
      '    SET ErroMensagem = 12;'
      ''
      ''
      ''
      ''
      
        '    CALL RegistraMes(pOrcChave, pClbCodigo, ErroMensagem, pConfi' +
        'rma, pMensagem, @meschave);'
      ''
      ''
      '    SET ErroMensagem = 14;'
      ''
      ''
      '    SET @VlrFechamento = (SELECT'
      '        SUM(dtl.dtlvalor) dtlvalor'
      '      FROM dtl'
      '        INNER JOIN olt'
      '          ON dtl.ltechave = olt.ltechave'
      '      WHERE olt.orcchave = pOrcChave'
      '      AND dtl.mdacodigo != 7);'
      ''
      ''
      ''
      '    IF @VlrFechamento > 0 THEN'
      ''
      '      SET @etdcodigo = (SELECT'
      '          etdcodigo'
      '        FROM orc'
      '        WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '      SET ErroMensagem = 15;'
      ''
      '      SET @VlrFechamento = (SELECT'
      '          SUM(dtl.dtlvalor) dtlvalor'
      '        FROM dtl'
      '          INNER JOIN olt'
      '            ON dtl.ltechave = olt.ltechave'
      '        WHERE olt.orcchave = pOrcChave'
      '        AND dtl.ltechave = lote);'
      ''
      '      DELETE'
      '        FROM trfi'
      '      WHERE mdacodigo <> modalidade;'
      ''
      '      INSERT INTO trfi (ID'
      '      , etdcodigo'
      '      , mdacodigo'
      '      , tfdcodigo'
      '      , numparc'
      '      , dtvecto'
      '      , vlrparcela'
      '      , numero)'
      
        '        VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE()' +
        ', @VlrFechamento, @meschave);'
      ''
      '      SET ErroMensagem = 16;'
      ''
      
        '      CALL RegistraTituloVenda(pFlaCodigo, lote, 1, ErroMensagem' +
        ', @TitCodigo);'
      ''
      ''
      '      INSERT INTO rfm (rfichave, meschave)'
      '        (SELECT DISTINCT'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = pOrcChave);'
      ''
      ''
      ''
      '      SET ErroMensagem = 17;'
      ''
      ''
      '      OPEN curlote; /*  vai gerar regisros financeiros do RFI */'
      '    read_loop:'
      '      LOOP'
      ''
      '        FETCH curlote INTO lote, modalidade;'
      ''
      '        IF done THEN'
      ''
      '          LEAVE read_loop;'
      '        END IF;'
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade'
      '          AND dtl.mdacodigo != 7);'
      ''
      '        DELETE'
      '          FROM trfi'
      '        WHERE mdacodigo <> modalidade;'
      ''
      '        INSERT INTO trfi (ID'
      '        , etdcodigo'
      '        , mdacodigo'
      '        , tfdcodigo'
      '        , numparc'
      '        , dtvecto'
      '        , vlrparcela'
      '        , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE' +
        '(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '        SET ErroMensagem = 16;'
      ''
      ''
      ''
      
        '        CALL RegistraFinanceiro(pFlaCodigo, lote, 1, ErroMensage' +
        'm, @TitCodigo);'
      ''
      '        SET ErroMensagem = 17;'
      ''
      ''
      '      END LOOP;'
      ''
      '      CLOSE curlote;'
      ''
      ''
      '      INSERT INTO rfm (rfichave'
      '      , meschave)'
      ''
      '        (SELECT DISTINCT'
      ''
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = pOrcChave);'
      ''
      '    END IF;'
      ''
      ''
      ''
      '    SET ErroMensagem = 18;'
      ''
      ''
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '        orc.orctotalav = (tito.totav - tito.descav),'
      ''
      ''
      ''
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        orc.orcdataencerr = CURRENT_DATE(),'
      '        orc.orchoraencerr = CURRENT_TIME(),'
      '        orc.stocodigo = 3'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      '    UPDATE ito'
      '    SET ito.stocodigo = 3'
      '    WHERE ito.orcchave = pOrcChave'
      '    AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF @meschave > 0 THEN'
      '    SET pMesChave = @meschave;'
      '  ELSE'
      '    SET pMesChave = 0;'
      '  END IF;'
      ''
      '  SET pConfirma = ErroException;'
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      'END //')
    Left = 88
    Top = 648
  end
  object us001309: TUniScript
    SQL.Strings = (
      '-- '
      ''
      '--'
      '-- Disable foreign keys'
      '--'
      
        '/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREI' +
        'GN_KEY_CHECKS=0 */;'
      ''
      ''
      'SET NAMES '#39'utf8'#39'//'
      ''
      ''
      'DROP PROCEDURE IF EXISTS RegistraCartaoCCO//'
      ''
      '--'
      '-- Create procedure "RegistraCartaoCCO"'
      '--'
      'CREATE PROCEDURE RegistraCartaoCCO(IN pLteChave int'
      ', IN pClbCodigo int'
      ', IN pCedCodigo int'
      ', IN pHistorico varchar(100)'
      ', IN pDtlChave int'
      ', IN pValor double(16, 2)'
      ', IN pChamada int'
      ', OUT pCcoChave int)'
      'BEGIN'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao registrar movimento de caixa'#39');'
      ''
      '  SET @ctacodigo = (SELECT'
      '      ctacodigo'
      '    FROM adc WHERE '
      '    adcencerramento IS NULL ORDER BY adccodigo DESC LIMIT 1 );'
      ''
      '   SET @rdcnrauto ='#39#39';'
      ''
      '  SET @rdcnrauto = (SELECT'
      '      rdcnrauto'
      '    FROM dtl WHERE '
      '    dtlchave=pDtlChave);'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      '  SET @Conciliado = (SELECT'
      '      IF(tctcodigo = 2, 0, 1)'
      '    FROM cta'
      '    WHERE ctacodigo = @ctacodigo);'
      ''
      ''
      '  INSERT INTO cco (ccochave'
      '  , ctacodigo'
      '  , toccodigo'
      '  , cedcodigo'
      '  , clbcodigo'
      '  , tficodigo'
      '  , moecodigo'
      '  , ccoemissao'
      '  , ccovencimento'
      '  , ccohistorico'
      '  , ccovalor'
      '  , ccoconciliado'
      '  , etdcodigo'
      '  , ccofavorecido'
      '  , ccodatamov'
      '  , ccodataregistro'
      '  , ccohoraregistro)'
      
        '    VALUES (@novachave, @ctacodigo, 1, pCedCodigo, pClbCodigo, 9' +
        ', 1, CURRENT_DATE(), CURRENT_DATE(),pHistorico, pValor, @Concili' +
        'ado, 0, '#39#39', CURRENT_DATE(), CURRENT_DATE(), CURRENT_TIME());'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pCcoChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      ''
      '    UPDATE terro'
      '    SET mensagem = '#39'Erro ao vincular movimento de caixa ao lote'#39
      '    WHERE chamada = pChamada;'
      ''
      ''
      '    INSERT INTO clt (cltchave'
      '    , ccochave'
      '    , ltechave)'
      '      VALUES (@novachave, pCcoChave, pLteChave);'
      '  ELSE'
      '    SET pCcoChave = 0;'
      '  END IF;'
      ''
      'END //'
      ''
      ''
      '--'
      '-- Create procedure "RegistraFinanceiro"'
      '--'
      ''
      'DROP PROCEDURE IF EXISTS RegistraFinanceiro//'
      ''
      'CREATE PROCEDURE RegistraFinanceiro(IN pFlaCodigo int'
      ', IN pLteChave int'
      ', IN pMdaCodigo int'
      ', IN pChamada int'
      ', in pTitCodigo int'
      ', OUT rTitCodigo int)'
      'BEGIN'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      '  DELETE'
      '    FROM terro;'
      ''
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao incluir Titulo'#39');'
      ''
      ''
      '  SELECT'
      '    etdcodigo,'
      '    tfdcodigo,'
      '    dtvecto'
      '  FROM trfi'
      '  ORDER BY dtvecto DESC LIMIT 1 INTO @etdcodigo'
      '  , @tfdcodigo'
      '  , @dtvenctoInicial;'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      ''
      '  SET @rdcnrauto = IFNULL((SELECT'
      '      rdc.rdcnrauto'
      '    FROM lte,'
      '         dtl,'
      '         ltr,'
      '         rdc'
      '    WHERE dtl.dtlchave = ltr.dtlchave'
      '    AND lte.ltechave = dtl.ltechave'
      '    AND ltr.rdcchave = rdc.rdcchave'
      '    AND dtl.mdacodigo = pMdaCodigo'
      '    AND lte.ltechave = pLteChave), '#39#39');'
      ''
      ''
      '  SET @vlrtitulo = (SELECT'
      '      SUM(vlrparcela)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @ContaParcela = (SELECT'
      '      MIN(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @QtdParcela = (SELECT'
      '      MAX(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @totparcela = (SELECT'
      '      COUNT(*)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @numparcela = 0;'
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao Gerar Parcelas'#39
      '    WHERE Chamada = pChamada;'
      ''
      ''
      '    WHILE (@ContaParcela <= @QtdParcela) DO'
      '      IF pMdaCodigo = IFNULL((SELECT'
      '            mdacodigo'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela), 0) THEN'
      '        SET @numparcela = @numparcela + 1;'
      '        INSERT INTO rfi (rfichave'
      '        , titcodigo'
      '        , etdcodigo'
      '        , tfdcodigo'
      '        , flacodigo'
      '        , tficodigo'
      '        , bcocodigo'
      '        , carcodigo'
      '        , rfiemissao'
      '        , rfivencimento'
      '        , rfinumero'
      '        , rfivalor'
      '        , rfihistorico'
      '        , srfcodigo'
      '        , frrcodigo'
      '        , rfivalorparcela'
      '        , moecodigo'
      '        , rdcnrauto)'
      '          SELECT'
      '            @novachave,'
      '            pTitCodigo,'
      '            trfi.etdcodigo,'
      '            @tfdcodigo := trfi.tfdcodigo,'
      '            pFlaCodigo,'
      '            IF(trfi.tfdcodigo = 2, 10, 9),'
      '            '#39'000'#39','
      '            1,'
      '            CURRENT_DATE(),'
      '            trfi.dtvecto,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), '#39#39'), trfi.numparc, '#39'/'#39', @totparcela),'
      '            @vlrParcela := trfi.vlrparcela,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), CONCAT(pTitCodigo, '#39' - '#39')), trfi.numparc, '#39'/'#39', @totpa' +
        'rcela),'
      '            IF(trfi.tfdcodigo = 2, 0, 2),'
      '            999,'
      '            trfi.vlrparcela,'
      '            1,'
      '            @rdcnrauto'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela;'
      ''
      ''
      '        IF ROW_COUNT() > 0 THEN'
      '          SET @rficodigo = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      '          UPDATE terro'
      
        '          SET Mensagem = '#39'Erro ao gerar movimento inicial da par' +
        'cela'#39
      '          WHERE Chamada = pChamada;'
      ''
      ''
      '          INSERT INTO mfi (mfichave'
      '          , rfichave'
      '          , tmfcodigo'
      '          , moecodigo'
      '          , mfivalor'
      '          , mfidata)'
      
        '            VALUES (@novachave, @rficodigo, 2, 1, @vlrParcela, C' +
        'URRENT_DATE());'
      ''
      ''
      '          IF ROW_COUNT() > 0 THEN'
      '            SET @mfichave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar ligacao entre moviment' +
        'o e parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      ''
      '            INSERT INTO mlt (mltchave'
      '            , mfichave'
      '            , ltechave)'
      '              VALUES (@novachave, @mfichave, pLteChave);'
      ''
      '          END IF;'
      ''
      ''
      '          IF @tfdcodigo = 32 THEN'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar movimento de recebimen' +
        'to da parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      '            INSERT INTO mfi (mfichave'
      '            , rfichave'
      '            , tmfcodigo'
      '            , moecodigo'
      '            , mfivalor'
      '            , mfidata)'
      
        '              VALUES (@novachave, @rficodigo, 21, 1, @vlrParcela' +
        ', CURRENT_DATE());'
      ''
      '            IF ROW_COUNT() > 0 THEN'
      '              SET @mfichave = (SELECT'
      '                  LAST_INSERT_ID());'
      ''
      '              UPDATE terro'
      
        '              SET Mensagem = '#39'Erro ao gerar ligacao entre movime' +
        'nto e parcela'#39
      '              WHERE Chamada = pChamada;'
      ''
      ''
      '              INSERT INTO mlt (mltchave'
      '              , mfichave'
      '              , ltechave)'
      '                VALUES (@novachave, @mfichave, pLteChave);'
      '            END IF;'
      '          END IF;'
      '        END IF;'
      '      END IF;'
      ''
      '      SET @ContaParcela = @ContaParcela + 1;'
      '    END WHILE;'
      ''
      '  SET rTitCodigo:=@rficodigo;'
      ''
      'END //'
      ''
      ''
      '--'
      '-- Create procedure "RegistraTituloVenda"'
      '--'
      ''
      'DROP PROCEDURE IF EXISTS RegistraTituloVenda//'
      ''
      'CREATE PROCEDURE RegistraTituloVenda(IN pFlaCodigo int'
      ', IN pLteChave int'
      ', IN pMdaCodigo int'
      ', IN pChamada int'
      ', OUT pTitCodigo int)'
      'BEGIN'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      '  DELETE'
      '    FROM terro;'
      ''
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao incluir Titulo'#39');'
      ''
      ''
      '  SELECT'
      '    etdcodigo,'
      '    tfdcodigo,'
      '    dtvecto'
      '  FROM trfi'
      '  ORDER BY dtvecto DESC LIMIT 1 INTO @etdcodigo'
      '  , @tfdcodigo'
      '  , @dtvenctoInicial;'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      ''
      '  SET @clbcodigo = 1;'
      ''
      '  SET @rdcnrauto = IFNULL((SELECT'
      '      rdc.rdcnrauto'
      '    FROM lte,'
      '         dtl,'
      '         ltr,'
      '         rdc'
      '    WHERE dtl.dtlchave = ltr.dtlchave'
      '    AND lte.ltechave = dtl.ltechave'
      '    AND ltr.rdcchave = rdc.rdcchave'
      '    AND dtl.mdacodigo = pMdaCodigo'
      '    AND lte.ltechave = pLteChave), '#39#39');'
      ''
      ''
      '  SET @vlrtitulo = (SELECT'
      '      SUM(vlrparcela)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @ContaParcela = (SELECT'
      '      MIN(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @QtdParcela = (SELECT'
      '      MAX(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @totparcela = (SELECT'
      '      COUNT(*)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @numparcela = 0;'
      ''
      '  INSERT INTO tit (titcodigo'
      '  , etdcodigo'
      '  , clbcodigo'
      '  , tfdcodigo'
      '  , flacodigo'
      '  , tficodigo'
      '  , bcocodigo'
      '  , carcodigo'
      '  , titemissao'
      '  , tithora'
      '  '
      '  , titparcelas'
      '  , titvctoinicial'
      '  , titnumero'
      '  , titvalorparcela'
      '  , titvalor'
      '  , tithistorico'
      '  , srfcodigo'
      '  , moecodigo)'
      
        '    VALUES (@novachave, @etdcodigo, @clbcodigo, 32, pFlaCodigo, ' +
        '9, '#39'000'#39', 1, CURRENT_DATE(), CURRENT_TIME(), @QtdParcela, @dtven' +
        'ctoInicial, '#39#39', @vlrtitulo, @vlrtitulo, '#39#39', IF(@tfdcodigo = 32, ' +
        '2, 0), 1);'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pTitCodigo = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao Gerar Parcelas'#39
      ''
      '    WHERE Chamada = pChamada;'
      '        SET @numparcela = 1;'
      '        INSERT INTO rfi (rfichave'
      '        , titcodigo'
      '        , etdcodigo'
      '        , tfdcodigo'
      '        , flacodigo'
      '        , tficodigo'
      '        , bcocodigo'
      '        , carcodigo'
      '        , rfiemissao'
      '        , rfivencimento'
      '        , rfinumero'
      '        , rfivalor'
      '        , rfihistorico'
      '        , srfcodigo'
      '        , frrcodigo'
      '        , rfivalorparcela'
      '        , moecodigo'
      '        , rdcnrauto)'
      '          SELECT'
      '            @novachave,'
      '            pTitCodigo,'
      '            trfi.etdcodigo,'
      '            @tfdcodigo := 32,'
      '            pFlaCodigo,'
      '            IF(trfi.tfdcodigo = 2, 10, 9),'
      '            '#39'000'#39','
      '            1,'
      '            CURRENT_DATE(),'
      '            trfi.dtvecto,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), '#39#39'), trfi.numparc, '#39'/'#39', @totparcela),'
      '            @vlrParcela := trfi.vlrparcela,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), CONCAT(pTitCodigo, '#39' - '#39')), trfi.numparc, '#39'/'#39', @totpa' +
        'rcela),'
      '            IF(trfi.tfdcodigo = 2, 0, 2),'
      '            999,'
      '            trfi.vlrparcela,'
      '            1,'
      '            @rdcnrauto'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela;'
      ''
      ''
      '        IF ROW_COUNT() > 0 THEN'
      '          SET @rficodigo = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      '          UPDATE terro'
      
        '          SET Mensagem = '#39'Erro ao gerar movimento inicial da par' +
        'cela'#39
      '          WHERE Chamada = pChamada;'
      ''
      ''
      '          INSERT INTO mfi (mfichave'
      '          , rfichave'
      '          , tmfcodigo'
      '          , moecodigo'
      '          , mfivalor'
      '          , mfidata)'
      
        '            VALUES (@novachave, @rficodigo, 2, 1, @vlrParcela, C' +
        'URRENT_DATE());'
      ''
      ''
      '          IF ROW_COUNT() > 0 THEN'
      '            SET @mfichave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar ligacao entre moviment' +
        'o e parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      ''
      '            INSERT INTO mlt (mltchave'
      '            , mfichave'
      '            , ltechave)'
      '              VALUES (@novachave, @mfichave, pLteChave);'
      ''
      ''
      '          END IF;'
      ''
      ''
      '          IF @tfdcodigo = 32 THEN'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar movimento de recebimen' +
        'to da parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      '            INSERT INTO mfi (mfichave'
      '            , rfichave'
      '            , tmfcodigo'
      '            , moecodigo'
      '            , mfivalor'
      '            , mfidata)'
      
        '              VALUES (@novachave, @rficodigo, 21, 1, @vlrParcela' +
        ', CURRENT_DATE());'
      ''
      '            IF ROW_COUNT() > 0 THEN'
      '              SET @mfichave = (SELECT'
      '                  LAST_INSERT_ID());'
      ''
      '              UPDATE terro'
      
        '              SET Mensagem = '#39'Erro ao gerar ligacao entre movime' +
        'nto e parcela'#39
      '              WHERE Chamada = pChamada;'
      ''
      ''
      '              INSERT INTO mlt (mltchave'
      '              , mfichave'
      '              , ltechave)'
      '                VALUES (@novachave, @mfichave, pLteChave);'
      '            END IF;'
      '          END IF;'
      '        END IF;'
      ''
      '  END IF;'
      ''
      'END //'
      ''
      '--'
      '-- Enable foreign keys'
      '--'
      '/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;')
    Left = 144
    Top = 648
  end
  object us001310: TUniScript
    SQL.Strings = (
      ''
      'SET NAMES '#39'utf8'#39'//'
      ''
      '--'
      '-- Alter procedure "FechaMesa"'
      '--'
      'DROP PROCEDURE FechaMesa//'
      'CREATE PROCEDURE FechaMesa(IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      '  -- daniel 02/01/2025 10:40'
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '    SELECT'
      '      dtl.ltechave,'
      '      dtl.mdacodigo'
      '    FROM dtl'
      '      INNER JOIN olt'
      '        ON dtl.ltechave = olt.ltechave'
      '    WHERE olt.orcchave = pOrcChave'
      '    /* AND dtl.mdacodigo != 7 */;'
      '    DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '      SET done = TRUE;'
      '  END;'
      '  '
      '  '
      '  set @vlClbCodigo = pClbCodigo;'
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      '    SET ErroMensagem = 13;'
      ''
      ''
      ''
      '    INSERT INTO olt (oltchave'
      '    , orcchave'
      '    , ltechave'
      '    , oltidentificacao'
      '    , olttipo)'
      
        '      VALUE (@novachave, pOrcChave, @ltechave, pNome, pTipoFecha' +
        'mento);'
      ''
      ''
      '    SET @LteDesconto = IFNULL((SELECT'
      '        SUM(lte.ltedesconto)'
      '      FROM olt'
      '        INNER JOIN lte'
      '          ON olt.ltechave = lte.ltechave'
      '      WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '    SET @OrcTotalAv = (SELECT'
      '        SUM(itovalorav * itoquantidade) totav'
      '      FROM ito,'
      '           pro'
      '      WHERE ito.procodigo = pro.procodigo'
      '      AND ito.stocodigo <> 88'
      '      AND pro.tpocodigo = 0'
      '      AND orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    IF @LteDesconto > 0 THEN'
      '      SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      '      UPDATE ito, pro'
      
        '      SET itodescontoav = ROUND(((itototalav + itoacrescimoav + ' +
        'itooutras) * @percdesc), 2),'
      '          itosaldoav = (ito.itototalav - itodescontoav),'
      '          itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '          itosaldoap = (ito.itototalav - itodescontoav),'
      '          itopercdescap = ROUND(@percdesc, 3),'
      '          itopercdescav = ROUND(@percdesc, 3)'
      '      WHERE ito.stocodigo <> 88'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo = 0'
      '      AND ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '      SET @centavos = @LteDesconto - (SELECT'
      '          SUM(itodescontoav)'
      '        FROM ito,'
      '             pro'
      '        WHERE ito.orcchave = pOrcChave'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0);'
      ''
      ''
      ''
      ''
      '      IF @centavos <> 0 THEN'
      ''
      '        UPDATE ito, pro'
      '        SET itodescontoav = itodescontoav + @centavos,'
      '            itodescontoap = itodescontoap + @centavos,'
      '            itosaldoav = itosaldoav + @centavos,'
      '            itosaldoap = itosaldoap + @centavos'
      '        WHERE ito.stocodigo <> 88'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0'
      '        AND ito.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      
        '          orc.orcpercdescav = IF(tito.descap > 0, (tito.descap /' +
        ' tito.totap), 0),'
      '          orc.orctotalap = (tito.totap - tito.descap)'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      '    END IF;'
      ''
      ''
      '    SET ErroMensagem = 12;'
      ''
      ''
      
        '    CALL RegistraMes(pOrcChave,  @vlClbCodigo, ErroMensagem, pCo' +
        'nfirma, pMensagem, @meschave);'
      ''
      ''
      '    SET ErroMensagem = 14;'
      ''
      ''
      '    SET @VlrFechamento = (SELECT'
      '        SUM(dtl.dtlvalor) dtlvalor'
      '      FROM dtl'
      '        INNER JOIN olt'
      '          ON dtl.ltechave = olt.ltechave'
      '      WHERE olt.orcchave = pOrcChave);'
      ''
      ''
      '     SET @vlLtechave = (SELECT'
      '          ltechave'
      '      FROM olt        '
      
        '      WHERE olt.orcchave = pOrcChave ORDER by ltechave DESC LIMI' +
        'T 1);'
      ''
      ''
      '    IF @VlrFechamento > 0 THEN'
      ''
      '      SET @etdcodigo = (SELECT'
      '          etdcodigo'
      '        FROM orc'
      '        WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '      SET ErroMensagem = 15;'
      ''
      '      INSERT INTO trfi (ID'
      '      , etdcodigo'
      '      , mdacodigo'
      '      , tfdcodigo'
      '      , numparc'
      '      , dtvecto'
      '      , vlrparcela'
      '      , numero)'
      
        '        VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE()' +
        ', @VlrFechamento, @meschave);'
      ''
      '      SET ErroMensagem = 16;'
      ''
      
        '      CALL RegistraTituloVenda(pFlaCodigo,  @vlLtechave, 1, Erro' +
        'Mensagem, @TitCodigo);'
      ''
      '      DELETE FROM trfi WHERE numero= @meschave;'
      ''
      '      INSERT INTO rfm (rfichave, meschave)'
      '        (SELECT DISTINCT'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = pOrcChave);'
      ''
      '      SET ErroMensagem = 17;'
      ''
      '      OPEN curlote; '
      '    read_loop:'
      '      LOOP'
      ''
      '        FETCH curlote INTO lote, modalidade;'
      ''
      '        IF done THEN'
      '          LEAVE read_loop;'
      '        END IF;'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade  );'
      ''
      '         SET @vlLtechave = (SELECT'
      '            dtl.ltechave'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade );'
      ''
      '        DELETE'
      '          FROM trfi'
      '        WHERE mdacodigo <> modalidade;'
      ''
      '        IF modalidade=7 AND lote<>0 then '
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 2, 1, CURRENT_DATE(' +
        '), @VlrFechamento, @meschave);'
      ''
      '          SET ErroMensagem = 16;'
      '          SET @rtitcodigo=0;'
      '      '
      
        '        /*  CALL RegistraFinanceiro(pFlaCodigo,lote , 1, ErroMen' +
        'sagem, @TitCodigo, @rtitcodigo);'
      '      '
      ''
      '           INSERT INTO rfm (rfichave'
      '            , meschave)'
      ''
      '            (SELECT DISTINCT'
      '                rfichave,'
      '                @MesChave'
      '            FROM olt'
      '              INNER JOIN mlt'
      '                ON olt.ltechave = mlt.ltechave'
      '              INNER JOIN mfi'
      '                ON mlt.mfichave = mfi.mfichave'
      '            WHERE olt.orcchave = pOrcChave'
      '             AND mfi.tmfcodigo=21);'
      ''
      '          SET ErroMensagem = 17;*/'
      '        END IF; '
      ''
      ''
      ''
      ''
      ''
      '      END LOOP;'
      ''
      '      CLOSE curlote;'
      ''
      ''
      '     '
      '    END IF;'
      ''
      '    SET ErroMensagem = 18;'
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '        orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        orc.orcdataencerr = CURRENT_DATE(),'
      '        orc.orchoraencerr = CURRENT_TIME(),'
      '        orc.stocodigo = 3'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      '    UPDATE ito'
      '    SET ito.stocodigo = 3'
      '    WHERE ito.orcchave = pOrcChave'
      '    AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF @meschave > 0 THEN'
      '    SET pMesChave = @meschave;'
      '  ELSE'
      '    SET pMesChave = 0;'
      '  END IF;'
      ''
      '  SET pConfirma = ErroException;'
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      'END //'
      ''
      ''
      '--'
      '-- Alter procedure "FechaMesaParcial"'
      '--'
      'DROP PROCEDURE FechaMesaParcial//'
      
        'CREATE PROCEDURE FechaMesaParcial(IN pOrcChave int, IN pTipo int' +
        ', IN pNome varchar(20), IN pFlaCodigo int, IN pClbCodigo int, IN' +
        ' pCtaCodigo int, IN pLtePrincipal double(16, 02), IN pLteJuros d' +
        'ouble(16, 02), IN pLteDesconto double(16, 02), IN pLteMulta doub' +
        'le(16, 02), IN pLteTroco double(16, 02), IN pRefeicao int, IN pT' +
        'ipoTaxa int, IN pTaxa double(16, 02), IN pTipoFechamento int, OU' +
        'T pConfirma int, OUT pMensagem varchar(65000), OUT pMesChave int' +
        ', OUT pLteChave int)'
      'BEGIN'
      ''
      '  -- daniel 02/01/202508:50'
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT DISTINCT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      ''
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = @OrcChave'
      '  AND dtl.mdacodigo != 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      '  IF pLteDesconto > 0 THEN'
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      '  ELSE'
      '    SET @percdesc = 0;'
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      '    SET pLteChave = @ltechave;'
      ''
      '    IF pTipo = 1 THEN'
      ''
      '      SET @qtdItem = (SELECT'
      '          COUNT(*)'
      '        FROM titem);'
      ''
      '      IF (@qtdItem > 0) THEN'
      ''
      '        SET @ContaItem = 1;'
      ''
      '        SET ErroMensagem = 1;'
      ''
      '        INSERT INTO orc (orcchave'
      '        , etdcodigo'
      '        , clbcodigo'
      '        , fopcodigo'
      '        , tdecodigo'
      '        , stocodigo'
      '        , moccodigo'
      '        , foacodigo'
      '        , trmcodigo'
      '        , tfpcodigo'
      '        , puocodigo'
      '        , orcdataabert'
      '        , orchoraabert'
      '        , orcgeralav'
      '        , orcdescontoav'
      '        , orcpercdescav'
      '        , orctotalav'
      '        , orcgeralap'
      '        , orcdescontoap'
      '        , orcpercdescap'
      '        , orctotalap'
      '        , orcobs'
      '        , orcdestimpre'
      '        , edritem'
      '        , edrcodigo'
      '        , clbvendedor'
      '        , orcmesa'
      '        , orctelefone'
      '        , ccxchave'
      '        , cznchave'
      '        , oricodigo)'
      '          SELECT'
      '            @novachave,'
      '            etdcodigo,'
      '            pClbCodigo,'
      '            fopcodigo,'
      '            tdecodigo,'
      '            3,'
      '            moccodigo,'
      '            foacodigo,'
      '            trmcodigo,'
      '            tfpcodigo,'
      '            puocodigo,'
      '            orcdataabert,'
      '            TIME(NOW()),'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            pLteDesconto,'
      '            @percdesc,'
      
        '            (pLtePrincipal + pLteJuros + pLteMulta) - pLteDescon' +
        'to,'
      '            orcobs,'
      '            orcdestimpre,'
      '            edritem,'
      '            edrcodigo,'
      '            pClbCodigo,'
      '            orcmesa,'
      '            orctelefone,'
      '            ccxchave,'
      '            cznchave,'
      '            6'
      '          FROM orc'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '        IF (ROW_COUNT() > 0) THEN'
      ''
      '          SET @orcchave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      ''
      '          SET ErroMensagem = 2;'
      ''
      ''
      ''
      '          SET @troqtd = 0;'
      ''
      ''
      '          SET @troqtd = (SELECT DISTINCT'
      '              COUNT(orcchaveorigem)'
      '            FROM tro'
      '            WHERE orcchaveorigem = pOrcChave'
      '            AND orcchavedestino = @orcchave);'
      ''
      ''
      ''
      ''
      '          IF @troqtd = 0 THEN'
      ''
      ''
      ''
      '            SET @orcchaveinicial = IFNULL((SELECT'
      '                orcchaveorigem'
      '              FROM tro'
      '              WHERE orcchavedestino = pOrcChave'
      '              ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '            INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '              VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE ' +
        'KEY UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = ' +
        '@orcchave;'
      ''
      ''
      '          END IF;'
      ''
      ''
      ''
      ''
      ''
      '          SET @item = 0;'
      ''
      ''
      '          WHILE (@ContaItem <= @qtdItem) DO'
      ''
      '            SET @item = @item + 1;'
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 3;'
      ''
      ''
      ''
      ''
      '            SELECT'
      '              titem.itochave,'
      '              qtde'
      '            FROM titem'
      '            WHERE titem.ID = @ContaItem INTO @itochave'
      '            , @qtde;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 4;'
      ''
      ''
      ''
      ''
      '            INSERT INTO ito (itochave'
      '            , orcchave'
      '            , procodigo'
      '            , puncodigo'
      '            , unicodigo'
      '            , stocodigo'
      '            , tdecodigo'
      '            , itoquantidade'
      '            , itovalorav'
      '            , itototalav'
      '            , itodescontoav'
      '            , itosaldoav'
      '            , itovalorap'
      '            , itototalap'
      '            , itodescontoap'
      '            , itosaldoap'
      '            , itocontendo'
      '            , itoproservico'
      '            , itoprocomple'
      '            , itodataalter'
      '            , itoitem'
      '            , itogint'
      '            , itopercdescap'
      '            , itopercdescav'
      '            , itoinfadprod'
      '            , itoquanticondi'
      '            , itoquantidevolcondi'
      '            , vrpcodigo'
      '            , itoobs'
      '            , itoacrescimoav'
      '            , clbatendente'
      '            , oricodigo'
      '            , itooutras)'
      '              SELECT'
      '                @novoito,'
      '                @orcchave,'
      '                ito.procodigo,'
      '                puncodigo,'
      '                unicodigo,'
      '                3,'
      '                tdecodigo,'
      '                @qtde,'
      '                itovalorav + itoacrescimoav,'
      
        '                (@qtde * (itovalorav + itoacrescimoav + itooutra' +
        's)),'
      
        '                ROUND(((itovalorav + itoacrescimoav + itooutras)' +
        ' * @percdesc) * @qtde, 2),'
      
        '                (((itovalorav + itoacrescimoav + itooutras) * @q' +
        'tde) - (ROUND(((itovalorav + itoacrescimoav + itooutras) * @perc' +
        'desc) * @qtde, 2))),'
      '                itovalorap,'
      '                (@qtde * itovalorap),'
      '                ROUND((itototalap * @percdesc), 2),'
      '                (itototalap - itodescontoap),'
      '                itocontendo,'
      '                itoproservico,'
      '                itoprocomple,'
      '                CURRENT_DATE(),'
      '                @item,'
      '                itogint,'
      '                ROUND(@percdesc, 3),'
      '                ROUND(@percdesc, 3),'
      '                itoinfadprod,'
      '                itoquanticondi,'
      '                itoquantidevolcondi,'
      '                vrpcodigo,'
      '                itoobs,'
      '                itoacrescimoav,'
      '                clbatendente,'
      '                6,'
      '                itooutras'
      '              FROM ito'
      '              WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      '            SET @immitochave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      ''
      ''
      ''
      '            INSERT INTO imm (immchave,'
      '            itochave,'
      '            tcicodigo,'
      '            immimpresso,'
      '            immentregue,'
      '            immmodo,'
      '            ccxchave,'
      '            immhorapedido,'
      '            immhoraentrega,'
      '            immrecebido,'
      '            dorchave,'
      '            immnumepedido,'
      '            trmcodigo,'
      '            immdestino,'
      '            immidentificacao,'
      '            immgarsom,'
      '            immtemporetardo,'
      '            immmodoimpressao,'
      '            cznchave,'
      '            etdcodigoent,'
      '            immpratos,'
      '            immcopos,'
      '            immnumepedidoint,'
      '            clbcodigo,'
      '            immhoraimpresso,'
      '            immhoraimprimir,'
      '            immhoraentregadopedido,'
      '            immhoranotificadopedido,'
      '            immhorasaidadopedido)'
      '              SELECT'
      '                @novaimmchave,'
      '                @immitochave,'
      '                tcicodigo,'
      '                immimpresso,'
      '                immentregue,'
      '                immmodo,'
      '                ccxchave,'
      '                immhorapedido,'
      '                immhoraentrega,'
      '                immrecebido,'
      '                dorchave,'
      '                immnumepedido,'
      '                trmcodigo,'
      '                immdestino,'
      '                immidentificacao,'
      '                immgarsom,'
      '                immtemporetardo,'
      '                immmodoimpressao,'
      '                cznchave,'
      '                etdcodigoent,'
      '                immpratos,'
      '                immcopos,'
      '                immnumepedidoint,'
      '                clbcodigo,'
      '                immhoraimpresso,'
      '                immhoraimprimir,'
      '                immhoraentregadopedido,'
      '                immhoranotificadopedido,'
      '                immhorasaidadopedido'
      '              FROM imm'
      '              WHERE itochave = @itochave;'
      ''
      '            UPDATE imp'
      '            SET itochave = @immitochave'
      '            WHERE imp.itochave = @itochave;'
      ''
      ''
      ''
      '            SELECT'
      '              COUNT(itochave)'
      '            FROM sbi'
      '            WHERE sbi.itochave = @itochave INTO @qtdItemSbi;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItemsbi = 1;'
      ''
      ''
      ''
      '            WHILE (@ContaItemsbi <= @qtdItemSbi) DO'
      ''
      ''
      '              INSERT INTO sbi'
      '                (SELECT'
      '                  @outrachave,'
      '                  @immitochave,'
      '                  sbrcodigo,'
      '                  sbiobs,'
      '                  sbiitem,'
      '                  bprchave'
      '                FROM sbi'
      '                WHERE itochave = @itochave'
      '                AND sbi.sbiitem = @ContaItemsbi);'
      ''
      ''
      ''
      '              IF (SELECT'
      '                    ROW_COUNT()) > 0 THEN'
      '                SET @ultimosbichave = (SELECT'
      '                    LAST_INSERT_ID());'
      '              END IF;'
      ''
      ''
      ''
      ''
      '              SELECT'
      '                COUNT(itochave)'
      '              FROM isi'
      '              WHERE itochave = @itochave'
      '              AND isiitem = @ContaItemsbi INTO @qtdItemisi;'
      ''
      ''
      ''
      ''
      '              IF @qtdItemisi > 0 THEN'
      ''
      ''
      '                INSERT INTO isi'
      '                  (SELECT'
      '                    @novaisichave,'
      '                    @ultimosbichave,'
      '                    tsicodigo,'
      '                    procodigo,'
      '                    isitipo,'
      '                    @immitochave,'
      '                    isiitem,'
      '                    isiquantidade,'
      '                    0'
      '                  FROM isi'
      '                  WHERE itochave = @itochave'
      '                  AND isiitem = @ContaItemsbi);'
      ''
      '              END IF;'
      ''
      ''
      ''
      '              SET @ContaItemsbi = @ContaItemsbi + 1;'
      ''
      ''
      '            END WHILE;'
      ''
      ''
      ''
      ''
      ''
      '            SET ErroMensagem = 5;'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '            UPDATE ito'
      '            SET ito.itoquantidade = (ito.itoquantidade - @qtde),'
      
        '                ito.itototalav = (ito.itoquantidade * ito.itoval' +
        'orav),'
      
        '                ito.itosaldoav = (ito.itototalav - itodescontoav' +
        '),'
      
        '                ito.itototalap = (ito.itoquantidade * ito.itoval' +
        'orap),'
      '                ito.itosaldoap = (itototalap - itodescontoap)'
      '            WHERE ito.itochave = @itochave;'
      ''
      ''
      ''
      ''
      ''
      '            SET @ContaItem = @ContaItem + 1;'
      ''
      ''
      '          END WHILE;'
      ''
      '          SET ErroMensagem = 6;'
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      '              orc.orcdescontoav = tito.descav,'
      
        '              orc.orcpercdescav = IF(tito.descav > 0, (tito.desc' +
        'av / tito.totav), 0),'
      '              orc.orctotalav = (tito.totav - tito.descav),'
      '              orc.orcgeralap = tito.totap,'
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = @orcchave;'
      ''
      ''
      ''
      '          SET ErroMensagem = 7;'
      ''
      ''
      ''
      '          UPDATE orc'
      '          INNER JOIN (SELECT'
      '              ito.orcchave,'
      '              SUM(itototalav) totav,'
      '              SUM(itodescontoav) descav,'
      '              SUM(itototalap) totap,'
      '              SUM(itodescontoap) descap'
      '            FROM ito'
      '            WHERE stocodigo != 88'
      '            GROUP BY ito.orcchave) tito'
      '            ON tito.orcchave = orc.orcchave'
      '          SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '              orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '              orc.orcdescontoav = tito.descap,'
      
        '              orc.orcpercdescav = IF(tito.descap > 0, (tito.desc' +
        'ap / tito.totap), 0),'
      '              orc.orctotalap = (tito.totap - tito.descap)'
      '          WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      '        SET ErroMensagem = 8;'
      ''
      ''
      
        '        CALL RegistraMes(@orcchave, pClbCodigo, ErroMensagem, pC' +
        'onfirma, pMensagem, @meschave);'
      ''
      '        SET ErroMensagem = 10;'
      ''
      '        SET @troqtd = 0;'
      ''
      '        SET @troqtd = (SELECT DISTINCT'
      '            COUNT(orcchaveorigem)'
      '          FROM tro'
      '          WHERE orcchaveorigem = pOrcChave'
      '          AND orcchavedestino = @orcchave);'
      ''
      '        IF @troqtd = 0 THEN'
      ''
      '          SET @orcchaveinicial = IFNULL((SELECT'
      '              orcchaveorigem'
      '            FROM tro'
      '            WHERE orcchavedestino = pOrcChave'
      '            ORDER BY trochave DESC LIMIT 1), pOrcChave);'
      ''
      ''
      '          INSERT INTO tro (orcchaveorigem, orcchavedestino)'
      
        '            VALUES (@orcchaveinicial, @orcchave) ON DUPLICATE KE' +
        'Y UPDATE orcchaveorigem = @orcchaveinicial, orcchavedestino = @o' +
        'rcchave;'
      ''
      ''
      '        END IF;'
      ''
      ''
      ''
      ''
      ''
      '      END IF;'
      ''
      ''
      '      SET ErroMensagem = 11;'
      ''
      '      IF (@qtdItem > 0) THEN'
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, @OrcChave, @ltechave, pNome, 1);'
      '      ELSE'
      ''
      '        INSERT INTO olt (oltchave'
      '        , orcchave'
      '        , ltechave'
      '        , oltidentificacao'
      '        , olttipo)'
      '          VALUE (@novachave, pOrcChave, @ltechave, pNome, 0);'
      '      END IF;'
      ''
      ''
      ''
      '      IF (@qtdItem > 0)'
      '        AND (@orcchave > 0) THEN'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = @orcchave'
      '          AND dtl.mdacodigo != 7);'
      ''
      ''
      '        IF @VlrFechamento > 0 THEN'
      ''
      ''
      '          SET @etdcodigo = (SELECT'
      '              etdcodigo'
      '            FROM orc'
      '            WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      '          SET ErroMensagem = 15;'
      ''
      ''
      '          OPEN curlote;'
      '        read_loop:'
      '          LOOP'
      ''
      '            FETCH curlote INTO lote, modalidade;'
      ''
      ''
      '            IF done THEN'
      ''
      '              LEAVE read_loop;'
      '            END IF;'
      ''
      ''
      '            SET @VlrFechamento = (SELECT'
      '                SUM(dtl.dtlvalor) dtlvalor'
      '              FROM dtl'
      '                INNER JOIN olt'
      '                  ON dtl.ltechave = olt.ltechave'
      '              WHERE olt.orcchave = @orcchave'
      '              AND dtl.ltechave = lote'
      '              AND dtl.mdacodigo = modalidade'
      '              AND dtl.mdacodigo != 7);'
      ''
      '            DELETE'
      '              FROM trfi'
      '            WHERE mdacodigo <> modalidade;'
      ''
      '            INSERT INTO trfi (ID'
      '            , etdcodigo'
      '            , mdacodigo'
      '            , tfdcodigo'
      '            , numparc'
      '            , dtvecto'
      '            , vlrparcela'
      '            , numero)'
      
        '              VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_' +
        'DATE(), @VlrFechamento, @meschave);'
      ''
      ''
      ''
      '            SET ErroMensagem = 16;'
      ''
      
        '            CALL RegistraTitulo(pFlaCodigo, @ltechave, 1, ErroMe' +
        'nsagem, @TitCodigo);'
      ''
      '            SET ErroMensagem = 9;'
      ''
      '          END LOOP;'
      ''
      '          CLOSE curlote;'
      '        END IF;'
      ''
      ''
      '        INSERT INTO rfm (rfmchave'
      '        , rfichave'
      '        , meschave)'
      ''
      '          (SELECT DISTINCT'
      '            @novachave,'
      '            rfichave,'
      '            @MesChave'
      '          FROM olt'
      '            INNER JOIN mlt'
      '              ON olt.ltechave = mlt.ltechave'
      '            INNER JOIN mfi'
      '              ON mlt.mfichave = mfi.mfichave'
      '          WHERE olt.orcchave = @OrcChave);'
      ''
      '      END IF;'
      ''
      ''
      ''
      ' ELSE   -- recebimento parcial'
      ''
      '      SET ErroMensagem = 13;'
      ''
      '      INSERT INTO olt (oltchave'
      '      , orcchave'
      '      , ltechave'
      '      , oltidentificacao'
      '      , olttipo)'
      
        '        VALUE (@novachave, @orcchave, @ltechave, pNome, pTipoFec' +
        'hamento);'
      ''
      '      SET @LteDesconto = IFNULL((SELECT'
      '          SUM(lte.ltedesconto)'
      '        FROM olt'
      '          INNER JOIN lte'
      '            ON olt.ltechave = lte.ltechave'
      '        WHERE olt.orcchave = pOrcChave), 0);'
      ''
      '      SET @OrcTotalAv = (SELECT'
      '          SUM(itovalorav * itoquantidade) totav'
      '        FROM ito'
      '        WHERE orcchave = pOrcChave);'
      ''
      '      IF @LteDesconto > 0 THEN'
      '        SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      '        UPDATE ito'
      '        SET itodescontoav = ROUND((itototalav * @percdesc), 2),'
      '            itosaldoav = (ito.itototalav - itodescontoav),'
      '            itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '            itosaldoap = (ito.itototalav - itodescontoav),'
      '            itopercdescap = ROUND(@percdesc, 3),'
      '            itopercdescav = ROUND(@percdesc, 3)'
      '        WHERE ito.orcchave = pOrcChave;'
      ''
      '        SET @centavos = @LteDesconto - (SELECT'
      '            SUM(itodescontoav)'
      '          FROM ito'
      '          WHERE ito.orcchave = pOrcChave);'
      ''
      '        IF @centavos <> 0 THEN'
      ''
      '          UPDATE ito'
      '          SET itodescontoav = itodescontoav + @centavos,'
      '              itodescontoap = itodescontoap + @centavos,'
      '              itosaldoav = itosaldoav + @centavos,'
      '              itosaldoap = itosaldoap + @centavos'
      '          WHERE ito.orcchave = pOrcChave;'
      ''
      '        END IF;'
      ''
      '        UPDATE orc'
      '        INNER JOIN (SELECT'
      '            ito.orcchave,'
      '            SUM(itototalav) totav,'
      '            SUM(itodescontoav) descav,'
      '            SUM(itototalap) totap,'
      '            SUM(itodescontoap) descap'
      '          FROM ito'
      '          WHERE stocodigo != 88'
      '          GROUP BY ito.orcchave) tito'
      '          ON tito.orcchave = orc.orcchave'
      '        SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '            orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '            orc.orcdescontoav = tito.descap,'
      
        '            orc.orcpercdescav = IF(tito.descap > 0, (tito.descap' +
        ' / tito.totap), 0),'
      '            orc.orctotalap = (tito.totap - tito.descap)'
      '        WHERE orc.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      '      SET ErroMensagem = 12;'
      ''
      ' '
      '      SET ErroMensagem = 18;'
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      '          orc.orcpercdescav = @percdesc,'
      '          orc.orctotalap = (tito.totap - tito.descap),'
      '          orc.orcdataencerr = CURRENT_DATE(),'
      '          orc.orchoraencerr = CURRENT_TIME(),'
      '          orc.stocodigo = 3'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      ''
      ''
      '      UPDATE ito'
      '      SET ito.stocodigo = 3'
      '      WHERE ito.orcchave = pOrcChave'
      '      AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '    END IF;'
      ''
      '  END IF;'
      ''
      ''
      ''
      '  IF @meschave > 0 THEN'
      '    SET pMesChave = @meschave;'
      '  ELSE'
      '    SET pMesChave = 0;'
      '  END IF;'
      ''
      ''
      '  SET pConfirma = ErroException;'
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      'END //'
      ''
      ''
      '--'
      '-- Alter procedure "ProcessaLote"'
      '--'
      'DROP PROCEDURE ProcessaLote//'
      'CREATE PROCEDURE ProcessaLote(IN pFlaCodigo int'
      ', IN pTtfCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pLteTipoTaxa int'
      ', IN pLteValorTaxa double(16, 02)'
      ''
      ', OUT pConfirma int'
      ', OUT pLteChave int'
      ', OUT pMensagem varchar(65000))'
      'BEGIN'
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  SET ErroMensagem = 1;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      ''
      '  SET ErroMensagem = 2;'
      ''
      ''
      '  INSERT INTO lte (ltechave'
      '  , flacodigo'
      '  , tfdcodigo'
      '  , ltedata'
      '  , lteprincipal'
      '  , ltejuros'
      '  , ltedesconto'
      '  , ltetotal'
      '  , lteextenso'
      '  , ltehistorico'
      '  , ltemulta'
      '  , ltesituacao'
      '  , clbcodigo'
      '  , ctacodigo'
      '  , lteregistro'
      '  , ltetroco'
      '  , ltetipotaxa'
      '  , ltevalortaxa)'
      
        '    VALUES (@novachave, pFlaCodigo, pTtfCodigo, CURRENT_DATE(), ' +
        'pLtePrincipal, pLteJuros, pLteDesconto, (pLtePrincipal + pLteJur' +
        'os + pLteMulta) - pLteDesconto, '#39#39', '#39#39', pLteMulta, 0, pClbCodigo' +
        ', pCtaCodigo, NOW(), pLteTroco, pLteTipoTaxa, pLteValorTaxa);'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pLteChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    SET ErroMensagem = 3;'
      ''
      '    SET @dtlcont = 1;'
      '    SET @dtlqtde = (SELECT'
      '        COUNT(*)'
      '      FROM tdtl);'
      '    SET @VlrBaixa = 0;'
      ''
      '    WHILE (@dtlcont <= @dtlqtde) DO'
      ''
      '      INSERT INTO dtl (dtlchave'
      '      , ltechave'
      '      , cedcodigo'
      '      , dtlvalor'
      '      , mdacodigo'
      '      , flacodigo'
      '      , ccxchave'
      '      , dtlregistro)'
      '        (SELECT'
      '          @novachave,'
      '          pLteChave,'
      '          1,'
      '          @dtlValor := dtlvalor,'
      '          @mdacodigo := mdacodigo,'
      '          pFlaCodigo,'
      '          ccxchave,'
      '          dtlregistro'
      '        FROM tdtl'
      '        WHERE ID = @dtlcont);'
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        SET @dtlchave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      ''
      '        IF (@mdacodigo = 1) THEN'
      '          SET ErroMensagem = 4;'
      
        '          CALL RegistraCCO(pLteChave, pCtaCodigo, pClbCodigo, 1,' +
        ' '#39'Receb. em Dinheiro'#39', @dtlValor, ErroMensagem, @CcoChave);'
      '        END IF;'
      ''
      '        IF (@mdacodigo = 6) THEN'
      '          SET ErroMensagem = 4;'
      '          CALL RegistraCCO(pLteChave, (SELECT'
      '              cfgctacodigopix'
      
        '            FROM cfg), pClbCodigo, 1, '#39'Receb. em PIX'#39', @dtlValor' +
        ', ErroMensagem, @CcoChave);'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo = 3) THEN'
      '          SET ErroMensagem = 5;'
      
        '          CALL RegistraCheque(@dtlchave, ErroMensagem, @confirma' +
        ');'
      '          IF @confirma = 0 THEN'
      '            SET ErroMensagem = 6;'
      
        '            CALL RegistraCCO(pLteChave, pCtaCodigo, pClbCodigo, ' +
        '1, '#39'Receb. em Cheque'#39', @dtlValor, ErroMensagem, @CcoChave);'
      ''
      '          END IF;'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo IN (4, 5)) THEN'
      '          SET ErroMensagem = 7;'
      
        '          CALL  RegistraCartaoCCO(pLteChave,  pClbCodigo, 1, '#39'Re' +
        'ceb. em Cart'#227'o'#39',@dtlchave, @dtlValor, ErroMensagem, @CcoChave);'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo = 7) THEN'
      '          SET ErroMensagem = 9;'
      
        '          CALL RegistraTitulo(pFlaCodigo, pLteChave, @mdacodigo,' +
        ' ErroMensagem, @TitCodigo);'
      '        END IF;'
      ''
      '      END IF;'
      '      SET @dtlcont = @dtlcont + 1;'
      ''
      '    END WHILE;'
      ''
      '  END IF;'
      '  SET pConfirma = ErroException;'
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      'END //'
      '')
    Left = 192
    Top = 648
  end
  object us001311: TUniScript
    SQL.Strings = (
      'SET NAMES '#39'utf8'#39'//'
      ''
      '--'
      '-- Alter procedure "FechaMesa"'
      '--'
      'DROP PROCEDURE FechaMesa//'
      'CREATE PROCEDURE FechaMesa(IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      '  -- daniel 02/01/2025 10:40'
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '    SELECT'
      '      dtl.ltechave,'
      '      dtl.mdacodigo'
      '    FROM dtl'
      '      INNER JOIN olt'
      '        ON dtl.ltechave = olt.ltechave'
      '    WHERE olt.orcchave = pOrcChave'
      '    /* AND dtl.mdacodigo != 7 */;'
      '    DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '      SET done = TRUE;'
      '  END;'
      '  '
      '  '
      '  set @vlClbCodigo = pClbCodigo;'
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      '    SET ErroMensagem = 13;'
      ''
      ''
      ''
      '    INSERT INTO olt (oltchave'
      '    , orcchave'
      '    , ltechave'
      '    , oltidentificacao'
      '    , olttipo)'
      
        '      VALUE (@novachave, pOrcChave, @ltechave, pNome, pTipoFecha' +
        'mento);'
      ''
      ''
      '    SET @LteDesconto = IFNULL((SELECT'
      '        SUM(lte.ltedesconto)'
      '      FROM olt'
      '        INNER JOIN lte'
      '          ON olt.ltechave = lte.ltechave'
      '      WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '    SET @OrcTotalAv = (SELECT'
      '        SUM(itovalorav * itoquantidade) totav'
      '      FROM ito,'
      '           pro'
      '      WHERE ito.procodigo = pro.procodigo'
      '      AND ito.stocodigo <> 88'
      '      AND pro.tpocodigo = 0'
      '      AND orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    IF @LteDesconto > 0 THEN'
      '      SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      '      UPDATE ito, pro'
      
        '      SET itodescontoav = ROUND(((itototalav + itoacrescimoav + ' +
        'itooutras) * @percdesc), 2),'
      '          itosaldoav = (ito.itototalav - itodescontoav),'
      '          itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '          itosaldoap = (ito.itototalav - itodescontoav),'
      '          itopercdescap = ROUND(@percdesc, 3),'
      '          itopercdescav = ROUND(@percdesc, 3)'
      '      WHERE ito.stocodigo <> 88'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo = 0'
      '      AND ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '      SET @centavos = @LteDesconto - (SELECT'
      '          SUM(itodescontoav)'
      '        FROM ito,'
      '             pro'
      '        WHERE ito.orcchave = pOrcChave'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0);'
      ''
      ''
      ''
      ''
      '      IF @centavos <> 0 THEN'
      ''
      '        UPDATE ito, pro'
      '        SET itodescontoav = itodescontoav + @centavos,'
      '            itodescontoap = itodescontoap + @centavos,'
      '            itosaldoav = itosaldoav + @centavos,'
      '            itosaldoap = itosaldoap + @centavos'
      '        WHERE ito.stocodigo <> 88'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0'
      '        AND ito.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      
        '          orc.orcpercdescav = IF(tito.descap > 0, (tito.descap /' +
        ' tito.totap), 0),'
      '          orc.orctotalap = (tito.totap - tito.descap)'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      '    END IF;'
      ''
      ''
      '    SET ErroMensagem = 12;'
      ''
      ''
      
        '    CALL RegistraMes(pOrcChave,  @vlClbCodigo, ErroMensagem, pCo' +
        'nfirma, pMensagem, @meschave);'
      ''
      ''
      '    SET ErroMensagem = 14;'
      ''
      ''
      '    SET @VlrFechamento = (SELECT'
      '        SUM(dtl.dtlvalor) dtlvalor'
      '      FROM dtl'
      '        INNER JOIN olt'
      '          ON dtl.ltechave = olt.ltechave'
      '      WHERE olt.orcchave = pOrcChave);'
      ''
      ''
      '     SET @vlLtechave = (SELECT'
      '          ltechave'
      '      FROM olt        '
      
        '      WHERE olt.orcchave = pOrcChave ORDER by ltechave DESC LIMI' +
        'T 1);'
      ''
      ''
      '    IF @VlrFechamento > 0 THEN'
      ''
      '      SET @etdcodigo = (SELECT'
      '          etdcodigo'
      '        FROM orc'
      '        WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '      SET ErroMensagem = 15;'
      ''
      '      INSERT INTO trfi (ID'
      '      , etdcodigo'
      '      , mdacodigo'
      '      , tfdcodigo'
      '      , numparc'
      '      , dtvecto'
      '      , vlrparcela'
      '      , numero)'
      
        '        VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE()' +
        ', @VlrFechamento, @meschave);'
      ''
      '      SET ErroMensagem = 16;'
      ''
      
        '      CALL RegistraTituloVenda(pFlaCodigo,  @vlLtechave, 1, Erro' +
        'Mensagem, @TitCodigo);'
      ''
      '      DELETE FROM trfi WHERE numero= @meschave;'
      ''
      '      INSERT INTO rfm (rfichave, meschave)'
      '        (SELECT DISTINCT'
      '          rfichave,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = pOrcChave);'
      ''
      '      SET ErroMensagem = 17;'
      ''
      '      OPEN curlote; '
      '    read_loop:'
      '      LOOP'
      ''
      '        FETCH curlote INTO lote, modalidade;'
      ''
      '        IF done THEN'
      '          LEAVE read_loop;'
      '        END IF;'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade  );'
      ''
      '         SET @vlLtechave = (SELECT'
      '            dtl.ltechave'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade );'
      ''
      '        DELETE'
      '          FROM trfi'
      '        WHERE mdacodigo <> modalidade;'
      ''
      '        IF modalidade=7 AND lote<>0 then '
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '          VALUES (@novachave, @etdcodigo, 1, 2, 1, CURRENT_DATE(' +
        '), @VlrFechamento, @meschave);'
      ''
      '          SET ErroMensagem = 16;'
      '          SET @rtitcodigo=0;'
      '  '
      '        END IF; '
      ''
      '      END LOOP;'
      ''
      '      CLOSE curlote;'
      ''
      '     '
      '    END IF;'
      ''
      '    SET ErroMensagem = 18;'
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '        orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        orc.orcdataencerr = CURRENT_DATE(),'
      '        orc.orchoraencerr = CURRENT_TIME(),'
      '        orc.stocodigo = 3'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      '    UPDATE ito'
      '    SET ito.stocodigo = 3'
      '    WHERE ito.orcchave = pOrcChave'
      '    AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF @meschave > 0 THEN'
      '    SET pMesChave = @meschave;'
      '  ELSE'
      '    SET pMesChave = 0;'
      '  END IF;'
      ''
      '  SET pConfirma = ErroException;'
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      'END //'
      ''
      ''
      '--'
      '-- Alter procedure "ProcessaLote"'
      '--'
      'DROP PROCEDURE ProcessaLote//'
      'CREATE PROCEDURE ProcessaLote(IN pFlaCodigo int'
      ', IN pTtfCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pLteTipoTaxa int'
      ', IN pLteValorTaxa double(16, 02)'
      ''
      ', OUT pConfirma int'
      ', OUT pLteChave int'
      ', OUT pMensagem varchar(65000))'
      'BEGIN'
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  SET ErroMensagem = 1;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      ''
      '  SET ErroMensagem = 2;'
      ''
      ''
      '  INSERT INTO lte (ltechave'
      '  , flacodigo'
      '  , tfdcodigo'
      '  , ltedata'
      '  , lteprincipal'
      '  , ltejuros'
      '  , ltedesconto'
      '  , ltetotal'
      '  , lteextenso'
      '  , ltehistorico'
      '  , ltemulta'
      '  , ltesituacao'
      '  , clbcodigo'
      '  , ctacodigo'
      '  , lteregistro'
      '  , ltetroco'
      '  , ltetipotaxa'
      '  , ltevalortaxa)'
      
        '    VALUES (@novachave, pFlaCodigo, pTtfCodigo, CURRENT_DATE(), ' +
        'pLtePrincipal, pLteJuros, pLteDesconto, (pLtePrincipal + pLteJur' +
        'os + pLteMulta) - pLteDesconto, '#39#39', '#39#39', pLteMulta, 0, pClbCodigo' +
        ', pCtaCodigo, NOW(), pLteTroco, pLteTipoTaxa, pLteValorTaxa);'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pLteChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    SET ErroMensagem = 3;'
      ''
      '    SET @dtlcont = 1;'
      '    SET @dtlqtde = (SELECT'
      '        COUNT(*)'
      '      FROM tdtl);'
      '    SET @VlrBaixa = 0;'
      ''
      '    WHILE (@dtlcont <= @dtlqtde) DO'
      ''
      '      INSERT INTO dtl (dtlchave'
      '      , ltechave'
      '      , cedcodigo'
      '      , dtlvalor'
      '      , mdacodigo'
      '      , flacodigo'
      '      , ccxchave'
      '      , dtlregistro)'
      '        (SELECT'
      '          @novachave,'
      '          pLteChave,'
      '          1,'
      '          @dtlValor := dtlvalor,'
      '          @mdacodigo := mdacodigo,'
      '          pFlaCodigo,'
      '          ccxchave,'
      '          dtlregistro'
      '        FROM tdtl'
      '        WHERE ID = @dtlcont);'
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        SET @dtlchave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      ''
      '        IF (@mdacodigo = 1) THEN'
      '          SET ErroMensagem = 4;'
      
        '          CALL RegistraCCO(pLteChave, pCtaCodigo, pClbCodigo, 1,' +
        ' '#39'Receb. em Dinheiro'#39', @dtlValor, ErroMensagem, @CcoChave);'
      '        END IF;'
      ''
      '        IF (@mdacodigo = 6) THEN'
      '          SET ErroMensagem = 4;'
      '          CALL RegistraCCO(pLteChave, (SELECT'
      '              cfgctacodigopix'
      
        '            FROM cfg), pClbCodigo, 1, '#39'Receb. em PIX'#39', @dtlValor' +
        ', ErroMensagem, @CcoChave);'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo = 3) THEN'
      '          SET ErroMensagem = 5;'
      
        '          CALL RegistraCheque(@dtlchave, ErroMensagem, @confirma' +
        ');'
      '          IF @confirma = 0 THEN'
      '            SET ErroMensagem = 6;'
      
        '            CALL RegistraCCO(pLteChave, pCtaCodigo, pClbCodigo, ' +
        '1, '#39'Receb. em Cheque'#39', @dtlValor, ErroMensagem, @CcoChave);'
      ''
      '          END IF;'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo IN (4, 5)) THEN'
      '          SET ErroMensagem = 7;'
      
        '          CALL  RegistraCartaoCCO(pLteChave,  pClbCodigo, 1, '#39'Re' +
        'ceb. em Cart'#227'o'#39',@dtlchave, @dtlValor, ErroMensagem, @CcoChave);'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo = 7) THEN'
      '          SET ErroMensagem = 9;'
      
        '          CALL RegistraTitulo(pFlaCodigo, pLteChave, @mdacodigo,' +
        ' ErroMensagem, @TitCodigo);'
      '        END IF;'
      ''
      '      END IF;'
      '      SET @dtlcont = @dtlcont + 1;'
      ''
      '    END WHILE;'
      ''
      '  END IF;'
      '  SET pConfirma = ErroException;'
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      'END //'
      ''
      ''
      '--'
      '-- Alter procedure "RegistraFinanceiro"'
      '--'
      'DROP PROCEDURE RegistraFinanceiro//'
      'CREATE PROCEDURE RegistraFinanceiro(IN pFlaCodigo int'
      ', IN pLteChave int'
      ', IN pMdaCodigo int'
      ', IN pChamada int'
      ', in pTitCodigo int'
      ', OUT rTitCodigo int)'
      'BEGIN'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      '  DELETE'
      '    FROM terro;'
      ''
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao incluir Titulo'#39');'
      ''
      ''
      '  SELECT'
      '    etdcodigo,'
      '    tfdcodigo,'
      '    dtvecto'
      '  FROM trfi'
      '  ORDER BY dtvecto DESC LIMIT 1 INTO @etdcodigo'
      '  , @tfdcodigo'
      '  , @dtvenctoInicial;'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      ''
      '  SET @rdcnrauto = IFNULL((SELECT'
      '      rdc.rdcnrauto'
      '    FROM lte,'
      '         dtl,'
      '         ltr,'
      '         rdc'
      '    WHERE dtl.dtlchave = ltr.dtlchave'
      '    AND lte.ltechave = dtl.ltechave'
      '    AND ltr.rdcchave = rdc.rdcchave'
      '    AND dtl.mdacodigo = pMdaCodigo'
      '    AND lte.ltechave = pLteChave), '#39#39');'
      ''
      ''
      '  SET @vlrtitulo = (SELECT'
      '      SUM(vlrparcela)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @ContaParcela = (SELECT'
      '      MIN(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @QtdParcela = (SELECT'
      '      MAX(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @totparcela = (SELECT'
      '      COUNT(*)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @numparcela = 0;'
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao Gerar Parcelas'#39
      '    WHERE Chamada = pChamada;'
      ''
      ''
      '    WHILE (@ContaParcela <= @QtdParcela) DO'
      '      IF pMdaCodigo = IFNULL((SELECT'
      '            mdacodigo'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela), 0) THEN'
      '        SET @numparcela = @numparcela + 1;'
      '        INSERT INTO rfi (rfichave'
      '        , titcodigo'
      '        , etdcodigo'
      '        , tfdcodigo'
      '        , flacodigo'
      '        , tficodigo'
      '        , bcocodigo'
      '        , carcodigo'
      '        , rfiemissao'
      '        , rfivencimento'
      '        , rfinumero'
      '        , rfivalor'
      '        , rfihistorico'
      '        , srfcodigo'
      '        , frrcodigo'
      '        , rfivalorparcela'
      '        , moecodigo'
      '        , rdcnrauto)'
      '          SELECT'
      '            @novachave,'
      '            pTitCodigo,'
      '            trfi.etdcodigo,'
      '            @tfdcodigo := trfi.tfdcodigo,'
      '            pFlaCodigo,'
      '            IF(trfi.tfdcodigo = 2, 10, 9),'
      '            '#39'000'#39','
      '            1,'
      '            CURRENT_DATE(),'
      '            trfi.dtvecto,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), '#39#39'), trfi.numparc, '#39'/'#39', @totparcela),'
      '            @vlrParcela := trfi.vlrparcela,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), CONCAT(pTitCodigo, '#39' - '#39')), trfi.numparc, '#39'/'#39', @totpa' +
        'rcela),'
      '            IF(trfi.tfdcodigo = 2, 0, 2),'
      '            999,'
      '            trfi.vlrparcela,'
      '            1,'
      '            @rdcnrauto'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela;'
      ''
      ''
      '        IF ROW_COUNT() > 0 THEN'
      '          SET @rficodigo = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      '          UPDATE terro'
      
        '          SET Mensagem = '#39'Erro ao gerar movimento inicial da par' +
        'cela'#39
      '          WHERE Chamada = pChamada;'
      ''
      ''
      '          INSERT INTO mfi (mfichave'
      '          , rfichave'
      '          , tmfcodigo'
      '          , moecodigo'
      '          , mfivalor'
      '          , mfidata)'
      
        '            VALUES (@novachave, @rficodigo, 2, 1, @vlrParcela, C' +
        'URRENT_DATE());'
      ''
      ''
      '          IF ROW_COUNT() > 0 THEN'
      '            SET @mfichave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar ligacao entre moviment' +
        'o e parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      ''
      '            INSERT INTO mlt (mltchave'
      '            , mfichave'
      '            , ltechave)'
      '              VALUES (@novachave, @mfichave, pLteChave);'
      ''
      '          END IF;'
      ''
      ''
      '          IF @tfdcodigo = 32 THEN'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar movimento de recebimen' +
        'to da parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      '            INSERT INTO mfi (mfichave'
      '            , rfichave'
      '            , tmfcodigo'
      '            , moecodigo'
      '            , mfivalor'
      '            , mfidata)'
      
        '              VALUES (@novachave, @rficodigo, 21, 1, @vlrParcela' +
        ', CURRENT_DATE());'
      ''
      '            IF ROW_COUNT() > 0 THEN'
      '              SET @mfichave = (SELECT'
      '                  LAST_INSERT_ID());'
      ''
      '              UPDATE terro'
      
        '              SET Mensagem = '#39'Erro ao gerar ligacao entre movime' +
        'nto e parcela'#39
      '              WHERE Chamada = pChamada;'
      ''
      ''
      '              INSERT INTO mlt (mltchave'
      '              , mfichave'
      '              , ltechave)'
      '                VALUES (@novachave, @mfichave, pLteChave);'
      '            END IF;'
      '          END IF;'
      '        END IF;'
      '      END IF;'
      ''
      '      SET @ContaParcela = @ContaParcela + 1;'
      '    END WHILE;'
      ''
      '  SET rTitCodigo:=pTitCodigo;'
      ''
      'END //')
    Left = 240
    Top = 648
  end
  object us001312: TUniScript
    SQL.Strings = (
      ''
      ''
      'DROP VIEW IF EXISTS v_imm CASCADE//'
      ''
      'CREATE'
      'DEFINER = '#39'root'#39'@'#39'%'#39
      'VIEW v_imm'
      'AS'
      'SELECT'
      '  `imm`.`immchave` AS `chave`,'
      '  `pro`.`pronome` AS `identificacao`,'
      
        '  LPAD(CAST(`imm`.`immnumepedido` AS char charset utf8), 4, '#39'0'#39')' +
        ' AS `pedido`,'
      
        '  TIME_FORMAT(TIMEDIFF(CURRENT_TIMESTAMP(), `imm`.`immhorapedido' +
        '`), '#39'%H:%i'#39') AS `tempo`,'
      '  `ito`.`itochave` AS `item`,'
      
        '  IF(`imm`.`immnumepedido` < 5000, '#39'ENTR'#39', CONCAT('#39'M:'#39', `orc`.`o' +
        'rcmesa`)) AS `destino`,'
      '  `tci`.`tcicodigo` AS `impressora`,'
      '  `sep`.`sepcodigo` AS `setor`,'
      '  `ito`.`procodigo` AS `produto`,'
      '  `ito`.`itoquantidade` AS `quantidade`,'
      '  `ito`.`puncodigo` AS `unidade`,'
      '  `imm`.`immhorapedido` AS `inicio`,'
      '  `ito`.`stocodigo` AS `situacao`,'
      
        '  `pun`.`punmaximoclbproducao` * `ito`.`itoquantidade` AS `maxim' +
        'o`'
      'FROM ((((((((((`pro`'
      '  JOIN `gri`)'
      '  JOIN `ito`)'
      '  JOIN `imm`)'
      '  JOIN `czn`)'
      '  JOIN `clb`)'
      '  JOIN `orc`)'
      '  JOIN `tci`)'
      '  JOIN `mit`)'
      '  JOIN `sep`)'
      '  JOIN `pun`)'
      'WHERE `ito`.`itochave` = `imm`.`itochave`'
      'AND `pro`.`procodigo` = `ito`.`procodigo`'
      'AND `pro`.`grpcodigo` = `gri`.`grpcodigo`'
      'AND `gri`.`sepcodigo` = `sep`.`sepcodigo`'
      'AND `imm`.`cznchave` = `czn`.`cznchave`'
      'AND `czn`.`cznfechamento` IS NULL'
      'AND `orc`.`orcchave` = `ito`.`orcchave`'
      'AND `gri`.`tcicodigo` = `tci`.`tcicodigo`'
      'AND `mit`.`mitcodigo` = `tci`.`mitcodigo`'
      'AND `imm`.`clbcodigo` = `clb`.`clbcodigo`'
      'AND `orc`.`stocodigo` <> 88'
      'AND `ito`.`stocodigo` <> 88'
      'AND `ito`.`puncodigo` = `pun`.`puncodigo`'
      'AND `imm`.`clbcodigoent` = 0'
      'AND `gri`.`gricontrolaproducao` = 1'
      'AND `imm`.`immrecebido` <> 2'
      
        'AND IF(`imm`.`immnumepedido` < 5000, `imm`.`immhoraimprimir` IS ' +
        'NOT NULL, 1)'
      'ORDER BY `imm`.`immchave`//')
    Left = 288
    Top = 648
  end
  object us001313: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'lte'#39
      '      AND column_name = '#39'tdfcodigo'#39') THEN'
      ''
      ''
      ''
      '--'
      '-- Alter table lte'
      '--'
      'ALTER TABLE lte'
      '  DROP COLUMN tdfcodigo;'
      ''
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      '')
    Left = 344
    Top = 648
  end
  object us001314: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS ProcessaLote//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE ProcessaLote (IN pFlaCodigo int'
      ', IN pTtfCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pLteTipoTaxa int'
      ', IN pLteValorTaxa double(16, 02)'
      ''
      ', OUT pConfirma int'
      ', OUT pLteChave int'
      ', OUT pMensagem varchar(65000))'
      'BEGIN'
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  SET ErroMensagem = 1;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      ''
      '  SET ErroMensagem = 2;'
      ''
      ''
      '  INSERT INTO lte (ltechave'
      '  , flacodigo'
      '  , tfdcodigo'
      '  , ltedata'
      '  , lteprincipal'
      '  , ltejuros'
      '  , ltedesconto'
      '  , ltetotal'
      '  , lteextenso'
      '  , ltehistorico'
      '  , ltemulta'
      '  , ltesituacao'
      '  , clbcodigo'
      '  , ctacodigo'
      '  , lteregistro'
      '  , ltetroco'
      '  , ltetipotaxa'
      '  , ltevalortaxa)'
      
        '    VALUES (@novachave, pFlaCodigo, pTtfCodigo, CURRENT_DATE(), ' +
        'pLtePrincipal, pLteJuros, pLteDesconto, (pLtePrincipal + pLteJur' +
        'os + pLteMulta) - pLteDesconto, '#39#39', '#39#39', pLteMulta, 0, pClbCodigo' +
        ', pCtaCodigo, NOW(), pLteTroco, pLteTipoTaxa, pLteValorTaxa);'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pLteChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    SET ErroMensagem = 3;'
      ''
      '    SET @dtlcont = 1;'
      '    SET @dtlqtde = (SELECT'
      '        COUNT(*)'
      '      FROM tdtl);'
      '    SET @VlrBaixa = 0;'
      ''
      '    WHILE (@dtlcont <= @dtlqtde) DO'
      ''
      '      INSERT INTO dtl (dtlchave'
      '      , ltechave'
      '      , cedcodigo'
      '      , dtlvalor'
      '      , mdacodigo'
      '      , flacodigo'
      '      , ccxchave'
      '      , dtlregistro)'
      '        (SELECT'
      '          @novachave,'
      '          pLteChave,'
      '          1,'
      '          @dtlValor := dtlvalor,'
      '          @mdacodigo := mdacodigo,'
      '          pFlaCodigo,'
      '          ccxchave,'
      '          dtlregistro'
      '        FROM tdtl'
      '        WHERE ID = @dtlcont);'
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        SET @dtlchave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      ''
      '        IF (@mdacodigo = 1) THEN'
      '          SET ErroMensagem = 4;'
      
        '          CALL RegistraCCO(pLteChave, pCtaCodigo, pClbCodigo, 1,' +
        ' '#39'Receb. em Dinheiro'#39', @dtlValor, ErroMensagem, @dtlchave, @CcoC' +
        'have);'
      '        END IF;'
      ''
      '        IF (@mdacodigo = 6) THEN'
      '          SET ErroMensagem = 4;'
      '          CALL RegistraCCO(pLteChave, (SELECT'
      '              cfgctacodigopix'
      
        '            FROM cfg), pClbCodigo, 1, '#39'Receb. em PIX'#39', @dtlValor' +
        ', ErroMensagem, @dtlchave, @CcoChave);'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo = 3) THEN'
      '          SET ErroMensagem = 5;'
      
        '          CALL RegistraCheque(@dtlchave, ErroMensagem, @confirma' +
        ');'
      '          IF @confirma = 0 THEN'
      '            SET ErroMensagem = 6;'
      
        '            CALL RegistraCCO(pLteChave, pCtaCodigo, pClbCodigo, ' +
        '1, '#39'Receb. em Cheque'#39', @dtlValor, ErroMensagem, @dtlchave, @CcoC' +
        'have);'
      ''
      '          END IF;'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo IN (4, 5)) THEN'
      '          SET ErroMensagem = 7;'
      
        '          CALL RegistraCartaoCCO(pLteChave, pClbCodigo, 1, '#39'Rece' +
        'b. em Cart'#65533'o'#39', @dtlchave, @dtlValor, ErroMensagem, @dtlchave, @C' +
        'coChave);'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo = 7) THEN'
      '          SET ErroMensagem = 9;'
      
        '          CALL RegistraTitulo(pFlaCodigo, pLteChave, @mdacodigo,' +
        ' ErroMensagem, @TitCodigo);'
      '        END IF;'
      ''
      '      END IF;'
      '      SET @dtlcont = @dtlcont + 1;'
      ''
      '    END WHILE;'
      ''
      '  END IF;'
      '  SET pConfirma = ErroException;'
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS RegistraCCO//'
      'CREATE DEFINER = '#39'root'#39'@'#39'localhost'#39
      'PROCEDURE RegistraCCO (IN pLteChave int'
      ', IN pCtaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCedCodigo int'
      ', IN pHistorico varchar(100)'
      ', IN pValor double(16, 2)'
      ', IN pChamada int'
      ', IN pDtlChave int'
      ', OUT pCcoChave int)'
      'BEGIN'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao registrar movimento de caixa'#39');'
      ''
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      '  SET @Conciliado = (SELECT'
      '      IF(tctcodigo = 2, 0, 1)'
      '    FROM cta'
      '    WHERE ctacodigo = pCtaCodigo);'
      ''
      ''
      '  INSERT INTO cco (ccochave'
      '  , ctacodigo'
      '  , toccodigo'
      '  , cedcodigo'
      '  , clbcodigo'
      '  , tficodigo'
      '  , moecodigo'
      '  , ccoemissao'
      '  , ccovencimento'
      '  , ccohistorico'
      '  , ccovalor'
      '  , ccoconciliado'
      '  , etdcodigo'
      '  , ccofavorecido'
      '  , ccodatamov'
      '  , ccodataregistro'
      '  , ccohoraregistro)'
      
        '    VALUES (@novachave, pCtaCodigo, 1, pCedCodigo, pClbCodigo, 9' +
        ', 1, CURRENT_DATE(), CURRENT_DATE(), pHistorico, pValor, @Concil' +
        'iado, 0, '#39#39', CURRENT_DATE(), CURRENT_DATE(), CURRENT_TIME());'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pCcoChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      ''
      '    UPDATE terro'
      '    SET mensagem = '#39'Erro ao vincular movimento de caixa ao lote'#39
      '    WHERE chamada = pChamada;'
      ''
      ''
      '    INSERT INTO clt (cltchave'
      '    , ccochave'
      '    , ltechave'
      '    , dtlchave)'
      '      VALUES (@novachave, pCcoChave, pLteChave, pDtlChave);'
      '  ELSE'
      '    SET pCcoChave = 0;'
      '  END IF;'
      ''
      'END'
      '//'
      ''
      'DROP PROCEDURE IF EXISTS RegistraTituloVenda//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraTituloVenda (IN pFlaCodigo int'
      ', IN pLteChave int'
      ', IN pMdaCodigo int'
      ', IN pChamada int'
      ', OUT pTitCodigo int'
      ', OUT pRfiChave int)'
      'BEGIN'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      '  DELETE'
      '    FROM terro;'
      ''
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao incluir Titulo'#39');'
      ''
      ''
      '  SELECT'
      '    etdcodigo,'
      '    tfdcodigo,'
      '    dtvecto'
      '  FROM trfi'
      '  ORDER BY dtvecto DESC LIMIT 1 INTO @etdcodigo'
      '  , @tfdcodigo'
      '  , @dtvenctoInicial;'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      ''
      '  SET @clbcodigo = 1;'
      ''
      '  SET @rdcnrauto = IFNULL((SELECT'
      '      rdc.rdcnrauto'
      '    FROM lte,'
      '         dtl,'
      '         ltr,'
      '         rdc'
      '    WHERE dtl.dtlchave = ltr.dtlchave'
      '    AND lte.ltechave = dtl.ltechave'
      '    AND ltr.rdcchave = rdc.rdcchave'
      '    AND dtl.mdacodigo = pMdaCodigo'
      '    AND lte.ltechave = pLteChave), '#39#39');'
      ''
      ''
      '  SET @vlrtitulo = (SELECT'
      '      SUM(vlrparcela)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @ContaParcela = (SELECT'
      '      MIN(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @QtdParcela = (SELECT'
      '      MAX(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @totparcela = (SELECT'
      '      COUNT(*)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @numparcela = 0;'
      ''
      '  INSERT INTO tit (titcodigo'
      '  , etdcodigo'
      '  , clbcodigo'
      '  , tfdcodigo'
      '  , flacodigo'
      '  , tficodigo'
      '  , bcocodigo'
      '  , carcodigo'
      '  , titemissao'
      '  , tithora'
      ''
      '  , titparcelas'
      '  , titvctoinicial'
      '  , titnumero'
      '  , titvalorparcela'
      '  , titvalor'
      '  , tithistorico'
      '  , srfcodigo'
      '  , moecodigo)'
      
        '    VALUES (@novachave, @etdcodigo, @clbcodigo, 32, pFlaCodigo, ' +
        '9, '#39'000'#39', 1, CURRENT_DATE(), CURRENT_TIME(), @QtdParcela, @dtven' +
        'ctoInicial, '#39#39', @vlrtitulo, @vlrtitulo, '#39#39', 2, 1);'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pTitCodigo = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao Gerar Parcelas'#39
      ''
      '    WHERE Chamada = pChamada;'
      '    SET @numparcela = 1;'
      '    INSERT INTO rfi (rfichave'
      '    , titcodigo'
      '    , etdcodigo'
      '    , tfdcodigo'
      '    , flacodigo'
      '    , tficodigo'
      '    , bcocodigo'
      '    , carcodigo'
      '    , rfiemissao'
      '    , rfivencimento'
      '    , rfinumero'
      '    , rfivalor'
      '    , rfihistorico'
      '    , srfcodigo'
      '    , frrcodigo'
      '    , rfivalorparcela'
      '    , moecodigo'
      '    , rdcnrauto)'
      '      SELECT'
      '        @novachave,'
      '        pTitCodigo,'
      '        trfi.etdcodigo,'
      '        @tfdcodigo := 32,'
      '        pFlaCodigo,'
      '        IF(trfi.tfdcodigo = 2, 10, 9),'
      '        '#39'000'#39','
      '        1,'
      '        CURRENT_DATE(),'
      '        trfi.dtvecto,'
      
        '        CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numero, '#39 +
        ' - '#39'), '#39#39'), trfi.numparc, '#39'/'#39', @totparcela),'
      '        @vlrParcela := trfi.vlrparcela,'
      
        '        CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numero, '#39 +
        ' - '#39'), CONCAT(pTitCodigo, '#39' - '#39')), trfi.numparc, '#39'/'#39', @totparcel' +
        'a),'
      '        IF(trfi.tfdcodigo = 2, 0, 2),'
      '        999,'
      '        trfi.vlrparcela,'
      '        1,'
      '        @rdcnrauto'
      '      FROM trfi'
      '      WHERE ID = @ContaParcela;'
      ''
      ''
      '    IF ROW_COUNT() > 0 THEN'
      '      SET @rficodigo = (SELECT'
      '          LAST_INSERT_ID());'
      ''
      '      SET pRfiChave = @rficodigo;'
      ''
      '      UPDATE terro'
      
        '      SET Mensagem = '#39'Erro ao gerar movimento inicial da parcela' +
        #39
      '      WHERE Chamada = pChamada;'
      ''
      ''
      '      INSERT INTO mfi (mfichave'
      '      , rfichave'
      '      , tmfcodigo'
      '      , moecodigo'
      '      , mfivalor'
      '      , mfidata)'
      
        '        VALUES (@novachave, @rficodigo, 2, 1, @vlrParcela, CURRE' +
        'NT_DATE());'
      ''
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        SET @mfichave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      '        UPDATE terro'
      
        '        SET Mensagem = '#39'Erro ao gerar ligacao entre movimento e ' +
        'parcela'#39
      '        WHERE Chamada = pChamada;'
      ''
      ''
      '        INSERT INTO mlt (mltchave'
      '        , mfichave'
      '        , ltechave)'
      '          VALUES (@novachave, @mfichave, pLteChave);'
      ''
      ''
      '      END IF;'
      ''
      ''
      '      IF @tfdcodigo = 32 THEN'
      ''
      '        UPDATE terro'
      
        '        SET Mensagem = '#39'Erro ao gerar movimento de recebimento d' +
        'a parcela'#39
      '        WHERE Chamada = pChamada;'
      ''
      '        INSERT INTO mfi (mfichave'
      '        , rfichave'
      '        , tmfcodigo'
      '        , moecodigo'
      '        , mfivalor'
      '        , mfidata)'
      
        '          VALUES (@novachave, @rficodigo, 21, 1, @vlrParcela, CU' +
        'RRENT_DATE());'
      ''
      '        IF ROW_COUNT() > 0 THEN'
      '          SET @mfichave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      '          UPDATE terro'
      
        '          SET Mensagem = '#39'Erro ao gerar ligacao entre movimento ' +
        'e parcela'#39
      '          WHERE Chamada = pChamada;'
      ''
      ''
      '          INSERT INTO mlt (mltchave'
      '          , mfichave'
      '          , ltechave)'
      '            VALUES (@novachave, @mfichave, pLteChave);'
      '        END IF;'
      '      END IF;'
      '    END IF;'
      ''
      '  END IF;'
      ''
      'END'
      '//'
      '')
    Delimiter = '//'
    Left = 400
    Top = 648
  end
  object us001315: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS ProcessaLote//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE ProcessaLote (IN pFlaCodigo int'
      ', IN pTtfCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pLteTipoTaxa int'
      ', IN pLteValorTaxa double(16, 02)'
      ''
      ', OUT pConfirma int'
      ', OUT pLteChave int'
      ', OUT pMensagem varchar(65000))'
      'BEGIN'
      ''
      '  --'
      
        '  -- Script was generated by Devart dbForge Studio for MySQL, Ve' +
        'rsion 6.3.358.0'
      
        '  -- Product home page: http://www.devart.com/dbforge/mysql/stud' +
        'io'
      '  -- Script date 21/01/2025 10:03:30'
      '  -- Server version: 5.5.5-10.5.26-MariaDB-0+deb11u2'
      '  -- Client version: 4.1'
      '  --'
      ''
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  SET ErroMensagem = 1;'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      ''
      '  SET ErroMensagem = 2;'
      ''
      ''
      '  INSERT INTO lte (ltechave'
      '  , flacodigo'
      '  , tfdcodigo'
      '  , ltedata'
      '  , lteprincipal'
      '  , ltejuros'
      '  , ltedesconto'
      '  , ltetotal'
      '  , lteextenso'
      '  , ltehistorico'
      '  , ltemulta'
      '  , ltesituacao'
      '  , clbcodigo'
      '  , ctacodigo'
      '  , lteregistro'
      '  , ltetroco'
      '  , ltetipotaxa'
      '  , ltevalortaxa)'
      
        '    VALUES (@novachave, pFlaCodigo, pTtfCodigo, CURRENT_DATE(), ' +
        'pLtePrincipal, pLteJuros, pLteDesconto, (pLtePrincipal + pLteJur' +
        'os + pLteMulta) - pLteDesconto, '#39#39', '#39#39', pLteMulta, 0, pClbCodigo' +
        ', pCtaCodigo, NOW(), pLteTroco, pLteTipoTaxa, pLteValorTaxa);'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pLteChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      '    SET ErroMensagem = 3;'
      ''
      '    SET @dtlcont = 1;'
      '    SET @dtlqtde = (SELECT'
      '        COUNT(*)'
      '      FROM tdtl);'
      '    SET @VlrBaixa = 0;'
      ''
      '    WHILE (@dtlcont <= @dtlqtde) DO'
      ''
      '      INSERT INTO dtl (dtlchave'
      '      , ltechave'
      '      , cedcodigo'
      '      , dtlvalor'
      '      , mdacodigo'
      '      , flacodigo'
      '      , ccxchave'
      '      , dtlregistro)'
      '        (SELECT'
      '          @novachave,'
      '          pLteChave,'
      '          1,'
      '          @dtlValor := dtlvalor,'
      '          @mdacodigo := mdacodigo,'
      '          pFlaCodigo,'
      '          ccxchave,'
      '          dtlregistro'
      '        FROM tdtl'
      '        WHERE ID = @dtlcont);'
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        SET @dtlchave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      ''
      '        IF (@mdacodigo = 1) THEN'
      '          SET ErroMensagem = 4;'
      
        '          CALL RegistraCCO(pLteChave, pCtaCodigo, pClbCodigo, 1,' +
        ' '#39'Receb. em Dinheiro'#39', @dtlValor, ErroMensagem, @dtlchave, @CcoC' +
        'have);'
      '        END IF;'
      ''
      '        IF (@mdacodigo = 6) THEN'
      '          SET ErroMensagem = 4;'
      '          CALL RegistraCCO(pLteChave, (SELECT'
      '              cfgctacodigopix'
      
        '            FROM cfg), pClbCodigo, 1, '#39'Receb. em PIX'#39', @dtlValor' +
        ', ErroMensagem, @dtlchave, @CcoChave);'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo = 3) THEN'
      '          SET ErroMensagem = 5;'
      
        '          CALL RegistraCheque(@dtlchave, ErroMensagem, @confirma' +
        ');'
      '          IF @confirma = 0 THEN'
      '            SET ErroMensagem = 6;'
      
        '            CALL RegistraCCO(pLteChave, pCtaCodigo, pClbCodigo, ' +
        '1, '#39'Receb. em Cheque'#39', @dtlValor, ErroMensagem, @dtlchave, @CcoC' +
        'have);'
      ''
      '          END IF;'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo IN (4, 5)) THEN'
      '          SET ErroMensagem = 7;'
      
        '          CALL RegistraCartaoCCO(pLteChave, pClbCodigo, 1, '#39'Rece' +
        'b. em Cart'#65533'o'#39', @dtlchave, @dtlValor, ErroMensagem, @CcoChave);'
      '        END IF;'
      ''
      ''
      '        IF (@mdacodigo = 7) THEN'
      '          SET ErroMensagem = 9;'
      
        '          CALL RegistraTitulo(pFlaCodigo, pLteChave, @mdacodigo,' +
        ' ErroMensagem, @TitCodigo);'
      '        END IF;'
      ''
      '      END IF;'
      '      SET @dtlcont = @dtlcont + 1;'
      ''
      '    END WHILE;'
      ''
      '  END IF;'
      '  SET pConfirma = ErroException;'
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      'END //')
    Left = 456
    Top = 648
  end
  object us001316: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS RegistraTituloVenda//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraTituloVenda (IN pFlaCodigo int'
      ', IN pLteChave int'
      ', IN pMdaCodigo int'
      ', IN pChamada int'
      ', OUT pTitCodigo int'
      ', OUT pRfiChave int)'
      'BEGIN'
      ''
      '  --'
      
        '  -- Script was generated by Devart dbForge Studio for MySQL, Ve' +
        'rsion 6.3.358.0'
      
        '  -- Product home page: http://www.devart.com/dbforge/mysql/stud' +
        'io'
      '  -- Script date 21/01/2025 10:03:30'
      '  -- Server version: 5.5.5-10.5.26-MariaDB-0+deb11u2'
      '  -- Client version: 4.1'
      '  --'
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      '  DELETE'
      '    FROM terro;'
      ''
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao incluir Titulo'#39');'
      ''
      ''
      '  SELECT'
      '    etdcodigo,'
      '    tfdcodigo,'
      '    dtvecto'
      '  FROM trfi'
      '  ORDER BY dtvecto DESC LIMIT 1 INTO @etdcodigo'
      '  , @tfdcodigo'
      '  , @dtvenctoInicial;'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      ''
      '  SET @clbcodigo = 1;'
      ''
      '  SET @rdcnrauto = IFNULL((SELECT'
      '      rdc.rdcnrauto'
      '    FROM lte,'
      '         dtl,'
      '         ltr,'
      '         rdc'
      '    WHERE dtl.dtlchave = ltr.dtlchave'
      '    AND lte.ltechave = dtl.ltechave'
      '    AND ltr.rdcchave = rdc.rdcchave'
      '    AND dtl.mdacodigo = pMdaCodigo'
      '    AND lte.ltechave = pLteChave), '#39#39');'
      ''
      ''
      '  SET @vlrtitulo = (SELECT'
      '      SUM(vlrparcela)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @ContaParcela = (SELECT'
      '      MIN(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @QtdParcela = (SELECT'
      '      MAX(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @totparcela = (SELECT'
      '      COUNT(*)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @numparcela = 0;'
      ''
      '  INSERT INTO tit (titcodigo'
      '  , etdcodigo'
      '  , clbcodigo'
      '  , tfdcodigo'
      '  , flacodigo'
      '  , tficodigo'
      '  , bcocodigo'
      '  , carcodigo'
      '  , titemissao'
      '  , tithora'
      ''
      '  , titparcelas'
      '  , titvctoinicial'
      '  , titnumero'
      '  , titvalorparcela'
      '  , titvalor'
      '  , tithistorico'
      '  , srfcodigo'
      '  , moecodigo)'
      
        '    VALUES (@novachave, @etdcodigo, @clbcodigo, 32, pFlaCodigo, ' +
        '9, '#39'000'#39', 1, CURRENT_DATE(), CURRENT_TIME(), @QtdParcela, @dtven' +
        'ctoInicial, '#39#39', @vlrtitulo, @vlrtitulo, '#39#39', 2, 1);'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pTitCodigo = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao Gerar Parcelas'#39
      ''
      '    WHERE Chamada = pChamada;'
      '    SET @numparcela = 1;'
      '    INSERT INTO rfi (rfichave'
      '    , titcodigo'
      '    , etdcodigo'
      '    , tfdcodigo'
      '    , flacodigo'
      '    , tficodigo'
      '    , bcocodigo'
      '    , carcodigo'
      '    , rfiemissao'
      '    , rfivencimento'
      '    , rfinumero'
      '    , rfivalor'
      '    , rfihistorico'
      '    , srfcodigo'
      '    , frrcodigo'
      '    , rfivalorparcela'
      '    , moecodigo'
      '    , rdcnrauto)'
      '      SELECT'
      '        @novachave,'
      '        pTitCodigo,'
      '        trfi.etdcodigo,'
      '        @tfdcodigo := 32,'
      '        pFlaCodigo,'
      '        IF(trfi.tfdcodigo = 2, 10, 9),'
      '        '#39'000'#39','
      '        1,'
      '        CURRENT_DATE(),'
      '        trfi.dtvecto,'
      
        '        CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numero, '#39 +
        ' - '#39'), '#39#39'), trfi.numparc, '#39'/'#39', @totparcela),'
      '        @vlrParcela := trfi.vlrparcela,'
      
        '        CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numero, '#39 +
        ' - '#39'), CONCAT(pTitCodigo, '#39' - '#39')), trfi.numparc, '#39'/'#39', @totparcel' +
        'a),'
      '        IF(trfi.tfdcodigo = 2, 0, 2),'
      '        999,'
      '        trfi.vlrparcela,'
      '        1,'
      '        @rdcnrauto'
      '      FROM trfi'
      '      WHERE ID = @ContaParcela;'
      ''
      ''
      '    IF ROW_COUNT() > 0 THEN'
      '      SET @rficodigo = (SELECT'
      '          LAST_INSERT_ID());'
      ''
      '      SET pRfiChave = @rficodigo;'
      ''
      '      UPDATE terro'
      
        '      SET Mensagem = '#39'Erro ao gerar movimento inicial da parcela' +
        #39
      '      WHERE Chamada = pChamada;'
      ''
      ''
      '      INSERT INTO mfi (mfichave'
      '      , rfichave'
      '      , tmfcodigo'
      '      , moecodigo'
      '      , mfivalor'
      '      , mfidata)'
      
        '        VALUES (@novachave, @rficodigo, 2, 1, @vlrParcela, CURRE' +
        'NT_DATE());'
      ''
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        SET @mfichave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      '        UPDATE terro'
      
        '        SET Mensagem = '#39'Erro ao gerar ligacao entre movimento e ' +
        'parcela'#39
      '        WHERE Chamada = pChamada;'
      ''
      ''
      '        INSERT INTO mlt (mltchave'
      '        , mfichave'
      '        , ltechave)'
      '          VALUES (@novachave, @mfichave, pLteChave);'
      ''
      ''
      '      END IF;'
      ''
      ''
      '      IF @tfdcodigo = 32 THEN'
      ''
      '        UPDATE terro'
      
        '        SET Mensagem = '#39'Erro ao gerar movimento de recebimento d' +
        'a parcela'#39
      '        WHERE Chamada = pChamada;'
      ''
      '        INSERT INTO mfi (mfichave'
      '        , rfichave'
      '        , tmfcodigo'
      '        , moecodigo'
      '        , mfivalor'
      '        , mfidata)'
      
        '          VALUES (@novachave, @rficodigo, 21, 1, @vlrParcela, CU' +
        'RRENT_DATE());'
      ''
      '        IF ROW_COUNT() > 0 THEN'
      '          SET @mfichave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      '          UPDATE terro'
      
        '          SET Mensagem = '#39'Erro ao gerar ligacao entre movimento ' +
        'e parcela'#39
      '          WHERE Chamada = pChamada;'
      ''
      ''
      '          INSERT INTO mlt (mltchave'
      '          , mfichave'
      '          , ltechave)'
      '            VALUES (@novachave, @mfichave, pLteChave);'
      '        END IF;'
      '      END IF;'
      '    END IF;'
      ''
      '  END IF;'
      ''
      'END //')
    Left = 24
    Top = 704
  end
  object us001317: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS FechaMesa//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE FechaMesa (IN pOrcChave int'
      ', IN pTipo int'
      ', IN pNome varchar(20)'
      ', IN pFlaCodigo int'
      ', IN pClbCodigo int'
      ', IN pCtaCodigo int'
      ', IN pLtePrincipal double(16, 02)'
      ', IN pLteJuros double(16, 02)'
      ', IN pLteDesconto double(16, 02)'
      ', IN pLteMulta double(16, 02)'
      ', IN pLteTroco double(16, 02)'
      ', IN pRefeicao int'
      ', IN pTipoTaxa int'
      ', IN pTaxa double(16, 02)'
      ', IN pTipoFechamento int'
      ', OUT pConfirma int'
      ', OUT pMensagem BLOB'
      ', OUT pMesChave int'
      ', OUT pLteChave int)'
      'BEGIN'
      '  -- daniel 02/01/2025 10:40'
      ''
      '  DECLARE ErroException integer DEFAULT 0;'
      '  DECLARE ErroMensagem integer DEFAULT 0;'
      ''
      '  DECLARE lote integer DEFAULT 0;'
      '  DECLARE modalidade integer DEFAULT 0;'
      ''
      '  DECLARE done int DEFAULT FALSE;'
      ''
      ''
      '  DECLARE curlote CURSOR FOR'
      '  SELECT'
      '    dtl.ltechave,'
      '    dtl.mdacodigo'
      '  FROM dtl'
      '    INNER JOIN olt'
      '      ON dtl.ltechave = olt.ltechave'
      '  WHERE olt.orcchave = pOrcChave'
      '  AND dtl.mdacodigo = 7;'
      '  DECLARE CONTINUE HANDLER FOR NOT FOUND BEGIN'
      '    SET done = TRUE;'
      '  END;'
      ''
      ''
      '  SET @vlClbCodigo = pClbCodigo;'
      ''
      '  SET @Confirma = 0;'
      ''
      '  SET @ltechave = 0;'
      ''
      '  SET @Mensagem = 0;'
      ''
      
        '  CALL ProcessaLote(pFlaCodigo, 32, pClbCodigo, pCtaCodigo, pLte' +
        'Principal, pLteJuros, pLteDesconto, pLteMulta, pLteTroco, pTipoT' +
        'axa, pTaxa, @Confirma, @ltechave, @Mensagem);'
      ''
      '  SET pConfirma = @Confirma;'
      ''
      '  SET pMensagem = @Mensagem;'
      ''
      '  SET pLteChave = 0;'
      ''
      '  SET pMesChave = 0;'
      ''
      '  SET @meschave = 0;'
      ''
      ''
      '  IF pLteDesconto > 0 THEN'
      ''
      '    SET @percdesc = (pLteDesconto / pLtePrincipal);'
      ''
      '  ELSE'
      ''
      '    SET @percdesc = 0;'
      ''
      '  END IF;'
      ''
      ''
      '  IF pConfirma = 0 THEN'
      ''
      ''
      '    SET pLteChave = @ltechave;'
      ''
      ''
      '    SET ErroMensagem = 13;'
      ''
      ''
      ''
      '    INSERT INTO olt (oltchave'
      '    , orcchave'
      '    , ltechave'
      '    , oltidentificacao'
      '    , olttipo)'
      
        '      VALUE (@novachave, pOrcChave, @ltechave, pNome, pTipoFecha' +
        'mento);'
      ''
      ''
      '    SET @LteDesconto = IFNULL((SELECT'
      '        SUM(lte.ltedesconto)'
      '      FROM olt'
      '        INNER JOIN lte'
      '          ON olt.ltechave = lte.ltechave'
      '      WHERE olt.orcchave = pOrcChave), 0);'
      ''
      ''
      ''
      '    SET @OrcTotalAv = (SELECT'
      '        SUM(itovalorav * itoquantidade) totav'
      '      FROM ito,'
      '           pro'
      '      WHERE ito.procodigo = pro.procodigo'
      '      AND ito.stocodigo <> 88'
      '      AND pro.tpocodigo = 0'
      '      AND orcchave = pOrcChave);'
      ''
      ''
      ''
      ''
      '    IF @LteDesconto > 0 THEN'
      '      SET @percdesc = (@LteDesconto / @OrcTotalAv);'
      ''
      ''
      ''
      '      UPDATE ito, pro'
      
        '      SET itodescontoav = ROUND(((itototalav + itoacrescimoav + ' +
        'itooutras) * @percdesc), 2),'
      '          itosaldoav = (ito.itototalav - itodescontoav),'
      '          itodescontoap = ROUND((itototalap * @percdesc), 2),'
      '          itosaldoap = (ito.itototalav - itodescontoav),'
      '          itopercdescap = ROUND(@percdesc, 3),'
      '          itopercdescav = ROUND(@percdesc, 3)'
      '      WHERE ito.stocodigo <> 88'
      '      AND ito.procodigo = pro.procodigo'
      '      AND pro.tpocodigo = 0'
      '      AND ito.orcchave = pOrcChave;'
      ''
      ''
      ''
      ''
      ''
      '      SET @centavos = @LteDesconto - (SELECT'
      '          SUM(itodescontoav)'
      '        FROM ito,'
      '             pro'
      '        WHERE ito.orcchave = pOrcChave'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0);'
      ''
      ''
      ''
      ''
      '      IF @centavos <> 0 THEN'
      ''
      '        UPDATE ito, pro'
      '        SET itodescontoav = itodescontoav + @centavos,'
      '            itodescontoap = itodescontoap + @centavos,'
      '            itosaldoav = itosaldoav + @centavos,'
      '            itosaldoap = itosaldoap + @centavos'
      '        WHERE ito.stocodigo <> 88'
      '        AND ito.procodigo = pro.procodigo'
      '        AND pro.tpocodigo = 0'
      '        AND ito.orcchave = pOrcChave;'
      ''
      '      END IF;'
      ''
      ''
      ''
      '      UPDATE orc'
      '      INNER JOIN (SELECT'
      '          ito.orcchave,'
      '          SUM(itototalav) totav,'
      '          SUM(itodescontoav) descav,'
      '          SUM(itototalap) totap,'
      '          SUM(itodescontoap) descap'
      '        FROM ito'
      '        WHERE stocodigo != 88'
      '        GROUP BY ito.orcchave) tito'
      '        ON tito.orcchave = orc.orcchave'
      '      SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '          orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '          orc.orcdescontoav = tito.descap,'
      
        '          orc.orcpercdescav = IF(tito.descap > 0, (tito.descap /' +
        ' tito.totap), 0),'
      '          orc.orctotalap = (tito.totap - tito.descap)'
      '      WHERE orc.orcchave = pOrcChave;'
      ''
      '    END IF;'
      ''
      ''
      '    SET ErroMensagem = 12;'
      ''
      ''
      
        '    CALL RegistraMes(pOrcChave, @vlClbCodigo, ErroMensagem, pCon' +
        'firma, pMensagem, @meschave);'
      ''
      ''
      '    SET ErroMensagem = 14;'
      ''
      ''
      '    SET @VlrFechamento = (SELECT'
      '        SUM(dtl.dtlvalor) dtlvalor'
      '      FROM dtl'
      '        INNER JOIN olt'
      '          ON dtl.ltechave = olt.ltechave'
      '      WHERE olt.orcchave = pOrcChave);'
      ''
      ''
      '    SET @vlLtechave = (SELECT'
      '        ltechave'
      '      FROM olt'
      '      WHERE olt.orcchave = pOrcChave'
      '      ORDER BY ltechave DESC LIMIT 1);'
      ''
      ''
      '    IF @VlrFechamento > 0 THEN'
      ''
      '      SET @etdcodigo = (SELECT'
      '          etdcodigo'
      '        FROM orc'
      '        WHERE orc.orcchave = pOrcChave);'
      ''
      ''
      ''
      '      SET ErroMensagem = 15;'
      ''
      '      INSERT INTO trfi (ID'
      '      , etdcodigo'
      '      , mdacodigo'
      '      , tfdcodigo'
      '      , numparc'
      '      , dtvecto'
      '      , vlrparcela'
      '      , numero)'
      
        '        VALUES (@novachave, @etdcodigo, 1, 32, 1, CURRENT_DATE()' +
        ', @VlrFechamento, @meschave);'
      ''
      '      SET ErroMensagem = 16;'
      '      SET @rfichaveVenda = 0;'
      ''
      
        '      CALL RegistraTituloVenda(pFlaCodigo, @vlLtechave, 1, ErroM' +
        'ensagem, @TitCodigo, @rfichaveVenda);'
      ''
      '      SET @rfivenda = 0;'
      ''
      ''
      '      DELETE'
      '        FROM trfi'
      '      WHERE numero = @meschave;'
      ''
      '      INSERT INTO rfm (rfichave, meschave)'
      '        (SELECT DISTINCT'
      '          @rfichaveVenda,'
      '          @MesChave'
      '        FROM olt'
      '          INNER JOIN mlt'
      '            ON olt.ltechave = mlt.ltechave'
      '          INNER JOIN mfi'
      '            ON mlt.mfichave = mfi.mfichave'
      '        WHERE olt.orcchave = pOrcChave);'
      ''
      '      SET ErroMensagem = 17;'
      ''
      ''
      ''
      ''
      '      OPEN curlote;'
      '    read_loop:'
      '      LOOP'
      ''
      '        FETCH curlote INTO lote, modalidade;'
      ''
      '        IF done THEN'
      '          LEAVE read_loop;'
      '        END IF;'
      ''
      ''
      '        SET @VlrFechamento = (SELECT'
      '            SUM(dtl.dtlvalor) dtlvalor'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade);'
      ''
      '        SET @vlLtechave = (SELECT'
      '            dtl.ltechave'
      '          FROM dtl'
      '            INNER JOIN olt'
      '              ON dtl.ltechave = olt.ltechave'
      '          WHERE olt.orcchave = pOrcChave'
      '          AND dtl.ltechave = lote'
      '          AND dtl.mdacodigo = modalidade);'
      ''
      '        DELETE'
      '          FROM trfi'
      '        WHERE mdacodigo <> 7;'
      ''
      '        IF modalidade = 7'
      '          AND lote <> 0 THEN'
      '          INSERT INTO trfi (ID'
      '          , etdcodigo'
      '          , mdacodigo'
      '          , tfdcodigo'
      '          , numparc'
      '          , dtvecto'
      '          , vlrparcela'
      '          , numero)'
      
        '            VALUES (@novachave, @etdcodigo, 1, 2, 1, CURRENT_DAT' +
        'E(), @VlrFechamento, @meschave);'
      ''
      '          SET ErroMensagem = 16;'
      '          SET @rtitcodigo = 0;'
      ''
      '        END IF;'
      ''
      '      END LOOP;'
      ''
      '      CLOSE curlote;'
      ''
      ''
      '    END IF;'
      ''
      '    SET ErroMensagem = 18;'
      ''
      '    UPDATE orc'
      '    INNER JOIN (SELECT'
      '        ito.orcchave,'
      '        SUM(itototalav) totav,'
      '        SUM(itodescontoav) descav,'
      '        SUM(itototalap) totap,'
      '        SUM(itodescontoap) descap'
      '      FROM ito'
      '      WHERE stocodigo != 88'
      '      GROUP BY ito.orcchave) tito'
      '      ON tito.orcchave = orc.orcchave'
      '    SET orc.orcgeralav = tito.totav,'
      ''
      ''
      '        orc.orctotalav = (tito.totav - tito.descav),'
      ''
      '        orc.orctotalap = (tito.totap - tito.descap),'
      '        orc.orcdataencerr = CURRENT_DATE(),'
      '        orc.orchoraencerr = CURRENT_TIME(),'
      '        orc.stocodigo = 3'
      '    WHERE orc.orcchave = pOrcChave;'
      ''
      '    UPDATE ito'
      '    SET ito.stocodigo = 3'
      '    WHERE ito.orcchave = pOrcChave'
      '    AND ito.stocodigo IN (1, 2, 5);'
      ''
      ''
      '  END IF;'
      ''
      ''
      ''
      ''
      '  IF @meschave > 0 THEN'
      '    SET pMesChave = @meschave;'
      '  ELSE'
      '    SET pMesChave = 0;'
      '  END IF;'
      ''
      '  SET pConfirma = ErroException;'
      ''
      '  SET pMensagem = '#39'Movimento gravado com sucesso !'#39';'
      ''
      'END//')
    Left = 88
    Top = 712
  end
  object us001318: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS RegistraTituloVenda//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraTituloVenda (IN pFlaCodigo int'
      ', IN pLteChave int'
      ', IN pMdaCodigo int'
      ', IN pChamada int'
      ', OUT pTitCodigo int'
      ', OUT pRfiChave int)'
      'BEGIN'
      ''
      '  --'
      
        '  -- Script was generated by Devart dbForge Studio for MySQL, Ve' +
        'rsion 6.3.358.0'
      
        '  -- Product home page: http://www.devart.com/dbforge/mysql/stud' +
        'io'
      '  -- Script date 21/01/2025 10:03:30'
      '  -- Server version: 5.5.5-10.5.26-MariaDB-0+deb11u2'
      '  -- Client version: 4.1'
      '  --'
      ''
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      '  DELETE'
      '    FROM terro;'
      ''
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao incluir Titulo'#39');'
      ''
      ''
      '  SELECT'
      '    etdcodigo,'
      '    tfdcodigo,'
      '    dtvecto'
      '  FROM trfi'
      '  ORDER BY dtvecto DESC LIMIT 1 INTO @etdcodigo'
      '  , @tfdcodigo'
      '  , @dtvenctoInicial;'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      ''
      '  SET @clbcodigo = 1;'
      ''
      '  SET @rdcnrauto = IFNULL((SELECT'
      '      rdc.rdcnrauto'
      '    FROM lte,'
      '         dtl,'
      '         ltr,'
      '         rdc'
      '    WHERE dtl.dtlchave = ltr.dtlchave'
      '    AND lte.ltechave = dtl.ltechave'
      '    AND ltr.rdcchave = rdc.rdcchave'
      '    AND dtl.mdacodigo = pMdaCodigo'
      '    AND lte.ltechave = pLteChave), '#39#39');'
      ''
      ''
      '  SET @vlrtitulo = (SELECT'
      '      SUM(vlrparcela)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @ContaParcela = (SELECT'
      '      MIN(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @QtdParcela = (SELECT'
      '      MAX(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @totparcela = (SELECT'
      '      COUNT(*)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @numparcela = 0;'
      ''
      '  INSERT INTO tit (titcodigo'
      '  , etdcodigo'
      '  , clbcodigo'
      '  , tfdcodigo'
      '  , flacodigo'
      '  , tficodigo'
      '  , bcocodigo'
      '  , carcodigo'
      '  , titemissao'
      '  , tithora'
      ''
      '  , titparcelas'
      '  , titvctoinicial'
      '  , titnumero'
      '  , titvalorparcela'
      '  , titvalor'
      '  , tithistorico'
      '  , srfcodigo'
      '  , moecodigo)'
      
        '    VALUES (@novachave, @etdcodigo, @clbcodigo, 32, pFlaCodigo, ' +
        '9, '#39'000'#39', 1, CURRENT_DATE(), CURRENT_TIME(), @QtdParcela, @dtven' +
        'ctoInicial, '#39#39', @vlrtitulo, @vlrtitulo, '#39#39', 2, 1);'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pTitCodigo = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao Gerar Parcelas'#39
      ''
      '    WHERE Chamada = pChamada;'
      '    SET @numparcela = 1;'
      '    INSERT INTO rfi (rfichave'
      '    , titcodigo'
      '    , etdcodigo'
      '    , tfdcodigo'
      '    , flacodigo'
      '    , tficodigo'
      '    , bcocodigo'
      '    , carcodigo'
      '    , rfiemissao'
      '    , rfivencimento'
      '    , rfinumero'
      '    , rfivalor'
      '    , rfihistorico'
      '    , srfcodigo'
      '    , frrcodigo'
      '    , rfivalorparcela'
      '    , moecodigo'
      '    , rdcnrauto)'
      '      SELECT'
      '        @novachave,'
      '        pTitCodigo,'
      '        trfi.etdcodigo,'
      '        @tfdcodigo := 32,'
      '        pFlaCodigo,'
      '        IF(trfi.tfdcodigo = 2, 10, 9),'
      '        '#39'000'#39','
      '        1,'
      '        CURRENT_DATE(),'
      '        trfi.dtvecto,'
      
        '        CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numero, '#39 +
        ' - '#39'), '#39#39'), trfi.numparc, '#39'/'#39', @totparcela),'
      '        @vlrParcela := trfi.vlrparcela,'
      
        '        CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numero, '#39 +
        ' - '#39'), CONCAT(pTitCodigo, '#39' - '#39')), trfi.numparc, '#39'/'#39', @totparcel' +
        'a),'
      '        IF(trfi.tfdcodigo = 2, 0, 2),'
      '        999,'
      '        trfi.vlrparcela,'
      '        1,'
      '        @rdcnrauto'
      '      FROM trfi'
      '      WHERE ID = @ContaParcela;'
      ''
      ''
      '    IF ROW_COUNT() > 0 THEN'
      '      SET @rficodigo = (SELECT'
      '          LAST_INSERT_ID());'
      ''
      '      SET pRfiChave = @rficodigo;'
      ''
      '      UPDATE terro'
      
        '      SET Mensagem = '#39'Erro ao gerar movimento inicial da parcela' +
        #39
      '      WHERE Chamada = pChamada;'
      ''
      ''
      '      INSERT INTO mfi (mfichave'
      '      , rfichave'
      '      , tmfcodigo'
      '      , moecodigo'
      '      , mfivalor'
      '      , mfidata)'
      
        '        VALUES (@novachave, @rficodigo, 2, 1, @vlrParcela, CURRE' +
        'NT_DATE());'
      ''
      ''
      '      IF ROW_COUNT() > 0 THEN'
      '        SET @mfichave = (SELECT'
      '            LAST_INSERT_ID());'
      ''
      '        UPDATE terro'
      
        '        SET Mensagem = '#39'Erro ao gerar ligacao entre movimento e ' +
        'parcela'#39
      '        WHERE Chamada = pChamada;'
      ''
      ''
      '      /* INSERT INTO mlt (mltchave'
      '       , mfichave'
      '       , ltechave)'
      '         VALUES (@novachave, @mfichave, pLteChave);*/'
      ''
      ''
      '      END IF;'
      ''
      ''
      '      IF @tfdcodigo = 32 THEN'
      ''
      '        UPDATE terro'
      
        '        SET Mensagem = '#39'Erro ao gerar movimento de recebimento d' +
        'a parcela'#39
      '        WHERE Chamada = pChamada;'
      ''
      '        INSERT INTO mfi (mfichave'
      '        , rfichave'
      '        , tmfcodigo'
      '        , moecodigo'
      '        , mfivalor'
      '        , mfidata)'
      
        '          VALUES (@novachave, @rficodigo, 21, 1, @vlrParcela, CU' +
        'RRENT_DATE());'
      ''
      '        IF ROW_COUNT() > 0 THEN'
      '          SET @mfichave = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      '          UPDATE terro'
      
        '          SET Mensagem = '#39'Erro ao gerar ligacao entre movimento ' +
        'e parcela'#39
      '          WHERE Chamada = pChamada;'
      ''
      ''
      '          INSERT INTO mlt (mltchave'
      '          , mfichave'
      '          , ltechave)'
      '            VALUES (@novachave, @mfichave, pLteChave);'
      '        END IF;'
      '      END IF;'
      '    END IF;'
      ''
      '  END IF;'
      ''
      'END //'
      '')
    Left = 512
    Top = 416
  end
  object us001319: TUniScript
    SQL.Strings = (
      ''
      ''
      'DROP PROCEDURE IF EXISTS RegistraTitulo//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraTitulo (IN pFlaCodigo int'
      ', IN pLteChave int'
      ', IN pMdaCodigo int'
      ', IN pChamada int'
      ', OUT pTitCodigo int)'
      'BEGIN'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      '  DELETE'
      '    FROM terro;'
      ''
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE Chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao incluir Titulo'#39');'
      ''
      ''
      '  SELECT'
      '    etdcodigo,'
      '    tfdcodigo,'
      '    dtvecto'
      '  FROM trfi'
      '  ORDER BY dtvecto DESC LIMIT 1 INTO @etdcodigo'
      '  , @tfdcodigo'
      '  , @dtvenctoInicial;'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      ''
      '  SET @rdcnrauto = IFNULL((SELECT'
      '      rdc.rdcnrauto'
      '    FROM lte,'
      '         dtl,'
      '         ltr,'
      '         rdc'
      '    WHERE dtl.dtlchave = ltr.dtlchave'
      '    AND lte.ltechave = dtl.ltechave'
      '    AND ltr.rdcchave = rdc.rdcchave'
      '    AND dtl.mdacodigo = pMdaCodigo'
      '    AND lte.ltechave = pLteChave), '#39#39');'
      ''
      ''
      '  SET @vlrtitulo = (SELECT'
      '      SUM(vlrparcela)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @ContaParcela = (SELECT'
      '      MIN(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @QtdParcela = (SELECT'
      '      MAX(ID)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @totparcela = (SELECT'
      '      COUNT(*)'
      '    FROM trfi'
      '    WHERE mdacodigo = pMdaCodigo);'
      '  SET @numparcela = 0;'
      ''
      ''
      '  INSERT INTO tit (titcodigo'
      '  , etdcodigo'
      '  , tfdcodigo'
      '  , flacodigo'
      '  , tficodigo'
      '  , bcocodigo'
      '  , carcodigo'
      '  , titemissao'
      '  , tithora'
      '  , clbcodigo'
      '  , titparcelas'
      '  , titvctoinicial'
      '  , titnumero'
      '  , titvalorparcela'
      '  , titvalor'
      '  , tithistorico'
      '  , srfcodigo'
      '  , moecodigo)'
      
        '    VALUES (@novachave, @etdcodigo, @tfdcodigo, pFlaCodigo, 9, '#39 +
        '000'#39', 1, CURRENT_DATE(), CURRENT_TIME(), @clbcodigo, @QtdParcela' +
        ', @dtvenctoInicial, '#39#39', @vlrtitulo, @vlrtitulo, '#39#39', IF(@tfdcodig' +
        'o = 32, 2, 0), 1);'
      ''
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pTitCodigo = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      ''
      '    UPDATE terro'
      '    SET Mensagem = '#39'Erro ao Gerar Parcelas'#39
      '    WHERE Chamada = pChamada;'
      ''
      ''
      '    WHILE (@ContaParcela <= @QtdParcela) DO'
      '      IF pMdaCodigo = IFNULL((SELECT'
      '            mdacodigo'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela), 0) THEN'
      '        SET @numparcela = @numparcela + 1;'
      '        INSERT INTO rfi (rfichave'
      '        , titcodigo'
      '        , etdcodigo'
      '        , tfdcodigo'
      '        , flacodigo'
      '        , tficodigo'
      '        , bcocodigo'
      '        , carcodigo'
      '        , rfiemissao'
      '        , rfivencimento'
      '        , rfinumero'
      '        , rfivalor'
      '        , rfihistorico'
      '        , srfcodigo'
      '        , frrcodigo'
      '        , rfivalorparcela'
      '        , moecodigo'
      '        , rdcnrauto)'
      '          SELECT'
      '            @novachave,'
      '            pTitCodigo,'
      '            trfi.etdcodigo,'
      '            @tfdcodigo := trfi.tfdcodigo,'
      '            pFlaCodigo,'
      '            IF(trfi.tfdcodigo = 2, 10, 9),'
      '            '#39'000'#39','
      '            1,'
      '            CURRENT_DATE(),'
      '            trfi.dtvecto,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), '#39#39'), trfi.numparc, '#39'/'#39', @totparcela),'
      '            @vlrParcela := trfi.vlrparcela,'
      
        '            CONCAT(IF(LENGTH(trfi.numero) > 0, CONCAT(trfi.numer' +
        'o, '#39' - '#39'), CONCAT(pTitCodigo, '#39' - '#39')), trfi.numparc, '#39'/'#39', @totpa' +
        'rcela),'
      '            IF(trfi.tfdcodigo = 2, 0, 2),'
      '            999,'
      '            trfi.vlrparcela,'
      '            1,'
      '            @rdcnrauto'
      '          FROM trfi'
      '          WHERE ID = @ContaParcela;'
      ''
      ''
      '        IF ROW_COUNT() > 0 THEN'
      '          SET @rficodigo = (SELECT'
      '              LAST_INSERT_ID());'
      ''
      ''
      '          UPDATE terro'
      
        '          SET Mensagem = '#39'Erro ao gerar movimento inicial da par' +
        'cela'#39
      '          WHERE Chamada = pChamada;'
      ''
      ''
      '          INSERT INTO mfi (mfichave'
      '          , rfichave'
      '          , tmfcodigo'
      '          , moecodigo'
      '          , mfivalor'
      '          , mfidata)'
      
        '            VALUES (@novachave, @rficodigo, 2, 1, @vlrParcela, C' +
        'URRENT_DATE());'
      ''
      ''
      '          IF ROW_COUNT() > 0 THEN'
      '            SET @mfichave = (SELECT'
      '                LAST_INSERT_ID());'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar ligacao entre moviment' +
        'o e parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      ''
      '          /*  INSERT INTO mlt (mltchave'
      '            , mfichave'
      '            , ltechave)'
      '              VALUES (@novachave, @mfichave, pLteChave);*/'
      ''
      ''
      ''
      ''
      '          END IF;'
      ''
      ''
      '          IF @tfdcodigo = 32 THEN'
      ''
      '            UPDATE terro'
      
        '            SET Mensagem = '#39'Erro ao gerar movimento de recebimen' +
        'to da parcela'#39
      '            WHERE Chamada = pChamada;'
      ''
      ''
      ''
      ''
      ''
      '            INSERT INTO mfi (mfichave'
      '            , rfichave'
      '            , tmfcodigo'
      '            , moecodigo'
      '            , mfivalor'
      '            , mfidata)'
      
        '              VALUES (@novachave, @rficodigo, 21, 1, @vlrParcela' +
        ', CURRENT_DATE());'
      ''
      ''
      ''
      '            IF ROW_COUNT() > 0 THEN'
      '              SET @mfichave = (SELECT'
      '                  LAST_INSERT_ID());'
      ''
      '              UPDATE terro'
      
        '              SET Mensagem = '#39'Erro ao gerar ligacao entre movime' +
        'nto e parcela'#39
      '              WHERE Chamada = pChamada;'
      ''
      ''
      '              INSERT INTO mlt (mltchave'
      '              , mfichave'
      '              , ltechave)'
      '                VALUES (@novachave, @mfichave, pLteChave);'
      '            END IF;'
      '          END IF;'
      '        END IF;'
      '      END IF;'
      ''
      '      SET @ContaParcela = @ContaParcela + 1;'
      '    END WHILE;'
      ''
      '  END IF;'
      'END //')
    Left = 560
    Top = 416
  end
  object us001320: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'lte'#39
      '      AND column_name = '#39'tdfcodigo'#39') THEN'
      ''
      '--'
      '-- Alter table "lte"'
      '--'
      'ALTER TABLE lte'
      '  DROP COLUMN tdfcodigo;'
      ''
      ''
      'end if; '
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Left = 648
    Top = 416
  end
  object us001321: TUniScript
    SQL.Strings = (
      'UPDATE v_rfi'
      'INNER JOIN etd ON etd.etdcodigo = v_rfi.etdcodigo'
      'SET v_rfi.etdidentificacao = etd.etdidentificacao'
      'WHERE etd.etdidentificacao <> v_rfi.etdidentificacao//'
      ''
      ''
      ''
      ''
      'DROP TRIGGER IF EXISTS etd_after_upd//'
      ''
      'CREATE'
      'DEFINER = '#39'root'#39'@'#39'%'#39
      'TRIGGER etd_after_upd'
      'AFTER UPDATE'
      'ON etd'
      'FOR EACH ROW'
      'BEGIN'
      '  UPDATE v_rfi'
      '  INNER JOIN etd'
      '    ON etd.etdcodigo = v_rfi.etdcodigo'
      '  SET v_rfi.etdidentificacao = etd.etdidentificacao'
      '  WHERE etd.etdidentificacao <> v_rfi.etdidentificacao;'
      ''
      'END //'
      '')
    Delimiter = '//'
    Left = 728
    Top = 416
  end
  object us001322: TUniScript
    SQL.Strings = (
      'UPDATE tem SET temidentificacao='#39'Cancelada'#39' WHERE temcodigo=90//')
    Delimiter = '//'
    Left = 784
    Top = 416
  end
  object us001323: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS RegistraCartaoCCO//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE RegistraCartaoCCO (IN pLteChave int'
      ', IN pClbCodigo int'
      ', IN pCedCodigo int'
      ', IN pHistorico varchar(100)'
      ', IN pDtlChave int'
      ', IN pValor double(16, 2)'
      ', IN pChamada int'
      ', OUT pCcoChave int)'
      'BEGIN'
      ''
      '  CREATE TEMPORARY TABLE IF NOT EXISTS terro ('
      '    Chamada int(11),'
      '    Mensagem varchar(65000)'
      '  ) ENGINE = INNODB;'
      ''
      '  DELETE'
      '    FROM terro'
      '  WHERE chamada = pChamada;'
      ''
      ''
      '  INSERT INTO terro'
      '    VALUES (pChamada, '#39'Erro ao registrar movimento de caixa'#39');'
      ''
      '  SET @ctacodigo = (SELECT'
      '      ctacodigo'
      '    FROM adc'
      '    WHERE adcencerramento IS NULL'
      '    ORDER BY adccodigo DESC LIMIT 1);'
      ''
      '  SET @rdcnrauto = '#39#39';'
      ''
      '  SET @rdcnrauto = (SELECT'
      '      rdcnrauto'
      '    FROM dtl'
      '    WHERE dtlchave = pDtlChave);'
      ''
      '  SET @clbcodigo = (SELECT'
      '      clbcodigo'
      '    FROM lte'
      '    WHERE ltechave = pLteChave);'
      ''
      '  SET @Conciliado = (SELECT'
      '      IF(tctcodigo = 2, 0, 1)'
      '    FROM cta'
      '    WHERE ctacodigo = @ctacodigo);'
      ''
      ''
      '  INSERT INTO cco (ccochave'
      '  , ctacodigo'
      '  , toccodigo'
      '  , cedcodigo'
      '  , clbcodigo'
      '  , tficodigo'
      '  , moecodigo'
      '  , ccoemissao'
      '  , ccovencimento'
      '  , ccohistorico'
      '  , ccovalor'
      '  , ccoconciliado'
      '  , etdcodigo'
      '  , ccofavorecido'
      '  , ccodatamov'
      '  , ccodataregistro'
      '  , ccohoraregistro)'
      
        '    VALUES (@novachave, @ctacodigo, 1, pCedCodigo, pClbCodigo, 9' +
        ', 1, CURRENT_DATE(), CURRENT_DATE(), pHistorico, pValor, @Concil' +
        'iado, 0, '#39#39', CURRENT_DATE(), CURRENT_DATE(), CURRENT_TIME());'
      ''
      '  IF ROW_COUNT() > 0 THEN'
      '    SET pCcoChave = (SELECT'
      '        LAST_INSERT_ID());'
      ''
      ''
      '    UPDATE terro'
      '    SET mensagem = '#39'Erro ao vincular movimento de caixa ao lote'#39
      '    WHERE chamada = pChamada;'
      ''
      ''
      '    INSERT INTO clt (cltchave'
      '    , ccochave'
      '    , ltechave'
      '    , dtlchave)'
      '      VALUES (@novachave, pCcoChave, pLteChave, pDtlChave);'
      '  ELSE'
      '    SET pCcoChave = 0;'
      '  END IF;'
      ''
      'END //')
    Delimiter = '//'
    Left = 840
    Top = 416
  end
  object us001324: TUniScript
    SQL.Strings = (
      'DROP PROCEDURE IF EXISTS AtualizaIndices//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaIndices ()'
      'BEGIN'
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'itm'#39
      '      AND INDEX_NAME = '#39'itm_itochave'#39') THEN'
      ''
      ''
      'ALTER TABLE itm'
      '  ADD INDEX itm_itochave (itochave);'
      ''
      '  END IF;'
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaIndices()//'
      ''
      '')
    Left = 896
    Top = 416
  end
  object us001325: TUniScript
    SQL.Strings = (
      'REPLACE INTO tem(temcodigo, temidentificacao) VALUES'
      '(91, '#39'NF Cancelada'#39' )//'
      ''
      ''
      'UPDATE tem'
      ' SET temidentificacao = '#39'Exclu'#237'do'#39
      ' WHERE temcodigo'#160'='#160'90//'
      ''
      ''
      'REPLACE INTO cdd(cddcodigo, ufscodigo, cddnome) VALUES'
      '('#39'5101837'#39', '#39'51'#39', '#39'Boa Esperan'#231'a do Norte'#39')//')
    Left = 968
    Top = 416
  end
  object us001326: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaIndices//'
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaIndices ()'
      'BEGIN'
      ''
      '  /*Identifica se '#237'ndice N'#195'O EXISTE para poder CRIAR ele*/'
      '  IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.STATISTICS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'etd'#39
      '      AND INDEX_NAME = '#39'IDX_etd_etddoc1'#39') THEN'
      ''
      'ALTER TABLE etd'
      '  ADD INDEX IDX_etd_etddoc1 (etddoc1);'
      ''
      ''
      '  END IF;'
      ''
      'END//'
      ''
      'CALL AtualizaIndices()//'
      ''
      ''
      '')
    Left = 1032
    Top = 416
  end
  object us001327: TUniScript
    SQL.Strings = (
      'dROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'adc'#39
      '      AND column_name = '#39'adcchaveintegracao'#39') THEN'
      ''
      'ALTER TABLE adc'
      '  ADD COLUMN adcchaveintegracao varchar(1000) DEFAULT NULL;'
      ' '
      'end if; '
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'adc'#39
      '      AND column_name = '#39'adcserviconome'#39') THEN'
      ''
      'ALTER TABLE adc'
      '  ADD COLUMN adcserviconome varchar(1000) DEFAULT NULL;'
      ' '
      'end if; '
      ''
      ''
      ''
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'trm'#39
      '      AND column_name = '#39'trmsmarttef'#39') THEN'
      ''
      'ALTER TABLE trm'
      '  ADD COLUMN trmsmarttef integer(2) DEFAULT 0;'
      ' '
      'end if; '
      ''
      ''
      ''
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      'DROP TABLE IF EXISTS pos//'
      ''
      'CREATE TABLE IF NOT EXISTS pos ('
      '  poscodigo int(11) NOT NULL AUTO_INCREMENT,'
      '  posidentificacao varchar(50) DEFAULT NULL,'
      '  posnumeroserie varchar(255) DEFAULT NULL,'
      '  clbcodigo int(11) DEFAULT 0,'
      '  PRIMARY KEY (poscodigo)'
      ')'
      'ENGINE = INNODB'
      'CHARACTER SET utf8mb4'
      'COLLATE utf8mb4_general_ci'
      'COMMENT = '#39'Terminais de venda smartpos'#39
      'ROW_FORMAT = DYNAMIC//'
      ''
      ''
      ''
      '')
    Left = 1088
    Top = 416
  end
  object us001328: TUniScript
    SQL.Strings = (
      'create TABLE IF NOT exists nrt ('
      '  nrtcodigo varchar(100) not null,'
      '  crtcodigo integer not null,'
      '  nrtidentificacao varchar(100) not null,'
      '  nrtcfop_interno varchar(5) not null,'
      '  nrticm_interno numeric(10,3) not null,'
      '  nrtcfop_externo varchar(5) not null,'
      '  nrticm_externo numeric(10,3) not null,'
      '  nrtcombate_pobreza_aliquota numeric(10,3) not null,'
      '  nrtreducao_base_aliquota numeric(10,3) not null,'
      '  cstcodigo varchar(5) not null,'
      '  csicodigo varchar(5) not null,'
      '  cspcodigo varchar(5) not null,'
      '  pis_aliquota numeric(10,3) not null,'
      '  csfcodigo varchar(5) not null,'
      '  cofins_aliquota numeric(10,3) not null,'
      '  nrtclassificacao_is varchar(50) not null,'
      '  nrtclassificacao_cpresumido varchar(50) not null,'
      '  nrtibs_aliquota_estadual numeric(10,3) not null,'
      
        '  nrtibs_aliquota_municipal numeric(10,3) not null default 0.000' +
        ','
      '  nrtdata_inicio date not null,'
      '  nrtdata_fim date null,'
      '  nrtcbs_aliquota numeric(10,3) null,'
      '  nrtreducao_cbs numeric(10,3) null,'
      '  nrtreducao_ibs numeric(10,3) NULL,'
      '  PRIMARY KEY (nrtcodigo)'
      ') //'
      ''
      ''
      'UPDATE cfgmcfg set cfgapuracaoicm=1//'
      ''
      ''
      'dROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'pro'#39
      '      AND column_name = '#39'nrtcodigo'#39') THEN'
      ''
      'ALTER TABLE pro'
      '  ADD COLUMN nrtcodigo varchar(100) DEFAULT NULL;'
      ' '
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      '')
    Left = 512
    Top = 472
  end
  object us001329: TUniScript
    SQL.Strings = (
      'dROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'cfg'#39
      '      AND column_name = '#39'cfgusaeconf'#39') THEN'
      ''
      'ALTER TABLE cfg'
      '  ADD COLUMN cfgusaeconf integer(3) DEFAULT 0;'
      ' '
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      '')
    Left = 568
    Top = 472
  end
  object us001330: TUniScript
    SQL.Strings = (
      'dROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'pos'#39
      '      AND column_name = '#39'poscelularentregador'#39') THEN'
      ''
      '--'
      '-- Alter table "pos"'
      '--'
      'ALTER TABLE pos'
      '  ADD COLUMN poscelularentregador VARCHAR(20) DEFAULT NULL;'
      ' '
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      ''
      ''
      ''
      ''
      ''
      '')
    Left = 624
    Top = 472
  end
  object us001331: TUniScript
    SQL.Strings = (
      'dROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'orc'#39
      '      AND column_name = '#39'orcstatusintegracao'#39') THEN'
      ''
      '--'
      '-- Alter table "orc"'
      '--'
      'ALTER TABLE orc'
      '  ADD COLUMN orcstatusintegracao integer(11)  DEFAULT 0 ;'
      ' '
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      ''
      '')
    Left = 680
    Top = 472
  end
  object us001332: TUniScript
    SQL.Strings = (
      'dROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'orc'#39
      '      AND column_name = '#39'orchoraintegracao'#39') THEN'
      ''
      '--'
      '-- Alter table "orc"'
      '--'
      'ALTER TABLE orc'
      '  ADD COLUMN orchoraintegracao time  DEFAULT null ;'
      ' '
      'end if; '
      ''
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//'
      ''
      '')
    Left = 736
    Top = 472
  end
  object us001333: TUniScript
    SQL.Strings = (
      'DROP VIEW v_imm CASCADE//'
      ''
      'CREATE'
      'DEFINER = '#39'root'#39'@'#39'%'#39
      'VIEW v_imm'
      'AS'
      'SELECT'
      '  `imm`.`immchave` AS `chave`,'
      '  `pro`.`pronome` AS `identificacao`,'
      
        '  LPAD(CAST(`imm`.`immnumepedido` AS char charset utf8), 4, '#39'0'#39')' +
        ' AS `pedido`,'
      
        '  TIME_FORMAT(TIMEDIFF(CURRENT_TIMESTAMP(), `imm`.`immhoraimpres' +
        'so`), '#39'%H:%i'#39') AS `tempo`,'
      '  `ito`.`itochave` AS `item`,'
      
        '  IF(`imm`.`immnumepedido` < 5000, '#39'ENTR'#39', CONCAT('#39'M:'#39', `orc`.`o' +
        'rcmesa`)) AS `destino`,'
      '  `tci`.`tcicodigo` AS `impressora`,'
      '  `sep`.`sepcodigo` AS `setor`,'
      '  `ito`.`procodigo` AS `produto`,'
      '  `ito`.`itoquantidade` AS `quantidade`,'
      '  `ito`.`puncodigo` AS `unidade`,'
      '  `imm`.`immhorapedido` AS `inicio`,'
      '  `ito`.`stocodigo` AS `situacao`,'
      
        '  `pun`.`punmaximoclbproducao` * `ito`.`itoquantidade` AS `maxim' +
        'o`'
      'FROM ((((((((((`pro`'
      '  JOIN `gri`)'
      '  JOIN `ito`)'
      '  JOIN `imm`)'
      '  JOIN `czn`)'
      '  JOIN `clb`)'
      '  JOIN `orc`)'
      '  JOIN `tci`)'
      '  JOIN `mit`)'
      '  JOIN `sep`)'
      '  JOIN `pun`)'
      'WHERE `ito`.`itochave` = `imm`.`itochave`'
      'AND `pro`.`procodigo` = `ito`.`procodigo`'
      'AND `pro`.`grpcodigo` = `gri`.`grpcodigo`'
      'AND `gri`.`sepcodigo` = `sep`.`sepcodigo`'
      'AND `imm`.`cznchave` = `czn`.`cznchave`'
      'AND `czn`.`cznfechamento` IS NULL'
      'AND `orc`.`orcchave` = `ito`.`orcchave`'
      'AND `gri`.`tcicodigo` = `tci`.`tcicodigo`'
      'AND `mit`.`mitcodigo` = `tci`.`mitcodigo`'
      'AND `imm`.`clbcodigo` = `clb`.`clbcodigo`'
      'AND `orc`.`stocodigo` <> 88'
      'AND `ito`.`stocodigo` <> 88'
      'AND `ito`.`puncodigo` = `pun`.`puncodigo`'
      'AND `imm`.`clbcodigoent` = 0'
      'AND `gri`.`gricontrolaproducao` = 1'
      'AND `imm`.`immrecebido` <> 2'
      
        'AND IF(`imm`.`immnumepedido` < 5000, `imm`.`immhoraimprimir` IS ' +
        'NOT NULL, 1)'
      'ORDER BY `imm`.`immchave`//')
    Left = 792
    Top = 472
  end
  object us001334: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF NOT EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'nrt'#39
      '      AND column_name = '#39'nrtcstibscbs'#39') THEN'
      ''
      ''
      ''
      '--'
      '-- Alter table nrt'
      '--'
      'ALTER TABLE nrt'
      '  ADD COLUMN nrtcstibscbs VARCHAR(5) DEFAULT NULL;'
      ''
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Left = 880
    Top = 472
  end
  object us001335: TUniScript
    SQL.Strings = (
      'CREATE TABLE IF NOT EXISTS inr ('
      
        '  inrregra int(11) NOT NULL AUTO_INCREMENT COMMENT '#39'Chave prim'#225'r' +
        'ia da regra fiscal'#39','
      
        '  itmchave int(11) NOT NULL COMMENT '#39'Referencia a chave do item ' +
        'da venda da tabela itm'#39','
      
        '  cst_ibscbs varchar(5) DEFAULT NULL COMMENT '#39'Codigo da Situacao' +
        'o Tribut'#225'ria (CST) do IBS e CBS'#39','
      
        '  class_trib_ibscbs varchar(10) DEFAULT NULL COMMENT '#39'Classifica' +
        #231#227'o tributaria do IBS e CBS'#39','
      
        '  base_calc_ibscbs decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT ' +
        #39'Base de calculo do IBS e CBS'#39','
      
        '  perc_ibs_uf decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39'Perc' +
        'entual IBS para UF de destino'#39','
      
        '  red_aliq_ibs_uf decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39 +
        'Reducao de al'#237'quota IBS UF destino'#39','
      
        '  aliq_efetiva_ibs_uf decimal(15, 2) NOT NULL DEFAULT 0.00 COMME' +
        'NT '#39'Al'#237'quota efetiva IBS UF destino'#39','
      
        '  valor_ibs_uf decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39'Val' +
        'or IBS UF destino'#39','
      
        '  perc_ibs_mun decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39'Per' +
        'centual IBS municipal'#39','
      
        '  red_aliq_ibs_mun decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT ' +
        #39'Reducaoo de al'#237'quota IBS municipal'#39','
      
        '  aliq_efetiva_ibs_mun decimal(15, 2) NOT NULL DEFAULT 0.00 COMM' +
        'ENT '#39'Aliquota efetiva IBS municipal'#39','
      
        '  valor_ibs_mun decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39'Va' +
        'lor IBS municipal'#39','
      
        '  total_ibs_ufmun decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39 +
        'Valor total do IBS estadual mais o IBS municipal'#39','
      
        '  perc_cbs decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39'Percent' +
        'ual do CBS'#39','
      
        '  red_aliq_cbs decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39'Red' +
        'ucao de al'#237'quota do CBS'#39','
      
        '  aliq_efetiva_cbs decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT ' +
        #39'Aliquota efetiva do CBS'#39','
      
        '  valor_cbs decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39'Valor ' +
        'do CBS'#39','
      '  PRIMARY KEY (inrregra),'
      '  INDEX idx_inr_cst (cst_ibscbs),'
      '  INDEX idx_inr_id_item (itmchave),'
      '  INDEX idx_inr_id_item_cst (itmchave, cst_ibscbs),'
      '  CONSTRAINT inr_itm_itmchave FOREIGN KEY (itmchave)'
      
        '  REFERENCES itm (itmchave) ON DELETE RESTRICT ON UPDATE RESTRIC' +
        'T'
      ')'
      'ENGINE = INNODB'
      'AUTO_INCREMENT = 1'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci'
      
        'COMMENT = '#39'Tabela de valores e parametros tributArios para IBS e' +
        ' CBS com liga'#231'ao da tabela itm'#39';'
      ''
      ''
      ''
      ''
      'CREATE TABLE IF NOT EXISTS mnr ('
      
        '  mnrchave int(11) NOT NULL AUTO_INCREMENT COMMENT '#39'Chave primar' +
        'ia do registro de totais'#39','
      
        '  meschave int(11) NOT NULL COMMENT '#39'Referencia a chave da venda' +
        ' da tabela mes'#39','
      
        '  total_base_ibscbs decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT' +
        ' '#39'Base de calculo conjunta para IBS e CBS'#39','
      
        '  total_ibs_uf decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39'Val' +
        'or total do IBS destinado '#224' UF'#39','
      
        '  total_ibs_mun decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39'Va' +
        'lor total do IBS destinado ao municipio'#39','
      
        '  total_ibs_ufmun decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39 +
        'Total do IBS estadual mais o IBS municipal'#39','
      
        '  credito_presumido_ibs decimal(15, 2) NOT NULL DEFAULT 0.00 COM' +
        'MENT '#39'Credito presumido de IBS'#39','
      
        '  total_cbs decimal(15, 2) NOT NULL DEFAULT 0.00 COMMENT '#39'Valor ' +
        'total do CBS na opera'#231#227'o'#39','
      
        '  credito_presumido_cbs decimal(15, 2) NOT NULL DEFAULT 0.00 COM' +
        'MENT '#39'Credito presumido de CBS'#39','
      '  PRIMARY KEY (mnrchave),'
      '  CONSTRAINT mnr_mes_meschave FOREIGN KEY (meschave)'
      
        '  REFERENCES mes (meschave) ON DELETE RESTRICT ON UPDATE RESTRIC' +
        'T'
      ')'
      'ENGINE = INNODB'
      'AUTO_INCREMENT = 1'
      'CHARACTER SET latin1'
      'COLLATE latin1_swedish_ci'
      
        'COMMENT = '#39'Tabela de totais consolidados de IBS e CBS com ligaca' +
        'o'#160'da'#160'tabela'#160'mes'#39';')
    Left = 936
    Top = 480
  end
  object us001336: TUniScript
    SQL.Strings = (
      '-- Ajuste o delimitador para permitir BEGIN...END'
      'DELIMITER //'
      ''
      'DROP PROCEDURE IF EXISTS AtualizaConstraint //'
      ''
      'CREATE PROCEDURE AtualizaConstraint()'
      'BEGIN'
      '  DECLARE v_fk_exists  INT DEFAULT 0;'
      '  DECLARE v_idx_exists INT DEFAULT 0;'
      '  DECLARE v_schema     VARCHAR(64);'
      ''
      '  SET v_schema = DATABASE();'
      ''
      
        '  /* Verifica se a FK '#39'pro_nrt'#39' j'#225' existe na tabela '#39'pro'#39' refere' +
        'nciando '#39'nrt(nrtcodigo)'#39' */'
      '  SELECT COUNT(*)'
      '    INTO v_fk_exists'
      '  FROM information_schema.KEY_COLUMN_USAGE k'
      '  WHERE k.CONSTRAINT_SCHEMA = v_schema'
      '    AND k.TABLE_NAME        = '#39'pro'#39
      '    AND k.CONSTRAINT_NAME   = '#39'pro_nrt'#39
      '    AND k.REFERENCED_TABLE_NAME = '#39'nrt'#39
      '    AND k.COLUMN_NAME       = '#39'nrtcodigo'#39
      '    AND k.REFERENCED_COLUMN_NAME = '#39'nrtcodigo'#39';'
      ''
      '  IF v_fk_exists = 0 THEN'
      
        '    /* Certifique-se de que as tabelas s'#227'o InnoDB e as colunas e' +
        'xistem */'
      '    ALTER TABLE `pro`'
      '      ADD CONSTRAINT `pro_nrt`'
      '      FOREIGN KEY (`nrtcodigo`)'
      '      REFERENCES `nrt` (`nrtcodigo`)'
      '      ON DELETE RESTRICT'
      '      ON UPDATE RESTRICT;'
      '  END IF;'
      ''
      
        '  /* Verifica se o '#237'ndice '#39'mfisituacao'#39' j'#225' existe na tabela '#39'mfi' +
        #39' */'
      '  SELECT COUNT(*)'
      '    INTO v_idx_exists'
      '  FROM information_schema.STATISTICS s'
      '  WHERE s.TABLE_SCHEMA = v_schema'
      '    AND s.TABLE_NAME   = '#39'mfi'#39
      '    AND s.INDEX_NAME   = '#39'mfisituacao'#39';'
      ''
      '  IF v_idx_exists = 0 THEN'
      '    ALTER TABLE `mfi`'
      '      ADD INDEX `mfisituacao` (`mfisituacao`);'
      '  END IF;'
      ''
      'END //'
      ''
      '/* Executa a procedure */'
      'CALL AtualizaConstraint() //'
      ''
      '/* (Opcional) remove a procedure ap'#243's uso */'
      'DROP PROCEDURE IF EXISTS AtualizaConstraint //'
      ''
      '/* Volta o delimitador padr'#227'o */'
      'DELIMITER ;')
    Left = 512
    Top = 520
  end
  object us001337: TUniScript
    SQL.Strings = (
      ''
      'DROP PROCEDURE IF EXISTS AtualizaColunas//'
      ''
      'CREATE DEFINER = '#39'root'#39'@'#39'%'#39
      'PROCEDURE AtualizaColunas ()'
      'BEGIN'
      ''
      'IF  EXISTS (SELECT'
      '        *'
      '      FROM information_schema.COLUMNS'
      '      WHERE TABLE_SCHEMA = DATABASE()'
      '      AND TABLE_NAME = '#39'nrt'#39
      '      AND column_name = '#39'nrtclassificacao_ibscbs'#39') THEN'
      ''
      ''
      ''
      '--'
      '-- Alter table nrt'
      '--'
      'ALTER TABLE nrt'
      '  DROP COLUMN nrtclassificacao_ibscbs;'
      ''
      'end if; '
      ''
      'END//'
      ''
      'CALL AtualizaColunas()//')
    Left = 592
    Top = 520
  end
end
