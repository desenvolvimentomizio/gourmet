unit uFprinciEnt;

interface

uses

  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, uFprinciAte, DBAccess, Uni, Data.DB, Vcl.Menus, System.Actions,
  Vcl.ActnList, MemDS, Vcl.ExtCtrls, UniProvider, MySQLUniProvider, Vcl.Grids,
  Vcl.DBGrids, Vcl.ComCtrls, Vcl.StdCtrls, Vcl.DBCtrls, Vcl.Imaging.pngimage, ufuncoes,
  Vcl.Buttons, Vcl.Themes, System.MaskUtils, StrUtils, uPegaBase,
  System.Diagnostics, DateUtils, frxClass, frxExportImage, Vcl.Mask, DASQLMonitor, UniSQLMonitor,
  IdBaseComponent, IdComponent, IdTCPConnection, IdTCPClient, IdHTTP,
  frxDACComponents, frxUniDACComponents, VirtualDataSet, VirtualTable,
  Vcl.Clipbrd, System.Math, frxExportText, frxExportXML, frxExportXLS,
  frxExportXLSX, frxDMPExport, frxExportHelpers, frxExportHTMLDiv, frxExportCSV,
  frxExportBaseDialog, frxExportPDF, frxChBox, frxGradient, frxChart, frxRich,
  frxCross, frxBarcode, frxDCtrl, frxDBSet;

type
  TGroupBox = class(Vcl.StdCtrls.TGroupBox) // declare this before of your form definition
  public
    procedure Paint; override;
  end;

type
  TFprinciEnt = class(TFprinciAte)
    ActQuantidade: TAction;
    ActAbreVenda: TAction;
    PlDadosAtend: TPanel;
    LbVendedor: TLabel;
    LbOrcChave: TLabel;
    LbQtdItens: TLabel;
    SBSair: TSpeedButton;
    SBAbreVenda: TSpeedButton;
    SBCancelaItem: TSpeedButton;
    SBLimpaAtendimento: TSpeedButton;
    SBDescontoGeral: TSpeedButton;
    SBDescontoItem: TSpeedButton;
    SBFinalizaVenda: TSpeedButton;
    SBClientes: TSpeedButton;
    SBProdutos: TSpeedButton;
    SBQuantidade: TSpeedButton;
    SBAbreCaixa: TSpeedButton;
    SBFechaCaixa: TSpeedButton;
    SpeedButton1: TSpeedButton;
    qprosfnquantidade: TFloatField;
    sbr: TUniQuery;
    sbrsbrcodigo: TIntegerField;
    sbrsbridentificacao: TStringField;
    sbrprocodigo: TIntegerField;
    sbi: TUniQuery;
    sbisbichave: TIntegerField;
    sbiitochave: TIntegerField;
    sbisbrcodigo: TIntegerField;
    sbisbiobs: TStringField;
    isi: TUniQuery;
    isiisichave: TIntegerField;
    isisbichave: TIntegerField;
    isitsicodigo: TIntegerField;
    tsi: TUniQuery;
    tsitsicodigo: TIntegerField;
    tsitsiidentificacao: TStringField;
    litopuncodigo: TIntegerField;
    isiprocodigo: TIntegerField;
    DataSource1: TDataSource;
    sbGrupos: TScrollBox;
    grp: TUniQuery;
    grpgrpcodigo: TIntegerField;
    grpgrpidentificacao: TStringField;
    sbListaProdutos: TScrollBox;
    pro: TUniQuery;
    qprogrpcodigo: TIntegerField;
    plBotoesPedido: TPanel;
    btAlteraPedido: TBitBtn;
    btVerPedido: TBitBtn;
    isiisitipo: TIntegerField;
    isipronome: TStringField;
    isitsiidentificacao: TStringField;
    plPedido: TPanel;
    pedido: TRichEdit;
    PedidoRodaPe: TRichEdit;
    ActPedido: TAction;
    SBConfirmaPedido: TSpeedButton;
    PedidoCabecalho: TRichEdit;
    plIdentificaPedido: TPanel;
    imm: TUniQuery;
    immimmchave: TIntegerField;
    immitochave: TIntegerField;
    immtcicodigo: TIntegerField;
    immimmmodo: TIntegerField;
    immimmhoraimprimir: TDateTimeField;
    plImp: TPanel;
    brg: TUniQuery;
    brgbrdcodigo: TIntegerField;
    brgbrdidentificacao: TStringField;
    bri: TUniQuery;
    bribrichave: TIntegerField;
    briitochave: TIntegerField;
    bribrdcodigo: TIntegerField;
    ActClientesSimplificado: TAction;
    SpeedButton2: TSpeedButton;
    bgr: TUniQuery;
    bgrbrdcodigo: TIntegerField;
    brggrpcodigo: TIntegerField;
    brgbrichave: TIntegerField;
    brgitochave: TIntegerField;
    brgbriincluir: TIntegerField;
    plGrpTituloCardapio: TPanel;
    plTituloCardapio: TPanel;
    plGrpPesquisa: TPanel;
    btLimpaBuscaCardapio: TSpeedButton;
    edBuscaCardapio: TEdit;
    plBotaoVoltarCardapio: TPanel;
    qsbi: TUniQuery;
    isipunprecoav: TFloatField;
    pbri: TUniQuery;
    plRodapeEsquerda: TPanel;
    plRecebeDados: TPanel;
    plCodigo: TPanel;
    plTituloCodigo: TPanel;
    cdbarra: TEdit;
    bMaisItens: TBitBtn;
    Dpro: TDataSource;
    immimmtemporetardo: TIntegerField;
    immimp: TUniQuery;
    immimpimmchave: TIntegerField;
    immimpimmhoraimprimir: TDateTimeField;
    immimpimmtemporetardo: TIntegerField;
    immimpimmmodoimpressao: TIntegerField;
    immimmnumepedido: TIntegerField;
    immimpimmnumepedido: TIntegerField;
    immcznchave: TIntegerField;
    immimpcznchave: TIntegerField;
    immimmhorapedido: TDateTimeField;
    gri: TUniQuery;
    DBGridPro: TDBGrid;
    plDetalheProduto: TPanel;
    plPrecoProduto: TPanel;
    dpun: TUniDataSource;
    pun: TUniQuery;
    DBGridPun: TDBGrid;
    punpuncodigo: TIntegerField;
    punprocodigo: TIntegerField;
    punpunprecoav: TFloatField;
    pununisimbolo: TStringField;
    plIngridientesPro: TPanel;
    Panel3: TPanel;
    mmIngredientes: TMemo;
    isa: TUniQuery;
    btSelecionar: TButton;
    DBGridGrp: TDBGrid;
    dgrp: TUniDataSource;
    plQuantidadePro: TPanel;
    plTituloQuantidadePro: TPanel;
    btMais: TButton;
    btMenos: TButton;
    edQtdaPro: TMaskEdit;
    itoitoobs: TStringField;
    cfgcfgmgoucobraentrega: TIntegerField;
    ActVerEntregas: TAction;
    SpeedButton3: TSpeedButton;
    cfgcfggouentregafutura: TIntegerField;
    sbVerpedidos: TSpeedButton;
    ActVerPedidos: TAction;
    orcorcvias: TIntegerField;
    itoitounidades: TIntegerField;
    ActImprime: TAction;
    ActCarregaPedido: TAction;
    spCarregaPedido: TSpeedButton;
    btalteraritem: TButton;
    sbisbiitem: TIntegerField;
    plUnidades: TPanel;
    edQtdaUni: TEdit;
    immclbcodigo: TIntegerField;
    isiisiquantidade: TIntegerField;
    relgri: TUniQuery;
    gritcicodigo: TIntegerField;
    gritciporta: TStringField;
    grimitidentificacao: TStringField;
    grigripedidoaux: TIntegerField;
    relgrirelarquivo: TBlobField;
    cfgcfgmgouviasorcdelivery: TIntegerField;
    plDireitaDetalhe: TPanel;
    listaasair: TUniQuery;
    PanelJaSairam: TPanel;
    PanelNaoSairam: TPanel;
    PanelTopoSituacaoEntregas: TPanel;
    Panel2: TPanel;
    Splitter1: TSplitter;
    DataSourcelistaasair: TDataSource;
    listaOrcs: TDBGrid;
    listaasairorcchave: TIntegerField;
    listaasairorcdataabert: TDateField;
    listaasairorchoraabert: TTimeField;
    listaasairorcdataencerr: TDateField;
    listaasairorchoraencerr: TTimeField;
    listaasairorcdataentrega: TDateField;
    listaasairorchoraentrega: TTimeField;
    listaasairetdcodigo: TIntegerField;
    listaasairetdidentificacao: TStringField;
    listaasairorcgeral: TFloatField;
    listaasairorcdesconto: TFloatField;
    listaasairorctotal: TFloatField;
    listaasairclbidentificacao: TStringField;
    listaasairorcobs: TStringField;
    listaasairorcnome: TStringField;
    listaasairorcendereco: TStringField;
    listaasairorctelefone: TStringField;
    listaasairpuocodigo: TIntegerField;
    listaasairedrbairro: TStringField;
    listaasairedrendereco: TStringField;
    listaasairpdghoraentrega: TStringField;
    listaasairorcdescrpagto: TStringField;
    listaasairpdgnumero: TStringField;
    listaasairetdidentificacaoent: TStringField;
    listaasairmarca: TIntegerField;
    LabelQtdPedidosaSair: TLabel;
    LabelQtdPedidosJaSaiu: TLabel;
    listajasaiu: TUniQuery;
    DataSourcelistajasaiu: TDataSource;
    listaOrcsSaiu: TDBGrid;
    qsbr: TUniQuery;
    qsbrsbrqtd: TIntegerField;
    ajustaadicionais: TUniQuery;
    plrodapeDireitaDetalhe: TPanel;
    SpeedButton4: TSpeedButton;
    frxUniDACComponents1: TfrxUniDACComponents;
    ingredientes: TUniQuery;
    sabores: TUniQuery;
    saboressbrcodigo: TIntegerField;
    saboressbridentificacao: TStringField;
    saboresprocodigo: TIntegerField;
    saboresisaingredientes: TStringField;
    vch: TUniQuery;
    ovc: TUniQuery;
    vchvchchave: TIntegerField;
    vchvchdataemissao: TDateField;
    vchvchsituacao: TIntegerField;
    vchvchvoucher: TStringField;
    vchvchtipo: TIntegerField;
    vchvchmodouso: TIntegerField;
    vchvchdatavalidade: TDateField;
    vchvchvalor: TFloatField;
    vchvchpercentual: TFloatField;
    vchetdcodigo: TIntegerField;
    vchvchdatauso: TDateField;
    ovcorcchave: TIntegerField;
    ovcovcchave: TIntegerField;
    ovcvchchave: TIntegerField;
    ovcitochave: TIntegerField;
    vchprocodigo: TIntegerField;
    vchpuncodigo: TIntegerField;
    cfgcfgmgoufinalizadelivery: TIntegerField;
    cfgcfgmgouctadelivery: TIntegerField;
    orcoricodigo: TIntegerField;
    immpdscodigo: TIntegerField;
    orcpdscodigo: TIntegerField;
    listajasaiuorcchave: TIntegerField;
    listajasaiuorcdataabert: TDateField;
    listajasaiuorchoraabert: TTimeField;
    listajasaiuorcdataencerr: TDateField;
    listajasaiuorchoraencerr: TTimeField;
    listajasaiuetdcodigo: TIntegerField;
    listajasaiuetdidentificacao: TStringField;
    listajasaiuclbidentificacao: TStringField;
    listajasaiuorcgeral: TFloatField;
    listajasaiuorcdesconto: TFloatField;
    listajasaiuorctotal: TFloatField;
    listajasaiuorcobs: TStringField;
    listajasaiuorcdescrpagto: TStringField;
    listajasaiuorcnome: TStringField;
    listajasaiuorcendereco: TStringField;
    listajasaiuorctelefone: TStringField;
    listajasaiupuocodigo: TIntegerField;
    listajasaiuedrbairro: TStringField;
    listajasaiuedrendereco: TStringField;
    listajasaiupdghoraentrega: TStringField;
    listajasaiupdgnumero: TStringField;
    listajasaiuetdidentificacaoent: TStringField;
    listajasaiuorcretorno: TStringField;
    listajasaiutempoemproducao: TStringField;
    listajasaiutempoementrega: TStringField;
    listajasaiumoccodigo: TIntegerField;
    listajasaiupdsidentificacao: TStringField;
    SpeedButton5: TSpeedButton;
    cfgcfgmgoucontrolaentrega: TIntegerField;
    verificacadastro: TUniQuery;
    verificacadastroetdcodigo: TIntegerField;
    verificacadastroetdidentificacao: TStringField;
    verificacadastroedrcodigo: TIntegerField;
    verificacadastroedrrua: TStringField;
    verificacadastroedrnumero: TStringField;
    verificacadastroetfcodigo: TIntegerField;
    verificacadastroetftelefone: TStringField;
    verificacadastroedrbairro: TStringField;
    ActImportaAiqFome: TAction;
    etdimp: TUniQuery;
    etdimpetdcodigo: TIntegerField;
    etdimpetdidentificacao: TStringField;
    etdimpetdapelido: TStringField;
    etdimpetddeletar: TIntegerField;
    etdimptpecodigo: TIntegerField;
    etdimpetddatacad: TDateField;
    etdimpetddataalt: TDateField;
    etdimpetddoc1: TStringField;
    etdimptsecodigo: TIntegerField;
    etdimpetdcarga: TIntegerField;
    etdimpetdativo: TIntegerField;
    etdimpetddescsituacao: TStringField;
    etdimpetdsped: TIntegerField;
    etdimpetdobs: TStringField;
    etdimpetdsuframa: TStringField;
    etdimptcbcodigo: TIntegerField;
    etdimpetdnfemodelos: TStringField;
    etdimpgrtcodigo: TIntegerField;
    etdimpatvcodigo: TIntegerField;
    etdimpjsncodigo: TIntegerField;
    etdimpetdpedidoobrigatorio: TIntegerField;
    etdimpetdregime: TIntegerField;
    edrimp: TUniQuery;
    edrimpedrcodigo: TIntegerField;
    edrimptedcodigo: TIntegerField;
    edrimpetdcodigo: TIntegerField;
    edrimpedrrua: TStringField;
    edrimpedrnumero: TStringField;
    edrimpedrcxpostal: TStringField;
    edrimpedrcomple: TStringField;
    edrimpedrbairro: TStringField;
    edrimpcddcodigo: TStringField;
    edrimpedrinscest: TStringField;
    edrimpedrcep: TStringField;
    edrimpedrinsestst: TStringField;
    edrimpufscodigo: TStringField;
    edrimpedrobs: TStringField;
    edrimpedrinscmun: TStringField;
    edrimpedritem: TIntegerField;
    edrimpedrnomefazenda: TStringField;
    edrimpedrrazaofazenda: TStringField;
    edrimpedrativo: TIntegerField;
    edrimpjsncodigo: TIntegerField;
    etvimp: TUniQuery;
    etvimpetvcodigo: TIntegerField;
    etvimpetdcodigo: TIntegerField;
    etvimptvicodigo: TIntegerField;
    etvimppcgcodigo: TIntegerField;
    etfimp: TUniQuery;
    etfimpetfcodigo: TIntegerField;
    etfimpetdcodigo: TIntegerField;
    etfimpttfcodigo: TIntegerField;
    etfimpetftelefone: TStringField;
    etfimpetfcontato: TStringField;
    etfimpetfdepartamento: TStringField;
    etfimpetfativo: TIntegerField;
    etfimpjsncodigo: TIntegerField;
    etfimpetfsenha: TStringField;
    etfimpetfpontuacao: TIntegerField;
    baiimp: TUniQuery;
    baiimpbaicodigo: TIntegerField;
    baiimpbaiidentificacao: TStringField;
    baiimpprocodigo: TIntegerField;
    proimp: TUniQuery;
    proimpprocodigo: TIntegerField;
    proimppronome: TStringField;
    proimptpoidentificacao: TStringField;
    proimpmaridentificacao: TStringField;
    proimpgrpidentificacao: TStringField;
    proimpicmaliquotas: TStringField;
    proimpproncm: TStringField;
    proimpprosaldo: TFloatField;
    proimpprosaldodisp: TFloatField;
    proimpsipcodigo: TIntegerField;
    proimpproobs: TStringField;
    proimpproreferencia: TStringField;
    proimpunisimbolo: TStringField;
    proimppunprecoav: TFloatField;
    proimppunprecoap: TFloatField;
    proimptpocodigo: TIntegerField;
    proimpproanpcodigo: TIntegerField;
    proimpenpcodigo: TIntegerField;
    proimpenpendereco: TStringField;
    proimppropedecomple: TIntegerField;
    proimpcpbcodbalanca: TIntegerField;
    proimpgracodigo: TIntegerField;
    proimpdpridentificacao: TStringField;
    proimpproconsolidado: TIntegerField;
    proimppunpercav: TFloatField;
    proimppunpercap: TFloatField;
    proimppuncusto: TFloatField;
    proimpgrpcodigo: TIntegerField;
    proimpcstcodigo: TStringField;
    proimpprocest: TStringField;
    proimppuncodigo: TIntegerField;
    orcorcnumeropedido: TStringField;
    adiimp: TUniQuery;
    isiimp: TUniQuery;
    isiimpisichave: TIntegerField;
    isiimpsbichave: TIntegerField;
    isiimptsicodigo: TIntegerField;
    isiimpprocodigo: TIntegerField;
    isiimpisitipo: TIntegerField;
    isiimpitochave: TIntegerField;
    isiimpisiitem: TIntegerField;
    isiimpisiquantidade: TIntegerField;
    isiimpisiacrescimo: TFloatField;
    adiimpprocodigo: TIntegerField;
    adiimppronome: TStringField;
    adiimppunprecoav: TFloatField;
    adiimpgrpcodigo: TIntegerField;
    adiimptpocodigo: TIntegerField;
    adiimpsipcodigo: TIntegerField;
    vchvchetdemissor: TIntegerField;
    SpeedButton6: TSpeedButton;
    pco: TUniQuery;
    itocombo: TUniQuery;
    itopcocodigo: TIntegerField;
    litopcocodigo: TIntegerField;
    uqsbr: TUniQuery;
    Duqsbr: TDataSource;
    uqsbrprocodigo: TIntegerField;
    uqsbrpronome: TStringField;
    uqsbrprocomposto: TStringField;
    uqsbrpuncodigo: TIntegerField;
    ActChamaSenha: TAction;
    sbChamaSenha: TSpeedButton;
    etdedrcomple: TStringField;
    etdedrobs: TStringField;
    lbnumepedido: TLabel;
    cfgcfgctacodigopix: TIntegerField;
    listaasairstocodigo: TIntegerField;
    frxReport: TfrxReport;
    frxDados: TfrxDBDataset;
    DSdados: TUniDataSource;
    frxUniDACComponents: TfrxUniDACComponents;
    frxDialogControls: TfrxDialogControls;
    frxBarCodeObject: TfrxBarCodeObject;
    frxCrossObject: TfrxCrossObject;
    frxRichObject1: TfrxRichObject;
    frxChartObject1: TfrxChartObject;
    frxGradientObject1: TfrxGradientObject;
    frxCheckBoxObject1: TfrxCheckBoxObject;
    frxPDFExport1: TfrxPDFExport;
    frxCSVExport1: TfrxCSVExport;
    frxHTML5DivExport1: TfrxHTML5DivExport;
    frxDotMatrixExport1: TfrxDotMatrixExport;
    frxXLSXExport1: TfrxXLSXExport;
    frxXLSExport1: TfrxXLSExport;
    frxXMLExport1: TfrxXMLExport;
    frxSimpleTextExport1: TfrxSimpleTextExport;
    orccznchave: TIntegerField;
    orcccxchave: TIntegerField;
    orcbaicodigo: TIntegerField;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure ActQuantidadeExecute(Sender: TObject);
    procedure ActAbreVendaExecute(Sender: TObject);
    procedure ActLimpaAtendimentoExecute(Sender: TObject);
    procedure ActCancelaItemExecute(Sender: TObject);
    procedure ActClientesExecute(Sender: TObject);
    procedure ActProdutosExecute(Sender: TObject);
    procedure cdbarraKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure cdbarraKeyPress(Sender: TObject; var Key: Char);
    procedure listaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure ActFinalizaVendaExecute(Sender: TObject);
    procedure DlitoDataChange(Sender: TObject; Field: TField);
    procedure FormKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure listaDblClick(Sender: TObject);
    procedure btAlteraPedidoClick(Sender: TObject);
    procedure btVerPedidoClick(Sender: TObject);
    procedure ActPedidoExecute(Sender: TObject);
    procedure ActClientesSimplificadoExecute(Sender: TObject);
    procedure edBuscaCardapioKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btLimpaBuscaCardapioClick(Sender: TObject);
    procedure plBotaoVoltarCardapioClick(Sender: TObject);
    procedure DproDataChange(Sender: TObject; Field: TField);
    procedure btSelecionarClick(Sender: TObject);
    procedure DBGridGrpDblClick(Sender: TObject);
    procedure btMaisClick(Sender: TObject);
    procedure btMenosClick(Sender: TObject);
    procedure DBGridProDblClick(Sender: TObject);
    procedure DBGridProKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGridGrpKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGridPunKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure orcAfterInsert(DataSet: TDataSet);
    procedure ActVerEntregasExecute(Sender: TObject);
    procedure ActVerPedidosExecute(Sender: TObject);
    procedure dpunDataChange(Sender: TObject; Field: TField);
    procedure edQtdaUniChange(Sender: TObject);
    procedure btMenosUniClick(Sender: TObject);
    procedure btMaisUniClick(Sender: TObject);
    procedure ActImprimeExecute(Sender: TObject);
    procedure ActCarregaPedidoExecute(Sender: TObject);
    procedure btalteraritemClick(Sender: TObject);
    procedure ActDescontoItemExecute(Sender: TObject);
    procedure ActDescontoGeralExecute(Sender: TObject);
    procedure SpeedButton4Click(Sender: TObject);
    procedure listaOrcsMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure listaOrcsSaiuMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure DataSourcelistaasairDataChange(Sender: TObject; Field: TField);
    procedure DataSourcelistajasaiuDataChange(Sender: TObject; Field: TField);
    procedure listaOrcsTitleClick(Column: TColumn);
    procedure listaOrcsSaiuTitleClick(Column: TColumn);
    procedure saboresCalcFields(DataSet: TDataSet);
    procedure SpeedButton5Click(Sender: TObject);
    procedure DBGridProKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGridGrpKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure PedidoCabecalhoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure pedidoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure PedidoRodaPeKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btAlteraPedidoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btVerPedidoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure relogioTimer(Sender: TObject);
    procedure ActReimprimeComprovanteExecute(Sender: TObject);
    procedure ActChamaSenhaExecute(Sender: TObject);
    procedure itoAfterInsert(DataSet: TDataSet);
    procedure orcBeforePost(DataSet: TDataSet);
    procedure listaOrcsDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure FormDblClick(Sender: TObject);
  private
    procedure Ajustabotoes(Situacao: Boolean);
    procedure AtualizaStatusAtend;
    procedure recalculaTotal;
    function IncluirNovoItem(Produto, Embalagem: Integer; Variacao: Integer = 0; Quantidade: Double = 0; pcocodigo: Integer = 0): Boolean; Override;
    function IncluirNovoItemChave(Produto, Embalagem: Integer; Variacao: Integer = 0; Quantidade: Double = 0): Integer;
    function IncluirNovoItemCombo(Produto, Embalagem: Integer; Variacao: Integer = 0; Quantidade: Double = 0; pcocodigo: Integer = 0): Integer;
    function IncluirNovoItemImportado(Produto, Embalagem: Integer; Variacao: Integer = 0; Quantidade: Double = 0; vlBordas: string = '';
      vObsItem: string = ''; vValorUnitario: Double = 0): Integer;
    procedure Crianovoorc;
    procedure Mostraclienteselecionado;
    procedure Mostrapainelcliente;
    procedure MontaBotoesGrupos;
    procedure MontaBotoesProdutos(vGrpCodigo: Integer; vGrpIdentificacao: string);
    procedure MontaBotoesProdutosNova(vGrpCodigo: Integer; vGrpIdentificacao: string);
    procedure btMostraProdutosGrupoclick(Sender: TObject);
    procedure btSelecionaProdutoClick(Sender: TObject);
    procedure btVoltaParaGruposClick(Sender: TObject);
    procedure MontaTextoPedido;
    procedure CriaPedidoGourmet;
    procedure AjustaHoraImprimir(vOrcchave: string);
    function CarregaFrame(pacote: string; destino: TPanel; conexao: tuniconnection): thandle;
    procedure VoltaCardapio;
    procedure MostraTodosProdutos;
    procedure IncluiValorEntrega(vlEtdCodigo, vlEdrCodigo: string);
    function GetBotoesAtivosImpre: String; override;
    procedure MostraComplementoProduto(vItoChave: Integer);
    procedure AtualizaListasdePedidos;
    function AjustaNumeroItem: Integer;
    function ProcessaVendas(vOrcchave: string; vAFaturar: Boolean = false): string;
    function Finaliza(Vchave: String; vMostrarLote: Boolean = false): String;
    procedure ProcessaTaclasRapidas(Key: Word; Shift: TShiftState);
    procedure SelecionaSabor(vSbrCodigo: string; vlNomeTit: string; vTipo: Integer = 0);

    procedure CarregaCabecalhoPedido(vTexto: TstringList);
    procedure ChamaSenha;
    procedure AjustaNumeroPedidoAtual(var vlNumePedidoAtual: string);
    procedure ImprimirComprovanteVenda(vConexao: tuniconnection; vOrcchave, vDirRelat, vImpressora: String; vTipoImpressao: Integer);
    function LocalImprimir(conexao: tuniconnection; Dados: TUniDataSource; DirRelatorio: String; TipoImpressao: Integer; Impressora: String = '';
      vUsuCodigo: string = ''): String;
    function ImpressaoInterna(AOwner: TComponent; conexao: tuniconnection; vtabela: TUniDataSource; DirRelatorio: String; Impressora: String = '';
      vUsuCodigo: string = ''): string;

    { Private declarations }

  public
    { Public declarations }
    vlPackopm: cardinal;

    vpbaicodigo: string;
    vpccxchave: string;
    vpPedidoChamar: string;
    vpDataAberturaCZN: string;
    vpCombo: Double;
    vpQtCombos: Integer;
    vpItochave: Integer;
    vpItoUnidades: Double;
    vpCznChave: string;
    vpTelCodigo: String;
    vpImmNumePedido: string;
    vpImprimiuECF: Boolean;
    vpImprimiuDAV: Boolean;
    vpImprimiuNFCe: Boolean;
    vpImprimiuNFE: Boolean;

    vpGrpCodigo: Integer;
    vpFinalizar: string;
    vpRetiraBalcao: string;
    vpOriCodigo: string;
    vplValorLiquidoOp: Double;
    vpOrcChaveReimprime: string;

    vpTeclaFinalizador: Integer;
    vpValorFinalizador: Double;
    vpTotalAcrescimoav: Double;

    vpNrPedidoAiqFome: string;
    vpHoraPedido: string;
    vpDataPedido: string;

    vPetdcodigo: string;
    vPetdidentificacao: string;
    vPedrcodigo: string;
    vPedrrua: string;
    vPedrnumero: string;
    vPetfcodigo: string;
    vPetftelefone: string;
    vPedrbairro: string;
    vpEdrComplemento: string;

  end;

  TMoniImp = function(AOwner: TComponent; Parente: TWinControl; conexao: tuniconnection; vCznChave: string): TFrame;

var
  FprinciEnt: TFprinciEnt;

const
  IntegerSet = [#33 .. #47, #58 .. #255];
  StringSet = [#46 .. #57];

implementation

{$R *.dfm}

uses uBuscaProduto, ulunidadesent, uforcfpagtoent, ufivlinhacomplpro,
  ufpedidos, ufunidades, ufListaItens, ufSabores, ufChamarSenha, ulunidades;

function ExtractStringsOnly(_Separators: TSysCharSet; const Str: String): String;
Var
  lista: TStrings;
begin
  lista := TstringList.Create;
  try
    ExtractStrings(_Separators, [], pchar(Str), lista);
    lista.StrictDelimiter := True;
    lista.QuoteChar := #0;
    result := StringReplace(lista.DelimitedText, lista.Delimiter, EmptyStr, [rfReplaceAll]);
  finally
    lista.Free;
  end;
end;

procedure TrimAppMemorySize;
var
  MainHandle: thandle;
begin
  try
    MainHandle := OpenProcess(PROCESS_ALL_ACCESS, false, GetCurrentProcessID);
    SetProcessWorkingSetSize(MainHandle, $FFFFFFFF, $FFFFFFFF);
    CloseHandle(MainHandle);
  except
  end;
  Application.ProcessMessages;
end;

(* Chamada exportada para carga da BPL *)
procedure MainForm(AOwner: TApplication);
begin
  FprinciEnt := TFprinciEnt.Create(AOwner);
end;

exports MainForm;

type
  { expor propriedades e metodso privadas e protegindos do dbgrid }
  TFriendly = class(TCustomDBGrid)
  published
    property DefaultRowHeight;
  end;

  TCellGrid = class(TCustomGrid);

  { hifenizar }

  { TGroupBox }

procedure TGroupBox.Paint;
var
  H: Integer;
  R: TRect;
  Flags: Longint;
  CaptionRect, OuterRect: TRect;
  Size: TSize;
  Box: TThemedButton;
  Details: TThemedElementDetails;
begin
  with Canvas do
  begin
    Font := Self.Font;

    if ThemeControl(Self) then
    begin
      if Text <> '' then
      begin
        GetTextExtentPoint32(Handle, pchar(Text), length(Text), Size);
        CaptionRect := Rect(0, 0, Size.cx, Size.cy);

        if not UseRightToLeftAlignment then
          OffsetRect(CaptionRect, 8, 0)
        else
          OffsetRect(CaptionRect, Width - 8 - CaptionRect.Right, 0);
      end
      else
        CaptionRect := Rect(0, 0, 0, 0);

      OuterRect := ClientRect;
      OuterRect.Top := (CaptionRect.Bottom - CaptionRect.Top) div 2;
      with CaptionRect do
        ExcludeClipRect(Handle, Left, Top, Right, Bottom);
      if Enabled then
        Box := tbGroupBoxNormal
      else
        Box := tbGroupBoxDisabled;
      Details := ThemeServices.GetElementDetails(Box);
      // Draw the themed frame
      ThemeServices.DrawElement(Handle, Details, OuterRect);
      SelectClipRgn(Handle, 0);
      if Text <> '' then
      begin
        Font.Name := 'Tahoma';
        Font.Size := 11;
        Font.Style := [fsBold];
        H := TextHeight('0');
        if not UseRightToLeftAlignment then
          R := Rect(8, 0, 0, H)
        else
          R := Rect(R.Right - Canvas.TextWidth(Text) - 8, 0, 0, H);
        Flags := DrawTextBiDiModeFlags(DT_SINGLELINE);
        // Now using the Windows.DrawText
        DrawText(Handle, pchar(Text), length(Text), R, Flags or DT_CALCRECT);
        if Tag > 0 then
          Font.Color := clwhite; // background color of the caption

        Brush.Color := Color; // background color of the caption
        DrawText(Handle, pchar(Text), length(Text), R, Flags);
      end;
    end
    else
      inherited; // if the control is not themed then use the original paint method.
  end;
end;

function PosaDireita(Const Letra: string; Const Texto: String): Integer;

Var
  i: Integer;
  S: String;
begin
  result := 0;
  for i := length(Texto) - 1 downto 0 do
  begin
    S := Copy(Texto, i, 1);
    if S = Letra then
    begin
      result := i;
    end;
  end;
end;

procedure ExecuteAndWait(const aCommando: string);
var
  tmpStartupInfo: TStartupInfo;
  tmpProcessInformation: TProcessInformation;
  tmpProgram: String;
begin
  tmpProgram := trim(aCommando);
  FillChar(tmpStartupInfo, SizeOf(tmpStartupInfo), 0);
  with tmpStartupInfo do
  begin
    cb := SizeOf(TStartupInfo);
    wShowWindow := SW_HIDE;
  end;

  if CreateProcess(nil, pchar(tmpProgram), nil, nil, True, CREATE_NO_WINDOW, nil, nil, tmpStartupInfo, tmpProcessInformation) then
  begin
    // loop every 10 ms
    while WaitForSingleObject(tmpProcessInformation.hProcess, 10) > 0 do
    begin
      Application.ProcessMessages;
    end;
    CloseHandle(tmpProcessInformation.hProcess);
    CloseHandle(tmpProcessInformation.hThread);
  end
  else
  begin
    RaiseLastOSError;
  end;
end;

function TFprinciEnt.AjustaNumeroItem: Integer;
var
  VlNumeroItem: Integer;
begin
  lito.DisableControls;
  lito.First;
  VlNumeroItem := 0;
  while not lito.Eof do
  begin
    consulta.Close;
    consulta.SQL.Text := 'select procodigo from ito where ito.procodigo=' + litoprocodigo.AsString + ' and ito.orcchave=' + litoorcchave.AsString +
      ' and ito.procodigo not in (select procodigo from bai) ';
    consulta.Open;

    if not consulta.IsEmpty then
    begin
      VlNumeroItem := VlNumeroItem + 1;
    end;

    lito.Next;
  end;

  lito.EnableControls;

  result := VlNumeroItem;
end;

function TFprinciEnt.IncluirNovoItemImportado(Produto, Embalagem: Integer; Variacao: Integer = 0; Quantidade: Double = 0; vlBordas: string = '';
  vObsItem: string = ''; vValorUnitario: Double = 0): Integer;
Var
  VProCodigo: Integer;
  VUniCodigo: Integer;
  vItoChave: Integer;

  (* Variáveis para tratar novo item no orçamento *)
  VNovoItem: Boolean;
  VEstoqueDisponivel: Boolean; // Recebe retorno que identifica se produto tem saldo disponível
  VQuantidade: Double; // Recebe quantidade para ser lançada no novo item
  VQuantidadeTotal: Double;
  VTextoQuantidade: String; // Utilizada quando produto tem saldo positivo menor que um
  VPodeQuantidade: Boolean; // Utilizada quando produto tem saldo positivo menor que um
  VMensagem: String; // Utilizada quando produto tem saldo positivo menor que um

  vlTecnico: String; // Identifica o técnico resposável pelo serviço
  vlVariacao: String;
  i: Integer;
Begin
  Try
    result := -1;
    consulta.Close;
    consulta.SQL.Text := 'select cznchave, cznabertura from czn where cznfechamento IS null order by cznchave limit 1';
    consulta.Open;

    if consulta.IsEmpty then
    begin
      ShowMessage('Atenção:' + #13 + #13 + 'A Cozinha não esta aberta, solicite a abertura da Cozinha!');
      Application.Terminate;
    end
    else
    begin

      vpCznChave := consulta.Fields[0].AsString;
      vpDataAberturaCZN := Copy(consulta.Fields[1].AsString, 1, 10);
    end;

    lito.DisableControls;
    Try
      If (Produto <> 0) Then
      Begin
        qpro.Close;
        qpro.Params[0].AsInteger := Produto;
        qpro.FilterSQL := '';
        qpro.Open;

        if qpro.IsEmpty then
          Exit;

        qsbi.Close;
        qsbi.Params[0].AsInteger := Produto;
        qsbi.Open;

        qsbr.Close;
        qsbr.Params[0].AsInteger := Produto;
        qsbr.Open;

        // Verifica se o item está inativo e avisa usuário.
        if qprosipcodigo.AsInteger = 2 then
        begin
          Application.MessageBox(pchar('Produto desativado não pode ser vendido.'), 'Produto Inativo', MB_OK + MB_DEFBUTTON1 + MB_ICONWARNING);
          Exit;
        end;

        // Identifica se item tem mais de uma unidade de venda
        If (qpro.RecordCount > 1) or (qsbrsbrqtd.AsInteger > 0) or (qsbi.RecordCount > 0) Then
          if (qpro.Locate('puncodigo', Embalagem, [])) then
          begin

            If (Not Ito.Active) Then
            Begin
              Ito.Params[0].AsInteger := StrToInt(vpOrcChave);
              Ito.Open;
            End;
            qpro.First;

            Ito.Append;
            itotdecodigo.AsInteger := orctdecodigo.AsInteger;
            itoorcchave.AsInteger := orcorcchave.AsInteger;
            itostocodigo.AsInteger := Orcstocodigo.AsInteger;
            itoitoitem.AsInteger := AjustaNumeroItem + 1;
            itoitodescontoav.AsFloat := 0;
            itoitodescontoap.AsFloat := 0;
            itoprocodigo.AsInteger := Produto;
            itoitounidades.AsFloat := vpItoUnidades;
            itoitoobs.AsString := vObsItem;
            vpItoUnidades := 0;

            itoitovalorav.AsFloat := 0;

            itoitocontendo.AsFloat := qpropunmultiplicador.AsFloat;
            itopuncodigo.AsInteger := qpropuncodigo.AsInteger;
            itounicodigo.AsInteger := qprounicodigo.AsInteger;
            VUniCodigo := 1;

            if Quantidade <> 0 then
            begin
              if sbr.RecordCount > 1 then
              begin
                itoitoquantidade.AsFloat := VQuantidade;
              end
              else
              begin
                itoitoquantidade.AsFloat := Quantidade;
              end;
            end
            else if vpQuantidade <> 0 then
              itoitoquantidade.AsFloat := vpQuantidade

            else
              itoitoquantidade.AsFloat := 1;

            itoitototalav.AsFloat := 0;

            itoitosaldoav.AsFloat := 0;

            itoitovalorap.AsFloat := 0;

            itoitototalap.AsFloat := 0;
            itoitosaldoap.AsFloat := 0;
            Ito.Post;
            vItoChave := Self.itoitochave.AsInteger;

            Application.CreateForm(Tlunidadesent, Lunidadesent);

            If (qsbi.RecordCount > 0) Then
              Lunidadesent.vpTipoLista := 'Ingredientes'
            else
              Lunidadesent.vpTipoLista := 'Sabores';

            Lunidadesent.psituacao.Caption := 'Incluindo';
            Lunidadesent.vpOrcChave := Self.vpOrcChave;

            Lunidadesent.Dqpro.DataSet := qpro;

            sbr.Close;
            sbr.Params[0].AsInteger := Self.qprogrpcodigo.AsInteger;
            sbr.Open;

            sbi.Close;
            sbi.Params[0].AsInteger := vItoChave;
            sbi.Open;

            if sbr.Locate('procodigo', itoprocodigo.AsInteger, []) then
            begin
              SelecionaSabor(sbrsbrcodigo.AsString, sbrsbridentificacao.AsString, 1);
            end;

            bgr.Close;
            bgr.Params[0].AsInteger := Self.qprogrpcodigo.AsInteger;
            bgr.Open;

            bgr.First;
            while not bgr.Eof do
            begin

              bri.Close;
              bri.Params[0].AsInteger := vItoChave;
              bri.Params[1].AsInteger := bgrbrdcodigo.AsInteger;
              bri.Open;

              if bri.IsEmpty then
                bri.Append
              else
                bri.Edit;

              briitochave.AsInteger := vItoChave;
              bribrdcodigo.AsInteger := bgrbrdcodigo.AsInteger;
              bri.Post;

              bgr.Next;

            end;

            brg.Close;
            brg.Params[0].AsInteger := Self.qprogrpcodigo.AsInteger;
            brg.Params[1].AsInteger := vItoChave;
            brg.Open;

            if brg.Locate('brdidentificacao', vlBordas, [LOCASEINSENSITIVE]) then
            begin

              brg.Edit;
              brg.FieldByName('briincluir').AsString := '1';
              brg.Post;

            end;

            tsi.Close;
            tsi.Open;

            { INICIO visualicao de bordas }

            consulta.Close;
            consulta.SQL.Text := 'select grpcodigo from brg where grpcodigo=' + qprogrpcodigo.AsString;
            consulta.Open;

            if Ito.Locate('itochave', vItoChave, []) then
            begin

              VQuantidade := Self.itoitoquantidade.AsFloat;
              lito.Close;
              lito.ParamByName('orcchave').AsString := vpOrcChave;
              lito.ParamByName('flacodigo').AsInteger := ACESSO.Filial;
              lito.Open;
              recalculaTotal;
            end;
            btVerPedido.Click;

          end;

        (* Identifica se o produto possui Grade e se Variação não foi localizada *)
        if (qprogracodigo.AsInteger > 0) and (Variacao <= 0) then
        begin
          vlVariacao := MostraLista('mvrp', ACESSO.Usuario.ToString, inttostr(Produto));

          if vlVariacao = '' then
            Exit;

          Variacao := StrToInt(vlVariacao);
        end;

        VProCodigo := qproprocodigo.AsInteger;
        VUniCodigo := qprounicodigo.AsInteger;

        lista.Visible := True;
        plDireitaDetalhe.Visible := True;

        VNovoItem := True;

        If (VNovoItem) Then
        Begin
          Try

            if vpQuantidade <> 0 then
              VQuantidade := vpQuantidade
            else if VQuantidade = 0 then
            begin
              if Quantidade = 0 then
                VQuantidade := 1
              else
                VQuantidade := Quantidade;

            end;

            vpQuantidade := 0;

            // Verifica se produto tem saldo positivo menor que um.
            if (qproprosaldodisp.AsFloat > 0) and (qproprosaldodisp.AsFloat < 1) then
            begin
              VMensagem := 'Produto possui apenas ' + Format('%2.4n', [qproprosaldodisp.AsFloat]);
              VMensagem := VMensagem + ' de saldo disponível!';
              VMensagem := VMensagem + #13 + #13 + 'Por favor, indique a quantidade a ser vendida a seguir.';

              Application.MessageBox(pchar(VMensagem), pchar('Informação'), MB_OK + MB_ICONINFORMATION);
              VQuantidade := qproprosaldodisp.AsFloat;

              repeat
                VPodeQuantidade := false;
                VTextoQuantidade := '0';

                InputQuery('Quantidade', 'Informe a quantidade:', VTextoQuantidade);

                try
                  VQuantidade := StrToFloat(VTextoQuantidade);
                  if VQuantidade > 0 then
                    VPodeQuantidade := True;
                except
                  VPodeQuantidade := false;
                end;

              until (VPodeQuantidade);
            end;

            // Soma quantidade total do item se tiver lançado no orçamento com outra unidade.
            VQuantidadeTotal := VQuantidade + QuantiTotalItemOrc(VProCodigo, VUniCodigo);

            // Verifica se produto tem saldo suficiente.
            VEstoqueDisponivel := PermiteQuantidade(VProCodigo, VUniCodigo, VQuantidadeTotal);

          except
            on e: Exception do
            begin
              Application.MessageBox(pchar('Erro ao verificar quantidade do produto: ' + inttostr(VProCodigo) + #13 + #13 + 'Mensagem: ' + e.Message),
                'Erro', MB_OK + MB_DEFBUTTON1 + MB_ICONERROR);

              SalvarLogErro(e.Message, e.StackTrace);

              lito.EnableControls;
            end;
          end;

          Case VEstoqueDisponivel of
            True:
              begin

                If (Not Ito.Active) Then
                Begin
                  Ito.Params[0].AsInteger := StrToInt(vpOrcChave);
                  Ito.Open;
                End;
                if Ito.Locate('itochave', vItoChave, []) then
                  Ito.Edit
                else
                  Ito.Append;

                itotdecodigo.AsInteger := orctdecodigo.AsInteger;
                itoorcchave.AsInteger := orcorcchave.AsInteger;
                itostocodigo.AsInteger := Orcstocodigo.AsInteger;
                if Ito.State = dsinsert then
                begin
                  itoitoitem.AsInteger := AjustaNumeroItem + 1;
                end;
                itoitodescontoav.AsFloat := 0;
                itoitodescontoap.AsFloat := 0;
                itoprocodigo.AsInteger := VProCodigo;

                if vValorUnitario = 0 then
                begin
                  itoitovalorav.AsFloat := qpropunprecoav.AsFloat;
                end
                else
                begin
                  itoitovalorav.AsFloat := vValorUnitario;

                end;

                itoitocontendo.AsFloat := qpropunmultiplicador.AsFloat;
                itopuncodigo.AsInteger := qpropuncodigo.AsInteger;
                itounicodigo.AsInteger := qprounicodigo.AsInteger;

                VUniCodigo := qprounicodigo.AsInteger;
                itoitoquantidade.AsFloat := VQuantidade;

                if (Ito.State = dsinsert) or (Ito.State = dsedit) then
                begin
                  itoitototalav.AsFloat := itoitoquantidade.AsFloat * itoitovalorav.AsFloat;

                  itoitosaldoav.AsFloat := itoitototalav.AsFloat;

                  if Self.cfgcfgdoisprecos.AsInteger = 1 then
                    itoitovalorap.AsFloat := qpropunprecoap.AsFloat
                  else
                    itoitovalorap.AsFloat := 0;

                  itoitototalap.AsFloat := itoitoquantidade.AsFloat * itoitovalorap.AsFloat;
                  itoitosaldoap.AsFloat := itoitototalap.AsFloat;
                end;

                itoitounidades.AsFloat := vpItoUnidades;

                if Variacao > 0 then
                  itovrpcodigo.AsInteger := Variacao;

                Ito.Post;

                vItoChave := Self.itoitochave.AsInteger;

                // gera informação para impressora
                imm.Close;
                imm.Params[0].AsInteger := vItoChave;
                imm.Open;

                if imm.IsEmpty then
                  imm.Append
                else
                  imm.Edit;
                immitochave.AsInteger := vItoChave;

                consulta.Close;
                consulta.SQL.Text := 'SELECT gri.tcicodigo, gri.griminuretardo FROM gri ';
                consulta.SQL.Add('INNER JOIN pro ON gri.grpcodigo = pro.grpcodigo');
                consulta.SQL.Add(' and pro.procodigo=' + itoprocodigo.AsString);
                consulta.Open;

                immtcicodigo.AsInteger := consulta.Fields[0].AsInteger;
                immimmtemporetardo.AsInteger := consulta.Fields[1].AsInteger;
                immimmmodo.AsInteger := 0;

                // immimmhoraimprimir.AsString := agora(Application, conexao);

                if trim(vpImmNumePedido) = '' then
                  immimmnumepedido.AsString := '0'
                else
                  immimmnumepedido.AsString := vpImmNumePedido;

                immcznchave.AsString := vpCznChave;
                immimmhorapedido.AsString := agora(Application, conexao);
                immclbcodigo.AsInteger := ACESSO.Usuario;
                immpdscodigo.AsInteger := 2;
                imm.Post;

                lito.Refresh;
                lito.Locate('itochave', vItoChave, []);
                Ito.Edit;

                (* Identifica se tem COMPLEMENTO NA DESCRICAO *)
                If (qpropropedecomple.AsInteger = 1) Then
                  MostraComplementoProduto(vItoChave);

                (* Identifica o Colaborador Responsável pelo Atendimento *)

                lito.Refresh;
                lito.Locate('itochave', vItoChave, []);

                (*
                  * Se produto não tem Preço definido
                  * chama função para usuário definir
                *)
                repeat
                  If (litoitovalor.AsFloat = 0) Then
                    AjustaPreco(vItoChave);

                  if (litoitovalor.AsFloat = 0) then
                    Application.MessageBox(pchar('Valor de venda precisa ser definido!'), 'Atenção', MB_ICONWARNING + MB_OK);
                until (litoitovalor.AsFloat > 0);

                if orctdecodigo.AsInteger = tdeTotal then
                begin
                  Application.MessageBox(pchar('Desconto Geral foi cancelado!'), 'Atenção', MB_ICONWARNING + MB_OK);

                  if orc.State <> dsedit then
                    orc.Edit;

                  orctdecodigo.AsInteger := tdeSemDesconto;

                  zPCalcDescAV.ParamByName('orcchave').AsString := orcorcchave.AsString;
                  zPCalcDescAV.ParamByName('Desconto').AsFloat := 0;
                  zPCalcDescAV.Execute;

                  if cfgcfgdoisprecos.AsInteger = 1 then
                  begin
                    zPCalcDescAP.ParamByName('orcchave').AsString := orcorcchave.AsString;
                    zPCalcDescAP.ParamByName('Desconto').AsFloat := 0;
                    zPCalcDescAP.Execute;
                  end;
                end;

              end;
          End;

        End;
        result := itoitochave.AsInteger;

        // MontaTextoPedido;
        try
          // recalculaTotal;

          if Variacao > 0 then
            lito.Locate('procodigo;unicodigo;vrpcodigo', VarArrayOf([VProCodigo, VUniCodigo, Variacao]), [])
          else
            lito.Locate('procodigo;unicodigo', VarArrayOf([VProCodigo, VUniCodigo]), []);

        except
          on e: Exception do
          begin
            Application.MessageBox(pchar('Erro ao recalcular total do produto: ' + inttostr(VProCodigo) + #13 + #13 + 'Mensagem: ' + e.Message),
              'Erro', MB_OK + MB_DEFBUTTON1 + MB_ICONERROR);
            SalvarLogErro(e.Message, e.StackTrace);

            lito.EnableControls;
          end;
        end;

        recalculaTotal;
      End;
    Except
      on e: Exception do
      begin
        result := -1;
        Application.MessageBox(pchar('Erro ao incluir produto: ' + inttostr(VProCodigo) + #13 + #13 + 'Mensagem: ' + e.Message), 'Erro',
          MB_OK + MB_DEFBUTTON1 + MB_ICONERROR);
        SalvarLogErro(e.Message, e.StackTrace);

        lito.EnableControls;
      end;

    End;

  Finally
    qpro.Close;
    lito.EnableControls;
  End;
End;

function TFprinciEnt.IncluirNovoItemChave(Produto, Embalagem, Variacao: Integer; Quantidade: Double): Integer;
begin
  result := 0;
  if IncluirNovoItem(Produto, Embalagem, Variacao, Quantidade) then
  begin
    result := vpItochave;
  end;
end;

function TFprinciEnt.IncluirNovoItemCombo(Produto, Embalagem: Integer; Variacao: Integer = 0; Quantidade: Double = 0; pcocodigo: Integer = 0)
  : Integer;
begin
  result := 0;
  if IncluirNovoItem(Produto, Embalagem, Variacao, Quantidade, pcocodigo) then
  begin
    result := vpItochave;
  end;
end;

function TFprinciEnt.IncluirNovoItem(Produto, Embalagem: Integer; Variacao: Integer = 0; Quantidade: Double = 0; pcocodigo: Integer = 0): Boolean;
Var
  VProCodigo: Integer;
  VUniCodigo: Integer;
  vItoChave: Integer;

  (* Variáveis para tratar novo item no orçamento *)
  VNovoItem: Boolean;
  VEstoqueDisponivel: Boolean; // Recebe retorno que identifica se produto tem saldo disponível
  VQuantidade: Double; // Recebe quantidade para ser lançada no novo item
  VQuantidadeTotal: Double;
  VTextoQuantidade: String; // Utilizada quando produto tem saldo positivo menor que um
  VPodeQuantidade: Boolean; // Utilizada quando produto tem saldo positivo menor que um
  VMensagem: String; // Utilizada quando produto tem saldo positivo menor que um

  vlTecnico: String; // Identifica o técnico resposável pelo serviço
  vlVariacao: String;

  vlAdicional: Integer;
  vlQtSbi: Integer;

  vlTotalSabor: Double;
  vlvalorSabor: Double;
  vlTxtvalorSabor: String;

Begin
  Try

    consulta.Close;
    consulta.SQL.Text := 'select cznchave from czn where cznfechamento IS null order by cznchave limit 1';
    consulta.Open;

    if consulta.IsEmpty then
    begin
      ShowMessage('Atenção:' + #13 + #13 + 'A Cozinha não esta aberta, solicite a abertura da Cozinha!');
      Application.Terminate;
    end
    else
    begin
      vpCznChave := consulta.Fields[0].AsString;
    end;

    lito.DisableControls;
    Try
      If (Produto <> 0) Then
      Begin

        qpro.Close;
        qpro.Params[0].AsInteger := Produto;

        if (Embalagem <> 0) and (Embalagem <> -1) then
        begin
          qpro.FilterSQL := 'pun.puncodigo=' + Embalagem.ToString;

        end
        else
        begin
          qpro.FilterSQL := '';
        end;
        qpro.Open;

        if qpro.IsEmpty then
          Exit;

        If (qpro.RecordCount > 1) Then
        begin
          if not(qpro.Locate('puncodigo', Embalagem, [])) then
          begin
            Application.CreateForm(Tlunidades, Lunidades);
            Lunidades.Dqpro.DataSet := qpro;
            Lunidades.lista.Columns[3].Visible := false;

            Lunidades.ShowModal;

            qpro.FilterSQL := 'pun.puncodigo=' + Lunidades.Dqpro.DataSet.FieldByName('puncodigo').AsString;

            Embalagem := Lunidades.Dqpro.DataSet.FieldByName('puncodigo').AsInteger;
            Lunidades.Free;

          end;
        end;

        VProCodigo := qproprocodigo.AsInteger;
        VUniCodigo := qprounicodigo.AsInteger;

        qsbi.Close;
        qsbi.Params[0].AsInteger := Produto;
        qsbi.Open;

        qsbr.Close;
        qsbr.Params[0].AsInteger := Produto;
        qsbr.Open;

        sbr.Close;
        sbr.Params[0].AsInteger := Self.qprogrpcodigo.AsInteger;
        sbr.Open;

        // Verifica se o item está inativo e avisa usuário.
        if qprosipcodigo.AsInteger = 2 then
        begin
          Application.MessageBox(pchar('Produto desativado não pode ser vendido.'), 'Produto Inativo', MB_OK + MB_DEFBUTTON1 + MB_ICONWARNING);
          Exit;
        end;

        // Identifica se item tem mais de uma unidade de venda
        If (qpro.RecordCount > 1) or (qsbrsbrqtd.AsInteger > 0) or (qsbi.RecordCount > 0) Then
          if (qpro.Locate('puncodigo', Embalagem, [])) then
          begin

            If (Not Ito.Active) Then
            Begin
              Ito.Params[0].AsInteger := StrToInt(vpOrcChave);
              Ito.Open;
            End;
            qpro.First;

            Ito.Append;
            itotdecodigo.AsInteger := orctdecodigo.AsInteger;
            itoorcchave.AsInteger := orcorcchave.AsInteger;
            itostocodigo.AsInteger := Orcstocodigo.AsInteger;
            itoitoitem.AsInteger := AjustaNumeroItem + 1;
            itoitodescontoav.AsFloat := 0;
            itoitodescontoap.AsFloat := 0;
            itoprocodigo.AsInteger := Produto;
            itoitounidades.AsFloat := vpItoUnidades;
            vpItoUnidades := 0;

            itoitovalorav.AsFloat := 0;

            itoitocontendo.AsFloat := qpropunmultiplicador.AsFloat;
            itopuncodigo.AsInteger := Embalagem; // qpropuncodigo.AsInteger;
            itounicodigo.AsInteger := qprounicodigo.AsInteger;
            VUniCodigo := 1;

            if Quantidade <> 0 then
            begin

              if vpQuantidade <> 0 then
                VQuantidade := vpQuantidade
              else if VQuantidade = 0 then
              begin
                if Quantidade = 0 then
                  VQuantidade := 1
                else
                  VQuantidade := Quantidade;

              end;

              if sbr.RecordCount > 1 then
              begin
                itoitoquantidade.AsFloat := StrToFloat(VQuantidade.ToString);
              end
              else
              begin
                itoitoquantidade.AsFloat := Quantidade;
              end;
            end
            else if vpQuantidade <> 0 then
              itoitoquantidade.AsFloat := vpQuantidade

            else
              itoitoquantidade.AsFloat := 1;

            itoitototalav.AsFloat := 0;

            itoitosaldoav.AsFloat := 0;

            itoitovalorap.AsFloat := 0;

            itoitototalap.AsFloat := 0;
            itoitosaldoap.AsFloat := 0;
            itopcocodigo.AsInteger := pcocodigo;

            Ito.Post;
            vItoChave := Self.itoitochave.AsInteger;
            vpItochave := vItoChave;

            Application.CreateForm(Tlunidadesent, Lunidadesent);

            If (qsbi.RecordCount > 0) Then
              Lunidadesent.vpTipoLista := 'Ingredientes'
            else
              Lunidadesent.vpTipoLista := 'Sabores';

            Lunidadesent.psituacao.Caption := 'Incluindo';
            Lunidadesent.vpOrcChave := Self.vpOrcChave;

            Lunidadesent.Dqpro.DataSet := qpro;

            sbr.Close;
            sbr.Params[0].AsInteger := Self.qprogrpcodigo.AsInteger;
            sbr.Open;

            sbi.Close;
            sbi.Params[0].AsInteger := vItoChave;
            sbi.Open;

            bgr.Close;
            bgr.Params[0].AsInteger := Self.qprogrpcodigo.AsInteger;
            bgr.Open;

            bgr.First;
            while not bgr.Eof do
            begin

              bri.Close;
              bri.Params[0].AsInteger := vItoChave;
              bri.Params[1].AsInteger := bgrbrdcodigo.AsInteger;
              bri.Open;

              if bri.IsEmpty then
                bri.Append
              else
                bri.Edit;

              briitochave.AsInteger := vItoChave;
              bribrdcodigo.AsInteger := bgrbrdcodigo.AsInteger;
              bri.Post;

              bgr.Next;

            end;

            tsi.Close;
            tsi.Open;

            Lunidadesent.Dsbr.DataSet := sbr;
            Lunidadesent.Dsbi.DataSet := sbi;
            Lunidadesent.Dtsi.DataSet := tsi;
            Lunidadesent.Dbri.DataSet := bri;

            { INICIO visualicao de bordas }

            consulta.Close;
            consulta.SQL.Text := 'select grpcodigo from brg where grpcodigo=' + qprogrpcodigo.AsString;
            consulta.Open;

            if not consulta.IsEmpty then
            begin

              brg.Close;
              brg.Params[0].AsInteger := Self.qprogrpcodigo.AsInteger;
              brg.Params[1].AsInteger := vItoChave;
              brg.Open;

              Lunidadesent.Dbrg.DataSet := brg;

              if not brg.IsEmpty then
                Lunidadesent.plBordas.Visible := True;

              { FINAL visualicao de bordas }

            end
            else
            begin
              Lunidadesent.plBordas.Visible := false;
            end;
            Lunidadesent.zcone := conexao;
            Lunidadesent.vpItochave := inttostr(vItoChave);
            Lunidadesent.plProNome.Caption := qpropronome.AsString;
            Lunidadesent.vpUsrCodigo := ACESSO.Usuario.ToString;
            Lunidadesent.vpPunCodigo := inttostr(Embalagem);

            if Lunidadesent.ShowModal = mrcancel then
            begin
              Ito.Delete;
              freeandnil(Lunidadesent);
              btVerPedido.Click;
              Exit;
            end
            else
            begin
              if Ito.Locate('itochave', vItoChave, []) then
              begin

                VQuantidade := Self.itoitoquantidade.AsFloat;
                lito.Close;
                lito.ParamByName('orcchave').AsString := vpOrcChave;
                lito.ParamByName('flacodigo').AsInteger := ACESSO.Filial;
                lito.Open;
                recalculaTotal;
              end;
              btVerPedido.Click;

            end;
            freeandnil(Lunidadesent);
          end;

        (* Identifica se o produto possui Grade e se Variação não foi localizada *)
        if (qprogracodigo.AsInteger > 0) and (Variacao <= 0) then
        begin
          vlVariacao := MostraLista('mvrp', ACESSO.Usuario.ToString, inttostr(Produto));

          if vlVariacao = '' then
            Exit;

          Variacao := StrToInt(vlVariacao);
        end;

        VProCodigo := qproprocodigo.AsInteger;
        VUniCodigo := qprounicodigo.AsInteger;

        lista.Visible := True;
        plDireitaDetalhe.Visible := True;

        VNovoItem := True;

        If (VNovoItem) Then
        Begin
          Try

            if vpQuantidade <> 0 then
              VQuantidade := vpQuantidade
            else if VQuantidade = 0 then
            begin
              if Quantidade = 0 then
                VQuantidade := 1
              else
                VQuantidade := Quantidade;

            end;

            vpQuantidade := 0;

            // Verifica se produto tem saldo positivo menor que um.
            if (qproprosaldodisp.AsFloat > 0) and (qproprosaldodisp.AsFloat < 1) then
            begin
              VMensagem := 'Produto possui apenas ' + Format('%2.4n', [qproprosaldodisp.AsFloat]);
              VMensagem := VMensagem + ' de saldo disponível!';
              VMensagem := VMensagem + #13 + #13 + 'Por favor, indique a quantidade a ser vendida a seguir.';

              Application.MessageBox(pchar(VMensagem), pchar('Informação'), MB_OK + MB_ICONINFORMATION);
              VQuantidade := qproprosaldodisp.AsFloat;

              repeat
                VPodeQuantidade := false;
                VTextoQuantidade := '0';

                InputQuery('Quantidade', 'Informe a quantidade:', VTextoQuantidade);

                try
                  VQuantidade := StrToFloat(VTextoQuantidade);
                  if VQuantidade > 0 then
                    VPodeQuantidade := True;
                except
                  VPodeQuantidade := false;
                end;

              until (VPodeQuantidade);
            end;

            // Soma quantidade total do item se tiver lançado no orçamento com outra unidade.
            VQuantidadeTotal := VQuantidade + QuantiTotalItemOrc(VProCodigo, VUniCodigo);

            // Verifica se produto tem saldo suficiente.
            VEstoqueDisponivel := PermiteQuantidade(VProCodigo, VUniCodigo, VQuantidadeTotal);

          except
            on e: Exception do
            begin
              Application.MessageBox(pchar('Erro ao verificar quantidade do produto: ' + inttostr(VProCodigo) + #13 + #13 + 'Mensagem: ' + e.Message),
                'Erro', MB_OK + MB_DEFBUTTON1 + MB_ICONERROR);

              SalvarLogErro(e.Message, e.StackTrace);

              lito.EnableControls;
            end;
          end;

          Case VEstoqueDisponivel of
            True:
              begin

                If (Not Ito.Active) Then
                Begin
                  Ito.Params[0].AsInteger := StrToInt(vpOrcChave);
                  Ito.Open;
                End;
                if Ito.Locate('itochave', vItoChave, []) then
                  Ito.Edit
                else
                  Ito.Append;

                itotdecodigo.AsInteger := orctdecodigo.AsInteger;
                itoorcchave.AsInteger := orcorcchave.AsInteger;
                itostocodigo.AsInteger := Orcstocodigo.AsInteger;
                if Ito.State = dsinsert then
                begin
                  itoitoitem.AsInteger := AjustaNumeroItem + 1;
                end;
                itoitodescontoav.AsFloat := 0;
                itoitodescontoap.AsFloat := 0;
                itoprocodigo.AsInteger := VProCodigo;

                sbi.Close;
                sbi.Params[0].AsInteger := itoitochave.AsInteger;
                sbi.Open;

                vlQtSbi := sbi.RecordCount;

                if not sbi.IsEmpty then
                begin
                  vlAdicional := 0;
                  vlQtSbi := sbi.RecordCount;

                  vlTotalSabor := 0;
                  vlvalorSabor := 0;

                  while not sbi.Eof do
                  begin

                    if (Ito.FieldByName('puncodigo').AsString <> '') and (sbi.FieldByName('sbrcodigo').AsString <> '') then
                    begin

                      consulta.Close;
                      consulta.SQL.Text := 'select spupreco from spu where sbrcodigo=' + sbi.FieldByName('sbrcodigo').AsString + ' and puncodigo=' +
                        Ito.FieldByName('puncodigo').AsString + ' and spuadicional=0 and  spu.procodigo=' + itoprocodigo.AsString;
                      consulta.Open;

                      if not consulta.IsEmpty then
                      begin

                        vlvalorSabor := consulta.FieldByName('spupreco').AsFloat / vlQtSbi;

                      end
                      else
                      begin

                        qpro.Close;
                        qpro.Params[0].AsInteger := Ito.FieldByName('procodigo').AsInteger;
                        qpro.FilterSQL := 'puncodigo=' + Ito.FieldByName('puncodigo').AsString;

                        qpro.Open;

                        vlvalorSabor := qpro.FieldByName('punprecoav').AsFloat / vlQtSbi;
                      end;
                    end
                    else
                    begin

                    end;

                    vlTotalSabor := vlTotalSabor + vlvalorSabor;

                    sbi.Next;
                  end;

                  vlTxtvalorSabor := StringReplace(Floattostr(vlTotalSabor), ',', '.', [rfReplaceAll, rfIgnoreCase]);
                  consulta.Close;
                  consulta.SQL.Text := 'update ito set itovalorav= round(' + vlTxtvalorSabor + ',6) where itochave=' + itoitochave.AsString;
                  consulta.ExecSQL;

                  consulta.Close;
                  consulta.SQL.Text := 'update ito set itototalav=itovalorav*itoquantidade where itochave=' + itoitochave.AsString;
                  consulta.ExecSQL;

                  itoitovalorav.AsFloat := vlTotalSabor;

                end
                else
                begin
                  itoitovalorav.AsFloat := qpropunprecoav.AsFloat;
                end;

                itoitocontendo.AsFloat := qpropunmultiplicador.AsFloat;
                itopuncodigo.AsInteger := qpropuncodigo.AsInteger;
                itounicodigo.AsInteger := qprounicodigo.AsInteger;

                VUniCodigo := qprounicodigo.AsInteger;
                itoitoquantidade.AsFloat := VQuantidade;

                if (Ito.State = dsinsert) or (Ito.State = dsedit) then
                begin
                  itoitototalav.AsFloat := itoitoquantidade.AsFloat * itoitovalorav.AsFloat;

                  itoitosaldoav.AsFloat := itoitototalav.AsFloat;

                  if Self.cfgcfgdoisprecos.AsInteger = 1 then
                    itoitovalorap.AsFloat := qpropunprecoap.AsFloat
                  else
                    itoitovalorap.AsFloat := 0;

                  itoitototalap.AsFloat := itoitoquantidade.AsFloat * itoitovalorap.AsFloat;
                  itoitosaldoap.AsFloat := itoitototalap.AsFloat;
                end;

                itoitounidades.AsFloat := vpItoUnidades;

                Ito.Post;

                vItoChave := Self.itoitochave.AsInteger;

                // gera informação para impressora
                imm.Close;
                imm.Params[0].AsInteger := vItoChave;
                imm.Open;

                if imm.IsEmpty then
                  imm.Append
                else
                  imm.Edit;
                immitochave.AsInteger := vItoChave;

                consulta.Close;
                consulta.SQL.Text := 'SELECT gri.tcicodigo, gri.griminuretardo FROM gri ';
                consulta.SQL.Add('INNER JOIN pro ON gri.grpcodigo = pro.grpcodigo');
                consulta.SQL.Add(' and pro.procodigo=' + itoprocodigo.AsString);
                consulta.Open;

                immtcicodigo.AsInteger := consulta.Fields[0].AsInteger;
                immimmtemporetardo.AsInteger := consulta.Fields[1].AsInteger;
                immimmmodo.AsInteger := 0;

                // immimmhoraimprimir.AsString := agora(Application, conexao);
                if trim(vpImmNumePedido) = '' then
                  immimmnumepedido.AsString := '0'
                else
                  immimmnumepedido.AsString := vpImmNumePedido;
                immcznchave.AsString := vpCznChave;
                immimmhorapedido.AsString := agora(Application, conexao);
                immclbcodigo.AsInteger := ACESSO.Usuario;
                immpdscodigo.AsInteger := 2;
                imm.Post;

                lito.Refresh;
                lito.Locate('itochave', vItoChave, []);
                Ito.Edit;

                (* Identifica se tem COMPLEMENTO NA DESCRICAO *)
                If (qpropropedecomple.AsInteger = 1) Then
                  MostraComplementoProduto(vItoChave);

                (* Identifica o Colaborador Responsável pelo Atendimento *)

                lito.Refresh;
                lito.Locate('itochave', vItoChave, []);

                (*
                  * Se produto não tem Preço definido
                  * chama função para usuário definir
                *)
                repeat
                  If (litoitovalor.AsFloat = 0) Then
                    AjustaPreco(vItoChave);

                  if (litoitovalor.AsFloat = 0) then
                    Application.MessageBox(pchar('Valor de venda precisa ser definido!'), 'Atenção', MB_ICONWARNING + MB_OK);
                until (litoitovalor.AsFloat > 0);

                if orctdecodigo.AsInteger = tdeTotal then
                begin
                  Application.MessageBox(pchar('Desconto Geral foi cancelado!'), 'Atenção', MB_ICONWARNING + MB_OK);

                  if orc.State <> dsedit then
                    orc.Edit;

                  orctdecodigo.AsInteger := tdeSemDesconto;

                  zPCalcDescAV.ParamByName('orcchave').AsString := orcorcchave.AsString;
                  zPCalcDescAV.ParamByName('Desconto').AsFloat := 0;
                  zPCalcDescAV.Execute;

                  if cfgcfgdoisprecos.AsInteger = 1 then
                  begin
                    zPCalcDescAP.ParamByName('orcchave').AsString := orcorcchave.AsString;
                    zPCalcDescAP.ParamByName('Desconto').AsFloat := 0;
                    zPCalcDescAP.Execute;
                  end;
                end;

              end;
          End;

        End;

        vpItochave := vItoChave;
        MontaTextoPedido;
        try
          // recalculaTotal;

          if Variacao > 0 then
            lito.Locate('procodigo;unicodigo;vrpcodigo', VarArrayOf([VProCodigo, VUniCodigo, Variacao]), [])
          else
            lito.Locate('procodigo;unicodigo', VarArrayOf([VProCodigo, VUniCodigo]), []);
        except
          on e: Exception do
          begin
            Application.MessageBox(pchar('Erro ao recalcular total do produto: ' + inttostr(VProCodigo) + #13 + #13 + 'Mensagem: ' + e.Message),
              'Erro', MB_OK + MB_DEFBUTTON1 + MB_ICONERROR);
            SalvarLogErro(e.Message, e.StackTrace);

            lito.EnableControls;
          end;
        end;
        recalculaTotal;
      End;
    Except
      on e: Exception do
      begin
        Application.MessageBox(pchar('Erro ao incluir produto: ' + inttostr(VProCodigo) + #13 + #13 + 'Mensagem: ' + e.Message), 'Erro',
          MB_OK + MB_DEFBUTTON1 + MB_ICONERROR);
        SalvarLogErro(e.Message, e.StackTrace);

        lito.EnableControls;
      end;

    End;
    result := True;
  Finally
    qpro.Close;
    lito.EnableControls;
  End;
End;

procedure TFprinciEnt.listaDblClick(Sender: TObject);
var
  vlItoChave: Integer;
  vlProCodigo: Integer;
  vlPunCodigo: Integer;

  vItoChave: Integer;
  VProCodigo: Integer;
  vlQtSbi: Integer;
  vlAdicional: currency;
  vlTotalSabor: currency;
  vlvalorSabor: currency;
  vlTxtvalorSabor: string;
  VUniCodigo: Integer;
  VQuantidade: Double;
  Variacao: Integer;

  vlCobrarAdicionais: currency;
  vlQtdBordas: Double;
  vlBordas: currency;
  vlTotalBordas: currency;
  vlvaloradicionalSabor: currency;

begin
  inherited;

  if itopcocodigo.AsInteger <> 0 then
  begin
    ShowMessage('Itens de Combo não podem ser alterados, só excluidos e reincluidos !');

    btVerPedido.onClick(btVerPedido);
    Exit;
  end;

  vlItoChave := Self.Litoitochave.AsInteger;
  vlProCodigo := Self.litoprocodigo.AsInteger;
  if Ito.Locate('itochave', Litoitochave.AsInteger, []) then
  begin
    vlPunCodigo := Self.itopuncodigo.AsInteger;

  end;

  qpro.Close;
  qpro.Params[0].AsInteger := vlProCodigo;
  qpro.FilterSQL := '';
  qpro.Open;

  sbr.Close;
  sbr.Params[0].AsInteger := Self.qprogrpcodigo.AsInteger;
  sbr.Open;

  try
    Application.CreateForm(Tlunidadesent, Lunidadesent);
    Lunidadesent.vpOrcChave := Self.vpOrcChave;
    Lunidadesent.Dqpro.DataSet := qpro;
    Lunidadesent.vpPunCodigo := inttostr(vlPunCodigo);

    Lunidadesent.Dqpro.DataSet.Locate('puncodigo', Lunidadesent.vpPunCodigo, []);

    sbi.Close;
    sbi.Params[0].AsInteger := vlItoChave;
    sbi.Open;

    tsi.Close;
    tsi.Open;

    Lunidadesent.Dsbr.DataSet := sbr;
    Lunidadesent.Dsbi.DataSet := sbi;
    Lunidadesent.Dtsi.DataSet := tsi;
    Lunidadesent.Disi.DataSet := isi;
    Lunidadesent.Dbri.DataSet := bri;

    consulta.Close;
    consulta.SQL.Text := 'select procodigo from bpr where procodigo=' + qproprocodigo.AsString;
    consulta.Open;

    if not consulta.IsEmpty then
    begin

      { INICIO visualicao de bordas }
      brg.Close;
      brg.Params[0].AsInteger := vlItoChave;
      brg.Params[1].AsInteger := Self.qprogrpcodigo.AsInteger;
      brg.Open;

      Lunidadesent.Dbrg.DataSet := brg;

      if not brg.IsEmpty then
        Lunidadesent.plBordas.Visible := True;

      { FINAL visualicao de bordas }

    end
    else
    begin
      Lunidadesent.plBordas.Visible := false;

    end;
    Lunidadesent.zcone := conexao;
    Lunidadesent.vpItochave := inttostr(vlItoChave);
    Lunidadesent.plProNome.Caption := qpropronome.AsString;
    Lunidadesent.vpUsrCodigo := ACESSO.Usuario.ToString;

    Lunidadesent.AjustaBotaoUnidades;
    Lunidadesent.plUnidades.Visible := false;
    Lunidadesent.psituacao.Caption := 'Alterando';

    qsbi.Close;
    qsbi.Params[0].AsInteger := vlProCodigo;
    qsbi.Open;

    If (qsbi.RecordCount > 0) Then
      Lunidadesent.vpTipoLista := 'Ingredientes'
    else
      Lunidadesent.vpTipoLista := 'Sabores';

    Lunidadesent.ShowModal;

    If (Not Ito.Active) Then
    Begin
      Ito.Params[0].AsInteger := StrToInt(vpOrcChave);
      Ito.Open;
    End;

    if Ito.Locate('itochave', Litoitochave.AsInteger, []) then
    begin
      Self.Ito.Edit;
      Self.itounicodigo.AsInteger := qprounicodigo.AsInteger;
      Self.itopuncodigo.AsInteger := qpropuncodigo.AsInteger;
      Self.itoitoquantidade.AsFloat := Lunidadesent.itoquantidade.Field.AsFloat;
      Self.Ito.Post;
    end;

    { verificar }
    vItoChave := lista.DataSource.DataSet.FieldByName('itochave').AsInteger;
    VProCodigo := lista.DataSource.DataSet.FieldByName('procodigo').AsInteger;
    VQuantidade := Lunidadesent.itoquantidade.Field.AsFloat; // lista.DataSource.DataSet.FieldByName('itoquantidade').AsFloat;

    If (Not Ito.Active) Then
    Begin
      Ito.Params[0].AsInteger := StrToInt(vpOrcChave);
      Ito.Open;
    End;
    if Ito.Locate('itochave', vItoChave, []) then
      Ito.Edit
    else
      Ito.Append;

    itotdecodigo.AsInteger := orctdecodigo.AsInteger;
    itoorcchave.AsInteger := orcorcchave.AsInteger;
    itostocodigo.AsInteger := Orcstocodigo.AsInteger;
    if Ito.State = dsinsert then
    begin
      itoitoitem.AsInteger := AjustaNumeroItem + 1;
    end;
    itoitodescontoav.AsFloat := 0;
    itoitodescontoap.AsFloat := 0;
    itoprocodigo.AsInteger := VProCodigo;

    sbi.Close;
    sbi.Params[0].AsInteger := itoitochave.AsInteger;
    sbi.Open;

    vlQtSbi := sbi.RecordCount;

    if not sbi.IsEmpty then
    begin
      vlAdicional := 0;
      vlQtSbi := sbi.RecordCount;

      vlTotalSabor := 0;
      vlvalorSabor := 0;

      while not sbi.Eof do
      begin

        if (Ito.FieldByName('puncodigo').AsString <> '') and (sbi.FieldByName('sbrcodigo').AsString <> '') then
        begin

          consulta.Close;
          consulta.SQL.Text := 'select spupreco from spu where sbrcodigo=' + sbi.FieldByName('sbrcodigo').AsString + ' and puncodigo=' +
            Ito.FieldByName('puncodigo').AsString + ' and spuadicional=0 and  spu.procodigo=' + itoprocodigo.AsString;;
          consulta.Open;

          if not consulta.IsEmpty then
          begin

            vlvalorSabor := consulta.FieldByName('spupreco').AsFloat / vlQtSbi;

          end
          else
          begin

            qpro.Close;
            qpro.Params[0].AsInteger := Ito.FieldByName('procodigo').AsInteger;
            qpro.FilterSQL := 'puncodigo=' + Ito.FieldByName('puncodigo').AsString;

            qpro.Open;

            vlvalorSabor := qpro.FieldByName('punprecoav').AsFloat / vlQtSbi;
          end;
        end
        else
        begin

        end;

        vlTotalSabor := vlTotalSabor + vlvalorSabor;

        sbi.Next;
      end;

      vlTxtvalorSabor := StringReplace(Floattostr(vlTotalSabor), ',', '.', [rfReplaceAll, rfIgnoreCase]);
      consulta.Close;
      consulta.SQL.Text := 'update ito set itovalorav= round(' + vlTxtvalorSabor + ',6) where itochave=' + itoitochave.AsString;
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'update ito set itototalav=itovalorav*itoquantidade where itochave=' + itoitochave.AsString;
      consulta.ExecSQL;

      itoitovalorav.AsFloat := vlTotalSabor;

    end
    else
    begin
      itoitovalorav.AsFloat := qpropunprecoav.AsFloat;
    end;

    itoitocontendo.AsFloat := qpropunmultiplicador.AsFloat;
    itopuncodigo.AsInteger := qpropuncodigo.AsInteger;
    itounicodigo.AsInteger := qprounicodigo.AsInteger;

    VUniCodigo := qprounicodigo.AsInteger;
    itoitoquantidade.AsFloat := VQuantidade;

    if (Ito.State = dsinsert) or (Ito.State = dsedit) then
    begin
      itoitototalav.AsFloat := itoitoquantidade.AsFloat * itoitovalorav.AsFloat;

      itoitosaldoav.AsFloat := itoitototalav.AsFloat;

      if Self.cfgcfgdoisprecos.AsInteger = 1 then
        itoitovalorap.AsFloat := qpropunprecoap.AsFloat
      else
        itoitovalorap.AsFloat := 0;

      itoitototalap.AsFloat := itoitoquantidade.AsFloat * itoitovalorap.AsFloat;
      itoitosaldoap.AsFloat := itoitototalap.AsFloat;
    end;

    itoitounidades.AsFloat := vpItoUnidades;

    Ito.Post;

    vItoChave := Self.itoitochave.AsInteger;

    // gera informação para impressora

    imm.Close;
    imm.Params[0].AsInteger := vItoChave;
    imm.Open;

    if imm.IsEmpty then
      imm.Append
    else
      imm.Edit;
    immitochave.AsInteger := vItoChave;

    consulta.Close;
    consulta.SQL.Text := 'SELECT gri.tcicodigo, gri.griminuretardo FROM gri ';
    consulta.SQL.Add('INNER JOIN pro ON gri.grpcodigo = pro.grpcodigo');
    consulta.SQL.Add(' and pro.procodigo=' + itoprocodigo.AsString);
    consulta.Open;

    immtcicodigo.AsInteger := consulta.Fields[0].AsInteger;
    immimmtemporetardo.AsInteger := consulta.Fields[1].AsInteger;
    immimmmodo.AsInteger := 0;

    // immimmhoraimprimir.AsString := agora(Application, conexao);

    if trim(vpImmNumePedido) = '' then
      immimmnumepedido.AsString := '0'
    else
      immimmnumepedido.AsString := vpImmNumePedido;

    immcznchave.AsString := vpCznChave;
    immimmhorapedido.AsString := agora(Application, conexao);
    immclbcodigo.AsInteger := ACESSO.Usuario;
    immpdscodigo.AsInteger := 2;
    imm.Post;

    lito.Refresh;
    lito.Locate('itochave', vItoChave, []);
    Ito.Edit;

    (* Identifica se tem COMPLEMENTO NA DESCRICAO *)
    If (qpropropedecomple.AsInteger = 1) Then
      MostraComplementoProduto(vItoChave);

    (* Identifica o Colaborador Responsável pelo Atendimento *)

    lito.Refresh;
    lito.Locate('itochave', vItoChave, []);

    (*
      * Se produto não tem Preço definido
      * chama função para usuário definir
    *)
    repeat
      If (litoitovalor.AsFloat = 0) Then
        AjustaPreco(vItoChave);

      if (litoitovalor.AsFloat = 0) then
        Application.MessageBox(pchar('Valor de venda precisa ser definido!'), 'Atenção', MB_ICONWARNING + MB_OK);
    until (litoitovalor.AsFloat > 0);

    consulta.Close;
    consulta.SQL.Text :=
      'SELECT punprecoav, isiquantidade FROM isi,pro,pun WHERE  isitipo=1 AND isi.procodigo=pro.procodigo and pun.procodigo=pro.procodigo and itochave='
      + vItoChave.ToString;
    consulta.Open;

    if not consulta.IsEmpty then
    begin
      consulta.First;
      while not consulta.Eof do
      begin

        vlCobrarAdicionais := vlCobrarAdicionais + consulta.FieldByName('punprecoav').AsCurrency * consulta.FieldByName('isiquantidade').AsFloat;

        consulta.Next;
      end;
    end;

    vlQtdBordas := 0;

    pbri.Close;
    pbri.SQL.Text := 'SELECT brd.brdidentificacao, bri.itochave,  bri.brdcodigo,  pun.punprecoav,  pro.procodigo,  ito.itochave,  pun.pcoprocodigo ';
    pbri.SQL.Add('FROM bri ');
    pbri.SQL.Add('LEFT JOIN ito  ON bri.itochave = ito.itochave ');
    pbri.SQL.Add('LEFT JOIN brd  ON bri.brdcodigo = brd.brdcodigo ');
    pbri.SQL.Add('LEFT JOIN pro  on brd.procodigo = pro.procodigo ');
    pbri.SQL.Add('LEFT JOIN pun  ON pro.procodigo=pun.procodigo AND pun.unicodigo=ito.unicodigo  ');
    pbri.SQL.Add('where bri.itochave=:itochave and briincluir=1 ');
    pbri.Params[0].AsInteger := vItoChave;
    pbri.Open;

    pbri.First;
    while not pbri.Eof do
    begin
      vlQtdBordas := vlQtdBordas + 1;
      pbri.Next;
    end;

    pbri.First;
    while not pbri.Eof do
    begin
      vlBordas := vlBordas + ((pbri.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * VQuantidade);
      pbri.Next;
    end;
    vlTotalBordas := vlTotalBordas + vlBordas;

    vlvaloradicionalSabor := 0;

    if sbi.FieldByName('sbrcodigo').AsString <> '' then
    begin

      consulta.Close;
      consulta.SQL.Text := 'select spupreco from spu where sbrcodigo=' + sbi.FieldByName('sbrcodigo').AsString + ' and puncodigo=' +
        Ito.FieldByName('puncodigo').AsString + ' and spuadicional=1 and  spu.procodigo=' + itoprocodigo.AsString;
      consulta.Open;

    end
    else
    begin

    end;
    if not consulta.IsEmpty then
    begin

      vlvaloradicionalSabor := consulta.FieldByName('spupreco').AsFloat / vlQtSbi;

    end;

    consulta.Close;
    consulta.SQL.Text := 'update ito set  itoacrescimoav=' +
      buscatroca(Floattostr(((vlCobrarAdicionais + vlvaloradicionalSabor * VQuantidade) + vlBordas) * 1), ',', '.') + ' where itochave=' +
      vItoChave.ToString;
    consulta.ExecSQL;

    if orctdecodigo.AsInteger = tdeTotal then
    begin
      Application.MessageBox(pchar('Desconto Geral foi cancelado!'), 'Atenção', MB_ICONWARNING + MB_OK);

      if orc.State <> dsedit then
        orc.Edit;

      orctdecodigo.AsInteger := tdeSemDesconto;

      zPCalcDescAV.ParamByName('orcchave').AsString := orcorcchave.AsString;
      zPCalcDescAV.ParamByName('Desconto').AsFloat := 0;
      zPCalcDescAV.Execute;

      if cfgcfgdoisprecos.AsInteger = 1 then
      begin
        zPCalcDescAP.ParamByName('orcchave').AsString := orcorcchave.AsString;
        zPCalcDescAP.ParamByName('Desconto').AsFloat := 0;
        zPCalcDescAP.Execute;
      end;
    end;

    { verificar }

    btVerPedido.Click;
    vpQuantidade := 1;

  finally
    freeandnil(Lunidadesent);
  end;

end;

procedure TFprinciEnt.listaDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
var
  fixRect: TRect;

begin
  if lito.Active = false then
    Exit;
  fixRect := Rect;

  If Odd(Dlito.DataSet.RecNo) Then
    lista.Canvas.Brush.Color := PEG_COR_BASE
  Else
    lista.Canvas.Brush.Color := clwhite;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      Brush.Color := PEG_COR_SELCGRID;
      FillRect(fixRect);
      Font.Color := clwhite;
    End;

  with TFriendly(lista) do
  begin
    if TDataLink(DataLink).ActiveRecord = Row - 1 then
      with Canvas do
      begin
        Brush.Color := PEG_COR_SELCGRID;
        DefaultDrawColumnCell(fixRect, DataCol, Column, State);
      end;

  end;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);

end;

procedure TFprinciEnt.listaOrcsDrawColumnCell(Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
var
  fixRect: TRect;
  Check: Integer;
  vminutos: Integer;
  vsegundos: Integer;
  index: Integer;

var
  Button: Integer;
  R: TRect;
  bcolor: TColor;

begin

  fixRect := Rect;

  If Odd(DataSourcelistaasair.DataSet.RecNo) Then
    listaOrcs.Canvas.Brush.Color := PEG_COR_BASE
  else
    listaOrcs.Canvas.Brush.Color := clwhite;

  If gdSelected In State Then
    With (Sender As TDBGrid).Canvas Do
    Begin
      if listaOrcs.Canvas.Font.Color = clGreen then
        Brush.Color := clwhite
      else
        Brush.Color := PEG_COR_SELCGRID;
      FillRect(fixRect);
      Font.Color := clwhite;

      if listaasairstocodigo.AsInteger = stoCancelado then
      begin
        listaOrcs.Canvas.Font.Color := clYellow;
        listaOrcs.Canvas.Brush.Color := clred;
      end;

    End;

  with TFriendly(listaOrcs) do
  begin
    { Get active record within grids TDataLink. The active record will be
      the current record in the dataset. Check against Row that we are
      trying to Draw, -1 to offset the column headings within grid. }

    if listaasairstocodigo.AsInteger = stoCancelado then
    begin
      listaOrcs.Canvas.Font.Color := clred;
    end;

    if TDataLink(DataLink).ActiveRecord = Row - 1 then
    begin
      with Canvas do
      begin
        { set grids canvas to win highlight colour }
        if listaOrcs.Canvas.Font.Color = clGreen then
          Brush.Color := clsilver
        else
          Brush.Color := PEG_COR_SELCGRID; // $004080FF;
        { now redraw the cell, but highlighted }
        DefaultDrawColumnCell(fixRect, DataCol, Column, State);
      end;
    end;
  end;

  if listaasairstocodigo.AsInteger = stoCancelado then
  begin
    listaOrcs.Canvas.Font.Color := clYellow;
    listaOrcs.Canvas.Brush.Color := clred;
  end;

  TDBGrid(Sender).DefaultDrawDataCell(fixRect, TDBGrid(Sender).Columns[DataCol].Field, State);

end;

procedure TFprinciEnt.listaOrcsMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  inherited;
  vpOrcChaveReimprime := DataSourcelistaasair.DataSet.FieldByName('orcchave').AsString;
end;

procedure TFprinciEnt.listaOrcsTitleClick(Column: TColumn);
begin
  inherited;
  listaasair.IndexFieldNames := Column.FieldName;
end;

procedure TFprinciEnt.Crianovoorc;
begin
  inherited Crianovoorc;
  Vendedor := '';
  plPedido.Visible := false;
  PedidoCabecalho.Lines.Clear;
  pedido.Lines.Clear;
  PedidoRodaPe.Lines.Clear;
  Ajustabotoes(false);
  lbnumepedido.Caption := 'Ped.: ';
  vpImmNumePedido := '';

end;

procedure TFprinciEnt.CriaPedidoGourmet;
var
  vlNumePedidoAtual: string;

begin

  AjustaNumeroPedidoAtual(vlNumePedidoAtual);

  if vlNumePedidoAtual = '' then
  begin
    ShowMessage('Verifique as configurações do sistema na aba de Gourmet!' + #13 + 'Não esta definido numero inicial para os pedidos de entrega!');
    Exit;
  end;

  vpImmNumePedido := vlNumePedidoAtual;

  lbnumepedido.Caption := 'Ped.: ' + vlNumePedidoAtual;

end;

procedure TFprinciEnt.DataSourcelistaasairDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  vpOrcChaveReimprime := DataSourcelistaasair.DataSet.FieldByName('orcchave').AsString;
end;

procedure TFprinciEnt.DataSourcelistajasaiuDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  vpOrcChaveReimprime := DataSourcelistajasaiu.DataSet.FieldByName('orcchave').AsString;
end;

procedure TFprinciEnt.listaOrcsSaiuMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  inherited;
  vpOrcChaveReimprime := DataSourcelistajasaiu.DataSet.FieldByName('orcchave').AsString;

end;

procedure TFprinciEnt.listaOrcsSaiuTitleClick(Column: TColumn);
begin
  inherited;
  listajasaiu.IndexFieldNames := Column.FieldName;
end;

procedure TFprinciEnt.DBGridGrpDblClick(Sender: TObject);
var
  vGrpCodigo: Integer;
begin
  pro.FilterSQL := '';
  vGrpCodigo := grpgrpcodigo.AsInteger;
  vpGrpCodigo := vGrpCodigo;
  plTituloCardapio.Caption := inttostr(grp.RecordCount) + ' ' + grpgrpidentificacao.AsString;
  sbGrupos.Visible := false;
  plBotaoVoltarCardapio.Visible := True;
  MontaBotoesProdutosNova(vGrpCodigo, grpgrpidentificacao.AsString);
  edBuscaCardapio.SetFocus;

end;

procedure TFprinciEnt.DBGridGrpKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  If (((Shift = [ssCtrl]) And (Key = 46))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) Then
    Abort;
end;

procedure TFprinciEnt.DBGridGrpKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  ProcessaTaclasRapidas(Key, Shift);
end;

procedure TFprinciEnt.DBGridProDblClick(Sender: TObject);
begin

  if (pun.RecordCount = 1) and (isa.IsEmpty) then
  begin
    if edQtdaPro.Text = '' then
      edQtdaPro.Text := '1';

    // btSelecionar.Click;
  end;

  inherited;
end;

procedure TFprinciEnt.DBGridProKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  If (((Shift = [ssCtrl]) And (Key = 46))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) Then
    Abort;
end;

procedure TFprinciEnt.DBGridProKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  // ProcessaTaclasRapidas(Key,Shift);

end;

procedure TFprinciEnt.DBGridPunKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  If (((Shift = [ssCtrl]) And (Key = 46))) or ((ssCtrl in Shift) and (Key = VK_DELETE)) Then
    Abort;

end;

procedure TFprinciEnt.DlitoDataChange(Sender: TObject; Field: TField);
begin
  inherited;

  if Dlito.DataSet.IsEmpty then
    Exit;

end;

procedure TFprinciEnt.DproDataChange(Sender: TObject; Field: TField);
var
  vlLinha: string;
begin
  inherited;
  if not pro.Active then
    Exit;

  if pro.FieldByName('procodigo').AsString = '' then
    Exit;

  pun.Connection := conexao;
  pun.Close;
  pun.SQL.Text := 'SELECT  puncodigo, procodigo, punprecoav, unisimbolo';
  pun.SQL.Add('FROM pun , uni WHERE pun.sipcodigo=1 and  pun.tuncodigo<>0 and uni.unicodigo=pun.unicodigo and procodigo=' +
    pro.FieldByName('procodigo').AsString);
  pun.SQL.Add('and procodigo NOT IN (SELECT  procodigo FROM sfn) ');
  pun.Open;

  if not pun.IsEmpty then // preço para produtos com Tamanhos
  begin
    pun.Close;
    pun.SQL.Text := 'SELECT  puncodigo, procodigo, punprecoav, unisimbolo ';
    pun.SQL.Add('FROM pun , uni WHERE pun.sipcodigo=1 and   pun.tuncodigo<>0 and uni.unicodigo=pun.unicodigo and procodigo=' +
      pro.FieldByName('procodigo').AsString);
    pun.SQL.Add('and procodigo NOT IN (SELECT  procodigo FROM sfn) ');
    pun.Open;

  end
  else // preço para produtos com sabores
  begin

    pun.Close;
    pun.SQL.Text := 'SELECT  puncodigo, procodigo, punprecoav, unisimbolo ';
    pun.SQL.Add('FROM pun, uni WHERE pun.sipcodigo=1 and   pun.tuncodigo<>0 and uni.unicodigo=pun.unicodigo and pun.puncodigo=' +
      pro.FieldByName('puncodigo').AsString + ' and procodigo=' + pro.FieldByName('procodigo').AsString);
    pun.SQL.Add('and procodigo IN (SELECT  procodigo FROM sfn) ');
    pun.Open;
  end;

  // ingredientes
  isa.Connection := conexao;
  isa.SQL.Text := 'SELECT   sbrcodigo,  isa.procodigo,  pronome ';
  isa.SQL.Add('FROM isa, pro WHERE pro.procodigo = isa.procodigo ');
  isa.SQL.Add('AND isa.sbrcodigo = (SELECT sbrcodigo FROM sbr ');
  isa.SQL.Add('WHERE procodigo =' + pro.FieldByName('procodigo').AsString + ')');
  isa.Open;

  if not isa.IsEmpty then
  begin

    isa.First;
    while not isa.Eof do
    begin
      vlLinha := vlLinha + UpperNome(isa.FieldByName('pronome').AsString) + ', ';
      isa.Next;
    end;
    vlLinha := Copy(vlLinha, 1, length(vlLinha) - 2);
    mmIngredientes.ReadOnly := false;
    mmIngredientes.Lines.Text := vlLinha;
    mmIngredientes.ReadOnly := True;

  end
  else
  begin
    mmIngredientes.ReadOnly := false;
    mmIngredientes.Lines.Text := '';
    mmIngredientes.ReadOnly := True;
  end;

  if (pun.RecordCount = 1) then
  begin
    if not plQuantidadePro.Visible then
    begin
      plQuantidadePro.Visible := True;
      edQtdaPro.Text := '1';
    end
    else
    begin
      if edQtdaPro.Text = '' then
        edQtdaPro.Text := '1';
    end;
  end
  else
  begin
    if edQtdaPro.Text = '' then
      edQtdaPro.Text := '1';
    plQuantidadePro.Visible := false;
  end;

  DBGridPun.Width := DBGridPun.Width + 1;
  DBGridPun.Width := DBGridPun.Width - 1;

  ShowScrollbar(DBGridPun.Handle, SB_VERT, True);

  if pro.FieldByName('procomposto').AsString <> '' then
  begin
    if pro.FieldByName('procomposto').AsInteger = 1 then
    begin
      plQuantidadePro.Visible := false;
    end
    else
    begin
      plQuantidadePro.Visible := True;
    end;
  end;

end;

procedure TFprinciEnt.dpunDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  if uppercase(Self.pununisimbolo.AsString) = 'KG' then
  begin
    plUnidades.Visible := True;
    edQtdaPro.EditMask := '';
    btMais.Visible := false;
    btMenos.Visible := false;

    consulta.Close;
    consulta.SQL.Text := 'select cpbuniadesporkg from cpb where procodigo=' + pro.FieldByName('procodigo').AsString;
    consulta.Open;

    if (consulta.FieldByName('cpbuniadesporkg').AsInteger = 0) or (consulta.FieldByName('cpbuniadesporkg').AsInteger = 1) then
    begin
      plTituloQuantidadePro.Caption := 'Quantidade';
      plUnidades.Visible := false;
    end
    else
    begin
      plTituloQuantidadePro.Caption := consulta.FieldByName('cpbuniadesporkg').AsString + ' por KG';
      plUnidades.Visible := True;
    end;

  end
  else
  begin
    btMais.Visible := True;
    btMenos.Visible := True;
    plUnidades.Visible := false;
    edQtdaPro.EditMask := '999;0';
  end;
end;

procedure TFprinciEnt.MostraTodosProdutos;
var
  i: Integer;
begin
  inherited;
  for i := 0 to sbListaProdutos.ComponentCount - 1 do
  begin
    if (sbListaProdutos.Components[i] is TLabel) then
      (((sbListaProdutos.Components[i] as TLabel).Parent as TPanel).Parent as TPanel).Visible := True;
  end;
end;

procedure TFprinciEnt.orcAfterInsert(DataSet: TDataSet);
begin
  inherited;

  consulta.Close;
  consulta.SQL.Text := 'select cznchave, cznabertura from czn where cznfechamento IS null order by cznchave limit 1';
  consulta.Open;

  vpCznChave := consulta.Fields[0].AsString;
  vpDataAberturaCZN := Copy(consulta.Fields[1].AsString, 1, 10);

  orcfoacodigo.AsInteger := 2;
  orcorcvias.AsInteger := 1;
  orcoricodigo.AsInteger := OriDelivery;
  orcorcdataabert.AsString := vpDataAberturaCZN;

end;

procedure TFprinciEnt.orcBeforePost(DataSet: TDataSet);
begin
  inherited;
  orcorcdataabert.AsString := vpDataAberturaCZN;
end;

procedure TFprinciEnt.PedidoCabecalhoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  ProcessaTaclasRapidas(Key, Shift);
end;

procedure TFprinciEnt.VoltaCardapio;
begin
  plRodapeLista.Width := 300;
  sbGrupos.Visible := True;
  sbListaProdutos.Visible := false;
  plTituloCardapio.Caption := 'Cardápio';
  edBuscaCardapio.Text := '';
  plBotaoVoltarCardapio.Visible := false;
  edBuscaCardapio.SetFocus;
  edQtdaPro.Text := '1';
end;

procedure TFprinciEnt.edBuscaCardapioKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
var
  i, X: Integer;
begin
  inherited;

  if sbGrupos.Visible then
  begin
    pro.FilterSQL := '';
    X := 0;
    if edBuscaCardapio.Text = '' then
    begin

      grp.First;
      ProcessaTaclasRapidas(Key, Shift);

    end
    else
    begin
      consulta.Close;
      consulta.SQL.Text := 'select grpcodigo from grp where upper(grpidentificacao) like ' + chr(39) + '%' +
        trim(uppercase(trim(edBuscaCardapio.Text))) + '%' + chr(39);
      consulta.Open;
      grp.Locate('grpcodigo', consulta.FieldByName('grpcodigo').AsString, []);
      if Key = 13 then
      begin
        DBGridGrpDblClick(DBGridGrp);
        edBuscaCardapio.Text := '';
      end
      else
      begin
        ProcessaTaclasRapidas(Key, Shift);
      end;

    end;
  end
  else if sbListaProdutos.Visible then
  begin

    X := 0;
    if edBuscaCardapio.Text = '' then
    begin
      pro.FilterSQL := '';
      pro.First;
    end
    else
    begin
      consulta.Close;
      consulta.SQL.Text := 'select procodigo from pro where pro.tpocodigo in (0,9) AND  grpcodigo=' + inttostr(vpGrpCodigo) +
        ' and upper(pronome) like ' + chr(39) + '%' + uppercase(trim(edBuscaCardapio.Text)) + '%' + chr(39);
      consulta.Open;

      pro.FilterSQL := 'upper(pronome) like ' + chr(39) + '%' + trim(uppercase(trim(edBuscaCardapio.Text))) + '%' + chr(39);

      // pro.Locate('procodigo', consulta.FieldByName('procodigo').AsInteger, []);

      if Key = 13 then
      begin
        DBGridProDblClick(DBGridPro);
        edBuscaCardapio.Text := '';
      end;

      if Key = 40 then
      begin
        Key := 0;
        pro.Next;
      end;
      if Key = 38 then
      begin
        Key := 0;
        pro.Prior;
      end;

    end;

  end;
end;

procedure TFprinciEnt.edQtdaUniChange(Sender: TObject);
begin
  inherited;

  consulta.Close;
  consulta.SQL.Text := 'select cpbuniadesporkg from cpb where procodigo=' + pro.FieldByName('procodigo').AsString;
  consulta.Open;

  if (consulta.FieldByName('cpbuniadesporkg').AsInteger = 0) or (consulta.FieldByName('cpbuniadesporkg').AsInteger = 1) then
    plTituloQuantidadePro.Caption := 'Quantidade'
  else
  begin
    plTituloQuantidadePro.Caption := consulta.FieldByName('cpbuniadesporkg').AsString + ' por KG';

    try
      edQtdaPro.Text := Floattostr((1 / consulta.FieldByName('cpbuniadesporkg').AsFloat) * StrToInt((edQtdaUni.Text)));
    except
      edQtdaPro.Text := '1';
    end;
  end;

end;

Procedure TFprinciEnt.Mostraclienteselecionado;
Begin

  // Mostrapainelcliente;
End;

Procedure TFprinciEnt.Mostrapainelcliente;
Var
  vlMoastraLista: TMostraLista;
  vlEndereco: Integer;
  vlRetonro: String;
  vlTxtFiltro: String;
  vlPackEnd: cardinal;
Begin

  plMensagemPrincipal.Visible := false;

  orc.Edit;

  consulta.Close;
  consulta.SQL.Text := 'select edrcodigo from edr where etdcodigo=' + vPetdcodigo;
  consulta.Open;

  if (orcedrcodigo.AsString = '')
  { * OS  23382
    Daniel 12/09/2014 Verificado na base do cliente que estava ficando 0 (zero) como padrao para o erd* }
    or (orcedrcodigo.AsString = '0')
  { * OS  23382 * }
  then
  begin
    if consulta.RecordCount > 1 then
    begin
      vlPackEnd := LoadPackage('modulos\medr.bpl');
      If vlPackEnd <> 0 Then
        Try
          @vlMoastraLista := GetProcAddress(vlPackEnd, pchar('formu'));

          If Assigned(vlMoastraLista) Then
          Begin
            vlTxtFiltro := ' etdcodigo=' + vPetdcodigo;
            vlRetonro := vlMoastraLista(Application, conexao, ACESSO.Usuario.ToString, 1, 'moduloedr', vlTxtFiltro, '');
          End;
        Finally
          DoUnLoadPackage(Application, vlPackEnd);
        End;

      if vlRetonro <> '' then
        vlEndereco := StrToInt(vlRetonro)

    end
    else
      vlEndereco := consulta.Fields[0].AsInteger;
  end
  else
  begin
    vlEndereco := orcedrcodigo.AsInteger;
  end;

  Etd.Close;
  Etd.Params[0].AsString := vPetdcodigo;
  Etd.Params[1].AsInteger := vlEndereco;
  Etd.Open;

  Orcetdcodigo.AsString := vPetdcodigo;
  orcedrcodigo.AsInteger := vlEndereco;
  orcedritem.AsInteger := etdedritem.AsInteger;

  PCpaginas.Visible := True;
  ActClientes.Enabled := True;
  Lidentificacao.Caption := AnsiUpperCase(etdetdidentificacao.AsString);
End;

procedure TFprinciEnt.pedidoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  ProcessaTaclasRapidas(Key, Shift);
end;

procedure TFprinciEnt.PedidoRodaPeKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  ProcessaTaclasRapidas(Key, Shift);
end;

procedure TFprinciEnt.plBotaoVoltarCardapioClick(Sender: TObject);
begin
  inherited;
  VoltaCardapio;
end;

procedure TFprinciEnt.recalculaTotal;
var
  vlBruto: Double;
  vlDesconto: Double;
  vlLiquido: Double;
begin
  inherited recalculaTotal;
  vlBruto := 0;
  vlDesconto := 0;
  vlLiquido := 0;

  If vpTipoPreco = puoAPrazo Then
  begin
    vlBruto := orcorcgeralap.AsFloat;
    vlDesconto := orcorcdescontoap.AsFloat;
    vlLiquido := orcorctotalap.AsFloat;

  end
  else
  begin
    vlBruto := orcorcgeralav.AsFloat;
    vlDesconto := orcorcdescontoav.AsFloat;
    vlLiquido := orcorctotalav.AsFloat;
  end;

  LbQtdItens.Caption := 'Itens: ' + inttostr(vpQtdItens);

  // MontaTextoPedido;

end;

procedure TFprinciEnt.relogioTimer(Sender: TObject);
begin
  inherited;
  TrimAppMemorySize;
end;

procedure TFprinciEnt.saboresCalcFields(DataSet: TDataSet);
var
  vlLinha: string;
begin
  inherited;
  if FprinciEnt.sabores.Active then
  begin
    FprinciEnt.ingredientes.Close;
    FprinciEnt.ingredientes.SQL.Text := 'select isa.sbrcodigo, isa.procodigo, pro.pronome from isa,pro WHERE ';
    FprinciEnt.ingredientes.SQL.Add(' isa.senadicionavel=0 and  pro.sipcodigo=1 and isa.sipcodigo=1 and isa.procodigo=pro.procodigo and sbrcodigo=' +
      saboressbrcodigo.AsString);
    FprinciEnt.ingredientes.Open;
    vlLinha := '';

    FprinciEnt.ingredientes.First;
    while not FprinciEnt.ingredientes.Eof do
    begin
      vlLinha := vlLinha + UpperNome(FprinciEnt.ingredientes.FieldByName('pronome').AsString) + ', ';
      FprinciEnt.ingredientes.Next;
    end;
    vlLinha := Copy(vlLinha, 1, length(vlLinha) - 2);

    FprinciEnt.saboresisaingredientes.AsString := vlLinha;
  end;
end;

procedure TFprinciEnt.SpeedButton4Click(Sender: TObject);
var
  vlNomeArq: string;
  BlobField: TBlobField;
  vDirRelat: string;
begin
  if Self.orc.Active then
  begin

    if Orcstocodigo.AsInteger = stoEmDigitacao then
    begin
      ShowMessage('Favor concluir o atendimento depois usar o botão "Reimpre pedido selecionado"');
      Exit;
    end;

  end;

  inherited;

  if vpOrcChaveReimprime <> '' then
  BEGIN
    frxUniDACComponents1.DefaultDatabase := conexao;

    vlNomeArq := ExtractFilePath(Application.ExeName) + 'Report\comprovanteDelivery.fr3';

    if not FileExists(vlNomeArq) then
    begin
      ShowMessage('Arquivo nao localizado: ' + vlNomeArq);
      Exit;
    end;

    // relatorio.LoadFromFile(vlNomeArq);

    consulta.Close;
    consulta.SQL.Text := 'select orcvias from orc where orcchave=' + vpOrcChaveReimprime;
    consulta.Open;

    PedidoCabecalho.Lines.Clear;

    orc.Close;
    orc.Params[0].AsString := vpOrcChaveReimprime;
    orc.Params[1].AsInteger := ACESSO.Filial;
    orc.Open;

    Etd.Close;
    Etd.Params[0].AsString := Orcetdcodigo.AsString;
    Etd.Params[1].AsInteger := orcedrcodigo.AsInteger;
    Etd.Open;

    with PedidoCabecalho do
    begin
      SelAttributes.Size := 16;
      SelAttributes.Style := [fsBold];
      SelAttributes.Color := clred;
      SelStart := GetTextLen;
      SelText := 'Pedido nº: ' + orcorcchave.AsString + ' ' + Format('%-40s', [Copy(etdetdidentificacao.AsString, 1, 40)]) + #13#10;
      SelStart := GetTextLen;
      SelAttributes.Size := 12;
      SelAttributes.Style := [];
      SelAttributes.Color := clBlack;

      if length(etdetftelefone.AsString) = 10 then
      begin
        SelText := 'TELEFONE: ' + FormatMaskText('!\(99\)0000-0000;0;_', etdetftelefone.AsString) + #13#10;
      end
      else if length(etdetftelefone.AsString) = 11 then
        SelText := 'TELEFONE: ' + FormatMaskText('!\(99\)00000-0000;0;_', etdetftelefone.AsString) + #13#10;

      SelAttributes.Size := 12;
      SelAttributes.Style := [];
      SelAttributes.Color := clBlack;

      SelText := 'ENDEREÇO: ' + etdedrrua.AsString + ', ' + etdedrnumero.AsString + #13#10;
      SelAttributes.Size := 12;
      SelAttributes.Style := [];
      SelAttributes.Color := clBlack;

      SelText := '          ' + etdedrbairro.AsString + #13#10;
      SelText := '          ' + etdedrobs.AsString;

    end;

    Clipboard.Clear;
    Clipboard.AsText := PedidoCabecalho.Text;

    vDirRelat := ExtractFilePath(Application.ExeName) + 'report\ComprovanteDELIVERY.fr3';

    // ImprimirComprovantesOrc(Application, conexao, vpOrcChaveReimprime, vDirRelat, trmtciporta.AsString, tiImprimir);
    DSdados.DataSet := orc;
    ImpressaoInterna(Application, conexao, DSdados, vDirRelat, trmtciporta.AsString);

    orc.Close;
    Etd.Close;

  END;

end;

function TFprinciEnt.ImpressaoInterna(AOwner: TComponent; conexao: tuniconnection; vtabela: TUniDataSource; DirRelatorio: String;
  Impressora: String = ''; vUsuCodigo: string = ''): string;
var
  vlClbIdentificacao: string;

  vlData: TDateTime;
  vlAno, vlMes, vlDia: Word;
  vlHora, vlMin, vlSec, vlMili: Word;

  vlArqExport: string;
  vlVias: Integer;
begin
  Try

    frxUniDACComponents.DefaultDatabase := conexao;

    DSdados := vtabela;

    frxDados.DataSource := vtabela;

    frxDados.DataSource := dorc;

    try
      consulta.Connection := conexao;
      consulta.SQL.Text := 'select cfgviascomprovante from cfgmsai';
      consulta.Open;
      vlVias := consulta.FieldByName('cfgviascomprovante').AsInteger;
    except
      vlVias := 1;
    end;

    if FileExists(DirRelatorio) then
    begin
      if length(Impressora) > 0 then
        frxReport.PrintOptions.Printer := Impressora;

      frxReport.LoadFromFile(DirRelatorio);
      frxReport.PrintOptions.Copies := vlVias;

      { implementacao da identificacao do emissor do relatorio }
      if vUsuCodigo <> '' then
      begin
        frxReport.Variables['CLBCODIGO'] := QuotedStr(vUsuCodigo);
      end;

      frxReport.ShowReport;

    end;

    result := '';
  Finally
  End;
end;

procedure TFprinciEnt.SpeedButton5Click(Sender: TObject);
begin
  inherited;
  AtualizaListasdePedidos;
end;

procedure TFprinciEnt.FormCreate(Sender: TObject);
begin
  inherited;

  frxReport.AddFunction('function AjustaDias(Data: TDateTime; vDias: Integer): TDateTime', 'DelphiFunctions', 'Adiciona ou Remove dias.');
  frxReport.AddFunction('function DataExtenso(Data: TDateTime): String', 'DelphiFunctions', 'Retorna Data por extenso.');
  frxReport.AddFunction('function ValorExtenso(Valor: Double): String', 'DelphiFunctions', 'Retorna valor em reais por extenso.');
  frxReport.AddFunction('function StringReplace(const S, OldPattern, NewPattern: string): string', 'DelphiFunctions',
    'Função StringReplace do Delphi com flags rfReplaceAll e rfIgnoreCase.');

  vpLarguraTela := 1920;
  vpAlturaTela := 1080;

  inherited;

  // cria um mutex usando um nome único
  CreateMutex(nil, false, 'mizioVarejo.OnlyOne');

  // verifica se houve erro na criação
  if GetLastError = ERROR_ALREADY_EXISTS then
  begin
    MessageBox(0, 'Este programa já está sendo executado', 'Aviso', MB_ICONSTOP);
    Halt(0); // cancela execução
  end;

  if FileExists(ExtractFilePath(Application.ExeName) + 'logo.png') then
  begin
    IFundo.Picture.LoadFromFile(ExtractFilePath(Application.ExeName) + 'logo.png');
  end;

  InicializacaoGeral;

  Ajustabotoes(false);

  Trm.Close;
  Trm.Params[0].AsString := ACESSO.Terminal.ToString;
  Trm.Open;

  If Trm.RecordCount = 0 Then
  Begin
    ShowMessage('Este terminal não esta cadastrado no sistema, verifique!');
    Application.Terminate;
  End
  Else
  Begin

    WindowState := WsMaximized;

    ativaimpressoraNF;

    if not IDAV.Visible then
      If FileExists(ExtractFilePath(Application.ExeName) + 'relat\comprovante.fr3') Then
        IDAV.Visible := True;


    if cfgcfgusanfc.AsInteger = 1 then
      Infce.Visible := True;

    ajustaCaixa;
    // ActFechaCaixa.Visible := false;

    lterminal.Caption := ACESSO.Terminal.ToString;

    Ajustabotoes(false);
    TFriendly(lista).DefaultRowHeight := 50;

    consulta.Close;
    consulta.SQL.Text := 'select cznchave from czn where cznfechamento IS null order by cznchave limit 1';
    consulta.Open;

    if consulta.IsEmpty then
    begin
      ShowMessage('Atenção:' + #13 + #13 + 'A Cozinha não esta aberta, solicite a abertura da Cozinha!');
      Application.Terminate;
    end
    else
    begin
      vpCznChave := consulta.Fields[0].AsString;
    end;

  End;

  if FileExists(ExtractFilePath(Application.ExeName) + 'modulos\mmoniimpnet.bpl') then
  begin
    CarregaFrame('mmoniimpnet', plImp, Self.conexao);
  end;

end;

procedure TFprinciEnt.FormDblClick(Sender: TObject);
begin
  inherited;
  WindowState := TWindowState.WsMaximized;
end;

procedure TFprinciEnt.FormKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  Tecla: Integer;
  VCdBarra: String;
  VQuantidade: Double;
Begin
  VCdBarra := (FindComponent('Cdbarra') as TEdit).Text;
  (FindComponent('Cdbarra') as TEdit).Text := '';

  Tecla := Key;
  Key := 0;

  // Identifica se tem combinação de tecla com Ctrl;

  {
    If Shift = [ssCtrl] Then
    Begin
    Case Tecla Of
    (* I - CANCELAMENTO DE ITEM *)
    73:
    ActCancelaItem.Execute;

    (* U - LIMPA ATENDIMENTO *)
    85:
    ActLimpaAtendimento.Execute;

    (* D - DESCONTO NO ITEM *)
    68:
    ActDescontoItem.Execute;

    (* G - DESCONTO GERAL *)
    71:
    ActDescontoGeral.Execute;

    Else
    begin
    (FindComponent('Cdbarra') as TEdit).Text := VCdBarra;
    (FindComponent('Cdbarra') as TEdit).SelStart := length((FindComponent('Cdbarra') as TEdit).Text);
    // DEVOLVE POSIÇÃO DO CURSOR PARA O FIM
    Key := Tecla;
    end;
    End;

    End
    Else
    Begin }
  if plMensagemPrincipal.Visible then
    Case Tecla Of

      (* F2 - INICIA VENDA *)
      113:
        ActAbreVenda.Execute;
    else
      begin
        Key := Tecla;
        Exit;
      end;
    End;

  Case Tecla Of
    (* SETA PARA CIMA *)
    38:
      if lito.Active then
        Dlito.DataSet.Prior;

    (* SETA PARA BAIXO *)
    40:
      if lito.Active then
        Dlito.DataSet.Next;

    (* F4 - AJUSTA QUANTIDADE *)
    115:
      ActQuantidade.Execute;

    (* F6 -  FINALIZAR VENDA *)
    117:
      ActFinalizaVenda.Execute;

    (* F7 - BUSCA CLIENTES *)
    118:
      ActClientes.Execute;

    (* F8 - PRODUTOS *)
    119:
      ActProdutos.Execute;

    (* F9 - A FATURAR *)
    120:
      if ActAFaturar.Visible then
        ActAFaturar.Execute;

    (* NENHUMA DAS OPÇÕES DEVOLVE VALOR DAS TECLAS *)
  Else
    begin
      (FindComponent('Cdbarra') as TEdit).Text := VCdBarra;
      (FindComponent('Cdbarra') as TEdit).SelStart := length((FindComponent('Cdbarra') as TEdit).Text);
      // DEVOLVE POSIÇÃO DO CURSOR PARA O FIM
      Key := Tecla;
    end;
  End;
  { End; }

end;

function TFprinciEnt.CarregaFrame(pacote: string; destino: TPanel; conexao: tuniconnection): thandle;
var
  exec: TMoniImp;
  frame: TFrame;
  pack: cardinal;
  retor: cardinal;
begin
  pack := LoadPackage('modulos\' + pacote + '.bpl');
  if pack <> 0 then
  begin
    @exec := GetProcAddress(pack, pchar('MoniImp'));
    if Assigned(exec) then
    begin
      destino.Visible := True;

      if exec(Application, destino, conexao, vpCznChave) <> nil then
      begin
        retor := pack;
      end
      else
      begin
        retor := 0;
      end;

    end;
  end;
  result := retor;
end;

procedure TFprinciEnt.FormShow(Sender: TObject);
var
  vlnomebpl: string;
begin
  inherited;

  vlPackopm := LoadPackage('modulos\mopm.bpl');

  Screen.Cursors[crSQLWait] := Screen.Cursors[crDefault];
  GBSalvar.Visible := True;
  IDAV.Visible := True;
  Infce.Visible := True;
  Infe.Visible := True;
  vpItoUnidades := 0;
  AtualizaListasdePedidos;

  vlnomebpl := ExtractFilePath(Application.ExeName) + 'modulos\m' + extractfilename(Application.ExeName);
  vlnomebpl := Copy(vlnomebpl, 1, pos('.', vlnomebpl) - 1);
  vlnomebpl := vlnomebpl + '.bpl';
  if FileExists(vlnomebpl) then
    label1.Caption := GetAppVersionStr(vlnomebpl)
  else
    label1.Caption := GetAppVersionStr(Application.ExeName);

  if (FileExists(ExtractFilePath(Application.ExeName) + 'Tvsenha.exe')) or (FileExists(ExtractFilePath(Application.ExeName) + 'senhas\Tvsenha.exe'))
  then
  begin
    ActChamaSenha.Enabled := True;
    sbChamaSenha.Visible := True;
  end
  else
  begin
    ActChamaSenha.Enabled := false;
    sbChamaSenha.Visible := false;
  end;

  if cfgcfgmgoucontrolaentrega.AsInteger = 1 then
  begin
    ActAbreCaixa.Enabled := false;
    SBAbreCaixa.Visible := false;
    ActFechaCaixa.Enabled := false;
    SBFechaCaixa.Visible := false;
    GBBusca.Visible := false;
  end
  else
  begin
    GBBusca.Visible := false;
    ActAbreCaixa.Enabled := false;
    SBAbreCaixa.Visible := false;
    ActFechaCaixa.Enabled := false;
    SBFechaCaixa.Visible := false;
  end;

end;

procedure TFprinciEnt.ActAbreVendaExecute(Sender: TObject);
var
  vlccxchave: string;
  vlctadelivery: string;

begin
  inherited;

  if cfgcfgmgoucontrolaentrega.AsInteger = 1 then
  begin
    consulta.Close;
    consulta.SQL.Text := 'select cfgmgouctadelivery from cfgmgou';
    consulta.Open;

    vlctadelivery := consulta.FieldByName('cfgmgouctadelivery').AsString;

    consulta.Close;
    consulta.SQL.Text := 'select ccxchave from ccx where ctacodigo=' + vlctadelivery + ' and ccxfinal is null';
    consulta.Open;

    vlccxchave := '';
    if not consulta.IsEmpty then
    begin
      vlccxchave := consulta.FieldByName('ccxchave').AsString;
    end;

    if vlccxchave = '' then
    begin
      ShowMessage('É necessário um Caixa ABERTO para realizar vendas!' + #13 + 'Abra o caixa no Controle de Entregas!');
      Exit;
    end;

    vpccxchave := vlccxchave;

    consulta.Close;
    consulta.SQL.Text := 'select ccxchave,ccxfinal from ccx where ccxchave=' + vlccxchave;
    consulta.Open;

    if consulta.FieldByName('ccxfinal').AsString <> '' then
    begin
      ShowMessage('É necessário um Caixa ABERTO para realizar vendas!' + #13 + 'Abra o caixa no Controle de Entregas!');
      Exit;
    end;

  end
  else
  begin

    if ccxchave.Field.AsString = '' then
    begin
      ShowMessage('É necessário um Caixa ABERTO para realizar vendas!' + #13 + 'Abra o caixa pela opção "Abre Caixa"');
      Exit;
    end;

    consulta.Close;
    consulta.SQL.Text := 'select ccxchave,ccxfinal from ccx where ccxchave=' + ccxchave.Field.AsString;
    consulta.Open;

    if consulta.FieldByName('ccxfinal').AsString <> '' then
    begin
      ShowMessage('É necessário um Caixa ABERTO para realizar vendas!' + #13 + 'Abra o caixa pela opção "Abre Caixa"');

      Exit;

    end;

  end;

  vpOrcChaveReimprime := '';

  AtualizaListasdePedidos;

  Infce.Tag := 1;
  Infe.Tag := 1;
  IDAV.Tag := 1;

  vPetdcodigo := '0';
  vPedrcodigo := '0';

  plMensagemPrincipal.Visible := false;

  vpTipoPreco := puoAVista;
  Novoorcamento;
  MontaBotoesGrupos;

  Ajustabotoes(True);

  cdbarra.Text := '';
  cdbarra.SetFocus;

  AdjustColumnWidths(lista);

  if orc.State = dsbrowse then
    orc.Edit;

  Etd.Close;
  Etd.Params[0].AsString := vPetdcodigo;
  Etd.Params[1].AsString := vPedrcodigo;
  Etd.Open;

  Orcetdcodigo.AsString := vPetdcodigo;
  orcedrcodigo.AsString := vPedrcodigo;
  orcedritem.AsInteger := etdedritem.AsInteger;

  PCpaginas.Visible := True;
  ActClientes.Enabled := True;
  Lidentificacao.Caption := AnsiUpperCase(etdetdidentificacao.AsString);

  MontaTextoPedido;

  btVerPedido.Click;

  edBuscaCardapio.SetFocus;

end;

procedure TFprinciEnt.MontaBotoesProdutos(vGrpCodigo: Integer; vGrpIdentificacao: string);
var
  i, v, u: Integer;
  plProduto: TPanel;
  plTitProduto: TPanel;
  plTexto: TLabel;

  mmIngre: TMemo;

  plValor: TPanel;
  plQtdPre: TPanel;

  vlUnicodigo: string;
  vlSabores: String;

  qIsa: TUniQuery;
  qPun: TUniQuery;
  qSfn: TUniQuery;

  vlLinha: string;
  vlTipo: string;
  vlPunCodigo: string;

begin

  try
    sbListaProdutos.Width := 620;
    sbListaProdutos.Visible := True;
    plRodapeLista.Width := 620;

    for i := 0 to sbListaProdutos.ComponentCount - 1 do
    begin
      sbListaProdutos.Components[0].Destroy;
      if sbListaProdutos.ComponentCount = 0 then
        break;
    end;

    pro.Close;
    consulta.Close;
    consulta.SQL.Text := 'SELECT grp.grpcodigo, sfn.sfnquantidade, pro.procodigo ';
    consulta.SQL.Add('FROM pro INNER JOIN grp ON pro.grpcodigo = grp.grpcodigo ');
    consulta.SQL.Add('INNER JOIN sfn ON sfn.procodigo = pro.procodigo ');
    consulta.SQL.Add('where grp.grpcodigo=' + inttostr(vGrpCodigo));
    consulta.Open;

    if consulta.IsEmpty then
    begin
      vlTipo := 'Sabores';

      pro.SQL.Text := 'SELECT pro.procodigo, pronome, procomposto ';
      pro.SQL.Add('FROM pro ');
      pro.SQL.Add('WHERE pro.tpocodigo in (0,9) ');
      pro.SQL.Add('and pro.grpcodigo=:grpcodigo ');
      pro.SQL.Add('order by pro.pronome ');

    end
    else
    begin
      vlTipo := 'Tamanhos';

      pro.SQL.Text := 'SELECT pro.procodigo, pun.puncodigo, ';
      pro.SQL.Add('concat(pro.pronome,' + chr(39) + ' ' + chr(39) + ',if(upper(uni.uninome)=' + chr(39) + 'UNIDADE' + chr(39) + ',' + chr(39) +
        chr(39) + ',uni.uninome)) as pronome, ');
      pro.SQL.Add('pun.punprecoav, pro.unicodigo as unipro, pun.unicodigo as unipun, ');
      pro.SQL.Add('procomposto ');
      pro.SQL.Add('FROM pun ');
      pro.SQL.Add('INNER JOIN pro ON pun.procodigo = pro.procodigo ');
      pro.SQL.Add('INNER JOIN uni ON pun.unicodigo = uni.unicodigo ');
      pro.SQL.Add('WHERE pro.tpocodigo in (0,9) ');
      pro.SQL.Add('and pro.grpcodigo=:grpcodigo ');
      pro.SQL.Add('order by pro.pronome, uni.uninome ');

    end;

    pro.Params[0].AsInteger := vGrpCodigo;
    pro.Open;

    if not pro.IsEmpty then
    begin

      sbListaProdutos.Visible := True;
      pro.First;

      while not pro.Eof do
      begin
        if vlTipo = 'Tamanhos' then
        begin
          vlPunCodigo := '_' + pro.FieldByName('puncodigo').AsString;
        end
        else
        begin
          vlPunCodigo := '';
        end;

        plProduto := TPanel.Create(sbListaProdutos);
        plProduto.Parent := sbListaProdutos;
        plProduto.Height := 45;
        plProduto.Name := 'plProduto' + pro.FieldByName('procodigo').AsString + ifthen(vlTipo = 'Tamanhos', vlPunCodigo, '');
        plProduto.Align := alBottom;
        plProduto.ParentBackground := false;
        plProduto.ParentFont := false;
        plProduto.Font.Size := 12;
        plProduto.Font.Style := [fsBold];
        plProduto.Font.Name := 'Tahoma';

        plProduto.BorderWidth := 4;
        plProduto.Alignment := taLeftJustify;
        plProduto.Tag := pro.FieldByName('procodigo').AsInteger;
        plProduto.Align := alTop;
        plProduto.Color := clwhite;
        plProduto.Caption := '';
        plProduto.BevelOuter := bvRaised;

        plTitProduto := TPanel.Create(sbListaProdutos);
        plTitProduto.Parent := plProduto;
        plTitProduto.Align := alTop;
        plTitProduto.Name := 'tiProduto' + pro.FieldByName('procodigo').AsString + ifthen(vlTipo = 'Tamanhos', vlPunCodigo, '');
        plTitProduto.Caption := '';
        plTitProduto.Tag := pro.FieldByName('procodigo').AsInteger;
        plTitProduto.Height := 30;
        plTitProduto.BevelOuter := bvNone;
        // plTitProduto.OnClick := btSelecionaProdutoClick;

        plTexto := TLabel.Create(sbListaProdutos);
        plTexto.Caption := buscatroca(Copy(UpperNome(pro.FieldByName('pronome').AsString), 1, 50) + #13 + #10 +
          Copy(UpperNome(pro.FieldByName('pronome').AsString), 51, 100), 'Unidade', '');
        plTexto.Parent := plTitProduto;
        plTexto.ParentFont := false;
        plTexto.Name := 'btProduto' + pro.FieldByName('procodigo').AsString + ifthen(vlTipo = 'Tamanhos', vlPunCodigo, '');
        plTexto.Font.Size := 13;
        plTexto.Font.Style := [fsBold];
        plTexto.Font.Name := 'Tahoma';
        plTexto.Align := alclient;
        plTexto.Font.Color := $00C08000;
        // plTexto.OnClick := btSelecionaProdutoClick;

        qPun := TUniQuery.Create(plProduto);
        qPun.Name := 'qPun' + plProduto.Name;
        qPun.Connection := conexao;
        qPun.SQL.Text := 'SELECT  puncodigo, procodigo, punprecoav ';
        qPun.SQL.Add('FROM pun WHERE pun.tuncodigo<>0 and procodigo=' + pro.FieldByName('procodigo').AsString);
        qPun.SQL.Add('and procodigo NOT IN (SELECT  procodigo FROM sfn) ');
        qPun.Open;

        if not qPun.IsEmpty then // preço para produtos com Tamanhos
        begin

          qPun.First;
          while not qPun.Eof do
          begin
            plQtdPre := TPanel.Create(plProduto);
            plQtdPre.Parent := plTitProduto;
            plQtdPre.Tag := pro.FieldByName('procodigo').AsInteger;
            plQtdPre.onClick := btSelecionaProdutoClick;
            plQtdPre.BevelOuter := bvRaised;
            plQtdPre.Width := 115;
            plQtdPre.Name := 'plQtdPre' + pro.FieldByName('procodigo').AsString + '_' + qPun.FieldByName('puncodigo').AsString;
            plQtdPre.Caption := vlSabores + Format('%10s', [formatfloat('##,##0.00', qPun.FieldByName('punprecoav').AsFloat)]);
            plQtdPre.BorderStyle := bsNone;
            plQtdPre.Alignment := taRightJustify;
            plQtdPre.Align := alRight;
            plQtdPre.BorderWidth := 3;
            plQtdPre.Font.Name := 'Tahoma';
            plQtdPre.Color := $00C08000;
            plQtdPre.ParentBackground := false;
            plQtdPre.ParentFont := false;
            plQtdPre.Font.Color := clwhite;

            plQtdPre.Font.Size := 14;

            qPun.Next;
          end;
        end
        else // preço para produtos com sabores
        begin

          plQtdPre := TPanel.Create(plProduto);
          plQtdPre.Parent := plTitProduto;
          plQtdPre.Tag := pro.FieldByName('procodigo').AsInteger;
          plQtdPre.onClick := btSelecionaProdutoClick;
          plQtdPre.BevelOuter := bvRaised;
          plQtdPre.BorderWidth := 3;

          plQtdPre.Width := 145;
          vlSabores := '';
          consulta.Close;
          consulta.SQL.Text := 'select unicodigo from pun where puncodigo=' + pro.FieldByName('puncodigo').AsString;
          consulta.Open;

          if not consulta.IsEmpty then
          begin
            vlUnicodigo := '';
            vlUnicodigo := consulta.Fields[0].AsString;

            if vlUnicodigo <> '' then
            begin
              consulta.Close;
              consulta.SQL.Text := 'SELECT sfn.sfnquantidade FROM sfn  WHERE sfn.procodigo =' + pro.FieldByName('procodigo').AsString + ' and ';
              consulta.SQL.Add(' sfn.unicodigo =' + vlUnicodigo);
              consulta.Open;

              if not consulta.IsEmpty then
              begin
                if consulta.Fields[0].AsInteger > 0 then
                  vlSabores := 'Sb: ' + consulta.Fields[0].AsString;

              end;

            end;

          end;

          plQtdPre.Name := 'plQtdPre' + pro.FieldByName('procodigo').AsString + vlPunCodigo;
          plQtdPre.Caption := vlSabores + Format('%10s', [formatfloat('##,##0.00', pro.FieldByName('punprecoav').AsFloat)]);
          plQtdPre.BorderStyle := bsNone;
          plQtdPre.Alignment := taRightJustify;
          plQtdPre.Align := alRight;
          plQtdPre.Font.Name := 'Tahoma';
          plQtdPre.Font.Size := 14;
          plQtdPre.Color := $00C08000;
          plQtdPre.ParentBackground := false;
          plQtdPre.ParentFont := false;
          plQtdPre.Font.Color := clwhite;

          // preço para produtos com sabores

        end;

        qIsa := TUniQuery.Create(plProduto);
        qIsa.Name := 'qIsa' + plProduto.Name;
        qIsa.Connection := conexao;
        qIsa.SQL.Text := 'SELECT   sbrcodigo,  isa.procodigo,  pronome ';
        qIsa.SQL.Add('FROM isa, pro WHERE pro.procodigo = isa.procodigo ');
        qIsa.SQL.Add('AND isa.sbrcodigo = (SELECT sbrcodigo FROM sbr ');
        qIsa.SQL.Add('WHERE procodigo =' + pro.FieldByName('procodigo').AsString + ')');
        qIsa.Open;
        if not qIsa.IsEmpty then
        begin
          mmIngre := TMemo.Create(plProduto);
          mmIngre.Parent := plProduto;
          mmIngre.Name := 'mmProduto' + pro.FieldByName('procodigo').AsString + ifthen(vlTipo = 'Tamanhos', vlPunCodigo, '');
          mmIngre.ReadOnly := True;

          qIsa.First;
          while not qIsa.Eof do
          begin
            vlLinha := vlLinha + UpperNome(qIsa.FieldByName('pronome').AsString) + ', ';
            qIsa.Next;
          end;
          vlLinha := Copy(vlLinha, 1, length(vlLinha) - 2);

          mmIngre.Lines.Text := vlLinha;

          v := length(trim(vlLinha));

          if v <= 60 then
          begin
            v := 1;
          end
          else if (v >= 61) and (v < 120) then
          begin
            v := 2;
          end
          else if (v >= 121) and (v < 180) then
          begin
            v := 3;
          end
          else if (v >= 181) and (v < 240) then
          begin
            v := 4;
          end
          else
            v := 5;

          mmIngre.Height := v * 25;
          mmIngre.Font.Name := 'Tahoma';
          mmIngre.ParentFont := false;
          mmIngre.Font.Size := 12;
          mmIngre.Font.Style := [];
          mmIngre.Align := alBottom;
          mmIngre.Hint := UpperNome(pro.FieldByName('pronome').AsString);
          mmIngre.Font.Color := clNavy;
          mmIngre.BorderStyle := bsNone;
          mmIngre.BevelInner := bvNone;
          mmIngre.BevelOuter := bvNone;
          mmIngre.WordWrap := True;

          u := 0;
          for i := 0 to plProduto.ComponentCount - 1 do
          begin
            if plProduto.Components[i] is TPanel then
              u := u + (plProduto.Components[i] as TPanel).Height;

            if plProduto.Components[i] is TLabel then
              u := u + (plProduto.Components[i] as TLabel).Height;

            if plProduto.Components[i] is TMemo then
              u := u + (plProduto.Components[i] as TMemo).Height;

          end;
          plProduto.Height := u + 5;
          vlLinha := '';
          plProduto.Align := alBottom;
          plProduto.Align := alTop;

        end;
        pro.Next;

      end;

    end;

  finally
  end;
end;

procedure TFprinciEnt.MontaBotoesProdutosNova(vGrpCodigo: Integer; vGrpIdentificacao: string);
var
  i, v, u: Integer;
  plProduto: TPanel;
  plTitProduto: TPanel;
  plTexto: TLabel;

  mmIngre: TMemo;

  plValor: TPanel;
  plQtdPre: TPanel;

  vlUnicodigo: string;
  vlSabores: String;

  qIsa: TUniQuery;
  qPun: TUniQuery;
  qSfn: TUniQuery;

  vlLinha: string;
  vlTipo: string;
  vlPunCodigo: string;
  a: string;
begin

  try
    sbListaProdutos.Width := 620;
    sbListaProdutos.Visible := True;
    plRodapeLista.Width := 620;

    for i := 0 to sbListaProdutos.ComponentCount - 1 do
    begin
      sbListaProdutos.Components[0].Destroy;
      if sbListaProdutos.ComponentCount = 0 then
        break;
    end;

    pro.Close;
    consulta.Close;
    consulta.SQL.Text := 'SELECT grp.grpcodigo, sfn.sfnquantidade, pro.procodigo ';
    consulta.SQL.Add('FROM pro INNER JOIN grp ON pro.grpcodigo = grp.grpcodigo ');
    consulta.SQL.Add('INNER JOIN sfn ON sfn.procodigo = pro.procodigo ');
    consulta.SQL.Add('where pro.sipcodigo=1 and grp.grpcodigo=' + inttostr(vGrpCodigo));
    consulta.Open;

    if consulta.IsEmpty then
    begin
      vlTipo := 'Sabores';

      pro.SQL.Text := ' SELECT pro.procodigo, pronome,procomposto, ';
      pro.SQL.Add(' ifnull( IF((SELECT sbr.sbrordem FROM sbr WHERE sbr.procodigo = pro.procodigo limit 1) IS NULL, ' +
        '(SELECT gop.gopordem FROM gop  WHERE gop.procodigo = pro.procodigo limit 1), (SELECT sbr.sbrordem FROM sbr WHERE sbr.procodigo = pro.procodigo limit 1)  ),0) AS ordem ');
      pro.SQL.Add('FROM pro WHERE pro.sipcodigo=1 and pro.tpocodigo = 0 AND pro.grpcodigo=:grpcodigo ORDER BY ordem,pronome ');

    end
    else
    begin
      vlTipo := 'Tamanhos';

      pro.SQL.Text := 'SELECT pro.procodigo, pun.puncodigo,procomposto, ';
      pro.SQL.Add('concat(pro.pronome,' + chr(39) + ' ' + chr(39) + ',if(upper(uni.uninome)=' + chr(39) + 'UNIDADE' + chr(39) + ',' + chr(39) +
        chr(39) + ',uni.uninome)) as pronome, ');
      pro.SQL.Add('pun.punprecoav, pro.unicodigo as unipro, pun.unicodigo as unipun, ');
      pro.SQL.Add('(SELECT sfn.sfnordem FROM sfn WHERE sfn.unicodigo=pun.unicodigo limit 1) as ordem,pronome ');
      pro.SQL.Add('FROM pun ');
      pro.SQL.Add('INNER JOIN pro ON pun.procodigo = pro.procodigo and pro.sipcodigo=1 ');
      pro.SQL.Add('INNER JOIN uni ON pun.unicodigo = uni.unicodigo ');
      pro.SQL.Add('LEFT JOIN sfn ON pun.unicodigo = sfn.unicodigo and sfn.procodigo=pro.procodigo');

      pro.SQL.Add('WHERE pro.tpocodigo in (0,9) ');

      pro.SQL.Add('and sfn.sipcodigo=1 ');
      pro.SQL.Add('and pro.grpcodigo=:grpcodigo ');
      pro.SQL.Add('order by ordem, pronome  ');
      a := pro.SQL.Text;

    end;

    pro.Params[0].AsInteger := vGrpCodigo;
    pro.Open;
    DataSource1.DataSet := pro;
    DBGridPro.Columns[0].Width := 450;
    DBGridPro.Columns[0].FieldName := 'pronome';
    DBGridPro.Columns[0].Title.Caption := 'Identificação';

    if not pro.IsEmpty then
    begin

      sbListaProdutos.Visible := True;
      pro.First;

    end;

  finally

  end;
end;

procedure TFprinciEnt.btVoltaParaGruposClick(Sender: TObject);
begin
  // sbGrupos.Visible := true;
  // MontaBotoesGrupos;
end;

procedure TFprinciEnt.btSelecionaProdutoClick(Sender: TObject);
var
  VProCodigo: Integer;

  vEmbalagem: Integer;
  vVariacao: Integer;
  VCBarra: string;
  vlPunCodigo: string;
begin
  if (Sender is TLabel) then
  begin
    VCBarra := inttostr((Sender as TLabel).Tag);
    vlPunCodigo := (Sender as TLabel).Name;
  end
  else if (Sender is TPanel) then
  begin
    VCBarra := inttostr((Sender as TPanel).Tag);
    vlPunCodigo := (Sender as TPanel).Name;
  end
  else if (Sender is TMemo) then
  begin
    VCBarra := inttostr((Sender as TMemo).Tag);
    vlPunCodigo := (Sender as TMemo).Name;
  end;

  vlPunCodigo := Copy(vlPunCodigo, pos('_', vlPunCodigo) + 1, 10);

  consulta.Close;
  consulta.SQL.Text := 'select punbarra from pun where puncodigo=' + vlPunCodigo;
  consulta.Open;

  VCBarra := consulta.Fields[0].AsString;

  VProCodigo := BuscaProdutoBarra(Application, conexao, VCBarra, vEmbalagem, vVariacao);

  If VProCodigo > -1 Then
    IncluirNovoItem(VProCodigo, vEmbalagem, vVariacao);

  VoltaCardapio;

end;

procedure TFprinciEnt.btSelecionarClick(Sender: TObject);
var
  vlPunCodigo: string;
  VCBarra: string;
  VlpcoProCodigo: Integer;
  vEmbalagem: Integer;
  vVariacao: Integer;
  VQuantidade: Double;

  vlTotalItensCombo: Double;
  vlTotalCombo: Double;

  vlPercentual: Double;

  vlListaItem: TstringList;
  vlListaAdicionaisItem: TstringList;
  vlItoChavecombo: Integer;
  i: Integer;
  vlitocombo: Integer;

  vlQtSbi: Integer;
  vlvalorSabor: currency;
  vlTxtvalorSabor: string;

  vlqtdItens: Integer;
  X: Integer;

  vlicombo: String;
  vlpcombo: String;
  vlbcombo: String;
  vldifcombo: Double;

  vlpcosaborfixo: Integer;
  vlgrpcodigo: string;
  vlUnicodigo: string;

  vlqtd, vliadicional: Integer;
  vlCobrarAdicionais: Double;
  vlCobrarAdicional: string;
  vlItoAdicional: string;
  vlQtdBordas: Integer;

  vlTotalBordas: Double;
  vlBordas: Double;

  VProCodigo: Integer;

  vlAdicionalBordas: Double;
  // vlvaloradicionalSabor: currency;

  vladsaborpuncodigo: string;
  vlvaloradicionalSabor: currency;
begin
  vlAdicionalBordas := 0;

  vpQtCombos := 1;
  pco.Close;
  pco.ParamByName('procodigo').AsString := pro.FieldByName('procodigo').AsString;
  pco.Open;

  VProCodigo := pro.FieldByName('procodigo').AsInteger;
  vpCombo := 0;
  if not pco.IsEmpty then
  begin

    vpCombo := dpun.DataSet.FieldByName('punprecoav').AsCurrency;
    vlListaItem := TstringList.Create;
    vlListaAdicionaisItem := TstringList.Create;
    pco.First;
    while not pco.Eof do
    begin

      vlpcosaborfixo := pco.FieldByName('pcosaborfixo').AsInteger;
      if vlpcosaborfixo = 1 then
      begin
        vlPunCodigo := pco.FieldByName('puncodigo').AsString;
        VlpcoProCodigo := pco.FieldByName('pcosubproduto').AsInteger;

        if vlPunCodigo <> '' then
        begin
          consulta.Close;
          consulta.SQL.Text := 'select punbarra from pun where puncodigo=' + vlPunCodigo;
          consulta.Open;

          VCBarra := consulta.Fields[0].AsString;

          VlpcoProCodigo := BuscaProdutoBarra(Application, conexao, VCBarra, vEmbalagem, vVariacao);

          vpItoUnidades := pco.FieldByName('unicodigo').AsInteger; // StrToInt(edQtdaPro.Text);

          VQuantidade := pco.FieldByName('pcoquantidade').AsFloat;

          If VlpcoProCodigo > -1 Then
          begin

            qsbr.Close;
            qsbr.Params[0].AsInteger := VlpcoProCodigo;
            qsbr.Open;

            if qsbrsbrqtd.AsInteger > 1 then
            begin
              VQuantidade := 1;

              vlqtdItens := pco.FieldByName('pcoquantidade').AsInteger;
            end
            else
            begin
              VQuantidade := pco.FieldByName('pcoquantidade').AsInteger;
              vlqtdItens := 1;
            end;

            for X := 1 to vlqtdItens do
            begin

              vlItoChavecombo := IncluirNovoItemCombo(VlpcoProCodigo, vEmbalagem, vVariacao, VQuantidade, pco.FieldByName('procodigo').AsInteger);

              vlQtdBordas := 0;

              pbri.Close;
              pbri.SQL.Text :=
                'SELECT brd.brdidentificacao, bri.itochave,  bri.brdcodigo,  pun.punprecoav,  pro.procodigo,  ito.itochave,  pun.pcoprocodigo ';
              pbri.SQL.Add('FROM bri ');
              pbri.SQL.Add('LEFT JOIN ito  ON bri.itochave = ito.itochave ');
              pbri.SQL.Add('LEFT JOIN brd  ON bri.brdcodigo = brd.brdcodigo ');
              pbri.SQL.Add('LEFT JOIN pro  on brd.procodigo = pro.procodigo ');
              pbri.SQL.Add('LEFT JOIN pun  ON pro.procodigo=pun.procodigo ');
              pbri.SQL.Add('where bri.itochave=:itochave and briincluir=1 ');
              pbri.Params[0].AsInteger := vlItoChavecombo;

              if VProCodigo <> 0 then
              begin
                pbri.Filter := 'pcoprocodigo=' + VProCodigo.ToString;
                pbri.Filtered := True;
              end;

              pbri.Open;

              pbri.First;
              while not pbri.Eof do
              begin
                vlQtdBordas := vlQtdBordas + 1;
                pbri.Next;
              end;

              pbri.First;
              while not pbri.Eof do
              begin

                vlBordas := vlBordas + ((pbri.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * VQuantidade);

                pbri.Next;
              end;
              vlTotalBordas := vlTotalBordas + vlBordas;

              pbri.Filter := '';
              pbri.Filtered := false;

              consulta.Close;
              consulta.SQL.Text := 'update ito set pcocodigo=' + pco.FieldByName('procodigo').AsString + ' where itochave=' +
                vlItoChavecombo.ToString;
              consulta.ExecSQL;

              vlListaItem.Add(vlItoChavecombo.ToString + '-' + pco.FieldByName('procodigo').AsString + '#' + vlBordas.ToString);
              vlBordas := 0;
            end;

          end;

        end;

      end;

      if vlpcosaborfixo = 0 then
      begin
        VQuantidade := pco.FieldByName('pcoquantidade').AsFloat;

        for vlqtd := 1 to pco.FieldByName('pcoquantidade').AsInteger do
        begin
          try
            Application.CreateForm(Tfsabores, fsabores);
            consulta.Close;
            consulta.SQL.Text :=
              'SELECT (select grpcodigo from pro WHERE procodigo=pco.pcosubproduto) grpcodigo,pco.unicodigo,pco.pcosubproduto FROM pco, pro WHERE pco.procodigo=pro.procodigo  and pcocodigo=:pcocodigo ';
            consulta.ParamByName('pcocodigo').AsString := pco.FieldByName('pcocodigo').AsString;
            consulta.Open;
            vlgrpcodigo := consulta.FieldByName('grpcodigo').AsString;
            vlUnicodigo := consulta.FieldByName('unicodigo').AsString;
            consulta.Close;

            uqsbr.Close;
            uqsbr.ParamByName('grpcodigo').AsString := vlgrpcodigo;
            uqsbr.ParamByName('unicodigo').AsString := vlUnicodigo;
            uqsbr.Open;

            fsabores.DBGSbr.DataSource.DataSet := uqsbr;

            fsabores.ShowModal;
            vlPunCodigo := uqsbr.FieldByName('puncodigo').AsString;
            VlpcoProCodigo := uqsbr.FieldByName('procodigo').AsInteger;

            if vlPunCodigo <> '' then
            begin
              consulta.Close;
              consulta.SQL.Text := 'select punbarra from pun where puncodigo=' + vlPunCodigo;
              consulta.Open;

              VCBarra := consulta.Fields[0].AsString;

              VlpcoProCodigo := BuscaProdutoBarra(Application, conexao, VCBarra, vEmbalagem, vVariacao);

              vpItoUnidades := pco.FieldByName('unicodigo').AsInteger; // StrToInt(edQtdaPro.Text);

              VQuantidade := pco.FieldByName('pcoquantidade').AsFloat;

              If VlpcoProCodigo > -1 Then
              begin

                qsbr.Close;
                qsbr.Params[0].AsInteger := VlpcoProCodigo;
                qsbr.Open;

                VQuantidade := 1;
                vlqtdItens := 1;
                vlBordas := 0;

                for X := 1 to vlqtdItens do
                begin

                  vlItoChavecombo := IncluirNovoItemCombo(VlpcoProCodigo, vEmbalagem, vVariacao, VQuantidade, pco.FieldByName('procodigo').AsInteger);

                  vlQtdBordas := 0;

                  pbri.Close;
                  pbri.SQL.Text :=
                    'SELECT brd.brdidentificacao, bri.itochave,  bri.brdcodigo,  pun.punprecoav,  pro.procodigo,  ito.itochave,  pun.pcoprocodigo ';
                  pbri.SQL.Add('FROM bri ');
                  pbri.SQL.Add('LEFT JOIN ito  ON bri.itochave = ito.itochave ');
                  pbri.SQL.Add('LEFT JOIN brd  ON bri.brdcodigo = brd.brdcodigo ');
                  pbri.SQL.Add('LEFT JOIN pro  on brd.procodigo = pro.procodigo ');
                  pbri.SQL.Add('LEFT JOIN pun  ON pro.procodigo=pun.procodigo AND pun.unicodigo=ito.unicodigo  ');
                  pbri.SQL.Add('where bri.itochave=:itochave and briincluir=1 ');
                  pbri.Params[0].AsInteger := vlItoChavecombo;
                  pbri.Open;

                  pbri.First;
                  while not pbri.Eof do
                  begin
                    vlQtdBordas := vlQtdBordas + 1;
                    pbri.Next;
                  end;

                  pbri.First;
                  while not pbri.Eof do
                  begin

                    vlBordas := vlBordas + ((pbri.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * VQuantidade);
                    pbri.Next;
                  end;
                  vlTotalBordas := vlTotalBordas + vlBordas;

                  consulta.Close;
                  consulta.SQL.Text :=
                    'SELECT punprecoav, isiquantidade FROM isi,pro,pun WHERE  isitipo=1 AND isi.procodigo=pro.procodigo and pun.procodigo=pro.procodigo and itochave='
                    + vlItoChavecombo.ToString;
                  consulta.Open;

                  if not consulta.IsEmpty then
                  begin
                    vlCobrarAdicionais := vlCobrarAdicionais + consulta.FieldByName('punprecoav').AsCurrency *
                      consulta.FieldByName('isiquantidade').AsFloat;
                  end;

                  if vlQtdBordas > 0 then
                  begin
                    consulta.Close;
                    consulta.SQL.Text := 'select punprecoav from pun where pcoprocodigo=' + VProCodigo.ToString;
                    consulta.Open;

                    if not consulta.IsEmpty then
                    begin

                      consulta.First;
                      while not consulta.Eof do
                      begin
                        vlBordas := vlBordas + ((consulta.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * VQuantidade);
                        consulta.Next;
                      end;

                    end;
                  end;

                  vlBordas := 0;

                  consulta.Close;
                  consulta.SQL.Text := 'update ito set pcocodigo=' + pco.FieldByName('procodigo').AsString + ' where itochave=' +
                    vlItoChavecombo.ToString;
                  consulta.ExecSQL;

                  vlListaItem.Add(vlItoChavecombo.ToString + '-' + pco.FieldByName('procodigo').AsString + '#' + vlBordas.ToString);
                  vlBordas := 0;
                end;

              end;

            end;
          finally
            fsabores.Free;
          end;
        end;

      end;

      pco.Next;

    end;
    vlTotalItensCombo := 0;
    vlPercentual := 0;
    vlCobrarAdicionais := 0;
    vlbcombo := '';
    for i := 0 to vlListaItem.Count - 1 do
    begin

      vlbcombo := trim(Copy(vlListaItem.Strings[i], pos('#', vlListaItem.Strings[i]) + 1, 200));
      vlicombo := Copy(vlListaItem.Strings[i], 1, pos('-', vlListaItem.Strings[i]) - 1);
      vlpcombo := Copy(vlListaItem.Strings[i], pos('-', vlListaItem.Strings[i]) + 1, 20);
      vlpcombo := Copy(vlpcombo, 1, pos('#', vlpcombo) - 1);

      vlvaloradicionalSabor := 0;
      vladsaborpuncodigo := '';

      consulta.Close;
      consulta.SQL.Text := 'select puncodigo from pun where procodigo=' + vlpcombo;
      consulta.Open;

      if not consulta.IsEmpty then
      begin
        vladsaborpuncodigo := consulta.FieldByName('puncodigo').AsString;
      end;

      if (vladsaborpuncodigo <> '') and (vlpcombo <> '') then
      begin

        consulta.Close;
        consulta.SQL.Text := 'select spupreco from spu where puncodigo=' + vladsaborpuncodigo + ' and spuadicional=1 and  spu.procodigo=' + vlpcombo;
        consulta.Open;

        if not consulta.IsEmpty then
        begin

          vlvaloradicionalSabor := consulta.FieldByName('spupreco').AsFloat;

        end;

      end
      else
      begin
        vlvaloradicionalSabor := 0;
      end;

      if vlvaloradicionalSabor <> 0 then
      begin
        consulta.Close;
        consulta.SQL.Text := 'update ito set itoacrescimoav=itoacrescimoav+ROUND( (' + buscatroca(CurrToStr(vlvaloradicionalSabor), ',', '.') +
          '),2) where itochave=' + vlicombo + ' and pcocodigo=' + vlpcombo;
        consulta.ExecSQL;

      end;

      consulta.Close;
      consulta.SQL.Text := 'select itototalav, itoacrescimoav from ito where itochave=' + vlicombo + ' and pcocodigo=' + vlpcombo;
      consulta.Open;

      vlTotalItensCombo := vlTotalItensCombo + consulta.FieldByName('itototalav').AsCurrency + consulta.FieldByName('itoacrescimoav').AsCurrency;

      consulta.Close;
      consulta.SQL.Text :=
        'SELECT punprecoav, isiquantidade FROM isi,pro,pun WHERE  isitipo=1 AND isi.procodigo=pro.procodigo and pun.procodigo=pro.procodigo and itochave='
        + vlicombo;
      consulta.Open;
      if (not consulta.IsEmpty) or (vlvaloradicionalSabor > 0) then
      begin
        vlCobrarAdicionais := vlvaloradicionalSabor + vlCobrarAdicionais +
          (consulta.FieldByName('punprecoav').AsCurrency * consulta.FieldByName('isiquantidade').AsFloat);
        vlListaAdicionaisItem.Add(vlicombo + '-' + Floattostr((consulta.FieldByName('punprecoav').AsCurrency * consulta.FieldByName('isiquantidade')
          .AsFloat) + vlvaloradicionalSabor));
      end;

    end;

    vlTotalItensCombo := vlTotalItensCombo;

    vlPercentual := vpCombo / vlTotalItensCombo;

    for i := 0 to vlListaItem.Count - 1 do
    begin

      vlicombo := Copy(vlListaItem.Strings[i], 1, pos('-', vlListaItem.Strings[i]) - 1);
      vlpcombo := Copy(vlListaItem.Strings[i], pos('-', vlListaItem.Strings[i]) + 1, 20);
      vlpcombo := Copy(vlpcombo, 1, pos('#', vlpcombo) - 1);

      consulta.Close;
      consulta.SQL.Text := 'update ito set itopercentualcombo=' + buscatroca(vlPercentual.ToString, ',', '.') + '    , itototalav=itototalav*(' +
        buscatroca(vlPercentual.ToString, ',', '.') + ') where itochave=' + vlicombo + ' and pcocodigo=' + vlpcombo;
      consulta.ExecSQL;

      for vliadicional := 0 to vlListaAdicionaisItem.Count - 1 do
      begin

        vlCobrarAdicional := vlListaAdicionaisItem.Strings[vliadicional];
        vlCobrarAdicional := Copy(vlCobrarAdicional, 1, pos('-', vlCobrarAdicional) - 1);

        vlItoAdicional := vlListaAdicionaisItem.Strings[vliadicional];
        vlItoAdicional := Copy(vlItoAdicional, pos('-', vlItoAdicional) + 1, 200);
        vlItoAdicional := StringReplace(vlItoAdicional, ',', '.', [rfReplaceAll, rfIgnoreCase]);

      end;

      if vlCobrarAdicional = vlicombo then
      begin
        consulta.Close;
        consulta.SQL.Text := 'update ito set itoacrescimoav=ROUND( (itoacrescimoav' + ' )*(' + buscatroca(vlPercentual.ToString, ',', '.') +
          '),2) where itochave=' + vlicombo + ' and itoacrescimoav<>0  and pcocodigo=' + vlpcombo;
        consulta.ExecSQL;
      end
      else
      begin
        consulta.Close;
        consulta.SQL.Text := 'update ito set itoacrescimoav=ROUND( itoacrescimoav*(' + buscatroca(vlPercentual.ToString, ',', '.') +
          '),2) where itochave=' + vlicombo + ' and pcocodigo=' + vlpcombo;
        consulta.ExecSQL;

      end;

      consulta.Close;
      consulta.SQL.Text := 'update ito set itovalorav= round(itototalav/itoquantidade,6) where itochave=' + vlicombo + ' and pcocodigo=' + vlpcombo;
      consulta.ExecSQL;

    end;

    vlTotalCombo := 0;

    for i := 0 to vlListaItem.Count - 1 do
    begin
      vlicombo := Copy(vlListaItem.Strings[i], 1, pos('-', vlListaItem.Strings[i]) - 1);
      vlpcombo := Copy(vlListaItem.Strings[i], pos('-', vlListaItem.Strings[i]) + 1, 20);
      vlpcombo := Copy(vlpcombo, 1, pos('#', vlpcombo) - 1);

      itocombo.Close;
      itocombo.ParamByName('orcchave').AsString := vpOrcChave;
      itocombo.FilterSQL := 'pcocodigo=' + vlpcombo;
      itocombo.Open;

      itocombo.First;

      if itocombo.Locate('itochave', vlicombo, []) then
      begin

        // while not itocombo.Eof do
        // begin
        sbi.Close;
        sbi.Params[0].AsString := vlicombo; // Self.itocombo.FieldByName('itochave').AsInteger;
        sbi.Open;

        if not sbi.IsEmpty then
        begin

          vlQtSbi := sbi.RecordCount;

          while not sbi.Eof do
          begin

            if (lito.FieldByName('puncodigo').AsString <> '') and (sbi.FieldByName('sbrcodigo').AsString <> '') then
            begin

              consulta.Close;
              consulta.SQL.Text := 'select spupreco from spu where sbrcodigo=' + sbi.FieldByName('sbrcodigo').AsString + ' and puncodigo=' +
                lito.FieldByName('puncodigo').AsString + ' and spuadicional=0 and  spu.procodigo=' + litoprocodigo.AsString;
              consulta.Open;

              if not consulta.IsEmpty then
              begin

                vlvalorSabor := consulta.FieldByName('spupreco').AsFloat / vlQtSbi;

              end
              else
              begin

                qpro.Close;
                qpro.Params[0].AsInteger := lito.FieldByName('procodigo').AsInteger;
                qpro.FilterSQL := 'puncodigo=' + lito.FieldByName('puncodigo').AsString;
                qpro.Open;

                vlvalorSabor := qpro.FieldByName('punprecoav').AsFloat / vlQtSbi;
              end;
            end;

            sbi.Next;

          end;

        end;

        // itocombo.Next;
      end;

    end;
    if itocombo.Active then
    begin
      itocombo.First;
      vlTotalCombo := 0;

      for i := 0 to vlListaItem.Count - 1 do
      begin
        vlicombo := Copy(vlListaItem.Strings[i], 1, pos('-', vlListaItem.Strings[i]) - 1);
        vlpcombo := Copy(vlListaItem.Strings[i], pos('-', vlListaItem.Strings[i]) + 1, 20);
        vlpcombo := Copy(vlpcombo, 1, pos('#', vlpcombo) - 1);

        if itocombo.Locate('itochave', vlicombo, []) then
        begin

          // while not itocombo.Eof do
          // begin
          if itocombo.FieldByName('itopercentualcombo').AsFloat <> 1 then
          begin
            vlTotalCombo := vlTotalCombo + itocombo.FieldByName('itototalav').AsFloat + itocombo.FieldByName('itoacrescimoav').AsFloat;
            vlitocombo := itocombo.FieldByName('itochave').AsInteger;
          end;

          // itocombo.Next;
          // end;

        end;
      end;

      vldifcombo := (vpCombo - (vlTotalCombo));

      if (vldifcombo > 0.01) and (vldifcombo < -0.01) then
      begin

        for i := 0 to vlListaItem.Count - 1 do
        begin
          vlicombo := Copy(vlListaItem.Strings[i], 1, pos('-', vlListaItem.Strings[i]) - 1);
          vlpcombo := Copy(vlListaItem.Strings[i], pos('-', vlListaItem.Strings[i]) + 1, 20);
          vlpcombo := Copy(vlpcombo, 1, pos('#', vlpcombo) - 1);

          if vlTotalCombo <> vpCombo then
          begin
            if itocombo.Locate('itochave', vlicombo, []) then
            begin

              vlTotalCombo := (vldifcombo / itocombo.FieldByName('itoquantidade').AsFloat);

              if vldifcombo < 0 then
              begin

                consulta.Close;
                consulta.SQL.Text := 'update ito set itovalorav=itovalorav' + buscatroca(Floattostr(vlTotalCombo), ',', '.') + ' where itochave='
                  + vlicombo;
                consulta.ExecSQL;

              end
              else
              begin

                consulta.Close;
                consulta.SQL.Text := 'update ito set itovalorav=itovalorav+' + buscatroca(Floattostr(vlTotalCombo), ',', '.') + ' where itochave='
                  + vlicombo;
                consulta.ExecSQL;
              end;

              consulta.Close;
              consulta.SQL.Text := 'update ito set  itototalav=itovalorav*itoquantidade where itochave=' + vlicombo;
              consulta.ExecSQL;

            end;
          end;

        end;
      end
      else
      begin
        vldifcombo := 0;
      end;

      vlbcombo := '';

      for i := 0 to vlListaItem.Count - 1 do
      begin
        vlicombo := Copy(vlListaItem.Strings[i], 1, pos('-', vlListaItem.Strings[i]) - 1);
        vlpcombo := Copy(vlListaItem.Strings[i], pos('-', vlListaItem.Strings[i]) + 1, 20);
        vlpcombo := Copy(vlpcombo, 1, pos('#', vlpcombo) - 1);
        vlbcombo := trim(Copy(vlListaItem.Strings[i], pos('#', vlListaItem.Strings[i]) + 1, 200));

        for vliadicional := 0 to vlListaAdicionaisItem.Count - 1 do
        begin

          if vlbcombo = '' then
          begin
            vlbcombo := '0';
          end;
          vlCobrarAdicional := vlListaAdicionaisItem.Strings[vliadicional];
          vlCobrarAdicional := Copy(vlCobrarAdicional, 1, pos('-', vlCobrarAdicional) - 1);

          vlItoAdicional := vlListaAdicionaisItem.Strings[vliadicional];
          vlItoAdicional := Copy(vlItoAdicional, pos('-', vlItoAdicional) + 1, 200);
          vlItoAdicional := StringReplace(vlItoAdicional, ',', '.', [rfReplaceAll, rfIgnoreCase]);

          if vlbcombo <> '0' then
          begin
            vlItoAdicional := vlItoAdicional + '+' + StringReplace(vlbcombo, ',', '.', [rfReplaceAll, rfIgnoreCase]);
          end;

        end;

        if vlItoAdicional = '' then
        begin
          vlItoAdicional := '0';
        end;

        if vlCobrarAdicional = vlicombo then
        begin

          consulta.Close;
          consulta.SQL.Text := 'update ito set itoacrescimoav=itoacrescimoav+' + vlItoAdicional + ' where itochave=' + vlicombo + ' and pcocodigo='
            + vlpcombo;
          consulta.ExecSQL;

        end;

      end;

      vlbcombo := '';

      for i := 0 to vlListaItem.Count - 1 do
      begin
        vlicombo := Copy(vlListaItem.Strings[i], 1, pos('-', vlListaItem.Strings[i]) - 1);
        vlpcombo := Copy(vlListaItem.Strings[i], pos('-', vlListaItem.Strings[i]) + 1, 20);
        vlpcombo := Copy(vlpcombo, 1, pos('#', vlpcombo) - 1);

        vlbcombo := trim(Copy(vlListaItem.Strings[i], pos('#', vlListaItem.Strings[i]) + 1, 200));
        vlbcombo := StringReplace(vlbcombo, ',', '.', [rfReplaceAll, rfIgnoreCase]);

        if vlbcombo = '' then
        begin
          vlbcombo := '0';
        end;

        if vlbcombo <> '0' then
        begin
          consulta.Close;
          consulta.SQL.Text := 'update ito set itoacrescimoav=itoacrescimoav+' + vlbcombo + ' where itochave=' + vlicombo + ' and pcocodigo='
            + vlpcombo;
          consulta.ExecSQL;
        end;

      end;

      VoltaCardapio;
      MontaTextoPedido;
    end;
  end
  else
  begin

    vlPunCodigo := punpuncodigo.AsString;
    VlpcoProCodigo := pro.FieldByName('procodigo').AsInteger;

    if vlPunCodigo <> '' then
    begin
      consulta.Close;
      consulta.SQL.Text := 'select punbarra from pun where puncodigo=' + vlPunCodigo;
      consulta.Open;

      VCBarra := consulta.Fields[0].AsString;

      VlpcoProCodigo := BuscaProdutoBarra(Application, conexao, VCBarra, vEmbalagem, vVariacao);

      if plUnidades.Visible then
      begin

        if edQtdaUni.Text = '' then
          edQtdaUni.Text := '0';

        vpItoUnidades := StrToInt(edQtdaUni.Text);
      end
      else
      begin

        if plQuantidadePro.Visible then
          vpItoUnidades := StrToFloat(edQtdaPro.Text);
      end;

      if plQuantidadePro.Visible then
        VQuantidade := StrToFloat(edQtdaPro.Text)
      else
        VQuantidade := 0;

      If VlpcoProCodigo > -1 Then
      begin
        vlItoChavecombo := IncluirNovoItemChave(VlpcoProCodigo, vEmbalagem, vVariacao, VQuantidade);

        consulta.Close;
        consulta.SQL.Text := 'SELECT itoquantidade FROM ito WHERE  itochave=' + vlItoChavecombo.ToString;
        consulta.Open;

        VQuantidade := consulta.FieldByName('itoquantidade').AsFloat;

        consulta.Close;
        consulta.SQL.Text :=
          'SELECT punprecoav, isiquantidade FROM isi,pro,pun WHERE  isitipo=1 AND isi.procodigo=pro.procodigo and pun.procodigo=pro.procodigo and itochave='
          + vlItoChavecombo.ToString;
        consulta.Open;

        if not consulta.IsEmpty then
        begin
          consulta.First;
          while not consulta.Eof do
          begin

            vlCobrarAdicionais := vlCobrarAdicionais + consulta.FieldByName('punprecoav').AsCurrency * consulta.FieldByName('isiquantidade').AsFloat;

            consulta.Next;
          end;
        end;

        vlQtdBordas := 0;

        pbri.Close;
        pbri.SQL.Text :=
          'SELECT brd.brdidentificacao, bri.itochave,  bri.brdcodigo,  pun.punprecoav,  pro.procodigo,  ito.itochave,  pun.pcoprocodigo ';
        pbri.SQL.Add('FROM bri ');
        pbri.SQL.Add('LEFT JOIN ito  ON bri.itochave = ito.itochave ');
        pbri.SQL.Add('LEFT JOIN brd  ON bri.brdcodigo = brd.brdcodigo ');
        pbri.SQL.Add('LEFT JOIN pro  on brd.procodigo = pro.procodigo ');
        pbri.SQL.Add('LEFT JOIN pun  ON pro.procodigo=pun.procodigo AND pun.unicodigo=ito.unicodigo  ');
        pbri.SQL.Add('where bri.itochave=:itochave and briincluir=1 ');
        pbri.Params[0].AsInteger := vlItoChavecombo;
        pbri.Open;

        pbri.First;
        while not pbri.Eof do
        begin
          vlQtdBordas := vlQtdBordas + 1;
          pbri.Next;
        end;

        pbri.First;
        while not pbri.Eof do
        begin
          vlBordas := vlBordas + ((pbri.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * VQuantidade);
          pbri.Next;
        end;
        vlTotalBordas := vlTotalBordas + vlBordas;

        consulta.Close;
        consulta.SQL.Text := 'update ito set  itoacrescimoav=' + buscatroca(Floattostr(((vlCobrarAdicionais * VQuantidade) + vlBordas) * 1), ',', '.')
          + ' where itochave=' + vlItoChavecombo.ToString;
        consulta.ExecSQL;

      end;

      VoltaCardapio;

    end;
  end;
end;

procedure TFprinciEnt.btMaisClick(Sender: TObject);
var
  i: Integer;
begin
  inherited;
  try
    i := StrToInt(edQtdaPro.Text) + 1;

    if i > 99 then
      i := 99;
  except
    i := 1;
  end;
  edQtdaPro.Text := inttostr(i);

end;

procedure TFprinciEnt.btMaisUniClick(Sender: TObject);
var
  i: Integer;
begin
  inherited;
  try
    i := StrToInt(edQtdaUni.Text) + 1;

    if i > 99 then
      i := 99;
  except
    i := 1;
  end;
  edQtdaUni.Text := inttostr(i);

end;

procedure TFprinciEnt.btMenosClick(Sender: TObject);
var
  i: Integer;
begin
  inherited;
  try
    i := StrToInt(edQtdaPro.Text) - 1;

    if i <= 0 then
      i := 1;
  except
    i := 1;
  end;
  edQtdaPro.Text := inttostr(i);

end;

procedure TFprinciEnt.btMenosUniClick(Sender: TObject);
var
  i: Integer;
begin
  inherited;
  try
    i := StrToInt(edQtdaUni.Text) - 1;

    if i <= 0 then
      i := 1;
  except
    i := 1;
  end;
  edQtdaUni.Text := inttostr(i);

end;

procedure TFprinciEnt.btMostraProdutosGrupoclick(Sender: TObject);
var
  vGrpCodigo: Integer;
begin
  pro.FilterSQL := '';
  edBuscaCardapio.Text := '';

  vGrpCodigo := grpgrpcodigo.AsInteger;
  plTituloCardapio.Caption := inttostr(grp.RecordCount) + ' ' + grpgrpidentificacao.AsString;
  sbGrupos.Visible := false;
  plBotaoVoltarCardapio.Visible := True;
  MontaBotoesProdutosNova(vGrpCodigo, grpgrpidentificacao.AsString);
end;

procedure TFprinciEnt.MontaBotoesGrupos;
begin

  sbListaProdutos.Width := 0;
  sbListaProdutos.Visible := false;
  plRodapeLista.Width := 300;

  grp.Close;
  grp.Open;

  grp.First;
end;

procedure TFprinciEnt.ActCancelaItemExecute(Sender: TObject);
begin
  if not Self.lito.IsEmpty then
  begin
    Application.CreateForm(TfListaItens, fListaItens);
    fListaItens.Dlito.DataSet := Self.lito;

    if fListaItens.ShowModal = mrok then
    begin
      inherited;
    end;

    btVerPedido.Click;
    recalculaTotal;
  end;
end;

procedure TFprinciEnt.ActCarregaPedidoExecute(Sender: TObject);
var
  vlOrcchave: string;
begin
  inherited;
  vpOrcChave := '';

  vpOrcChave := BuscaAtendimentos(mocDelivery);

  if vpOrcChave <> '' then
  begin
    vlOrcchave := vpOrcChave;
    ActAbreVenda.Execute;
    vpOrcChave := vlOrcchave;

    CarregaAtendimentos;

    Mostraclienteselecionado;
    plPedido.Visible := True;
    lista.Visible := false;
    btVerPedido.Visible := false;
    btAlteraPedido.Visible := True;
    MontaTextoPedido;

    cdbarra.SetFocus;
  end
  else if orc.Active then
    vpOrcChave := orcorcchave.AsString;

  recalculaTotal;
end;

procedure TFprinciEnt.ActChamaSenhaExecute(Sender: TObject);
begin
  inherited;

  if sbChamaSenha.Visible then
  begin
    vpPedidoChamar := '';
    Application.CreateForm(TfChamarSenha, fChamarSenha);

    if fChamarSenha.ShowModal = mrok then
    begin
      ChamaSenha;
    end;
  end;
end;

procedure TFprinciEnt.ActClientesExecute(Sender: TObject);
begin
  inherited;
  Mostraclienteselecionado;
end;

procedure TFprinciEnt.ActClientesSimplificadoExecute(Sender: TObject);
begin
  inherited;
  vPetdcodigo := MostraLista('mcle', 'formu', '');

  if (lito.RecordCount > 0) and (vPetdcodigo <> '') then
  begin
    if orc.State <> dsedit then
      orc.Edit;

    if pos('#', vPetdcodigo) > 0 then
    begin
      vpRetiraBalcao := Copy(vPetdcodigo, pos('@', vPetdcodigo) + 1, 10);

      if pos('|', vpRetiraBalcao) > 0 then
      begin
        vpRetiraBalcao := Copy(vpRetiraBalcao, 1, pos('|', vpRetiraBalcao) - 1);
      end;

      vPedrcodigo := Copy(vPetdcodigo, pos('#', vPetdcodigo) + 1, pos('@', vPetdcodigo) - 1);
      vPetdcodigo := Copy(vPetdcodigo, 1, pos('#', vPetdcodigo) - 1);

      if pos('$', vPedrcodigo) > 0 then
      begin
        vpTelCodigo := Copy(vPedrcodigo, pos('$', vPedrcodigo) + 1, 200);
        vPedrcodigo := Copy(vPedrcodigo, 1, pos('$', vPedrcodigo) - 1);

      end;

      Etd.Close;
      Etd.Params[0].AsString := vPetdcodigo;
      Etd.Params[1].AsString := vPedrcodigo;
      Etd.Open;

      if orc.State = dsbrowse then
        orc.Edit;

      Orcetdcodigo.AsString := vPetdcodigo;
      orcedrcodigo.AsString := vPedrcodigo;
      orcedritem.AsInteger := etdedritem.AsInteger;

      btVerPedido.Click;
    end;

  end;
end;

procedure TFprinciEnt.ActDescontoGeralExecute(Sender: TObject);
begin
  inherited;

  btVerPedido.Click;
  recalculaTotal;
end;

procedure TFprinciEnt.ActDescontoItemExecute(Sender: TObject);
var
  vlItoRecno: Integer;
  vlItoAcrescimoav: Double;

begin

  if not Self.lito.IsEmpty then
  begin
    vlItoRecno := lito.RecNo;
    lito.Close;
    lito.ParamByName('orcchave').AsString := vpOrcChave;
    lito.ParamByName('flacodigo').AsInteger := ACESSO.Filial;

    lito.Open;
    lito.RecNo := vlItoRecno;

    vlItoAcrescimoav := litoitosaldo.AsCurrency;
    Application.CreateForm(TfListaItens, fListaItens);
    fListaItens.Dlito.DataSet := Self.lito;

    if fListaItens.ShowModal = mrok then
    begin
      inherited;
    end;

    btVerPedido.Click;
    recalculaTotal;
  end;

end;

procedure TFprinciEnt.ActFinalizaVendaExecute(Sender: TObject);
begin
  inherited;
  if orc.Active then
  begin

    if orc.State <> dsedit then
      orc.Edit;

    if cfgcfgusasrv.AsInteger = 1 then
    begin
      consulta.Close;
      consulta.SQL.Text := 'SELECT ito.procodigo FROM ito, pro ';
      consulta.SQL.Add('WHERE ito.procodigo = pro.procodigo ');
      consulta.SQL.Add('AND ito.stocodigo IN (1, 2, 3) ');
      consulta.SQL.Add('AND pro.tpocodigo = 9');
      consulta.SQL.Add('AND ito.orcchave = ' + vpOrcChave);
      consulta.Open;

      if not consulta.IsEmpty then
      begin

        Orcmoccodigo.AsInteger := mocDelivery;
      end;
    end;

  end;

  if cfgcfgusacaixaprevenda.AsInteger = 1 then
  begin
    FinalizaPreVenda;
    Exit;
  end;

  inherited;
end;

procedure TFprinciEnt.CarregaCabecalhoPedido(vTexto: TstringList);
var

  vlpos: Integer;
  vlLinha: string;
  vlEtddoc1: string;
  vliRetira: Integer;

  vledrreferencia: string;

begin
  vliRetira := 0;
  vlLinha := vTexto[0];

  vlpos := pos(semacento('PEDIDO #'), vlLinha);
  vpNrPedidoAiqFome := Copy(vlLinha, vlpos + 8, 250);

  vlLinha := semacento(uppercase(vTexto[1]));

  vpHoraPedido := Copy(vlLinha, pos('(', vlLinha) + 9, 5);
  if pos(')', vpHoraPedido) > 0 then
  begin
    vpHoraPedido := Copy(vpHoraPedido, 1, length(vpHoraPedido) - 1);
  end;

  vpDataPedido := Copy(vlLinha, pos('(', vlLinha) + 1, 5) + '/' + inttostr(yearof(date));

  vlLinha := semacento(uppercase(vTexto[3]));
  vPetdidentificacao := semacento(uppercase(trim(Copy(vlLinha, 1, 200))));

  vlLinha := semacento(uppercase(vTexto[4]));

  if pos(',', vlLinha) > 0 then
  begin
    vlLinha := Copy(vlLinha, 1, pos(',', vlLinha) - 1);
    vPetftelefone := SoNumeros(vlLinha);
  end
  else
  begin
    vPetftelefone := SoNumeros(vlLinha);
  end;

  vlLinha := semacento(uppercase(vTexto[6]));

  if pos(uppercase(semacento('CPF NA NOTA:')), uppercase(vTexto[4])) > 0 then
  begin
    vlEtddoc1 := semacento(SoNumeros(trim(uppercase(vTexto[4]))));

    if vliRetira > 0 then
    begin

      vlLinha := semacento(vTexto[8]);
      vPedrrua := uppercase(trim(Copy(vlLinha, 1, PosaDireita('-', vlLinha) - 1)));
      vPedrnumero := uppercase(trim(Copy(vlLinha, PosaDireita('-', vlLinha) + 2, 20)));
      vlLinha := semacento(uppercase(vTexto[10]));
      vpRetiraBalcao := '1';

      if pos(uppercase(semacento('Complemento:')), uppercase(vlLinha)) > 0 then
      begin
        vPedrbairro := trim(uppercase(Copy(vlLinha, 1, pos(uppercase(semacento('Complemento:')), vlLinha) - 3)));

        vpEdrComplemento := trim(uppercase(Copy(vlLinha, pos(uppercase(semacento('Complemento:')), vlLinha) + 13, 200)));
      end
      else
      begin
        vPedrbairro := uppercase(vlLinha);
      end;

    end
    else
    begin

      vpRetiraBalcao := '0';
      // endereço         teste - 123
      vlLinha := semacento(vTexto[6]);
      vPedrrua := uppercase(trim(Copy(vlLinha, 1, PosaDireita('-', vlLinha) - 1)));
      vPedrnumero := uppercase(trim(Copy(vlLinha, PosaDireita('-', vlLinha) + 2, 20)));
      vlLinha := semacento(uppercase(vTexto[8]));


      // bairro Centro, Complemento: Rua boa

      if pos(uppercase(semacento('Complemento:')), uppercase(vlLinha)) > 0 then
      begin
        vPedrbairro := trim(uppercase(Copy(vlLinha, 1, pos(uppercase(semacento('Complemento:')), vlLinha) - 3)));

        vpEdrComplemento := trim(uppercase(Copy(vlLinha, pos(uppercase(semacento('Complemento:')), vlLinha) + 13, 200)));
      end
      else
      begin
        vPedrbairro := uppercase(vlLinha);
      end;
    end;

  end
  else
  begin

    if vliRetira > 0 then
    begin

      // endereço         teste - 123
      vlLinha := vTexto[8];

      vPedrrua := cfgedrrua.AsString;
      vPedrnumero := cfgedrnumero.AsString;
      vPedrbairro := cfgedrbairro.AsString;

      vpRetiraBalcao := '1';

    end
    else
    begin

      // endereço         teste - 123
      vlLinha := vTexto[4];
      vPedrrua := uppercase(trim(Copy(vlLinha, 1, PosaDireita('-', vlLinha) - 1)));
      vPedrnumero := uppercase(trim(Copy(vlLinha, PosaDireita('-', vlLinha) + 2, 20)));
      vlLinha := semacento(uppercase(vTexto[6]));

      vpRetiraBalcao := '0';
      // bairro Centro, Complemento: Rua boa

      if pos(uppercase(semacento('Complemento:')), uppercase(vlLinha)) > 0 then
      begin
        vPedrbairro := trim(uppercase(Copy(vlLinha, 1, pos(uppercase(semacento('Complemento:')), vlLinha) - 3)));

        vpEdrComplemento := trim(uppercase(Copy(vlLinha, pos(uppercase('Complemento:'), vlLinha) + 13, 200)));
      end
      else
      begin
        vPedrbairro := uppercase(vlLinha);

      end;

    end;
  end;

  verificacadastro.Close;
  verificacadastro.ParamByName('etdidentificacao').AsString := semacento(vPetdidentificacao);
  verificacadastro.ParamByName('edrrua').AsString := semacento(vPedrrua);
  verificacadastro.ParamByName('edrnumero').AsString := semacento(vPedrnumero);
  verificacadastro.ParamByName('etftelefone').AsString := semacento(vPetftelefone);
  verificacadastro.ParamByName('edrbairro').AsString := semacento(vPedrbairro);
  verificacadastro.Open;

  if verificacadastro.IsEmpty then
  begin
    etdimp.Open;
    etdimp.Append;

    etdimpetdidentificacao.AsString := vPetdidentificacao;
    etdimpetdapelido.AsString := vPetdidentificacao;
    etdimpetddeletar.AsInteger := 0;
    etdimptpecodigo.AsInteger := 1;
    etdimpetddatacad.AsFloat := strtodate(vpDataPedido);
    etdimpetddataalt.AsFloat := strtodate(vpDataPedido);
    if vlEtddoc1 <> '' then
    begin
      etdimpetddoc1.AsString := vlEtddoc1;
    end
    else
    begin
      etdimpetddoc1.AsString := '0';
    end;
    etdimptsecodigo.AsInteger := 2;
    etdimpetdcarga.AsInteger := 1;
    etdimpetdativo.AsInteger := 1;
    etdimpetdsped.AsInteger := 0;
    etdimptcbcodigo.AsInteger := 3;
    etdimpetdnfemodelos.AsInteger := 99;
    etdimpgrtcodigo.AsInteger := 1;
    etdimpatvcodigo.AsInteger := 0;
    etdimpetdregime.AsInteger := 1;
    etdimp.Post;

    vPetdcodigo := etdimpetdcodigo.AsString;

    etvimp.Close;
    etvimp.Open;
    etvimp.Append;
    etvimpetdcodigo.AsString := vPetdcodigo;
    etvimptvicodigo.AsInteger := 1;
    etvimp.Post;

    edrimp.Close;
    edrimp.Open;
    edrimp.Append;
    edrimptedcodigo.AsInteger := 1;
    edrimpetdcodigo.AsString := vPetdcodigo;
    edrimpedrrua.AsString := vPedrrua;
    edrimpedrnumero.AsString := vPedrnumero;
    edrimpedrcomple.AsString := vpEdrComplemento;
    edrimpedrbairro.AsString := vPedrbairro;
    edrimpcddcodigo.AsString := '5107925';
    edrimpedrinscest.AsString := '';
    edrimpedrcep.AsString := '78890-000';
    edrimpedrinsestst.AsString := '';
    edrimpufscodigo.AsString := '51';
    edrimpedrobs.AsString := vledrreferencia;
    edrimpedrinscmun.AsString := '';
    edrimpedritem.AsInteger := 1;
    edrimpedrnomefazenda.AsString := '';
    edrimpedrrazaofazenda.AsString := '';
    edrimpedrativo.AsInteger := 1;
    edrimp.Post;

    etfimp.Close;
    etfimp.Open;
    etfimp.Append;

    etfimpetdcodigo.AsString := vPetdcodigo;
    etfimpttfcodigo.AsInteger := 1;
    etfimpetftelefone.AsString := vPetftelefone;
    etfimpetfativo.AsInteger := 1;
    etfimp.Post;

    vPetdcodigo := etdimpetdcodigo.AsString;
    vPedrcodigo := edrimpedrcodigo.AsString;
    vPetfcodigo := etfimpetfcodigo.AsString;

  end
  else
  begin
    vPetdcodigo := verificacadastroetdcodigo.AsString;
    vPedrcodigo := verificacadastroedrcodigo.AsString;
    vPetfcodigo := verificacadastroetfcodigo.AsString;
  end;

end;

procedure TFprinciEnt.ChamaSenha;
begin

  consulta.Close;
  consulta.SQL.Text := 'INSERT INTO sts (stscodigo ,stsidentificacao ,stsipimpressora ) ';
  consulta.SQL.Add(' VALUES ( 1,' + QuotedStr('NOME DA IMPRISSORA') + ',' + QuotedStr('0.0.0.0') + ') ');
  consulta.SQL.Add(' ON DUPLICATE KEY UPDATE stscodigo=VALUES(stscodigo) ');
  consulta.ExecSQL;

  consulta.Close;
  consulta.SQL.Text := 'select cznchave, cznabertura from czn where cznfechamento IS null order by cznchave limit 1';
  consulta.Open;
  vpDataAberturaCZN := Copy(consulta.Fields[1].AsString, 1, 10);
  consulta.Close;

  consulta.Close;
  consulta.SQL.Text := 'select esenumero from ese where esedata = :data';
  consulta.ParamByName('data').AsDate := strtodate(vpDataAberturaCZN);
  consulta.Open;
  vpPedidoChamar := trim(vpPedidoChamar);

  if (vpPedidoChamar <> '') and (vpPedidoChamar <> '0') then
  begin

    if consulta.IsEmpty then
    begin

      consulta.Close;
      consulta.SQL.Text := 'insert into ese values (@chave, :data,' + vpPedidoChamar + ',0,1,0,0)';
      consulta.ParamByName('data').AsDate := strtodate(vpDataAberturaCZN);
      consulta.ExecSQL;

    end
    else
    begin

      consulta.Close;
      consulta.SQL.Text := 'UPDATE ese SET esenumero = ' + vpPedidoChamar + ' WHERE esedata = :data';
      consulta.ParamByName('data').AsDate := strtodate(vpDataAberturaCZN);
      consulta.ExecSQL;
    end;
  end;
end;

procedure TFprinciEnt.AjustaNumeroPedidoAtual(var vlNumePedidoAtual: string);
begin

  consulta.Close;
  consulta.SQL.Text := 'SELECT MAX(immnumepedido)+1 numero FROM imm WHERE cznchave=' + vpCznChave + ' AND immnumepedido<=4999';
  consulta.Open;

  if consulta.FieldByName('numero').AsInteger = 1 then
  begin
    consulta.Close;
    consulta.SQL.Text := 'SELECT  cfgmgoupedidelivery from cfgmgou';
    consulta.Open;

    vlNumePedidoAtual := consulta.FieldByName('cfgmgoupedidelivery').AsString;

    if vlNumePedidoAtual = '' then
    begin
      consulta.Close;
      consulta.SQL.Text := 'SELECT  cfgmgoupedideliveryinicial from cfgmgou';
      consulta.Open;

      vlNumePedidoAtual := consulta.FieldByName('cfgmgoupedideliveryinicial').AsString;

      consulta.Close;
      consulta.SQL.Text := 'update cfgmgou set cfgmgoupedidelivery=' + vlNumePedidoAtual + ' where cfgcodigo=1';
      consulta.ExecSQL

    end;

    vpImmNumePedido := vlNumePedidoAtual;

  end
  else
  begin

    vlNumePedidoAtual := consulta.FieldByName('numero').AsString;
    vpImmNumePedido := vlNumePedidoAtual;

  end;

  consulta.Close;
  consulta.SQL.Text := 'SELECT  cfgmgoupedidelivery from cfgmgou';
  consulta.Open;

  consulta.Edit;
  consulta.FieldByName('cfgmgoupedidelivery').AsString := vlNumePedidoAtual;
  consulta.Post;

end;

procedure TFprinciEnt.ActImprimeExecute(Sender: TObject);
var
  vDirRelat: String;
  i: Integer;
  vlOrcVias: Integer;
begin
  consulta.Close;
  consulta.SQL.Text := 'select orcvias from orc where orcchave=' + vpOrcChave;
  consulta.Open;
  if consulta.FieldByName('orcvias').AsInteger > 0 then
    vlOrcVias := consulta.FieldByName('orcvias').AsInteger
  else
    vlOrcVias := 1;

  for i := 1 to vlOrcVias do
  begin
    vDirRelat := ExtractFilePath(Application.ExeName) + 'report\ComprovanteDELIVERY.fr3';

    // ImprimirComprovantesOrc(Application, conexao, vpOrcChave, vDirRelat, trmtciporta.AsString, tiImprimir);

    ImpressaoInterna(Application, conexao, DSdados, vDirRelat, trmtciporta.AsString);

  end;
end;

procedure TFprinciEnt.ImprimirComprovanteVenda(vConexao: tuniconnection; vOrcchave, vDirRelat, vImpressora: String; vTipoImpressao: Integer);
var
  vtOrcChave: TVirtualTable;
  DSOrcChave: TUniDataSource;
begin
  vtOrcChave := TVirtualTable.Create(Owner);
  DSOrcChave := TUniDataSource.Create(Owner);

  try
    vtOrcChave.FieldDefs.Add('orcchave', ftInteger);

    DSOrcChave.DataSet := vtOrcChave;

    vtOrcChave.Clear;
    vtOrcChave.Close;
    vtOrcChave.Open;
    vtOrcChave.Append;
    vtOrcChave.FieldByName('orcchave').AsString := vOrcchave;
    vtOrcChave.Post;

    LocalImprimir(vConexao, DSOrcChave, vDirRelat, vTipoImpressao, vImpressora);

  finally
    vtOrcChave.Free;
    DSOrcChave.Free;
  end;
end;

Function TFprinciEnt.LocalImprimir(conexao: tuniconnection; Dados: TUniDataSource; DirRelatorio: String; TipoImpressao: Integer;
  Impressora: String = ''; vUsuCodigo: string = ''): String;

Var
  exec: Impressao;
  vNomeRotina: String;
  Vu: String;
  vpPackrfr: thandle;
Begin

  case TipoImpressao of
    tiImprimir:
      vNomeRotina := 'mrfrImpressao';
    tiGerador:
      vNomeRotina := 'mrfrGerador';
    tiImprimirDireto:
      vNomeRotina := 'mrfrImpressaoDireta';
  end;

  If vpPackrfr <> 0 Then
    Try
      @exec := GetProcAddress(vpPackrfr, pchar(vNomeRotina));

      If Assigned(exec) Then
        Vu := exec(Application, conexao, Dados, DirRelatorio, Impressora, Vu);

    Finally
      DoUnLoadPackage(Application, vpPackrfr);
    End;

End;

procedure TFprinciEnt.ActLimpaAtendimentoExecute(Sender: TObject);
var
  vlNumePedidoAtual: string;
begin

  if lito.Active then
  begin
    if lito.RecordCount > 0 then
    begin
      inherited;
    end;
  end;

  if (lito.Active) and (lito.RecordCount > 0) then
    if (Orcmoccodigo.AsInteger <> mocNovoRegistro) then
      Application.MessageBox(pchar('Atendimento cancelado com sucesso!'), 'Informação', MB_OK + MB_ICONEXCLAMATION)
    else If (Application.MessageBox(pchar('Deseja cancelar o atendimento ?'), 'Atenção', MB_YESNO + MB_DEFBUTTON2 + MB_ICONQUESTION) = IDNO) Then
      Exit;

  cdbarra.Text := '';
  plMensagemPrincipal.Visible := True;
  recalculaTotal;

  Ajustabotoes(false);
  plMensagemPrincipal.Visible := True;

  Try
    consulta.Close;
    consulta.SQL.Text := 'UPDATE orc SET stocodigo = 88 WHERE orcchave=' + vpOrcChave;
    consulta.ExecSQL;

    AtualizaSituacaoItens(vpOrcChave, stoCancelado, tdfMovimentoEmAndamento);

    consulta.Close;
    consulta.SQL.Text := 'DELETE FROM uoc WHERE orcchave=' + vpOrcChave;
    consulta.ExecSQL;

    consulta.Close;
    consulta.SQL.Text := 'DELETE imm.* FROM imm,ito WHERE imm.itochave=ito.itochave and orcchave=' + vpOrcChave;
    consulta.ExecSQL;


  //  AjustaNumeroPedidoAtual(vlNumePedidoAtual);

    lbnumepedido.Caption := 'Ped.: ' + vlNumePedidoAtual;

    orc.Refresh;
    lito.Refresh;

  Except
  End;

  Crianovoorc;
end;

procedure TFprinciEnt.IncluiValorEntrega(vlEtdCodigo, vlEdrCodigo: string);
var
  qIto: TUniQuery;
  vlItoChave: Integer;
  qImm: TUniQuery;
  vlTcicodigo: String;

begin

  if (vpOrcChave <> '') and (vpOrcChave <> '0') then
  begin
    lito.Close;
    lito.ParamByName('orcchave').AsString := vpOrcChave;
    lito.ParamByName('flacodigo').AsString := ACESSO.Filial.ToString;
    lito.Open;

    if (vlEdrCodigo <> '') and (vlEtdCodigo <> '') then
    begin

      if lito.Active then
      begin

        if litoorcchave.AsString <> '' then
        begin
          consulta.Close;
          consulta.SQL.Text := 'delete from ito where procodigo in (select procodigo from bai) and orcchave=' + vpOrcChave;
          consulta.ExecSQL;
        end;
      end;

      consulta.Close;
      consulta.SQL.Text := 'SELECT pun.punprecoav, bai.procodigo, bai.baiidentificacao, pun.puncodigo,pun.unicodigo, ';
      consulta.SQL.Add('edr.etdcodigo, edr.edritem FROM bai ');
      consulta.SQL.Add('INNER JOIN pro ON bai.procodigo = pro.procodigo ');
      consulta.SQL.Add('INNER JOIN pun ON pun.procodigo = pro.procodigo ');
      consulta.SQL.Add('RIGHT OUTER JOIN edr ON upper(edr.edrbairro) = upper(bai.baiidentificacao) ');
      consulta.SQL.Add('where edr.etdcodigo=' + vlEtdCodigo + ' and edr.edrcodigo=' + vlEdrCodigo);
      consulta.Open;

      if consulta.IsEmpty then
        Exit;

      if consulta.FieldByName('procodigo').AsString = '' then
        Exit;

      try
        qIto := TUniQuery.Create(Self);
        qIto.Name := 'qIto' + vlEtdCodigo;
        qIto.Connection := conexao;
        qIto.SQL.Text := 'SELECT itochave, orcchave, procodigo, puncodigo, unicodigo, stocodigo, ';
        qIto.SQL.Add('tdecodigo, itoquantidade, itovalorav, itodescontoav, itototalav, itosaldoav, ');
        qIto.SQL.Add('itovalorap, itodescontoap, itototalap, itosaldoap, itocontendo,  itoproservico, ');
        qIto.SQL.Add('itoprocomple, itodataalter, itoitem, itogint, itopercdescap,  itopercdescav, ');
        qIto.SQL.Add(' itoinfadprod, itoquanticondi, itoquantidevolcondi, vrpcodigo,clbatendente FROM ito limit 0');
        qIto.Open;
        qIto.Append;

        qIto.FieldByName('orcchave').AsString := vpOrcChave;
        qIto.FieldByName('procodigo').AsString := consulta.FieldByName('procodigo').AsString;
        qIto.FieldByName('puncodigo').AsString := consulta.FieldByName('puncodigo').AsString;
        qIto.FieldByName('unicodigo').AsString := consulta.FieldByName('unicodigo').AsString;
        qIto.FieldByName('stocodigo').AsString := '1';
        qIto.FieldByName('tdecodigo').AsString := '0';
        qIto.FieldByName('itoquantidade').AsString := '1';
        qIto.FieldByName('itovalorav').AsString := consulta.FieldByName('punprecoav').AsString;
        qIto.FieldByName('itodescontoav').AsString := '0';
        qIto.FieldByName('itototalav').AsString := consulta.FieldByName('punprecoav').AsString;
        qIto.FieldByName('itosaldoav').AsString := consulta.FieldByName('punprecoav').AsString;
        qIto.FieldByName('itovalorap').AsString := consulta.FieldByName('punprecoav').AsString;
        qIto.FieldByName('itodescontoap').AsString := '0';
        qIto.FieldByName('itototalap').AsString := consulta.FieldByName('punprecoav').AsString;
        qIto.FieldByName('itosaldoap').AsString := consulta.FieldByName('punprecoav').AsString;
        qIto.FieldByName('itocontendo').AsString := '1';
        qIto.FieldByName('itoproservico').AsString := '';
        qIto.FieldByName('itoprocomple').AsString := '';
        qIto.FieldByName('itoitem').AsString := '0';
        qIto.FieldByName('itopercdescap').AsString := '0';
        qIto.FieldByName('itopercdescav').AsString := '0';
        qIto.FieldByName('itoquanticondi').AsString := '0';
        qIto.FieldByName('itoquantidevolcondi').AsString := '0';
        qIto.FieldByName('clbatendente').AsInteger := ACESSO.Usuario;

        qIto.Post;
        vlItoChave := qIto.FieldByName('itochave').AsInteger;

        consulta.Close;
        consulta.SQL.Text := 'SELECT gri.tcicodigo, gri.griminuretardo FROM gri ';
        consulta.SQL.Add('inner JOIN pro ON gri.grpcodigo = pro.grpcodigo ');
        consulta.SQL.Add('and pro.procodigo=' + qIto.FieldByName('procodigo').AsString);
        consulta.Open;
        vlTcicodigo := consulta.Fields[0].AsString;

        consulta.Close;
        consulta.SQL.Text :=
          ' insert into imm (immchave, itochave, immmodo, immhorapedido, cznchave, clbcodigo,tcicodigo, immnumepedido ) values (@chave,  ' +
          inttostr(vlItoChave) + ',9,now(),' + vpCznChave + ',' + ACESSO.Usuario.ToString + ',' + vlTcicodigo + ',' + vpImmNumePedido + ')';
        consulta.ExecSQL;

        recalculaTotal;

      finally
        freeandnil(qIto);
      end;

    end
    else
    begin
      ActClientesSimplificado.Execute;

    end;
  end;
end;

procedure TFprinciEnt.itoAfterInsert(DataSet: TDataSet);
begin
  inherited;
  itoclbatendente.AsString := ACESSO.Usuario.ToString;
end;

procedure TFprinciEnt.ActPedidoExecute(Sender: TObject);
Var
  Nvp: Double;
  vltotal: Double;

  vModalResult: Integer;
  Retorno: String;
  vDirRelat: String;
  vlClbCodigo: string;
  vlFormaPagto: string;
  vlTrocoPara: string;
  vlEtdCodigo: string;
  vlEdrCodigo: string;
  vlTelCodigo: string;

  vlHora: string;
  vlMeschave: string;
  vlccxchave: string;

  vlDesconto: Double;
  vlOriCodigo: string;

  vlmestotal: Double;
  vlitemtotal: Double;
  vldiferenca: Double;
  vlitmchave: String;

  vlstrdife: String;

  vlNumePedidoAtual: string;

begin
  if Orcetdcodigo.AsInteger = 0 then
  begin

    vlEtdCodigo := MostraLista('mcle', 'formu', '');

    if (vlEtdCodigo = '') or (vlEtdCodigo = '#$') then
      Exit;

    if (lito.RecordCount > 0) and (vlEtdCodigo <> '') then
    begin
      if orc.State <> dsedit then
        orc.Edit;

      if pos('#', vlEtdCodigo) > 0 then
      begin
        vpRetiraBalcao := Copy(vlEtdCodigo, pos('@', vlEtdCodigo) + 1, 10);

        vlEdrCodigo := Copy(vlEtdCodigo, pos('#', vlEtdCodigo) + 1, 200);
        vlEtdCodigo := Copy(vlEtdCodigo, 1, pos('#', vlEtdCodigo) - 1);

        if pos('|', vpRetiraBalcao) > 0 then
        begin
          vpOriCodigo := trim(Copy(vpRetiraBalcao, pos('|', vpRetiraBalcao) + 1, 10));
          vpOriCodigo := trim(Copy(vpOriCodigo, pos('|', vpOriCodigo) + 1, 10));

          vpRetiraBalcao := Copy(vpRetiraBalcao, 1, pos('|', vpRetiraBalcao) - 1);

        end;

        vPetdcodigo := Copy(vlEtdCodigo, 1, pos('#', vlEtdCodigo) - 1);

        vPedrcodigo := Copy(vlEtdCodigo, pos('#', vlEtdCodigo) + 1, 50);
        vPedrcodigo := Copy(vPedrcodigo, 1, pos('$', vPedrcodigo) - 1);

        if pos('$', vlEdrCodigo) > 0 then
        begin
          vlTelCodigo := Copy(vlEdrCodigo, pos('$', vlEdrCodigo) + 1, 200);
          if pos('@', vlTelCodigo) > 0 then
          begin
            vlTelCodigo := Copy(vlTelCodigo, 1, pos('@', vlTelCodigo) - 1);
          end;

          vlEdrCodigo := Copy(vlEdrCodigo, 1, pos('$', vlEdrCodigo) - 1);

        end;
        if vlEdrCodigo = '' then
          vlEdrCodigo := '0';

        vPetdcodigo := vlEtdCodigo;

        Orcetdcodigo.AsString := vlEtdCodigo;
        orcedrcodigo.AsString := vlEdrCodigo;

        if Copy(vlTelCodigo, 1, 4) = '6666' then
        begin
          orcorctelefone.AsString := trim(Copy(vlTelCodigo, 3, 10));
        end
        else
        begin
          orcorctelefone.AsString := vlTelCodigo;
        end;
        consulta.Close;
        consulta.SQL.Text := 'select edrcodigo,edritem from edr where etdcodigo=' + vlEtdCodigo + ' and edrcodigo=' + vlEdrCodigo;
        consulta.Open;

        orcedrcodigo.AsString := consulta.Fields[0].AsString;
        orcedritem.AsString := consulta.Fields[1].AsString;

        consulta.Close;
        consulta.SQL.Text := 'select  baicodigo from edr,bai where  edr.edrbairro=bai.baiidentificacao and bai.sipcodigo=1   and etdcodigo=' +
          vlEtdCodigo + ' and edrcodigo=' + vlEdrCodigo;
        consulta.Open;
        vpbaicodigo := consulta.Fields[0].AsString;;

        orcbaicodigo.AsString := consulta.Fields[0].AsString;

        Etd.Close;
        Etd.Params[0].AsString := vlEtdCodigo;
        Etd.Params[1].AsString := vlEdrCodigo;
        Etd.Open;

        vPetdcodigo := vlEtdCodigo;

      end;

    end;

  end
  else
  begin
    vlEtdCodigo := Orcetdcodigo.AsString;
    vlEdrCodigo := orcedrcodigo.AsString;

    Etd.Close;
    Etd.Params[0].AsString := vlEtdCodigo;
    Etd.Params[1].AsString := vlEdrCodigo;
    Etd.Open;

    vPetdcodigo := vlEtdCodigo;
  end;

  try
    { * DANIEL
      12/09/2014 ajustado a variavel que recebe o código da entidade selecionada
      pois estava ficando zero mesmo para com um cliente pré selecionado * }
    vPetdcodigo := Self.etdetdcodigo.AsString;
    { * * }
    if lito.IsEmpty then
      Exit;

    If (orc.State = dsbrowse) Then
      orc.Edit;

    If vPetdcodigo = '0' Then
      Self.ActClientes.Execute;

    (* VpEtdCancelado - Identifica se usuário Canecelou lista de clientes *)
    if VpEtdCancelado then
    begin
      VpEtdCancelado := false;
      Exit;
    end;

    CriaPedidoGourmet;
    if (cfgcfgmgoucobraentrega.AsInteger = 1) and (vpRetiraBalcao = '0') then
    begin
      IncluiValorEntrega(vlEtdCodigo, vlEdrCodigo);
    end;

    btVerPedido.Click;
    vlDesconto := 0;
    Application.CreateForm(Tforcfpagtoent, Forcfpagtoent);
    Forcfpagtoent.Dregistro.DataSet := Self.orc;
    Forcfpagtoent.dtorcdataentrega.DateTime := strtodatetime(agora(Application, conexao));
    Forcfpagtoent.hrorchoraentrega.DateTime := strtodatetime(agora(Application, conexao));

    Forcfpagtoent.pltotal.Caption := 'Total do Pedido R$ ' + formatfloat('##,##0.00', vplValorLiquidoOp);
    Forcfpagtoent.plTotalLiquido.Caption := 'Liquido R$ ' + formatfloat('##,##0.00', vplValorLiquidoOp);

    Forcfpagtoent.vpTotalBruto := vplValorLiquidoOp;

    if cfgcfggouentregafutura.AsInteger = 1 then
      Forcfpagtoent.plProgramacaoEntrega.Visible := True
    else
      Forcfpagtoent.plProgramacaoEntrega.Visible := false;

    Forcfpagtoent.vpFinalizar := '1'; // cfgcfgmgoufinalizadelivery.AsString;

    vModalResult := Forcfpagtoent.ShowModal;

    If not(vModalResult = mrok) Then
    begin

      consulta.Close;
      consulta.SQL.Text := 'SELECT cfgmgoupedidelivery FROM cfgmgou ';
      consulta.Open;

      vlNumePedidoAtual := consulta.FieldByName('cfgmgoupedidelivery').AsString;


      Exit;
    end;

    vlDesconto := Forcfpagtoent.vpDesconto;
    vlFormaPagto := Forcfpagtoent.vpFormaPagto;
    vlTrocoPara := Forcfpagtoent.vpValorTroco;


    vpFinalizar := '1'; // cfgcfgmgoufinalizadelivery.AsString;

    If (orc.State = dsbrowse) Then
      orc.Edit;

    orcmdacodigo.AsString := vlFormaPagto;
    orcorcdataentrega.AsDateTime := Forcfpagtoent.dtorcdataentrega.DateTime;
    orcorchoraentrega.AsDateTime := Forcfpagtoent.hrorchoraentrega.DateTime;

    case StrToInt(vlFormaPagto) of
      mdaDinheiro:
        begin
          if vlTrocoPara <> '0,00' then
          begin
            orcorcobs.AsString := orcorcobs.AsString + #13 + 'Em Dinheiro - Levar troco para:  ' + vlTrocoPara;
          end
          else
          begin
            orcorcobs.AsString := orcorcobs.AsString + #13 + 'Em Dinheiro';
          end;
          vpValorFinalizador := vplValorLiquidoOp;
          vpTeclaFinalizador := 117; // F6
        end;
      mdaCartaoDebito:
        begin
          orcorcobs.AsString := orcorcobs.AsString + #13 + 'Levar máquina de Cartão - DÉBITO';
          vpValorFinalizador := vplValorLiquidoOp;
          vpTeclaFinalizador := 115; // F4

        end;
      mdaPix:
        begin
          orcorcobs.AsString := orcorcobs.AsString + #13 + 'PIX - NA MAQUINA DE CARTÃO';
          vpValorFinalizador := vplValorLiquidoOp;
          vpTeclaFinalizador := 119; // F4

        end;

      mdaCartaoCredito:
        begin
          orcorcobs.AsString := orcorcobs.AsString + #13 + 'Levar máquina de Cartão - CRÉDITO';
          vpValorFinalizador := vplValorLiquidoOp;
          vpTeclaFinalizador := 114; // F3

        end;
      mdaConvenio:
        begin
          orcorcobs.AsString := orcorcobs.AsString + #13 + 'Vai Assinar';
          vpValorFinalizador := vplValorLiquidoOp;
          vpTeclaFinalizador := 120; // F9
        end;
      mdaAFaturar:
        begin
          orcorcobs.AsString := orcorcobs.AsString + #13 + 'A Faturar';
          vpValorFinalizador := vplValorLiquidoOp;
          vpTeclaFinalizador := 121; // F10
        end;
      mdaOnLine:
        begin
          orcorcobs.AsString := orcorcobs.AsString + #13 + 'Já Pago - On Line';
          vpValorFinalizador := vplValorLiquidoOp;
          vpTeclaFinalizador := 122; // F11
        end;

    end;

    if vpRetiraBalcao = '1' then
      Self.Orcmoccodigo.AsInteger := mocRetiraBalcao
    else
      Self.Orcmoccodigo.AsInteger := mocDelivery;

    AtualizaSituacaoItens(vpOrcChave, stoEmAberto, tdfMovimentoEmAndamento);
    // SalvaColabItens(ACESSO.Usuario.ToString);
    Orcetdcodigo.AsString := vPetdcodigo;
    Orcstocodigo.AsInteger := stoEmAberto;
    vlHora := agora(Application, conexao);
    orcorchoraabert.AsFloat := strtodatetime(vlHora);
    orcpdscodigo.AsInteger := 2;

    orcoricodigo.AsString := vpOriCodigo;

    orcorcgeralav.AsCurrency := vplValorLiquidoOp + vlDesconto;
    orcorctotalav.AsCurrency := vplValorLiquidoOp;
    orccznchave.AsString := vpCznChave;

    orcccxchave.AsString := vpccxchave;
    orcbaicodigo.AsString := vpbaicodigo;

    AtualizaSituacaoItens(vpOrcChave, stoEmAberto, tdfMovimentoEmAndamento);
    Orcstocodigo.AsInteger := stoEmAberto;
    orcedritem.AsInteger := etdedritem.AsInteger;

    orc.Post;

    vpImprimiuDAV := True;
    vpImprimiuECF := True;
    vpImprimiuNFCe := True;
    vpImprimiuNFE := True;

    if vpFinalizar = '1' then
    begin

      // ActFinalizaVenda.Execute;
      consulta.Close;
      consulta.SQL.Text := 'SELECT ccx.ccxchave ' + '  FROM ccx,ctr ' + '  WHERE ctr.ctacodigo=ccx.ctacodigo and ctr.trmcodigo=' +
        ACESSO.Terminal.ToString + ' and ccx.clbcodigo = ' + inttostr(ACESSO.Usuario) + ' AND ccx.ccxdatafecha IS null ' +
        ' ORDER BY ccx.ccxchave DESC LIMIT 1';

      consulta.Open;

      vlccxchave := consulta.Fields[0].AsString;

      if vlccxchave = '' then
      begin
        consulta.Close;
        consulta.SQL.Text := 'SELECT ccx.ccxchave ' + '  FROM ccx,ctr ' + '  WHERE ctr.ctacodigo=ccx.ctacodigo and ctr.trmcodigo=' +
          ACESSO.Terminal.ToString + ' and  ccx.ccxdatafecha IS null ' + ' ORDER BY ccx.ccxchave DESC LIMIT 1';

        consulta.Open;

        vlccxchave := consulta.Fields[0].AsString;

      end;

      CriaPedidoGourmet;

      consulta.Close;
      consulta.SQL.Text := 'update imm set  immnumepedido=' + vpImmNumePedido + ',  cznchave=' + vpCznChave +
        ' where itochave in (select itochave from ito where ' + '  orcchave=' + vpOrcChave + ' and stocodigo<>88)';
      consulta.ExecSQL;

      AjustaHoraImprimir(vpOrcChave);

      AtualizaSituacaoItens(vpOrcChave, stoVendido, tdfMovimentoEmAndamento);

      orc.Edit;
      orcpdscodigo.AsInteger := 2;
      orcoricodigo.AsString := vpOriCodigo;
      orcorcnumeropedido.AsString := vpImmNumePedido;
      Orcstocodigo.AsInteger := stoVendido;
      orcccxchave.AsString := vlccxchave;
      orcedritem.AsInteger := etdedritem.AsInteger;

      orc.Post;

      if vpTeclaFinalizador = 121 then
        vlMeschave := ProcessaVendas(vpOrcChave, True)
      else
        vlMeschave := ProcessaVendas(vpOrcChave, false);

      Finaliza(vlMeschave);

      if vlMeschave <> '' then
      begin
        consulta.Close;
        consulta.SQL.Text :=
          'select mes.oricodigo, ori.etdcodigo orietdcodigo, mes.etdcodigo mesetdcodigo, mes.meschave  from mes,ori,mor where mes.oricodigo=ori.oricodigo and mes.meschave=mor.meschave and mor.orcchave='
          + vpOrcChave;
        consulta.Open;

        if not consulta.IsEmpty then
        begin
          vlMeschave := consulta.FieldByName('meschave').AsString;

          if (consulta.FieldByName('orietdcodigo').AsString <> '') and (consulta.FieldByName('orietdcodigo').AsString <> '0') then
          begin

            if (consulta.FieldByName('orietdcodigo').AsString <> consulta.FieldByName('mesetdcodigo').AsString) then
            begin
              vlOriCodigo := consulta.FieldByName('orietdcodigo').AsString;

              consulta.Close;
              consulta.SQL.Text := 'UPDATE rfi,rfm SET rfi.etdcodigo=' + vlOriCodigo + ' WHERE rfi.rfichave=rfm.rfichave AND rfm.meschave=' +
                vlMeschave;
              consulta.ExecSQL;

              consulta.Close;
              consulta.SQL.Text := 'UPDATE v_rfi,rfm SET v_rfi.etdcodigo=' + vlOriCodigo + ' WHERE v_rfi.rfichave=rfm.rfichave AND rfm.meschave=' +
                vlMeschave;
              consulta.ExecSQL;

              consulta.Close;
              consulta.SQL.Text := 'UPDATE tit,rfi,rfm SET tit.etdcodigo=' + vlOriCodigo +
                ' WHERE tit.titcodigo=rfi.titcodigo and rfi.rfichave=rfm.rfichave AND rfm.meschave=' + vlMeschave;
              consulta.ExecSQL;

            end;
          end;
        end;

      end;

    end;

    vlmestotal := 0;
    vlitemtotal := 0;
    vldiferenca := 0;
    vlitmchave := '';

    if vlMeschave <> '' then
    begin

      consulta.Close;
      consulta.SQL.Text := '';
      consulta.SQL.Text := 'select mesvalor from mes where meschave=' + vlMeschave;
      consulta.Open;
      vlmestotal := consulta.FieldByName('mesvalor').AsFloat;

      consulta.Close;
      consulta.SQL.Text := '';
      consulta.SQL.Text := 'select itmchave, itmtotal from itm where meschave=' + vlMeschave;
      consulta.Open;

      while not consulta.Eof do
      begin
        vlitemtotal := vlitemtotal + consulta.FieldByName('itmtotal').AsFloat;

        consulta.Next;
      end;

      vlitmchave := consulta.FieldByName('itmchave').AsString;

      vldiferenca := vlmestotal - vlitemtotal;

      { if vldiferenca <> 0 then
        begin
        vldiferenca := consulta.FieldByName('itmtotal').AsCurrency + vldiferenca;

        vlstrdife := vldiferenca.ToString;
        vlstrdife := StringReplace(vlstrdife, '.', '', [rfReplaceAll, rfIgnoreCase]);
        vlstrdife := StringReplace(vlstrdife, ',', '.', [rfReplaceAll, rfIgnoreCase]);

        if vlitmchave <> '' then
        begin
        consulta.Close;
        consulta.SQL.Text := '';
        consulta.SQL.Text := 'update itm set itmtotal=' + vlstrdife + ' where itmchave=' + vlitmchave;
        consulta.ExecSQL;

        end;
        end;
      }

    end;

    consulta.Close;
    consulta.SQL.Text := 'update ito set oricodigo=' + orcoricodigo.AsString + ' where orcchave=' + orcorcchave.AsString;
    consulta.ExecSQL;

    Clipboard.Clear;
    Clipboard.AsText := PedidoCabecalho.Text;

    if FileExists(ExtractFilePath(Application.ExeName) + 'report\ComprovanteDELIVERY.fr3') then
      Self.ActImprime.Execute;

    Crianovoorc;
    AtualizaListasdePedidos;
  finally
    freeandnil(Forcfpagtoent);
  end;
end;

Function TFprinciEnt.Finaliza(Vchave: String; vMostrarLote: Boolean = false): String;
Var
  vlRegistra: Tregistralotedatagourmet;

  Vpri: String;
  Vjur: String;
  vMulta: String;
  Vdes: String;
  vPodeConvenio: Boolean;

  vConfiguracoesTEF: TConfiguracoesTEF;

  vlPacklte: cardinal;
  vlTotalBruto: Double;

  vlccxchave: Integer;
  vlDia: Tdate;
  vlTeclaFinalizador: Integer;
  vlValorFinalizador: Double;

Begin

  If not orc.Active Then
    Exit;

  if lito.IsEmpty then
    Exit;


  // VpEtdCancelado - Identifica se usuário Cancelou lista de clientes

  vConfiguracoesTEF := CarregaConfiguracoesTEF(vConfiguracoesTEF);

  if vConfiguracoesTEF.NumeroTerminalTEF <> '' then
  begin
    vlPacklte := LoadPackage('modulos\mlteTEF.bpl');
  end
  else
  begin
    vlPacklte := LoadPackage('modulos\mlte.bpl');
  end;

  If vlPacklte <> 0 Then
    Try
      @vlRegistra := GetProcAddress(vlPacklte, pchar('registralotedatagourmet'));
      If Assigned(vlRegistra) Then
      Begin

        if (orcorcgeralav.AsCurrency = orcorctotalav.AsCurrency) and (orcorcdescontoav.AsCurrency <> 0) then
        begin
          orc.Edit;
          orcorcgeralav.AsCurrency := orcorctotalav.AsCurrency + orcorcdescontoav.AsCurrency;

          orc.Post;
        end;


        vlTotalBruto := Self.orcorcgeralav.AsCurrency; // + vpTotalAcrescimoav;

        Vpri := buscatroca(Floattostr(RoundTo(vlTotalBruto, -2)), ',', '.');
        Vdes := buscatroca(Self.orcorcdescontoav.AsString, ',', '.');
        Vjur := '0';
        vMulta := '0';

        if vPetdcodigo = '0' then
          vPodeConvenio := false
        else
          vPodeConvenio := True;

        if cfgcfgmgoucontrolaentrega.AsInteger = 1 then
        begin

          vpCtaCodigo := cfgcfgmgouctadelivery.AsString;
        end
        else
        begin
          vpCtaCodigo := trmctacodigo.AsString;
        end;

        consulta.Close;
        consulta.SQL.Text := 'SELECT ccx.ccxchave , ccx.ccxdataber , ccx.ccxhoraaber, clb.clbidentificacao FROM ccx ';
        consulta.SQL.Add('INNER JOIN clb ON ccx.clbcodigo = clb.clbcodigo ');
        consulta.SQL.Add('WHERE ccx.ctacodigo = ' + vpCtaCodigo + ' ');
        consulta.SQL.Add('AND ccx.ccxdatafecha IS NULL order by ccxchave desc limit 1');
        consulta.Open;

        vlccxchave := consulta.FieldByName('ccxchave').AsInteger;

        vlDia := strtodate(hoje(Application, conexao));

        consulta.Close;
        consulta.SQL.Text := 'select etdcodigo, orcgeralav, orcdescontoav, orctotalav, clbentregador, orcobs, mdacodigo from orc where orcchave=' +
          vpOrcChave;
        consulta.Open;

        if not consulta.IsEmpty then
        begin
          if (consulta.FieldByName('mdacodigo').AsString <> '0') and (trim(consulta.FieldByName('mdacodigo').AsString) <> '') then
          begin

            case consulta.FieldByName('mdacodigo').AsInteger of
              0:
                vlTeclaFinalizador := 117; // Não se Aplica - Dinheiro
              1:
                vlTeclaFinalizador := 117; // Não se Aplica - Dinheiro
              4:
                vlTeclaFinalizador := 114; // F3	Cartão Crédito
              5:
                vlTeclaFinalizador := 115; // F4	Cartão Débito
              6:
                vlTeclaFinalizador := 119; // F8	PIX
              7:
                vlTeclaFinalizador := 120; // F9	Convênio
              9:
                vlTeclaFinalizador := 121; // A Faturar
              78:
                vlTeclaFinalizador := 122; // On Line

            end;

          end
          else
          begin

            if pos(uppercase('Dinheiro'), uppercase(consulta.FieldByName('orcobs').AsString)) > 0 then
            begin
              vlTeclaFinalizador := 117; // F6
            end
            else if pos(uppercase('Levar máquina de Cartão - DÉBITO'), uppercase(consulta.FieldByName('orcobs').AsString)) > 0 then
            begin
              vlTeclaFinalizador := 115; // F4
            end
            else if pos(uppercase('Levar máquina de Cartão - CRÉDITO'), uppercase(consulta.FieldByName('orcobs').AsString)) > 0 then
            begin
              vlTeclaFinalizador := 114; // F3
            end
            else if pos(uppercase('PIX'), uppercase(consulta.FieldByName('orcobs').AsString)) > 0 then
            begin
              vlTeclaFinalizador := 119; // F8
            end

            else if pos(uppercase('Vai Assinar'), uppercase(consulta.FieldByName('orcobs').AsString)) > 0 then
            begin
              vlTeclaFinalizador := 120; // F9
            end
            else if pos(uppercase('A Faturar'), uppercase(consulta.FieldByName('orcobs').AsString)) > 0 then
            begin
              vlTeclaFinalizador := 121
            end
            else if pos(uppercase('Já Pago - On Line'), uppercase(consulta.FieldByName('orcobs').AsString)) > 0 then
            begin
              vlTeclaFinalizador := 122
            end;

          end;
        end;

        if vMostrarLote then
          vpValorFinalizador := 0;

        result := vlRegistra(Application, conexao, Vchave, ACESSO.Terminal.ToString, Vpri, vMulta, Vjur, Vdes, ACESSO, inttostr(tfdVenda), vlDia,
          vPodeConvenio, vlTeclaFinalizador, vpValorFinalizador, True, StrToInt(vpCtaCodigo), false, True, vlccxchave, vPetdcodigo.ToInteger);

      End;
    Finally
      DoUnLoadPackage(Application, vlPacklte);
    End;

End;



procedure TFprinciEnt.ProcessaTaclasRapidas(Key: Word; Shift: TShiftState);
var
  Tecla: Word;
begin
  Tecla := Key;
  if Shift = [ssCtrl] then
  begin
    case Tecla of
      73:
        ActCancelaItem.Execute;
      85:
        ActLimpaAtendimento.Execute;
      68:
        ActDescontoItem.Execute;
      71:
        ActDescontoGeral.Execute;
    end;
  end
  else
  begin
    case Tecla of
      38:
        if lito.Active then
          Dlito.DataSet.Prior;
      40:
        if lito.Active then
          Dlito.DataSet.Next;
      115:
        ActQuantidade.Execute;
      46048:
        ActQuantidade.Execute;

      117:
        ActFinalizaVenda.Execute;
      118:
        ActClientes.Execute;
      119:
        ActProdutos.Execute;
      120:
        if ActAFaturar.Visible then
          ActAFaturar.Execute;

    end;
    (* NENHUMA DAS OPÇÕES DEVOLVE VALOR DAS TECLAS *)
  end;
end;

function TFprinciEnt.ProcessaVendas(vOrcchave: string; vAFaturar: Boolean = false): string;
var
  Processa: TProcessaOrc;

  vmeschave: String;
  vlOrcchave: string;
begin

  vmeschave := '';
  vlOrcchave := vOrcchave;

  If vlPackopm <> 0 Then
    Try
      @Processa := GetProcAddress(vlPackopm, pchar('ProcessaOrc'));

      If Assigned(Processa) Then
      Begin
        vmeschave := '0';
        vmeschave := Processa(Application, conexao, vlOrcchave, ACESSO, vAFaturar);
      End;
    Finally
      // DoUnLoadPackage(Pack);
    End;

  If (vmeschave <> '0') and (vmeschave <> '') Then
  Begin

    consulta.Close;
    consulta.SQL.Text := 'update orc set stocodigo=' + inttostr(stoVendido) + ' where orcchave=' + vlOrcchave;
    consulta.ExecSQL;

    AtualizaSituacaoItens(vlOrcchave, stoVendido, tdfMovimentoEmAndamento);

  End;

  result := vmeschave;

end;

procedure TFprinciEnt.AjustaHoraImprimir(vOrcchave: string);
var
  vlItoChave: string;
  vlAgoraServer: string;
  vlProCodigo: string;
  vlMaiorTempo: Integer;
  vlSegundos: Integer;
  vlhoraImprimir: TDateTime;
  vlshoraImprimir: String;
begin

  immimp.Close;
  immimp.Params[0].AsString := vpImmNumePedido;
  immimp.Params[1].AsString := vpCznChave;
  immimp.Open;

  while not immimp.Eof do
  begin

    consulta.Close;
    consulta.SQL.Text := 'select procodigo from ito, imm where imm.itochave=ito.itochave and imm.immchave=' + immimpimmchave.AsString;
    consulta.Open;
    vlProCodigo := consulta.Fields[0].AsString;

    immimp.Edit;

    consulta.Close;
    consulta.SQL.Text := 'SELECT gri.tcicodigo, gri.griminuretardo FROM gri ';
    consulta.SQL.Add('INNER JOIN pro ON gri.grpcodigo = pro.grpcodigo');
    consulta.SQL.Add(' and pro.procodigo=' + vlProCodigo);
    consulta.Open;

    vlAgoraServer := agora(Application, conexao);
    immimpimmtemporetardo.AsInteger := consulta.Fields[1].AsInteger;

    try


      // vlshoraImprimir := datetimetostr(IncMinute(strtodatetime(vlAgoraServer), 35));


      // immimpimmhoraimprimir.AsString := vlshoraImprimir;

      immimpimmhoraimprimir.AsString := datetimetostr(strtodatetime(vlAgoraServer));

    except
      immimpimmhoraimprimir.AsString := datetimetostr(strtodatetime(vlAgoraServer));
    end;

    immimp.Post;

    immimp.Next;
  end;
  vlMaiorTempo := 0;

end;

procedure TFprinciEnt.ActProdutosExecute(Sender: TObject);
Var
  vlRetorno: String;
  vlFiltro: String;
begin


  // inherited;

  vlFiltro := '(pro.tpocodigo=''0'' or pro.tpocodigo=''4'' or pro.tpocodigo=''9'')';

  vlRetorno := MostraLista('mpro', vlFiltro);
  If vlRetorno <> '' Then
    If StrToInt(vlRetorno) > 0 Then
      IncluirNovoItem(StrToInt(vlRetorno), 0);

  if vlRetorno <> '' then
  begin
    consulta.Close;
    consulta.SQL.Text := 'select cpbuniadesporkg from cpb where procodigo=' + vlRetorno;
    consulta.Open;

    if (consulta.FieldByName('cpbuniadesporkg').AsInteger <> 0) and (consulta.FieldByName('cpbuniadesporkg').AsInteger <> 1) then
    begin

      funidades := Tfunidades.Create(Application);
      funidades.Dito.Edit;
      funidades.Dito.DataSet := Ito;

      if funidades.ShowModal = mrok then
      begin

        try
          Ito.Edit;
          itoitoquantidade.AsFloat := ((1 / consulta.FieldByName('cpbuniadesporkg').AsFloat) * itoitounidades.AsInteger);
          Ito.Post;
        except
          Ito.Cancel;
        end;

      end;

      plPedido.Visible := True;
      lista.Visible := false;
      btVerPedido.Visible := false;
      btAlteraPedido.Visible := True;
      MontaTextoPedido;

    end;

  end;

end;

procedure TFprinciEnt.ActQuantidadeExecute(Sender: TObject);
Var
  Clicou: Boolean;
  Squantidade: String;
  VQuantidade: Double;
Begin
  if not lito.Active then
    Exit;

  VQuantidade := 1;

  if not Self.lito.IsEmpty then
  begin
    Application.CreateForm(TfListaItens, fListaItens);
    fListaItens.Dlito.DataSet := Self.lito;

    if fListaItens.ShowModal = mrok then
    begin
      If not(Ito.Locate('itochave', Litoitochave.AsInteger, [])) Then
        Exit;

      Clicou := InputQuery('Quantidade', 'Digite a nova quantidade:', Squantidade);

      If Clicou Then
      Begin
        Try
          VQuantidade := StrToFloat(Squantidade);
        Except
          Application.MessageBox(pchar('Quantidade inválida!'), 'Atenção', MB_ICONWARNING + MB_OK);
          Exit;
        End;

        AjustaQuantidade(VQuantidade, taqFinal);
      End;

      recalculaTotal;
      plPedido.Visible := True;
      lista.Visible := false;
      btVerPedido.Visible := false;
      btAlteraPedido.Visible := True;
      btVerPedido.Click;
    end;
  end;

end;

procedure TFprinciEnt.ActReimprimeComprovanteExecute(Sender: TObject);
begin
  // inherited;

  MostraLista('mrdo', 'tdfcodigo=' + QuotedStr('00')); // + ' and mes.oricodigo not in (1,2,4,6) ');
  // MostraLista('mrdo', 'mes.tdfcodigo=' + QuotedStr('00')+ ' and mes.oricodigo not in (1,2,4,6) ');

end;

procedure TFprinciEnt.ActVerEntregasExecute(Sender: TObject);
var
  vlArq: string;
begin

  vlArq := ExtractFilePath(Application.ExeName) + 'AtendSai.exe';
  if FileExists(vlArq) then
    ExecuteAndWait(vlArq);

end;

procedure TFprinciEnt.ActVerPedidosExecute(Sender: TObject);
begin
  inherited;
  Application.CreateForm(tfpedidos, fpedidos);
  fpedidos.orcs.Connection := conexao;

  fpedidos.sbAtualizar.Click;
  fpedidos.ShowModal;
end;

Procedure TFprinciEnt.Ajustabotoes(Situacao: Boolean);
Begin

  ActQuantidade.Enabled := Situacao;
  ActCancelaItem.Enabled := Situacao;

  if cfgcfgusacaixaprevenda.AsInteger = 1 then
    ActAFaturar.Visible := false;

  ActAFaturar.Enabled := Situacao;

  ActDescontoItem.Enabled := Situacao;
  ActDescontoGeral.Enabled := Situacao;

  if (Situacao = True) and (Orcmoccodigo.AsInteger in [mocOrcamento, mocCondicional, mocOrdemServico, mocDelivery]) then
    ActLimpaAtendimento.Enabled := false
  else
    ActLimpaAtendimento.Enabled := Situacao;

  ActPedido.Enabled := Situacao;
  ActClientes.Enabled := Situacao;

  PCpaginas.Visible := Situacao;
  PlEsquerda.Visible := Situacao;
  PlDetalhe.Visible := Situacao;
  plDireitaDetalhe.Visible := True;

  ActClientes.Enabled := Situacao;
  ActProdutos.Enabled := Situacao;

  ActQuantidade.Enabled := Situacao;

  ActCancelaItem.Enabled := Situacao;
  ActDescontoItem.Enabled := Situacao;
  ActDescontoGeral.Enabled := Situacao;

  ActFinalizaVenda.Enabled := Situacao;

  ActQuantidade.Enabled := Situacao;

  ActDescontoItem.Enabled := Situacao;
  ActDescontoGeral.Enabled := Situacao;
  ActSangria.Enabled := Situacao;
  ActSuprimento.Enabled := Situacao;
  // ActAbreCaixa.Enabled := Situacao;

  PlEsquerda.Visible := Situacao;
  PlDetalhe.Visible := Situacao;
  ActSair.Enabled := Situacao;

  PlDadosAtend.Visible := Situacao;

  if cfgcfgidentificavendedor.AsInteger = 1 then
    LbVendedor.Visible := Situacao;

  if Situacao = false then
  begin
    ActAbreVenda.Enabled := True;
    ActSair.Enabled := True;
    ActSangria.Enabled := True;
    ActSuprimento.Enabled := True;
    // ActAbreCaixa.Enabled := True;

    plMensagemPrincipal.Visible := True;

    GBBusca.Visible := True;
    // GBSalvar.Visible := false;
  end
  else
  begin
    ActAbreVenda.Enabled := false;
    ActSair.Enabled := false;

    plMensagemPrincipal.Visible := false;
    GBBusca.Visible := false;
    // GBSalvar.Visible := true;

    LbOrcChave.Caption := 'Nº: ' + vpOrcChave;
  end;

  if vpCaixaAberto = 0 then
  begin
    ActSangria.Enabled := false;
    ActSuprimento.Enabled := false;
    // ActAbreCaixa.Enabled := True;
    // ActFechaCaixa.Enabled := false;
    ActClientes.Enabled := false;
    ActProdutos.Enabled := false;
  end
  else
  begin
    // ActFechaCaixa.Enabled := True;
    // ActAbreCaixa.Enabled := false;
  end;

  ActAbreGaveta.Enabled := True;

  if not plMensagemPrincipal.Visible then
  begin
    ActSangria.Enabled := false;
    ActSuprimento.Enabled := false;
    ActAbreGaveta.Enabled := false;
    // ActFechaCaixa.Enabled := false;
  end;

  AtualizaStatusAtend;
End;

procedure TFprinciEnt.AtualizaStatusAtend;
var
  vStatusAtual: String;
begin
  case Orcmoccodigo.AsInteger of
    mocNovoRegistro:
      vStatusAtual := 'Novo Registro';
    mocOrcamento:
      vStatusAtual := 'Orçamento - Em Edição';
    mocDelivery:
      vStatusAtual := 'Pedido - Em Edição';
    mocOrdemServico:
      vStatusAtual := 'Ordem de Serviço - Em Edição';

  else
    vStatusAtual := '';
  end;

  if not orc.Active then
    vStatusAtual := 'Novo Registro';

end;

procedure TFprinciEnt.btAlteraPedidoClick(Sender: TObject);
begin
  inherited;
  plPedido.Visible := false;
  lista.Visible := True;
  btalteraritem.Visible := True;
  btAlteraPedido.Visible := false;
  btVerPedido.Visible := True;
end;

procedure TFprinciEnt.btAlteraPedidoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  ProcessaTaclasRapidas(Key, Shift);
end;

procedure TFprinciEnt.btalteraritemClick(Sender: TObject);
begin
  inherited;

  listaDblClick(lista);

end;

procedure TFprinciEnt.btLimpaBuscaCardapioClick(Sender: TObject);
begin
  inherited;
  edBuscaCardapio.Text := '';
end;

procedure TFprinciEnt.btVerPedidoClick(Sender: TObject);
begin
  inherited;
  plPedido.Visible := True;
  lista.Visible := false;
  btalteraritem.Visible := false;
  btVerPedido.Visible := false;
  btAlteraPedido.Visible := True;
  recalculaTotal;
  MontaTextoPedido;
end;

procedure TFprinciEnt.btVerPedidoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  ProcessaTaclasRapidas(Key, Shift);
end;

procedure TFprinciEnt.cdbarraKeyPress(Sender: TObject; var Key: Char);
Var
  VCBarra: String;
  vProduto: Integer;
  vEmbalagem: Integer;
  vVariacao: Integer;
  Vquanti: Double;
  VQuantidade: Double;
  vlLocalizouItem: Boolean;
  vlUnidade: Integer;
  S: String;
  iValue, iCode: Integer;

Begin
  S := Key;
  val(S, iValue, iCode);
  if (iCode <> 0) and (Key <> #8) and (Key <> #13) then
  begin
    Key := #0;
  end;

  VCBarra := cdbarra.Text;

  // SE CAMPO TEM VALOR DIGITADO SISTEMA LOCALIZA PRODUTO PARA INSERIR OU CANCELAR
  If ((VCBarra <> '')) Then
  Begin

    //
    // *****  LOCALIZA E INSERE PRODUTO NO ORÇAMENTO OU CANCELA ITENS DO CONDICIONAL *****
    //

    If (Key = #13) Then
    Begin

      vProduto := BuscaProdutoBarra(Application, conexao, VCBarra, vEmbalagem, vVariacao);

      If vProduto > -1 Then
        IncluirNovoItem(vProduto, vEmbalagem, vVariacao)
      Else
        Application.MessageBox(pchar('Produto não localizado!!'), 'Atenção', MB_ICONWARNING + MB_OK);

      cdbarra.Text := '';
      Key := #0;
    End;

    If (Key = 'x') or (Key = 'X') Then
    Begin
      vpQuantidade := StrToFloat(Copy(VCBarra, 1, length(VCBarra)));
      VQuantidade := vpQuantidade;

      cdbarra.Text := '';
      Key := #0;

    End;

  End;

  if (Key = #4) or (Key = #7) or (Key = #9) or (Key = #$15) then
    Key := #0;

end;

procedure TFprinciEnt.cdbarraKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  Tecla: Integer;
  VCdBarra: String;
  VQuantidade: Double;
Begin
  VCdBarra := (FindComponent('Cdbarra') as TEdit).Text;
  (FindComponent('Cdbarra') as TEdit).Text := '';

  Tecla := Key;
  Key := 0;

  // Identifica se tem combinação de tecla com Ctrl;
  If Shift = [ssCtrl] Then
  Begin
    Case Tecla Of
      (* I - CANCELAMENTO DE ITEM *)
      73:
        ActCancelaItem.Execute;

      (* U - LIMPA ATENDIMENTO *)
      85:
        ActLimpaAtendimento.Execute;

      (* D - DESCONTO NO ITEM *)
      68:
        ActDescontoItem.Execute;

      (* G - DESCONTO GERAL *)
      71:
        ActDescontoGeral.Execute;

    Else
      begin
        (FindComponent('Cdbarra') as TEdit).Text := VCdBarra;
        (FindComponent('Cdbarra') as TEdit).SelStart := length((FindComponent('Cdbarra') as TEdit).Text);
        // DEVOLVE POSIÇÃO DO CURSOR PARA O FIM
        Key := Tecla;
      end;
    End;

  End
  Else
  Begin
    if plMensagemPrincipal.Visible then
      Case Tecla Of

        113:
          ActAbreVenda.Execute;
      else
        begin
          Key := Tecla;
          Exit;
        end;
      End;

    Case Tecla Of
      (* SETA PARA CIMA *)
      38:
        if lito.Active then
          Dlito.DataSet.Prior;

      (* SETA PARA BAIXO *)
      40:
        if lito.Active then
          Dlito.DataSet.Next;

      (* F4 - AJUSTA QUANTIDADE *)
      115:
        ActQuantidade.Execute;

      (* F6 -  FINALIZAR VENDA *)
      117:
        ActFinalizaVenda.Execute;

      (* F7 - BUSCA CLIENTES *)
      118:
        ActClientes.Execute;

      (* F8 - PRODUTOS *)
      119:
        ActProdutos.Execute;

      (* F9 - A FATURAR *)
      120:
        if ActAFaturar.Visible then
          ActAFaturar.Execute;

      (* NENHUMA DAS OPÇÕES DEVOLVE VALOR DAS TECLAS *)
    Else
      begin
        (FindComponent('Cdbarra') as TEdit).Text := VCdBarra;
        (FindComponent('Cdbarra') as TEdit).SelStart := length((FindComponent('Cdbarra') as TEdit).Text);
        // DEVOLVE POSIÇÃO DO CURSOR PARA O FIM
        Key := Tecla;
      end;
    End;
  End;

end;

procedure TFprinciEnt.SelecionaSabor(vSbrCodigo: string; vlNomeTit: string; vTipo: Integer = 0);
var
  vlNomePnl: string;
  vlSbrCodigo: string;
  i, X: Integer;
  qsbi: TUniQuery;
  qsbr: TUniQuery;

begin
  try

    vlSbrCodigo := vSbrCodigo;

    qsbr := TUniQuery.Create(Self);
    qsbr.Name := 'qSbr' + vlSbrCodigo;
    qsbr.Connection := conexao;
    qsbr.Close;
    qsbr.SQL.Text := 'select grpcodigo from sbr where sbrcodigo=' + vlSbrCodigo;
    qsbr.Open;

    qsbi := TUniQuery.Create(Self);
    qsbi.Name := 'qSbi' + vlSbrCodigo;
    qsbi.Connection := conexao;
    qsbi.Close;

    qsbi.SQL.Text := 'SELECT sbi.sbichave FROM sbi ';
    qsbi.SQL.Add('INNER JOIN ito ON sbi.itochave = ito.itochave ');
    qsbi.SQL.Add('INNER JOIN sbr ON sbi.sbrcodigo = sbi.sbrcodigo ');
    qsbi.SQL.Add('where ito.orcchave=' + vpOrcChave + ' and ito.itochave=' + itoitochave.AsString + ' and ');
    qsbi.SQL.Add('sbi.sbrcodigo=' + vlSbrCodigo + ' ');
    qsbi.SQL.Add('group by sbi.sbrcodigo, sbi.sbiitem ');
    qsbi.SQL.Add('order by sbi.sbrcodigo, sbi.sbiitem ');

    qsbi.Open;

    if qsbi.IsEmpty then
    begin
      i := 1;
    end
    else
    begin
      if qsbr.FieldByName('grpcodigo').AsString = '' then
        i := 1
      else
        i := qsbi.RecordCount + 1;
    end;

    for X := 1 to i do
    begin

      qsbi.SQL.Text := 'SELECT sbi.sbichave FROM sbi ';
      qsbi.SQL.Add('INNER JOIN ito ON sbi.itochave = ito.itochave ');
      qsbi.SQL.Add('where ito.orcchave=' + vpOrcChave + ' and ito.itochave=' + itoitochave.AsString + ' and ');
      qsbi.SQL.Add('sbi.sbrcodigo=' + vlSbrCodigo + ' and ');
      qsbi.SQL.Add('sbi.sbiitem=' + inttostr(X) + ' ');
      qsbi.SQL.Add('group by sbi.sbrcodigo, sbi.sbiitem ');
      qsbi.SQL.Add('order by sbi.sbrcodigo, sbi.sbiitem ');

      qsbi.Open;

      if qsbi.IsEmpty then
      begin
        sbi.Append;
        sbi.FieldByName('sbiitem').AsInteger := X;
        sbi.FieldByName('sbrcodigo').AsString := vlSbrCodigo;
      end
      else
      begin
        sbi.Edit;
      end;

      sbi.FieldByName('itochave').AsString := itoitochave.AsString;

      sbi.Post;

    end;
  finally
    qsbr.Close;
    qsbi.Close;
    freeandnil(qsbi);
    freeandnil(qsbr);
  end;
end;

procedure TFprinciEnt.MontaTextoPedido;
var
  i: Integer;

  vNome1: string;
  vNome2: string;
  vNome3: string;
  VNome: string;
  vltotal: Double;
  vlTotalBordas: Double;
  vlQtdBordas: Integer;

  vlAdicional: Double;

  vlBordas: Double;
  vlValorUnit: Double;
  vlValorTotalItem: Double;

  vlCobraAdicional: Integer;
  vlEndereco: Integer;

  vlQtSbi: Integer;
  // vlTotalSabor: Currency;
  // vlValorSabor: Currency;

  vlItemTotalBorda: Double;

  vlTotalCombo: Double;
  vlvalorCombo: Double;
  vlitocombo: Integer;

  vlPcocodigo: string;
begin

  vlEndereco := orcedrcodigo.AsInteger;

  Etd.Close;
  Etd.Params[0].AsString := vPetdcodigo;
  Etd.Params[1].AsInteger := vlEndereco;
  Etd.Open;

  recalculaTotal;

  PedidoCabecalho.Lines.Clear;
  pedido.Lines.Clear;
  PedidoRodaPe.Lines.Clear;
  vltotal := 0;
  vlTotalBordas := 0;
  vpTotalAcrescimoav := 0;
  vlValorTotalItem := 0;
  lito.Close;
  lito.ParamByName('orcchave').AsString := vpOrcChave;
  lito.ParamByName('flacodigo').AsInteger := ACESSO.Filial;
  lito.Open;
  lito.First;
  if ((vPetdcodigo <> '') and (vPetdcodigo <> '0')) or (Orcetdcodigo.AsString <> '0') then
  begin
    PedidoCabecalho.Visible := True;

    with PedidoCabecalho do
    begin
      SelAttributes.Size := 16;
      SelAttributes.Style := [fsBold];
      SelAttributes.Color := clred;
      SelStart := GetTextLen;
      SelText := 'Pedido nº: ' + orcorcchave.AsString + ' ' + Format('%-40s', [Copy(etdetdidentificacao.AsString, 1, 40)]) + #13#10;
      SelStart := GetTextLen;
      SelAttributes.Size := 12;
      SelAttributes.Style := [];
      SelAttributes.Color := clBlack;

      if length(etdetftelefone.AsString) = 10 then
      begin
        SelText := 'TELEFONE: ' + FormatMaskText('!\(99\)0000-0000;0;_', etdetftelefone.AsString) + #13#10;
      end
      else if length(etdetftelefone.AsString) = 11 then
        SelText := 'TELEFONE: ' + FormatMaskText('!\(99\)00000-0000;0;_', etdetftelefone.AsString) + #13#10;

      SelAttributes.Size := 12;
      SelAttributes.Style := [];
      SelAttributes.Color := clBlack;

      SelText := 'ENDEREÇO: ' + etdedrrua.AsString + ', ' + etdedrnumero.AsString + #13#10;
      SelAttributes.Size := 12;
      SelAttributes.Style := [];
      SelAttributes.Color := clBlack;

      SelText := '          ' + etdedrbairro.AsString + #13#10;
      SelText := '          ' + etdedrobs.AsString;

    end;
  end
  else
    PedidoCabecalho.Visible := false;

  with PedidoCabecalho do
  begin
    SelText := #13#10;
  end;

  while not lito.Eof do
  begin
    vlBordas := 0;
    vlItemTotalBorda := 0;
    with pedido do
    begin
      SelText := #13#10;

      SelAttributes.Size := 14;
      SelAttributes.Style := [];
      SelAttributes.Color := clBlack;
      SelStart := GetTextLen;

      VNome := litopronome.AsString;

      vlCobraAdicional := 0;

      consulta.Close;
      consulta.SQL.Text := 'select sbrcobraadicional from sbr where procodigo=' + litoprocodigo.AsString;
      consulta.Open;

      if not consulta.IsEmpty then
      begin
        vlCobraAdicional := consulta.Fields[0].AsInteger;
      end
      else
      begin
        consulta.Close;
        consulta.SQL.Text :=
          'select sbrcobraadicional from sbr,grp where sbr.grpcodigo=grp.grpcodigo  and grp.grpcodigo=(select grpcodigo from pro where procodigo=' +
          litoprocodigo.AsString + ' LIMIT 1)';
        consulta.Open;

        if not consulta.IsEmpty then
        begin
          vlCobraAdicional := consulta.Fields[0].AsInteger;
        end;

      end;

      consulta.Close;
      consulta.SQL.Text := 'SELECT itovalorav, itoquantidade FROM ito where itochave=' + Litoitochave.AsString;
      consulta.Open;

      vlValorUnit := consulta.Fields[0].AsCurrency * consulta.Fields[1].AsFloat;

      consulta.Close;
      consulta.SQL.Text := 'SELECT uni.uninome, pun.punprecoav FROM pun, uni, pro ';
      consulta.SQL.Add('WHERE pro.procodigo = pun.procodigo  ');
      consulta.SQL.Add('AND uni.unicodigo = pun.unicodigo AND puncodigo = ' + litopuncodigo.AsString + ' ');
      consulta.SQL.Add('AND pun.unicodigo <> pro.unicodigo');
      consulta.Open;

      if consulta.IsEmpty then
      begin
        consulta.Close;
        consulta.SQL.Text := 'SELECT uni.uninome, pun.punprecoav FROM pun, uni, pro ';
        consulta.SQL.Add('WHERE pro.procodigo = pun.procodigo  ');
        consulta.SQL.Add('AND uni.unicodigo = pun.unicodigo AND puncodigo = ' + litopuncodigo.AsString + ' ');
        consulta.Open;

      end;

      if not consulta.IsEmpty then
        VNome := VNome + ' ' + consulta.Fields[0].AsString;

      vNome1 := Copy(VNome, 1, 35);
      vNome2 := Copy(VNome, 36, 35);
      vNome3 := Copy(VNome, 71, 40);

      SelText := '   ' + vNome1 + #13#10;
      SelStart := GetTextLen;
      if vNome2 <> '' then
      begin
        SelAttributes.Size := 14;
        SelAttributes.Style := [];
        SelAttributes.Color := clBlack;
        SelText := '   ' + vNome2 + #13#10;
        SelStart := GetTextLen;
      end;
      if vNome3 <> '' then
      begin
        SelAttributes.Size := 14;
        SelAttributes.Style := [];
        SelAttributes.Color := clBlack;
        SelText := '   ' + vNome3 + #13#10;
        SelStart := GetTextLen;
      end;

      SelAttributes.Size := 8;
      SelAttributes.Style := [];
      SelAttributes.Color := clBlack;

      sbi.Close;
      sbi.Params[0].AsInteger := Self.Litoitochave.AsInteger;
      sbi.Open;

      if not sbi.IsEmpty then
      begin
        vlAdicional := 0;
        vlQtSbi := sbi.RecordCount;

        while not sbi.Eof do
        begin

          consulta.Close;
          consulta.SQL.Text := 'select sbridentificacao from sbr where sbrcodigo=' + sbisbrcodigo.AsString;
          consulta.Open;

          while not consulta.Eof do
          begin
            if consulta.Fields[0].AsString <> VNome then
            begin
              isi.Close;
              isi.Params[0].AsInteger := sbisbichave.AsInteger;
              isi.Open;
              if sbi.RecordCount > 1 then
              begin
                SelStart := GetTextLen;
                SelAttributes.Size := 10;
                SelAttributes.Style := [fsBold];
                SelAttributes.Color := clBlack;
                SelText := '    ' + consulta.Fields[0].AsString;
              end;
            end;
            if sbisbiobs.AsString = '' then
            begin
              SelText := #13#10;
            end
            else
            begin
              SelAttributes.Style := [];
              SelText := '  (' + sbisbiobs.AsString + ')' + #13#10;
            end;

            while not isi.Eof do
            begin
              if isiisitipo.AsInteger = 1 then
              begin
                if isitsicodigo.AsInteger = 3 then
                begin
                  if isiisiquantidade.AsInteger > 1 then
                  begin
                    SelText := '    Adicionar:  ' + isiisiquantidade.AsString + ' ' + isipronome.AsString + #13#10;
                  end
                  else
                  begin
                    SelText := '      Adicionar:  ' + isipronome.AsString + #13#10;
                  end;
                end
                else
                  SelText := '                  ' + isitsiidentificacao.AsString + ' ' + isipronome.AsString + #13#10;

                if (isitsicodigo.AsInteger <> 1) AND (vlCobraAdicional <> 0) then
                begin
                  vlAdicional := vlAdicional + (isipunprecoav.AsCurrency * isiisiquantidade.AsInteger);

                end;

              end
              else if isiisitipo.AsInteger = 0 then
              begin
                if isitsicodigo.AsInteger <> 3 then
                  SelText := '                  ' + isitsiidentificacao.AsString + ' ' + isipronome.AsString + #13#10;
              end;
              isi.Next;
            end;

            consulta.Next;
          end;

          sbi.Next;
        end;

        pbri.Close;
        pbri.SQL.Text :=
          'SELECT brd.brdidentificacao, bri.itochave,  bri.brdcodigo,  pun.punprecoav,  pro.procodigo,  ito.itochave,  pun.pcoprocodigo, pun.pcoprocodigo ';
        pbri.SQL.Add('FROM bri ');
        pbri.SQL.Add('LEFT JOIN ito  ON bri.itochave = ito.itochave ');
        pbri.SQL.Add('LEFT JOIN brd  ON bri.brdcodigo = brd.brdcodigo ');
        pbri.SQL.Add('LEFT JOIN pro  on brd.procodigo = pro.procodigo ');
        pbri.SQL.Add('LEFT JOIN pun  ON pro.procodigo=pun.procodigo AND pun.unicodigo=ito.unicodigo  ');
        pbri.SQL.Add('where bri.itochave=:itochave and briincluir=1 ');
        pbri.Params[0].AsInteger := Litoitochave.AsInteger;
        pbri.Open;

        if not pbri.IsEmpty then
        begin
          SelAttributes.Size := 10;
          SelAttributes.Style := [fsBold];
          SelAttributes.Color := clBlack;
          SelText := #13#10;

          // SelText := '    Complemento / Base: ' + #13#10;
          SelText := '                 Borda: ' + #13#10;

        end
        else
        begin
          vlTotalBordas := 0;
        end;
        vlQtdBordas := 0;
        pbri.First;
        while not pbri.Eof do
        begin
          vlQtdBordas := vlQtdBordas + 1;
          pbri.Next;
        end;

        pbri.First;
        while not pbri.Eof do
        begin
          SelStart := GetTextLen;
          SelAttributes.Size := 10;
          SelAttributes.Style := [fsBold, fsItalic];
          SelAttributes.Color := clBlack;
          SelText := '          ' + pbri.FieldByName('brdidentificacao').AsString + #13#10;

          vlPcocodigo := '';
          consulta.Close;
          consulta.SQL.Text := 'SELECT pcocodigo FROM ito where pcocodigo<>0 and itochave=' + Litoitochave.AsString;
          consulta.Open;

          vlPcocodigo := consulta.FieldByName('pcocodigo').AsString;

          if vlPcocodigo <> '' then
          begin

            consulta.Close;
            consulta.SQL.Text := 'select punprecoav,pcoprocodigo  from pun where pcoprocodigo=' + vlPcocodigo + ' and procodigo=' +
              pbri.FieldByName('procodigo').AsString;
            consulta.Open;

            if not consulta.IsEmpty then
            begin
              if consulta.FieldByName('pcoprocodigo').AsInteger <> 0 then
              begin
                if consulta.FieldByName('pcoprocodigo').AsString = vlPcocodigo then
                begin

                  vlBordas := vlBordas + ((consulta.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * litoitoquantidade.AsFloat);
                end;
              end;

            end;

            { else
              begin
              vlBordas := vlBordas + ((pbri.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * litoitoquantidade.AsFloat);
              end; }
          end
          else
          begin

            { if consulta.FieldByName('pcoprocodigo').AsInteger <> 0 then
              begin
              if consulta.FieldByName('pcoprocodigo').AsString = vlPcocodigo then
              begin
              vlBordas := vlBordas + ((pbri.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * litoitoquantidade.AsFloat);
              end;
              end
              else
              begin }
            vlBordas := vlBordas + ((pbri.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * litoitoquantidade.AsFloat);
            { end; }
          end;
          pbri.Next;
        end;
        vlTotalBordas := vlTotalBordas + vlBordas;

        consulta.Close;
        consulta.SQL.Text := 'SELECT itovalorav,itoquantidade FROM ito where itochave=' + Litoitochave.AsString;
        consulta.Open;

        vlValorUnit := consulta.Fields[0].AsCurrency * consulta.Fields[1].AsFloat;



        // vlValorUnit :=  litoitovalor.AsCurrency; // vlTotalSabor;

      end
      else
      begin

        pbri.Close;
        pbri.SQL.Text :=
          'SELECT brd.brdidentificacao, bri.itochave,  bri.brdcodigo,  pun.punprecoav,  pro.procodigo,  ito.itochave,  pun.pcoprocodigo ';
        pbri.SQL.Add('FROM bri ');
        pbri.SQL.Add('LEFT JOIN ito  ON bri.itochave = ito.itochave ');
        pbri.SQL.Add('LEFT JOIN brd  ON bri.brdcodigo = brd.brdcodigo ');
        pbri.SQL.Add('LEFT JOIN pro  on brd.procodigo = pro.procodigo ');
        pbri.SQL.Add('LEFT JOIN pun  ON pro.procodigo=pun.procodigo AND pun.unicodigo=ito.unicodigo  ');
        pbri.SQL.Add('where bri.itochave=:itochave and briincluir=1 ');
        pbri.Params[0].AsInteger := Litoitochave.AsInteger;
        pbri.Open;

        if not pbri.IsEmpty then
        begin
          SelAttributes.Size := 10;
          SelAttributes.Style := [fsBold];
          SelAttributes.Color := clBlack;
          SelText := #13#10;

          // SelText := '    Complemento / Base: ' + #13#10;
          SelText := '                 Borda: ' + #13#10;

        end
        else
        begin
          vlTotalBordas := 0;
          vlTotalBordas := 0;
          vlBordas := 0;

        end;
        vlQtdBordas := 0;
        pbri.First;
        while not pbri.Eof do
        begin
          vlQtdBordas := vlQtdBordas + 1;
          pbri.Next;
        end;

        pbri.First;
        while not pbri.Eof do
        begin
          SelStart := GetTextLen;
          SelAttributes.Size := 10;
          SelAttributes.Style := [fsBold, fsItalic];
          SelAttributes.Color := clBlack;
          SelText := '          ' + pbri.FieldByName('brdidentificacao').AsString + #13#10;

          consulta.Close;
          consulta.SQL.Text := 'select punprecoav from pun where procodigo=' + pbri.FieldByName('procodigo').AsString;
          consulta.Open;

          if not consulta.IsEmpty then
          begin
            vlBordas := vlBordas + ((consulta.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * litoitoquantidade.AsFloat);
          end
          else
          begin
            vlBordas := vlBordas + ((pbri.FieldByName('punprecoav').AsCurrency / vlQtdBordas) * litoitoquantidade.AsFloat);
          end;
          pbri.Next;

        end;
        vlTotalBordas := vlTotalBordas + vlBordas;

      end;

      SelAttributes.Size := 14;
      SelAttributes.Style := [fsBold];
      SelAttributes.Color := clBlack;

      SelStart := GetTextLen;

      if litoitodesconto.AsCurrency > 0 then
      begin
        SelText := '      ' + formatfloat('#0.000', litoitoquantidade.AsFloat) + ' X ' +
          Format('%8s', [formatfloat('##,##0.00', (vlValorUnit / litoitoquantidade.AsFloat) + vlAdicional + ((vlBordas / litoitoquantidade.AsFloat)
          { * litoitopercentualcombo.AsFloat } ))]) + Format('%8s', [formatfloat('-#,##0.00', litoitodesconto.AsCurrency)]) + '   = R$ ' +
          Format('%8s', [formatfloat('##,##0.00', ((vlValorUnit + vlAdicional)) + (vlBordas { * litoitopercentualcombo.AsFloat } ) -
          litoitodesconto.AsCurrency)]) + #13#10;
      end
      else
      begin
        SelText := '      ' + formatfloat('#0.000', litoitoquantidade.AsFloat) + ' X ' +
          Format('%8s', [formatfloat('##,##0.00', (vlValorUnit / litoitoquantidade.AsFloat) + vlAdicional + ((vlBordas / litoitoquantidade.AsFloat)
          { * litoitopercentualcombo.AsFloat } ))]) + Format('%8s', ['        ']) + '   = R$ ' +
          Format('%8s', [formatfloat('##,##0.00', (((vlValorUnit / litoitoquantidade.AsFloat) + vlAdicional) * litoitoquantidade.AsFloat) +
          (vlBordas { * litoitopercentualcombo.AsFloat } ) - litoitodesconto.AsCurrency)]) + #13#10;

      end;

      SelText := '_________________________________________________________________________________' + #13#10;
      vlValorTotalItem := { vlBordas + } ((vlValorUnit) { * litoitoquantidade.AsFloat } ) - litoitodesconto.AsCurrency;
      vltotal := vltotal + (vlBordas { * litoitopercentualcombo.AsFloat } ) +
        (((vlValorUnit / litoitoquantidade.AsFloat) + vlAdicional) * litoitoquantidade.AsFloat) - litoitodesconto.AsCurrency;

    end;

    if vlCobraAdicional=1 then
      vpTotalAcrescimoav := vpTotalAcrescimoav + vlAdicional + (vlBordas { * litoitopercentualcombo.AsFloat } );
    vlAdicional := 0;

    lito.Next;
  end;

  with PedidoRodaPe do
  begin
    SelAttributes.Size := 16;
    SelAttributes.Style := [fsBold];
    SelAttributes.Color := clBlack;
    SelStart := GetTextLen;
    SelText := '                    =====================' + #13#10;

    SelAttributes.Size := 16;
    SelAttributes.Style := [fsBold];
    SelAttributes.Color := clBlack;
    SelStart := GetTextLen;
    SelText := '                     Total R$ ' + Format('%12s', [formatfloat('###,##0.00', vltotal)]) + #13#10;
    SelStart := GetTextLen;
    SelAttributes.Size := 12;
    SelAttributes.Style := [];
    SelAttributes.Color := clBlack;

  end;

  vplValorLiquidoOp := vltotal;
  // recalculaTotal;

end;

function TFprinciEnt.GetBotoesAtivosImpre: String;
Var
  vlImpAtivos: string;
Begin
  vlImpAtivos := '     ';

  if IDAV.Visible then
    if vpImprimiuDAV then
      Insert('O', vlImpAtivos, 1);

  Insert(' ', vlImpAtivos, 2);

  if Infce.Visible then
    if vpImprimiuNFCe then
      Insert('F', vlImpAtivos, 3);

  if Infe.Visible then
    if vpImprimiuNFE then
      Insert('E', vlImpAtivos, 4);

  if orcfopcodigo.AsInteger = 2 then
    Insert('B', vlImpAtivos, 5);

  result := vlImpAtivos;
end;

procedure TFprinciEnt.MostraComplementoProduto(vItoChave: Integer);
begin
  try
    if Ito.Locate('itochave', vItoChave, []) then
    begin
      Application.CreateForm(Tfivlinhacomplpro, fivlinhacomplpro);
      fivlinhacomplpro.Dregistro.DataSet := Ito;
      fivlinhacomplpro.ShowModal;
      lito.Refresh;
    end;
  finally
    freeandnil(fivlinhacomplpro);
  end;
end;

procedure TFprinciEnt.AtualizaListasdePedidos;
begin
  PanelJaSairam.Visible := True;
  Splitter1.Visible := True;
  PanelTopoSituacaoEntregas.Caption := 'Pedidos aguardando para serem entregues';

  listaasair.Close;
  listaasair.Open;
  LabelQtdPedidosaSair.Caption := 'Qtd: ' + formatfloat('000', listaasair.RecordCount);

  listajasaiu.Close;
  listajasaiu.Open;
  LabelQtdPedidosJaSaiu.Caption := 'Qtd: ' + formatfloat('000', listajasaiu.RecordCount);
  Application.ProcessMessages;

end;

end.
