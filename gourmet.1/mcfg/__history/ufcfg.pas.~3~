unit ufcfg;

interface


uses
  Winapi.Windows, Vcl.Forms, ufrmbase, Vcl.StdCtrls, Vcl.ExtCtrls, Vcl.DBCtrls,
  Vcl.Mask, Vcl.ImgList, Vcl.Controls, PngImageList, System.Classes,
  System.Actions, Vcl.ActnList, Data.DB, MemDS, DBAccess, Uni, Vcl.Buttons,
  Vcl.ComCtrls, System.SysUtils, uFuncoes, uPegaBase, System.ImageList;

type
  Tfcfg = class(Tfrmbase)
    Label1: TLabel;
    cfgcodigo: TDBEdit;
    registrocfgcodigo: TIntegerField;
    registrocfgidentificacao: TStringField;
    registrocfgusasped: TIntegerField;
    sen: TUniQuery;
    sensencodigo: TIntegerField;
    sensenidentificacao: TStringField;
    Label3: TLabel;
    cfgusasped: TDBEdit;
    bconfigsped: TButton;
    registrocfgusavnd: TIntegerField;
    registrocfgusacpr: TIntegerField;
    registrocfgusactb: TIntegerField;
    registrocfgusacpa: TIntegerField;
    registrocfgusacre: TIntegerField;
    registrocfgusabol: TIntegerField;
    registrocfgusanfe: TIntegerField;
    registrocfgusapdv: TIntegerField;
    registrocfgusanfc: TIntegerField;
    registrocfgusarh: TIntegerField;
    Label4: TLabel;
    cfgusacpr: TDBEdit;
    Label6: TLabel;
    cfgusacpa: TDBEdit;
    Label7: TLabel;
    cfgusavnd: TDBEdit;
    Label8: TLabel;
    cfgusacre: TDBEdit;
    Label11: TLabel;
    cfgusasrv: TDBEdit;
    Label12: TLabel;
    cfgusabol: TDBEdit;
    Label14: TLabel;
    cfgusanfe: TDBEdit;
    Label16: TLabel;
    cfgusapdv: TDBEdit;
    Label18: TLabel;
    cfgusanfc: TDBEdit;
    Label20: TLabel;
    cfgusactb: TDBEdit;
    registrosenusasped: TStringField;
    bconfigcfg: TButton;
    registrosenusacpr: TStringField;
    registrosenusavnd: TStringField;
    registrosenusactb: TStringField;
    registrosenusacpa: TStringField;
    registrosenusabol: TStringField;
    registrosenusanfe: TStringField;
    registrosenusapdv: TStringField;
    registrosenusanfc: TStringField;
    Label30: TLabel;
    cfgusarh: TDBEdit;
    registrosenusarh: TStringField;
    registrosenusacre: TStringField;
    bconfignfe: TButton;
    bconfigentradas: TButton;
    bcondifsaidas: TButton;
    registrocfgctacaixa: TIntegerField;
    Label33: TLabel;
    cfgctacaixa: TDBEdit;
    bconfigContasAReceber: TButton;
    registrocfgusaadc: TIntegerField;
    Label34: TLabel;
    bconfigadc: TButton;
    TSAjustes: TTabSheet;
    GBEntidades: TGroupBox;
    bAjustaCPFCNPJ: TBitBtn;
    bconfignfc: TButton;
    adc: TUniQuery;
    Label35: TLabel;
    cfgusaadc: TDBRadioGroup;
    bAjustaTelefones: TButton;
    Label36: TLabel;
    Label37: TLabel;
    cfgusache: TDBRadioGroup;
    registrocfgusache: TIntegerField;
    bconfigctb: TButton;
    bConfigBoletos: TButton;
    bconfigfolha: TButton;
    Label38: TLabel;
    cfgusatelentre: TDBEdit;
    registrocfgusatelentre: TIntegerField;
    registrosenteleentrega: TStringField;
    registrocfgusagou: TIntegerField;
    registrosenusagou: TStringField;
    Bevel1: TBevel;
    Bevel2: TBevel;
    Bevel3: TBevel;
    Label39: TLabel;
    cfgusagou: TDBEdit;
    bconfiggoumet: TButton;
    registroflacodigo: TIntegerField;
    fla: TUniQuery;
    flaflacodigo: TIntegerField;
    flaflaidentificacao: TStringField;
    flaetdcodigo: TIntegerField;
    flaetdidentificacao: TStringField;
    registroflaidentificacao: TStringField;
    registroetdidentificacao: TStringField;
    Label5: TLabel;
    flacodigo: TDBEdit;
    Label9: TLabel;
    registrocfgusasrv: TIntegerField;
    registrosenusasrv: TStringField;
    etdidentificacao: TDBEdit;
    Label2: TLabel;
    cfgidentificacao: TDBEdit;
    sen9: TUniQuery;
    registrocfgeminclusao: TIntegerField;
    registrosencfgeminclusao: TStringField;
    Label10: TLabel;
    cfgeminclusao: TDBEdit;
    registrocfgtodasentidades: TIntegerField;
    registrosencfgtodasentidades: TStringField;
    Label13: TLabel;
    cfgtodasentidades: TDBEdit;
    Label15: TLabel;
    cfgctacodigopix: TDBEdit;
    registrocfgctacodigopix: TIntegerField;
    registrocfgetdcodigopix: TIntegerField;
    Label17: TLabel;
    cfgetdcodigopix: TDBEdit;
    registrocfgusaeconf: TIntegerField;
    Label19: TLabel;
    cfgusaeconf: TDBEdit;
    procedure bconfigspedClick(Sender: TObject);
    procedure bconfigcfgClick(Sender: TObject);
    procedure bconfignfeClick(Sender: TObject);
    procedure bconfigentradasClick(Sender: TObject);
    procedure bcondifsaidasClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure bconfigContasAReceberClick(Sender: TObject);
    procedure bconfigadcClick(Sender: TObject);
    procedure bAjustaCPFCNPJClick(Sender: TObject);
    procedure bconfirmaClick(Sender: TObject);
    procedure bAjustaTelefonesClick(Sender: TObject);
    procedure bconfigctbClick(Sender: TObject);
    procedure bConfigBoletosClick(Sender: TObject);
    procedure bconfigfolhaClick(Sender: TObject);
    procedure bconfiggoumetClick(Sender: TObject);
  private
    FFilial: Integer;
    procedure SetFilial(const Value: Integer);
    procedure ClonaConfigMatriz(pTabela: String);
    { Private declarations }
  published
    property Filial: Integer read FFilial write SetFilial;
  public
    { Public declarations }
  end;

var
  fcfg: Tfcfg;

  // Início ID do Módulo fracfg
const
  vPlIdMd = '03.06.81.002-01';
  vPlTitMdl = 'Configurações';

  // Fim ID do Módulo fracfg

implementation

uses  ufAjustaCpfCnpj,  ufAjustaTelefone;
{$R *.dfm}

function formulario(pCargaFrame: TCargaFrame): string;
begin
  fcfg := Tfcfg.Create(pCargaFrame);
  fcfg.ShowModal;
  fcfg.Free;
end;

exports formulario;

procedure Tfcfg.bAjustaCPFCNPJClick(Sender: TObject);
begin
  inherited;
  fAjustaCpfCnpj := TfAjustaCpfCnpj.Create(Application);
  try
    fAjustaCpfCnpj.etd.Connection := zcone;
    fAjustaCpfCnpj.Consulta.Connection := zcone;
    fAjustaCpfCnpj.ShowModal;
  finally
    fAjustaCpfCnpj.Free;
  end;
end;

procedure Tfcfg.bAjustaTelefonesClick(Sender: TObject);
begin
  inherited;
  fAjustaTelefone := TfAjustaTelefone.Create(Application);
  try
    fAjustaTelefone.etf.Connection := zcone;
    fAjustaTelefone.Consulta.Connection := zcone;
    fAjustaTelefone.ShowModal;
  finally
    fAjustaTelefone.Free;
  end;

end;

procedure Tfcfg.bcondifsaidasClick(Sender: TObject);
begin
  ClonaConfigMatriz('cfgmsai');
  MostraFormu('mcfgmsai', '', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bconfigadcClick(Sender: TObject);
begin
  MostraLista('madc', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bConfigBoletosClick(Sender: TObject);
begin
  ClonaConfigMatriz('cfgmbol');
  MostraFormu('mcfgmbol', '', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bconfigcfgClick(Sender: TObject);
begin
  ClonaConfigMatriz('cfgmcfg');
  MostraFormu('mcfgmcfg', '', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bconfigContasAReceberClick(Sender: TObject);
begin
  ClonaConfigMatriz('cfgmcre');
  MostraFormu('mcfgmcre', '', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bconfigctbClick(Sender: TObject);
begin
  ClonaConfigMatriz('cfgmctb');
  MostraFormu('mcfgmctb', '', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bconfigentradasClick(Sender: TObject);
begin
  ClonaConfigMatriz('cfgment');
  MostraFormu('mcfgment', '', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bconfigfolhaClick(Sender: TObject);
begin
  ClonaConfigMatriz('cfgmflh');
  MostraFormu('mcfgmflh', '', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bconfiggoumetClick(Sender: TObject);
begin
  ClonaConfigMatriz('cfgmgou');
  MostraFormu('mcfgmgou', '', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bconfignfeClick(Sender: TObject);
begin
  ClonaConfigMatriz('cfgmnfe');
  MostraFormu('mcfgmnfe', '', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bconfigspedClick(Sender: TObject);
begin
  ClonaConfigMatriz('cfgmspd');
  ClonaConfigMatriz('ctd');
  MostraFormu('mcfgmspd', '', Self.cfgcodigo.Field.AsString);
end;

procedure Tfcfg.bconfirmaClick(Sender: TObject);
begin
  { se definiu que vai usar cartoes, deve ter ao menos uma operadora para o registro }
  if (cfgusaadc.Field.AsInteger = 1) or (cfgusaadc.Field.AsInteger = 2) then
  begin
    adc.Close;
    adc.Open;
    if adc.IsEmpty then
      bconfigadc.Click;
  end;

  inherited;

end;

procedure Tfcfg.FormShow(Sender: TObject);
begin
  Self.Height := 580;
  Self.Width := 900;

  IdModulo := vPlIdMd;

  Filial := StrToInt(vChaveMestre);
  ClonaConfigMatriz('cfg');

  inherited;

  if Self.Height < 580 then
    Self.Height := 580;

  if Self.Width < 900 then
    Self.Width := 900;

  flacodigo.Color := PEG_COR_VALORPADRAO;
  etdidentificacao.Color := PEG_COR_VALORPADRAO;

  (* Clona configurações de Clientes, pois este não está visível *)
  ClonaConfigMatriz('cfgmcli');
end;

procedure Tfcfg.SetFilial(const Value: Integer);
begin
  FFilial := Value;
  fla.Params[0].AsInteger := Filial;
  fla.Connection := zcone;
  fla.Open;

  registro.Params[0].AsInteger := Filial;
end;

procedure Tfcfg.ClonaConfigMatriz(pTabela: String);
var
  uqMatriz: TUniQuery;
  uqFilial: TUniQuery;
  I: Integer;
begin
  uqMatriz := TUniQuery.Create(Application);

  try
    uqMatriz.Connection := zcone;

    uqMatriz.SQL.Add('SELECT * FROM ' + pTabela + ' c');
    uqMatriz.SQL.Add(' WHERE c.cfgcodigo = (SELECT cfg.cfgcodigo FROM cfg ');
    uqMatriz.SQL.Add('                       INNER JOIN fla ON cfg.flacodigo = fla.flacodigo');
    uqMatriz.SQL.Add('                       ORDER BY fla.flacodigo LIMIT 1);');

    uqMatriz.Open;

    (* Se Matriz não possui configuração válida a rotina é abandonada *)
    if uqMatriz.IsEmpty then
      Exit;

    (* Inicia verificação da configuração da Filial *)
    uqFilial := TUniQuery.Create(Application);

    try
      uqFilial.Connection := zcone;

      uqFilial.SQL.Add('SELECT * FROM ' + pTabela + ' c');

      if pTabela = 'cfg' then
        uqFilial.SQL.Add(' WHERE c.flacodigo = ' + IntToStr(Filial))
      else
        uqFilial.SQL.Add(' WHERE c.cfgcodigo = ' + cfgcodigo.Field.AsString);

      uqFilial.Open;

      (* Se Filial possui configuração válida a rotina é abandonada *)
      if not uqFilial.IsEmpty then
        Exit;

      (* Configuração da Matriz é clonada para a Filial *)
      uqFilial.Append;

      for I := 1 to uqMatriz.FieldCount - 1 do
        uqFilial.Fields[I].AsString := uqMatriz.Fields[I].AsString;

      if pTabela = 'cfg' then
      begin
        uqFilial.FieldByName('flacodigo').AsInteger := Filial;
        uqFilial.FieldByName('cfgidentificacao').AsString := flaetdidentificacao.AsString;
      end
      else
      begin
        uqFilial.FieldByName('cfgcodigo').AsInteger := cfgcodigo.Field.AsInteger;

        if pTabela = 'cfgmcfg' then
          uqFilial.FieldByName('cfgetdempresa').AsInteger := flaetdcodigo.AsInteger;
      end;

      uqFilial.Post;
    finally
      uqFilial.Free;
    end;

  finally
    uqMatriz.Free;
  end;
end;

end.
