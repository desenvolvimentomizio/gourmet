unit ufnfce;

interface

uses
  Winapi.Windows, pcnConversao, System.SysUtils, Vcl.Forms, ACBrNFeDANFEFRDM,
  ACBrNFeDANFEClass, ACBrNFeDANFEFR, ACBrValidador, Uni,
  ACBrBase, ACBrDFe, ACBrNFe, Vcl.ComCtrls, System.Classes, Vcl.Controls,
  Vcl.ExtCtrls, Vcl.Dialogs, System.StrUtils, System.Math, uFuncoes,
  pcnConversaoNFe, uPegaBase, MemDS, DBAccess, Data.DB, DateUtils, Vcl.StdCtrls,
  ACBrMail, IdComponent, IdMessage, IdIOHandler, IdIOHandlerSocket,
  IdIOHandlerStack, IdSSL, IdSSLOpenSSL, IdBaseComponent, IdTCPConnection,
  IdTCPClient, IdExplicitTLSClientServerBase, IdMessageClient, IdSMTPBase,
  IdSMTP, IdAttachment, IdAttachmentFile, ACBrDFeReport, ACBrDFeDANFeReport,
  ACBrDANFCeFortesFr, ACBrDFeUtil, midaslib, ACBrDFeSSL, pcnAuxiliar, blcksock, IdEMailAddress;

type
  Tfnfce = class(TForm)
    ACBrNFeNFCe: TACBrNFe;
    ACBrValidador: TACBrValidador;

    consulta: TUniQuery;
    rec: TUniQuery;
    mes: TUniQuery;
    itm: TUniQuery;
    etd: TUniQuery;
    toe: TUniQuery;
    enf: TUniQuery;
    mev: TUniQuery;
    cfg: TUniQuery;
    trm: TUniQuery;
    mic: TUniQuery;
    oic: TUniQuery;
    qDtl: TUniQuery;
    rni: TUniQuery;
    NumeroNFCe: TUniQuery;
    disponivel: TUniQuery;
    limite: TUniQuery;
    yoe: TUniQuery;
    itmncm: TUniQuery;

    recreccodigo: TIntegerField;
    recrecmotivo: TStringField;
    recrecdthoraentrada: TDateTimeField;
    recrecdthorasaida: TDateTimeField;

    mesmeschave: TIntegerField;
    mestoecodigo: TIntegerField;
    mesetdcodigo: TIntegerField;
    mesmestotal: TFloatField;
    mesrefcodigo: TIntegerField;
    mestfpcodigo: TIntegerField;
    mestdfcodigo: TStringField;
    mesmesnumero: TIntegerField;
    mesmesserie: TStringField;
    mesedritem: TIntegerField;
    mesmesdatanfe: TDateField;
    mesmescoocupom: TIntegerField;
    mesmesdatacupom: TDateField;
    mesmesprotocolo: TStringField;
    mesmeschavenfe: TStringField;
    mesmesregistro: TDateField;
    mestemcodigo: TIntegerField;

    itmcfocfop: TStringField;
    itmprocodigo: TIntegerField;
    itmpronome: TStringField;
    itmpronomereduzido: TStringField;
    itmproncm: TStringField;
    itmitmdesccomple: TStringField;
    itmitmquantidade: TFloatField;
    itmunisimbolo: TStringField;
    itmitmvalor: TFloatField;
    itmitmdesconto: TFloatField;
    itmitmchave: TIntegerField;
    itmcstcodigo: TStringField;
    itmicmcodigo: TStringField;
    itmitmicm: TFloatField;
    itmitmbicm: TFloatField;
    itmitmaliqipi: TFloatField;
    itmitmbipi: TFloatField;
    itmitmipi: TFloatField;
    itmitmvlribpt: TFloatField;
    itmpunqtdtribtotal: TFloatField;
    itmunisimbolotrib: TStringField;
    itmproanpcodigo: TIntegerField;
    itmitmtotal: TFloatField;
    itmitmcargatrib: TFloatField;

    etdetddoc1: TStringField;
    etdedrcep: TStringField;
    etdedrrua: TStringField;
    etdedrnumero: TStringField;
    etdedrbairro: TStringField;
    etdcddcodigo: TStringField;
    etdcddnome: TStringField;
    etdufssigla: TStringField;
    etdetftelefone: TStringField;
    etdtpecodigo: TIntegerField;
    etdetdidentificacao: TStringField;
    etdedrinscest: TStringField;

    toettecodigo: TIntegerField;
    toetoeidentificacao: TStringField;
    toetoecodigo: TIntegerField;

    enfenfchave: TIntegerField;
    enftencodigo: TIntegerField;
    enfenfregistroevento: TDateField;
    enfenfchaveevento: TStringField;
    enfenfseqevento: TIntegerField;
    enfenfdescricao: TStringField;
    enfenfxml: TBlobField;
    enfenfcstat: TIntegerField;
    enfenfxmotivo: TStringField;

    mevmevchave: TIntegerField;
    mevenfchave: TIntegerField;
    mevmeschave: TIntegerField;

    cfgcfgcodigo: TIntegerField;
    cfgcfgservarqnfes: TStringField;
    cfgcfgnumecertif: TStringField;
    cfgcfgetdempresa: TIntegerField;
    cfgcfgviasnfe: TIntegerField;
    cfgcfgserienfe: TStringField;
    cfgcfgserienfce: TStringField;
    cfgcfgdescrinfe: TIntegerField;
    cfgcfgemailnfe: TStringField;
    cfgcfgemailservidornfe: TStringField;
    cfgcfgemailsenhanfe: TStringField;
    cfgcfgmailportnfe: TStringField;
    cfgcfgemailusatls: TIntegerField;
    cfgcrtcodigo: TIntegerField;
    cfgetdapelido: TStringField;
    cfgetdidentificacao: TStringField;
    cfgetddoc1: TStringField;
    cfgufscodigo: TStringField;
    cfgcddcodigo: TStringField;
    cfgedrinscest: TStringField;
    cfgedrrua: TStringField;
    cfgedrnumero: TStringField;
    cfgedrbairro: TStringField;
    cfgedrcep: TStringField;
    cfgcddnome: TStringField;
    cfgufssigla: TStringField;
    cfgetftelefone: TStringField;
    cfgcfgusanfc: TIntegerField;
    cfgcfgtoken1nfce: TStringField;
    cfgcfgnumecertifa1: TStringField;
    cfgcfgmodonfe: TIntegerField;
    cfgcfgidtokennfce: TStringField;
    cfgcfgviaassinar: TIntegerField;
    cfgcfgsenhacertificadoa1: TStringField;

    trmtciporta: TStringField;
    trmecfcodigo: TIntegerField;
    trmtrmcodigo: TIntegerField;
    trmtipcodigo: TIntegerField;

    micmicchave: TIntegerField;
    micmeschave: TIntegerField;
    micidccodigo: TIntegerField;
    micidcnome: TStringField;
    micidcdoc: TStringField;

    oicoicchave: TIntegerField;
    oicorcchave: TIntegerField;
    oicidccodigo: TIntegerField;
    oicidcnome: TStringField;
    oicidcdoc: TStringField;

    PlTitulo: TPanel;
    plStatusSefaz: TPanel;
    Panel1: TPanel;

    rnirnichave: TIntegerField;
    rnirniano: TStringField;
    rnirnimes: TStringField;
    rnitdfcodigo: TStringField;
    rnirninumeroinicial: TIntegerField;
    rnirninumerofinal: TIntegerField;
    rnirnijutificativa: TStringField;

    mesclbidentificacao: TStringField;
    itmitmcargatribest: TFloatField;
    mesmesprodutos: TFloatField;
    cfgcfgmensagempdv: TStringField;
    plestagio: TPanel;
    mesmesobs: TStringField;
    info: TMemo;
    etdetdnfemodelos: TStringField;
    itmcspcodigo: TStringField;
    itmcsfcodigo: TStringField;

    disponivelrfisaldocapital: TFloatField;

    limiteetdcodigo: TIntegerField;
    limiteetllimitetotal: TFloatField;
    yoeansanexo: TStringField;
    cfgcfgtoesubstforaestado: TIntegerField;
    cfgcfgtoesubstnoestado: TIntegerField;

    itmncmtoecodigo: TIntegerField;
    cfgcfgprevisualizarimpressao: TIntegerField;
    cfgcfgversao: TStringField;
    ACBrValidadorBarra: TACBrValidador;
    itmpunbarra: TStringField;
    itmpunbarrasistema: TIntegerField;
    SMTP: TIdSMTP;
    IO_OpenSSL: TIdSSLIOHandlerSocketOpenSSL;
    IdMessage1: TIdMessage;
    mesmesemissao: TDateField;
    toeitm: TUniQuery;
    toeitmtoecodigo: TIntegerField;
    toeitmcstcodigo: TStringField;
    toeitmcsicodigo: TStringField;
    toeitmcspcodigo: TStringField;
    toeitmcfgpercentualpis: TFloatField;
    toeitmcsfcodigo: TStringField;
    toeitmcfgpercentualcofins: TFloatField;
    itmcsicodigo: TStringField;
    itmtoecodigo: TIntegerField;
    cfgcfgusacstnoproduto: TIntegerField;
    itmcst: TUniQuery;
    itmcstitmchave: TIntegerField;
    itmcstcstcodigo: TStringField;
    itmcstcsicodigo: TStringField;
    itmcstcspcodigo: TStringField;
    itmcstcsfcodigo: TStringField;
    itmcstitmaliqpis: TFloatField;
    itmcstitmaliqcofins: TFloatField;
    itmcstitmaliqipi: TFloatField;
    ncm: TUniQuery;
    toettocodigo: TIntegerField;
    mostra: TProgressBar;
    cfgcfgtoesubstanpnoestado: TIntegerField;
    cfgcfgtoesubstanpforaestado: TIntegerField;
    ACBrNFeDANFCEFR1: TACBrNFeDANFCEFR;
    cfgcfgtoemesinte: TIntegerField;
    mesmeshoranfe: TTimeField;
    cfgcfgdefinetoeatendimento: TIntegerField;
    cfgcfgcestativo: TIntegerField;
    itmtcecest: TStringField;
    itmtpocodigo: TIntegerField;
    qTomTof: TUniQuery;
    tom: TUniQuery;
    tomtomchave: TIntegerField;
    tomtofcodigo: TIntegerField;
    tommeschave: TIntegerField;
    tomtomobs: TStringField;
    cfgcfgobs1: TIntegerField;
    cfgcfgproducaopropria: TIntegerField;
    itmproproducao: TIntegerField;
    cfgcfgtoeinteproducaopropria: TIntegerField;
    cfgcfgtoeforaproducaopropria: TIntegerField;
    itmitmpercreducaobaseicm: TFloatField;
    itmitmaliqpis: TFloatField;
    itmitmpis: TFloatField;
    itmitmbpis: TFloatField;
    itmitmaliqcofins: TFloatField;
    itmitmcofins: TFloatField;
    itmitmbcofins: TFloatField;
    itmitmfrete: TFloatField;
    itmitmoutras: TFloatField;
    pad: TUniQuery;
    padpadcodigo: TIntegerField;
    padpadncm: TStringField;
    padpadpis: TFloatField;
    padpadcofins: TFloatField;
    padpadextipi: TStringField;
    padpadcodigopiscofins: TStringField;
    cfgcfgtoeintesubsprodpropria: TIntegerField;
    cfgcfgtoeforasubsprodpropria: TIntegerField;
    itmpunidentificacao: TStringField;
    qconsulta: TUniQuery;
    mesmescodigonota: TIntegerField;
    mesmesrefeicao: TIntegerField;
    mesmesoutras: TCurrencyField;
    itmicmaliquota: TStringField;
    cfgcfgtributacaoimendes: TIntegerField;
    itmitmbicms: TFloatField;
    itmitmmva: TFloatField;
    itmitmicms: TFloatField;
    itmitmaliqicms: TStringField;
    mesmespis: TCurrencyField;
    mesmescofins: TCurrencyField;
    itmpuncodigo: TIntegerField;
    ctd: TUniQuery;
    ctdctdcnpj: TStringField;
    cfgcfgcertificadoa1: TBlobField;
    cfgeteemail: TStringField;
    rnimeschave: TIntegerField;
    rnimeschavenfe: TStringField;
    cfgctdboxedominio: TStringField;
    mesmesfrete: TFloatField;
    cfgcfgusapdv: TIntegerField;
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormShow(Sender: TObject);
    procedure IO_OpenSSLStatusInfo(const AMsg: string);
  private
    Fzcone: TUniConnection;
    // ACBrNFeDANFEFR : TACBrNFeDANFEFR;

    function AjustaSituacaoNFCe(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    procedure CancelaNFCe(vMesChave: string; vFlaCodigo: string = '1');
    function ConsultaServicoSEFAZNFCE: string;
    function EmiteNFCe(vMesChave: string; vImprimir: Boolean; vFlaCodigo: string = '1'): Boolean;
    function GeraNFCe(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function ReGeraNFCe(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function ImprimeNFCe(vMesChave: string; vFlaCodigo: string = '1'; vVisualizar: Boolean = False): Boolean;
    function EmailNFCe(vMesChave: string; vFlaCodigo: string = '1'; vVisualizar: Boolean = False; vemails: string = ''): Boolean;
    function VerificaExistencia(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function GeraNomeArqNFCe(vMesChave: string; vFlaCodigo: string = '1'): string;
    procedure AjustaCaminhoGeralNF(Data: TDate);
    procedure InicializaTabelas;
    function ValidaProdutos(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function ValidaConsumidor(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function AssinaNota(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function SalvaEmCoontigencia(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function SalvaNormal(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;

    function ValidaNota(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
    function Geraxml(vChaveNFE: string; vFlaCodigo: string = '1'): Boolean;
    function ReGeraxml(vChaveNFE: string; vFlaCodigo: string = '1'): Boolean;

    procedure entraemcontigencia(vStatSEFAZ: string);
    function GeraNomeArqNFCeTipo(vMesChave: string; vTipoEmissao: Integer; vFlaCodigo: string = '1'): string;
    function ConsultaNFCe(vMesChave, vArqNFCe: String; vFlaCodigo: string = '1'): Boolean;
    function InutilizarNumerosNFCe(vFlaCodigo: string = '1'): Boolean;
    procedure Setzcone(const Value: TUniConnection);
    procedure SalvarLogErro(eMessage, eStackTrace: String);
    function InutilizarNumerosNFCeDireto(vFlaCodigo: string = '1'): Boolean;
    procedure VerifieAjustaItemcomSubstituicao(usEmitente, ufDestinatario: string);

    function EnviarEmail(destino, copias, texto, assunto, xml, pdf, nome_cliente, nome_empresa: String): Boolean;
    procedure Inicializar;
    function GeraxmlCont(vChaveNFE: string; vFlaCodigo: string = '1'): Boolean;
    procedure VerifieAjustaItemcomConsumidorFinal;
    procedure VerifieAjustaItemMonofasico;
    procedure VerifieAjustaICM;
    function LerConfiguracaoNFCe: Boolean;

  protected
    // procedure ActionChange(Sender: TObject; CheckDefaults: Boolean); override;
    { Private declarations }
    vpConsultaVisivel: Boolean;
  published
    property zcone: TUniConnection read Fzcone write Setzcone;

  public
    { Public declarations }
    Acesso: TAcesso;
    vpFilial: string;
    vpPastaPrincipal: string;
    vpMesChave: String;
    vpFlacodigo: String;

    vpDataAtual: TdateTime;
    vpSubPastaDoc: string;
    vpAAAAMMNNNFCe: string;
    vpTrmCodigo: string;
    vpClbCodigo: string;

    vpNomeArquivoNFCe: string;
    vPastaPrincipal: string;

    vpConsultouSEFAZ: Boolean;
    vpDataHoraSEFAZ: TdateTime;
  end;

const
  (* Tipos de Emissão de NFCe *)
  temiNormal = 1;
  temiContingencia = 2;
  temiContingenciOffLine = 9;

var
  fnfce: Tfnfce;

  (* Identifica situação do Web Service como Normal - OnLine *)
  vpWSNormal: Boolean = True;

implementation

{$R *.dfm}

function modulonfce(AOwner: TComponent; conexao: TUniConnection; vMesChave: string; vFuncao: string; Acesso: TAcesso; vImprimir: Boolean;
  vConsultouSefaz: Boolean; vemail: string): Boolean;
var
  vDia: string;
  vHora: string;

begin
  try

    fnfce := Tfnfce.Create(AOwner);

    fnfce.zcone := conexao;
    fnfce.Acesso := Acesso;
    fnfce.vpTrmCodigo := Acesso.Terminal.ToString;
    fnfce.vpClbCodigo := Acesso.Usuario.ToString;
    fnfce.vpFlacodigo := Acesso.Filial.ToString;

    (*
      * Variável que identifica se já foi feita primeira consulta do Status da SEFAZ
      * para reverter o problemas dos certificados digitais de cartão
    *)
    fnfce.vpConsultouSEFAZ := vConsultouSefaz;

    if fnfce.vpConsultouSEFAZ then
    begin
      fnfce.plStatusSefaz.Caption := 'SEFAZ on-line';
      application.ProcessMessages;
    end
    else
    begin
      fnfce.plStatusSefaz.Caption := 'SEFAZ sem acesso';
      application.ProcessMessages;
    end;

    fnfce.InicializaTabelas;

    (* Ajusta pasta Principal de salvamento dos arquivos. *)
    if fnfce.cfgcfgservarqnfes.AsString = '' then
      fnfce.vpPastaPrincipal := ExtractFilePath(application.ExeName)
    else
      fnfce.vpPastaPrincipal := fnfce.cfgcfgservarqnfes.AsString;

    if Copy(fnfce.vpPastaPrincipal, Length(fnfce.vpPastaPrincipal), 1) <> '\' then
      fnfce.vpPastaPrincipal := fnfce.vpPastaPrincipal + '\';

    fnfce.vpSubPastaDoc := 'arqnfces';

    (* Ajusta as configurações do Componente *)
    if not fnfce.LerConfiguracaoNFCe then
    begin
      ShowMessage('Verifique as configurações para emissão de NFCe');
      Exit;
    end;

    if fnfce.cfgcfgservarqnfes.AsString = '' then
    begin
      fnfce.vPastaPrincipal := ExtractFilePath(application.ExeName);
    end
    else
    begin
      fnfce.vPastaPrincipal := fnfce.cfgcfgservarqnfes.AsString;
    end;

    (* Atribui a variável a data atual do servidor *)

    fnfce.vpConsultaVisivel := False;

    // vDia :=fnfe.mesmesemissao.AsString; // hoje(Application, conexao);
    vDia := hoje(application, conexao);
    vHora := agora(application, conexao);

    fnfce.vpDataAtual := strtodatetime(formatdatetime('dd/mm/yyyy', strtodate(vDia)) + ' ' + formatdatetime('hh:mm:ss', strtodatetime(vHora)));
    // fnfe.consulta.Fields[0].AsFloat;


    // fnfce.vpDataAtual := strtodatetime(agora(application, fnfce.zcone));

    fnfce.AjustaCaminhoGeralNF(fnfce.vpDataAtual);

    (* Identifica se Contingência está Ativa *)
    if fnfce.rec.Active = False then
      fnfce.rec.Open;

    if fnfce.rec.IsEmpty then
    begin
      case ansiIndexStr(vFuncao, ['EmiteNFCe', 'ImprimeNFCe', 'CancelaNFCe', 'ConsultaServicoSEFAZNFCE', 'VerificaExistencia', 'AjustaSituacaoNFCe',
        'InutilizarNumerosNFCE', 'InutilizarNumerosNFCEDireto', 'GerarXML', 'ReGerarXML', 'VisualizaNFCe', 'EmailNFCe', 'GerarXMLCont']) of
        12:
          vpWSNormal := False;
      else
        vpWSNormal := True;
      end;
    end
    else
      vpWSNormal := False;

    if (vMesChave <> '0') and (vMesChave <> '') then
      fnfce.vpNomeArquivoNFCe := fnfce.GeraNomeArqNFCe(vMesChave, fnfce.vpFlacodigo);

    fnfce.vpMesChave := vMesChave;

    case ansiIndexStr(vFuncao, ['EmiteNFCe', 'ImprimeNFCe', 'CancelaNFCe', 'ConsultaServicoSEFAZNFCE', 'VerificaExistencia', 'AjustaSituacaoNFCe',
      'InutilizarNumerosNFCE', 'InutilizarNumerosNFCEDireto', 'GerarXML', 'ReGerarXML', 'VisualizaNFCe', 'EmailNFCe', 'GerarXMLCont']) of
      0:
        Result := fnfce.EmiteNFCe(vMesChave, vImprimir, fnfce.vpFlacodigo);
      1:
        Result := fnfce.ImprimeNFCe(vMesChave, fnfce.vpFlacodigo);
      2:
        fnfce.CancelaNFCe(vMesChave, fnfce.vpFlacodigo);
      3:
        begin
          fnfce.vpConsultaVisivel := True;
          fnfce.ConsultaServicoSEFAZNFCE;
        end;
      4:
        Result := fnfce.VerificaExistencia(vMesChave, fnfce.vpFlacodigo);
      5:
        Result := fnfce.AjustaSituacaoNFCe(vMesChave, fnfce.vpFlacodigo);
      6:
        Result := fnfce.InutilizarNumerosNFCe;
      7:
        Result := fnfce.InutilizarNumerosNFCeDireto;
      8:
        Result := fnfce.Geraxml(vMesChave, fnfce.vpFlacodigo);
      9:
        Result := fnfce.ReGeraxml(vMesChave, fnfce.vpFlacodigo);
      10:
        Result := fnfce.ImprimeNFCe(vMesChave, fnfce.vpFlacodigo, True);
      11:
        Result := fnfce.EmailNFCe(vMesChave, fnfce.vpFlacodigo, True, vemail);
      12:
        Result := fnfce.GeraxmlCont(vMesChave, fnfce.vpFlacodigo);

    end;

  finally

    System.Classes.UnRegisterClass(TACBrValidador);

    System.Classes.UnRegisterClass(TACBrNFe);
    System.Classes.UnRegisterClass(TMemo);
    fnfce.Close;
    FreeAndNil(fnfce);
  end;
end;

exports modulonfce;

(*
  *
  ****** Verifica Pré-existência da NFe *******
  *
*)

function RoundCurrency(const Value: Currency): Currency;
var
  V64: Int64 absolute Result;
  Decimals: Integer;
begin
  Result := Value;
  Decimals := V64 mod 100;
  Dec(V64, Decimals);
  case Decimals of
    - 99 .. -50:
      Dec(V64, 100);
    50 .. 99:
      Inc(V64, 100);
  end;
end;

procedure Tfnfce.VerifieAjustaICM;
var
  vlcfop: string;
  vlcstcodigo: string;
  vlcsicodigo: string;
  vlcspcodigo: string;
  vlcsfcodigo: string;
  vlcfgpercentualpis: string;
  vlcfgpercentualcofins: string;
begin

  if cfgcfgtributacaoimendes.AsInteger = 0 then
  begin

    itm.Close;
    itm.Params[0].AsString := vpMesChave;
    itm.Params[1].AsInteger := Acesso.Filial;
    itm.Open;

    itm.First;

    While Not itm.Eof Do
    Begin

      if (cfgcfgdefinetoeatendimento.AsInteger = 0) then
      begin

        if (itmitmaliqpis.AsFloat > 0) and (itmitmaliqcofins.AsFloat > 0) then
        begin

          itm.Edit;
          itmitmpis.AsFloat := ((itmitmvalor.AsCurrency * itmitmquantidade.AsFloat) - itmitmdesconto.AsCurrency + itmitmfrete.AsCurrency +
            itmitmoutras.AsCurrency) * (itmitmaliqpis.AsFloat / 100);
          itmitmbpis.AsCurrency := ((itmitmvalor.AsCurrency * itmitmquantidade.AsFloat) - itmitmdesconto.AsCurrency + itmitmfrete.AsCurrency +
            itmitmoutras.AsCurrency);

          itmitmcofins.AsFloat := ((itmitmvalor.AsCurrency * itmitmquantidade.AsFloat) - itmitmdesconto.AsCurrency + itmitmfrete.AsCurrency +
            itmitmoutras.AsCurrency) * (itmitmaliqcofins.AsFloat / 100);
          itmitmbcofins.AsCurrency := ((itmitmvalor.AsCurrency * itmitmquantidade.AsFloat) - itmitmdesconto.AsCurrency + itmitmfrete.AsCurrency +
            itmitmoutras.AsCurrency);
          itm.post;
        end
        else
        begin

          itm.Edit;
          itmitmpis.AsFloat := 0;
          itmitmbpis.AsCurrency := 0;
          itmitmcofins.AsFloat := 0;
          itmitmbcofins.AsCurrency := 0;
          itm.post;

        end;

      end;
      itm.Next;
    End;

  end
  else
  begin

    if cfgcfgproducaopropria.AsInteger = 1 then
    begin

      if cfgcfgtoeinteproducaopropria.AsInteger <> 0 then
      begin

        itm.Close;
        itm.Params[0].AsString := vpMesChave;
        itm.Params[1].AsInteger := Acesso.Filial;
        itm.Open;

        itm.First;

        While Not itm.Eof Do
        Begin

          if itmproproducao.AsInteger = 1 then
          begin

            consulta.Close;
            consulta.SQL.Text :=
              'select cfocfop toecfopsaida, cstcodigo,csicodigo ,cspcodigo,csfcodigo , propisaliquota cfgpercentualpis,icmcodigo,procofinsaliquota cfgpercentualcofins ,propercreducaobaseicm,cfocfopfora,icmcodigofora from pro where procodigo='
              + itmprocodigo.AsString;
            consulta.Open;

            {
              consulta.Close;
              consulta.SQL.Text :=
              'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo=' +
              cfgcfgtoeinteproducaopropria.AsString;
              consulta.Open;
            }

            vlcfop := consulta.FieldByName('toecfopsaida').AsString;

            vlcstcodigo := consulta.FieldByName('cstcodigo').AsString;
            vlcsicodigo := consulta.FieldByName('csicodigo').AsString;
            vlcspcodigo := consulta.FieldByName('cspcodigo').AsString;
            vlcsfcodigo := consulta.FieldByName('csfcodigo').AsString;

            vlcfgpercentualpis := consulta.FieldByName('cfgpercentualpis').AsString;
            // vlcfgpercentualpis := StringReplace(vlcfgpercentualpis, ',', '.', [rfReplaceAll, rfIgnoreCase]);

            vlcfgpercentualcofins := consulta.FieldByName('cfgpercentualcofins').AsString;
            // vlcfgpercentualcofins := StringReplace(vlcfgpercentualcofins, ',', '.', [rfReplaceAll, rfIgnoreCase]);

            itm.Edit;
            itmcfocfop.AsString := vlcfop;

            itmitmaliqcofins.AsString := vlcfgpercentualcofins;
            itmitmaliqpis.AsString := vlcfgpercentualpis;

            itmitmcofins.AsFloat := itmitmtotal.AsCurrency * (strtofloat(vlcfgpercentualcofins) / 100);
            itmitmpis.AsFloat := itmitmtotal.AsCurrency * (strtofloat(vlcfgpercentualpis) / 100);

            itmcstcodigo.AsString := vlcstcodigo;
            itmcsicodigo.AsString := vlcsicodigo;
            itmcspcodigo.AsString := vlcspcodigo;
            itmcsfcodigo.AsString := vlcsfcodigo;
            itmtoecodigo.AsString := cfgcfgtoeinteproducaopropria.AsString;
            itm.post;

          end;

          itm.Next;
        end;
      end;

    end;

  end;
end;

procedure Tfnfce.VerifieAjustaItemMonofasico;
var
  vlcfop: string;
  vlcstcodigo: string;
  vlcsicodigo: string;
  vlcspcodigo: string;
  vlcsfcodigo: string;
  vlcfgpercentualpis: string;
  vlcfgpercentualcofins: string;
begin
  if cfgcfgtributacaoimendes.AsInteger = 0 then
  begin

    itm.First;

    // ajusta o toe do item para produto com substituição
    While Not itm.Eof Do
    Begin
      if (cfgcfgdefinetoeatendimento.AsInteger = 0) then
      begin

        consulta.Close;
        consulta.SQL.Text := 'select padcodigo from pro where procodigo=' + itmprocodigo.AsString;

        consulta.Open;
        if not consulta.IsEmpty then
        begin
          if (consulta.FieldByName('padcodigo').AsString <> '') and (consulta.FieldByName('padcodigo').AsString <> '1') then
          begin
            pad.Close;
            pad.Connection := zcone;
            pad.ParamByName('padcodigo').AsString := consulta.FieldByName('padcodigo').AsString;
            pad.Open;

            if not pad.IsEmpty then
            begin

              if (padpadpis.AsString <> '') and (padpadcofins.AsString <> '') then
              begin

                vlcspcodigo := padpadcodigopiscofins.AsString;
                vlcsfcodigo := padpadcodigopiscofins.AsString;

                vlcfgpercentualpis := padpadpis.AsString;
                vlcfgpercentualpis := StringReplace(vlcfgpercentualpis, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                vlcfgpercentualcofins := padpadcofins.AsString;
                vlcfgpercentualcofins := StringReplace(vlcfgpercentualcofins, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                itmncm.Close;

                itmncm.SQL.Text := 'update itm set csfcodigo=' + QuotedStr(vlcsfcodigo) + '   ,cspcodigo=' + QuotedStr(vlcspcodigo) +
                  '    ,itmaliqcofins=' + vlcfgpercentualcofins + ' ,itmaliqpis=' + vlcfgpercentualpis + ' where itmchave=' + itmitmchave.AsString;
                itmncm.ExecSQL;

              end;

            end;

          end;
        end;

      end;
      itm.Next;
    End;

    { itmncm.Close;
      itmncm.SQL.Text := 'update mes set toecodigo=' + cfgcfgtoemesinte.AsString + ' where meschave=' + mesmeschave.AsString;
      itmncm.ExecSQL;
    }
  end;
  // fim do ajusta o toe do item para produto com substituição

end;

procedure Tfnfce.VerifieAjustaItemcomConsumidorFinal;
var
  vlcfop: string;
  vlcstcodigo: string;
  vlcsicodigo: string;
  vlcspcodigo: string;
  vlcsfcodigo: string;
  vlcfgpercentualpis: string;
  vlcfgpercentualcofins: string;
  vlimecodigo: string;
begin

  vlimecodigo := '';

  consulta.Close;
  consulta.SQL.Text := 'select imecodigo from pun where puncodigo=' + itmpuncodigo.AsString;
  consulta.Open;

  if not consulta.IsEmpty then
  begin
    vlimecodigo := trim(consulta.FieldByName('imecodigo').AsString);
  end;

  if (cfgcfgtributacaoimendes.AsInteger = 0) or (vlimecodigo = '') then
  begin

    itm.First;

    // ajusta o toe do item para produto com substituição
    While Not itm.Eof Do
    Begin
      if (cfgcfgdefinetoeatendimento.AsInteger = 0) then
      begin

        consulta.Close;
        consulta.SQL.Text :=
          'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo=' +
          cfgcfgtoemesinte.AsString;
        consulta.Open;

        vlcstcodigo := consulta.FieldByName('cstcodigo').AsString;
        vlcsicodigo := consulta.FieldByName('csicodigo').AsString;
        vlcspcodigo := consulta.FieldByName('cspcodigo').AsString;
        vlcsfcodigo := consulta.FieldByName('csfcodigo').AsString;

        vlcfgpercentualpis := consulta.FieldByName('cfgpercentualpis').AsString;
        vlcfgpercentualpis := StringReplace(vlcfgpercentualpis, ',', '.', [rfReplaceAll, rfIgnoreCase]);

        vlcfgpercentualcofins := consulta.FieldByName('cfgpercentualcofins').AsString;
        vlcfgpercentualcofins := StringReplace(vlcfgpercentualcofins, ',', '.', [rfReplaceAll, rfIgnoreCase]);

        vlcfop := consulta.FieldByName('toecfopsaida').AsString;

        itmncm.Close;

        itmncm.SQL.Text := 'update itm set itmcofins=' + vlcfgpercentualcofins + ' ,itmpis=' + vlcfgpercentualpis + ', cfocfop=' + QuotedStr(vlcfop) +
          ',cstcodigo=' + QuotedStr(vlcstcodigo) + ', csicodigo=' + QuotedStr(vlcsicodigo) + ', cspcodigo=' + QuotedStr(vlcspcodigo) + ',csfcodigo=' +
          QuotedStr(vlcsfcodigo) + ', toecodigo=' + cfgcfgtoemesinte.AsString + ' where itmchave=' + itmitmchave.AsString;
        itmncm.ExecSQL;

        consulta.Close;
        consulta.SQL.Text := 'select padcodigo from pro where procodigo=' + itmprocodigo.AsString;
        consulta.Open;
        if not consulta.IsEmpty then
        begin
          if consulta.FieldByName('padcodigo').AsString <> '' then
          begin
            pad.Close;
            pad.Connection := zcone;
            pad.ParamByName('padcodigo').AsString := consulta.FieldByName('padcodigo').AsString;
            pad.Open;

            if not pad.IsEmpty then
            begin

              if (padpadpis.AsString <> '') and (padpadcofins.AsString <> '') and (padpadcofins.AsString <> '1') then
              begin

                vlcspcodigo := padpadcodigopiscofins.AsString;
                vlcsfcodigo := padpadcodigopiscofins.AsString;

                vlcfgpercentualpis := padpadpis.AsString;
                vlcfgpercentualpis := StringReplace(vlcfgpercentualpis, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                vlcfgpercentualcofins := padpadcofins.AsString;
                vlcfgpercentualcofins := StringReplace(vlcfgpercentualcofins, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                itmncm.Close;

                itmncm.SQL.Text := 'update itm set csfcodigo=' + QuotedStr(vlcsfcodigo) + '   ,cspcodigo=' + QuotedStr(vlcspcodigo) +
                  '    ,itmaliqcofins=' + vlcfgpercentualcofins + ' ,itmaliqpis=' + vlcfgpercentualpis + ' where itmchave=' + itmitmchave.AsString;
                itmncm.ExecSQL;

              end;

            end;

          end;
        end;

      end;
      itm.Next;
    End;
    if mesmeschave.AsString <> '' then
    begin
      itmncm.Close;
      itmncm.SQL.Text := 'update mes set toecodigo=' + cfgcfgtoemesinte.AsString + ' where meschave=' + mesmeschave.AsString;
      itmncm.ExecSQL;
    end;

  end;


  // fim do ajusta o toe do item para produto com substituição

end;

function Tfnfce.ValidaConsumidor(vMesChave: string; vFlaCodigo: String = '1'): Boolean;
var
  vlNrDoc: string;
  vlNrCEP: string;

begin

  if cfgcfgtributacaoimendes.AsInteger = 0 then
  begin

    mes.Close;
    mes.Params[0].AsString := vMesChave;
    mes.Params[1].AsString := vFlaCodigo;
    mes.Open;

    etd.Close;
    etd.ParamByName('etdcodigo').AsInteger := mesetdcodigo.AsInteger;
    etd.ParamByName('edritem').AsInteger := mesedritem.AsInteger;
    etd.Open;

    if trim(LowerCase(etdetdidentificacao.AsString)) <> 'consumidor' then
    begin

      vlNrDoc := SomenteNumeros(Self.etdetddoc1.AsString);

      case Length(vlNrDoc) of
        11:
          ACBrValidador.TipoDocto := docCPF;
        14:
          ACBrValidador.TipoDocto := docCNPJ;
      end;

      if vlNrDoc <> '0' then
      begin
        ACBrValidador.Documento := vlNrDoc;

        if not ACBrValidador.Validar then
        begin
          application.MessageBox(PChar('Erro preenchimento dos dados da NFC-e.' + #13 + #13 + #13 + 'Número do documento inválido para o Cliente:' +
            #13 + #13 + etdetdidentificacao.AsString), 'Emissão como CONSUMIDOR', MB_OK + MB_ICONERROR);
          Result := False;
          Exit;
        end;
        Result := True;
      end
      else
      begin
        Result := False;
      end;

    end
    else
    begin
      Result := True;
    end;

  end
  else
  begin
    Result := True;
  end;
end;

function Tfnfce.GeraxmlCont(vChaveNFE: string; vFlaCodigo: string = '1'): Boolean;
begin
  try
    Result := False;

    if not vpConsultouSEFAZ then
    begin
      vpConsultaVisivel := False;
      ConsultaServicoSEFAZNFCE;
    end;

    PlTitulo.Caption := 'Gerar NFC-e';

    fnfce.Show;

    plestagio.Caption := 'Carga dos dados';

    mes.Close;
    mes.Params[0].AsString := vChaveNFE;
    mes.Params[1].AsString := vFlaCodigo;
    mes.Open;

    plestagio.Caption := 'Ajusta pastas';

    (* Ajusta caminho para poder localizar arquivo com base na data do campo mesregistro *)
    AjustaCaminhoGeralNF(Self.mesmesregistro.AsFloat);
    plestagio.Caption := 'Verifica pré-existencia';

    plestagio.Caption := 'Recarrega Dados';

    { mes.Close;
      mes.Params[0].AsString := vChaveNFE;
      mes.Params[1].AsString := vFlaCodigo;
      mes.Open; }

    plestagio.Caption := 'Consulta Pastas';

    (* Ajusta caminho para data atual pois não é uma NFE válida *)
    AjustaCaminhoGeralNF(vpDataAtual);

    plestagio.Caption := 'Valida consumidor';

    (* Se NÃO validar o cadastro do destinatário abandona emissão *)
    { if not ValidaConsumidor(vChaveNFE, fnfce.vpFlacodigo) then

      Exit; }

    plestagio.Caption := 'Valida produtos';

    (* Se NÃO validas os itens do registros abandona a geração da NFCe *)


    { if not ValidaProdutos(vChaveNFE) then
      Exit; }

    plestagio.Caption := 'Gera NFC-e';

    (* Se retornou erro na geração da NFCe abandona *)
    if not GeraNFCe(vChaveNFE, fnfce.vpFlacodigo) then
      Exit;

    (*
      Identifica situação do Web Service da SEFAZ
      Se não estiver normal salva NFe como Contingência
    *)
    vpWSNormal := False;

    if not vpWSNormal then
    begin
      plestagio.Caption := 'Salva em contingencia';

      if Self.SalvaEmCoontigencia(ACBrNFeNFCe, vChaveNFE) then
      begin
        vpNomeArquivoNFCe := GeraNomeArqNFCe(vChaveNFE, vFlaCodigo);

        Result := True;
      end;
    end
    else if Self.SalvaNormal(ACBrNFeNFCe, vChaveNFE, vFlaCodigo) then
    begin
      plestagio.Caption := 'Salva normal';

      vpNomeArquivoNFCe := GeraNomeArqNFCe(vChaveNFE, vFlaCodigo);

      Result := True;
    end;
  finally

    fnfce.Close;
  end;

end;

function Tfnfce.Geraxml(vChaveNFE: string; vFlaCodigo: string = '1'): Boolean;
begin
  try
    Result := False;

    if not vpConsultouSEFAZ then
    begin
      vpConsultaVisivel := False;
      ConsultaServicoSEFAZNFCE;
    end;

    PlTitulo.Caption := 'Gerar NFC-e';

    fnfce.Show;

    plestagio.Caption := 'Carga dos dados';

    mes.Close;
    mes.Params[0].AsString := vChaveNFE;
    mes.Params[1].AsString := vFlaCodigo;
    mes.Open;

    plestagio.Caption := 'Ajusta pastas';

    (* Ajusta caminho para poder localizar arquivo com base na data do campo mesregistro *)
    AjustaCaminhoGeralNF(Self.mesmesregistro.AsFloat);
    plestagio.Caption := 'Verifica pré-existencia';

    plestagio.Caption := 'Recarrega Dados';

    plestagio.Caption := 'Consulta Pastas';

    (* Ajusta caminho para data atual pois não é uma NFE válida *)

    if Copy(mesmesprotocolo.AsString, 1, 15) <> '00000000000000' then
    begin
      AjustaCaminhoGeralNF(mesmesdatanfe.AsDateTime);
    end
    else
    begin
      AjustaCaminhoGeralNF(vpDataAtual);
    end;

    plestagio.Caption := 'Valida consumidor';

    (* Se NÃO validar o cadastro do destinatário abandona emissão *)
    { if not ValidaConsumidor(vChaveNFE, fnfce.vpFlacodigo) then

      Exit; }

    plestagio.Caption := 'Valida produtos';

    (* Se NÃO validas os itens do registros abandona a geração da NFCe *)
    { if not ValidaProdutos(vChaveNFE) then
      Exit; }

    plestagio.Caption := 'Gera NFC-e';

    (* Se retornou erro na geração da NFCe abandona *)
    if not GeraNFCe(vChaveNFE, fnfce.vpFlacodigo) then
      Exit;

    (*
      Identifica situação do Web Service da SEFAZ
      Se não estiver normal salva NFe como Contingência
    *)

    if not vpWSNormal then
    begin
      plestagio.Caption := 'Salva em contingencia';

      if Self.SalvaEmCoontigencia(ACBrNFeNFCe, vChaveNFE) then
      begin
        vpNomeArquivoNFCe := GeraNomeArqNFCe(vChaveNFE, vFlaCodigo);

        Result := True;
      end;
    end
    else if Self.SalvaNormal(ACBrNFeNFCe, vChaveNFE, vFlaCodigo) then
    begin
      plestagio.Caption := 'Salva normal';

      vpNomeArquivoNFCe := GeraNomeArqNFCe(vChaveNFE, vFlaCodigo);

      Result := True;
    end;
  finally

    fnfce.Close;
  end;

end;

function Tfnfce.ReGeraxml(vChaveNFE: string; vFlaCodigo: string = '1'): Boolean;
begin
  try
    Result := False;

    if not vpConsultouSEFAZ then
    begin
      vpConsultaVisivel := False;
      // ConsultaServicoSEFAZNFCE;
    end;

    PlTitulo.Caption := 'Gerar NFC-e';

    fnfce.Show;

    plestagio.Caption := 'Carga dos dados';

    mes.Close;
    mes.Params[0].AsString := vChaveNFE;
    mes.Params[1].AsString := vFlaCodigo;
    mes.Open;

    plestagio.Caption := 'Ajusta pastas';

    (* Ajusta caminho para poder localizar arquivo com base na data do campo mesregistro *)
    AjustaCaminhoGeralNF(Self.mesmesregistro.AsFloat);
    vpDataAtual := Self.mesmesregistro.AsDateTime;

    plestagio.Caption := 'Verifica pré-existencia';

    plestagio.Caption := 'Recarrega Dados';

    { mes.Close;
      mes.Params[0].AsString := vChaveNFE;
      mes.Params[1].AsString := vFlaCodigo;
      mes.Open; }

    plestagio.Caption := 'Consulta Pastas';

    (* Ajusta caminho para data atual pois não é uma NFE válida *)
    AjustaCaminhoGeralNF(vpDataAtual);

    plestagio.Caption := 'Valida consumidor';

    (* Se NÃO validar o cadastro do destinatário abandona emissão *)
    { if not ValidaConsumidor(vChaveNFE, fnfce.vpFlacodigo) then

      Exit; }

    plestagio.Caption := 'Valida produtos';

    (* Se NÃO validas os itens do registros abandona a geração da NFCe *)
    { if not ValidaProdutos(vChaveNFE) then
      Exit; }

    plestagio.Caption := 'Gera NFC-e';

    (* Se retornou erro na geração da NFCe abandona *)
    if not ReGeraNFCe(vChaveNFE, fnfce.vpFlacodigo) then
      Exit;

    (*
      Identifica situação do Web Service da SEFAZ
      Se não estiver normal salva NFe como Contingência
    *)

  finally

    fnfce.Close;
  end;

end;

function Tfnfce.ValidaProdutos(vMesChave: string; vFlaCodigo: string): Boolean;
var
  (* Utilizados para chamada do mvpr - Validação de Produtos *)
  ValidarProdutos: function(AOwner: TComponent; conexao: TUniConnection; ChaveMes: string; CodigoFilial: string = '1';
    VerificaNCM: Boolean = True): Boolean;
  vPodeProdutos: Boolean;
  PackMvpr: HModule;

begin
  Result := True;
  PackMvpr := LoadPackage('modulos\mvpr.bpl');

  If PackMvpr <> 0 Then
    Try
      @ValidarProdutos := GetProcAddress(PackMvpr, PChar('ValidaProdutos'));

      If Assigned(ValidarProdutos) Then
        Result := ValidarProdutos(application, zcone, vMesChave, vFlaCodigo);

    Finally
      // DoUnLoadPackage(application, PackMvpr);
    End;

end;

procedure Tfnfce.InicializaTabelas;
var
  vlQtTabelas: Integer;
begin
  try
    try

      consulta.Connection := fnfce.zcone;
      rec.Connection := fnfce.zcone;
      mes.Connection := fnfce.zcone;
      itm.Connection := fnfce.zcone;
      etd.Connection := fnfce.zcone;
      toe.Connection := fnfce.zcone;
      enf.Connection := fnfce.zcone;
      mev.Connection := fnfce.zcone;
      cfg.Connection := fnfce.zcone;
      trm.Connection := fnfce.zcone;
      mic.Connection := fnfce.zcone;
      oic.Connection := fnfce.zcone;
      qDtl.Connection := fnfce.zcone;
      rni.Connection := fnfce.zcone;
      NumeroNFCe.Connection := fnfce.zcone;

      disponivel.Connection := fnfce.zcone;
      limite.Connection := fnfce.zcone;
      ncm.Connection := fnfce.zcone;
      itmncm.Connection := fnfce.zcone;

      cfg.Close;
      cfg.ParamByName('flacodigo').AsInteger := Acesso.Filial;
      cfg.Open;

      trm.Close;
      trm.SQL.Text := 'SELECT DISTINCT tci.tciporta, mit.ecfcodigo, cit.trmcodigo, mit.tipcodigo FROM tci ';
      trm.SQL.Add('INNER JOIN mit  ON tci.mitcodigo = mit.mitcodigo ');
      trm.SQL.Add('INNER JOIN cit ON cit.tcicodigo = tci.tcicodigo ');
      trm.SQL.Add('WHERE  tci.trmcodigo = ' + vpTrmCodigo);
      trm.SQL.Add(' and  cit.trmcodigo=' + vpTrmCodigo);
      trm.SQL.Add(' AND mit.tipcodigo=2');
      trm.Open;

      Panel1.Caption := 'TRM: ' + trmtrmcodigo.AsString + ' Aguarde ...';

    except
      on e: EAccessViolation do
      begin
        MessageDlg('Houve uma violação de acesso, com a mensagem' + e.Message, MtError, [MbOk], 0);
      end;
    end;

  finally

  end;
end;

function Tfnfce.GeraNomeArqNFCe(vMesChave: string; vFlaCodigo: String = '1'): string;
var
  vlArqNFCe: String;
  vData: Double;
  vlCNPJ: String;
  vlNrNFCe, vlNrSer, vlCodigoNFCe: Integer;

  vlUfCod: string;

begin
  vlArqNFCe := '';

  try
    mes.Close;
    mes.Params[0].AsString := vMesChave;
    mes.Params[1].AsString := vFlaCodigo;
    mes.Open;

    if mesmesnumero.AsInteger = 0 then
      Exit;

    if mesmesdatanfe.AsFloat = 0 then
      vData := mesmesregistro.AsFloat
    else
      vData := mesmesdatanfe.AsFloat;

    if mesmeschavenfe.AsString <> '' then
    begin
      vlArqNFCe := mesmeschavenfe.AsString;
      vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe + '-nfe.xml';
    end;

    if FileExists(vlArqNFCe) then
      Exit;

    (* Tenta encontrar arquivo da NFCe com geração NORMAL *)
    vlCNPJ := SomenteNumeros(Self.cfgetddoc1.AsString);
    vlUfCod := Copy(Self.cfgcddcodigo.AsString, 1, 2);

    vlNrNFCe := mesmesnumero.AsInteger;
    vlCodigoNFCe := mesmescodigonota.AsInteger;

    if mesmesserie.AsString <> '' then
      vlNrSer := mesmesserie.AsInteger
    else
      vlNrSer := 1;

    vlCNPJ := SomenteNumeros(vlCNPJ);

    // nome da nota com emissao normal
    vlArqNFCe := Copy(vlUfCod, 1, 2);
    vlArqNFCe := vlArqNFCe + formatdatetime('yymm', vData);
    vlArqNFCe := vlArqNFCe + vlCNPJ;
    vlArqNFCe := vlArqNFCe + '65';
    vlArqNFCe := vlArqNFCe + FormatFloat('000', vlNrSer);
    vlArqNFCe := vlArqNFCe + FormatFloat('000000000', vlNrNFCe);
    vlArqNFCe := vlArqNFCe + '1';
    vlArqNFCe := vlArqNFCe + FormatFloat('00000000', vlCodigoNFCe);
    vlArqNFCe := vlArqNFCe + Modulo11(trim(vlArqNFCe));
    vlArqNFCe := vlArqNFCe + '-nfe.xml';

    vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe;

    if FileExists(vlArqNFCe) then
      Exit;

    (* Tenta encontrar arquivo da NFCe com emissão em CONTINGÊNCIA - CÓD 2 *)
    vlArqNFCe := Copy(vlUfCod, 1, 2);
    vlArqNFCe := vlArqNFCe + formatdatetime('yymm', vData);
    vlArqNFCe := vlArqNFCe + vlCNPJ;
    vlArqNFCe := vlArqNFCe + '65';
    vlArqNFCe := vlArqNFCe + FormatFloat('000', vlNrSer);
    vlArqNFCe := vlArqNFCe + FormatFloat('000000000', vlNrNFCe);
    vlArqNFCe := vlArqNFCe + '2';
    vlArqNFCe := vlArqNFCe + FormatFloat('00000000', vlCodigoNFCe);
    vlArqNFCe := vlArqNFCe + Modulo11(trim(vlArqNFCe));
    vlArqNFCe := vlArqNFCe + '-nfe.xml';

    vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe;

    if FileExists(vlArqNFCe) then
      Exit;

    (* Tenta encontrar arquivo da NFCe com emissão em CONTINGÊNCIA OFFLINE - CÓD 9 *)
    vlArqNFCe := Copy(vlUfCod, 1, 2);
    vlArqNFCe := vlArqNFCe + formatdatetime('yymm', vData);
    vlArqNFCe := vlArqNFCe + vlCNPJ;
    vlArqNFCe := vlArqNFCe + '65';
    vlArqNFCe := vlArqNFCe + FormatFloat('000', vlNrSer);
    vlArqNFCe := vlArqNFCe + FormatFloat('000000000', vlNrNFCe);
    vlArqNFCe := vlArqNFCe + '9';
    vlArqNFCe := vlArqNFCe + FormatFloat('00000000', vlCodigoNFCe);
    vlArqNFCe := vlArqNFCe + Modulo11(trim(vlArqNFCe));
    vlArqNFCe := vlArqNFCe + '-nfe.xml';

    vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe;

    if FileExists(vlArqNFCe) then
      Exit;

    (* Se chegou até aqui é porque arquivo não existe *)

    vlArqNFCe := '';
  finally
    Result := vlArqNFCe;
  end;
end;

function Tfnfce.GeraNomeArqNFCeTipo(vMesChave: string; vTipoEmissao: Integer; vFlaCodigo: string = '1'): string;
var
  vlArqNFCe: String;
  vlData: Double;
  vlCNPJ: String;
  vlNrNFCe, vlNrSer: Integer;
  vlUfCod: string;
begin
  mes.Close;
  mes.Params[0].AsString := vMesChave;
  mes.Params[1].AsString := vFlaCodigo;
  mes.Open;

  if mesmesnumero.AsInteger = 0 then
    Exit;

  if mesmesdatanfe.AsFloat = 0 then
    vlData := mesmesregistro.AsFloat
  else
    vlData := mesmesdatanfe.AsFloat;

  (* Carrega dados para formação do nome do arquivo *)
  vlCNPJ := SomenteNumeros(Self.cfgetddoc1.AsString);
  vlUfCod := Copy(Self.cfgcddcodigo.AsString, 1, 2);

  vlNrNFCe := mesmesnumero.AsInteger;
  vlNrSer := mesmesserie.AsInteger;
  vlCNPJ := SomenteNumeros(vlCNPJ);

  (* Gera chave *)
  vlArqNFCe := Copy(vlUfCod, 1, 2);
  vlArqNFCe := vlArqNFCe + formatdatetime('yymm', vlData);
  vlArqNFCe := vlArqNFCe + vlCNPJ;
  vlArqNFCe := vlArqNFCe + '65';
  vlArqNFCe := vlArqNFCe + FormatFloat('000', vlNrSer);
  vlArqNFCe := vlArqNFCe + FormatFloat('000000000', vlNrNFCe);

  (* Define o tipo de emissão - 1=Normal 2=Contingencia 9=ContingenciaOffLine *)
  vlArqNFCe := vlArqNFCe + IntToStr(vTipoEmissao);

  vlArqNFCe := vlArqNFCe + FormatFloat('00000000', vlNrNFCe);
  vlArqNFCe := vlArqNFCe + Modulo11(trim(vlArqNFCe));
  vlArqNFCe := vlArqNFCe + '-nfe.xml';

  vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vlData) + '\' + vlArqNFCe;

  Result := vlArqNFCe;
end;

function Tfnfce.VerificaExistencia(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
begin
  Result := False;

  if FileExists(vpNomeArquivoNFCe) then
    if AjustaSituacaoNFCe(vMesChave, vFlaCodigo) then
      Result := True;
end;

function Tfnfce.ConsultaNFCe(vMesChave, vArqNFCe: String; vFlaCodigo: string = '1'): Boolean;
Var
  nProt: String;
  vnrnfe: String;
  vchNFe: String;
  vdtNFe: String;
  vhrNFe: String;
  vCodStatusNFe: String;
  vMsgStatusNFe: String;
  vRetorno: Boolean;
  vData: TDate;
  vlArqNFCe: string;
Begin
  vRetorno := False;

  try
    If not FileExists(vArqNFCe) Then
    begin

      if mesmesnumero.AsInteger = 0 then
        Exit;

      if mesmesdatanfe.AsFloat = 0 then
        vData := mesmesregistro.AsFloat
      else
        vData := mesmesdatanfe.AsFloat;

      if mesmeschavenfe.AsString <> '' then
      begin
        vlArqNFCe := mesmeschavenfe.AsString;
        vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe + '-nfe.xml';
      end;

    end;

    If not FileExists(vArqNFCe) Then
    begin
      ShowMessage('Arquivo não localizado!' + #13 + #13 + vArqNFCe);
      Exit;
    end;

    ACBrNFeNFCe.NotasFiscais.Clear;
    ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;

    ACBrNFeNFCe.NotasFiscais.LoadFromFile(vArqNFCe);
    ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := False;
    ACBrNFeNFCe.Consultar;

    vdtNFe := DateToStr(ACBrNFeNFCe.WebServices.consulta.DhRecbto);
    vhrNFe := TimeToStr(ACBrNFeNFCe.WebServices.consulta.DhRecbto);

    nProt := ACBrNFeNFCe.WebServices.consulta.Protocolo;
    vchNFe := ACBrNFeNFCe.WebServices.consulta.NFeChave;

    vCodStatusNFe := IntToStr(ACBrNFeNFCe.WebServices.consulta.cStat);
    vMsgStatusNFe := ACBrNFeNFCe.WebServices.consulta.xMotivo;

    vnrnfe := IntToStr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.Ide.nNF);

    (* Verifica código de retorno é igual a 100 - Uso Autorizado *)
    If (ACBrNFeNFCe.WebServices.consulta.cStat = 150) or (ACBrNFeNFCe.WebServices.consulta.cStat = 100) or
      (ACBrNFeNFCe.WebServices.consulta.cStat = 104) Then
      Try
        vRetorno := True;
        vhrNFe := TimeToStr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.Ide.dEmi);

        vdtNFe := Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.protNFe.DhRecbto), 1, 10);

        { consulta.Close;
          consulta.SQL.Text := 'set @disable_triggers=1';
          consulta.ExecSQL; }

        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';
        consulta.SQL.Add('mesregistro = ''' + (vdtNFe) + ''', ');
        // consulta.SQL.Add('mesnumero = ''' + vnrnfe + ''', ');
        consulta.SQL.Add('meschavenfe = ''' + vchNFe + ''', ');
        consulta.SQL.Add('tdfcodigo = ''65'', ');
        consulta.SQL.Add('meshoranfe = ' + QuotedStr(vhrNFe) + ', ');
        consulta.SQL.Add('temcodigo = 5, ');
        consulta.SQL.Add('mesprotocolo = ''' + nProt + ''' WHERE ');
        consulta.SQL.Add('meschave = ' + vMesChave + ' and flacodigo=' + vFlaCodigo);
        consulta.ExecSQL;

        { consulta.Close;
          consulta.SQL.Text := 'set @disable_triggers=null';
          consulta.ExecSQL; }

        consulta.Close;
        consulta.SQL.Text := 'select mesregistro,mesnumero, meschavenfe,tdfcodigo,mesprotocolo from mes where meschave=' + vMesChave;
        consulta.Open;

        { ShowMessage('Registro: ' + consulta.Fields[0].AsString + ''#13'' + (* *)
          'Nr. NFE: ' + consulta.Fields[1].AsString + ''#13'' + (* *)
          'Chave  : ' + consulta.Fields[2].AsString + ''#13'' + #13 + #13 + (* *)
          'Código Status: ' + vCodStatusNFe + #13 + (* *)
          'Status - NFE : ' + vMsgStatusNFe + #13 + (* *)
          'Protocolo Nr.: ' + nProt + #13 + (* *)
          'Data  e  Hora: ' + vdtNFe + ' - ' + vhrNFe);
        }
        consulta.Close;

      Except
      End;
  finally
    Result := vRetorno;
  end;
End;

function Tfnfce.EmiteNFCe(vMesChave: string; vImprimir: Boolean; vFlaCodigo: string = '1'): Boolean;
begin

  try
    Result := False;

    PlTitulo.Caption := 'Gerar NFC-e';
    info.Lines.Add('Inicio: ' + datetimetostr(now));
    fnfce.Show;
    mostra.max := 10;
    application.ProcessMessages;

    plestagio.Caption := 'Carga dos dados';

    info.Lines.Add('Abrindo movimento: ' + datetimetostr(now));

    mes.Close;
    mes.Params[0].AsString := vMesChave;
    mes.Params[1].AsString := vFlaCodigo;
    mes.Open;

    mostra.position := 2;
    application.ProcessMessages;

    info.Lines.Add('Movimento aberto: ' + datetimetostr(now));

    plestagio.Caption := 'Ajusta pastas';

    (* Ajusta caminho para poder localizar arquivo com base na data do campo mesregistro *)

    // AjustaCaminhoGeralNF(Self.mesmesregistro.AsFloat);

    plestagio.Caption := 'Verifica pré-existencia';
    mostra.position := 3;
    application.ProcessMessages;

    info.Lines.Add('Verificando pre-existencia da NFE: ' + datetimetostr(now));

    plestagio.Caption := 'Recarrega Dados';

    info.Lines.Add('Reabrindo movimento: ' + datetimetostr(now));
    mostra.position := 4;
    application.ProcessMessages;

    info.Lines.Add('Reaberto movimento: ' + datetimetostr(now));

    plestagio.Caption := 'Consulta Pastas';

    (* Ajusta caminho para data atual pois não é uma NFE válida *)
    AjustaCaminhoGeralNF(vpDataAtual);

    plestagio.Caption := 'Valida consumidor';

    info.Lines.Add('Validando consumidor: ' + datetimetostr(now));

    info.Lines.Add('Consumidor validado: ' + datetimetostr(now));

    plestagio.Caption := 'Valida produtos';

    info.Lines.Add('Validando produtos: ' + datetimetostr(now));

    (* Se NÃO validas os itens do registros abandona a geração da NFCe *)
    { if not ValidaProdutos(vMesChave) then
      Exit; }

    info.Lines.Add('Produtos validados: ' + datetimetostr(now));

    plestagio.Caption := 'Gera NFC-e';

    info.Lines.Add('Gerando NFCE: ' + datetimetostr(now));

    (* Se retornou erro na geração da NFCe abandona *)
    if not GeraNFCe(vMesChave, fnfce.vpFlacodigo) then
      Exit;
    mostra.position := 5;
    application.ProcessMessages;

    info.Lines.Add('NFCE Gerada: ' + datetimetostr(now));

    (*
      Identifica situação do Web Service da SEFAZ
      Se não estiver normal salva NFe como Contingência
    *)

    if not vpWSNormal then
    begin
      plestagio.Caption := 'Salva em contingencia';
      mostra.position := 6;
      application.ProcessMessages;

      if Self.SalvaEmCoontigencia(ACBrNFeNFCe, vMesChave) then
      begin
        vpNomeArquivoNFCe := GeraNomeArqNFCe(vMesChave, vFlaCodigo);

        plestagio.Caption := 'Imprime a nota';

        info.Lines.Add('Imprimindo NFCE: ' + datetimetostr(now));

        if vImprimir then
          ImprimeNFCe(vMesChave, fnfce.vpFlacodigo);
        info.Lines.Add('NFCE Impressa: ' + datetimetostr(now));

        Result := True;
      end;
    end
    else if Self.SalvaNormal(ACBrNFeNFCe, vMesChave) then
    begin
      mostra.position := 7;
      application.ProcessMessages;

      plestagio.Caption := 'Salva normal';

      info.Lines.Add('Imprimindo NFCE: ' + datetimetostr(now));

      vpNomeArquivoNFCe := GeraNomeArqNFCe(vMesChave, vFlaCodigo);
      mostra.position := 8;
      application.ProcessMessages;

      if vImprimir then
        ImprimeNFCe(vMesChave, fnfce.vpFlacodigo);
      info.Lines.Add('NFCE Impressa: ' + datetimetostr(now));

      Result := True;
    end;
  finally
    mostra.position := 10;
    application.ProcessMessages;

    if not DirectoryExists(ExtractFilePath(application.ExeName) + 'logsnfce') then
      ForceDirectories(ExtractFilePath(application.ExeName) + 'logsnfce');

    info.Lines.SaveToFile(ExtractFilePath(application.ExeName) + 'logsnfce\' + formatdatetime('yyyymmddnnss', now()) + '.txt');

    fnfce.Close;
  end;

end;

procedure Tfnfce.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  inherited;
  Action := cafree;
end;

procedure Tfnfce.FormShow(Sender: TObject);
begin
  inherited;
  Self.Width := 520;
  Self.Height := 230;

  ACBrNFeDANFCEFR1.Sistema := '(66)3544-2765 PÉGASUS Sistemas';


  // vDia :=fnfe.mesmesemissao.AsString; // hoje(Application, conexao);
  // vDia := hoje(Application, conexao);

  // fnfe.vpDataAtual := strtodatetime(formatdatetime('dd/mm/yyyy', strtodate(vDia)) + ' ' + formatdatetime('hh:mm:ss', strtodatetime(vHora)));
  // fnfe.consulta.Fields[0].AsFloat;

end;

function Tfnfce.ImprimeNFCe(vMesChave: string; vFlaCodigo: string = '1'; vVisualizar: Boolean = False): Boolean;
var
  vlArqCompro: string;

begin
  cfg.Close;
  cfg.ParamByName('flacodigo').AsInteger := Acesso.Filial;
  cfg.Open;

  Result := False;

  mes.Close;
  mes.Params[0].AsString := vMesChave;
  mes.Params[1].AsString := vFlaCodigo;
  mes.Open;

  AjustaCaminhoGeralNF(Self.mesmesregistro.AsFloat);
  vpNomeArquivoNFCe := Self.GeraNomeArqNFCe(vMesChave, vFlaCodigo);

  if vpNomeArquivoNFCe = '' then
    Exit;

  If FileExists(ExtractFilePath(application.ExeName) + 'report\DANFeNFCe.fr3') Then
  Begin
    qDtl.Close;
    qDtl.SQL.Clear;
    qDtl.SQL.Add('SELECT lte.ltetroco ');
    qDtl.SQL.Add('  FROM rfm ');
    qDtl.SQL.Add(' INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
    qDtl.SQL.Add(' INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
    qDtl.SQL.Add(' INNER JOIN lte ON mlt.ltechave = lte.ltechave ');
    qDtl.SQL.Add(' WHERE rfm.meschave = ' + vMesChave);
    qDtl.Open;

    { (* Troco *)
      if not qDtl.IsEmpty then
      ACBrNFeDANFEFR.vTroco := qDtl.Fields[0].AsFloat; }

    (* Operador *)
    // ACBrNFeDANFEFR.Usuario := mesclbidentificacao.AsString;

    if Length(trmtciporta.AsAnsiString) > 0 then
    begin
      Panel1.Caption := 'Imprimindo em ' + Self.trmtciporta.AsAnsiString + ', aguarde ...';
      application.ProcessMessages;
      ACBrNFeDANFCEFR1.Impressora := Self.trmtciporta.AsAnsiString;
    end;

    { if Length(trmtciporta.AsAnsiString) > 0 then
      if IsValidatePrinter(trmtciporta.AsAnsiString) then
      ACBrNFeDANFEFR.Impressora := Self.trmtciporta.AsAnsiString; }

    if vVisualizar then
    begin
      ACBrNFeDANFCEFR1.MostraSetup := True;
      ACBrNFeDANFCEFR1.MostraPreview := True;
      ACBrNFeDANFCEFR1.MostraStatus := True;

    end
    else
    begin
      ACBrNFeDANFCEFR1.MostraSetup := False;
      ACBrNFeDANFCEFR1.MostraPreview := False;
      ACBrNFeDANFCEFR1.MostraStatus := False;

    end;

    { if Length(ACBrNFeDANFEFR.Impressora) = 0 then
      begin
      ACBrNFeDANFEFR.MostrarPreview := True;
      ACBrNFeDANFEFR.MostrarStatus := True;
      ACBrNFeDANFEFR.ShowDialog := True;
      end; }

    ACBrNFeDANFCEFR1.FastFile := ExtractFilePath(application.ExeName) + 'report\DANFeNFCe.fr3';

    If FileExists(ExtractFilePath(application.ExeName) + 'logonfce.jpg') Then
      ACBrNFeDANFCEFR1.Logo := ExtractFilePath(application.ExeName) + 'logonfce.jpg';

    ACBrNFeNFCe.NotasFiscais.Clear;
    // ACBrNFeNFCe.DANFE.ImprimeEmUmaLinha := True;

    ACBrNFeNFCe.NotasFiscais.LoadFromFile(vpNomeArquivoNFCe);

    if vVisualizar then
    begin
      ACBrNFeDANFCEFR1.MostraSetup := True;
      ACBrNFeDANFCEFR1.MostraPreview := True;
      ACBrNFeDANFCEFR1.MostraStatus := True;
      ACBrNFeNFCe.NotasFiscais.Imprimir;

    end
    else
    begin
      if Acesso.Usuario <> 1 then
      begin

        if application.MessageBox(PChar('Cliente necessita do comprovante?' + #13 + 'Imprimir NFC-e?'), 'Atenção', MB_YESNO + MB_ICONWARNING) = IDYES
        then
        begin
          if vVisualizar then
          begin
            ACBrNFeDANFCEFR1.MostraSetup := True;
            ACBrNFeDANFCEFR1.MostraPreview := True;
            ACBrNFeDANFCEFR1.MostraStatus := True;
            ACBrNFeNFCe.NotasFiscais.Imprimir;

          end
          else
          begin

            if cfgcfgprevisualizarimpressao.AsInteger = 1 then
            begin
              ACBrNFeDANFCEFR1.MostraSetup := True;
              ACBrNFeDANFCEFR1.MostraPreview := True;
              ACBrNFeDANFCEFR1.MostraStatus := True;
              ACBrNFeNFCe.NotasFiscais.Imprimir;
            end
            else
            begin
              ACBrNFeDANFCEFR1.MostraPreview := False;
              ACBrNFeDANFCEFR1.MostraStatus := False;
              ACBrNFeNFCe.NotasFiscais.Imprimir;
            end;
          end;

        end;

      end;
    end;

    ACBrNFeDANFCEFR1.PathPDF := vpPastaPrincipal + 'pdfs\';
    ACBrNFeNFCe.NotasFiscais.ImprimirPDF;
    ACBrNFeNFCe.NotasFiscais.Clear;

    Result := True;

    if cfgcfgviaassinar.AsInteger = 0 then
      Exit;

    (* Identifica se houve parte de pagamento a prazo *)
    consulta.Close;
    consulta.SQL.Clear;
    consulta.SQL.Add('SELECT rfm.meschave FROM rfm, mfi, mlt, dtl ');
    consulta.SQL.Add(' WHERE mfi.rfichave  = rfm.rfichave ');
    consulta.SQL.Add('   AND mfi.mfichave  = mlt.mfichave ');
    consulta.SQL.Add('   AND mlt.ltechave  = dtl.ltechave ');
    consulta.SQL.Add('   AND dtl.mdacodigo = 7 ');
    consulta.SQL.Add('   AND rfm.meschave  = ' + vMesChave);
    consulta.Open;

    if not consulta.IsEmpty then
    begin
      if vVisualizar then
      begin
        ImprimirComprovantesPDV(application, zcone, vMesChave, ExtractFilePath(application.ExeName) + 'Report\viaassinar.fr3', trmtciporta.AsString,
          tiImprimir);
      end
      else
      begin
        ImprimirComprovantesPDV(application, zcone, vMesChave, ExtractFilePath(application.ExeName) + 'Report\viaassinar.fr3', trmtciporta.AsString,
          tiImprimirDireto);
      end;
    end;
  End;
end;

function Tfnfce.EmailNFCe(vMesChave: string; vFlaCodigo: string = '1'; vVisualizar: Boolean = False; vemails: string = ''): Boolean;
var
  vlArqCompro: string;
  xml, pdf: string;
begin
  Result := False;

  mes.Close;
  mes.Params[0].AsString := vMesChave;
  mes.Params[1].AsString := vFlaCodigo;
  mes.Open;

  AjustaCaminhoGeralNF(Self.mesmesregistro.AsFloat);
  vpNomeArquivoNFCe := Self.GeraNomeArqNFCe(vMesChave, vFlaCodigo);

  if vpNomeArquivoNFCe = '' then
    Exit;

  If FileExists(ExtractFilePath(application.ExeName) + 'report\DANFeNFCe.fr3') Then
  Begin
    qDtl.Close;
    qDtl.SQL.Clear;
    qDtl.SQL.Add('SELECT lte.ltetroco ');
    qDtl.SQL.Add('  FROM rfm ');
    qDtl.SQL.Add(' INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
    qDtl.SQL.Add(' INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
    qDtl.SQL.Add(' INNER JOIN lte ON mlt.ltechave = lte.ltechave ');
    qDtl.SQL.Add(' WHERE rfm.meschave = ' + vMesChave);
    qDtl.Open;

    (* Troco *)
    { if not qDtl.IsEmpty then
      ACBrNFeDANFEFR.vTroco := qDtl.Fields[0].AsFloat; }

    (* Operador *)
    ACBrNFeDANFCEFR1.Usuario := mesclbidentificacao.AsString;

    if Length(trmtciporta.AsAnsiString) > 0 then
    begin
      Panel1.Caption := 'Prepagando email em ' + Self.trmtciporta.AsAnsiString + ', aguarde ...';
      application.ProcessMessages;
      ACBrNFeDANFCEFR1.Impressora := Self.trmtciporta.AsAnsiString;
    end;

    ACBrNFeDANFCEFR1.FastFile := ExtractFilePath(application.ExeName) + 'report\DANFeNFCe.fr3';

    If FileExists(ExtractFilePath(application.ExeName) + 'logonfce.jpg') Then
      ACBrNFeDANFCEFR1.Logo := ExtractFilePath(application.ExeName) + 'logonfce.jpg';

    ACBrNFeNFCe.NotasFiscais.Clear;
    ACBrNFeNFCe.NotasFiscais.LoadFromFile(vpNomeArquivoNFCe);

    xml := vpNomeArquivoNFCe;
    ACBrNFeDANFCEFR1.MostraPreview := False;
    ACBrNFeDANFCEFR1.MostraStatus := False;

    // ACBrNFeNFCe.NotasFiscais.Imprimir;

    ACBrNFeDANFCEFR1.PathPDF := vpPastaPrincipal + 'pdfs\';
    ACBrNFeNFCe.NotasFiscais.ImprimirPDF;
    pdf := ChangeFileExt(vpPastaPrincipal + 'pdfs\' + extractfilename(xml), '.pdf');

    ACBrNFeNFCe.NotasFiscais.Clear;

    EnviarEmail(vemails, '', 'NFCE emitida, enviada conforme sua solicitação', 'Segue Nota fiscal ao Consumidor solicitada.', xml, pdf, 'CONSUMIDOR',
      cfgetdapelido.AsString);

    Result := True;

  End;
end;

Function Tfnfce.EnviarEmail(destino, copias, texto, assunto, xml, pdf, nome_cliente, nome_empresa: String): Boolean;
Var
  Attachmentxml: TIdAttachment;
  Attachmentpdf: TIdAttachment;
  vEnviado: Boolean;
  vlMensagemErro, vlDiretorioErro: String;
  vlResponder: TIdEmailAddressList;

Begin

  vEnviado := False;
  Result := vEnviado;

  if trim(cfgcfgemailnfe.AsString) = '' then
  begin
    application.MessageBox(PChar('Email do emitente não cadastrado.' + #13 + #13 +
      'Entre em contato com suporte da Pégasus Sistemas - (66) 3544-2765.'), 'ATENÇÃO', MB_OK + MB_ICONWARNING);
    Exit;
  end;

  if (trim(destino) = '') then
  begin
    destino := cfgctdboxedominio.AsString;
  end
  else
  begin
    if cfgctdboxedominio.AsString <> '' then
    begin
      copias := copias + ' ' + cfgctdboxedominio.AsString;
      copias := trim(copias);
      copias := StringReplace(copias, ' ', ';', [rfReplaceAll, rfIgnoreCase]);
    end;
  end;

  if (trim(destino) = '') and (trim(copias) = '') then
  begin
    application.MessageBox(PChar('Nenhum email cadastrado para envio.' + #13 + #13 + 'Verifique no cadastro da entidade!!'), 'ATENÇÃO',
      MB_OK + MB_ICONWARNING);
    Exit;
  end;

  Inicializar;
  Try

    IdMessage1.Clear;
    IdMessage1.Body.Clear;
    IdMessage1.Body.Text := texto + #13 + #13;
    IdMessage1.Subject := assunto; // Assunto
    IdMessage1.From.Text := LowerCase(cfgcfgemailnfe.AsString); // Email de envio da mensagem
    IdMessage1.From.Name := nome_empresa; // Nome para apresentação
    IdMessage1.CCList.EMailAddresses := copias; // Com cópia
    IdMessage1.BccList.EMailAddresses := '';
    IdMessage1.Recipients.EMailAddresses := destino; // email destino
    IdMessage1.ReceiptRecipient.Text := IdMessage1.From.Text;

    vlResponder := TIdEmailAddressList.Create(Self);
    vlResponder.EMailAddresses := cfgeteemail.AsString;
    IdMessage1.InReplyTo := cfgeteemail.AsString;
    IdMessage1.ReplyTo := vlResponder;

    if FileExists(xml) then
      Attachmentxml := TIdAttachmentFile.Create(IdMessage1.MessageParts, xml);

    if FileExists(pdf) then
      Attachmentpdf := TIdAttachmentFile.Create(IdMessage1.MessageParts, pdf);

    // Conectando e enviando
    Try
      SMTP.Connect; // Inicia conexão

      If SMTP.Connected Then
      Begin

        SMTP.Send(IdMessage1); // Se conectado envia email

        vEnviado := True;
        SMTP.Disconnect; // Desconecta

        Attachmentxml.Free;
        Attachmentpdf.Free;
      End;
    Except
      On e: Exception Do // Definição da variável e do tipo Exception
      Begin
        vEnviado := False;

        vlMensagemErro := 'Não foi possível enviar o email.' + #13 + #13 + 'Mensagem: ' + #13 + e.Message;
        application.MessageBox(PChar(vlMensagemErro), 'Erro Envio de Email', MB_OK + MB_ICONERROR);

        SalvarLogErro(e.Message, e.StackTrace);

        SMTP.Disconnect;
        Sleep(1000);

        If SMTP.Connected Then
          SMTP.Disconnect;
      End;
    End;
  Finally

  End;

  Result := vEnviado;
End;

procedure Tfnfce.Inicializar;
begin

  cfg.Close;
  cfg.ParamByName('flacodigo').AsString := Acesso.Filial.ToString;
  cfg.Open;

  // Define configurações do servidor para envio de email.
  with SMTP do
  begin
    IOHandler := IO_OpenSSL;
    Host := LowerCase(cfgcfgemailservidornfe.AsString); // 'smtp.live.com'; // 'smtp.gmail.com';
    Username := LowerCase(cfgcfgemailnfe.AsString); // 'email@hotmail.com'; // 'email@gmail.com';
    Password := trim(cfgcfgemailsenhanfe.AsString); // 'senha';
    Port := cfgcfgmailportnfe.AsInteger; // 587; // 465;
    case cfgcfgemailusatls.AsInteger of
      0:
        UseTLS := UtNoTLSSupport;
      1:
        UseTLS := UtUseExplicitTLS;
      2:
        UseTLS := UtUseImplicitTLS;
      3:
        UseTLS := UtUseRequireTLS;
    end;
    AuthType := SatDefault;
    ConnectTimeout := 30000;
    ReadTimeout := 30000;
  end;

  with IO_OpenSSL do
  begin
    SSLOptions.Method := sslvSSLv23;
    SSLOptions.Mode := sslmClient;
  end;

end;

function Tfnfce.GeraNFCe(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
Var
  vErro: String;
  vMensagemErro: String;

  vMsgRetorno: String;

  vNumeroNFe: Integer;
  vChaveNFE: String;
  vProtocoloNFe: String;

  (* Acumuladores - Totais NFCe *)
  vlQtdItens: Integer;

  vlTotBC: Double;
  vlTotICMS: Double;

  vlTotDesc: Double;
  vlTotBruto: Double;
  vlTotLiq: Double;

  (* Carga Tributária *)
  vlTotTrib: Double;
  vlTotTribEst: Double;
  vlMensagemCargaTrib: string;

  (* Retornos da SEFAZ *)
  vCStat: Integer;
  vXMotivo: String;

  vDinheiro: Double;
  vChequeProprio: Double;
  vChequeTerceiros: Double;
  vCartaoDebito: Double;
  vCartaoCredito: Double;
  vPIX: Double;
  vConvenio: Double;
  vAFaturar: Double;
  vlTroco: Double;
  vTrocaDevolucao: Double;
  vVale: Double;
  vDoacao: Double;
  vCredito: Double;

  vlTotalItens: Double;
  vlTotalFinalizadores: Double;
  vlPercentualProdutos: Double;
  vlValorDiferenca: Double;

  (* CST e CSOSN *)
  vlCSTIcmsOK: Boolean;
  vlCSTIcms: TpcnCSTIcms;

  vlCSOSNIcmsOK: Boolean;
  vlCSOSNIcms: TpcnCSOSNIcms;
  ok: Boolean;

  { * exibe limite do cliente * }
  vlMensagemLimite: string;
  vlDatatual: string;

  vlcspcodigo: string;
  vlcsfcodigo: string;

  vlcfgpercentualpis: string;

  vlcfgpercentualcofins: string;
  vlNFCeProtocolo: string;
  vlNFCeChave: string;

  vlrefeicao: string;
  vlOutras: Currency;

  vlAgora: String;

  vlMensagemReducaoBase: STRING;
  vlReducoes: TStringList;
  iReduz: Integer;

  vlTotatFrete: Currency;
  vlMensagemicmreducao: string;

Begin
  info.Lines.Add('Inicio abertura tabelas: ' + datetimetostr(now));

  Result := False;

  vlQtdItens := 0;

  vlTotBC := 0;
  vlTotICMS := 0;

  vlTotDesc := 0;
  vlTotBruto := 0;
  vlTotLiq := 0;

  vlTotTrib := 0;
  vlTotTribEst := 0;
  vlMensagemCargaTrib := '';
  vlNFCeProtocolo := '';
  vlNFCeChave := '';



  //
  // ****** Carrega consulta da tabela mes e itm ********
  //

  cfg.Close;
  cfg.ParamByName('flacodigo').AsInteger := Acesso.Filial;
  cfg.Open;

  itm.Close;
  itm.Params[0].AsString := vMesChave;
  itm.Params[1].AsString := vFlaCodigo;
  itm.Open;

  vlReducoes := TStringList.Create;

  itm.First;
  while not itm.Eof do
  begin
    consulta.Close;
    consulta.SQL.Text := 'select propercreducaobaseicm from pro where propercreducaobaseicm>0 and procodigo=' + itmprocodigo.AsString;
    consulta.Open;
    if not consulta.IsEmpty then
    begin
      vlReducoes.Add(floattostr(100 - consulta.FieldByName('propercreducaobaseicm').AsFloat) + '%');
    end;

    itm.Next;
  end;

  itm.First;

  etd.Close;
  etd.ParamByName('etdcodigo').AsInteger := mesetdcodigo.AsInteger;
  etd.ParamByName('edritem').AsInteger := mesedritem.AsInteger;
  etd.Open;

  mic.Close;
  mic.Params[0].AsString := vMesChave;
  mic.Open;

  oic.Close;
  oic.Params[0].AsString := vMesChave;
  oic.Open;

  if mes.Active then
  begin
    if mestoecodigo.AsString <> '' then
    begin
      toe.Close;
      toe.SQL.Text := 'select ttecodigo,toeidentificacao,toecodigo,ttocodigo from toe where toecodigo=' + mestoecodigo.AsString;
      toe.Open;
    end;
  end;

  vlAgora := agora(application, zcone);

  info.Lines.Add('Tabelas abertas: ' + vlAgora);

  //
  // ***** Inicia GERAÇÃO da NFe *****
  //

  vlNFCeProtocolo := mesmesprotocolo.AsString;
  vlNFCeChave := mesmeschavenfe.AsString;

  ACBrNFeNFCe.NotasFiscais.Clear;
  ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;
  // Try

  With ACBrNFeNFCe.NotasFiscais.Add.NFe Do
  Begin
    Ide.indIntermed := iiSemOperacao;
    infRespTec.CNPJ := '14477548000131';
    infRespTec.email := 'mizio@miziosistemas.com.br';
    infRespTec.xContato := 'Mizio Sistemas';
    infRespTec.fone := '6635442765';

    (* !
      *
      ********* Identificação da NFe - IDE ********
      *
    *)
    if cfgcfgmodonfe.AsInteger <> 1 then
    begin
      Ide.indIntermed := iiOperacaoSemIntermediador;
    end;

    Ide.cUF := cfgufscodigo.AsInteger;

    Ide.natOp := 'VENDA';

    Ide.hSaiEnt := vpDataAtual;

    infNFe.Versao := cfgcfgversao.AsFloat;

    if not vpWSNormal then
    begin

      Ide.hSaiEnt := strtodatetime(vlAgora);
      Ide.dEmi := strtodatetime(vlAgora);
      Ide.dSaiEnt := strtodatetime(vlAgora);
      Ide.hSaiEnt := strtodatetime(vlAgora);

      mes.Edit;
      mesmesregistro.AsString := trim(Copy(vlAgora, 1, 10));
      mesmeshoranfe.AsString := trim(Copy(vlAgora, 11, 8));
      mes.post;

    end
    else
    begin

      if (Copy(vlNFCeProtocolo, 1, 15) <> '000000000000000') and (vlNFCeProtocolo <> '') then
      begin
        Ide.hSaiEnt := mesmesdatanfe.AsDateTime;
        Ide.dEmi := mesmesdatanfe.AsDateTime;
        Ide.dSaiEnt := mesmesdatanfe.AsDateTime;
        Ide.hSaiEnt := mesmesdatanfe.AsDateTime;

      end
      else
      begin

        Ide.dEmi := vpDataAtual;
        Ide.dSaiEnt := vpDataAtual;
        Ide.hSaiEnt := vpDataAtual;

      end;
    end;

    vlDatatual := datetimetostr(vpDataAtual);

    Ide.indPag := ipVista;
    Ide.cUF := UFtoCUF(cfgufssigla.AsString);
    Ide.cMunFG := cfgcddcodigo.AsInteger;

    Ide.idDest := doInterna;

    Ide.finNFe := fnNormal;
    Ide.tpImp := tiNFCe;
    Ide.indFinal := cfConsumidorFinal;

    Ide.indPres := pcPresencial;
    Ide.modelo := 65;
    Ide.serie := cfgcfgserienfce.AsInteger;
    Ide.tpNF := tnSaida;

    if vpWSNormal then
    begin
      ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teNormal;
      Ide.tpEmis := teNormal;
    end
    else
    begin
      if rec.Active = False then
      begin
        rec.Open;
      end;

      ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teOffLine;
      Ide.tpEmis := teOffLine;
      Ide.dhCont := mesmesemissao.AsDateTime; // recrecdthoraentrada.AsFloat;
      Ide.xJust := 'Falha de comunicação com servidores da SEFAZ.';

    end;

    Ide.cMunFG := cfgcddcodigo.AsInteger;

    if cfgcfgmodonfe.AsInteger = 2 then
      Ide.tpAmb := taHomologacao;

    if cfgcfgmodonfe.AsInteger = 1 then
      Ide.tpAmb := taProducao;

    Ide.verProc := '21.25.300.1';

    ctd.Close;
    ctd.Connection := zcone;
    ctd.Open;

    if not ctd.IsEmpty then
    begin
      if (ctdctdcnpj.AsString <> '') and (ctdctdcnpj.AsString <> '0') then
      begin
        try
          if strtofloat(SoNumeros(ctdctdcnpj.AsString)) > 0 then
          begin
            autXML.Add.CNPJCPF := SoNumeros(ctdctdcnpj.AsString);
          end;
        except

        end;
      end;
    end;

    (*
      *
      ****** Emitente da NFC-e - EMIT ********
      *
    *)

    Emit.CNPJCPF := SomenteNumeros(cfgetddoc1.AsString);
    Emit.IE := SomenteNumeros(cfgedrinscest.AsString);
    Emit.IEST := '';
    Emit.xNome := cfgetdidentificacao.AsString;
    Emit.xFant := cfgetdapelido.AsString;
    Emit.EnderEmit.fone := cfgetftelefone.AsString;
    Emit.EnderEmit.CEP := StrToInt(SomenteNumeros(cfgedrcep.AsString));
    Emit.EnderEmit.xLgr := cfgedrrua.AsString;
    Emit.EnderEmit.nro := cfgedrnumero.AsString;
    Emit.EnderEmit.xCpl := '';
    Emit.EnderEmit.xBairro := cfgedrbairro.AsString;
    Emit.EnderEmit.cMun := cfgcddcodigo.AsInteger;
    Emit.EnderEmit.xMun := cfgcddnome.AsString;
    Emit.EnderEmit.UF := UpperCase(cfgufssigla.AsString);
    Emit.EnderEmit.cPais := 1058;
    Emit.EnderEmit.xPais := 'BRASIL';

    case cfgcrtcodigo.AsInteger of
      1:
        Emit.CRT := crtSimplesNacional;
      2:
        Emit.CRT := crtSimplesExcessoReceita;
      3:
        Emit.CRT := crtRegimeNormal;
    end;

    (*
      *
      ********* Destinatário da NFe **********
      *
    *)

    if (trim(LowerCase(etdetdidentificacao.AsString)) <> 'consumidor') and (ValidaConsumidor(vMesChave, vFlaCodigo)) then
    begin
      Dest.indIEDest := inNaoContribuinte;
      Dest.CNPJCPF := SomenteNumeros(Self.etdetddoc1.AsString);
      Dest.xNome := etdetdidentificacao.AsString;
      Dest.EnderDest.UF := etdufssigla.AsString;

    end
    else
    begin
      if mic.RecordCount = 1 then
      begin
        Dest.indIEDest := inNaoContribuinte;
        Dest.CNPJCPF := SomenteNumeros(Self.micidcdoc.AsString);
        Dest.xNome := micidcnome.AsString;
        Dest.EnderDest.UF := Emit.EnderEmit.UF;
      end
      else if oic.RecordCount = 1 then
      begin
        Dest.indIEDest := inNaoContribuinte;
        Dest.CNPJCPF := SomenteNumeros(Self.oicidcdoc.AsString);
        Dest.xNome := oicidcnome.AsString;
        Dest.EnderDest.UF := Emit.EnderEmit.UF;
      end;
    end;

    (*
      *
      ********* Detalhamento de Produtos e Serviços - DET ***********
      *
    *)

    itm.Refresh;
    itm.IndexFieldNames := 'itmchave';
    itm.First;
    vlQtdItens := 1;

    { toe.Close;
      toe.Connection := zcone;
      toe.SQL.Text := 'select toecodigo,ttecodigo,toeidentificacao,ttocodigo from toe where toecodigo=' + mestoecodigo.AsString;
      toe.Open;
    }

    VerifieAjustaICM;

    if UpperCase(cfgufssigla.AsString) <> UpperCase(etdufssigla.AsString) then
    begin

      if (Ide.indPres = pcPresencial) then
      begin
        if Ide.indFinal = cfConsumidorFinal then
        begin
          VerifieAjustaItemcomConsumidorFinal;
        end;
      end;
    end;

    VerifieAjustaItemcomSubstituicao(Emit.EnderEmit.UF, Dest.EnderDest.UF);

    VerifieAjustaItemMonofasico;

    itm.Close;
    itm.Params[0].AsString := vpMesChave;
    itm.Params[1].AsInteger := Acesso.Filial;
    itm.Open;

    itm.First;
    While Not itm.Eof Do
    Begin

      if (cfgcfgusacstnoproduto.AsInteger = 0) and (cfgcfgdefinetoeatendimento.AsInteger = 0) then
      begin

        toeitm.Close;
        toeitm.Connection := zcone;
        toeitm.ParamByName('toecodigo').AsInteger := itmtoecodigo.AsInteger;
        toeitm.Open;

        itmcst.Close;
        itmcst.Connection := zcone;
        itmcst.ParamByName('itmchave').AsInteger := itmitmchave.AsInteger;
        itmcst.Open;
        if itmtcecest.AsString <> '' then
        begin

          itmcst.Edit;

          itmcstcstcodigo.AsString := toeitmcstcodigo.AsString;
          itmcstcsicodigo.AsString := toeitmcsicodigo.AsString;

          consulta.Close;
          consulta.SQL.Text := 'select padcodigo from pro where procodigo=' + itmprocodigo.AsString;
          consulta.Open;
          if not consulta.IsEmpty then
          begin

            if consulta.FieldByName('padcodigo').AsString <> '' then
            begin
              pad.Close;
              pad.Connection := zcone;
              pad.ParamByName('padcodigo').AsString := consulta.FieldByName('padcodigo').AsString;
              pad.Open;

              if not pad.IsEmpty then
              begin

                if (padpadpis.AsString <> '') and (padpadcofins.AsString <> '') then
                begin

                  vlcspcodigo := padpadcodigopiscofins.AsString;
                  vlcsfcodigo := padpadcodigopiscofins.AsString;

                  vlcfgpercentualpis := padpadpis.AsString;
                  vlcfgpercentualpis := StringReplace(vlcfgpercentualpis, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                  vlcfgpercentualcofins := padpadcofins.AsString;
                  vlcfgpercentualcofins := StringReplace(vlcfgpercentualcofins, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                  itmncm.Close;

                  itmncm.SQL.Text := 'update itm set csfcodigo=' + QuotedStr(vlcsfcodigo) + '   ,cspcodigo=' + QuotedStr(vlcspcodigo) +
                    '    ,itmaliqcofins=' + vlcfgpercentualcofins + ' ,itmaliqpis=' + vlcfgpercentualpis + ' where itmchave=' + itmitmchave.AsString;
                  itmncm.ExecSQL;

                end;

              end;
            end;

          end
          else
          begin

            itmcstcspcodigo.AsString := toeitmcspcodigo.AsString;
            itmcstcsfcodigo.AsString := toeitmcsfcodigo.AsString;
            itmcstitmaliqpis.AsFloat := toeitmcfgpercentualpis.AsFloat;
            itmcstitmaliqcofins.AsFloat := toeitmcfgpercentualcofins.AsFloat;

          end;

          itmcst.post;
        end;

      end
      else
      begin

        toeitm.Close;
        toeitm.Connection := zcone;
        toeitm.ParamByName('toecodigo').AsInteger := itmtoecodigo.AsInteger;
        toeitm.Open;

      end;
      itm.Next;
    End;

    itm.Close;
    itm.Params[0].AsString := vpMesChave;
    itm.Params[1].AsInteger := Acesso.Filial;
    itm.Open;

    if ((mesmesprodutos.AsCurrency - mesmestotal.AsCurrency) <> 0) and (mesmesprodutos.AsCurrency <> 0) then
    begin
      vlOutras := 0;

      itm.First;
      While Not itm.Eof Do
      Begin

        vlOutras := vlOutras + itmitmoutras.AsCurrency;
        itm.Next;
      End;

    end;

    vlTotatFrete := 0;
    itm.First;
    While Not itm.Eof Do
    Begin

      With Det.Add Do
      Begin

        infAdProd := ''; // 'Teste de informacao adicional;Teste de Segunda Linha';
        Prod.nItem := vlQtdItens;
        Prod.ncm := SomenteNumeros(itmproncm.AsString);

        Prod.CFOP := trim(Copy(itmcfocfop.AsString, 1, 1) + Copy(itmcfocfop.AsString, 2, 4));

        Prod.cProd := Self.itmprocodigo.AsString;

        ACBrValidadorBarra.TipoDocto := docGTIN;
        ACBrValidadorBarra.Documento := Copy(itmpunbarra.AsString, 2, 13);
        if ACBrValidadorBarra.Validar then
        begin
          if itmpunbarrasistema.AsInteger = 1 then
          begin
            Prod.cEAN := 'SEM GTIN';
            Prod.cEANTrib := 'SEM GTIN';
          end
          else
          begin
            Prod.cEAN := Copy(itmpunbarra.AsString, 2, 13);
            Prod.cEANTrib := Copy(itmpunbarra.AsString, 2, 13);

          end;
        end
        else
        begin
          Prod.cEAN := 'SEM GTIN';
          Prod.cEANTrib := 'SEM GTIN';
        end;

        If cfgcfgdescrinfe.AsInteger = 0 Then
          Prod.xProd := BuscaTroca(trim(itmpronome.AsString), '%', '') + ' ' + Self.itmpunidentificacao.AsString;

        If cfgcfgdescrinfe.AsInteger = 1 Then
          Prod.xProd := BuscaTroca(trim(itmpronomereduzido.AsString), '%', '') + ' ' + Self.itmpunidentificacao.AsString;

        If (Copy(Prod.xProd, 1, 1) = '.') Then
          Prod.xProd := trim(Copy(Prod.xProd, 2, 300));

        Prod.qCom := Self.itmitmquantidade.AsFloat;
        Prod.uCom := Self.itmunisimbolo.AsString;
        Prod.vProd := Self.itmitmtotal.AsFloat;
        // Prod.vProd := Self.itmitmtotal.AsFloat - itmitmoutras.AsCurrency;

        Prod.vOutro := itmitmoutras.AsCurrency;

        Prod.qTrib := Self.itmitmquantidade.AsFloat;
        Prod.vDesc := Self.itmitmdesconto.AsFloat;

        // Prod.vFrete := Self.itmitmfrete.AsCurrency;
        if cfgcfgusapdv.AsInteger = 1 then
        begin
          Prod.vOutro := Self.itmitmoutras.AsCurrency;
          vlTotatFrete := vlTotatFrete + Self.itmitmoutras.AsCurrency;
        end
        else
        begin
          vlTotatFrete := 0;
        end;

        Prod.uTrib := Self.itmunisimbolo.AsString;
        // Prod.vUnTrib := (Self.itmitmtotal.AsFloat - itmitmoutras.AsCurrency) / Self.itmitmquantidade.AsFloat;
        Prod.vUnTrib := (Self.itmitmtotal.AsFloat) / Self.itmitmquantidade.AsFloat;

        Prod.vUnCom := Prod.vUnTrib;

        vlTotDesc := vlTotDesc + Prod.vDesc;
        vlTotBruto := vlTotBruto + (Prod.vProd);
        vlTotLiq := vlTotLiq + (vlTotBruto - vlTotDesc);

        if itmtpocodigo.AsInteger = 99 then
          Prod.CEST := '01.999.00';

        Prod.CEST := itmtcecest.AsString;

        With Imposto Do
        Begin

          Imposto.vTotTrib := { itmitmcargatrib.AsFloat + } itmitmcargatribest.AsFloat;

          (* Acumula totais de carga tributária por ente Federal e Estadual *)
          vlTotTrib := vlTotTrib { + itmitmcargatrib.AsFloat };
          vlTotTribEst := vlTotTribEst + itmitmcargatribest.AsFloat;

          With ICMS Do
          Begin
            case Emit.CRT of
              crtSimplesNacional:
                vlCSOSNIcms := StrToCSOSNIcms(vlCSOSNIcmsOK, itmcstcodigo.AsString);
              crtRegimeNormal, crtSimplesExcessoReceita:
                vlCSTIcms := StrToCSTICMS(vlCSTIcmsOK, Copy(Self.itmcstcodigo.AsString, 2, 2));
            end;

            (* CST *)
            if vlCSTIcmsOK then
              CST := vlCSTIcms;

            (* CSOSN *)
            if vlCSOSNIcmsOK then
              CSOSN := vlCSOSNIcms;

            ICMS.modBC := dbiValorOperacao;
            // dbiPrecoTabelado;
            If (LowerCase(Self.itmicmcodigo.AsString) = 'ff') Or (LowerCase(Self.itmicmcodigo.AsString) = 'ii') Or
              (LowerCase(Self.itmicmcodigo.AsString) = 'nn') Then
            Begin
              ICMS.pICMS := 0;
              ICMS.vICMS := 0;
              ICMS.vBC := 0;
            End
            Else
            Begin
              If (Self.itmitmicm.AsFloat = 0.01) or (Self.itmitmicm.AsFloat = 0) Then
              Begin
                ICMS.pICMS := 0;
                ICMS.vICMS := 0;
                ICMS.vBC := 0;
              End
              Else
              Begin
                ICMS.pICMS := Self.itmicmaliquota.AsFloat;
                ICMS.vICMS := itmitmicm.AsFloat;
                ICMS.vBC := itmitmbicm.AsCurrency;
                ICMS.pRedBC := itmitmpercreducaobaseicm.AsCurrency;

                if (itmitmbicms.AsFloat > 0) and (itmitmaliqicms.AsFloat > 0) then
                begin
                  ICMS.modBCST := dbisMargemValorAgregado;
                  ICMS.pMVAST := itmitmmva.AsFloat;
                  ICMS.vBCST := itmitmbicms.AsFloat;
                  ICMS.pICMSST := itmitmaliqicms.AsFloat;
                  ICMS.vICMSST := itmitmicms.AsFloat;

                end;

              End;
            End;

            vlTotICMS := vlTotICMS + ICMS.vICMS;
            vlTotBC := vlTotBC + ICMS.vBC;
          End;

          pis.CST := StrToCSTPIS(ok, itmcspcodigo.AsString);
          if itmitmaliqpis.AsFloat > 0 then
          begin
            pis.vBC := itmitmbpis.AsCurrency;
            pis.pPIS := itmitmaliqpis.AsFloat;
            pis.vPIS := itmitmpis.AsCurrency;
          end;

          COFINS.CST := StrToCSTCOFINS(ok, itmcsfcodigo.AsString);

          if itmitmaliqcofins.AsFloat > 0 then
          begin
            COFINS.vBC := itmitmbcofins.AsCurrency;
            COFINS.pCOFINS := itmitmaliqcofins.AsFloat;
            COFINS.vCOFINS := itmitmcofins.AsCurrency;
          end;

        End;
        vlQtdItens := vlQtdItens + 1;

      End;

      itm.Next;
    End;

    (*
      *
      ******** Informações do Transporte da NF-e - TRANSP ********
      *
    *)

    Transp.modFrete := mfSemFrete;

    (*
      *
      ******* Totais da NFe *******
      *
    *)

    (* Trata mensagem referente Carga Tributária *)
    if (vlTotTrib + vlTotTribEst) > 0 then
    begin
      vlMensagemCargaTrib := 'Trib. aprox. R$ ';
      vlMensagemCargaTrib := vlMensagemCargaTrib + FormatFloat('#,###.00', RoundTo(vlTotTrib, -2)) + ' Federal';

      if vlTotTribEst > 0 then
        vlMensagemCargaTrib := vlMensagemCargaTrib + ' e ' + FormatFloat('#,###.00', RoundTo(vlTotTribEst, -2)) + ' Estadual';

      vlMensagemCargaTrib := vlMensagemCargaTrib + ';Fonte: IBPT 5oi7eW (Lei Federal 12.741/2012)';

    end;
    vlMensagemCargaTrib := '';

    { * Exibe situação de credito do cliente * }
    vlMensagemLimite := '';

    limite.Close;
    limite.ParamByName('etdcodigo').AsInteger := mesetdcodigo.AsInteger;
    limite.Open;

    if not limite.IsEmpty then
    begin
      disponivel.Close;
      disponivel.ParamByName('etdcodigo').AsInteger := mesetdcodigo.AsInteger;
      disponivel.Open;

      if (mesetdcodigo.AsInteger <> 0) and (limiteetllimitetotal.AsCurrency > 0) then
      begin
        vlMensagemLimite := { 'Limite R$ ' + FormatFloat('#,###.00', RoundTo(limiteetllimitetotal.Ascurrency, -2)) + #13 + } 'Limite Disponível R$ ' +
          FormatFloat('#,###.00', RoundTo(limiteetllimitetotal.AsCurrency - (disponivelrfisaldocapital.AsCurrency - mesmestotal.AsCurrency), -2));
      end;

    end;

    qTomTof.Close;
    qTomTof.Connection := zcone;
    qTomTof.SQL.Text := 'SELECT distinct tofidentificacao FROM tom, tof WHERE ';
    qTomTof.SQL.Add('tom.tofcodigo = tof.tofcodigo AND ');
    qTomTof.SQL.Add('tof.ticcodigo IN (' + IntToStr(ticObservacao) + ') AND ');
    qTomTof.SQL.Add('tom.meschave = ' + vpMesChave + ' ');
    qTomTof.SQL.Add('ORDER BY tof.tofcodigo');
    qTomTof.Open;

    if qTomTof.IsEmpty then
    begin

      if cfgcfgobs1.AsString <> '' then
      begin
        tom.Connection := zcone;
        tom.Open;
        tom.Append;
        tomtofcodigo.AsInteger := cfgcfgobs1.AsInteger;
        tommeschave.AsString := vpMesChave;
        tom.post;
      end;

      qTomTof.Close;
      qTomTof.Connection := zcone;
      qTomTof.SQL.Text := 'SELECT distinct tofidentificacao FROM tom, tof WHERE ';
      qTomTof.SQL.Add('tom.tofcodigo = tof.tofcodigo AND ');
      qTomTof.SQL.Add('tof.ticcodigo IN (' + IntToStr(ticObservacao) + ') AND ');
      qTomTof.SQL.Add('tom.meschave = ' + vpMesChave + ' ');
      qTomTof.SQL.Add('ORDER BY tof.tofcodigo');
      qTomTof.Open;

    end;

    { if (cfgcfgobs2.AsString <> '0') or (cfgcfgobs3.AsString <> '0') or (cfgcfgobs4.AsString <> '0') then
      begin }

    vlMensagemReducaoBase := '';

    While Not qTomTof.Eof Do
    Begin
      if pos(trim(qTomTof.Fields[0].AsString), vlMensagemCargaTrib) = 0 then
      begin
        vlMensagemCargaTrib := vlMensagemCargaTrib + trim(qTomTof.Fields[0].AsString) + ';';

      end;
      qTomTof.Next;
    End;

    InfAdic.infCpl := trim(vlMensagemCargaTrib + #13 + ' ' + cfgcfgmensagempdv.AsString + #13 + #13 + mesmesobs.AsString + #13 + #13 +
      vlMensagemLimite + #13 + vlMensagemReducaoBase);

    (*
      *
      ******* Totais da NFe *******
      *
    *)

    Ide.indPres := pcPresencial;

    Total.ICMSTot.vTotTrib := RoundTo(vlTotTrib + vlTotTribEst, -2);

    if cfgcfgusapdv.AsInteger = 1 then
    begin
      Total.ICMSTot.vOutro := vlTotatFrete;
    end
    else
    begin
      Total.ICMSTot.vFrete := 0;
    end;

    Total.ICMSTot.vBC := vlTotBC;

    Total.ICMSTot.vICMS := RoundTo(vlTotICMS, -2);
    Total.ICMSTot.vProd := RoundTo(vlTotBruto, -2);
    Total.ICMSTot.vDesc := RoundTo(vlTotDesc, -2);

    Total.ICMSTot.vNF := RoundTo((vlTotBruto - vlTotDesc + vlTotatFrete), -2);

    Total.ICMSTot.vPIS := mesmespis.AsCurrency;
    Total.ICMSTot.vCOFINS := mesmescofins.AsCurrency;

    if mesmesrefeicao.AsInteger = 1 then
    begin

      consulta.Close;
      consulta.SQL.Text := 'select meschave, etdcodigo, mestotal from mes where ' + IntToStr(Self.mesmeschave.AsInteger - 1);
      consulta.Open;

      vlrefeicao := consulta.FieldByName('etdcodigo').AsString + '-' + consulta.FieldByName('mestotal').AsString;

      consulta.Close;
      consulta.SQL.Text := 'select meschave, etdcodigo, mestotal from mes where ' + IntToStr(Self.mesmeschave.AsInteger);
      consulta.Open;

      if vlrefeicao = consulta.FieldByName('etdcodigo').AsString + '-' + consulta.FieldByName('mestotal').AsString then
      begin

        qDtl.Close;
        qDtl.SQL.Text := 'SELECT distinct  dtl.dtlvalor,  rfm.meschave,   dtl.mdacodigo, dtl.cedcodigo FROM rfm ';
        qDtl.SQL.Add('INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
        qDtl.SQL.Add('INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
        qDtl.SQL.Add('INNER JOIN dtl ON mlt.ltechave = dtl.ltechave ');
        qDtl.SQL.Add('WHERE rfm.meschave=' + IntToStr(Self.mesmeschave.AsInteger - 1) + ' ');
        qDtl.SQL.Add('GROUP BY dtl.mdacodigo ');
        qDtl.SQL.Add('ORDER BY dtl.mdacodigo');
        qDtl.Open;

      end
      else
      begin
        qDtl.Close;
        qDtl.SQL.Text := 'SELECT distinct  dtl.dtlvalor,  rfm.meschave,   dtl.mdacodigo, dtl.cedcodigo FROM rfm ';
        qDtl.SQL.Add('INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
        qDtl.SQL.Add('INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
        qDtl.SQL.Add('INNER JOIN dtl ON mlt.ltechave = dtl.ltechave ');
        qDtl.SQL.Add('WHERE rfm.meschave=' + Self.mesmeschave.AsString + ' ');
        qDtl.SQL.Add('GROUP BY dtl.mdacodigo ');
        qDtl.SQL.Add('ORDER BY dtl.mdacodigo');
        qDtl.Open;
      end;

    end
    else
    begin

      qDtl.Close;
      qDtl.SQL.Text := 'SELECT distinct  dtl.dtlvalor,  rfm.meschave,   dtl.mdacodigo, dtl.cedcodigo FROM rfm ';
      qDtl.SQL.Add('INNER JOIN rfi ON rfm.rfichave = rfi.rfichave ');
      qDtl.SQL.Add('INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
      qDtl.SQL.Add('INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
      qDtl.SQL.Add('INNER JOIN dtl ON mlt.ltechave = dtl.ltechave ');
      qDtl.SQL.Add('WHERE rfm.meschave=' + Self.mesmeschave.AsString + ' ');
      qDtl.SQL.Add(' AND if(mdacodigo=4 or mdacodigo=5,tmfcodigo=21,  IF(mdacodigo=7,tmfcodigo=2,tmfcodigo=21)) ');
      qDtl.SQL.Add('GROUP BY dtl.mdacodigo ');
      qDtl.SQL.Add('ORDER BY dtl.mdacodigo');
      qDtl.Open;

    end;

    vDinheiro := 0;
    vChequeProprio := 0;
    vChequeTerceiros := 0;
    vCartaoDebito := 0;
    vCartaoCredito := 0;
    vPIX := 0;
    vConvenio := 0;
    vVale := 0;
    vDoacao := 0;
    vCredito := 0;
    vTrocaDevolucao := 0;

    vAFaturar := 0;

    vlTotalItens := 0;
    vlTotalFinalizadores := 0;
    vlPercentualProdutos := 0;

    vlTotalItens := RoundTo(vlTotBruto - vlTotDesc + vlTotatFrete, -2);

    while not qDtl.Eof do
    begin
      if not(qDtl.FieldByName('mdacodigo').AsInteger in [11, 22, 33]) then
        vlTotalFinalizadores := vlTotalFinalizadores + qDtl.FieldByName('dtlvalor').AsCurrency;

      qDtl.Next;
    end;

    vlPercentualProdutos := (mesmesprodutos.AsCurrency + mesmesoutras.AsCurrency) / mesmestotal.AsCurrency;

    qDtl.First;

    while not qDtl.Eof do
    begin
      case qDtl.FieldByName('mdacodigo').AsInteger of
        mdaDinheiro:
          vDinheiro := vDinheiro + qDtl.FieldByName('dtlvalor').AsCurrency;
        mdaTrocoDinheiro:
          begin
            // vDinheiro := vDinheiro - qDtl.FieldByName('dtlvalor').Ascurrency;
            vlTroco := vlTroco - qDtl.FieldByName('dtlvalor').AsCurrency;
          end;
        mdaChequeProprio:
          begin
            vChequeProprio := vChequeProprio + qDtl.FieldByName('dtlvalor').AsCurrency;
            vlTroco := vlTroco + qDtl.FieldByName('dtlvalor').AsCurrency;
          end;
        mdaTrocoChequeProprio:
          begin
            vChequeProprio := vChequeProprio - qDtl.FieldByName('dtlvalor').AsCurrency;
            vlTroco := vlTroco + qDtl.FieldByName('dtlvalor').AsCurrency;
          end;
        mdaChequeTerceiros:
          vChequeTerceiros := vChequeTerceiros + qDtl.FieldByName('dtlvalor').AsCurrency;
        mdaTrocoChequeTerceiros:
          vChequeTerceiros := vChequeTerceiros - qDtl.FieldByName('dtlvalor').AsCurrency;
        mdaCartaoDebito:
          vCartaoDebito := vCartaoDebito + qDtl.FieldByName('dtlvalor').AsCurrency;
        mdaCartaoCredito:
          vCartaoCredito := vCartaoCredito + qDtl.FieldByName('dtlvalor').AsCurrency;
        mdaPIX:
          vPIX := vPIX + qDtl.FieldByName('dtlvalor').AsCurrency;
        mdaConvenio:
          vConvenio := vConvenio + qDtl.FieldByName('dtlvalor').AsCurrency;
        mdaVale:
          vVale := vVale + qDtl.FieldByName('dtlvalor').AsCurrency;
        mdaDoacao:
          vDoacao := vDoacao + qDtl.FieldByName('dtlvalor').AsCurrency;
        mdaCredito:
          vCredito := vCredito + qDtl.FieldByName('dtlvalor').AsCurrency;

        mdaTrocaDevolucao:
          vTrocaDevolucao := vTrocaDevolucao + qDtl.FieldByName('dtlvalor').AsCurrency;

      end;
      qDtl.Next;
    end;

    if vDinheiro > 0 then
      if vlPercentualProdutos <> 0 then
        vDinheiro := RoundCurrency(vDinheiro * vlPercentualProdutos);

    if vChequeProprio > 0 then
      if vlPercentualProdutos <> 0 then
        vChequeProprio := RoundCurrency(vChequeProprio * vlPercentualProdutos);

    if vChequeTerceiros > 0 then
      if vlPercentualProdutos <> 0 then
        vChequeTerceiros := RoundCurrency(vChequeTerceiros * vlPercentualProdutos);

    if vCartaoDebito > 0 then
      if vlPercentualProdutos <> 0 then
        vCartaoDebito := RoundCurrency(vCartaoDebito * vlPercentualProdutos);

    if vCartaoCredito > 0 then
      if vlPercentualProdutos <> 0 then
        vCartaoCredito := RoundCurrency(vCartaoCredito * vlPercentualProdutos);

    if vConvenio > 0 then
      if vlPercentualProdutos <> 0 then
        vConvenio := RoundCurrency(vConvenio * vlPercentualProdutos);

    if vPIX > 0 then
      if vlPercentualProdutos <> 0 then
        vPIX := RoundCurrency(vPIX * vlPercentualProdutos);

    if vVale > 0 then
      if vlPercentualProdutos <> 0 then
        vVale := RoundCurrency(vVale * vlPercentualProdutos);

    if vDoacao > 0 then
      if vlPercentualProdutos <> 0 then
        vDoacao := RoundCurrency(vDoacao * vlPercentualProdutos);

    if vCredito > 0 then
      if vlPercentualProdutos <> 0 then
        vCredito := RoundCurrency(vCredito * vlPercentualProdutos);

    if vTrocaDevolucao > 0 then
      if vlPercentualProdutos <> 0 then
        vTrocaDevolucao := RoundCurrency(vTrocaDevolucao * vlPercentualProdutos);

    vlValorDiferenca := 0;
    vlValorDiferenca := vlTotalItens - (vDinheiro + vChequeProprio + vChequeTerceiros + vCartaoDebito + vCartaoCredito + vConvenio + vPIX + vVale +
      vTrocaDevolucao + vDoacao + vCredito);

    vlValorDiferenca := RoundCurrency(vlValorDiferenca);

    if mesetdcodigo.AsInteger = 0 then
    begin
      if vDinheiro + vChequeProprio + vChequeTerceiros + vCartaoDebito + vCartaoCredito + vConvenio + vPIX + vTrocaDevolucao + vVale + vDoacao +
        vCredito = 0 then
      begin
        vDinheiro := mesmestotal.AsCurrency;
        vlValorDiferenca := 0;
      end;

    end;

    if vDinheiro < 0 then
      vlValorDiferenca := vDinheiro;

    qDtl.Close;
    qDtl.SQL.Clear;
    qDtl.SQL.Add('SELECT lte.ltetroco ');
    qDtl.SQL.Add('  FROM rfm ');
    qDtl.SQL.Add(' INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
    qDtl.SQL.Add(' INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
    qDtl.SQL.Add(' INNER JOIN lte ON mlt.ltechave = lte.ltechave ');
    qDtl.SQL.Add(' WHERE rfm.meschave = ' + vMesChave);
    qDtl.Open;

    vlTroco := qDtl.FieldByName('ltetroco').AsCurrency;

    if vlTroco < 0 then
      vlTroco := vlTroco * -1;

    if vlTroco > 0 then
    begin

      ACBrNFeNFCe.NotasFiscais[0].NFe.pag.vTroco := vlTroco;
    end;

    if vDinheiro > 0 then
      with pag.Add do
      begin
        tPag := fpDinheiro;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vDinheiro + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
        begin
          vPag := vDinheiro + vlTroco;

        end;
      end;

    if vChequeProprio > 0 then
      with pag.Add do
      begin
        tPag := fpCheque;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vChequeProprio + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vChequeProprio;
      end;

    if vChequeTerceiros > 0 then
      with pag.Add do
      begin
        tPag := fpCheque;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vChequeTerceiros; // + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vChequeTerceiros + vlTroco;
      end;

    if vCartaoDebito > 0 then
      with pag.Add do
      begin
        tPag := fpCartaoDebito;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vCartaoDebito + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vCartaoDebito;
      end;

    if vCartaoCredito > 0 then
      with pag.Add do
      begin
        tPag := fpCartaoCredito;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vCartaoCredito + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vCartaoCredito;
      end;

    if vConvenio > 0 then
      with pag.Add do
      begin
        tPag := fpCreditoLoja;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vConvenio + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vConvenio;
      end;

    if vPIX > 0 then
      with pag.Add do
      begin
        tPag := fpPagamentoInstantaneo;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vPIX + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vPIX;
      end;

    if vVale > 0 then
      with pag.Add do
      begin
        tPag := fpValePresente;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vVale + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vVale;
      end;

    if vDoacao > 0 then
      with pag.Add do
      begin
        tPag := fpValePresente;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vDoacao + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vDoacao;
      end;

    if vCredito > 0 then
      with pag.Add do
      begin
        tPag := fpValePresente;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vCredito + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vCredito;
      end;

    if vTrocaDevolucao > 0 then
      with pag.Add do
      begin
        tPag := fpValePresente;
        if vlValorDiferenca <> 0 then
        begin
          vPag := vTrocaDevolucao + vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vTrocaDevolucao;

      end;

    if pag.Count = 0 then
    begin

      with pag.Add do
      begin
        tPag := TpcnFormaPagamento(17);

        if vlValorDiferenca <> 0 then
        begin
          vPag := vlValorDiferenca;
          vlValorDiferenca := 0;
        end
        else
          vPag := vTrocaDevolucao;

      end;

    end;

    (*
      *
      ********* Identifica o Número da NF-e **********
      *
    *)

    if (Self.mesmesnumero.AsString <> '') and (Self.mesmesnumero.AsString <> '0') then
    begin
      vNumeroNFe := Self.mesmesnumero.AsInteger
    end
    else
    begin

      // NumeroNFCe.Params[0].AsInteger := cfgcfgcodigo.AsInteger;
      NumeroNFCe.ExecSQL;
      vNumeroNFe := NumeroNFCe.Fields[0].AsInteger;
    end;

    Ide.nNF := vNumeroNFe;

    { if cfgcfgmodonfe.AsInteger <> 1 then
      begin
      infIntermed.CNPJ := '00000000000000';
      infIntermed.idCadIntTran := ' NOME DO INTERMEDIARIO';
      Ide.indIntermed := iiOperacaoSemIntermediador;
      end;
    }

    if (Copy(vlNFCeProtocolo, 1, 10) <> '0000000000') and (Length(trim(vlNFCeProtocolo)) > 0) then
    begin

      Ide.cNF := StrToInt(FormatFloat('00000000', StrToInt(Copy(vlNFCeChave, 36, 8))));

      if Copy(vlNFCeChave, 35, 1) = '9' then
      begin

        ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teOffLine;
        Ide.tpEmis := teOffLine;
        Ide.dhCont := mesmesdatanfe.AsDateTime; // recrecdthoraentrada.AsFloat;
        Ide.xJust := 'Falha de comunicação com servidores da SEFAZ.';

      end
      else
      begin
        ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teNormal;
        Ide.tpEmis := teNormal;
      end;

    end
    else
    begin
      if (mesmescodigonota.AsString = '') or (mesmescodigonota.AsString = '0') then
      begin
        Ide.cNF := GerarCodigoDFe(vNumeroNFe);
        mes.Edit;
        mesmescodigonota.AsInteger := Ide.cNF;
        mes.post;
      end
      else
      begin
        Ide.cNF := mesmescodigonota.AsInteger;
      end;

    end;

    consulta.Close;
    consulta.SQL.Text := 'set @disable_triggers=null';
    consulta.ExecSQL;

    consulta.Close;
    consulta.SQL.Text := 'UPDATE mes SET ';
    consulta.SQL.Add('mesnumero = ' + IntToStr(vNumeroNFe) + ', ');
    consulta.SQL.Add('tdfcodigo = ''65'', ');
    consulta.SQL.Add('refcodigo = 9, ');
    consulta.SQL.Add('temcodigo = 4 ');
    consulta.SQL.Add('WHERE meschave = ' + vMesChave);
    consulta.ExecSQL;

    info.Lines.Add('Iniciar comunicação: ' + datetimetostr(now));

    if (Copy(mesmesprotocolo.AsString, 1, 15) <> '000000000000000') and (mesmesprotocolo.AsString <> '') then
    begin
      AssinaNota(ACBrNFeNFCe, vMesChave, vFlaCodigo);

      vpNomeArquivoNFCe := mesmeschavenfe.AsString;

      vpNomeArquivoNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', mesmesdatanfe.AsDateTime) + '\' + vpNomeArquivoNFCe +
        '-nfe.xml';

      ConsultaNFCe(mesmeschave.AsString, vpNomeArquivoNFCe, Acesso.Filial.ToString);

    end
    else
    begin

      if AssinaNota(ACBrNFeNFCe, vMesChave, vFlaCodigo) then
      begin
        info.Lines.Add('Nota Assinada: ' + datetimetostr(now));
        Result := True;

      end;
    end;
  End;

End;

function Tfnfce.ReGeraNFCe(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
Var
  vErro: String;
  vMensagemErro: String;

  vMsgRetorno: String;

  vNumeroNFe: Integer;
  vChaveNFE: String;
  vProtocoloNFe: String;

  (* Acumuladores - Totais NFCe *)
  vlQtdItens: Integer;

  vlTotBC: Double;
  vlTotICMS: Double;

  vlTotDesc: Double;
  vlTotBruto: Double;
  vlTotLiq: Double;

  (* Carga Tributária *)
  vlTotTrib: Double;
  vlTotTribEst: Double;
  vlMensagemCargaTrib: string;

  (* Retornos da SEFAZ *)
  vCStat: Integer;
  vXMotivo: String;

  vDinheiro: Double;
  vChequeProprio: Double;
  vChequeTerceiros: Double;
  vCartaoDebito: Double;
  vCartaoCredito: Double;
  vPIX: Double;
  vConvenio: Double;
  vAFaturar: Double;
  vTroco: Double;
  vTrocaDevolucao: Double;
  vVale: Double;
  vDoacao: Double;
  vCredito: Double;

  vlTotalItens: Double;
  vlTotalFinalizadores: Double;
  vlPercentualProdutos: Double;
  vlValorDiferenca: Double;

  (* CST e CSOSN *)
  vlCSTIcmsOK: Boolean;
  vlCSTIcms: TpcnCSTIcms;

  vlCSOSNIcmsOK: Boolean;
  vlCSOSNIcms: TpcnCSOSNIcms;

  { * Mensagem de limite * }

  vlMensagemLimite: string;
  vlOutras: Currency;

  vlMensagemReducaoBase: STRING;
  vlReducoes: TStringList;
  iReduz: Integer;

  vlTotatFrete: Currency;
  vlMensagemicmreducao: String;

Begin
  if Self.mesmesnumero.AsString = '0' then
  begin
    Result := True;
    Exit;
  end;
  info.Lines.Add('Inicio abertura tabelas: ' + datetimetostr(now));

  Result := False;

  vlQtdItens := 0;

  vlTotBC := 0;
  vlTotICMS := 0;

  vlTotDesc := 0;
  vlTotBruto := 0;
  vlTotLiq := 0;

  vlTotTrib := 0;
  vlTotTribEst := 0;
  vlMensagemCargaTrib := '';



  //
  // ****** Carrega consulta da tabela mes e itm ********
  //

  mes.Close;
  mes.Params[0].AsString := vMesChave;
  mes.Params[1].AsString := vFlaCodigo;
  mes.Open;

  itm.Close;
  itm.Params[0].AsString := vMesChave;
  itm.Params[1].AsString := vFlaCodigo;
  itm.Open;

  vlReducoes := TStringList.Create;

  itm.First;
  while not itm.Eof do
  begin
    consulta.Close;
    consulta.SQL.Text := 'select propercreducaobaseicm from pro where propercreducaobaseicm>0 and procodigo=' + itmprocodigo.AsString;
    consulta.Open;
    if not consulta.IsEmpty then
    begin
      vlReducoes.Add(floattostr(100 - consulta.FieldByName('propercreducaobaseicm').AsFloat) + '%');
    end;

    itm.Next;
  end;

  itm.First;

  etd.Close;
  etd.ParamByName('etdcodigo').AsInteger := mesetdcodigo.AsInteger;
  etd.ParamByName('edritem').AsInteger := mesedritem.AsInteger;
  etd.Open;

  mic.Close;
  mic.Params[0].AsString := vMesChave;
  mic.Open;

  oic.Close;
  oic.Params[0].AsString := vMesChave;
  oic.Open;

  toe.Close;
  toe.SQL.Text := 'select ttecodigo,toeidentificacao,toecodigo,ttocodigo from toe where toecodigo=' + mestoecodigo.AsString;
  toe.Open;

  info.Lines.Add('Tabelas abertas: ' + datetimetostr(now));

  //
  // ***** Inicia GERAÇÃO da NFe *****
  //

  ACBrNFeNFCe.NotasFiscais.Clear;
  ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;

  Try

    With ACBrNFeNFCe.NotasFiscais.Add.NFe Do
    Begin

      Ide.indIntermed := iiSemOperacao;
      infRespTec.CNPJ := '14477548000131';
      infRespTec.email := 'Mizio@Miziosisemas.com.br';
      infRespTec.xContato := 'Mizio Sistemas';
      infRespTec.fone := '6635442765';

      (*
        *
        ********* Identificação da NFe - IDE ********
        *
      *)

      Ide.cUF := cfgufscodigo.AsInteger;
      // Ide.cNF -> Código da NFe definido por último.

      vpDataAtual := strtodatetime(mesmesregistro.AsString + ' ' + mesmeshoranfe.AsString);

      Ide.natOp := 'VENDA';
      Ide.hSaiEnt := vpDataAtual;

      Ide.dEmi := vpDataAtual;
      Ide.dSaiEnt := vpDataAtual;
      Ide.hSaiEnt := vpDataAtual;

      Ide.indPag := ipVista;
      Ide.cUF := UFtoCUF(cfgufssigla.AsString);
      Ide.cMunFG := cfgcddcodigo.AsInteger;

      Ide.idDest := doInterna;

      Ide.finNFe := fnNormal;
      Ide.tpImp := tiNFCe;
      Ide.indFinal := cfConsumidorFinal;
      Ide.indPres := pcPresencial;
      Transp.modFrete := mfSemFrete;

      Ide.modelo := 65;
      Ide.serie := cfgcfgserienfce.AsInteger;
      Ide.tpNF := tnSaida;

      if vpWSNormal then
      begin
        ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teNormal;
        Ide.tpEmis := teNormal;
      end
      else
      begin
        if rec.Active = False then
          rec.Open;

        ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teOffLine;
        Ide.tpEmis := teOffLine;
        Ide.dhCont := recrecdthoraentrada.AsFloat;
        Ide.xJust := 'Falha de comunicação com servidores da SEFAZ.';

      end;

      Ide.cMunFG := cfgcddcodigo.AsInteger;

      if cfgcfgmodonfe.AsInteger = 2 then
        Ide.tpAmb := taHomologacao;

      if cfgcfgmodonfe.AsInteger = 1 then
        Ide.tpAmb := taProducao;

      Ide.verProc := '21.25.300.1';

      ctd.Close;
      ctd.Connection := zcone;
      ctd.Open;

      if not ctd.IsEmpty then
      begin
        if (ctdctdcnpj.AsString <> '') and (ctdctdcnpj.AsString <> '0') then
        begin
          try
            if strtofloat(SoNumeros(ctdctdcnpj.AsString)) > 0 then
            begin
              autXML.Add.CNPJCPF := SoNumeros(ctdctdcnpj.AsString);
            end;
          except

          end;
        end;
      end;
      (*
        *
        ****** Emitente da NFC-e - EMIT ********
        *
      *)

      Emit.CNPJCPF := SomenteNumeros(cfgetddoc1.AsString);
      Emit.IE := SomenteNumeros(cfgedrinscest.AsString);
      Emit.IEST := '';
      Emit.xNome := cfgetdidentificacao.AsString;
      Emit.xFant := cfgetdapelido.AsString;
      Emit.EnderEmit.fone := cfgetftelefone.AsString;
      Emit.EnderEmit.CEP := StrToInt(SomenteNumeros(cfgedrcep.AsString));
      Emit.EnderEmit.xLgr := cfgedrrua.AsString;
      Emit.EnderEmit.nro := cfgedrnumero.AsString;
      Emit.EnderEmit.xCpl := '';
      Emit.EnderEmit.xBairro := cfgedrbairro.AsString;
      Emit.EnderEmit.cMun := cfgcddcodigo.AsInteger;
      Emit.EnderEmit.xMun := cfgcddnome.AsString;
      Emit.EnderEmit.UF := UpperCase(cfgufssigla.AsString);
      Emit.EnderEmit.cPais := 1058;
      Emit.EnderEmit.xPais := 'BRASIL';

      case cfgcrtcodigo.AsInteger of
        1:
          Emit.CRT := crtSimplesNacional;
        2:
          Emit.CRT := crtSimplesExcessoReceita;
        3:
          Emit.CRT := crtRegimeNormal;
      end;

      (*
        *
        ********* Destinatário da NFe **********
        *
      *)

      if (trim(LowerCase(etdetdidentificacao.AsString)) <> 'consumidor') and (ValidaConsumidor(vMesChave, vFlaCodigo)) then
      begin
        Dest.indIEDest := inNaoContribuinte;
        Dest.CNPJCPF := SomenteNumeros(Self.etdetddoc1.AsString);
        Dest.xNome := etdetdidentificacao.AsString;

      end
      else
      begin
        if mic.RecordCount = 1 then
        begin
          Dest.indIEDest := inNaoContribuinte;
          Dest.CNPJCPF := SomenteNumeros(Self.micidcdoc.AsString);
          Dest.xNome := micidcnome.AsString;
        end
        else if oic.RecordCount = 1 then
        begin
          Dest.indIEDest := inNaoContribuinte;
          Dest.CNPJCPF := SomenteNumeros(Self.oicidcdoc.AsString);
          Dest.xNome := oicidcnome.AsString;
        end;
      end;

      (*
        *
        ********* Detalhamento de Produtos e Serviços - DET ***********
        *
      *)

      itm.Refresh;
      itm.IndexFieldNames := 'itmchave';
      itm.First;

      VerifieAjustaItemcomSubstituicao(Emit.EnderEmit.UF, Dest.EnderDest.UF);

      itm.Close;
      itm.Params[0].AsString := vpMesChave;
      itm.Params[1].AsInteger := Acesso.Filial;
      itm.Open;

      if ((mesmesprodutos.AsCurrency - mesmestotal.AsCurrency) <> 0) and (mesmesprodutos.AsCurrency <> 0) then
      begin
        vlOutras := 0;

        itm.First;
        While Not itm.Eof Do
        Begin

          { if (itmitmquantidade.AsFloat*itmitmvalor.AsCurrency)<>itmitmtotal.AsCurrency then
            begin
            itm.Edit;
            itmitmoutras.AsCurrency :=itmitmtotal.AsCurrency-((itmitmquantidade.AsFloat*itmitmvalor.AsCurrency));
            itm.post;
            end; }

          { itm.Edit;
            itmitmoutras.AsCurrency := (mesmesprodutos.AsCurrency - mesmestotal.AsCurrency) * ( (Self.itmitmvalor.AsFloat*itmitmquantidade.AsFloat ) / mesmestotal.AsCurrency);
            itm.post;
          }

          vlOutras := vlOutras + itmitmoutras.AsCurrency;
          itm.Next;
        End;

        { if ((mesmesprodutos.AsCurrency - mesmestotal.AsCurrency) - vlOutras) > 0 then
          begin
          itm.Edit;
          itmitmoutras.AsCurrency := itmitmoutras.AsCurrency + ((mesmesprodutos.AsCurrency - mesmestotal.AsCurrency) - vlOutras);
          itm.post;

          end; }

      end;

      vlQtdItens := 1;
      vlTotatFrete := 0;
      While Not itm.Eof Do
      Begin

        With Det.Add Do
        Begin

          infAdProd := ''; // 'Teste de informacao adicional;Teste de Segunda Linha';
          Prod.nItem := vlQtdItens;
          Prod.ncm := SomenteNumeros(itmproncm.AsString);
          Prod.CFOP := trim('5' + Copy(itmcfocfop.AsString, 2, 4));

          Prod.cProd := Self.itmprocodigo.AsString;

          If cfgcfgdescrinfe.AsInteger = 0 Then
            Prod.xProd := BuscaTroca(trim(itmpronome.AsString), '%', '');

          If cfgcfgdescrinfe.AsInteger = 1 Then
            Prod.xProd := BuscaTroca(trim(itmpronomereduzido.AsString), '%', '');

          If (Copy(Prod.xProd, 1, 1) = '.') Then
            Prod.xProd := trim(Copy(Prod.xProd, 2, 300));

          Prod.qCom := Self.itmitmquantidade.AsFloat;
          Prod.uCom := Self.itmunisimbolo.AsString;
          Prod.vProd := Self.itmitmtotal.AsFloat;
          // Prod.vProd := Self.itmitmtotal.AsFloat - itmitmoutras.AsCurrency;

          Prod.vOutro := itmitmoutras.AsCurrency;

          Prod.qTrib := Self.itmitmquantidade.AsFloat;
          Prod.vDesc := Self.itmitmdesconto.AsFloat;

          if cfgcfgusapdv.AsInteger = 1 then
          begin
            Prod.vOutro := Self.itmitmoutras.AsCurrency;
            vlTotatFrete := vlTotatFrete + Self.itmitmoutras.AsCurrency;
          end
          else
          begin
            vlTotatFrete := 0;
          end;

          Prod.uTrib := Self.itmunisimbolo.AsString;
          Prod.vUnTrib := (Prod.vProd) / Prod.qTrib;
          Prod.vUnCom := Prod.vUnTrib;

          vlTotDesc := vlTotDesc + Prod.vDesc;
          vlTotBruto := vlTotBruto + Prod.vProd;
          vlTotLiq := vlTotLiq + (vlTotBruto - vlTotDesc);

          if itmtpocodigo.AsInteger = 99 then
            Prod.CEST := '01.999.00';

          Prod.CEST := itmtcecest.AsString;

          With Imposto Do
          Begin

            Imposto.vTotTrib := itmitmcargatrib.AsFloat + itmitmcargatribest.AsFloat;

            (* Acumula totais de carga tributária por ente Federal e Estadual *)
            vlTotTrib := vlTotTrib + itmitmcargatrib.AsFloat;
            vlTotTribEst := vlTotTribEst + itmitmcargatribest.AsFloat;

            With ICMS Do
            Begin
              case Emit.CRT of
                crtSimplesNacional:
                  vlCSOSNIcms := StrToCSOSNIcms(vlCSOSNIcmsOK, itmcstcodigo.AsString);
                crtRegimeNormal, crtSimplesExcessoReceita:
                  vlCSTIcms := StrToCSTICMS(vlCSTIcmsOK, Copy(Self.itmcstcodigo.AsString, 2, 2));
              end;

              (* CST *)
              if vlCSTIcmsOK then
                CST := vlCSTIcms;

              (* CSOSN *)
              if vlCSOSNIcmsOK then
                CSOSN := vlCSOSNIcms;

              ICMS.modBC := dbiPrecoTabelado;
              If (LowerCase(Self.itmicmcodigo.AsString) = 'ff') Or (LowerCase(Self.itmicmcodigo.AsString) = 'ii') Or
                (LowerCase(Self.itmicmcodigo.AsString) = 'nn') Then
              Begin
                ICMS.pICMS := 0;
                ICMS.vICMS := 0;
                ICMS.vBC := 0;
              End
              Else
              Begin
                If (Self.itmitmicm.AsFloat = 0.01) or (Self.itmitmicm.AsFloat = 0) Then
                Begin
                  ICMS.pICMS := 0;
                  ICMS.vICMS := 0;
                  ICMS.vBC := 0;
                End
                Else
                Begin
                  ICMS.pICMS := Self.itmicmaliquota.AsFloat;
                  ICMS.vICMS := itmitmicm.AsFloat;
                  ICMS.vBC := itmitmbicm.AsCurrency;
                  ICMS.pRedBC := itmitmpercreducaobaseicm.AsCurrency;
                  if (itmitmbicms.AsFloat > 0) and (itmitmaliqicms.AsFloat > 0) then
                  begin
                    ICMS.modBCST := dbisMargemValorAgregado;
                    ICMS.pMVAST := itmitmmva.AsFloat;
                    ICMS.vBCST := itmitmbicms.AsFloat;
                    ICMS.pICMSST := itmitmaliqicms.AsFloat;
                    ICMS.vICMSST := itmitmicms.AsFloat;

                  end;
                End;
              End;

              vlTotICMS := vlTotICMS + ICMS.vICMS;
              vlTotBC := vlTotBC + ICMS.vBC;
            End;

          End;
          vlQtdItens := vlQtdItens + 1;
        End;
        itm.Next;
      End;

      (*
        *
        ******** Informações do Transporte da NF-e - TRANSP ********
        *
      *)

      Transp.modFrete := mfSemFrete;

      (*
        *
        ******* Totais da NFe *******
        *
      *)

      (* Trata mensagem referente Carga Tributária *)
      if (vlTotTrib + vlTotTribEst) > 0 then
      begin
        vlMensagemCargaTrib := 'Trib. aprox. R$ ';
        vlMensagemCargaTrib := vlMensagemCargaTrib + FormatFloat('#,###.00', RoundTo(vlTotTrib, -2)) + ' Federal';

        if vlTotTribEst > 0 then
          vlMensagemCargaTrib := vlMensagemCargaTrib + ' e ' + FormatFloat('#,###.00', RoundTo(vlTotTribEst, -2)) + ' Estadual';

        vlMensagemCargaTrib := vlMensagemCargaTrib + ';Fonte: IBPT 5oi7eW (Lei Federal 12.741/2012)';

      end;

      { * Exibe situação de credito do cliente * }
      vlMensagemLimite := '';

      limite.Close;
      limite.ParamByName('etdcodigo').AsInteger := mesetdcodigo.AsInteger;
      limite.Open;

      if not limite.IsEmpty then
      begin
        disponivel.Close;
        disponivel.ParamByName('etdcodigo').AsInteger := mesetdcodigo.AsInteger;
        disponivel.Open;

        if (mesetdcodigo.AsInteger <> 0) and (limiteetllimitetotal.AsCurrency > 0) then
        begin

          vlMensagemLimite := 'Limite R$ ' + FormatFloat('#,###.00', RoundTo(limiteetllimitetotal.AsCurrency, -2)) + #13 + 'Disponível R$ ' +
            FormatFloat('#,###.00', RoundTo(disponivelrfisaldocapital.AsCurrency - mesmestotal.AsCurrency, -2));

        end;
      end;

      qTomTof.Close;
      qTomTof.Connection := zcone;
      qTomTof.SQL.Text := 'SELECT distinct tofidentificacao FROM tom, tof WHERE ';
      qTomTof.SQL.Add('tom.tofcodigo = tof.tofcodigo AND ');
      qTomTof.SQL.Add('tof.ticcodigo IN (' + IntToStr(ticObservacao) + ') AND ');
      qTomTof.SQL.Add('tom.meschave = ' + vpMesChave + ' ');
      qTomTof.SQL.Add('ORDER BY tof.tofcodigo');
      qTomTof.Open;

      if qTomTof.IsEmpty then
      begin

        if cfgcfgobs1.AsString <> '' then
        begin
          tom.Connection := zcone;
          tom.Open;
          tom.Append;
          tomtofcodigo.AsInteger := cfgcfgobs1.AsInteger;
          tommeschave.AsString := vpMesChave;
          tom.post;
        end;

        qTomTof.Close;
        qTomTof.Connection := zcone;
        qTomTof.SQL.Text := 'SELECT distinct tofidentificacao FROM tom, tof WHERE ';
        qTomTof.SQL.Add('tom.tofcodigo = tof.tofcodigo AND ');
        qTomTof.SQL.Add('tof.ticcodigo IN (' + IntToStr(ticObservacao) + ') AND ');
        qTomTof.SQL.Add('tom.meschave = ' + vpMesChave + ' ');
        qTomTof.SQL.Add('ORDER BY tof.tofcodigo');
        qTomTof.Open;

      end;

      { if (cfgcfgobs2.AsString <> '0') or (cfgcfgobs3.AsString <> '0') or (cfgcfgobs4.AsString <> '0') then
        begin }

      vlMensagemReducaoBase := '';

      {
        if vlReducoes.Count > 0 then
        begin
        for iReduz := 0 to vlReducoes.Count - 1 do
        begin

        vlMensagemicmreducao := StringReplace('REDUÇÃO DA BASE DE CALCULO A % CONFORME INCISO II DO ARTIGO 1 DO ANEXO V DO RICMS/MT', '%',
        vlReducoes[iReduz], []);

        if pos(vlMensagemicmreducao, vlMensagemReducaoBase) = 0 then
        begin
        vlMensagemReducaoBase := vlMensagemReducaoBase + vlMensagemicmreducao;
        end;

        end;
        end;
      }

      While Not qTomTof.Eof Do
      Begin
        if pos(trim(qTomTof.Fields[0].AsString), vlMensagemCargaTrib) = 0 then
        begin
          vlMensagemCargaTrib := vlMensagemCargaTrib + trim(qTomTof.Fields[0].AsString) + ';';

        end;
        qTomTof.Next;
      End;

      InfAdic.infCpl := vlMensagemCargaTrib + #13 + ' ' + cfgcfgmensagempdv.AsString + #13 + #13 + mesmesobs.AsString + #13 + #13 + vlMensagemLimite +
        #13 + vlMensagemReducaoBase;

      (*
        *
        ******* Totais da NFe *******
        *
      *)

      Ide.indPres := pcPresencial;

      Total.ICMSTot.vTotTrib := RoundTo(vlTotTrib + vlTotTribEst, -2);
      Total.ICMSTot.vBC := vlTotBC;

      if cfgcfgusapdv.AsInteger = 1 then
      begin
        Total.ICMSTot.vOutro := vlTotatFrete;
      end
      else
      begin
        Total.ICMSTot.vFrete := 0;
      end;

      Total.ICMSTot.vICMS := RoundTo(vlTotICMS, -2);
      Total.ICMSTot.vProd := RoundTo(vlTotBruto, -2);
      Total.ICMSTot.vDesc := RoundTo(vlTotDesc, -2);
      Total.ICMSTot.vNF := RoundTo((vlTotBruto - vlTotDesc + vlTotatFrete), -2);

      qDtl.Close;
      qDtl.SQL.Text := 'SELECT   dtl.dtlvalor,  rfm.meschave,   dtl.mdacodigo, dtl.cedcodigo FROM rfm ';
      qDtl.SQL.Add('INNER JOIN mfi ON rfm.rfichave = mfi.rfichave ');
      qDtl.SQL.Add('INNER JOIN mlt ON mlt.mfichave = mfi.mfichave ');
      qDtl.SQL.Add('INNER JOIN dtl ON mlt.ltechave = dtl.ltechave ');
      qDtl.SQL.Add('WHERE rfm.meschave=' + Self.mesmeschave.AsString + ' ');
      qDtl.SQL.Add('GROUP BY dtl.mdacodigo ');
      qDtl.SQL.Add('ORDER BY dtl.mdacodigo');

      qDtl.Open;

      vDinheiro := 0;
      vChequeProprio := 0;
      vChequeTerceiros := 0;
      vCartaoDebito := 0;
      vCartaoCredito := 0;
      vPIX := 0;
      vConvenio := 0;
      vVale := 0;
      vDoacao := 0;
      vCredito := 0;
      vTrocaDevolucao := 0;

      vAFaturar := 0;

      vlTotalItens := 0;
      vlTotalFinalizadores := 0;
      vlPercentualProdutos := 0;

      vlTotalItens := RoundTo(vlTotBruto - vlTotDesc, -2);

      while not qDtl.Eof do
      begin
        if not(qDtl.FieldByName('mdacodigo').AsInteger in [11, 22, 33]) then
          vlTotalFinalizadores := vlTotalFinalizadores + qDtl.FieldByName('dtlvalor').AsCurrency;

        qDtl.Next;
      end;

      vlPercentualProdutos := (mesmesprodutos.AsCurrency + mesmesoutras.AsCurrency) / mesmestotal.AsCurrency;

      qDtl.First;

      while not qDtl.Eof do
      begin
        case qDtl.FieldByName('mdacodigo').AsInteger of
          mdaDinheiro:
            vDinheiro := vDinheiro + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaTrocoDinheiro:
            begin
              // vDinheiro := vDinheiro - qDtl.FieldByName('dtlvalor').Ascurrency;
              vTroco := vTroco - qDtl.FieldByName('dtlvalor').AsCurrency;
            end;
          mdaChequeProprio:
            begin
              vChequeProprio := vChequeProprio + qDtl.FieldByName('dtlvalor').AsCurrency;
              vTroco := vTroco + qDtl.FieldByName('dtlvalor').AsCurrency;
            end;
          mdaTrocoChequeProprio:
            begin
              vChequeProprio := vChequeProprio - qDtl.FieldByName('dtlvalor').AsCurrency;
              vTroco := vTroco + qDtl.FieldByName('dtlvalor').AsCurrency;
            end;
          mdaChequeTerceiros:
            vChequeTerceiros := vChequeTerceiros + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaTrocoChequeTerceiros:
            vChequeTerceiros := vChequeTerceiros - qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaCartaoDebito:
            vCartaoDebito := vCartaoDebito + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaCartaoCredito:
            vCartaoCredito := vCartaoCredito + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaPIX:
            vPIX := vPIX + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaConvenio:
            vConvenio := vConvenio + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaVale:
            vVale := vVale + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaDoacao:
            vDoacao := vDoacao + qDtl.FieldByName('dtlvalor').AsCurrency;
          mdaCredito:
            vCredito := vCredito + qDtl.FieldByName('dtlvalor').AsCurrency;

          mdaTrocaDevolucao:
            vTrocaDevolucao := vTrocaDevolucao + qDtl.FieldByName('dtlvalor').AsCurrency;

        end;
        qDtl.Next;
      end;

      if vDinheiro > 0 then
        vDinheiro := RoundCurrency(vDinheiro * vlPercentualProdutos);

      if vChequeProprio > 0 then
        vChequeProprio := RoundCurrency(vChequeProprio * vlPercentualProdutos);

      if vChequeTerceiros > 0 then
        vChequeTerceiros := RoundCurrency(vChequeTerceiros * vlPercentualProdutos);

      if vCartaoDebito > 0 then
        vCartaoDebito := RoundCurrency(vCartaoDebito * vlPercentualProdutos);

      if vCartaoCredito > 0 then
        vCartaoCredito := RoundCurrency(vCartaoCredito * vlPercentualProdutos);

      if vConvenio > 0 then
        vConvenio := RoundCurrency(vConvenio * vlPercentualProdutos);

      if vPIX > 0 then
        vPIX := RoundCurrency(vPIX * vlPercentualProdutos);

      if vVale > 0 then
        vVale := RoundCurrency(vVale * vlPercentualProdutos);

      if vDoacao > 0 then
        vDoacao := RoundCurrency(vDoacao * vlPercentualProdutos);

      if vCredito > 0 then
        vCredito := RoundCurrency(vCredito * vlPercentualProdutos);

      if vTrocaDevolucao > 0 then
        vTrocaDevolucao := RoundCurrency(vTrocaDevolucao * vlPercentualProdutos);

      vlValorDiferenca := 0;
      vlValorDiferenca := vlTotalItens - (vDinheiro + vChequeProprio + vChequeTerceiros + vCartaoDebito + vCartaoCredito + vConvenio + vPIX + vVale +
        vTrocaDevolucao + vDoacao + vCredito);

      if vDinheiro < 0 then
        vlValorDiferenca := vDinheiro;

      if vDinheiro > 0 then
        with pag.Add do
        begin
          tPag := fpDinheiro;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vDinheiro + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vDinheiro;
        end;

      if vChequeProprio > 0 then
        with pag.Add do
        begin
          tPag := fpCheque;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vChequeProprio + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vChequeProprio;
        end;

      if vChequeTerceiros > 0 then
        with pag.Add do
        begin
          tPag := fpCheque;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vChequeTerceiros + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vChequeTerceiros;
        end;

      if vCartaoDebito > 0 then
        with pag.Add do
        begin
          tPag := fpCartaoDebito;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vCartaoDebito + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vCartaoDebito;
        end;

      if vCartaoCredito > 0 then
        with pag.Add do
        begin
          tPag := fpCartaoCredito;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vCartaoCredito + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vCartaoCredito;
        end;

      if vConvenio > 0 then
        with pag.Add do
        begin
          tPag := fpCreditoLoja;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vConvenio + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vConvenio;
        end;

      if vPIX > 0 then
        with pag.Add do
        begin
          tPag := fpPagamentoInstantaneo;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vPIX + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vPIX;
        end;

      if vVale > 0 then
        with pag.Add do
        begin
          tPag := fpValePresente;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vVale + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vVale;
        end;

      if vDoacao > 0 then
        with pag.Add do
        begin
          tPag := fpValePresente;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vDoacao + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vDoacao;
        end;

      if vCredito > 0 then
        with pag.Add do
        begin
          tPag := fpValePresente;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vCredito + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vCredito;
        end;

      if vTrocaDevolucao > 0 then
        with pag.Add do
        begin
          tPag := fpValePresente;
          if vlValorDiferenca <> 0 then
          begin
            vPag := vTrocaDevolucao + vlValorDiferenca;
            vlValorDiferenca := 0;
          end
          else
            vPag := vTrocaDevolucao;

        end;

      (*
        *
        ********* Identifica o Número da NF-e **********
        *
      *)
      if (Self.mesmesnumero.AsString <> '') and (Self.mesmesnumero.AsString <> '0') then
        vNumeroNFe := Self.mesmesnumero.AsInteger
      else
      begin

        // NumeroNFCe.Params[0].AsInteger := cfgcfgcodigo.AsInteger;
        NumeroNFCe.ExecSQL;
        vNumeroNFe := NumeroNFCe.Fields[0].AsInteger;
      end;

      Ide.nNF := vNumeroNFe;

      if (mesmescodigonota.AsString <> '0') and (mesmescodigonota.AsString <> '') then
      begin
        Ide.cNF := mesmescodigonota.AsInteger;
      end
      else
      begin
        Ide.cNF := GerarCodigoDFe(vNumeroNFe);
      end;

      { consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=1';
        consulta.ExecSQL;

        consulta.Close;
        consulta.SQL.Text := 'set @disable_triggers=null';
        consulta.ExecSQL; }

      info.Lines.Add('Iniciar comunicação: ' + datetimetostr(now));

      ACBrNFeNFCe.NotasFiscais.GerarNFe;
      ACBrNFeNFCe.NotasFiscais.Items[0].GerarXML;
      ACBrNFeNFCe.NotasFiscais.Items[0].GravarXML;

      { if AssinaNota(ACBrNFe, vMesChave, vFlaCodigo) then
        begin
        info.Lines.Add('Nota Assinada: ' + datetimetostr(now));

        if ValidaNota(ACBrNFe, vMesChave, vFlaCodigo) then
        begin
        info.Lines.Add('Nota Validada: ' + datetimetostr(now));

        Result := True;
        end;
        end; }

      Result := True;

    End;
  Except
    On e: Exception Do
    Begin
      vErro := '';
      If e.Message <> '' Then
        vErro := e.Message;

      vMensagemErro := 'Erro preenchimento dos dados da NFC-e.';

      SalvarLogErro(vMensagemErro, e.StackTrace);

      vMensagemErro := vMensagemErro + #13 + #13 + #13 + 'Utilize a opção "Imprimir com NFC-e".';

      // application.MessageBox(PChar(vMensagemErro), 'Erro Preenchimento NFC-e', MB_OK + MB_ICONERROR);

      Result := False;
    End;
  End;
End;

function Tfnfce.AssinaNota(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
var
  vErro: String;
  vMensagemErro: String;
begin
  Result := True;

  try

    // Assina e salva arquivo no Path definido
    vACBrNFe.NotasFiscais.Assinar;
  Except
    On e: Exception Do
    Begin

      vErro := '';
      If e.Message <> '' Then
        vErro := e.Message;

      vMensagemErro := 'Erro ao Assinar Digitalmente a NFC-e.';
      vMensagemErro := vMensagemErro + sLineBreak + 'Mensagem: ' + vErro;

      SalvarLogErro(vMensagemErro, e.StackTrace);

      vMensagemErro := vMensagemErro + sLineBreak + sLineBreak + sLineBreak + 'Utilize a opção "Imprimir com NFC-e".';

      // application.MessageBox(PChar(vMensagemErro), 'Erro Geração NF-e', MB_OK + MB_ICONERROR);

      Result := False;
    End;
  end;
end;

function Tfnfce.ValidaNota(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
var
  vlNumeroNFe: string;
  vErro: string;
  vMensagemErro: String;
begin
  Result := True;

  try

    // Valida Arquivo
    vACBrNFe.NotasFiscais.Validar;

  Except
    On e: Exception Do
    Begin
      vErro := '';
      If e.Message <> '' Then
        vErro := e.Message;

      vMensagemErro := 'Erro ao Validar a NFC-e.';
      vMensagemErro := vMensagemErro + sLineBreak + 'Mensagem: ' + vErro;

      SalvarLogErro(vMensagemErro, e.StackTrace);

      vMensagemErro := vMensagemErro + #13 + #13 + #13 + 'Utilize a opção "Imprimir com NFC-e".';

      // application.MessageBox(PChar(vMensagemErro), 'Erro Geração NF-e', MB_OK + MB_ICONERROR);

      Result := False;
    End;
  end;
end;

function Tfnfce.SalvaEmCoontigencia(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
var
  vChaveNFE: string;
  vProtocoloNFe: string;
  vErro: string;
  vlArqNFCe: string;
  vData: Double;
begin
  try
    vChaveNFE := Copy(vACBrNFe.NotasFiscais.Items[0].NFe.infNFe.ID, 4, 44);

    vProtocoloNFe := '000000000000000 ' + DateToStr(vpDataAtual) + ' ' + TimeToStr(vpDataAtual);

    consulta.Close;
    consulta.SQL.Text := 'UPDATE mes SET ';
    consulta.SQL.Add('mesdatanfe = ' + QuotedStr(ajustadata(DateToStr(vpDataAtual))) + ', ');
    consulta.SQL.Add('mesregistro = ' + QuotedStr(ajustadata(DateToStr(vpDataAtual))) + ', ');
    consulta.SQL.Add('tdfcodigo = ' + QuotedStr('65') + ', ');
    consulta.SQL.Add('refcodigo = 9, ');
    consulta.SQL.Add('mesprotocolo = ' + chr(39) + vProtocoloNFe + chr(39) + ', ');
    consulta.SQL.Add('temcodigo = 50, ');
    consulta.SQL.Add('meschavenfe = ' + QuotedStr(vChaveNFE) + ' WHERE ');
    consulta.SQL.Add('meschave = ' + vMesChave + ' and flacodigo=' + vFlaCodigo);
    consulta.ExecSQL;

    mes.Close;
    mes.Params[0].AsString := vMesChave;
    mes.Params[1].AsString := vFlaCodigo;
    mes.Open;

    vACBrNFe.NotasFiscais.Clear;
    ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;

    if vChaveNFE <> '' then
    begin

      if mesmesdatanfe.AsFloat = 0 then
        vData := mesmesregistro.AsFloat
      else
        vData := mesmesdatanfe.AsFloat;

      vlArqNFCe := mesmeschavenfe.AsString;
      vlArqNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', vData) + '\' + vlArqNFCe + '-nfe.xml';
    end;

    Result := True;
  Except
    On e: Exception Do
    Begin
      If e.Message = '' Then
        vErro := ''
      Else
        vErro := #13 + 'Erro: ' + e.Message;

      // application.MessageBox(PChar('Erro ao Validar a NFC-e.' + #13 + 'Mensagem: ' + vErro + #13 + #13 + #13 + 'Utilize a opção "Imprimir com NFC-e".'), 'Erro Geração NF-e',        MB_OK + MB_ICONERROR);
      Result := False;
      Exit;
    End;
  end;

end;

function Tfnfce.SalvaNormal(vACBrNFe: TACBrNFe; vMesChave: string; vFlaCodigo: string = '1'): Boolean;
var
  vChaveNFE: string;
  vProtocoloNFe: string;
  vCStat: Integer;
  vXMotivo: string;
  vErro: string;
  vlArqNFCe: String;
  vhrNFe: string;

  vChaveNFCe: string;
  VaaaammNFCe: string;
  vArqNFCe: string;
  vEmissaoNFCe: TDate;
  vlDataEmissao: TDate;

  vNovaChave: string;
  vlxmotivo: string;

begin
  Try

    if vACBrNFe.Enviar(0, False, True) then
    begin

      vCStat := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.cStat;
      vXMotivo := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.xMotivo;

      vlxmotivo := vXMotivo;
      vNovaChave := trim(Copy(vlxmotivo, pos('[', vlxmotivo) + 2, 44));

      // Se código de status = 100 - Autorizado o uso da NF-e.
      If vCStat = 100 Then
      Begin
        vChaveNFE := Copy(vACBrNFe.NotasFiscais.Items[0].NFe.infNFe.ID, 4, 44);

        vProtocoloNFe := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.nProt;
        vhrNFe := TimeToStr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.Ide.dEmi);
        Copy(datetimetostr(ACBrNFeNFCe.NotasFiscais.Items[0].NFe.procNFe.DhRecbto), 1, 10);

        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';
        consulta.SQL.Add('tdfcodigo = ' + QuotedStr('65') + ', ');
        consulta.SQL.Add('refcodigo = 9, ');
        consulta.SQL.Add('mesdatanfe = ' + QuotedStr(ajustadata(DateToStr(vpDataAtual))) + ', ');
        consulta.SQL.Add('mesregistro = ' + QuotedStr(ajustadata((Copy(datetimetostr(vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.DhRecbto), 1, 10))
          )) + ', ');
        consulta.SQL.Add('mesprotocolo = ' + QuotedStr(vProtocoloNFe) + ', ');
        consulta.SQL.Add('meshoranfe = ' + QuotedStr(vhrNFe) + ', ');
        consulta.SQL.Add('temcodigo = 5, ');
        consulta.SQL.Add('meschavenfe = ' + QuotedStr(vChaveNFE) + ' WHERE ');
        consulta.SQL.Add('meschave = ' + vMesChave + ' and flacodigo=' + vFlaCodigo);
        consulta.ExecSQL;

        try
          vlArqNFCe := GeraNomeArqNFCe(vMesChave, vFlaCodigo);
        except
        end;

        vACBrNFe.NotasFiscais.Clear;
        ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;
        Result := True;
      end;
    End
    else
    begin
      vCStat := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.cStat;
      vXMotivo := vACBrNFe.NotasFiscais.Items[0].NFe.procNFe.xMotivo;

    end;
  Except
    On e: Exception Do
    Begin
      If e.Message = '' Then
        vErro := ''
      Else
        vErro := #13 + e.Message;

      vNovaChave := vChaveNFE;
      trim(Copy(vlxmotivo, pos('[', vlxmotivo) + 2, 44));

      vlxmotivo := vACBrNFe.WebServices.Enviar.RetornoWS;

      vlxmotivo := Copy(vlxmotivo, pos('<chNFe>', vlxmotivo) + 7, 5000);

      vNovaChave := vChaveNFE;
      vNovaChave := trim(Copy(vlxmotivo, 1, 44));

      vCStat := vACBrNFe.WebServices.Enviar.cStat;

      vlxmotivo := vErro;
      vlxmotivo := vACBrNFe.WebServices.Retorno.xMotivo;
      vNovaChave := trim(Copy(vlxmotivo, pos('[', vlxmotivo) + 2, 44));

      if vCStat = 539 then // Denegada emissão pelo sefaz
      begin

        vEmissaoNFCe := mesmesemissao.AsDateTime;
        vChaveNFCe := GeraNomeArqNFCe(vMesChave);
        VaaaammNFCe := vpPastaPrincipal + 'arqnfces' + '\' + formatdatetime('yyyymm', vEmissaoNFCe);
        vArqNFCe := vChaveNFCe;

        if FileExists(vArqNFCe) then
        begin

          ACBrNFeNFCe.NotasFiscais.Clear;
          ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;

          ACBrNFeNFCe.NotasFiscais.LoadFromFile(vArqNFCe);

          if ACBrNFeNFCe.NotasFiscais.Count > 0 then
          begin

            vProtocoloNFe := ACBrNFeNFCe.NotasFiscais.Items[0].NFe.procNFe.nProt;
            vlDataEmissao := ACBrNFeNFCe.NotasFiscais.Items[0].NFe.Ide.dEmi;
            try
              qconsulta.Close;
              qconsulta.SQL.Text := 'UPDATE mes SET ';
              qconsulta.SQL.Add('tdfcodigo = ''65'', ');
              qconsulta.SQL.Add('mesdatanfe = ''' + ajustadata(DateToStr(vlDataEmissao)) + ''', ');
              qconsulta.SQL.Add('mesregistro = ''' + ajustadata(DateToStr(vlDataEmissao)) + ''', ');
              qconsulta.SQL.Add('mesprotocolo = ''' + vProtocoloNFe + ''', ');
              qconsulta.SQL.Add('temcodigo = 5, ');
              qconsulta.SQL.Add('meschavenfe = ''' + vChaveNFCe + ''' ');
              qconsulta.SQL.Add('WHERE meschave = ' + vMesChave);
              qconsulta.ExecSQL;
            except

            end;

          end;
        end;

      end
      else if (vCStat = 205) or (vCStat = 301) then // Denegada emissão pelo sefaz
      begin

        consulta.Close;
        consulta.SQL.Text := 'UPDATE mes SET ';
        consulta.SQL.Add('tdfcodigo = ' + QuotedStr('65') + ', ');
        consulta.SQL.Add('refcodigo = 9, ');
        consulta.SQL.Add('mesdatanfe = ' + QuotedStr(ajustadata(DateToStr(vpDataAtual))) + ', ');
        consulta.SQL.Add('mesregistro = ' + QuotedStr(ajustadata(DateToStr(vpDataAtual))) + ', ');
        consulta.SQL.Add('mesprotocolo = ' + QuotedStr(vProtocoloNFe) + ', ');
        consulta.SQL.Add('temcodigo = 7, ');
        consulta.SQL.Add('meschavenfe = ' + QuotedStr(vChaveNFE) + ' WHERE ');
        consulta.SQL.Add('meschave = ' + vMesChave + ' and flacodigo=' + vFlaCodigo);
        consulta.ExecSQL;

      end

      else if (vCStat = 0) or (vCStat = 999) then // Geralmente indica falha de comunicação com a SEFAZ
      begin

        entraemcontigencia(e.Message);
        Sleep(500);
        vpNomeArquivoNFCe := fnfce.GeraNomeArqNFCe(vMesChave, vFlaCodigo);

        GeraNFCe(vMesChave, fnfce.vpFlacodigo);

        if SalvaEmCoontigencia(vACBrNFe, vMesChave) then
          Result := True
        else
          Result := False;
      end
      else
      begin
        SalvarLogErro('RETORNO GERADO PELA SEFAZ: ' + IntToStr(vCStat) + #13 + #13 + 'Erro envio da NFC-e.' + sLineBreak + e.Message, e.StackTrace);
        application.MessageBox(PChar('RETORNO GERADO PELA SEFAZ:' + #13 + #13 + 'Erro envio da NFC-e.' + #13 + 'Mensagem: ' + vErro + #13 + #13 + #13
          + 'Utilize a opção "Imprimir com NFC-e".'), 'Erro Envio NF-e', MB_OK + MB_ICONERROR);
        Result := False;
      end;
    End;
  end;
end;

procedure Tfnfce.Setzcone(const Value: TUniConnection);
begin
  Fzcone := Value;
end;

procedure Tfnfce.entraemcontigencia(vStatSEFAZ: string);
var
  vlSituacao: Boolean;
begin
  vpWSNormal := False;
  vlSituacao := fnfce.Visible;

  if vlSituacao = False then
    fnfce.Show;

  if pos('Uma conexão com o servidor não pôde ser estabelecida', vStatSEFAZ) > 0 then
    vStatSEFAZ := '999 - ' + vStatSEFAZ;

  if rec.Active = False then
    rec.Open;

  if (rec.IsEmpty) or (Self.recrecdthorasaida.AsString <> '') then
  begin
    rec.Append;
    recrecdthoraentrada.AsFloat := vpDataAtual;
    recrecmotivo.AsString := trim(vStatSEFAZ);
    rec.post;
  end;

  rec.Close;

  fnfce.Visible := vlSituacao;
end;

function Tfnfce.ConsultaServicoSEFAZNFCE: string;
var
  vlRetornoErro: string;
  i: Integer;
Begin
  if LerConfiguracaoNFCe then
  begin

    vlRetornoErro := '';
    Result := '';

    PlTitulo.Caption := 'Consultando Status da SEFAZ.';

    fnfce.Show;

    // try
    AjustaCaminhoGeralNF(vpDataAtual);

    ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := vpConsultaVisivel;
    ACBrNFeNFCe.Configuracoes.Geral.ModeloDF := moNFCe;

    ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;

    ACBrNFeNFCe.WebServices.StatusServico.Executar;

    Result := UTF8Encode(ACBrNFeNFCe.WebServices.StatusServico.RetWS);
    vpDataHoraSEFAZ := ACBrNFeNFCe.WebServices.StatusServico.DhRecbto;

    { except
      on e: Exception do
      begin
      vlRetornoErro := e.Message;
      application.MessageBox(PChar('Falha de conexão com servidores da SEFAZ.' + #13 + #13 + 'Mensagem: ' + #13 + vlRetornoErro), 'Falha comunicação WebService',
      MB_OK + MB_ICONERROR);
      end;
      end; }
  end;
End;

Procedure Tfnfce.CancelaNFCe(vMesChave: string; vFlaCodigo: string = '1');
Var
  vProtocoloCanc: String;
  vJustificativaCanc: String;
  vTamCorrecao: Integer;
  vCStat: Integer;
  vXMotivo: String;
  vnArqNfe: String;
  vnArqEve: String;
  vAssunto: string;
  vTexto: string;
  vArqEvento: String;
  vChaveEvento: String;
  vErro: string;
  vMsgRetorno: string;
Begin
  if not vpConsultouSEFAZ then
  begin
    vpConsultaVisivel := False;
    ConsultaServicoSEFAZNFCE;
  end;

  PlTitulo.Caption := 'Cancelamento de NFC-e';
  fnfce.Show;

  try

    mes.Close;
    mes.Params[0].AsString := vMesChave;
    mes.Params[1].AsString := vFlaCodigo;
    mes.Open;

    AjustaCaminhoGeralNF(Self.mesmesregistro.AsFloat);
    vpNomeArquivoNFCe := Self.GeraNomeArqNFCe(vMesChave, vFlaCodigo);

    consulta.Close;
    consulta.SQL.Text := 'select temcodigo from mes where meschave=' + vMesChave;
    consulta.Open;

    if consulta.Fields[0].AsInteger = 50 then
    begin
      application.MessageBox(PChar('Este documento está em contigência, não pode ser cancelado !'), 'Atenção', MB_ICONWARNING + MB_OK);
      Exit;
    end;

    If not FileExists(vpNomeArquivoNFCe) Then
    begin
      application.MessageBox(PChar('O Arquivo :' + #13 + vpNomeArquivoNFCe + #13 + ' não foi localizado!'), 'Atenção', MB_ICONWARNING + MB_OK);
      Exit;
    end;

    repeat
      if not(InputQuery('Cancelamento da NFC-e', 'Justificativa do cancelamento.' + #13 + 'Contendo de 15 a 1000 caracteres.', vJustificativaCanc))
      then
        Exit;

      vTamCorrecao := Length(vJustificativaCanc);

      if vTamCorrecao < 15 then
        ShowMessage('Justificativa deve ter no mínimo 15 caracteres!');
    until (vTamCorrecao >= 15);

    If vJustificativaCanc = '' Then
    Begin
      application.MessageBox(PChar('É necessário uma jutificativa para cancelamento da NFCE!'), 'Atenção', MB_ICONWARNING + MB_OK);
      Exit;
    End;

    vCStat := 0;
    vXMotivo := '';

    ACBrNFeNFCe.NotasFiscais.Clear;
    ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;
    ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := False;
    ACBrNFeNFCe.NotasFiscais.LoadFromFile(vpNomeArquivoNFCe);

    ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;
    ACBrNFeNFCe.EventoNFe.Evento.Clear;
    ACBrNFeNFCe.EventoNFe.idLote := 0;

    with ACBrNFeNFCe.EventoNFe.Evento.Add do
    begin
      infEvento.dhEvento := vpDataAtual;
      infEvento.tpEvento := teCancelamento;
      infEvento.detEvento.xJust := vJustificativaCanc;
    end;

    // Try
    ACBrNFeNFCe.EnviarEvento(0);

    vCStat := ACBrNFeNFCe.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat;
    vXMotivo := ACBrNFeNFCe.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.xMotivo;
    vProtocoloCanc := ACBrNFeNFCe.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt;

    if (vCStat = 135) or (vCStat = 136) then
    begin

      vArqEvento := Copy(vpNomeArquivoNFCe, 1, pos('-', vpNomeArquivoNFCe) - 1);
      vArqEvento := vArqEvento + ACBrNFeNFCe.EventoNFe.Evento.Items[0].infEvento.TipoEvento;
      vArqEvento := vArqEvento + '01'; // Sequência do Evento
      vArqEvento := vArqEvento + '-procEventoNFe.xml';

      vChaveEvento := ACBrNFeNFCe.EventoNFe.Evento.Items[0].infEvento.chNFe;
      vChaveEvento := vChaveEvento + ACBrNFeNFCe.EventoNFe.Evento.Items[0].infEvento.TipoEvento;
      vChaveEvento := vChaveEvento + FormatFloat('00', ACBrNFeNFCe.EventoNFe.Evento.Items[0].infEvento.nSeqEvento);

      enf.Open;
      enf.Append;
      enftencodigo.AsInteger := tenCancelamento;
      enfenfregistroevento.AsFloat := vpDataAtual;
      enfenfchaveevento.AsString := vChaveEvento;
      enfenfseqevento.AsInteger := 1; // Cancelamento não tem sequência.
      enfenfdescricao.AsString := vJustificativaCanc;
      if FileExists(vArqEvento) then
        enfenfxml.LoadFromFile(vArqEvento);
      enfenfcstat.AsInteger := vCStat;
      enfenfxmotivo.AsString := vXMotivo;
      enf.post;

      mev.Open;
      mev.Append;
      mevenfchave.AsInteger := enfenfchave.AsInteger;
      mevmeschave.AsString := vMesChave;
      mev.post;

      consulta.Close;
      consulta.SQL.Text := 'set @disable_triggers=1';
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'UPDATE mes SET ';
      consulta.SQL.Add('sdecodigo = ''02'', ');
      consulta.SQL.Add('mesprotocolo = ''' + vProtocoloCanc + ''' ');
      consulta.SQL.Add('where meschave = ' + vMesChave + ' and flacodigo=' + vFlaCodigo);
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'set @disable_triggers=1';
      consulta.ExecSQL;

      ShowMessage('Cancelamento efetuado com sucesso!');
    end
    else
      application.MessageBox(PChar('Evento de NFC-e não autorizado.' + #13 + #13 + 'Mensagem: ' + #13 + vXMotivo), 'Erro Envio Evento NFC-e',
        MB_OK + MB_ICONERROR);

    { Except
      On e: Exception Do
      Begin
      vErro := '';
      If e.Message <> '' Then
      vErro := e.Message;

      vMsgRetorno := 'Evento de NFC-e não autorizado.';
      vMsgRetorno := vMsgRetorno + sLineBreak + 'Mensagem: ' + vErro;

      SalvarLogErro(vMsgRetorno, e.StackTrace);

      application.MessageBox(PChar(vMsgRetorno), 'Erro Envio NFC-e', MB_OK + MB_ICONERROR);

      Exit;
      End;
      End; }
  finally
    fnfce.Close;
  end;
End;

Function Tfnfce.AjustaSituacaoNFCe(vMesChave: string; vFlaCodigo: string = '1'): Boolean;
Var
  nProt: String;
  vnrnfe: String;
  vchNFe: String;
  vdtNFe: String;
  vhrNFe: String;
  vCodStatusNFe: String;
  vMsgStatusNFe: String;
  vMsgSituacao: string;
  vlchave: string;
  vErro: string;
  vCStat: Integer;
  vXMotivo: string;
  vMsgRetorno: string;

  vlNFCeProtocolo: string;
  vlNFCeChave: string;
  vldigVal: string;

Begin
  try
    fnfce.Show;
    Result := False;

    vlchave := vMesChave;
    consulta.Close;
    consulta.SQL.Text := 'select mesregistro from mes where meschave=' + vlchave;
    consulta.Open;

    fnfce.vpDataAtual := consulta.FieldByName('mesregistro').AsDateTime;
    fnfce.AjustaCaminhoGeralNF(fnfce.vpDataAtual);

    mes.Close;
    mes.Params[0].AsString := vMesChave;
    mes.Params[1].AsString := vFlaCodigo;
    mes.Open;

    if fnfce.vpNomeArquivoNFCe = '' then
    begin
      consulta.Close;
      consulta.SQL.Text := 'update mes set temcodigo=4 where meschave=' + vlchave;
      consulta.ExecSQL;
      Exit;

    end;

    If not FileExists(vpNomeArquivoNFCe) Then
    Begin
      if Self.mestemcodigo.AsInteger = 5 then
      begin
        vchNFe := Self.mesmeschavenfe.AsString;
        Geraxml(vchNFe, fnfce.vpFlacodigo);
      end
      else
      begin
        if not vpConsultouSEFAZ then
        begin
          vpConsultaVisivel := False;
          ConsultaServicoSEFAZNFCE;
        end;

        Self.GeraNFCe(vMesChave, fnfce.vpFlacodigo);
      end;
      vpNomeArquivoNFCe := GeraNomeArqNFCe(vMesChave, fnfce.vpFlacodigo);
    End;

    If not FileExists(vpNomeArquivoNFCe) Then
    begin
      ShowMessage('ATENÇÃO: O Arquivo ' + vpNomeArquivoNFCe + ' não foi localizado!');
      Exit(False);
    end;

    // Try

    vlNFCeProtocolo := mesmesprotocolo.AsString;
    vlNFCeChave := mesmeschavenfe.AsString;

    ACBrNFeNFCe.NotasFiscais.Clear;
    ACBrNFeNFCe.NotasFiscais.LoadFromFile(vpNomeArquivoNFCe);
    ACBrNFeNFCe.Configuracoes.Geral.VersaoQRCode := veqr200;
    ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := False;
    ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;

    ACBrNFeNFCe.Consultar;

    vdtNFe := DateToStr(ACBrNFeNFCe.WebServices.consulta.DhRecbto);
    vhrNFe := TimeToStr(ACBrNFeNFCe.WebServices.consulta.DhRecbto);
    nProt := ACBrNFeNFCe.WebServices.consulta.Protocolo;
    vchNFe := ACBrNFeNFCe.WebServices.consulta.NFeChave;
    vCodStatusNFe := IntToStr(ACBrNFeNFCe.WebServices.consulta.cStat);
    vMsgStatusNFe := ACBrNFeNFCe.WebServices.consulta.xMotivo;
    vMsgStatusNFe := ACBrNFeNFCe.WebServices.consulta.xMotivo;

    (* Verifica código de retorno é igual a 100 - Uso Autorizado *)

    If (ACBrNFeNFCe.WebServices.consulta.cStat = 100) { or (ACBrNFeNFCe.WebServices.Consulta.cStat = 217) } Then
    begin

      Result := True;

      consulta.Close;
      consulta.SQL.Text := 'set @disable_triggers=1';
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'UPDATE mes SET ';
      consulta.SQL.Add('mesdatanfe = ''' + ajustadata((Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.DhRecbto), 1, 10))) + ''', ');
      consulta.SQL.Add('mesregistro = ''' + ajustadata((Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.DhRecbto), 1, 10))) + ''', ');

      // consulta.SQL.Add('mesnumero = ''' + vnrnfe + ''', ');
      consulta.SQL.Add('meschavenfe = ''' + vchNFe + ''', ');
      consulta.SQL.Add('tdfcodigo = ''65'', ');
      consulta.SQL.Add('meshoranfe = ' + QuotedStr(vhrNFe) + ', ');
      consulta.SQL.Add('refcodigo = 9, ');
      consulta.SQL.Add('temcodigo = 5, ');
      consulta.SQL.Add('mesprotocolo = ''' + nProt + ''' WHERE ');
      consulta.SQL.Add('meschave = ' + vlchave + ' and flacodigo=' + vFlaCodigo);
      consulta.ExecSQL;
      consulta.Close;
      consulta.SQL.Text := 'set @disable_triggers=null';
      consulta.ExecSQL;

      try
        if FileExists(vpNomeArquivoNFCe) then
        begin
          if not mes.Active then
          begin
            mes.Close;
            mes.Params[0].AsString := vMesChave;
            mes.Params[1].AsString := vFlaCodigo;
            mes.Open;
          end;

        end;

      except
      end;

      consulta.Close;
      consulta.SQL.Text := 'select mesemissao,mesnumero, meschavenfe,tdfcodigo,mesprotocolo from mes where meschave=' + vlchave + ' and flacodigo=' +
        vFlaCodigo;
      consulta.Open;

      consulta.Close;
    end
    else If (ACBrNFeNFCe.WebServices.consulta.cStat = 101) { or (ACBrNFeNFCe.WebServices.Consulta.cStat = 217) } Then
    begin
      Result := True;
      consulta.Close;
      consulta.SQL.Text := 'set @disable_triggers=1';
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'UPDATE mes SET ';
      consulta.SQL.Add('mesemissao = ''' + ajustadata(vdtNFe) + ''', ');
      // consulta.SQL.Add('mesnumero = ''' + vnrnfe + ''', ');
      consulta.SQL.Add('sdecodigo = ''02'', ');
      consulta.SQL.Add('tdfcodigo = ''65'', ');
      consulta.SQL.Add('refcodigo = 9, ');
      consulta.SQL.Add('temcodigo = 5, ');
      consulta.SQL.Add('mesprotocolo = ''' + nProt + ''' WHERE ');
      consulta.SQL.Add('meschave = ' + vlchave + ' and flacodigo=' + vFlaCodigo);
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'set @disable_triggers=null';
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'select mesemissao,mesnumero, meschavenfe,tdfcodigo,mesprotocolo from mes where meschave=' + vlchave + ' and flacodigo=' +
        vFlaCodigo;
      consulta.Open;

      consulta.Close;

    end
    else If (ACBrNFeNFCe.WebServices.consulta.cStat = 150) { or (ACBrNFeNFCe.WebServices.Consulta.cStat = 217) } Then
    begin
      Result := True;
      consulta.Close;
      consulta.SQL.Text := 'set @disable_triggers=1';
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'UPDATE mes SET ';
      consulta.SQL.Add('mesdatanfe = ''' + ajustadata((Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.DhRecbto), 1, 10))) + ''', ');
      consulta.SQL.Add('mesregistro = ''' + ajustadata((Copy(datetimetostr(ACBrNFeNFCe.WebServices.consulta.DhRecbto), 1, 10))) + ''', ');

      // consulta.SQL.Add('mesnumero = ''' + vnrnfe + ''', ');
      consulta.SQL.Add('meschavenfe = ''' + vchNFe + ''', ');
      consulta.SQL.Add('sdecodigo = ''00'', ');
      consulta.SQL.Add('tdfcodigo = ''65'', ');
      consulta.SQL.Add('refcodigo = 9, ');
      consulta.SQL.Add('temcodigo = 5, ');
      consulta.SQL.Add('mesprotocolo = ''' + nProt + ''' WHERE ');
      consulta.SQL.Add('meschave = ' + vlchave + ' and flacodigo=' + vFlaCodigo);
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'set @disable_triggers=null';
      consulta.ExecSQL;

      consulta.Close;
      consulta.SQL.Text := 'select mesemissao,mesnumero, meschavenfe,tdfcodigo,mesprotocolo from mes where meschave=' + vlchave + ' and flacodigo=' +
        vFlaCodigo;
      consulta.Open;

      consulta.Close;

      try
        if FileExists(vpNomeArquivoNFCe) then
        begin
          if not mes.Active then
          begin
            mes.Close;
            mes.Params[0].AsString := vMesChave;
            mes.Params[1].AsString := vFlaCodigo;
            mes.Open;
          end;

        end;

      except
      end;

    end;

  finally
  end;
End;

function Tfnfce.InutilizarNumerosNFCe(vFlaCodigo: string = '1'): Boolean;
Var
  modelo, serie, Ano, vMes, NumeroInicial, NumeroFinal, Justificativa: String;
  vlRetorno: Boolean;
Begin
  vlRetorno := False;
  try
    if LerConfiguracaoNFCe then
    begin
      If Not(InputQuery('Inutilização de Números de NFCE ', 'Ano', Ano)) Then
        Exit;

      If Not(InputQuery('Inutilização de Números de NFCE ', 'Mes', vMes)) Then
        Exit;

      If Not(InputQuery('Inutilização de Números de NFCE ', 'Número Inicial', NumeroInicial)) Then
        Exit;

      If Not(InputQuery('Inutilização de Números de NFCE ', 'Número Final', NumeroFinal)) Then
        Exit;

      If Not(InputQuery('Inutilização de Números de NFCE ', 'Justificativa', Justificativa)) Then
        Exit;

      AjustaCaminhoGeralNF(strtodate('01' + '/' + vMes + '/' + Ano));

      if not vpConsultouSEFAZ then
      begin
        vpConsultaVisivel := False;
        ConsultaServicoSEFAZNFCE;
      end;
      cfg.Close;
      cfg.ParamByName('flacodigo').AsInteger := Acesso.Filial;
      cfg.Open;

      ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;

      ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := True;
      ACBrNFeNFCe.WebServices.Inutiliza(cfgetddoc1.AsString, Justificativa, StrToInt(Ano), 65, 1, StrToInt(NumeroInicial), StrToInt(NumeroFinal));
      ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := False;

      rni.Open;
      rni.Append;
      rnirniano.AsString := Ano;
      rnirnimes.AsString := vMes;
      rnitdfcodigo.AsString := '65';
      rnirninumeroinicial.AsString := NumeroInicial;
      rnirninumerofinal.AsString := NumeroFinal;
      rnirnijutificativa.AsString := Justificativa;
      rni.post;
      rni.Close;

      vlRetorno := True;

      consulta.Close;
      consulta.SQL.Text := 'SELECT meschave FROM mes ';
      consulta.SQL.Add('WHERE mesnumero BETWEEN ' + NumeroInicial + ' AND ' + NumeroFinal + ' ');
      consulta.SQL.Add('AND tdfcodigo = ''65'' ');
      consulta.Open;

      consulta.Close;
      consulta.SQL.Text := 'UPDATE mes,toe SET mesnumero=0, temcodigo=1, tdfcodigo=' + QuotedStr('00') + ', meschavenfe=' + QuotedStr('') +
        ', mesprotocolo=' + QuotedStr('') + ', mesdatanfe=null WHERE mes.toecodigo=toe.toecodigo  and sdecodigo=' + QuotedStr('00') +
        ' AND tdfcodigo=' + QuotedStr('65') + ' AND toe.ttocodigo=2 and mesnumero BETWEEN ' + NumeroInicial + ' AND ' + NumeroFinal;
      consulta.ExecSQL;

    end;
  except
    on e: Exception do
    begin

      // application.MessageBox(PChar('Inutilização de NFC-e não autorizada.' + #13 + #13 + 'Mensagem: ' + #13 + e.Message), 'Erro Inutilização NFC-e', MB_OK + MB_ICONERROR);

      vlRetorno := False;
    end;
  end;
  Result := vlRetorno;
End;

function Tfnfce.InutilizarNumerosNFCeDireto(vFlaCodigo: string = '1'): Boolean;
Var
  modelo, serie, Ano, vMes, NumeroInicial, NumeroFinal, Justificativa: String;
  vlRetorno: Boolean;
Begin
  vlRetorno := False;
  try
    if LerConfiguracaoNFCe then
    begin

      consulta.Close;
      consulta.SQL.Text := 'select mesregistro, mesnumero from mes where meschave=' + vpMesChave;
      consulta.Open;

      if consulta.IsEmpty then
      begin
        ShowMessage('Registro não localizado para inutilização de numeração!');
        Exit;
      end;

      Ano := IntToStr(YearOf(consulta.FieldByName('mesregistro').AsFloat));
      vMes := IntToStr(MonthOf(consulta.FieldByName('mesregistro').AsFloat));

      NumeroInicial := consulta.FieldByName('mesnumero').AsString;
      NumeroFinal := consulta.FieldByName('mesnumero').AsString;
      Justificativa := 'Falha na emissão do documento fiscal';

      AjustaCaminhoGeralNF(strtodate('01' + '/' + vMes + '/' + Ano));

      if not vpConsultouSEFAZ then
      begin
        vpConsultaVisivel := False;
        ConsultaServicoSEFAZNFCE;
      end;

      ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := True;
      ACBrNFeNFCe.WebServices.Inutiliza(cfgetddoc1.AsString, Justificativa, StrToInt(Ano), 65, 1, StrToInt(NumeroInicial), StrToInt(NumeroFinal));
      ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := False;

      vlRetorno := True;

      consulta.Close;
      consulta.SQL.Text := 'SELECT meschave FROM mes ';
      consulta.SQL.Add('WHERE mesnumero BETWEEN ' + NumeroInicial + ' AND ' + NumeroFinal + ' ');
      consulta.SQL.Add('AND tdfcodigo = ''65'' ');
      consulta.Open;

      while not consulta.Eof do
      begin

        mes.Close;
        mes.Params[0].AsInteger := consulta.Fields[0].AsInteger;
        mes.Params[1].AsString := vFlaCodigo;
        mes.Open;

        rni.Open;
        rni.Append;
        rnirniano.AsString := Ano;
        rnirnimes.AsString := vMes;
        rnitdfcodigo.AsString := '65';
        rnirninumeroinicial.AsString := NumeroInicial;
        rnirninumerofinal.AsString := NumeroFinal;
        rnirnijutificativa.AsString := Justificativa;
        rnimeschave.AsString := mesmeschave.AsString;
        rnimeschavenfe.AsString := mesmeschavenfe.AsString;
        rni.post;

        rni.Close;

        mes.Edit;
        mestdfcodigo.AsString := '00';
        mestemcodigo.AsInteger := 2;
        mesmesnumero.AsInteger := 0;
        mesmeschavenfe.AsString := '';
        mesmesprotocolo.AsString := '';
        mes.post;

        consulta.Next;
      end;

    end;
  except
    on e: Exception do
    begin

      application.MessageBox(PChar('Inutilização de NFC-e não autorizada.' + #13 + #13 + 'Mensagem: ' + #13 + e.Message), 'Erro Inutilização NFC-e',
        MB_OK + MB_ICONERROR);

      vlRetorno := False;
    end;
  end;
  Result := vlRetorno;
End;

procedure Tfnfce.IO_OpenSSLStatusInfo(const AMsg: string);
begin
  Sleep(700);
  application.ProcessMessages;
end;

procedure Tfnfce.AjustaCaminhoGeralNF(Data: TDate);
begin
  // verifca se os diretorios existem se nao ja cria os mesmos

  if not DirectoryExists(vpPastaPrincipal + 'pdfs') then
    ForceDirectories(vpPastaPrincipal + 'pdfs');

  if not DirectoryExists(vpPastaPrincipal) then
    ForceDirectories(vpPastaPrincipal);

  vpAAAAMMNNNFCe := vpPastaPrincipal + vpSubPastaDoc + '\' + formatdatetime('yyyymm', Data) + '\';

  if not DirectoryExists(vpAAAAMMNNNFCe) then
    ForceDirectories(vpAAAAMMNNNFCe);

  ACBrNFeNFCe.Configuracoes.Arquivos.PathSalvar := vpAAAAMMNNNFCe;
  ACBrNFeDANFCEFR1.PathPDF := vpPastaPrincipal + 'pdfs\';
end;

function Tfnfce.LerConfiguracaoNFCe: Boolean;
Begin

  cfg.Close;
  cfg.ParamByName('flacodigo').AsString := '1';
  cfg.Open;

  Result := True;

  ACBrNFeNFCe.Configuracoes.WebServices.Visualizar := False;
  ACBrNFeNFCe.Configuracoes.Arquivos.PathSchemas := ExtractFilePath(application.ExeName) + 'schemas';
  ACBrNFeNFCe.Configuracoes.Arquivos.IniServicos := ExtractFilePath(application.ExeName) + 'schemas\ACBrNFeServicos.ini';

  ACBrNFeNFCe.Configuracoes.Geral.ModeloDF := moNFCe;
  ACBrNFeNFCe.Configuracoes.Geral.VersaoDF := ve400;

  ACBrNFeNFCe.Configuracoes.Certificados.NumeroSerie := Self.cfgcfgnumecertifa1.AsString;

  if (Length(cfgcfgsenhacertificadoa1.AsString) > 0) then
  begin
    ACBrNFeNFCe.Configuracoes.Certificados.Senha := cfgcfgsenhacertificadoa1.AsString;

    cfgcfgcertificadoa1.SaveToFile(ExtractFilePath(application.ExeName) + 'certificado.pfx');

    ACBrNFeNFCe.Configuracoes.Certificados.ArquivoPFX := ExtractFilePath(application.ExeName) + 'certificado.pfx';
    ACBrNFeNFCe.Configuracoes.Geral.SSLHttpLib := httpOpenSSL;
    ACBrNFeNFCe.SSL.SSLType := LT_TLSv1_2;

  end;

  ACBrNFeNFCe.Configuracoes.Geral.SSLLib := libWinCrypt;
  ACBrNFeNFCe.Configuracoes.Geral.SSLCryptLib := cryWinCrypt;
  ACBrNFeNFCe.Configuracoes.Geral.SSLHttpLib := httpWinHttp;
  ACBrNFeNFCe.Configuracoes.Geral.SSLXmlSignLib := xsLibXml2;

  ACBrNFeNFCe.Configuracoes.Certificados.NumeroSerie := Self.cfgcfgnumecertif.AsString;
  ACBrNFeNFCe.Configuracoes.Certificados.Senha := cfgcfgsenhacertificadoa1.AsString;

  ACBrNFeNFCe.Configuracoes.Geral.FormaEmissao := teNormal;
  ACBrNFeNFCe.Configuracoes.Geral.Salvar := True;

  ACBrNFeNFCe.Configuracoes.WebServices.UF := UpperCase(Self.cfgufssigla.AsString);

  if cfgcfgmodonfe.AsInteger = 2 then
  begin
    ACBrNFeNFCe.Configuracoes.Geral.IdCSC := FormatFloat('000000', cfgcfgidtokennfce.AsInteger);
    ACBrNFeNFCe.Configuracoes.Geral.CSC := LowerCase(cfgcfgtoken1nfce.AsString);
    ACBrNFeNFCe.Configuracoes.WebServices.Ambiente := taHomologacao;
  end
  else if cfgcfgmodonfe.AsInteger = 1 then
  begin
    ACBrNFeNFCe.Configuracoes.Geral.IdCSC := FormatFloat('000000', cfgcfgidtokennfce.AsInteger);
    ACBrNFeNFCe.Configuracoes.Geral.CSC := LowerCase(cfgcfgtoken1nfce.AsString);
    ACBrNFeNFCe.Configuracoes.WebServices.Ambiente := taProducao;
  end;

  ACBrNFeNFCe.Configuracoes.WebServices.TimeZoneConf.ModoDeteccao := tzManual;
  ACBrNFeNFCe.Configuracoes.WebServices.TimeZoneConf.TimeZoneStr := '-04:00';

End;

procedure Tfnfce.SalvarLogErro(eMessage, eStackTrace: String);
var
  vlMensagem: String;
  vlArquivo: String;
begin
  vlMensagem := 'Mensagem: ' + eMessage + sLineBreak + sLineBreak + eStackTrace;

  vlArquivo := ExtractFilePath(application.ExeName) + 'Logs\NFCe\' + formatdatetime('yyyymmddhhnnsszzz', vpDataAtual) + '.txt';

  SalvarTextoEmArquivo(vlMensagem, vlArquivo);
end;

procedure Tfnfce.VerifieAjustaItemcomSubstituicao(usEmitente, ufDestinatario: string);
var
  vlcfop: string;
  vlcstcodigo: string;
  vlcsicodigo: string;
  vlcspcodigo: string;
  vlcsfcodigo: string;
  vlcfgpercentualpis: string;
  vlcfgpercentualcofins: string;
  vlEmitente: string;
  vlDestinatario: string;
  vlTceCest: string;
begin

  if cfgcfgtributacaoimendes.AsInteger = 0 then
  begin

    vlEmitente := usEmitente;
    vlDestinatario := ufDestinatario;
    if vlDestinatario = '' then
    begin
      vlDestinatario := vlEmitente;
    end;

    itm.First;

    // ajusta o toe do item para produto com substituição
    While Not itm.Eof Do
    Begin

      if (cfgcfgdefinetoeatendimento.AsInteger = 0) then
      begin

        if itmtcecest.AsString <> '' then
        begin

          if itmproanpcodigo.AsString <> '' then
          begin

            if (cfgcfgusacstnoproduto.AsInteger = 0) and (cfgcfgdefinetoeatendimento.AsInteger = 0) then
            begin

              if (cfgcfgtoesubstanpnoestado.AsInteger <> 0) then
              begin

                consulta.Close;
                consulta.SQL.Text :=
                  'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo=' +
                  cfgcfgtoesubstanpnoestado.AsString;
                consulta.Open;

                vlcstcodigo := consulta.FieldByName('cstcodigo').AsString;
                vlcsicodigo := consulta.FieldByName('csicodigo').AsString;
                vlcspcodigo := consulta.FieldByName('cspcodigo').AsString;
                vlcsfcodigo := consulta.FieldByName('csfcodigo').AsString;

                vlcfgpercentualpis := consulta.FieldByName('cfgpercentualpis').AsString;
                vlcfgpercentualpis := StringReplace(vlcfgpercentualpis, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                vlcfgpercentualcofins := consulta.FieldByName('cfgpercentualcofins').AsString;
                vlcfgpercentualcofins := StringReplace(vlcfgpercentualcofins, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                vlcfop := consulta.FieldByName('toecfopsaida').AsString;

                consulta.Close;
                consulta.SQL.Text := 'select tcecest from tce where tcecest=' + QuotedStr(itmtcecest.AsString);
                consulta.Open;

                vlTceCest := consulta.FieldByName('tcecest').AsString;

                itmncm.Close;
                itmncm.SQL.Text := 'update itm set  itmcest=' + QuotedStr(vlTceCest) + '  ,itmcofins=' + vlcfgpercentualcofins + ' ,itmpis=' +
                  vlcfgpercentualpis + ',  cfocfop=' + QuotedStr(vlcfop) + ',cstcodigo=' + QuotedStr(vlcstcodigo) + ', csicodigo=' +
                  QuotedStr(vlcsicodigo) + ', cspcodigo=' + QuotedStr(vlcspcodigo) + ',csfodigo=' + QuotedStr(vlcsfcodigo) + '   ,toecodigo=' +
                  cfgcfgtoesubstanpnoestado.AsString + ' where itmchave=' + itmitmchave.AsString;
                itmncm.ExecSQL;

              end;
            end;

          end
          else
          begin
            if (cfgcfgusacstnoproduto.AsInteger = 0) and (cfgcfgdefinetoeatendimento.AsInteger = 0) then
            begin

              if (cfgcfgtoesubstnoestado.AsInteger <> 0) then
              begin
                if itmtcecest.AsString = '' then
                begin

                  consulta.Close;
                  consulta.SQL.Text :=
                    'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo=' +
                    cfgcfgtoemesinte.AsString;
                  consulta.Open;

                end
                else
                begin

                  if (cfgcfgtoeinteproducaopropria.AsInteger <> 0) then
                  begin
                    if itmproproducao.AsInteger = 1 then
                    begin

                      consulta.Close;
                      consulta.SQL.Text :=
                        'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo='
                        + cfgcfgtoeintesubsprodpropria.AsString;
                      consulta.Open;
                    end
                    else
                    begin
                      consulta.Close;
                      consulta.SQL.Text :=
                        'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo='
                        + cfgcfgtoesubstnoestado.AsString;
                      consulta.Open;

                    end;

                  end
                  else
                  begin
                    consulta.Close;
                    consulta.SQL.Text :=
                      'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo=' +
                      cfgcfgtoesubstnoestado.AsString;
                    consulta.Open;
                  end;
                end;

                vlcstcodigo := consulta.FieldByName('cstcodigo').AsString;
                vlcsicodigo := consulta.FieldByName('csicodigo').AsString;
                vlcspcodigo := consulta.FieldByName('cspcodigo').AsString;
                vlcsfcodigo := consulta.FieldByName('csfcodigo').AsString;

                vlcfgpercentualpis := consulta.FieldByName('cfgpercentualpis').AsString;
                vlcfgpercentualpis := StringReplace(vlcfgpercentualpis, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                vlcfgpercentualcofins := consulta.FieldByName('cfgpercentualcofins').AsString;
                vlcfgpercentualcofins := StringReplace(vlcfgpercentualcofins, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                vlcfop := consulta.FieldByName('toecfopsaida').AsString;

                consulta.Close;
                consulta.SQL.Text := 'select tcecest from tce where tcecest=' + QuotedStr(itmtcecest.AsString);
                consulta.Open;

                vlTceCest := consulta.FieldByName('tcecest').AsString;

                if itmtcecest.AsString = '' then
                begin
                  itmncm.Close;
                  itmncm.SQL.Text := 'update itm set  itmcest=' + QuotedStr(vlTceCest) + '  ,itmcofins=' + vlcfgpercentualcofins + ' ,itmpis=' +
                    vlcfgpercentualpis + ', cfocfop=' + QuotedStr(vlcfop) + ',cstcodigo=' + QuotedStr(vlcstcodigo) + ', csicodigo=' +
                    QuotedStr(vlcsicodigo) + ', cspcodigo=' + QuotedStr(vlcspcodigo) + ',csfcodigo=' + QuotedStr(vlcsfcodigo) + ', toecodigo=' +
                    cfgcfgtoemesinte.AsString + ' where itmchave=' + itmitmchave.AsString;
                  itmncm.ExecSQL;

                end
                else
                begin
                  { if (cfgcfgtoeinteproducaopropria.AsInteger <> 0) then
                    begin }

                  if itmproproducao.AsInteger = 1 then
                  begin

                    itmncm.Close;
                    itmncm.SQL.Text := 'update itm set  itmcest=' + QuotedStr(vlTceCest) + '  ,itmcofins=' + vlcfgpercentualcofins + ' ,itmpis=' +
                      vlcfgpercentualpis + ', cfocfop=' + QuotedStr(vlcfop) + ',cstcodigo=' + QuotedStr(vlcstcodigo) + ', csicodigo=' +
                      QuotedStr(vlcsicodigo) + ', cspcodigo=' + QuotedStr(vlcspcodigo) + ',csfcodigo=' + QuotedStr(vlcsfcodigo) + ', toecodigo=' +
                      cfgcfgtoeintesubsprodpropria.AsString + ' where itmchave=' + itmitmchave.AsString;
                    itmncm.ExecSQL;

                  end
                  else
                  begin
                    itmncm.Close;
                    itmncm.SQL.Text := 'update itm set  itmcest=' + QuotedStr(vlTceCest) + '  ,itmcofins=' + vlcfgpercentualcofins + ' ,itmpis=' +
                      vlcfgpercentualpis + ', cfocfop=' + QuotedStr(vlcfop) + ',cstcodigo=' + QuotedStr(vlcstcodigo) + ', csicodigo=' +
                      QuotedStr(vlcsicodigo) + ', cspcodigo=' + QuotedStr(vlcspcodigo) + ',csfcodigo=' + QuotedStr(vlcsfcodigo) + ', toecodigo=' +
                      cfgcfgtoesubstnoestado.AsString + ' where itmchave=' + itmitmchave.AsString;
                    itmncm.ExecSQL;

                  end;
                end;
              end;
            end;

          end;
          { end; }

        end
        else
        begin

          if (cfgcfgtoemesinte.AsInteger <> 0) or (cfgcfgtoeinteproducaopropria.AsInteger <> 0) then
          begin

            if itmproproducao.AsInteger = 1 then
            begin

              if etdedrinscest.AsString <> '' then
              begin
                if etdufssigla.AsString <> cfgufssigla.AsString then
                begin

                  consulta.Close;
                  consulta.SQL.Text :=
                    'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo=' +
                    cfgcfgtoeforaproducaopropria.AsString;
                  consulta.Open;

                end
                else
                begin

                  consulta.Close;
                  consulta.SQL.Text :=
                    'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo=' +
                    cfgcfgtoeinteproducaopropria.AsString;
                  consulta.Open;

                end;

              end
              else
              begin

                consulta.Close;
                consulta.SQL.Text :=
                  'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo=' +
                  cfgcfgtoeinteproducaopropria.AsString;
                consulta.Open;

              end;

            end
            else
            begin
              consulta.Close;
              consulta.SQL.Text :=
                'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo=' +
                cfgcfgtoemesinte.AsString;
              consulta.Open;
            end;
          end
          else
          begin

            consulta.Close;
            consulta.SQL.Text :=
              'select toecfopsaida,cstcodigo,csicodigo,cspcodigo, csfcodigo,cfgpercentualpis, cfgpercentualcofins from toe where toecodigo=' +
              cfgcfgtoemesinte.AsString;
            consulta.Open;

          end;

          vlcstcodigo := consulta.FieldByName('cstcodigo').AsString;
          vlcsicodigo := consulta.FieldByName('csicodigo').AsString;
          vlcspcodigo := consulta.FieldByName('cspcodigo').AsString;
          vlcsfcodigo := consulta.FieldByName('csfcodigo').AsString;

          vlcfgpercentualpis := consulta.FieldByName('cfgpercentualpis').AsString;
          vlcfgpercentualpis := StringReplace(vlcfgpercentualpis, ',', '.', [rfReplaceAll, rfIgnoreCase]);

          vlcfgpercentualcofins := consulta.FieldByName('cfgpercentualcofins').AsString;
          vlcfgpercentualcofins := StringReplace(vlcfgpercentualcofins, ',', '.', [rfReplaceAll, rfIgnoreCase]);

          vlcfop := consulta.FieldByName('toecfopsaida').AsString;

          consulta.Close;
          consulta.SQL.Text := 'select tcecest from tce where tcecest=' + QuotedStr(itmtcecest.AsString);
          consulta.Open;

          vlTceCest := consulta.FieldByName('tcecest').AsString;

          vlTceCest := consulta.FieldByName('tcecest').AsString;

          if itmtcecest.AsString = '' then
          begin
            if itmproproducao.AsInteger = 1 then
            begin
              itmncm.Close;
              itmncm.SQL.Text := 'update itm set  itmcest=' + QuotedStr(vlTceCest) + '  ,itmcofins=' + vlcfgpercentualcofins + ' ,itmpis=' +
                vlcfgpercentualpis + ', cfocfop=' + QuotedStr(vlcfop) + ',cstcodigo=' + QuotedStr(vlcstcodigo) + ', csicodigo=' +
                QuotedStr(vlcsicodigo) + ', cspcodigo=' + QuotedStr(vlcspcodigo) + ',csfcodigo=' + QuotedStr(vlcsfcodigo) + ', toecodigo=' +
                cfgcfgtoeinteproducaopropria.AsString + ' where itmchave=' + itmitmchave.AsString;
              itmncm.ExecSQL;

            end
            else
            begin

              itmncm.Close;
              itmncm.SQL.Text := 'update itm set  itmcest=' + QuotedStr(vlTceCest) + '  ,itmcofins=' + vlcfgpercentualcofins + ' ,itmpis=' +
                vlcfgpercentualpis + ', cfocfop=' + QuotedStr(vlcfop) + ',cstcodigo=' + QuotedStr(vlcstcodigo) + ', csicodigo=' +
                QuotedStr(vlcsicodigo) + ', cspcodigo=' + QuotedStr(vlcspcodigo) + ',csfcodigo=' + QuotedStr(vlcsfcodigo) + ', toecodigo=' +
                cfgcfgtoemesinte.AsString + ' where itmchave=' + itmitmchave.AsString;
              itmncm.ExecSQL;
            end;

          end
          else
          begin

            itmncm.Close;
            itmncm.SQL.Text := 'update itm set  itmcest=' + QuotedStr(vlTceCest) + '  ,itmcofins=' + vlcfgpercentualcofins + ' ,itmpis=' +
              vlcfgpercentualpis + ', cfocfop=' + QuotedStr(vlcfop) + ',cstcodigo=' + QuotedStr(vlcstcodigo) + ', csicodigo=' + QuotedStr(vlcsicodigo)
              + ', cspcodigo=' + QuotedStr(vlcspcodigo) + ',csfcodigo=' + QuotedStr(vlcsfcodigo) + ', toecodigo=' + cfgcfgtoesubstnoestado.AsString +
              ' where itmchave=' + itmitmchave.AsString;
            itmncm.ExecSQL;

          end;

        end;
        consulta.Close;
        consulta.SQL.Text := 'select padcodigo from pro where procodigo=' + itmprocodigo.AsString;
        consulta.Open;
        if not consulta.IsEmpty then
        begin
          if consulta.FieldByName('padcodigo').AsString <> '' then
          begin
            pad.Close;
            pad.Connection := zcone;
            pad.ParamByName('padcodigo').AsString := consulta.FieldByName('padcodigo').AsString;
            pad.Open;

            if not pad.IsEmpty then
            begin

              if (padpadpis.AsString <> '') and (padpadcofins.AsString <> '') then
              begin

                vlcspcodigo := padpadcodigopiscofins.AsString;
                vlcsfcodigo := padpadcodigopiscofins.AsString;

                vlcfgpercentualpis := padpadpis.AsString;
                vlcfgpercentualpis := StringReplace(vlcfgpercentualpis, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                vlcfgpercentualcofins := padpadcofins.AsString;
                vlcfgpercentualcofins := StringReplace(vlcfgpercentualcofins, ',', '.', [rfReplaceAll, rfIgnoreCase]);

                itmncm.Close;

                itmncm.SQL.Text := 'update itm set csfcodigo=' + QuotedStr(vlcsfcodigo) + '   ,cspcodigo=' + QuotedStr(vlcspcodigo) +
                  '    ,itmaliqcofins=' + vlcfgpercentualcofins + ' ,itmaliqpis=' + vlcfgpercentualpis + ' where itmchave=' + itmitmchave.AsString;
                itmncm.ExecSQL;

              end;

            end;

          end;
        end;

      end;
      itm.Next;
    End;

  end;



  // fim do ajusta o toe do item para produto com substituição

end;

end.
